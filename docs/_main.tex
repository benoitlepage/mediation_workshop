% Options for packages loaded elsewhere
\PassOptionsToPackage{unicode}{hyperref}
\PassOptionsToPackage{hyphens}{url}
%
\documentclass[
]{book}
\usepackage{amsmath,amssymb}
\usepackage{iftex}
\ifPDFTeX
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
  \usepackage{textcomp} % provide euro and other symbols
\else % if luatex or xetex
  \usepackage{unicode-math} % this also loads fontspec
  \defaultfontfeatures{Scale=MatchLowercase}
  \defaultfontfeatures[\rmfamily]{Ligatures=TeX,Scale=1}
\fi
\usepackage{lmodern}
\ifPDFTeX\else
  % xetex/luatex font selection
\fi
% Use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\IfFileExists{microtype.sty}{% use microtype if available
  \usepackage[]{microtype}
  \UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\makeatletter
\@ifundefined{KOMAClassName}{% if non-KOMA class
  \IfFileExists{parskip.sty}{%
    \usepackage{parskip}
  }{% else
    \setlength{\parindent}{0pt}
    \setlength{\parskip}{6pt plus 2pt minus 1pt}}
}{% if KOMA class
  \KOMAoptions{parskip=half}}
\makeatother
\usepackage{xcolor}
\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{248,248,248}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.94,0.16,0.16}{#1}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\BuiltInTok}[1]{#1}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.64,0.00,0.00}{\textbf{#1}}}
\newcommand{\ExtensionTok}[1]{#1}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\ImportTok}[1]{#1}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\NormalTok}[1]{#1}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\RegionMarkerTok}[1]{#1}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\usepackage{longtable,booktabs,array}
\usepackage{calc} % for calculating minipage widths
% Correct order of tables after \paragraph or \subparagraph
\usepackage{etoolbox}
\makeatletter
\patchcmd\longtable{\par}{\if@noskipsec\mbox{}\fi\par}{}{}
\makeatother
% Allow footnotes in longtable head/foot
\IfFileExists{footnotehyper.sty}{\usepackage{footnotehyper}}{\usepackage{footnote}}
\makesavenoteenv{longtable}
\usepackage{graphicx}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
% Set default figure placement to htbp
\makeatletter
\def\fps@figure{htbp}
\makeatother
\setlength{\emergencystretch}{3em} % prevent overfull lines
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\setcounter{secnumdepth}{5}
% definitions for citeproc citations
\NewDocumentCommand\citeproctext{}{}
\NewDocumentCommand\citeproc{mm}{%
  \begingroup\def\citeproctext{#2}\cite{#1}\endgroup}
\makeatletter
 % allow citations to break across lines
 \let\@cite@ofmt\@firstofone
 % avoid brackets around text for \cite:
 \def\@biblabel#1{}
 \def\@cite#1#2{{#1\if@tempswa , #2\fi}}
\makeatother
\newlength{\cslhangindent}
\setlength{\cslhangindent}{1.5em}
\newlength{\csllabelwidth}
\setlength{\csllabelwidth}{3em}
\newenvironment{CSLReferences}[2] % #1 hanging-indent, #2 entry-spacing
 {\begin{list}{}{%
  \setlength{\itemindent}{0pt}
  \setlength{\leftmargin}{0pt}
  \setlength{\parsep}{0pt}
  % turn on hanging indent if param 1 is 1
  \ifodd #1
   \setlength{\leftmargin}{\cslhangindent}
   \setlength{\itemindent}{-1\cslhangindent}
  \fi
  % set entry spacing
  \setlength{\itemsep}{#2\baselineskip}}}
 {\end{list}}
\usepackage{calc}
\newcommand{\CSLBlock}[1]{\hfill\break\parbox[t]{\linewidth}{\strut\ignorespaces#1\strut}}
\newcommand{\CSLLeftMargin}[1]{\parbox[t]{\csllabelwidth}{\strut#1\strut}}
\newcommand{\CSLRightInline}[1]{\parbox[t]{\linewidth - \csllabelwidth}{\strut#1\strut}}
\newcommand{\CSLIndent}[1]{\hspace{\cslhangindent}#1}
\usepackage{booktabs}
\ifLuaTeX
  \usepackage{selnolig}  % disable illegal ligatures
\fi
\usepackage{bookmark}
\IfFileExists{xurl.sty}{\usepackage{xurl}}{} % add URL line breaks if available
\urlstyle{same}
\hypersetup{
  pdftitle={Mediation Workshop},
  pdfauthor={Benoît Lepage},
  hidelinks,
  pdfcreator={LaTeX via pandoc}}

\title{Mediation Workshop}
\author{Benoît Lepage}
\date{2024-10-23}

\begin{document}
\maketitle

{
\setcounter{tocdepth}{1}
\tableofcontents
}
\chapter{Introduction}\label{introduction}

The objective of this document is to provide practical examples for the Expanse report \href{https://github.com/benoitlepage/mediation_workshop/blob/main/Expanse\%20report/Mediation_BL-2024-03-29.pdf}{\emph{``Mediation Analysis: a Starting Guide for Epidemiologists''}} with R scripts corresponding to the different estimation methods presented in the report.

\chapter{Software}\label{software}

The examples given in this workshop have been elaborated for R (version 4.3.3).

Depending on the estimator, some R packages might be necessary:

\begin{itemize}
\tightlist
\item
  \texttt{lavaan} \href{https://lavaan.ugent.be/}{package}
\item
  \texttt{semPlot} \href{https://cran.r-project.org/web/packages/semPlot/index.html}{package}
\item
  \texttt{CMAverse} \href{https://bs1125.github.io/CMAverse/}{package}
\item
  \texttt{sandwich} \href{https://sandwich.r-forge.r-project.org/articles/sandwich.html}{package}
\item
  \texttt{boot} \href{https://cran.r-project.org/web/packages/boot/index.html}{package}
\item
  \texttt{regmedint} \href{https://kaz-yos.github.io/regmedint/}{package}
\item
  \texttt{mediation} \href{https://imai.fas.harvard.edu/research/files/mediationR2.pdf}{package}
\item
  \texttt{ltmle} \href{http://joshuaschwab.github.io/ltmle/}{package}
\item
  \texttt{intmed} \href{https://cran.r-project.org/web/packages/intmed/index.html}{package}
\item
  \texttt{medflex} \href{https://cran.r-project.org/web/packages/medflex/index.html}{package}
\item
  \texttt{questionr} \href{https://cran.r-project.org/web/packages/questionr/index.html}{package}
\item
  \texttt{geepack} \href{https://cran.r-project.org/web/packages/geepack/index.html}{package}
\item
  \texttt{SuperLearner} \href{http://cran.nexr.com/web/packages/SuperLearner/vignettes/Guide-to-SuperLearner.html}{package}
\item
  \texttt{xgboost} \href{https://cran.r-project.org/web/packages/xgboost/index.html}{package}
\item
  \texttt{tidyverse} \href{https://www.tidyverse.org/}{package}\\
\item
  \texttt{sl3} \href{https://github.com/tlverse/sl3}{package}
\item
  \texttt{hal9001} \href{https://cran.r-project.org/web/packages/hal9001/index.html}{package}
\item
  \texttt{medoutcon} \href{https://github.com/nhejazi/medoutcon}{package}
\item
  \texttt{glmnet} \href{https://cloud.r-project.org/web/packages/glmnet/index.html}{package}
\end{itemize}

\chapter{Data sets}\label{data-sets}

\section{General presentation of the data used in our examples}\label{general-presentation-of-the-data-used-in-our-examples}

Four data sets have been simulated, each containing 7 variables:

\begin{itemize}
\tightlist
\item
  2 baseline confounders (denoted \(L(0)\) in the DAGs):

  \begin{itemize}
  \tightlist
  \item
    \texttt{L0\_male}, a binary variable indicating the sex of the participant (1 for men, 0 for women);
  \item
    \texttt{L0\_soc\_env}, a binary variable indicating if the participant has been exposed to a deprived social environment);
  \end{itemize}
\item
  1 exposure of interest (denoted \(A\) in the DAGs):

  \begin{itemize}
  \tightlist
  \item
    \texttt{A0\_PM2.5}, a binary variable indicating if the participants had been exposed to a high level of \(\text{PM}_{2.5}\);
  \end{itemize}
\item
  1 confounder of the mediator-outcome relationship (denoted \(L(1)\) in the DAGs):

  \begin{itemize}
  \tightlist
  \item
    \texttt{L1}, a binary variable indicating if the participant is overweight (1 for being overweight, 0 for not being overweight);
  \end{itemize}
\item
  1 mediator of interest (denoted \(M\) in the DAGs):

  \begin{itemize}
  \tightlist
  \item
    \texttt{M\_diabetes}, a binary variable indicating if the participant has type 2 diabetes;
  \end{itemize}
\item
  2 outcomes (denoted \(Y\) in the DAGs):

  \begin{itemize}
  \tightlist
  \item
    \texttt{Y2\_death}, a binary variable indicating the occurrence of death before 60 years of age (1 if dead, 0 if alive);
  \item
    \texttt{Y2\_qol}, a quantitative variable corresponding to a quality of life measurement.
  \end{itemize}
\end{itemize}

\section{Data generating mechanisms}\label{data-generating-mechanisms}

The 4 data generating mechanisms used to simulate the data sets are described in chapter 4 of the \emph{Expanse ``Mediation analysis'' report}:

\begin{itemize}
\tightlist
\item
  The first two data sets are simulated from a causal model where confounders of the mediator-outcome relationship (\(L(1)\)) are not affected by the exposure \(A\) (Figure \ref{fig:figDAGM1}),

  \begin{itemize}
  \tightlist
  \item
    The data set \href{https://github.com/benoitlepage/mediation_workshop/blob/main/data/df1.csv}{\texttt{df1.csv}} is simulated from the statistical model \(\mathcal{M}_1\), which does not contain any \(A \ast M\) interaction effect on the outcome \(Y\).
  \item
    The data set \href{https://github.com/benoitlepage/mediation_workshop/blob/main/data/df1_int.csv}{\texttt{df1\_int.csv}} is simulated from the statistical model \(\mathcal{M}_{1 \ast}\), which contains an \(A \ast M\) interaction effect on the outcome \(Y\).
  \end{itemize}
\end{itemize}

\begin{figure}

{\centering \includegraphics[width=0.5\linewidth]{./figures/DAG_M1} 

}

\caption{Causal model 1}\label{fig:figDAGM1}
\end{figure}

\begin{itemize}
\tightlist
\item
  The next two data sets are simulated from a causal model where confounders of the mediator-outcome relationship (\(L(1)\)) are affected by the exposure \(A\) (Figure \ref{fig:figDAGM2}),

  \begin{itemize}
  \tightlist
  \item
    The data set \href{https://github.com/benoitlepage/mediation_workshop/blob/main/data/df2.csv}{\texttt{df2.csv}} is simulated from the statistical model \(\mathcal{M}_2\), which does not contain any \(A \ast M\) interaction effect on the outcome \(Y\).
  \item
    The data set \href{https://github.com/benoitlepage/mediation_workshop/blob/main/data/df2_int.csv}{\texttt{df2\_int.csv}} is simulated from the statistical model \(\mathcal{M}_{2 \ast}\), which contains an \(A \ast M\) interaction effect on the outcome \(Y\).
  \end{itemize}
\end{itemize}

\begin{figure}

{\centering \includegraphics[width=0.5\linewidth]{./figures/DAG_M2} 

}

\caption{Causal model 2}\label{fig:figDAGM2}
\end{figure}

The R functions used to simulate these 4 data sets are given in the Appendix A @ref(appendix\_a).

The Appendix B @ref(appendix\_b) describes how the true values for the estimands of the causal quantities of interest given in Table 2 of the \emph{Expanse ``Mediation analysis'' report} were calculated. Those true values are the theoretical values expected under the causal and statistical models \(\mathcal{M}_1\), \(\mathcal{M}_{1 \ast}\), \(\mathcal{M}_2\) and \(\mathcal{M}_{2 \ast}\). Estimations that will be obtained from the data sets \texttt{df1.csv}, \texttt{df1\_int.csv}, \texttt{df2.csv}, and \texttt{df2\_int.csv} will be slightly different from the true values because of sample variability.

\chapter{Baron and Kenny, structural equation models}\label{ChapBaronKennySem}

The Baron and Kenny approach can be applied if we make the assumption that no confounder of the \(M \rightarrow Y\) relationship is affected by the exposure \(A\). As a consequence we will use the \texttt{df1.csv} data set simulated from the Causal model 1 (Figure \ref{fig:figDAGM1}). We will also assume that there is no \(A \ast M\) interaction effect on the outcome \(Y\) in the following examples. Such interaction effects can be dealt with using traditional regression models in very similar approaches described in chapter \ref{ChapTradRegModels}.

\section{Baron and Kenny approach}\label{baron-and-kenny-approach}

The Baron \& Kenny approach relies on sequential and step-wise estimation of linear regression models:

\begin{itemize}
\tightlist
\item
  A model for the total effect of the exposure \(A\) on the outcome \(Y\) (conditional on baseline confounders \(L(0)\))
\end{itemize}

\begin{equation*}
    \mathbb{E}(Y \mid A,L(0)) = \theta_0 + \theta_A A + \theta_{L(0)} L(0)
  \end{equation*}

\begin{itemize}
\tightlist
\item
  A model to test if the exposure \(A\) has an effect on the mediator \(M\) (conditional on baseline confounders \(L(0)\) of the \(A-M\) relationship)
\end{itemize}

\begin{equation*}
    \mathbb{E}(M \mid A,L(0)) = \beta_0 + \beta_A A + \beta_{L(0)} L(0)
  \end{equation*}

\begin{itemize}
\tightlist
\item
  A model to estimate the direct effect of the exposure \(A\) on the outcome \(Y\) as well as the effect of the mediator \(M\) on the outcome, adjusted for baseline confounders \(L(0)\) and confounders of the \(M-Y\) relationship \(L(1)\)
\end{itemize}

\begin{equation*}
    \mathbb{E}(Y \mid A,M,L(1),L(0)) = \gamma_0 + \gamma_A A + \gamma_M M + \gamma_{L(0)} L(0) + \gamma_{L(1)} L(1)
  \end{equation*}

The total effect is given by the \(\theta_A\) coefficient from the 1st model.

The direct effect is given by the \(\gamma_A\) coefficient from the 3rd model.

The indirect effect can be calculated using:

\begin{itemize}
\tightlist
\item
  the ``difference in coefficient'' method based on the 1st and 3rd models: \(\theta_A - \gamma_A\),
\item
  or the ``product of coefficient'' method based on the 2nd and 3rd models: \(\beta_A \times \gamma_M\).
\end{itemize}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# Import data }
\FunctionTok{rm}\NormalTok{(}\AttributeTok{list=}\FunctionTok{ls}\NormalTok{())}
\NormalTok{df1 }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file =} \StringTok{"./data/df1.csv"}\NormalTok{)}

\DocumentationTok{\#\# Model 1 to estimate the total effect:}
\NormalTok{model.tot.A.QoL }\OtherTok{\textless{}{-}} \FunctionTok{lm}\NormalTok{(Y\_qol }\SpecialCharTok{\textasciitilde{}}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env,}
                      \AttributeTok{data =}\NormalTok{ df1)}
\FunctionTok{summary}\NormalTok{(model.tot.A.QoL)}
\CommentTok{\# Coefficients:}
\CommentTok{\#               Estimate Std. Error t value Pr(\textgreater{}|t|)}
\CommentTok{\#   (Intercept)  71.8820     0.2155 333.565  \textless{} 2e{-}16 ***}
\CommentTok{\#   A0\_PM2.5     {-}5.0961     0.3486 {-}14.617  \textless{} 2e{-}16 *** \textless{}{-} Total effect}
\CommentTok{\#   L0\_male      {-}1.1486     0.2194  {-}5.235 1.68e{-}07 ***}
\CommentTok{\#   L0\_soc\_env   {-}3.4441     0.2295 {-}15.005  \textless{} 2e{-}16 ***}

\CommentTok{\# The total effect of being exposed to high levels of PM\_2.5 on Quality of life}
\CommentTok{\# is approximately equal to an average decrease of {-}5.1 on the QoL scale,}
\CommentTok{\# given by the A0\_PM2.5 coefficient:}
\NormalTok{model.tot.A.QoL}\SpecialCharTok{$}\NormalTok{coefficients[}\StringTok{"A0\_PM2.5"}\NormalTok{]}
\CommentTok{\# {-}5.096057}

\DocumentationTok{\#\# Model 2 to estimate the effect of the exposure on the mediator}
\DocumentationTok{\#\# because the mediator is binary, we might want to use a logistic or probit regression}
\DocumentationTok{\#\# for example}
\NormalTok{logit.model.A.M }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(M\_diabetes }\SpecialCharTok{\textasciitilde{}}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env,}
                       \AttributeTok{data =}\NormalTok{ df1, }\AttributeTok{family =} \StringTok{"binomial"}\NormalTok{)}
\FunctionTok{summary}\NormalTok{(logit.model.A.M)}
\CommentTok{\# effects estimated on the logit scale:}
\CommentTok{\# Coefficients:}
\CommentTok{\#                          Estimate Std. Error z value Pr(\textgreater{}|z|)}
\CommentTok{\#   (Intercept) {-}1.27152    0.04584 {-}27.736  \textless{} 2e{-}16 ***}
\CommentTok{\#   A0\_PM2.5     0.56168    0.06537   8.592  \textless{} 2e{-}16 *** \textless{}{-} effect of A on M}
\CommentTok{\#   L0\_male      0.25455    0.04425   5.753 8.77e{-}09 ***}
\CommentTok{\#   L0\_soc\_env   0.32683    0.04731   6.908 4.91e{-}12 ***}
\FunctionTok{exp}\NormalTok{(}\FunctionTok{coefficients}\NormalTok{(logit.model.A.M)[}\StringTok{"A0\_PM2.5"}\NormalTok{])}
\CommentTok{\# Odds ratio = 1.753609  for the effect of being exposed to high levels of PM\_2.5}
\CommentTok{\# on the mediator (probability of type 2 diabetes)}

\DocumentationTok{\#\# Model 3 to estimate the direct effect of the exposure (conditional on the outcome) and}
\DocumentationTok{\#\# the effect of M on Y, adjusted for confounders of the A{-}Y and M{-}Y relationships}
\NormalTok{model.A.M.QoL }\OtherTok{\textless{}{-}} \FunctionTok{lm}\NormalTok{(Y\_qol }\SpecialCharTok{\textasciitilde{}}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+}\NormalTok{ M\_diabetes }\SpecialCharTok{+}\NormalTok{ L1 }\SpecialCharTok{+}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env,}
                    \AttributeTok{data =}\NormalTok{ df1)}
\FunctionTok{summary}\NormalTok{(model.A.M.QoL)}
\CommentTok{\# Coefficients:}
\CommentTok{\#               Estimate Std. Error t value Pr(\textgreater{}|t|)}
\CommentTok{\#   (Intercept)  74.7858     0.2130 351.178  \textless{} 2e{-}16 ***}
\CommentTok{\#   A0\_PM2.5     {-}3.9650     0.3212 {-}12.345  \textless{} 2e{-}16 *** \textless{}{-} Direct effect}
\CommentTok{\#   M\_diabetes   {-}8.7138     0.2221 {-}39.237  \textless{} 2e{-}16 *** \textless{}{-} effect of M on Y}
\CommentTok{\#   L1           {-}3.4252     0.2212 {-}15.483  \textless{} 2e{-}16 ***}
\CommentTok{\#   L0\_male      {-}0.7193     0.2017  {-}3.566 0.000364 ***}
\CommentTok{\#   L0\_soc\_env   {-}2.8876     0.2112 {-}13.674  \textless{} 2e{-}16 ***}

\CommentTok{\# The direct effect of PM\_2.5 is approximately {-}4.0 given by the A0\_PM2.5 coefficient}
\NormalTok{model.A.M.QoL}\SpecialCharTok{$}\NormalTok{coefficients[}\StringTok{"A0\_PM2.5"}\NormalTok{]}
\CommentTok{\# {-}3.965038}

\DocumentationTok{\#\# Following the Baron \& Kenny Steps, we would conclude that :}
\CommentTok{\# {-} There is a significant total effect of PM\_2.5 on Quality of Life (Model 1)}
\CommentTok{\# {-} There is a significant effect of PM\_2.5 on the mediator (diabetes) (Model 2)}
\CommentTok{\# {-} There is a significant effect of the mediator (diabetes) on Qol (model 3)}
\CommentTok{\# {-} The direct effect is significantly non{-}null}
\CommentTok{\# =\textgreater{} Conclusion: Diabetes partially mediates the relationship between PM\_2.5 and QoL}

\DocumentationTok{\#\#\# Estimation of the indirect effect:}
\DocumentationTok{\#\#\# We can apply the difference in coefficient method to estimate the indirect effect:}
\DocumentationTok{\#\#\# substract the direct effect from the Total effect:}
\NormalTok{ind.effect.dif.meth }\OtherTok{\textless{}{-}}\NormalTok{ (model.tot.A.QoL}\SpecialCharTok{$}\NormalTok{coefficients[}\StringTok{"A0\_PM2.5"}\NormalTok{] }\SpecialCharTok{{-}}
\NormalTok{                          model.A.M.QoL}\SpecialCharTok{$}\NormalTok{coefficients[}\StringTok{"A0\_PM2.5"}\NormalTok{])}
\CommentTok{\# {-}1.131019}
\CommentTok{\# the indirect effect is approximately {-}1.1}
\CommentTok{\# The confidence interval of the indirect effect can be computed by bootstrap.}

\CommentTok{\# Because the mediator is binary and we applied a logistic regression for Model 2,}
\CommentTok{\# we cannot apply the product of coefficients combining a coefficient from}
\CommentTok{\# Model 2 (logit scale) and from Model 3 (difference scale)}

\DocumentationTok{\#\#\# Model 2bis}
\CommentTok{\# Surprisingly, another possibility is to run a linear model of the binary mediator}
\CommentTok{\# instead of the logistic regression to apply the "product of coefficient method"}
\CommentTok{\# in order to estimate the indirect effect:}
\NormalTok{linear.model.A.M }\OtherTok{\textless{}{-}} \FunctionTok{lm}\NormalTok{(M\_diabetes }\SpecialCharTok{\textasciitilde{}}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env,}
                       \AttributeTok{data =}\NormalTok{ df1)}
\FunctionTok{summary}\NormalTok{(linear.model.A.M)}
\CommentTok{\# Coefficients:}
\CommentTok{\#             Estimate Std. Error t value Pr(\textgreater{}|t|)}
\CommentTok{\# (Intercept) 0.215398   0.008929  24.123  \textless{} 2e{-}16 ***}
\CommentTok{\# A0\_PM2.5    0.127180   0.014446   8.804  \textless{} 2e{-}16 *** \textless{}{-} effect of A on M}
\CommentTok{\# L0\_male     0.052363   0.009091   5.760 8.67e{-}09 ***}
\CommentTok{\# L0\_soc\_env  0.065806   0.009511   6.919 4.83e{-}12 ***}

\DocumentationTok{\#\# product of coefficient method:}
\NormalTok{ind.effect.prod.meth }\OtherTok{\textless{}{-}}\NormalTok{ (linear.model.A.M}\SpecialCharTok{$}\NormalTok{coefficients[}\StringTok{"A0\_PM2.5"}\NormalTok{] }\SpecialCharTok{*}
\NormalTok{                           model.A.M.QoL}\SpecialCharTok{$}\NormalTok{coefficients[}\StringTok{"M\_diabetes"}\NormalTok{])}
\CommentTok{\# {-}1.108213}
\CommentTok{\# which also gives an indirect effect of approximately {-}1.1}
\end{Highlighting}
\end{Shaded}

The Baron \& Kenny approach is usually applied for continuous outcomes, using linear regressions. It is less adapted for binary outcomes.

However, as for the binary mediator, some authors suggested that using linear regressions of the mediator and the outcome could still give some results.

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\#\# Baron \& Kenny approach for binary outcomes:}
\DocumentationTok{\#\# Model 1: linear model of the probability of death to estimate the total effect:}
\NormalTok{model.tot.A.death }\OtherTok{\textless{}{-}} \FunctionTok{lm}\NormalTok{(Y\_death }\SpecialCharTok{\textasciitilde{}}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env,}
                        \AttributeTok{data =}\NormalTok{ df1)}
\FunctionTok{summary}\NormalTok{(model.tot.A.death)}
\CommentTok{\# Coefficients:}
\CommentTok{\#               Estimate Std. Error t value Pr(\textgreater{}|t|)}
\CommentTok{\#   (Intercept) 0.135282   0.007909  17.104  \textless{} 2e{-}16 ***}
\CommentTok{\#   A0\_PM2.5    0.060247   0.012796   4.708 2.53e{-}06 *** \textless{}{-} Total effect}
\CommentTok{\#   L0\_male     0.050285   0.008053   6.244 4.43e{-}10 ***}
\CommentTok{\#   L0\_soc\_env  0.059565   0.008425   7.070 1.65e{-}12 ***}
\CommentTok{\# On a risk difference scale the total effect of being exposed to high levels of}
\CommentTok{\# PM\_2.5 on the probability of death is approximately +6.0\%}

\DocumentationTok{\#\# Model 3: linear model to estimate the direct effect of the exposure (conditional on}
\DocumentationTok{\#\# the outcome) and the effect of M on Y, adjusted for confounders of the A{-}Y}
\DocumentationTok{\#\# and M{-}Y relationships}
\NormalTok{model.A.M.death }\OtherTok{\textless{}{-}} \FunctionTok{lm}\NormalTok{(Y\_death }\SpecialCharTok{\textasciitilde{}}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+}\NormalTok{ M\_diabetes }\SpecialCharTok{+}\NormalTok{ L1 }\SpecialCharTok{+}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env,}
                      \AttributeTok{data =}\NormalTok{ df1)}
\FunctionTok{summary}\NormalTok{(model.A.M.death)}
\CommentTok{\#   Coefficients:}
\CommentTok{\#                          Estimate Std. Error t value Pr(\textgreater{}|t|)}
\CommentTok{\#   (Intercept) 0.098691   0.008460  11.666  \textless{} 2e{-}16 ***}
\CommentTok{\#   A0\_PM2.5    0.051509   0.012759   4.037 5.45e{-}05 *** \textless{}{-} Direct effect}
\CommentTok{\#   M\_diabetes  0.064751   0.008822   7.340 2.31e{-}13 *** \textless{}{-} effect of M on Y}
\CommentTok{\#   L1          0.075533   0.008788   8.595  \textless{} 2e{-}16 ***}
\CommentTok{\#   L0\_male     0.047490   0.008013   5.927 3.19e{-}09 ***}
\CommentTok{\#   L0\_soc\_env  0.055676   0.008389   6.637 3.36e{-}11 ***}


\CommentTok{\# The direct effect is approximately +5.2\% given by the A0\_PM2.5 coefficient}
\NormalTok{model.A.M.death}\SpecialCharTok{$}\NormalTok{coefficients[}\StringTok{"A0\_PM2.5"}\NormalTok{]}
\CommentTok{\# 0.05150901}

\CommentTok{\# The indirect effect can be calculated by the "difference in coefficient" method}
\CommentTok{\# using coefficients from models 1 and 3}
\NormalTok{model.tot.A.death}\SpecialCharTok{$}\NormalTok{coefficients[}\StringTok{"A0\_PM2.5"}\NormalTok{] }\SpecialCharTok{{-}}\NormalTok{ model.A.M.death}\SpecialCharTok{$}\NormalTok{coefficients[}\StringTok{"A0\_PM2.5"}\NormalTok{]}
\CommentTok{\# 0.008737889, i.e. approximately 0.9\%}

\CommentTok{\# or the product of coefficients using the previous model 2bis and model 3:}
\NormalTok{linear.model.A.M}\SpecialCharTok{$}\NormalTok{coefficients[}\StringTok{"A0\_PM2.5"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ model.A.M.death}\SpecialCharTok{$}\NormalTok{coefficients[}\StringTok{"M\_diabetes"}\NormalTok{]}
\CommentTok{\# 0.008234978, i.e. approximately 0.8\%}
\end{Highlighting}
\end{Shaded}

\section{Path analysis and Structural Equation Modeling}\label{path-analysis-and-structural-equation-modeling}

\subsection{First application, without intermediate confouding affected by the exposure}\label{first-application-without-intermediate-confouding-affected-by-the-exposure}

Path analyses can be considered as a ``generalization'' of the product of coefficients method. They combine graphical representation of causal structures, a set of linear equations and assumptions concerning the covariance structure of residuals.

When the causal model includes latent variables (represented by a measurement model), we refer to the analysis as structural equation modeling.

Variables which does not receive causal inputs from any other variable in the diagram are called exogenous variables. Unless the assumption is explicitly made that two exogenous variables are uncorrelated (because they do not have any common causal factor), it is preferable to consider them as not independent (connecting them by double arrows).

In the \texttt{df1.csv} data set, there are 3 exogenous variables: \texttt{L0\_male}, \texttt{L0\_soc\_env} and \texttt{L1}.

We will use the \href{https://lavaan.ugent.be/}{\texttt{lavaan}} R package to run path analyses.

\begin{itemize}
\tightlist
\item
  The first step is to write the model syntax
\item
  The second step is to analyze the model with the dataset
\end{itemize}

For a complete overview of the analyses that can be performed using \texttt{lavaan}, you can read:

\begin{itemize}
\tightlist
\item
  \href{https://lavaan.ugent.be/tutorial/}{the lavaan tutorial}
\item
  \href{https://tdjorgensen.github.io/SEM-in-Ed-compendium/index.html}{A lavaan Compendium for Structural Equation Modeling in Educational Research},(\citeproc{ref-Jak2023}{Jak, Suzanne and Jorgensen, Terrence D. 2024})
\item
  \href{https://gabriellajg.github.io/EPSY-579-R-Cookbook-for-SEM/}{R Cookbook for Structural Equation Modeling},(\citeproc{ref-Jiang2023}{Jiang, Ge 2023})
\end{itemize}

\textbf{First step}. Let us write the model syntax to analyze the effect of being exposed to high levels of \(\text{PM}_{2.5}\) on quality of life, mediated by type-2 diabetes.

We have to define:

\begin{itemize}
\tightlist
\item
  regression models for the endogenous variables: exposure to \(\text{PM}_{2.5}\) (\texttt{A0\_PM2.5}), type-2 diabetes (\texttt{M\_diabetes}) and quality of life (\texttt{Y\_qol})
\item
  covariance assumptions for the exogenous variables
\item
  we can also define additional parameters of interest (in our case, direct, indirect and total effects)
\end{itemize}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(lavaan)}

\NormalTok{sem.QoL }\OtherTok{\textless{}{-}} \StringTok{"                                 \# models are written between quotes}
\StringTok{\#\# Regression models}
\StringTok{\#\# we can also add the names of some path coefficients }
\StringTok{  A0\_PM2.5 \textasciitilde{} L0\_male + L0\_soc\_env}
\StringTok{  M\_diabetes \textasciitilde{} L0\_male + L0\_soc\_env + b.A * A0\_PM2.5 + L1   \# label b.A path coef}
\StringTok{  Y\_qol \textasciitilde{} L0\_male + L0\_soc\_env + c.A*A0\_PM2.5 + L1 + c.M*M\_diabetes \# label c.A and c.M}

\StringTok{\#\# Covariances}
\StringTok{\# Assuming a non{-}null covariance between confounders }
\StringTok{\# covariances are represented with a double tilde \textasciitilde{}\textasciitilde{} (double arrow)}
\StringTok{\# (note: in the data{-}generating system, the null assumptions were true)}
\StringTok{  L0\_male \textasciitilde{}\textasciitilde{} L0\_soc\_env}
\StringTok{  L0\_male \textasciitilde{}\textasciitilde{} L1}
\StringTok{  L0\_soc\_env \textasciitilde{}\textasciitilde{} L1}

\StringTok{\#\# We can define other parameters to estimate, using the := syntax}
\StringTok{\#\# we want the direct, indirect and total effects:}
\StringTok{  direct := c.A}
\StringTok{  indirect := b.A * c.M}
\StringTok{  total := (b.A * c.M) + c.A}
\StringTok{"}
\end{Highlighting}
\end{Shaded}

\textbf{Second step}. Let us analyze the model with the \texttt{df1.csv} dataset using the \texttt{sem} function from the \texttt{lavaan} package.

Binary exogenous variables (\texttt{L0\_male},\texttt{L0\_soc\_env} and \texttt{L1}) can be coded as simple dummy (0/1) variables, there is no need to declare them as factors (\texttt{ordered}).

Note that in the following example, we will not declare the other binary variables (\texttt{A0\_PM2.5},\texttt{M\_diabetes}) as factors and let them as simple dummy variables.

Running the \texttt{sem} function with the \texttt{df1.csv} dataset, we obtain:

\begin{itemize}
\tightlist
\item
  information about the estimator
\item
  estimates of the regression models
\item
  estimates of the covariance between exogenous variables
\item
  estimates of the residual variances
\item
  estimates of the additional parameters (direct, indirect and total effects)
\end{itemize}

For datasets with only continuous variables, \texttt{lavaan} would estimate the covariance structure by maximum likelihood estimation. For categorical data, weighted least square estimators (WLS) are typically used. Applying WLS to continuous data is referred to as asymptotical distribution-free estimation (ADF) in the SEM literature. ADF estimation requires large sample sizes (\textgreater{} 2000 or 5000).(\citeproc{ref-Jak2023}{Jak, Suzanne and Jorgensen, Terrence D. 2024})

In order to avoid underestimating standard errors and confidence intervals, robust estimators (``sandwich'' and bootstrap) are usually applied if the data are not multivariate normal.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{1234}\NormalTok{)}
\NormalTok{fit.qol }\OtherTok{\textless{}{-}}\NormalTok{ lavaan}\SpecialCharTok{::}\FunctionTok{sem}\NormalTok{(}\AttributeTok{model =}\NormalTok{ sem.QoL,}
                       \AttributeTok{fixed.x =} \ConstantTok{FALSE}\NormalTok{, }\CommentTok{\# ask for covariance of exogenous variables}
                                        \CommentTok{\# to be freely estimated }
                       \CommentTok{\# estimator = "DWLS",  \# for WLS estimation}
                       \AttributeTok{se =} \StringTok{"boot"}\NormalTok{, }\CommentTok{\# estimation of SE by bootstrap}
                       \CommentTok{\# se = "robust.sem", \# for sandwich{-}type SE}
                       \AttributeTok{bootstrap =} \DecValTok{100}\NormalTok{, }\CommentTok{\# better with 1000 bootstrap samples or more}
                       \AttributeTok{data =}\NormalTok{ df1)}
\FunctionTok{summary}\NormalTok{(fit.qol,}
        \AttributeTok{ci =} \ConstantTok{TRUE}\NormalTok{) }\CommentTok{\# add 95\%CI in the output}
\CommentTok{\# You will get 2 warning messages: }
\CommentTok{\# 1) we did not standardize the outcome, its variance is very large variance compared  }
\CommentTok{\#    to the other binary variables (not a problem)}
\CommentTok{\# 2) 3 bootstrap runs failed or did not converge. }
\CommentTok{\#    =\textgreater{} The estimations relie on the 97 other bootstrap samples}

\CommentTok{\# lavaan 0.6{-}18 ended normally after 23 iterations}
\CommentTok{\#}
\CommentTok{\#   Estimator                                         ML}
\CommentTok{\#   Optimization method                           NLMINB}
\CommentTok{\#   Number of model parameters                        20}
\CommentTok{\#}
\CommentTok{\#   Number of observations                         10000}
\CommentTok{\#}
\CommentTok{\# Model Test User Model:}
\CommentTok{\#   Test statistic                                 0.211}
\CommentTok{\#   Degrees of freedom                                 1}
\CommentTok{\#   P{-}value (Chi{-}square)                           0.646}
\CommentTok{\#}
\CommentTok{\# Parameter Estimates:}
\CommentTok{\#   Standard errors                            Bootstrap}
\CommentTok{\#   Number of requested bootstrap draws              100}
\CommentTok{\#   Number of successful bootstrap draws              97}
\CommentTok{\#}
\CommentTok{\# Regressions:}
\CommentTok{\#                  Estimate  Std.Err  z{-}value  P(\textgreater{}|z|) ci.lower ci.upper}
\CommentTok{\# A0\_PM2.5 \textasciitilde{}}
\CommentTok{\#   L0\_male           0.040    0.005    7.310    0.000    0.029    0.050}
\CommentTok{\#   L0\_sc\_nv          0.058    0.006    9.243    0.000    0.046    0.071}
\CommentTok{\# M\_diabetes \textasciitilde{}}
\CommentTok{\#   L0\_male           0.053    0.009    5.626    0.000    0.033    0.074}
\CommentTok{\#   L0\_sc\_nv          0.066    0.010    6.948    0.000    0.047    0.088}
\CommentTok{\#   A0\_PM2.5 (b.A)    0.127    0.015    8.475    0.000    0.100    0.156}
\CommentTok{\#   L1                0.070    0.011    6.391    0.000    0.046    0.088}
\CommentTok{\# Y\_qol \textasciitilde{}}
\CommentTok{\#   L0\_male          {-}0.719    0.190   {-}3.777    0.000   {-}1.081   {-}0.314}
\CommentTok{\#   L0\_sc\_nv         {-}2.888    0.210  {-}13.760    0.000   {-}3.262   {-}2.408}
\CommentTok{\#   A0\_PM2.5 (c.A)   {-}3.965    0.331  {-}11.977    0.000   {-}4.631   {-}3.262}
\CommentTok{\#   L1               {-}3.425    0.189  {-}18.136    0.000   {-}3.808   {-}3.043}
\CommentTok{\#   M\_diabts (c.M)   {-}8.714    0.211  {-}41.394    0.000   {-}9.082   {-}8.280}
\CommentTok{\#}
\CommentTok{\# Covariances:}
\CommentTok{\#                  Estimate  Std.Err  z{-}value  P(\textgreater{}|z|) ci.lower ci.upper}
\CommentTok{\# L0\_male \textasciitilde{}\textasciitilde{}}
\CommentTok{\#   L0\_soc\_env       {-}0.003    0.003   {-}1.055    0.291   {-}0.008    0.004}
\CommentTok{\#   L1               {-}0.002    0.002   {-}0.887    0.375   {-}0.006    0.002}
\CommentTok{\# L0\_soc\_env \textasciitilde{}\textasciitilde{}}
\CommentTok{\#   L1               {-}0.001    0.002   {-}0.452    0.651   {-}0.006    0.003}
\CommentTok{\#}
\CommentTok{\# Variances:}
\CommentTok{\#                  Estimate  Std.Err  z{-}value  P(\textgreater{}|z|) ci.lower ci.upper}
\CommentTok{\#  .A0\_PM2.5          0.099    0.002   43.273    0.000    0.094    0.103}
\CommentTok{\#  .M\_diabetes        0.205    0.002  114.604    0.000    0.200    0.208}
\CommentTok{\#  .Y\_qol           100.882    1.409   71.573    0.000   98.185  103.725}
\CommentTok{\#   L0\_male           0.250    0.000 9358.475    0.000    0.250    0.250}
\CommentTok{\#   L0\_soc\_env        0.229    0.001  166.244    0.000    0.226    0.232}
\CommentTok{\#   L1                0.207    0.002  117.109    0.000    0.204    0.210}
\CommentTok{\#}
\CommentTok{\# Defined Parameters:}
\CommentTok{\#                Estimate  Std.Err  z{-}value  P(\textgreater{}|z|) ci.lower ci.upper}
\CommentTok{\# direct           {-}3.965    0.333  {-}11.915    0.000   {-}4.631   {-}3.262}
\CommentTok{\# indirect         {-}1.104    0.129   {-}8.586    0.000   {-}1.359   {-}0.866}
\CommentTok{\# total            {-}5.069    0.358  {-}14.170    0.000   {-}5.843   {-}4.343}

\CommentTok{\# ?lavaan::parameterEstimates for more options on bootstrap SE estimations.}
\FunctionTok{parameterEstimates}\NormalTok{(fit.qol,}
                   \AttributeTok{level =} \FloatTok{0.95}\NormalTok{,}
                   \AttributeTok{boot.ci.type =} \StringTok{"bca.simple"}\NormalTok{) }\CommentTok{\# "bca.simple" to correct for bias,}
                                                \CommentTok{\# but not acceleration}
\CommentTok{\#           lhs op           rhs    label     est    se        z pvalue ci.lower ci.upper}
\CommentTok{\# 1    A0\_PM2.5  \textasciitilde{}       L0\_male            0.040 0.005    7.310  0.000    0.031    0.051}
\CommentTok{\# 2    A0\_PM2.5  \textasciitilde{}    L0\_soc\_env            0.058 0.006    9.243  0.000    0.045    0.070}
\CommentTok{\# ...}
\CommentTok{\# 21     direct :=           c.A   direct  {-}3.965 0.333  {-}11.915  0.000   {-}4.544   {-}3.190}
\CommentTok{\# 22   indirect :=       b.A*c.M indirect  {-}1.104 0.129   {-}8.586  0.000   {-}1.401   {-}0.897}
\CommentTok{\# 23      total := (b.A*c.M)+c.A    total  {-}5.069 0.358  {-}14.170  0.000   {-}5.658   {-}4.201}
\end{Highlighting}
\end{Shaded}

We recall that the results obtained using Baron \& Kenny approach were:

\begin{itemize}
\tightlist
\item
  direct effect = -3.965
\item
  indirect effect = -1.131 (using the ``difference in coefficients'' method) or -1.108213 (using the ``product of coefficients'' method)
\item
  total effect = -5.096
\end{itemize}

The path analysis results from \texttt{lavaan} are very close to the Baron \& Kenny results.

We can plot the estimated model using the \texttt{semPlot} package (Figure \ref{fig:FigSemPlotQol1}):

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(semPlot)}
\FunctionTok{semPaths}\NormalTok{(fit.qol,}
         \AttributeTok{what =} \StringTok{"est"}\NormalTok{,}
         \AttributeTok{layout =} \StringTok{"tree2"}\NormalTok{, }\CommentTok{\# tree, tree2, spring}
         \AttributeTok{rotation =} \DecValTok{2}\NormalTok{, }\CommentTok{\#exogenous on the left, endogenous on the right}
         \AttributeTok{sizeMan =} \DecValTok{10}\NormalTok{, }\CommentTok{\# font size of manifest variable names}
         \AttributeTok{nCharNodes =} \DecValTok{0}\NormalTok{,}
         \AttributeTok{nCharEdges =} \DecValTok{0}\NormalTok{, }\CommentTok{\# don\textquotesingle{}t limit variable name lengths}
         \AttributeTok{edge.label.cex =} \FloatTok{0.6}\NormalTok{,}
         \AttributeTok{curvePivot =} \ConstantTok{TRUE}\NormalTok{,}
         \AttributeTok{fade =} \ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.7\linewidth]{./figures/sem_plot} 

}

\caption{Plot of the SEM}\label{fig:FigSemPlotQol1}
\end{figure}

\subsection{Dealing with categorical endogenous variables}\label{dealing-with-categorical-endogenous-variables}

In the dataset, we can declare the binary endogenous variables as \texttt{ordered} variables, so that the \texttt{sem} function will detect them automatically as categorical variables, and apply a Weighted Least Square estimation.

When endogenous variables are binary or ordered categorical variables, the SEM-method will assume the existence of latent normal variables that underlies the observed categorical variables (corresponding to \emph{latent response variables} (LRV)). SEM will then fit the model to the LRV instead of the categorical variables. The distribution of a categorical variable is linked to the LRV using ``thresholds'', defined from the cumulative distribution function of a standard normal distribution to match the probabilities of observed levels (similarly to probit regressions).(\citeproc{ref-Jak2023}{Jak, Suzanne and Jorgensen, Terrence D. 2024})

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# We first create a data.frame, setting the exposure and mediator to ordered variables}
\NormalTok{df1.cat }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}\AttributeTok{L0\_male =}\NormalTok{ df1}\SpecialCharTok{$}\NormalTok{L0\_male,}
                      \AttributeTok{L0\_soc\_env =}\NormalTok{ df1}\SpecialCharTok{$}\NormalTok{L0\_soc\_env,}
                      \AttributeTok{A0\_PM2.5 =} \FunctionTok{ordered}\NormalTok{(df1}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\NormalTok{), }
                      \AttributeTok{L1 =}\NormalTok{ df1}\SpecialCharTok{$}\NormalTok{L1,}
                      \AttributeTok{M\_diabetes =} \FunctionTok{ordered}\NormalTok{(df1}\SpecialCharTok{$}\NormalTok{M\_diabetes), }
                      \AttributeTok{Y\_qol =}\NormalTok{ df1}\SpecialCharTok{$}\NormalTok{Y\_qol)}

\DocumentationTok{\#\# We analyze the model with the new data.frame (df1.cat)}
\DocumentationTok{\#\# In this example, we estimate standwich{-}type standard errors}
\NormalTok{fit.qol }\OtherTok{\textless{}{-}}\NormalTok{ lavaan}\SpecialCharTok{::}\FunctionTok{sem}\NormalTok{(}\AttributeTok{model =}\NormalTok{ sem.QoL,}
                       \AttributeTok{se =} \StringTok{"robust.sem"}\NormalTok{, }\CommentTok{\# for sandwich{-}type SE}
                       \AttributeTok{fixed.x =} \ConstantTok{FALSE}\NormalTok{,}
                       \AttributeTok{data =}\NormalTok{ df1.cat)}
\CommentTok{\# You will get 2 warnings:}
\CommentTok{\# 1) A generalized inverse for A11 submatrix was used to solve a trouble}
\CommentTok{\#    constructing W matrix}
\CommentTok{\# 2) The variance{-}covariance matrix of the vcov does not appear to be positive definite.}
\CommentTok{\#    Probably because the mean and variance of binary variable are collinear.}
\CommentTok{\#    This message might be quite common and can be ignored}
\FunctionTok{summary}\NormalTok{(fit.qol,}
        \AttributeTok{ci =} \ConstantTok{TRUE}\NormalTok{)}
\CommentTok{\# lavaan 0.6{-}18 ended normally after 76 iterations}
\CommentTok{\#}
\CommentTok{\# Estimator                                       DWLS  \# apply WLS estimator}
\CommentTok{\# Optimization method                           NLMINB}
\CommentTok{\# Number of model parameters                        24}
\CommentTok{\#}
\CommentTok{\# Number of observations                         10000}
\CommentTok{\#}
\CommentTok{\# Model Test User Model:}
\CommentTok{\#   Standard      Scaled}
\CommentTok{\# Test Statistic                                 0.209       0.214}
\CommentTok{\# Degrees of freedom                                 1           1}
\CommentTok{\# P{-}value (Chi{-}square)                           0.648       0.644}
\CommentTok{\# Scaling correction factor                                  0.977}
\CommentTok{\# Shift parameter                                           {-}0.000}
\CommentTok{\# simple second{-}order correction}
\CommentTok{\#}
\CommentTok{\# Parameter Estimates:}
\CommentTok{\#   Parameterization                               Delta}
\CommentTok{\#   Standard errors                           Robust.sem}
\CommentTok{\#   Information                                 Expected}
\CommentTok{\#   Information saturated (h1) model        Unstructured}
\CommentTok{\#}
\CommentTok{\# Regressions:}
\CommentTok{\#                  Estimate  Std.Err  z{-}value   P(\textgreater{}|z|) ci.lower ci.upper}
\CommentTok{\# A0\_PM2.5 \textasciitilde{}}
\CommentTok{\#   L0\_male           0.209    0.033     6.394    0.000    0.145    0.273}
\CommentTok{\#   L0\_sc\_nv          0.324    0.035     9.129    0.000    0.254    0.393}
\CommentTok{\# M\_diabetes \textasciitilde{}}
\CommentTok{\#   L0\_male           0.129    0.027     4.846    0.000    0.077    0.181}
\CommentTok{\#   L0\_sc\_nv          0.156    0.029     5.463    0.000    0.100    0.212}
\CommentTok{\#   A0\_PM2.5 (b.A)    0.182    0.021     8.498    0.000    0.140    0.224}
\CommentTok{\#   L1                0.199    0.028     7.083    0.000    0.144    0.254}
\CommentTok{\# Y\_qol \textasciitilde{}}
\CommentTok{\#   L0\_male          {-}0.193    0.214    {-}0.899    0.369   {-}0.613    0.227}
\CommentTok{\#   L0\_sc\_nv         {-}2.130    0.232    {-}9.195    0.000   {-}2.585   {-}1.676}
\CommentTok{\#   A0\_PM2.5 (c.A)   {-}1.754    0.169   {-}10.351    0.000   {-}2.086   {-}1.422}
\CommentTok{\#   L1               {-}3.070    0.229   {-}13.411    0.000   {-}3.519   {-}2.621}
\CommentTok{\#   M\_diabts (c.M)   {-}4.927    0.142   {-}34.802    0.000   {-}5.204   {-}4.649}
\CommentTok{\#}
\CommentTok{\# Covariances:}
\CommentTok{\#   Estimate  Std.Err  z{-}value   P(\textgreater{}|z|) ci.lower ci.upper}
\CommentTok{\# L0\_male \textasciitilde{}\textasciitilde{}}
\CommentTok{\#   L0\_soc\_env       {-}0.003    0.002    {-}1.167    0.243   {-}0.007    0.002}
\CommentTok{\#   L1               {-}0.002    0.002    {-}0.801    0.423   {-}0.006    0.003}
\CommentTok{\# L0\_soc\_env \textasciitilde{}\textasciitilde{}}
\CommentTok{\#   L1               {-}0.001    0.002    {-}0.425    0.671   {-}0.005    0.003}
\CommentTok{\#}
\CommentTok{\# Intercepts:}
\CommentTok{\#                  Estimate  Std.Err  z{-}value   P(\textgreater{}|z|) ci.lower ci.upper}
\CommentTok{\#  .Y\_qol            72.816    0.228   319.590    0.000   72.370   73.263}
\CommentTok{\#   L0\_male           0.501    0.005   100.197    0.000    0.491    0.511}
\CommentTok{\#   L0\_soc\_env        0.644    0.003   187.422    0.000    0.637    0.651}
\CommentTok{\#   L1                0.293    0.002   128.425    0.000    0.289    0.298}
\CommentTok{\#}
\CommentTok{\# Thresholds:}
\CommentTok{\#                Estimate  Std.Err  z{-}value   P(\textgreater{}|z|) ci.lower ci.upper}
\CommentTok{\# A0\_PM2.5|t1       1.527    0.031    48.583    0.000    1.465    1.589}
\CommentTok{\# M\_diabetes|t1     0.810    0.026    30.789    0.000    0.758    0.861}
\CommentTok{\#}
\CommentTok{\# Variances:}
\CommentTok{\#                  Estimate  Std.Err  z{-}value   P(\textgreater{}|z|) ci.lower ci.upper}
\CommentTok{\#  .A0\_PM2.5          0.965                                0.965    0.965}
\CommentTok{\#  .M\_diabetes        0.975                                0.975    0.975}
\CommentTok{\#  .Y\_qol            88.521    1.538    57.551    0.000   85.506   91.535}
\CommentTok{\#   L0\_male           0.250    0.000 12499.500    0.000    0.250    0.250}
\CommentTok{\#   L0\_soc\_env        0.229    0.002   106.346    0.000    0.225    0.234}
\CommentTok{\#   L1                0.207    0.002    91.060    0.000    0.203    0.212}
\CommentTok{\#}
\CommentTok{\# Defined Parameters:}
\CommentTok{\#                Estimate  Std.Err  z{-}value   P(\textgreater{}|z|) ci.lower ci.upper}
\CommentTok{\# direct           {-}1.754    0.169   {-}10.351    0.000   {-}2.086   {-}1.422}
\CommentTok{\# indirect         {-}0.896    0.099    {-}9.041    0.000   {-}1.091   {-}0.702}
\CommentTok{\# total            {-}2.651    0.177   {-}14.942    0.000   {-}2.998   {-}2.303}
\end{Highlighting}
\end{Shaded}

The results of the direct, indirect and total effects are quite different from the Baron \& Kenny estimations and the previous SEM (where categorical exogenous variables were treated as simple dummy variables).

This difference can probably be explained by the fact that the data generating system (used to simulate the data) does not imply latent normal variables underlying the categorical variables. Binary variables were directly simulated using binomial distributions.

If the exposure, mediator and outcome variables are a mix of continuous and categorical variables, (\citeproc{ref-Iacobucci2008}{Iacobucci 2008}) recommends to treat them as simple dummy variables (and as continuous variables when fitting the models).

\subsection{Application with intermediate confounding affected by the exposure}\label{application-with-intermediate-confounding-affected-by-the-exposure}

Under the causal model where the intermediate confounder \(L(1)\) of the \(M-Y\) relationship is affected by the exposure \(A\) (Causal model 2, Figure \ref{fig:figDAGM2}), we can describe 4 directed paths connecting the exposure to the outcome :

\begin{enumerate}
\def\labelenumi{(\roman{enumi})}
\tightlist
\item
  the path \(A \rightarrow Y\),
\item
  the path \(A \rightarrow L(1) \rightarrow Y\)
\item
  the path \(A \rightarrow M \rightarrow Y\)
\item
  and the path \(A \rightarrow L(1) \rightarrow M \rightarrow Y\)
\end{enumerate}

In the causal inference literature,

\begin{itemize}
\tightlist
\item
  the \emph{Marginal Randomized (or Interventional) Indirect Effect} (MRIE), described by (\citeproc{ref-vanderweele2016}{VanderWeele and Tchetgen Tchetgen 2017}), can be considered as an analogue of the set of directed paths from \(A\) to \(Y\) going through the mediator \(M\) (i.e.~paths (iii) \(A \rightarrow M \rightarrow Y\) and (iv) \(A \rightarrow L(1) \rightarrow M \rightarrow Y\))
\item
  and the \emph{Marginal Randomized (or Interventional) Direct Effect} (MRDE), corresponds to the other paths (i.e.~paths (i) \(A \rightarrow Y\) and (ii) \(A \rightarrow L(1) \rightarrow Y\)).
\end{itemize}

Regarding the \emph{conditional effects} described by (\citeproc{ref-zheng2017longitudinal}{Zheng and van der Laan 2017}),

\begin{itemize}
\tightlist
\item
  the \emph{Conditional Randomized (or Interventional) Indirect Effect} (CRIE), described by Lin et al. (\citeproc{ref-lin2017}{2017}), can be considered as an analogue of the specific paths from \(A\) to \(Y\) going only through the mediator \(M\) (i.e.~path (iii) \(A \rightarrow M \rightarrow Y\))
\item
  and the \emph{Conditional Randomized (or Interventional) Direct Effect} (CRDE), corresponds to the other paths (i.e.~paths (i) \(A \rightarrow Y\) and (ii) \(A \rightarrow L(1) \rightarrow Y\) and (iv) \(A \rightarrow L(1) \rightarrow M \rightarrow Y\)).
\end{itemize}

We can estimate the 4 paths by SEM analysis. Using the \texttt{df2.csv} dataset (without \(A\ast M\) interaction effect on the outcome), we will explore the effect of the exposure to high levels of \(\text{PM}_{2.5}\) on quality of life (\(Y\)), through type-2 diabetes (mediator of interest \(M\)), where overweight \(L(1)\) is affected by the exposure.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df2 }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file =} \StringTok{"data/df2.csv"}\NormalTok{)}
\FunctionTok{head}\NormalTok{(df2)}
\CommentTok{\#   L0\_male L0\_soc\_env A0\_PM2.5 L1 M\_diabetes Y\_death    Y\_qol}
\CommentTok{\# 1       0          1        0  1          0       0 91.91819}
\CommentTok{\# 2       1          1        1  0          0       1 67.53221}
\CommentTok{\# 3       1          1        0  0          0       0 75.56249}
\CommentTok{\# 4       1          0        0  0          0       0 89.77055}
\CommentTok{\# 5       1          1        0  1          1       1 63.22353}
\CommentTok{\# 6       1          1        0  1          0       0 77.87975}

\DocumentationTok{\#\# quality of life {-}{-}{-}{-}}
\DocumentationTok{\#\# First step: write the model syntax}
\NormalTok{sem.QoL.df2 }\OtherTok{\textless{}{-}} \StringTok{"}
\StringTok{  \#\# SEM for quantitative outcome (QoL)}
\StringTok{  \# Regression models}
\StringTok{    A0\_PM2.5 \textasciitilde{} a.L01 * L0\_male + a.L02 * L0\_soc\_env}
\StringTok{    L1 \textasciitilde{} b.L01 * L0\_male + b.L02 * L0\_soc\_env + b.A * A0\_PM2.5}
\StringTok{    M\_diabetes \textasciitilde{} c.L01 * L0\_male + c.L02 * L0\_soc\_env + c.A * A0\_PM2.5 + c.L1 * L1}
\StringTok{    Y\_qol \textasciitilde{} d.01 * L0\_male + d.02 * L0\_soc\_env + d.A * A0\_PM2.5 + d.L1 * L1 + d.M * M\_diabetes}

\StringTok{  \# Assuming the possibility of non{-}null covariance between confounders}
\StringTok{  \# (note: in the data{-}generating system, the null assumptions were true)}
\StringTok{    L0\_male \textasciitilde{}\textasciitilde{} L0\_soc\_env}

\StringTok{  \# define other parameters: specific paths, direct, indirect and total effects}
\StringTok{    path.A\_Y := d.A}
\StringTok{    path.A\_L1\_Y := b.A * d.L1}
\StringTok{    path.A\_M\_Y := c.A * d.M}
\StringTok{    path.A\_L1\_M\_Y := b.A * c.L1 * d.M}
\StringTok{    MRDE := d.A + (b.A * d.L1)}
\StringTok{    MRIE := (c.A * d.M) + (b.A * c.L1 * d.M)}
\StringTok{    CRDE := d.A + (b.A * d.L1) + (b.A * c.L1 * d.M)}
\StringTok{    CRIE := (c.A * d.M)}
\StringTok{    total := d.A + (b.A * d.L1) + (c.A * d.M) + (b.A * c.L1 * d.M)}
\StringTok{  "}

\DocumentationTok{\#\# Second step: estimate the model with the df2 dataset}
\NormalTok{fit.qol.df2 }\OtherTok{\textless{}{-}}\NormalTok{ lavaan}\SpecialCharTok{::}\FunctionTok{sem}\NormalTok{(}\AttributeTok{model =}\NormalTok{ sem.QoL.df2,}
                           \AttributeTok{se =} \StringTok{"robust.sem"}\NormalTok{, }\CommentTok{\# for sandwich{-}type SE}
                           \AttributeTok{fixed.x =} \ConstantTok{FALSE}\NormalTok{,}
                           \AttributeTok{data =}\NormalTok{ df2)}
\FunctionTok{summary}\NormalTok{(fit.qol.df2,}
        \AttributeTok{ci =} \ConstantTok{TRUE}\NormalTok{)}
\CommentTok{\# lavaan 0.6{-}18 ended normally after 18 iterations}
\CommentTok{\#}
\CommentTok{\# Estimator                                         ML}
\CommentTok{\# Optimization method                           NLMINB}
\CommentTok{\# Number of model parameters                        21}
\CommentTok{\#}
\CommentTok{\# Number of observations                         10000}
\CommentTok{\#}
\CommentTok{\# Model Test User Model:}
\CommentTok{\#   Test statistic                                 0.000}
\CommentTok{\#   Degrees of freedom                                 0}
\CommentTok{\#}
\CommentTok{\# Parameter Estimates:}
\CommentTok{\#   Standard errors                           Robust.sem}
\CommentTok{\#   Information                                 Expected}
\CommentTok{\#   Information saturated (h1) model          Structured}
\CommentTok{\#}
\CommentTok{\# Regressions:}
\CommentTok{\#                  Estimate  Std.Err  z{-}value   P(\textgreater{}|z|) ci.lower ci.upper}
\CommentTok{\# A0\_PM2.5 \textasciitilde{}}
\CommentTok{\#   L0\_mal (a.L01)    0.040    0.006     6.339    0.000    0.027    0.052}
\CommentTok{\#   L0\_sc\_ (a.L02)    0.058    0.006     9.527    0.000    0.046    0.070}
\CommentTok{\# L1 \textasciitilde{}}
\CommentTok{\#   L0\_mal (b.L01)   {-}0.043    0.009    {-}4.638    0.000   {-}0.062   {-}0.025}
\CommentTok{\#   L0\_sc\_ (b.L02)    0.069    0.010     7.166    0.000    0.050    0.088}
\CommentTok{\#   A0\_PM2   (b.A)    0.226    0.016    14.373    0.000    0.195    0.257}
\CommentTok{\# M\_diabetes \textasciitilde{}}
\CommentTok{\#   L0\_mal (c.L01)    0.052    0.009     5.662    0.000    0.034    0.070}
\CommentTok{\#   L0\_sc\_ (c.L02)    0.064    0.010     6.692    0.000    0.045    0.082}
\CommentTok{\#   A0\_PM2   (c.A)    0.072    0.016     4.567    0.000    0.041    0.103}
\CommentTok{\#   L1      (c.L1)    0.194    0.010    18.962    0.000    0.174    0.215}
\CommentTok{\# Y\_qol \textasciitilde{}}
\CommentTok{\#   L0\_mal  (d.01)   {-}0.725    0.202    {-}3.591    0.000   {-}1.121   {-}0.329}
\CommentTok{\#   L0\_sc\_  (d.02)   {-}2.881    0.210   {-}13.722    0.000   {-}3.292   {-}2.469}
\CommentTok{\#   A0\_PM2   (d.A)   {-}3.926    0.329   {-}11.945    0.000   {-}4.570   {-}3.282}
\CommentTok{\#   L1      (d.L1)   {-}5.165    0.217   {-}23.794    0.000   {-}5.591   {-}4.740}
\CommentTok{\#   M\_dbts   (d.M)   {-}8.698    0.217   {-}40.020    0.000   {-}9.124   {-}8.272}
\CommentTok{\#}
\CommentTok{\# Covariances:}
\CommentTok{\#                  Estimate  Std.Err  z{-}value   P(\textgreater{}|z|) ci.lower ci.upper}
\CommentTok{\# L0\_male \textasciitilde{}\textasciitilde{}}
\CommentTok{\#   L0\_soc\_env       {-}0.003    0.002    {-}1.167    0.243   {-}0.007    0.002}
\CommentTok{\#}
\CommentTok{\# Variances:}
\CommentTok{\#                  Estimate  Std.Err  z{-}value   P(\textgreater{}|z|) ci.lower ci.upper}
\CommentTok{\#  .A0\_PM2.5          0.099    0.002    41.100    0.000    0.094    0.103}
\CommentTok{\#  .L1                0.219    0.002   135.196    0.000    0.216    0.222}
\CommentTok{\#  .M\_diabetes        0.212    0.002   123.351    0.000    0.208    0.215}
\CommentTok{\#  .Y\_qol           100.878    1.409    71.598    0.000   98.117  103.640}
\CommentTok{\#   L0\_male           0.250    0.000 24999.950    0.000    0.250    0.250}
\CommentTok{\#   L0\_soc\_env        0.229    0.001   166.381    0.000    0.227    0.232}
\CommentTok{\#}
\CommentTok{\# Defined Parameters:}
\CommentTok{\#                Estimate  Std.Err  z{-}value   P(\textgreater{}|z|) ci.lower ci.upper}
\CommentTok{\# path.A\_Y         {-}3.926    0.329   {-}11.945    0.000   {-}4.570   {-}3.282}
\CommentTok{\# path.A\_L1\_Y      {-}1.168    0.095   {-}12.322    0.000   {-}1.354   {-}0.982}
\CommentTok{\# path.A\_M\_Y       {-}0.625    0.138    {-}4.536    0.000   {-}0.895   {-}0.355}
\CommentTok{\# path.A\_L1\_M\_Y    {-}0.382    0.035   {-}10.999    0.000   {-}0.451   {-}0.314}
\CommentTok{\# MRDE             {-}5.093    0.336   {-}15.170    0.000   {-}5.751   {-}4.435}
\CommentTok{\# MRIE             {-}1.007    0.139    {-}7.228    0.000   {-}1.280   {-}0.734}
\CommentTok{\# CRDE             {-}5.476    0.343   {-}15.942    0.000   {-}6.149   {-}4.803}
\CommentTok{\# CRIE             {-}0.625    0.138    {-}4.536    0.000   {-}0.895   {-}0.355}
\CommentTok{\# total            {-}6.101    0.370   {-}16.500    0.000   {-}6.825   {-}5.376}
\end{Highlighting}
\end{Shaded}

\chapter{Traditional regression models}\label{ChapTradRegModels}

Traditional regression models can be applied in the absence of an intermediate confounder \(L(1)\) of the \(M-Y\) relationship affected by the exposure \(A\) (Causal model 1). They can be used for two-way, three-way and four-way decomposition of the average total effect.

In the following examples, we use the \texttt{df1\_int.csv} data set with a \(A \star M\) interaction effect on the outcome.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df1\_int }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file =} \StringTok{"df1\_int.csv"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

If we assumed that there was no \(A \star M\) interaction, then the \texttt{A0\_PM2.5:M\_diabetes} interaction terms should be removed from the models below (applicable if we use the \texttt{df1.csv} data set).

\section{Estimation of the Average Total Effect (ATE)}\label{estimation-of-the-average-total-effect-ate}

The average total effect is the difference between the mean outcome had the whole population been exposed to high levels of \(\text{PM}_{2.5}\), compared to the mean outcome had the whole population been unexposed:
\(\text{ATE} = \mathbb{E}(Y_{A=1}) - \mathbb{E}(Y_{A=0})\).

For the quantitative outcome, the ATE of the exposure to high levels of \(\text{PM}_{2.5}\) \((A =1 \text{ versus } A=0)\) on the quality of life score \(Y\) can be estimated using a traditional linear regression of \texttt{Y\_qol} on \texttt{A0\_PM2.5}, adjusted for the baseline confounders \texttt{L0\_male} and \texttt{L0\_parent\_low\_educ\_lv}.

For the binary outcome (death), we can estimate a risk difference applying a Generalized Linear Model with a Gaussian distribution and identity link, as suggested by Naimi \emph{et al} (\citeproc{ref-naimi2020}{Naimi and Whitcomb 2020}).

The regression coefficient of the exposure variable \(A\) is used to estimate the risk difference or the average difference.
\begin{equation} 
  \mathbb{E}(Y \mid A, L(0)) = \alpha_0 + \alpha_A A + \alpha_{L(0)} L(0) 
  \label{eq:regtotaleffect}
\end{equation}

\[ \hat{\Psi}_{\text{trad}}^{\text{ATE}} = \hat{\alpha}_A\]

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# Import data}
\FunctionTok{rm}\NormalTok{(}\AttributeTok{list=}\FunctionTok{ls}\NormalTok{())}
\NormalTok{df1\_int }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file =} \StringTok{"./data/df1\_int.csv"}\NormalTok{)}

\DocumentationTok{\#\# For quantitative outcomes, apply a linear regression of Y on A (A0\_PM2.5), }
\DocumentationTok{\#\# adjusted for the baseline confounders L(0):}
\NormalTok{trad\_ATE\_qol }\OtherTok{\textless{}{-}} \FunctionTok{lm}\NormalTok{(Y\_qol }\SpecialCharTok{\textasciitilde{}}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env,}
                   \AttributeTok{data =}\NormalTok{ df1\_int)}

\DocumentationTok{\#\# For binary outcomes, apply a GLM of Y on A with a Gaussian distribution and}
\DocumentationTok{\#\# identity link, adjusted for the baseline confounders:}
\NormalTok{trad\_ATE\_death }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Y\_death }\SpecialCharTok{\textasciitilde{}}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env,}
                      \AttributeTok{family =} \FunctionTok{gaussian}\NormalTok{(}\StringTok{"identity"}\NormalTok{),}
                      \AttributeTok{data =}\NormalTok{ df1\_int)}

\DocumentationTok{\#\# Use the regression coefficient of the exposure (A0\_PM2.5) to estimate the ATE}
\NormalTok{ATE\_trad\_qol }\OtherTok{\textless{}{-}} \FunctionTok{coefficients}\NormalTok{(trad\_ATE\_qol)[}\StringTok{"A0\_PM2.5"}\NormalTok{]}
\CommentTok{\# {-}7.210089}

\NormalTok{ATE\_trad\_death }\OtherTok{\textless{}{-}} \FunctionTok{coefficients}\NormalTok{(trad\_ATE\_death)[}\StringTok{"A0\_PM2.5"}\NormalTok{]}
\CommentTok{\# 0.07720726}
\end{Highlighting}
\end{Shaded}

The estimation of 95\% confidence intervals could be obtained directly from the linear regression with quantitative outcomes (equation \eqref{eq:regtotaleffect}). However, using a robust (sandwich) variance estimator or applying a bootstrap procedure is recommended (\citeproc{ref-naimi2020}{Naimi and Whitcomb 2020}).

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(sandwich)}
\NormalTok{?sandwich}
\DocumentationTok{\#\# the sandwich() function returns a sandwich covariance matrix estimate}
\DocumentationTok{\#\# for the Quality of Life outcome}
\NormalTok{ATE\_trad\_qol }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\AttributeTok{ATE =} \FunctionTok{coef}\NormalTok{(trad\_ATE\_qol)[}\StringTok{"A0\_PM2.5"}\NormalTok{],}
                     \AttributeTok{lo =} \FunctionTok{coef}\NormalTok{(trad\_ATE\_qol)[}\StringTok{"A0\_PM2.5"}\NormalTok{] }\SpecialCharTok{{-}} \FunctionTok{qnorm}\NormalTok{(}\FloatTok{0.975}\NormalTok{) }\SpecialCharTok{*}
                       \FunctionTok{sqrt}\NormalTok{(}\FunctionTok{sandwich}\NormalTok{(trad\_ATE\_qol)[}\StringTok{"A0\_PM2.5"}\NormalTok{,}\StringTok{"A0\_PM2.5"}\NormalTok{]),}
                     \AttributeTok{hi =} \FunctionTok{coef}\NormalTok{(trad\_ATE\_qol)[}\StringTok{"A0\_PM2.5"}\NormalTok{] }\SpecialCharTok{+} \FunctionTok{qnorm}\NormalTok{(}\FloatTok{0.975}\NormalTok{) }\SpecialCharTok{*}
                       \FunctionTok{sqrt}\NormalTok{(}\FunctionTok{sandwich}\NormalTok{(trad\_ATE\_qol)[}\StringTok{"A0\_PM2.5"}\NormalTok{,}\StringTok{"A0\_PM2.5"}\NormalTok{]))}

\NormalTok{ATE\_trad\_qol}
\CommentTok{\# ATE = {-}7.210089 , IC95\% = [{-}7.978234 ; {-}6.441944]}

\DocumentationTok{\#\# for death outcome}
\NormalTok{ATE\_trad\_death }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\AttributeTok{ATE =} \FunctionTok{coef}\NormalTok{(trad\_ATE\_death)[}\StringTok{"A0\_PM2.5"}\NormalTok{],}
                       \AttributeTok{lo =} \FunctionTok{coef}\NormalTok{(trad\_ATE\_death)[}\StringTok{"A0\_PM2.5"}\NormalTok{] }\SpecialCharTok{{-}} \FunctionTok{qnorm}\NormalTok{(}\FloatTok{0.975}\NormalTok{) }\SpecialCharTok{*}
                         \FunctionTok{sqrt}\NormalTok{(}\FunctionTok{sandwich}\NormalTok{(trad\_ATE\_death)[}\StringTok{"A0\_PM2.5"}\NormalTok{,}\StringTok{"A0\_PM2.5"}\NormalTok{]),}
                       \AttributeTok{hi =} \FunctionTok{coef}\NormalTok{(trad\_ATE\_death)[}\StringTok{"A0\_PM2.5"}\NormalTok{] }\SpecialCharTok{+} \FunctionTok{qnorm}\NormalTok{(}\FloatTok{0.975}\NormalTok{) }\SpecialCharTok{*}
                         \FunctionTok{sqrt}\NormalTok{(}\FunctionTok{sandwich}\NormalTok{(trad\_ATE\_death)[}\StringTok{"A0\_PM2.5"}\NormalTok{,}\StringTok{"A0\_PM2.5"}\NormalTok{]))}
\NormalTok{ATE\_trad\_death}
\CommentTok{\# ATE = 0.07720726 , IC95\% = [0.04945859 ; 0.1049559]}

\DocumentationTok{\#\# 95\% CI calculation applying a bootstrap procedure}
\FunctionTok{library}\NormalTok{(boot)}
\NormalTok{bootfunc }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(data,index)\{}
\NormalTok{  boot\_dat }\OtherTok{\textless{}{-}}\NormalTok{ data[index,]}
\NormalTok{  mod.qol }\OtherTok{\textless{}{-}} \FunctionTok{lm}\NormalTok{(Y\_qol }\SpecialCharTok{\textasciitilde{}}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env,}
                \AttributeTok{data =}\NormalTok{ boot\_dat)}
\NormalTok{  mod.death }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Y\_death }\SpecialCharTok{\textasciitilde{}}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env,}
                   \AttributeTok{family =} \FunctionTok{gaussian}\NormalTok{(}\StringTok{"identity"}\NormalTok{),}
                   \AttributeTok{data =}\NormalTok{ boot\_dat)}
\NormalTok{  est }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\FunctionTok{coef}\NormalTok{(mod.qol)[}\StringTok{"A0\_PM2.5"}\NormalTok{],}
           \FunctionTok{coef}\NormalTok{(mod.death)[}\StringTok{"A0\_PM2.5"}\NormalTok{])}
  \FunctionTok{return}\NormalTok{(est)}
\NormalTok{\}}

\FunctionTok{set.seed}\NormalTok{(}\DecValTok{1234}\NormalTok{)}
\NormalTok{boot\_est }\OtherTok{\textless{}{-}} \FunctionTok{boot}\NormalTok{(df1\_int, bootfunc, }\AttributeTok{R =} \DecValTok{1000}\NormalTok{)}

\DocumentationTok{\#\# the 95\% CI for the estimation of the ATE of ACE on QoL is:}
\FunctionTok{boot.ci}\NormalTok{(boot\_est, }\AttributeTok{index =} \DecValTok{1}\NormalTok{, }\AttributeTok{type =} \StringTok{"norm"}\NormalTok{)}
\CommentTok{\# ({-}7.955, {-}6.445 ) }

\DocumentationTok{\#\# the 95\% CI for the estimation of the ATE of ACE on death is:}
\FunctionTok{boot.ci}\NormalTok{(boot\_est, }\AttributeTok{index =} \DecValTok{2}\NormalTok{, }\AttributeTok{type =} \StringTok{"norm"}\NormalTok{)}
\CommentTok{\# ( 0.0501,  0.1046 )  }
\end{Highlighting}
\end{Shaded}

Alternatively for binary outcomes, the total effect conditional on baseline confounders can be expressed on an Odds Ratio scale \(\text{OR}^{\text{TE}}\), using the logistic regression \eqref{eq:logittotaleffect}.

\begin{equation} 
  \text{logit} P(Y = 1 \mid A, L(0)) = \alpha_0 + \alpha_A A + \alpha_{L(0)}^\prime L(0) 
  \label{eq:logittotaleffect}
\end{equation}

\[ \text{OR}^{\text{TE}} \mid L(0) = \exp \hat{\alpha}_A \]

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{TE\_death\_model }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Y\_death }\SpecialCharTok{\textasciitilde{}}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env,}
                      \AttributeTok{family =} \StringTok{"binomial"}\NormalTok{,}
                      \AttributeTok{data =}\NormalTok{ df1\_int)}
\NormalTok{res\_TE\_death }\OtherTok{\textless{}{-}} \FunctionTok{summary}\NormalTok{(TE\_death\_model)}
\NormalTok{tot.effect.death.OR }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\AttributeTok{OR =} \FunctionTok{exp}\NormalTok{(}\FunctionTok{coef}\NormalTok{(res\_TE\_death)[}\StringTok{"A0\_PM2.5"}\NormalTok{,}\StringTok{"Estimate"}\NormalTok{]),}
                            \AttributeTok{lo =} \FunctionTok{exp}\NormalTok{(}\FunctionTok{coef}\NormalTok{(res\_TE\_death)[}\StringTok{"A0\_PM2.5"}\NormalTok{,}\StringTok{"Estimate"}\NormalTok{] }\SpecialCharTok{{-}}
                                       \FunctionTok{qnorm}\NormalTok{(}\FloatTok{0.975}\NormalTok{) }\SpecialCharTok{*}
                                       \FunctionTok{coef}\NormalTok{(res\_TE\_death)[}\StringTok{"A0\_PM2.5"}\NormalTok{,}\StringTok{"Std. Error"}\NormalTok{]),}
                            \AttributeTok{hi =} \FunctionTok{exp}\NormalTok{(}\FunctionTok{coef}\NormalTok{(res\_TE\_death)[}\StringTok{"A0\_PM2.5"}\NormalTok{,}\StringTok{"Estimate"}\NormalTok{] }\SpecialCharTok{+}
                                       \FunctionTok{qnorm}\NormalTok{(}\FloatTok{0.975}\NormalTok{) }\SpecialCharTok{*}
                                       \FunctionTok{coef}\NormalTok{(res\_TE\_death)[}\StringTok{"A0\_PM2.5"}\NormalTok{,}\StringTok{"Std. Error"}\NormalTok{]))}
\NormalTok{tot.effect.death.OR}
\CommentTok{\# OR = 1.523254 , 95\% CI = [ 1.323317 ; 1.753398]}
\end{Highlighting}
\end{Shaded}

\section{Two-way decomposition}\label{trad2way}

In order to carry-out two-way decomposition mediation analyses, with a binary mediator and a continuous outcome, Valeri and VanderWeele suggest using the following linear regression of the outcome and logistic regression of the mediator:(\citeproc{ref-valeri2013}{Valeri and VanderWeele 2013})
\begin{equation}
\mathbb{E}(Y \mid A, M,L(0),L(1)) = \gamma_0 + \gamma_A A + \gamma_M M + \gamma_{A \ast M} (A \ast M) + \gamma_{L(0)}^\prime L(0) + \gamma_{L(1)}^\prime L(1) 
\label{eq:contoutcomereg}
\end{equation}

\begin{equation} 
\text{logit}P(M=1 \mid A,L(0),L(1)) = \beta_0 + \beta_A A + \beta_{L(0)}^\prime L(0) + \beta_{L(1)}^\prime L(1)
\label{eq:medreg}
\end{equation}

If the outcome is binary, they suggest using the following logistic regression of the outcome instead of the previous linear regression:
\begin{equation}
\small
\text{logit}P(Y \mid A, M,L(0),L(1)) = \gamma_0 + \gamma_A A + \gamma_M M + \gamma_{A \ast M} (A \ast M) + \gamma_{L(0)}^\prime L(0) + \gamma_{L(1)}^\prime L(1) 
\label{eq:binoutcomereg}
\end{equation}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{trad\_qol\_am }\OtherTok{\textless{}{-}} \FunctionTok{lm}\NormalTok{(Y\_qol }\SpecialCharTok{\textasciitilde{}}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+}\NormalTok{ M\_diabetes }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5}\SpecialCharTok{:}\NormalTok{M\_diabetes }\SpecialCharTok{+}
\NormalTok{                    L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ L1,}
                  \AttributeTok{data =}\NormalTok{ df1\_int)}
\NormalTok{gamma.A.q }\OtherTok{\textless{}{-}} \FunctionTok{coef}\NormalTok{(trad\_qol\_am)[}\StringTok{"A0\_PM2.5"}\NormalTok{]}
\NormalTok{gamma.M.q }\OtherTok{\textless{}{-}} \FunctionTok{coef}\NormalTok{(trad\_qol\_am)[}\StringTok{"M\_diabetes"}\NormalTok{]}
\NormalTok{gamma.AM.q }\OtherTok{\textless{}{-}} \FunctionTok{coef}\NormalTok{(trad\_qol\_am)[}\StringTok{"A0\_PM2.5:M\_diabetes"}\NormalTok{]}

\NormalTok{trad\_m }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(M\_diabetes }\SpecialCharTok{\textasciitilde{}}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ L1, }
              \AttributeTok{family =} \StringTok{"binomial"}\NormalTok{,}
              \AttributeTok{data =}\NormalTok{ df1\_int)}
\NormalTok{beta}\FloatTok{.0} \OtherTok{\textless{}{-}} \FunctionTok{coef}\NormalTok{(trad\_m)[}\StringTok{"(Intercept)"}\NormalTok{]}
\NormalTok{beta.A }\OtherTok{\textless{}{-}} \FunctionTok{coef}\NormalTok{(trad\_m)[}\StringTok{"A0\_PM2.5"}\NormalTok{]}

\NormalTok{trad\_death\_am }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Y\_death }\SpecialCharTok{\textasciitilde{}}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+}\NormalTok{ M\_diabetes }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5}\SpecialCharTok{:}\NormalTok{M\_diabetes }\SpecialCharTok{+}
\NormalTok{                       L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ L1,}
                     \AttributeTok{family =} \StringTok{"binomial"}\NormalTok{,}
                     \AttributeTok{data =}\NormalTok{ df1\_int)}
\NormalTok{gamma.A.d }\OtherTok{\textless{}{-}} \FunctionTok{coef}\NormalTok{(trad\_death\_am)[}\StringTok{"A0\_PM2.5"}\NormalTok{]}
\NormalTok{gamma.M.d }\OtherTok{\textless{}{-}} \FunctionTok{coef}\NormalTok{(trad\_death\_am)[}\StringTok{"M\_diabetes"}\NormalTok{]}
\NormalTok{gamma.AM.d }\OtherTok{\textless{}{-}} \FunctionTok{coef}\NormalTok{(trad\_death\_am)[}\StringTok{"A0\_PM2.5:M\_diabetes"}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\subsection{Controlled Direct Effect}\label{trad2waycde}

The Controlled Direct Effect is defined as \(\text{CDE}_m = \mathbb{E}(Y_{A=1,M=m}) - \mathbb{E}(Y_{A=0,M=m})\):

For continuous outcome, using parameters from equation \eqref{eq:contoutcomereg}, it can be estimated by:
\[\text{CDE}_m = \hat{\gamma}_A + \hat{\gamma}_{A \ast M} \times m\]

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\#\# For a continuous outcome}
\CommentTok{\# setting the mediator to M=0}
\NormalTok{trad\_CDE\_qol\_m0 }\OtherTok{\textless{}{-}}\NormalTok{ gamma.A.q }\SpecialCharTok{+}\NormalTok{ gamma.AM.q }\SpecialCharTok{*} \DecValTok{0}
\NormalTok{trad\_CDE\_qol\_m0}
\CommentTok{\# {-}3.715265}
\CommentTok{\# setting the mediator to M=1}
\NormalTok{trad\_CDE\_qol\_m1 }\OtherTok{\textless{}{-}}\NormalTok{ gamma.A.q }\SpecialCharTok{+}\NormalTok{ gamma.AM.q }\SpecialCharTok{*} \DecValTok{1}
\NormalTok{trad\_CDE\_qol\_m1}
\CommentTok{\# {-}9.330657}
\end{Highlighting}
\end{Shaded}

For binary outcomes, using parameters from equation \eqref{eq:binoutcomereg}, it can be estimated on the OR scale by:
\[OR^{\text{CDE}_m} = \text{exp}\left(\hat{\gamma}_A + \hat{\gamma}_{A \ast M} \times m\right)\]

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\#\# For a binary outcome}
\DocumentationTok{\#\# setting the mediator to M=0}
\NormalTok{trad\_OR\_CDE\_death\_m0 }\OtherTok{\textless{}{-}} \FunctionTok{exp}\NormalTok{(gamma.A.d }\SpecialCharTok{+}\NormalTok{ gamma.AM.d }\SpecialCharTok{*} \DecValTok{0}\NormalTok{)}
\NormalTok{trad\_OR\_CDE\_death\_m0}
\CommentTok{\# OR\_CDE\_\{M=0\} = 1.442942 }

\DocumentationTok{\#\# setting the mediator to M=1}
\NormalTok{trad\_OR\_CDE\_death\_m1 }\OtherTok{\textless{}{-}} \FunctionTok{exp}\NormalTok{(gamma.A.d }\SpecialCharTok{+}\NormalTok{ gamma.AM.d }\SpecialCharTok{*} \DecValTok{1}\NormalTok{)}
\NormalTok{trad\_OR\_CDE\_death\_m1}
\CommentTok{\# OR\_CDE\_\{M=1\} = 1.461464 }
\end{Highlighting}
\end{Shaded}

\subsection{Natural Direct and Indirect effects}\label{trad2waynatural}

The Pure Natural Direct Effect (PNDE) and the Total Natural Indirect Effect (TNIE) are defined as:

\begin{itemize}
\tightlist
\item
  \(\text{PNDE} = \mathbb{E}\left(Y_{A=1,M_{A=0}}) - \mathbb{E}(Y_{A=0,M_{A=0}}\right)\),
\item
  \(\text{TNIE} = \mathbb{E}\left(Y_{A=1,M_{A=1}}) - \mathbb{E}(Y_{A=1,M_{A=0}}\right)\).
\end{itemize}

Alternatively, one can use the Total Natural Direct Effect (TNDE) and the Pure Natural Indirect Effect (PNIE):

\begin{itemize}
\tightlist
\item
  \(\text{TNDE} = \mathbb{E}\left(Y_{A=1,M_{A=1}}) - \mathbb{E}(Y_{A=0,M_{A=1}}\right)\),
\item
  \(\text{PNIE} = \mathbb{E}\left(Y_{A=0,M_{A=1}}) - \mathbb{E}(Y_{A=0,M_{A=0}}\right)\).
\end{itemize}

With a continuous outcome and a binary mediator, the PNDE and TNDE can be estimated using the linear regression of the outcome (equation \eqref{eq:contoutcomereg}) and the logistic regression of the mediator (equation \eqref{eq:medreg}):
\[\text{PNDE} \mid L(0), L(1) = \hat{\gamma}_A + \hat{\gamma}_{A \ast M} \frac{exp(\hat{\beta}_0 + \hat{\beta}_A \times 0 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1))}{1 + exp(\hat{\beta}_0 + \hat{\beta}_A \times 0 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1))}\]

\[\scriptsize
\text{TNIE} \mid L(0), L(1) = \left( \hat{\gamma}_M + \hat{\gamma}_{A \ast M} \times 1 \right) \left[ \frac{exp(\hat{\beta}_0 + \hat{\beta}_A \times 1 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1))}{1 + exp(\hat{\beta}_0 + \hat{\beta}_A \times 1 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1))} - \frac{exp(\hat{\beta}_0 + \hat{\beta}_A \times 0 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1))}{1 + exp(\hat{\beta}_0 + \hat{\beta}_A \times 0 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1))}\right]\]
The alternative TNDE ad PNIE can be estimated by:
\[\text{TNDE} \mid L(0), L(1) = \hat{\gamma}_A + \hat{\gamma}_{A \ast M}\frac{exp(\hat{\beta}_0 + \hat{\beta}_A \times 1 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1))}{1 + exp(\hat{\beta}_0 + \hat{\beta}_A \times 1 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1))}\]
\[\scriptsize \text{PNIE} \mid L(0), L(1) = \left( \hat{\gamma}_M + \hat{\gamma}_{A \ast M} \times 0 \right) \left[ \frac{exp(\hat{\beta}_0 + \hat{\beta}_A \times 1 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1))}{1 + exp(\hat{\beta}_0 + \hat{\beta}_A \times 1 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1))} - \frac{exp(\hat{\beta}_0 + \hat{\beta}_A \times 0 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1))}{1 + exp(\hat{\beta}_0 + \hat{\beta}_A \times 0 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1))}\right]\]
Conditional on participants for which \(L(0)=0\) and \(L(1)=0\), these expressions are simplified:
\[\text{PNDE} \Big| (L(0)=0, L(1)=0) = \hat{\gamma}_A + \hat{\gamma}_{A \ast M}\frac{exp(\hat{\beta}_0)}{1 + exp(\hat{\beta}_0)}\]
\[\text{TNIE} \Big| (L(0)=0, L(1)=0) = \left( \hat{\gamma}_M + \hat{\gamma}_{A \ast M} \right) \left[ \frac{exp(\hat{\beta}_0 + \hat{\beta}_A )}{1 + exp(\hat{\beta}_0 + \hat{\beta}_A )} - \frac{exp(\hat{\beta}_0 )}{1 + exp(\hat{\beta}_0)}\right]\]
and
\[\text{TNDE} \Big| (L(0)=0, L(1)=0) = \hat{\gamma}_A + \hat{\gamma}_{A \ast M}\frac{exp(\hat{\beta}_0 + \hat{\beta}_A)}{1 + exp(\hat{\beta}_0 + \hat{\beta}_A)}\]
\[\text{PNIE} \Big| (L(0)=0, L(1)=0) = \hat{\gamma}_M \left[ \frac{exp(\hat{\beta}_0 + \hat{\beta}_A )}{1 + exp(\hat{\beta}_0 + \hat{\beta}_A )} - \frac{exp(\hat{\beta}_0 )}{1 + exp(\hat{\beta}_0)}\right]\]

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\#\# For a continuous outcome, in the subgroup with L(0)=0 and L(1)=0}
\DocumentationTok{\#\# The PNDE and TNIE are:}
\NormalTok{trad\_PNDE\_qol }\OtherTok{\textless{}{-}}\NormalTok{ gamma.A.q }\SpecialCharTok{+}\NormalTok{ gamma.AM.q }\SpecialCharTok{*}\NormalTok{ (}\FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0}\NormalTok{)) }\SpecialCharTok{/}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0}\NormalTok{))}
\NormalTok{trad\_PNDE\_qol}
\CommentTok{\# {-}4.845089}

\NormalTok{trad\_TNIE\_qol }\OtherTok{\textless{}{-}}\NormalTok{ (gamma.M.q }\SpecialCharTok{+}\NormalTok{ gamma.AM.q) }\SpecialCharTok{*}
\NormalTok{  (}\FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0} \SpecialCharTok{+}\NormalTok{ beta.A) }\SpecialCharTok{/}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0} \SpecialCharTok{+}\NormalTok{ beta.A)) }\SpecialCharTok{{-}}
     \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0}\NormalTok{) }\SpecialCharTok{/}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0}\NormalTok{)))}
\NormalTok{trad\_TNIE\_qol}
\CommentTok{\# {-}1.50119}

\DocumentationTok{\#\# The TNDE and PNIE are:}
\NormalTok{trad\_TNDE\_qol }\OtherTok{\textless{}{-}}\NormalTok{ gamma.A.q }\SpecialCharTok{+}
\NormalTok{  gamma.AM.q }\SpecialCharTok{*} \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0} \SpecialCharTok{+}\NormalTok{ beta.A) }\SpecialCharTok{/}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0} \SpecialCharTok{+}\NormalTok{ beta.A))}
\NormalTok{trad\_TNDE\_qol}
\CommentTok{\# {-}5.436773}

\NormalTok{trad\_PNIE\_qol }\OtherTok{\textless{}{-}}\NormalTok{ gamma.M.q }\SpecialCharTok{*}
\NormalTok{  (}\FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0} \SpecialCharTok{+}\NormalTok{ beta.A) }\SpecialCharTok{/}
\NormalTok{     (}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0} \SpecialCharTok{+}\NormalTok{ beta.A)) }\SpecialCharTok{{-}} \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0}\NormalTok{) }\SpecialCharTok{/}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0}\NormalTok{)))}
\NormalTok{trad\_PNIE\_qol}
\CommentTok{\# {-}0.9095061}
\end{Highlighting}
\end{Shaded}

\textbf{For binary outcomes}, total, direct and indirect effects can be expressed on relative risk or odds ratio scales:

The total effect risk ratio is equal to :
\[\text{RR}^\text{TE}=\frac{\mathbb{E}(Y_1)}{\mathbb{E}(Y_0)}=\frac{\mathbb{E}(Y_{1,M_1})}{\mathbb{E}(Y_{0,M_0})}\]

The total effect risk ratio can be decomposed as the product of the PNDE risk ratio and the TNIE risk ratio:
\[\text{RR}^\text{TE}=\frac{\mathbb{E}(Y_{1,M_1})}{\mathbb{E}(Y_{0,M_0})}=\frac{\mathbb{E}(Y_{1,M_0})}{\mathbb{E}(Y_{0,M_0})} \times \frac{\mathbb{E}(Y_{1,M_1})}{\mathbb{E}(Y_{1,M_0})}=\text{RR}^\text{PNDE} \times \text{RR}^\text{TNIE}\]

Similarly, the total effect risk ratio can be decomposed as the product of the TNDE risk ratio and the PNIE risk ratio:
\[\text{RR}^\text{TE}=\frac{\mathbb{E}(Y_{1,M_1})}{\mathbb{E}(Y_{0,M_0})}=\frac{\mathbb{E}(Y_{1,M_1})}{\mathbb{E}(Y_{0,M_1})} \times \frac{\mathbb{E}(Y_{0,M_1})}{\mathbb{E}(Y_{0,M_0})}=\text{RR}^\text{TNDE} \times \text{RR}^\text{PNIE}\]

PNDE, TNIE, TNDE and PNIE can also be given on the OR scale,
\[\text{OR}^\text{PNDE} = \frac{\frac{P\left(Y_{A=1,M_{A=0}}=1\right)}{1 - P\left(Y_{A=1,M_{A=0}}=1\right)}}{\frac{P\left(Y_{A=0,M_{A=0}}=1\right)}{1 - P\left(Y_{A=0,M_{A=0}}=1\right)}} \quad \text{,} \quad \text{OR}^\text{TNIE} = \frac{\frac{P\left(Y_{A=1,M_{A=1}}=1\right)}{1 - P\left(Y_{A=1,M_{A=1}}=1\right)}}{\frac{P\left(Y_{A=1,M_{A=0}}=1\right)}{1 - P\left(Y_{A=1,M_{A=0}}=1\right)}}\]
and
\[\text{OR}^\text{TNDE} = \frac{\frac{P\left(Y_{A=1,M_{A=0}}=1\right)}{1 - P\left(Y_{A=1,M_{A=0}}=1\right)}}{\frac{P\left(Y_{A=0,M_{A=0}}=1\right)}{1 - P\left(Y_{A=0,M_{A=0}}=1\right)}} \quad \text{and} \quad \text{OR}^\text{PNIE} = \frac{\frac{P\left(Y_{A=1,M_{A=1}}=1\right)}{1 - P\left(Y_{A=1,M_{A=1}}=1\right)}}{\frac{P\left(Y_{A=1,M_{A=0}}=1\right)}{1 - P\left(Y_{A=1,M_{A=0}}=1\right)}}.\]
If the outcome is rare, we have \(P(Y=1) \approx \frac{P(Y=1)}{1-P(Y=1)}\) so that, \(\text{OR}^{\text{PNDE}}\) AND \(\text{OR}^{\text{TNIE}}\) can be estimated using the logistic model of the outcome (equation \eqref{eq:binoutcomereg}) and the logistic model of the mediator (equation \eqref{eq:medreg}):
\[\small \text{OR}^\text{PNDE} \mid L(0), L(1) \approx \frac{\text{exp}(\hat{\gamma}_A \times 1) \left[ 1 + \text{exp}(\hat{\gamma}_M + \hat{\gamma}_{A \ast M} \times 1 + \hat{\beta}_0  + \hat{\beta}_A \times 0 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1))\right]}{ \text{exp}(\hat{\gamma}_A \times 0) \left[ 1 + \text{exp}(\hat{\gamma}_M + \hat{\gamma}_{A \ast M} \times 0 + \hat{\beta}_0 + \hat{\beta}_A \times 0  + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1))\right]} \]

and

\[ \scriptsize \text{OR}^\text{TNIE} \mid L(0), L(1) \approx \frac{\left[1 + \text{exp}(\hat{\beta}_0 + \hat{\beta}_A \times 0 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1)) \right]  \left[ 1 + \text{exp}(\hat{\gamma}_M + \hat{\gamma}_{A \ast M} \times 1 + \hat{\beta}_0  + \hat{\beta}_A \times 1 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1))\right]}{ \left[1 + \text{exp}(\hat{\beta}_0  + \hat{\beta}_A \times 1 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1)) \right]  \left[ 1 + \text{exp}(\hat{\gamma}_M + \hat{\gamma}_{A \ast M} \times 1 + \hat{\beta}_0 + \hat{\beta}_A \times 0 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1))\right]} \]
Similarly, if the outcome is rare, \(\text{OR}^{\text{TNDE}}\) AND \(\text{OR}^{\text{PNIE}}\) can be estimated using the logistic regression models for the outcome and the mediator (equations \eqref{eq:binoutcomereg} and \eqref{eq:medreg}):
\[\small \text{OR}^\text{TNDE} \mid L(0), L(1) \approx \frac{\text{exp}\left(\hat{\gamma}_A \times 1 \right)  \left[ 1 + \text{exp}\left(\hat{\gamma}_M + \hat{\gamma}_{A \ast M} \times 1 + \hat{\beta}_0 + \hat{\beta}_A \times 1 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1)\right)\right]}{ \text{exp}\left(\hat{\gamma}_A \times 0 \right) \left[ 1 + \text{exp}\left(\hat{\gamma}_M + \hat{\gamma}_{A \ast M} \times 0 + \hat{\beta}_0 + \hat{\beta}_A \times 1 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1)\right)\right]}\]

and
\[\scriptsize \text{OR}^\text{PNIE} \mid L(0), L(1) \approx \frac{\left[1 + \text{exp}\left(\hat{\beta}_0  + \hat{\beta}_A \times 0 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1)\right) \right] \left[ 1 + \text{exp}\left(\hat{\gamma}_M + \hat{\gamma}_{A \ast M} \times 0 + \hat{\beta}_0  + \hat{\beta}_A \times 1 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1)\right)\right]}{ \left[1 + \text{exp}\left(\hat{\beta}_0  + \hat{\beta}_A \times 1 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1)\right) \right] \left[ 1 + \text{exp}\left(\hat{\gamma}_M + \hat{\gamma}_{A \ast M} \times 0 + \hat{\beta}_0 + \hat{\beta}_A \times 0 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1)\right)\right]} \]
Conditional on participants for which \(L(0)=0\) and \(L(1)=0\), these expressions are simplified:
\[\text{OR}^\text{PNDE} \Bigg| \left(L(0) = 0, L(1) = 0\right) \approx \frac{\text{exp}\left(\hat{\gamma}_A\right) \left[ 1 + \text{exp}\left(\hat{\gamma}_M + \hat{\gamma}_{A \ast M} + \hat{\beta}_0\right)\right]}{ \left[ 1 + \text{exp}\left(\hat{\gamma}_M + \hat{\beta}_0 \right)\right]}\]
and
\[\text{OR}^\text{TNIE} \Bigg| \left(L(0)=0, L(1)=0\right) \approx \frac{\left[1 + \text{exp}\left(\hat{\beta}_0\right) \right] \times \left[ 1 + \text{exp}\left(\hat{\gamma}_M + \hat{\gamma}_{A \ast M} + \hat{\beta}_0  + \hat{\beta}_A\right)\right]}{ \left[1 + \text{exp}\left(\hat{\beta}_0  + \hat{\beta}_A \right) \right] \times \left[ 1 + \text{exp}\left(\hat{\gamma}_M + \hat{\gamma}_{A \ast M} + \hat{\beta}_0 \right)\right]} \]
Similarly, conditional on \(L(0)=0\) and \(L(1)=0\),
\[\text{OR}^\text{TNDE} \Bigg| \left(L(0)=0, L(1)=0\right) \approx \frac{\text{exp}\left(\hat{\gamma}_A\right) \left[ 1 + \text{exp}\left(\hat{\gamma}_M + \hat{\gamma}_{A \ast M} + \hat{\beta}_0 + \hat{\beta}_A \right)\right]}{ \left[ 1 + \text{exp}\left(\hat{\gamma}_M + \hat{\beta}_0 + \hat{\beta}_A \right)\right]}\]
\[\text{OR}^\text{PNIE} \Bigg| \left(L(0)=0, L(1)=0\right) \approx \frac{\left[1 + \text{exp}\left(\hat{\beta}_0 \right) \right] \times \left[ 1 + \text{exp}\left(\hat{\gamma}_M + \hat{\beta}_0  + \hat{\beta}_A \right)\right]}{ \left[1 + \text{exp}\left(\hat{\beta}_0  + \hat{\beta}_A \right) \right] \times \left[ 1 + \text{exp}\left(\hat{\gamma}_M +  \hat{\beta}_0 \right)\right]} \]

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\#\# For a binary outcome, in the subgroup with L(0)=0 and L(1)=0}
\DocumentationTok{\#\# The PNDE and TNIE are (on the OR scale):}
\NormalTok{trad\_OR\_PNDE\_death }\OtherTok{\textless{}{-}} \FunctionTok{exp}\NormalTok{(gamma.A.d) }\SpecialCharTok{*}
\NormalTok{  (}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(gamma.M.d }\SpecialCharTok{+}\NormalTok{ gamma.AM.d }\SpecialCharTok{+}\NormalTok{ beta}\FloatTok{.0}\NormalTok{ )) }\SpecialCharTok{/}
\NormalTok{  (}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(gamma.M.d }\SpecialCharTok{+}\NormalTok{ beta}\FloatTok{.0}\NormalTok{))}
\NormalTok{trad\_OR\_PNDE\_death}
\CommentTok{\# 1.448035}

\NormalTok{trad\_OR\_TNIE\_death }\OtherTok{\textless{}{-}}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0}\NormalTok{)) }\SpecialCharTok{*}
\NormalTok{  (}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(gamma.M.d }\SpecialCharTok{+}\NormalTok{ gamma.AM.d }\SpecialCharTok{+}\NormalTok{ beta}\FloatTok{.0} \SpecialCharTok{+}\NormalTok{ beta.A)) }\SpecialCharTok{/}
\NormalTok{  ((}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0} \SpecialCharTok{+}\NormalTok{ beta.A)) }\SpecialCharTok{*}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(gamma.M.d }\SpecialCharTok{+}\NormalTok{ gamma.AM.d }\SpecialCharTok{+}\NormalTok{ beta}\FloatTok{.0}\NormalTok{)))}
\NormalTok{trad\_OR\_TNIE\_death}
\CommentTok{\# 1.050029}

\DocumentationTok{\#\# The TNDE and PNIE are (on the OR scale):}
\NormalTok{trad\_OR\_TNDE\_death }\OtherTok{\textless{}{-}} \FunctionTok{exp}\NormalTok{(gamma.A.d) }\SpecialCharTok{*}
\NormalTok{  (}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(gamma.M.d }\SpecialCharTok{+}\NormalTok{ gamma.AM.d }\SpecialCharTok{+}\NormalTok{ beta}\FloatTok{.0} \SpecialCharTok{+}\NormalTok{ beta.A)) }\SpecialCharTok{/}
\NormalTok{  (}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(gamma.M.d }\SpecialCharTok{+}\NormalTok{ beta}\FloatTok{.0} \SpecialCharTok{+}\NormalTok{ beta.A))}
\NormalTok{trad\_OR\_TNDE\_death}
\CommentTok{\# 1.450344}

\NormalTok{trad\_OR\_PNIE\_death }\OtherTok{\textless{}{-}}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0}\NormalTok{)) }\SpecialCharTok{*}
\NormalTok{  (}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(gamma.M.d }\SpecialCharTok{+}\NormalTok{ beta}\FloatTok{.0} \SpecialCharTok{+}\NormalTok{ beta.A)) }\SpecialCharTok{/}
\NormalTok{  ((}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0} \SpecialCharTok{+}\NormalTok{ beta.A)) }\SpecialCharTok{*}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(gamma.M.d }\SpecialCharTok{+}\NormalTok{ beta}\FloatTok{.0}\NormalTok{)))}
\NormalTok{trad\_OR\_PNIE\_death}
\CommentTok{\# 1.048358}
\end{Highlighting}
\end{Shaded}

The \texttt{regmedint} \href{https://cran.r-project.org/web/packages/regmedint/index.html}{package} (Regression-Based Causal Mediation Analysis with Interaction and Effect Modification Terms) can be used for two-way decomposition. Estimations of the CDE, PNDE, TNIE, TNDE and PNIE presented above can be obtained as we show in the following example.

For continuous outcomes:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(regmedint)}
\NormalTok{regmedint\_cont }\OtherTok{\textless{}{-}} \FunctionTok{regmedint}\NormalTok{(}\AttributeTok{data =}\NormalTok{ df1\_int,}
                            \DocumentationTok{\#\# Variables}
                            \AttributeTok{yvar =} \StringTok{"Y\_qol"}\NormalTok{,                   }\CommentTok{\# outcome variable}
                            \AttributeTok{avar =} \StringTok{"A0\_PM2.5"}\NormalTok{,                }\CommentTok{\# exposure}
                            \AttributeTok{mvar =} \StringTok{"M\_diabetes"}\NormalTok{,              }\CommentTok{\# mediator}
                            \AttributeTok{cvar =} \FunctionTok{c}\NormalTok{(}\StringTok{"L0\_male"}\NormalTok{,               }\CommentTok{\# confounders}
                                     \StringTok{"L0\_soc\_env"}\NormalTok{,}
                                     \StringTok{"L1"}\NormalTok{),}
                            \CommentTok{\#eventvar = "event",     \# only for survival outcome}
                            \DocumentationTok{\#\# Values at which effects are evaluated}
                            \AttributeTok{a0 =} \DecValTok{0}\NormalTok{,}
                            \AttributeTok{a1 =} \DecValTok{1}\NormalTok{,}
                            \AttributeTok{m\_cde =} \DecValTok{0}\NormalTok{,}
                            \AttributeTok{c\_cond =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{),                 }\CommentTok{\# covariate level}
                            \DocumentationTok{\#\# Model types}
                            \AttributeTok{mreg =} \StringTok{"logistic"}\NormalTok{,}
                            \AttributeTok{yreg =} \StringTok{"linear"}\NormalTok{,}
                            \DocumentationTok{\#\# Additional specification}
                            \AttributeTok{interaction =} \ConstantTok{TRUE}\NormalTok{, }\CommentTok{\# presence of A:M interaction term}
                                                \CommentTok{\# in the outcome model}
                            \AttributeTok{casecontrol =} \ConstantTok{FALSE}\NormalTok{)}
\FunctionTok{summary}\NormalTok{(regmedint\_cont)}
\DocumentationTok{\#\#\#\# Mediation analysis}
\CommentTok{\#             est         se          Z            p      lower      upper}
\CommentTok{\# cde  {-}3.7152652 0.41600219  {-}8.930879 0.000000e+00 {-}4.5306145 {-}2.8999159}
\CommentTok{\# pnde {-}4.8450888 0.35052810 {-}13.822255 0.000000e+00 {-}5.5321113 {-}4.1580663}
\CommentTok{\# tnie {-}1.5011902 0.20821830  {-}7.209694 5.608847e{-}13 {-}1.9092905 {-}1.0930898}
\CommentTok{\# tnde {-}5.4367728 0.34049175 {-}15.967414 0.000000e+00 {-}6.1041244 {-}4.7694213}
\CommentTok{\# pnie {-}0.9095061 0.12266064  {-}7.414817 1.219025e{-}13 {-}1.1499166 {-}0.6690957}
\CommentTok{\# te   {-}6.3462790 0.38788368 {-}16.361294 0.000000e+00 {-}7.1065170 {-}5.5860409}
\CommentTok{\# pm    0.2365465 0.02947624   8.024991 1.110223e{-}15  0.1787742  0.2943189}

\CommentTok{\# note: te = total effect = (pnde + tnie) = (tnde + pnie)}
\CommentTok{\#       pm = proportion mediated = tnie / te}
\end{Highlighting}
\end{Shaded}

For binary outcomes:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{regmedint\_bin }\OtherTok{\textless{}{-}} \FunctionTok{regmedint}\NormalTok{(}\AttributeTok{data =}\NormalTok{ df1\_int,}
                            \DocumentationTok{\#\# Variables}
                            \AttributeTok{yvar =} \StringTok{"Y\_death"}\NormalTok{,                 }\CommentTok{\# outcome variable}
                            \AttributeTok{avar =} \StringTok{"A0\_PM2.5"}\NormalTok{,                }\CommentTok{\# exposure}
                            \AttributeTok{mvar =} \StringTok{"M\_diabetes"}\NormalTok{,              }\CommentTok{\# mediator}
                            \AttributeTok{cvar =} \FunctionTok{c}\NormalTok{(}\StringTok{"L0\_male"}\NormalTok{,               }\CommentTok{\# confounders}
                                     \StringTok{"L0\_soc\_env"}\NormalTok{,}
                                     \StringTok{"L1"}\NormalTok{),}
                            \CommentTok{\#eventvar = "event",     \# only for survival outcome}
                            \DocumentationTok{\#\# Values at which effects are evaluated}
                            \AttributeTok{a0 =} \DecValTok{0}\NormalTok{,}
                            \AttributeTok{a1 =} \DecValTok{1}\NormalTok{,}
                            \AttributeTok{m\_cde =} \DecValTok{0}\NormalTok{,}
                            \AttributeTok{c\_cond =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{),                 }\CommentTok{\# covariate level}
                            \DocumentationTok{\#\# Model types}
                            \AttributeTok{mreg =} \StringTok{"logistic"}\NormalTok{,}
                            \AttributeTok{yreg =} \StringTok{"logistic"}\NormalTok{,}
                            \DocumentationTok{\#\# Additional specification}
                            \AttributeTok{interaction =} \ConstantTok{TRUE}\NormalTok{,}
                            \AttributeTok{casecontrol =} \ConstantTok{FALSE}\NormalTok{)}
\NormalTok{results.binary }\OtherTok{\textless{}{-}} \FunctionTok{summary}\NormalTok{(regmedint\_bin)}

\CommentTok{\# taking the exponential of the estimations}
\FunctionTok{exp}\NormalTok{(results.binary}\SpecialCharTok{$}\NormalTok{summary\_myreg[}\FunctionTok{c}\NormalTok{(}\StringTok{"cde"}\NormalTok{,}\StringTok{"pnde"}\NormalTok{,}\StringTok{"tnie"}\NormalTok{,}\StringTok{"tnde"}\NormalTok{,}\StringTok{"pnie"}\NormalTok{,}\StringTok{"te"}\NormalTok{),}
                                 \FunctionTok{c}\NormalTok{(}\StringTok{"est"}\NormalTok{,}\StringTok{"lower"}\NormalTok{,}\StringTok{"upper"}\NormalTok{)])}
\DocumentationTok{\#\#\#\# Mediation analysis}
\CommentTok{\#           est    lower    upper}
\CommentTok{\# cde  1.442942 1.191195 1.747893}
\CommentTok{\# pnde 1.448035 1.245470 1.683545}
\CommentTok{\# tnie 1.050029 1.013842 1.087509}
\CommentTok{\# tnde 1.450344 1.257042 1.673371}
\CommentTok{\# pnie 1.048358 1.029285 1.067783}
\CommentTok{\# te   1.520479 1.316954 1.755457}
\end{Highlighting}
\end{Shaded}

The \texttt{regmedint} package gives the same results as those calculated manually using the regression coefficients.

\section{Three-way decomposition}\label{trad3way}

In order to carry-out a three-way decomposition with standard regressions, we will use the same models as for the two-way decomposition (equations \eqref{eq:contoutcomereg}, \eqref{eq:binoutcomereg} and \eqref{eq:medreg}).

(\citeproc{ref-vanderweele2013}{VanderWeele 2013}) defines:

\begin{itemize}
\tightlist
\item
  the \(\text{PNDE} = \mathbb{E}\left(Y_{A=1,M_{A=0}}) - \mathbb{E}(Y_{A=0,M_{A=0}}\right)\),
\item
  the \(\text{PNIE} = \mathbb{E}\left(Y_{A=0,M_{A=1}}) - \mathbb{E}(Y_{A=0,M_{A=0}}\right)\),
\item
  and the mediated interactive effect \(\text{MIE} = \mathbb{E}\left( \left[ Y_{1,1} - Y_{1,0} - Y_{0,1} - Y_{0,0}\right] \times \left[M_1 - M_0 \right]\right)\).
\end{itemize}

The sum of these 3 components is equal to the Average total effect (ATE).

\textbf{With a continuous outcome and a binary mediator}, the PNDE and PNIE can be estimated as for the two-way decomposition (section \ref{trad2waynatural}) using the linear regression of the outcome (equation \eqref{eq:contoutcomereg}) and the logistic regression of the mediator (equation \eqref{eq:medreg}).

The mediated interactive effect can be estimated using the same equations \eqref{eq:contoutcomereg} and \eqref{eq:medreg}, by:
\[ \scriptsize \text{MIE} \mid (L(0), L(1)) = \hat{\gamma}_{A \ast M} \left[ \frac{\exp (\hat{\beta}_0 + \hat{\beta}_A \times 1 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1))}{1 + \exp (\hat{\beta}_0 + \hat{\beta}_A \times 1 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1))} - \frac{\exp (\hat{\beta}_0 + \hat{\beta}_A \times 0 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1))}{1 + \exp (\hat{\beta}_0 + \hat{\beta}_A \times 0 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1))}\right]\]

Conditional on participants for which \(L(0)=0\) and \(L(1)=0\), the expression is simplified:
\[\text{MIE} \Big| (L(0)=0, L(1)=0) = \hat{\gamma}_{A \ast M} \left[ \frac{\exp (\hat{\beta}_0 + \hat{\beta}_A )}{1 + \exp (\hat{\beta}_0 + \hat{\beta}_A )} - \frac{\exp (\hat{\beta}_0)}{1 + \exp (\hat{\beta}_0)}\right]\]

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\#\# For a continuous outcome, in the subgroup with L(0)=0 and L(1)=0}
\DocumentationTok{\#\# The PNDE is:}
\NormalTok{trad\_PNDE\_qol }\OtherTok{\textless{}{-}}\NormalTok{ gamma.A.q }\SpecialCharTok{+}\NormalTok{ gamma.AM.q }\SpecialCharTok{*}\NormalTok{ (}\FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0}\NormalTok{)) }\SpecialCharTok{/}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0}\NormalTok{))}
\NormalTok{trad\_PNDE\_qol}
\CommentTok{\# {-}4.845089}

\DocumentationTok{\#\# The PNIE is:}
\NormalTok{trad\_PNIE\_qol }\OtherTok{\textless{}{-}}\NormalTok{ gamma.M.q }\SpecialCharTok{*}
\NormalTok{  (}\FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0} \SpecialCharTok{+}\NormalTok{ beta.A) }\SpecialCharTok{/}
\NormalTok{     (}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0} \SpecialCharTok{+}\NormalTok{ beta.A)) }\SpecialCharTok{{-}} \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0}\NormalTok{) }\SpecialCharTok{/}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0}\NormalTok{)))}
\NormalTok{trad\_PNIE\_qol}
\CommentTok{\# {-}0.9095061}

\DocumentationTok{\#\# The MIE is:}
\NormalTok{trad\_MIE\_qol }\OtherTok{\textless{}{-}}\NormalTok{ gamma.AM.q }\SpecialCharTok{*}
\NormalTok{  (}\FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0} \SpecialCharTok{+}\NormalTok{ beta.A) }\SpecialCharTok{/}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0} \SpecialCharTok{+}\NormalTok{ beta.A)) }\SpecialCharTok{{-}}
     \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0}\NormalTok{) }\SpecialCharTok{/}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0}\NormalTok{)))}
\NormalTok{trad\_MIE\_qol}
\CommentTok{\# {-}0.591684}
\end{Highlighting}
\end{Shaded}

\textbf{With a binary outcome}, the total effect, the direct and indirect effects can be expressed using risk ratios or odds ratios. In order to express the mediated interactive effect, (\citeproc{ref-vanderweele2013}{VanderWeele 2013}) suggested decomposing the \emph{excess relative risk of the total effect} \((\text{RR}^{\text{TE}}-1)\), which enables the expression of the mediated interactive effect on an additive scale.

On the difference scale, the total effect can be decomposed as the sum of the PNDE, the PNIE and the MIE:
\[\begin{array}{rl}
\mathbb{E}(Y_1) - \mathbb{E}(Y_0) = & \left[ \mathbb{E}\left(Y_{1M_0}\right) - \mathbb{E}\left(Y_{0M_0}\right) \right] + \left[ \mathbb{E}\left(Y_{0M_1}\right) - \mathbb{E}\left(Y_{0M_0}\right) \right] \\ 
                                    & + \left[ \left[ \mathbb{E}\left(Y_{1M_1}\right) - \mathbb{E}\left(Y_{1M_0}\right) \right] - \left[ \mathbb{E}\left(Y_{0M_1}\right) - \mathbb{E}\left(Y_{0M_0}\right) \right] \right] \\
                                  = & \text{PNDE + PNIE} \\
                                    & \text{ + MIE}
\end{array}\]

Dividing by \(\mathbb{E}(Y_0) = \mathbb{E}\left(Y_{0M_0}\right)\), we obtain the excess relative risk of the total effect decomposition:
\[\begin{array}{rl}
 \frac{\mathbb{E}(Y_1)}{\mathbb{E}(Y_0)}-1 = & \left[ \frac{\mathbb{E}\left( Y_{1M_0}\right)}{\mathbb{E}\left( Y_{0M_0}\right)} - 1 \right]  + \left[ \frac{\mathbb{E}\left( Y_{0M_1}\right)}{\mathbb{E}\left( Y_{0M_0}\right)} - 1 \right] \\
                                            & + \left[ \frac{\mathbb{E}\left( Y_{1M_1}\right)}{\mathbb{E}\left( Y_{0M_0}\right)} - \frac{\mathbb{E}\left( Y_{1M_0}\right)}{\mathbb{E}\left( Y_{0M_0}\right)} - \frac{\mathbb{E}\left( Y_{0M_1}\right)}{\mathbb{E}\left( Y_{0M_0}\right)} + 1 \right]
\end{array}\]
where the first component is the \emph{excess relative risk due to the PNDE}, the second component is the \emph{excess relative risk due to the PNIE} and the third component is the \emph{mediated excess relative risk due to interaction}.

If the outcome is rare, relative risks are approximately equal to odds ratios, and the 3 components of the excess relative risk can be estimated using the logistic regression of the outcome (equation \eqref{eq:binoutcomereg}) and the logistic regression of the mediator (equation \eqref{eq:medreg}).

The component of the excess relative risk due to the PNDE is approximately equal to:
\[\scriptsize
\text{RR}^\text{PNDE} - 1 \approx \frac{ \exp \left[ \hat{\gamma}_A (1 - 0) \right] \left[ 1 + \exp \left( \hat{\beta}_0 + \hat{\beta}_A \times 0 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1) + \hat{\gamma}_M + \hat{\gamma}_{A \ast M} \times 1 \right) \right]}{ \left[ 1 + \exp \left( \hat{\beta}_0 + \hat{\beta}_A \times 0 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1) + \hat{\gamma}_M + \hat{\gamma}_{A \ast M} \times 0 \right) \right] } - 1 \]

The component of the excess relative risk due to the PNIE is approximately equal to:
\[\scriptsize
\text{RR}^\text{PNIE} - 1 \approx \frac{\left[ 1 + \exp \left( \hat{\beta}_0 + \hat{\beta}_A \times 0 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1) \right) \right] \left[ 1 + \exp \left( \hat{\beta}_0 + \hat{\beta}_A \times 1 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1) + \hat{\gamma}_M + \hat{\gamma}_{A \ast M} \times 0 \right) \right]}{\left[ 1 + \exp \left( \hat{\beta}_0 + \hat{\beta}_A \times 1 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1) \right) \right] \left[ 1 + \exp \left( \hat{\beta}_0 + \hat{\beta}_A \times 0 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1) + \hat{\gamma}_M + \hat{\gamma}_{A \ast M} \times 0 \right) \right] } - 1 \]

The component of the excess relative risk due to the mediated interactive effect is approximately equal to:
\[\small
\begin{array}{rl}
\text{RERI}_{mediated} \approx  & \frac{\exp \left[ \hat{\gamma}_A (1 - 0)\right] \left[1 + \exp \left(\hat{\beta}_0 + \hat{\beta}_A \times 1 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1) + \hat{\gamma}_M + \hat{\gamma}_{A \ast M} \times 1\right) \right] \left[1 + \exp \left(\hat{\beta}_0 + \hat{\beta}_A \times 0 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1)\right) \right]}{\left[ 1 + \exp \left(\hat{\beta}_0 + \hat{\beta}_A \times 0 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1) + \hat{\gamma}_M + \hat{\gamma}_{A \ast M} \times 0\right)\right] \left[ 1 + \exp \left(\hat{\beta}_0 + \hat{\beta}_A \times 1 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1) \right) \right]} \\
                                & - \frac{\left[1 + \exp \left(\hat{\beta}_0 + \hat{\beta}_A \times 1 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1) + \hat{\gamma}_M + \hat{\gamma}_{A \ast M} \times 0\right) \right] \left[1 + \exp \left(\hat{\beta}_0 + \hat{\beta}_A \times 0 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1) \right) \right]}{\left[ 1 + \exp \left(\hat{\beta}_0 + \hat{\beta}_A \times 0 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1) + \hat{\gamma}_M + \hat{\gamma}_{A \ast M} \times 0 \right)\right] \left[ 1 + \exp \left(\hat{\beta}_0 + \hat{\beta}_A \times 1 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1)  \right) \right]} \\
                                & - \frac{\exp \left[ \hat{\gamma}_A (1 - 0)\right] \left[1 + \exp \left(\hat{\beta}_0 + \hat{\beta}_A \times 0 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1) + \hat{\gamma}_M + \hat{\gamma}_{A \ast M} \times 1 \right) \right]}{\left[ 1 + \exp \left(\hat{\beta}_0 + \hat{\beta}_A \times 0 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1) + \hat{\gamma}_M + \hat{\gamma}_{A \ast M} \times 0 \right)\right]} + 1
\end{array}\]

Conditional on participants for which \(L(0)=0\) and \(L(1)=0\), these expressions are simplified:
\[\text{RR}^\text{PNDE} - 1 \approx \frac{ \exp \left( \hat{\gamma}_A \right) \left[ 1 + \exp \left( \hat{\beta}_0 + \hat{\gamma}_M + \hat{\gamma}_{A \ast M} \right) \right]}{ \left[ 1 + \exp \left( \hat{\beta}_0 + \hat{\gamma}_M \right) \right] } - 1 \]

\[\text{RR}^\text{PNIE} - 1 \approx \frac{\left[ 1 + \exp \left( \hat{\beta}_0 \right) \right] \left[ 1 + \exp \left( \hat{\beta}_0 + \hat{\beta}_A + \hat{\gamma}_M \right) \right]}{\left[ 1 + \exp \left( \hat{\beta}_0 + \hat{\beta}_A \right) \right] \left[ 1 + \exp \left( \hat{\beta}_0 + \hat{\gamma}_M \right) \right] } - 1 \]

and
\[\begin{array}{rl}
\text{RERI}_\text{mediated} \approx  & \frac{ \exp \left( \hat{\gamma}_A \right) \left[1 + \exp \left(\hat{\beta}_0 + \hat{\beta}_A + \hat{\gamma}_M + \hat{\gamma}_{A \ast M} \right) \right] \left[1 + \exp \left(\hat{\beta}_0 \right) \right]}{\left[ 1 + \exp \left(\hat{\beta}_0 + \hat{\gamma}_M \right)\right] \left[ 1 + \exp \left(\hat{\beta}_0 + \hat{\beta}_A \right) \right]}  - \frac{\left[1 + \exp \left(\hat{\beta}_0 + \hat{\beta}_A + \hat{\gamma}_M \right) \right] \left[1 + \exp \left(\hat{\beta}_0 \right) \right]}{\left[ 1 + \exp \left(\hat{\beta}_0 + \hat{\gamma}_M \right)\right] \left[ 1 + \exp \left(\hat{\beta}_0 + \hat{\beta}_A \right) \right]} \\
                                & - \frac{ \exp \left( \hat{\gamma}_A \right) \left[1 + \exp \left(\hat{\beta}_0 + \hat{\gamma}_M + \hat{\gamma}_{A \ast M} \right) \right]}{\left[ 1 + \exp \left(\hat{\beta}_0 + \hat{\gamma}_M \right)\right]} + 1
\end{array}\]

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\#\# For a binary outcome, in the subgroup with L(0)=0 and L(1)=0}
\DocumentationTok{\#\# The excess relative risk is 52.3\% (calculated from the OR of the total effect)}
\FloatTok{1.523254} \SpecialCharTok{{-}} \DecValTok{1}
\CommentTok{\# 0.523254}

\DocumentationTok{\#\# The excess relative risk is decomposed into 3 components:}
\DocumentationTok{\#\# The component of the excess relative risk due to PNDE is:}
\NormalTok{comp\_PNDE\_death }\OtherTok{\textless{}{-}} \FunctionTok{exp}\NormalTok{(gamma.A.d) }\SpecialCharTok{*}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0} \SpecialCharTok{+}\NormalTok{ gamma.M.d }\SpecialCharTok{+}\NormalTok{ gamma.AM.d)) }\SpecialCharTok{/}
\NormalTok{  (}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0} \SpecialCharTok{+}\NormalTok{ gamma.M.d)) }\SpecialCharTok{{-}} \DecValTok{1}
\NormalTok{comp\_PNDE\_death}
\CommentTok{\# 0.4480347 }

\DocumentationTok{\#\# The component of the excess relative risk due to PNIE is:}
\NormalTok{comp\_PNIE\_death }\OtherTok{\textless{}{-}}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0}\NormalTok{)) }\SpecialCharTok{*}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0} \SpecialCharTok{+}\NormalTok{ beta.A }\SpecialCharTok{+}\NormalTok{ gamma.M.d)) }\SpecialCharTok{/}
\NormalTok{  ((}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0} \SpecialCharTok{+}\NormalTok{ beta.A)) }\SpecialCharTok{*}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0} \SpecialCharTok{+}\NormalTok{ gamma.M.d))) }\SpecialCharTok{{-}} \DecValTok{1}
\NormalTok{comp\_PNIE\_death}
\CommentTok{\# 0.04835753}

\DocumentationTok{\#\# The component of the excess relative risk due to the mediated interactive}
\DocumentationTok{\#\# effect is:}
\NormalTok{comp\_MIE\_qol }\OtherTok{\textless{}{-}} \FunctionTok{exp}\NormalTok{(gamma.A.d) }\SpecialCharTok{*}
\NormalTok{  (}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0} \SpecialCharTok{+}\NormalTok{ beta.A }\SpecialCharTok{+}\NormalTok{ gamma.M.d }\SpecialCharTok{+}\NormalTok{ gamma.AM.d)) }\SpecialCharTok{*}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0}\NormalTok{)) }\SpecialCharTok{/}
\NormalTok{  ((}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0} \SpecialCharTok{+}\NormalTok{ gamma.M.d)) }\SpecialCharTok{*}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0} \SpecialCharTok{+}\NormalTok{ beta.A))) }\SpecialCharTok{{-}}
\NormalTok{  (}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0} \SpecialCharTok{+}\NormalTok{ beta.A }\SpecialCharTok{+}\NormalTok{ gamma.M.d)) }\SpecialCharTok{*}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0}\NormalTok{)) }\SpecialCharTok{/}
\NormalTok{  ((}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0} \SpecialCharTok{+}\NormalTok{ gamma.M.d)) }\SpecialCharTok{*}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0} \SpecialCharTok{+}\NormalTok{ beta.A))) }\SpecialCharTok{{-}}
  \FunctionTok{exp}\NormalTok{(gamma.A.d) }\SpecialCharTok{*}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0} \SpecialCharTok{+}\NormalTok{ gamma.M.d }\SpecialCharTok{+}\NormalTok{ gamma.AM.d)) }\SpecialCharTok{/}
\NormalTok{  (}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0} \SpecialCharTok{+}\NormalTok{ gamma.M.d)) }\SpecialCharTok{+} \DecValTok{1}
\NormalTok{comp\_MIE\_qol}
\CommentTok{\# 0.02408674}
\end{Highlighting}
\end{Shaded}

In this example, the excess relative risk of the exposure to high levels of \(\text{PM}_{2.5}\) is \(\approx 52.3\%\), and of this excess relative risk\ldots:

\begin{itemize}
\tightlist
\item
  \(\approx 44.8\%\) is attributable to the PNDE of \(\text{PM}_{2.5}\),
\item
  \(\approx 4.8\%\) is attributable to the PNIE of \(\text{PM}_{2.5}\) through type-2 diabetes,
\item
  \(\approx 2.4\%\) is attributable to the mediated interactive effect between \(\text{PM}_{2.5}\) and type-2 diabetes
\end{itemize}

Note: in this simulated data, the probability of death is around \(20\%\), so that the requirement of a rare outcome is not really fulfilled (usually, we would consider \(< 10\%\) to be acceptable).

\section{Four-way decomposition}\label{four-way-decomposition}

The same models as for the two-way and three-way decomposition (equations \eqref{eq:contoutcomereg}, \eqref{eq:binoutcomereg} and \eqref{eq:medreg}) will be used in order to apply the four-way decomposition.

(\citeproc{ref-vanderweele2014}{VanderWeele 2014}) defines:

\begin{itemize}
\tightlist
\item
  the \(\text{CDE}_{M=0} = \mathbb{E}\left( Y_{1,0}\right) - \mathbb{E}\left(Y_{0,0} \right)\),
\item
  the mediated interaction effect \(\text{MIE} = \mathbb{E}\left( \left[ Y_{1,1} - Y_{1,0} - Y_{0,1} - Y_{0,0}\right] \times \left[M_1 - M_0 \right]\right)\),
\item
  the reference interaction effect \(\text{RIE} = \mathbb{E}\left( \left[Y_{1,1} - Y_{1,0} - Y_{0,1} - Y_{0,0}\right] \times M_0 \right)\),
\item
  and the \(\text{PNIE} = \mathbb{E}\left(Y_{A=0,M_{A=1}}) - \mathbb{E}(Y_{A=0,M_{A=0}} \right)\).
\end{itemize}

The sum of these 4 components is equal to the Average total effect (ATE), and if the exposure affects the outcome, then at least one of these 4 components should be non-null.

\textbf{With a continuous outcome and a binary mediator}, the \(\text{CDE}_{M=0}\) and \(\text{PNIE}\) can be estimated as for the two-way decomposition (sections \ref{trad2waycde} and \ref{trad2waynatural}), and the \(\text{MIE}\) can be estimated as for the three-way decomposition (section \ref{trad3way}), using the linear regression of the outcome (equation \eqref{eq:contoutcomereg}) and the logistic regression of the mediator (equation \eqref{eq:medreg}).

\[\text{CDE}_{M=0} \mid \left(L(0),L(1) \right) = \hat{\gamma}_A + \hat{\gamma}_{A \ast M} \times 0\]

\[\scriptsize \text{PNIE} \mid L(0), L(1) = \left( \hat{\gamma}_M + \hat{\gamma}_{A \ast M} \times 0 \right) \left[ \frac{exp(\hat{\beta}_0 + \hat{\beta}_A \times 1 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1))}{1 + exp(\hat{\beta}_0 + \hat{\beta}_A \times 1 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1))} - \frac{exp(\hat{\beta}_0 + \hat{\beta}_A \times 0 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1))}{1 + exp(\hat{\beta}_0 + \hat{\beta}_A \times 0 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1))}\right]\]

and

\[ \scriptsize \text{MIE} \mid (L(0), L(1)) = \hat{\gamma}_{A \ast M} \left[ \frac{\exp (\hat{\beta}_0 + \hat{\beta}_A \times 1 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1))}{1 + \exp (\hat{\beta}_0 + \hat{\beta}_A \times 1 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1))} - \frac{\exp (\hat{\beta}_0 + \hat{\beta}_A \times 0 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1))}{1 + \exp (\hat{\beta}_0 + \hat{\beta}_A \times 0 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1))}\right]\]
The RIE can be estimated by:
\[\scriptsize
\text{RIE} \mid (L(0), L(1)) = \hat{\gamma}_{A \ast M} \left[ \frac{\exp (\hat{\beta}_0 + \hat{\beta}_A \times 0 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1))}{1 + \exp (\hat{\beta}_0 + \hat{\beta}_A \times 0 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1))} - 0 \right]\]

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\#\# For a continuous outcome, in the subgroup with L(0)=0 and L(1)=0}
\DocumentationTok{\#\# The CDE\_(M=0) is:}
\NormalTok{trad\_CDE\_qol\_m0 }\OtherTok{\textless{}{-}}\NormalTok{ gamma.A.q }\SpecialCharTok{+}\NormalTok{ gamma.AM.q }\SpecialCharTok{*} \DecValTok{0}
\NormalTok{trad\_CDE\_qol\_m0}
\CommentTok{\# {-}3.715265}

\DocumentationTok{\#\# The PNIE is:}
\NormalTok{trad\_PNIE\_qol }\OtherTok{\textless{}{-}}\NormalTok{ gamma.M.q }\SpecialCharTok{*}
\NormalTok{  (}\FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0} \SpecialCharTok{+}\NormalTok{ beta.A) }\SpecialCharTok{/}
\NormalTok{     (}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0} \SpecialCharTok{+}\NormalTok{ beta.A)) }\SpecialCharTok{{-}} \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0}\NormalTok{) }\SpecialCharTok{/}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0}\NormalTok{)))}
\NormalTok{trad\_PNIE\_qol}
\CommentTok{\# {-}0.9095061}

\DocumentationTok{\#\# The MIE is:}
\NormalTok{trad\_MIE\_qol }\OtherTok{\textless{}{-}}\NormalTok{ gamma.AM.q }\SpecialCharTok{*}
\NormalTok{  (}\FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0} \SpecialCharTok{+}\NormalTok{ beta.A) }\SpecialCharTok{/}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0} \SpecialCharTok{+}\NormalTok{ beta.A)) }\SpecialCharTok{{-}}
     \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0}\NormalTok{) }\SpecialCharTok{/}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0}\NormalTok{)))}
\NormalTok{trad\_MIE\_qol}
\CommentTok{\# {-}0.591684}

\DocumentationTok{\#\# The RIE is:}
\NormalTok{trad\_RIE\_qol }\OtherTok{\textless{}{-}}\NormalTok{ gamma.AM.q }\SpecialCharTok{*}\NormalTok{ (}\FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0}\NormalTok{)) }\SpecialCharTok{/}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0}\NormalTok{))}
\NormalTok{trad\_RIE\_qol}
\CommentTok{\# {-}1.129824}
\end{Highlighting}
\end{Shaded}

\textbf{With a binary outcome and a binary mediator}, (\citeproc{ref-vanderweele2014}{VanderWeele 2014}) suggested decomposing the \emph{excess relative risk of the total effect} \((\text{RR}^{\text{TE}}-1)\) (as for the 3-way decomposition), which enables the expression of the MIE and the RIE on an additive scale.

If the outcome is rare,

The component of the excess relative risk due to the CDE is approximately equal to:

\[\small
\begin{array}{rl}
\frac{\mathbb{E}\left( Y_{0,0} \mid L(0), L(1) \right)}{\mathbb{E}\left( Y_0 \mid L(0), L(1) \right)} \left(\frac{\mathbb{E}\left(Y_{1,0} \mid L(0),L(1) \right)}{\mathbb{E}\left(Y_{0,0} \mid L(0),L(1)\right)} - 1\right) \approx & \frac{\exp \left( \hat{\gamma}_A(1-0) + \hat{\gamma}_M \times 0 + \hat{\gamma}_{A \ast M} \times 1 \times 0 \right) \left[ 1 + \exp \left( \hat{\beta}_0 + \hat{\beta}_A \times 0 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(0)}^\prime L(1) \right) \right]}{1 + \exp \left( \hat{\beta}_0 + \hat{\beta}_A \times 0 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(0)}^\prime L(1) + \hat{\gamma}_M + \hat{\gamma}_{A \ast M} \times 0\right)} \\
& - \frac{\exp \left( \hat{\gamma}_M \times 0 + \hat{\gamma}_{A \ast M} \times 0 \times 0\right) \left[ 1 + \exp \left( \hat{\beta}_0 + \hat{\beta}_A \times 0 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(0)}^\prime L(1) \right) \right]}{1 + \exp \left( \hat{\beta}_0 + \hat{\beta}_A \times 0 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(0)}^\prime L(1) + \hat{\gamma}_M + \hat{\gamma}_{A \ast M} \times 0 \right)} 
\end{array}\]

The component of the excess relative risk due to the PNIE is approximately equal to:
\[\scriptsize
\text{RR}^\text{PNIE} - 1 \approx \frac{\left[ 1 + \exp \left( \hat{\beta}_0 + \hat{\beta}_A \times 0 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1) \right) \right] \left[ 1 + \exp \left( \hat{\beta}_0 + \hat{\beta}_A \times 1 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1) + \hat{\gamma}_M + \hat{\gamma}_{A \ast M} \times 0 \right) \right]}{\left[ 1 + \exp \left( \hat{\beta}_0 + \hat{\beta}_A \times 1 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1) \right) \right] \left[ 1 + \exp \left( \hat{\beta}_0 + \hat{\beta}_A \times 0 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1) + \hat{\gamma}_M + \hat{\gamma}_{A \ast M} \times 0 \right) \right] } - 1 \]

The component of the excess relative risk due to the mediated interactive effect is approximately equal to:
\[\small
\begin{array}{rl}
\text{RERI}_{mediated} \approx  & \frac{\exp \left[ \hat{\gamma}_A (1 - 0)\right] \left[1 + \exp \left(\hat{\beta}_0 + \hat{\beta}_A \times 1 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1) + \hat{\gamma}_M + \hat{\gamma}_{A \ast M} \times 1\right) \right] \left[1 + \exp \left(\hat{\beta}_0 + \hat{\beta}_A \times 0 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1)\right) \right]}{\left[ 1 + \exp \left(\hat{\beta}_0 + \hat{\beta}_A \times 0 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1) + \hat{\gamma}_M + \hat{\gamma}_{A \ast M} \times 0\right)\right] \left[ 1 + \exp \left(\hat{\beta}_0 + \hat{\beta}_A \times 1 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1) \right) \right]} \\
                                & - \frac{\left[1 + \exp \left(\hat{\beta}_0 + \hat{\beta}_A \times 1 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1) + \hat{\gamma}_M + \hat{\gamma}_{A \ast M} \times 0\right) \right] \left[1 + \exp \left(\hat{\beta}_0 + \hat{\beta}_A \times 0 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1) \right) \right]}{\left[ 1 + \exp \left(\hat{\beta}_0 + \hat{\beta}_A \times 0 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1) + \hat{\gamma}_M + \hat{\gamma}_{A \ast M} \times 0 \right)\right] \left[ 1 + \exp \left(\hat{\beta}_0 + \hat{\beta}_A \times 1 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1)  \right) \right]} \\
                                & - \frac{\exp \left[ \hat{\gamma}_A (1 - 0)\right] \left[1 + \exp \left(\hat{\beta}_0 + \hat{\beta}_A \times 0 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1) + \hat{\gamma}_M + \hat{\gamma}_{A \ast M} \times 1 \right) \right]}{\left[ 1 + \exp \left(\hat{\beta}_0 + \hat{\beta}_A \times 0 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1) + \hat{\gamma}_M + \hat{\gamma}_{A \ast M} \times 0 \right)\right]} + 1
\end{array}\]

and the component of the excess relative risk due to the reference interaction effect is approximately equal to:
\[
\begin{array}{rl}
\text{RERI}_\text{ref} \approx  & \frac{\exp \left[ \hat{\gamma}_A (1 - 0)\right] \left[1 + \exp \left(\hat{\beta}_0 + \hat{\beta}_A \times 0 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1) + \hat{\gamma}_M + \hat{\gamma}_{A \ast M} \times 1\right) \right]}{\left[ 1 + \exp \left(\hat{\beta}_0 + \hat{\beta}_A \times 0 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1) + \hat{\gamma}_M + \hat{\gamma}_{A \ast M} \times 0\right)\right] } - 1 \\
                                & - \frac{\exp \left[ \hat{\gamma}_A (1 - 0) + \hat{\gamma}_M \times 0 + \hat{\gamma}_{A \ast M} 1 \times 0 \right] \left[1 + \exp \left(\hat{\beta}_0 + \hat{\beta}_A \times 0 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1) \right) \right]}{ 1 + \exp \left(\hat{\beta}_0 + \hat{\beta}_A \times 0 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1) + \hat{\gamma}_M + \hat{\gamma}_{A \ast M} \times 0 \right)} \\
                                & + \frac{\exp \left( \hat{\gamma}_M \times 0 + \hat{\gamma}_{A \ast M} \times 0 \times 0 \right) \left[1 + \exp \left(\hat{\beta}_0 + \hat{\beta}_A \times 0 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1) \right) \right]}{ 1 + \exp \left(\hat{\beta}_0 + \hat{\beta}_A \times 0 + \hat{\beta}_{L(0)}^\prime L(0) + \hat{\beta}_{L(1)}^\prime L(1) + \hat{\gamma}_M + \hat{\gamma}_{A \ast M} \times 0 \right) } 
\end{array}\]

Conditional on participants for which \(L(0)=0\) and \(L(1)=0\), these expressions are simplified:

The component of the excess relative risk due to the CDE is approximately equal to:
\[ \approx \frac{\exp \left( \hat{\gamma}_A \right) \left[ 1 + \exp \left( \hat{\beta}_0 \right) \right]}{1 + \exp \left( \hat{\beta}_0 + \hat{\gamma}_M \right)} - \frac{ \left[ 1 + \exp \left( \hat{\beta}_0 \right) \right]}{1 + \exp \left( \hat{\beta}_0 + \hat{\gamma}_M \right)}\]

The component of the excess relative risk due to the PNIE is approximately equal to:
\[\text{RR}^\text{PNIE} - 1 \approx \frac{\left[ 1 + \exp \left( \hat{\beta}_0 \right) \right] \left[ 1 + \exp \left( \hat{\beta}_0 + \hat{\beta}_A + \hat{\gamma}_M \right) \right]}{\left[ 1 + \exp \left( \hat{\beta}_0 + \hat{\beta}_A \right) \right] \left[ 1 + \exp \left( \hat{\beta}_0 + \hat{\gamma}_M \right) \right] } - 1 \]

The component of the excess relative risk due to the mediated interactive effect is approximately equal to:
\[
\begin{array}{rl}
\text{RERI}_{mediated} \approx & \frac{\exp \left( \hat{\gamma}_A \right) \left[1 + \exp \left(\hat{\beta}_0 + \hat{\beta}_A + \hat{\gamma}_M + \hat{\gamma}_{A \ast M} \right) \right] \left[1 + \exp \left(\hat{\beta}_0 \right) \right]}{\left[ 1 + \exp \left(\hat{\beta}_0 + \hat{\gamma}_M \right)\right] \left[ 1 + \exp \left(\hat{\beta}_0 + \hat{\beta}_A  \right) \right]}  - \frac{\left[1 + \exp \left(\hat{\beta}_0 + \hat{\beta}_A + \hat{\gamma}_M \right) \right] \left[1 + \exp \left(\hat{\beta}_0 \right) \right]}{\left[ 1 + \exp \left(\hat{\beta}_0 + \hat{\gamma}_M \right)\right] \left[ 1 + \exp \left(\hat{\beta}_0 + \hat{\beta}_A \right) \right]} \\
 & - \frac{\exp \left( \hat{\gamma}_A \right) \left[1 + \exp \left(\hat{\beta}_0 + \hat{\gamma}_M + \hat{\gamma}_{A \ast M} \right) \right]}{\left[ 1 + \exp \left(\hat{\beta}_0 + \hat{\gamma}_M \right)\right]} + 1
\end{array}
\]

and the component of the excess relative risk due to the reference interaction effect is approximately equal to:
\[\small
\text{RERI}_\text{ref} \approx \frac{\exp \left( \hat{\gamma}_A\right) \left[1 + \exp \left(\hat{\beta}_0 + \hat{\gamma}_M + \hat{\gamma}_{A \ast M} \right) \right]}{\left[ 1 + \exp \left(\hat{\beta}_0 + \hat{\gamma}_M \right)\right] } - 1  - \frac{\exp \left( \hat{\gamma}_A \right) \left[1 + \exp \left(\hat{\beta}_0 \right) \right]}{ 1 + \exp \left(\hat{\beta}_0 + \hat{\gamma}_M \right)} + \frac{ \left[1 + \exp \left(\hat{\beta}_0 \right) \right]}{ 1 + \exp \left(\hat{\beta}_0 + \hat{\gamma}_M \right) } 
\]

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\#\# For a binary outcome, in the subgroup with L(0)=0 and L(1)=0}
\DocumentationTok{\#\# The excess relative risk is 52.3\% (calculated from the OR of the total effect)}
\FloatTok{1.523254} \SpecialCharTok{{-}} \DecValTok{1}
\CommentTok{\# 0.523254}

\DocumentationTok{\#\# The excess relative risk is decomposed into 4 components:}
\DocumentationTok{\#\# The component of the excess relative risk due to the CDE(M=0) is:}
\NormalTok{comp\_CDE\_death\_m0 }\OtherTok{\textless{}{-}} \FunctionTok{exp}\NormalTok{(gamma.A.d) }\SpecialCharTok{*}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0}\NormalTok{)) }\SpecialCharTok{/}
\NormalTok{  (}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0} \SpecialCharTok{+}\NormalTok{ gamma.M.d)) }\SpecialCharTok{{-}}
\NormalTok{  (}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0}\NormalTok{)) }\SpecialCharTok{/}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0} \SpecialCharTok{+}\NormalTok{ gamma.M.d))}
\NormalTok{comp\_CDE\_death\_m0}
\CommentTok{\# 0.402041}

\DocumentationTok{\#\# The component of the excess relative risk due to the PNIE is:}
\NormalTok{comp\_PNIE\_death }\OtherTok{\textless{}{-}}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0}\NormalTok{)) }\SpecialCharTok{*}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0} \SpecialCharTok{+}\NormalTok{ beta.A }\SpecialCharTok{+}\NormalTok{ gamma.M.d)) }\SpecialCharTok{/}
\NormalTok{  ((}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0} \SpecialCharTok{+}\NormalTok{ beta.A)) }\SpecialCharTok{*}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0} \SpecialCharTok{+}\NormalTok{ gamma.M.d))) }\SpecialCharTok{{-}} \DecValTok{1}
\NormalTok{comp\_PNIE\_death}
\CommentTok{\# 0.04835753}

\DocumentationTok{\#\# The component of the excess relative risk due to the MIE is:}
\NormalTok{comp\_MIE\_death }\OtherTok{\textless{}{-}} \FunctionTok{exp}\NormalTok{(gamma.A.d) }\SpecialCharTok{*}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0} \SpecialCharTok{+}\NormalTok{ beta.A }\SpecialCharTok{+}\NormalTok{ gamma.M.d }\SpecialCharTok{+}
\NormalTok{                                              gamma.AM.d)) }\SpecialCharTok{*}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0}\NormalTok{)) }\SpecialCharTok{/}
\NormalTok{  ((}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0} \SpecialCharTok{+}\NormalTok{ gamma.M.d)) }\SpecialCharTok{*}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0} \SpecialCharTok{+}\NormalTok{ beta.A))) }\SpecialCharTok{{-}}
\NormalTok{  (}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0} \SpecialCharTok{+}\NormalTok{ beta.A }\SpecialCharTok{+}\NormalTok{ gamma.M.d)) }\SpecialCharTok{*}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0}\NormalTok{)) }\SpecialCharTok{/}
\NormalTok{  ((}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0} \SpecialCharTok{+}\NormalTok{ gamma.M.d)) }\SpecialCharTok{*}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0} \SpecialCharTok{+}\NormalTok{ beta.A))) }\SpecialCharTok{{-}}
  \FunctionTok{exp}\NormalTok{(gamma.A.d) }\SpecialCharTok{*}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0} \SpecialCharTok{+}\NormalTok{ gamma.M.d }\SpecialCharTok{+}\NormalTok{ gamma.AM.d)) }\SpecialCharTok{/}
\NormalTok{  (}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0} \SpecialCharTok{+}\NormalTok{ gamma.M.d)) }\SpecialCharTok{+} \DecValTok{1}
\NormalTok{comp\_MIE\_death}
\CommentTok{\# 0.02408674}

\DocumentationTok{\#\# The component of the excess relative risk due to the RIE is:}
\NormalTok{comp\_RIE\_death }\OtherTok{\textless{}{-}} \FunctionTok{exp}\NormalTok{(gamma.A.d) }\SpecialCharTok{*}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0} \SpecialCharTok{+}\NormalTok{ gamma.M.d }\SpecialCharTok{+}\NormalTok{ gamma.AM.d)) }\SpecialCharTok{/}
\NormalTok{  (}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0} \SpecialCharTok{+}\NormalTok{ gamma.M.d)) }\SpecialCharTok{{-}} \DecValTok{1} \SpecialCharTok{{-}}
  \FunctionTok{exp}\NormalTok{(gamma.A.d) }\SpecialCharTok{*}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0}\NormalTok{)) }\SpecialCharTok{/}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0} \SpecialCharTok{+}\NormalTok{ gamma.M.d)) }\SpecialCharTok{+}
\NormalTok{  (}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0}\NormalTok{)) }\SpecialCharTok{/}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(beta}\FloatTok{.0} \SpecialCharTok{+}\NormalTok{ gamma.M.d))}
\NormalTok{comp\_RIE\_death}
\CommentTok{\# 0.04599376}
\end{Highlighting}
\end{Shaded}

In this example, the excess relative risk of the exposure to high levels of \(\text{PM}_{2.5}\) is \(\approx 52.3\%\), and of this excess relative risk\ldots:

\begin{itemize}
\tightlist
\item
  \(\approx 40.2\%\) is attributable to the CDE of \(\text{PM}_{2.5}\),
\item
  \(\approx 4.8\%\) is attributable to the PNIE of \(\text{PM}_{2.5}\) through type-2 diabetes,
\item
  \(\approx 2.4\%\) is attributable to the mediated interactive effect between \(\text{PM}_{2.5}\) and type-2 diabetes
\item
  and \(\approx 4.6\%\) is attributable to the (\(\text{PM}_{2.5}\) \(\ast\) type-2 diabetes) reference interactive effect.
\end{itemize}

Note: in this simulated data, the probability of death is around \(20\%\), so that the requirement of a rare outcome is not really fulfilled (usually, we would consider \(< 10\%\) to be acceptable).

\textbf{R package for 3-way and 4-way decomposition}

The \texttt{CMAverse} R \href{https://bs1125.github.io/CMAverse/index.html}{package} (a suite of functions for causal mediation analysis) can be used for 2-way, 3-way and 4-way decompositions. Estimations of the CDE(M=0), PNIE, MIE and INTref presented above can be obtained as we show in the following example.

Standard errors and confidence intervals can be computed by delta-method or by bootstrap.

Note that the results from regression based methods (applying the \texttt{estimation\ =\ "paramfunc"} argument) are not marginal expectations, but conditional expectations of direct, indirect, total, and interaction effects.

For continuous outcomes:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(CMAverse)}
\NormalTok{?CMAverse}\SpecialCharTok{::}\NormalTok{cmest}

\DocumentationTok{\#\#\# For the continuous outcome}
\DocumentationTok{\#\# Closed{-}form parameter function estimation and delta method inferece}
\NormalTok{res\_rb\_param\_delta }\OtherTok{\textless{}{-}} \FunctionTok{cmest}\NormalTok{(}\AttributeTok{data =}\NormalTok{ df1\_int,}
                            \AttributeTok{model =} \StringTok{"rb"}\NormalTok{, }\CommentTok{\# for "regression based" (rb) approach}
                            \AttributeTok{outcome =} \StringTok{"Y\_qol"}\NormalTok{,        }\CommentTok{\# outcome variable}
                            \AttributeTok{exposure =} \StringTok{"A0\_PM2.5"}\NormalTok{,    }\CommentTok{\# exposure variable}
                            \AttributeTok{mediator =} \StringTok{"M\_diabetes"}\NormalTok{,  }\CommentTok{\# mediator}
                            \AttributeTok{basec =} \FunctionTok{c}\NormalTok{(}\StringTok{"L0\_male"}\NormalTok{,      }\CommentTok{\# confounders}
                                      \StringTok{"L0\_soc\_env"}\NormalTok{,}
                                      \StringTok{"L1"}\NormalTok{),}
                            \AttributeTok{EMint =} \ConstantTok{TRUE}\NormalTok{, }\CommentTok{\# exposures*mediator interaction}
                            \AttributeTok{mreg =} \FunctionTok{list}\NormalTok{(}\StringTok{"logistic"}\NormalTok{), }\CommentTok{\# model of the mediator}
                            \AttributeTok{yreg =} \StringTok{"linear"}\NormalTok{,       }\CommentTok{\# model of the outcome}
                            \AttributeTok{astar =} \DecValTok{0}\NormalTok{,}
                            \AttributeTok{a =} \DecValTok{1}\NormalTok{,}
                            \AttributeTok{mval =} \FunctionTok{list}\NormalTok{(}\DecValTok{0}\NormalTok{),}
                            \AttributeTok{basecval =} \FunctionTok{list}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{),      }\CommentTok{\# covariate level}
                            \AttributeTok{estimation =} \StringTok{"paramfunc"}\NormalTok{, }\CommentTok{\#  closed{-}form parameter}
                                                      \CommentTok{\# function estimation}
                            \AttributeTok{inference =} \StringTok{"delta"}\NormalTok{) }\CommentTok{\# IC95\% : "delta" or "bootstrap"}
\FunctionTok{summary}\NormalTok{(res\_rb\_param\_delta)}
\CommentTok{\# Closed{-}form parameter function estimation with}
\CommentTok{\# delta method standard errors, confidence intervals and p{-}values}
\CommentTok{\#}
\CommentTok{\#                Estimate Std.error  95\% CIL 95\% CIU    P.val}
\CommentTok{\#   cde          {-}3.71527   0.41600 {-}4.53061  {-}2.900  \textless{} 2e{-}16 ***   CDE(M=0)}
\CommentTok{\#   pnde         {-}4.84509   0.35053 {-}5.53211  {-}4.158  \textless{} 2e{-}16 ***}
\CommentTok{\#   tnde         {-}5.43677   0.34049 {-}6.10412  {-}4.769  \textless{} 2e{-}16 ***}
\CommentTok{\#   pnie         {-}0.90951   0.12266 {-}1.14992  {-}0.669 1.22e{-}13 ***   PNIE}
\CommentTok{\#   tnie         {-}1.50119   0.20822 {-}1.90929  {-}1.093 5.61e{-}13 ***}
\CommentTok{\#   te           {-}6.34628   0.38788 {-}7.10652  {-}5.586  \textless{} 2e{-}16 ***}
\CommentTok{\#   intref       {-}1.12982   0.13824 {-}1.40076  {-}0.859 2.22e{-}16 ***   INTref}
\CommentTok{\#   intmed       {-}0.59168   0.10398 {-}0.79547  {-}0.388 1.27e{-}08 ***   MIE}
\CommentTok{\#   cde(prop)     0.58542   0.04505  0.49712   0.674  \textless{} 2e{-}16 ***}
\CommentTok{\#   intref(prop)  0.17803   0.02560  0.12786   0.228 3.51e{-}12 ***}
\CommentTok{\#   intmed(prop)  0.09323   0.01586  0.06216   0.124 4.11e{-}09 ***}
\CommentTok{\#   pnie(prop)    0.14331   0.01655  0.11087   0.176  \textless{} 2e{-}16 ***}
\CommentTok{\#   pm            0.23655   0.02948  0.17877   0.294 1.11e{-}15 ***}
\CommentTok{\#   int           0.27126   0.03780  0.19717   0.345 7.20e{-}13 ***}
\CommentTok{\#   pe            0.41458   0.04505  0.32627   0.503  \textless{} 2e{-}16 ***}
\CommentTok{\#   {-}{-}{-}}
\CommentTok{\#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1}

\DocumentationTok{\#\# for the 3{-}way decomposition, the PNDE, PNIE, and MIE are given by:}
\FunctionTok{data.frame}\NormalTok{(}\StringTok{"Estimate"} \OtherTok{=}\NormalTok{ res\_rb\_param\_delta}\SpecialCharTok{$}\NormalTok{effect.pe,}
           \StringTok{"lower95CI"} \OtherTok{=}\NormalTok{ res\_rb\_param\_delta}\SpecialCharTok{$}\NormalTok{effect.ci.low,}
           \StringTok{"upper95CI"} \OtherTok{=}\NormalTok{ res\_rb\_param\_delta}\SpecialCharTok{$}\NormalTok{effect.ci.high,}
           \StringTok{"P.value"} \OtherTok{=}\NormalTok{ res\_rb\_param\_delta}\SpecialCharTok{$}\NormalTok{effect.pval)[}\FunctionTok{c}\NormalTok{(}\StringTok{"pnde"}\NormalTok{,}\StringTok{"pnie"}\NormalTok{, }\StringTok{"intmed"}\NormalTok{),]}
\CommentTok{\#          Estimate  lower95CI  upper95CI      P.value}
\CommentTok{\# pnde   {-}4.8450888 {-}5.5321113 {-}4.1580663 0.000000e+00}
\CommentTok{\# pnie   {-}0.9095061 {-}1.1499166 {-}0.6690957 1.219025e{-}13}
\CommentTok{\# intmed {-}0.5916840 {-}0.7954739 {-}0.3878941 1.266206e{-}08}

\DocumentationTok{\#\# for the 4{-}way decomposition, the CDE(M=0), Intref, MIE and PNIE are given by:}
\FunctionTok{data.frame}\NormalTok{(}\StringTok{"Estimate"} \OtherTok{=}\NormalTok{ res\_rb\_param\_delta}\SpecialCharTok{$}\NormalTok{effect.pe,}
           \StringTok{"lower95CI"} \OtherTok{=}\NormalTok{ res\_rb\_param\_delta}\SpecialCharTok{$}\NormalTok{effect.ci.low,}
           \StringTok{"upper95CI"} \OtherTok{=}\NormalTok{ res\_rb\_param\_delta}\SpecialCharTok{$}\NormalTok{effect.ci.high,}
           \StringTok{"P.value"} \OtherTok{=}\NormalTok{ res\_rb\_param\_delta}\SpecialCharTok{$}\NormalTok{effect.pval)[}\FunctionTok{c}\NormalTok{(}\StringTok{"cde"}\NormalTok{,}\StringTok{"intref"}\NormalTok{,}
                                                         \StringTok{"intmed"}\NormalTok{,}\StringTok{"pnie"}\NormalTok{),]}
\CommentTok{\#          Estimate  lower95CI  upper95CI      P.value}
\CommentTok{\# cde    {-}3.7152652 {-}4.5306145 {-}2.8999159 0.000000e+00}
\CommentTok{\# intref {-}1.1298236 {-}1.4007600 {-}0.8588871 2.220446e{-}16}
\CommentTok{\# intmed {-}0.5916840 {-}0.7954739 {-}0.3878941 1.266206e{-}08}
\CommentTok{\# pnie   {-}0.9095061 {-}1.1499166 {-}0.6690957 1.219025e{-}13}
\end{Highlighting}
\end{Shaded}

For binary outcomes:

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\#\# For the binary outcome}
\DocumentationTok{\#\# Closed{-}form parameter function estimation and delta method inferece}
\NormalTok{res\_rb\_param\_delta }\OtherTok{\textless{}{-}} \FunctionTok{cmest}\NormalTok{(}\AttributeTok{data =}\NormalTok{ df1\_int,}
                            \AttributeTok{model =} \StringTok{"rb"}\NormalTok{, }\CommentTok{\# for "regression based" (rb) approach}
                            \AttributeTok{outcome =} \StringTok{"Y\_death"}\NormalTok{,      }\CommentTok{\# outcome variable}
                            \AttributeTok{exposure =} \StringTok{"A0\_PM2.5"}\NormalTok{,    }\CommentTok{\# exposure variable}
                            \AttributeTok{mediator =} \StringTok{"M\_diabetes"}\NormalTok{,  }\CommentTok{\# mediator}
                            \AttributeTok{basec =} \FunctionTok{c}\NormalTok{(}\StringTok{"L0\_male"}\NormalTok{,      }\CommentTok{\# confounders}
                                      \StringTok{"L0\_soc\_env"}\NormalTok{,}
                                      \StringTok{"L1"}\NormalTok{),}
                            \AttributeTok{EMint =} \ConstantTok{TRUE}\NormalTok{, }\CommentTok{\# exposures*mediator interaction}
                            \AttributeTok{mreg =} \FunctionTok{list}\NormalTok{(}\StringTok{"logistic"}\NormalTok{), }\CommentTok{\# model of the mediator}
                            \AttributeTok{yreg =} \StringTok{"logistic"}\NormalTok{,       }\CommentTok{\# model of the outcome}
                            \AttributeTok{astar =} \DecValTok{0}\NormalTok{,}
                            \AttributeTok{a =} \DecValTok{1}\NormalTok{,}
                            \AttributeTok{mval =} \FunctionTok{list}\NormalTok{(}\DecValTok{0}\NormalTok{),}
                            \AttributeTok{basecval =} \FunctionTok{list}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{),      }\CommentTok{\# covariate level}
                            \AttributeTok{estimation =} \StringTok{"paramfunc"}\NormalTok{, }\CommentTok{\#  closed{-}form parameter}
                            \CommentTok{\# function estimation}
                            \AttributeTok{inference =} \StringTok{"delta"}\NormalTok{) }\CommentTok{\# IC95\% : delta method}
\FunctionTok{summary}\NormalTok{(res\_rb\_param\_delta)}
\CommentTok{\# Closed{-}form parameter function estimation with}
\CommentTok{\# delta method standard errors, confidence intervals and p{-}values}
\CommentTok{\#}
\CommentTok{\# Estimate Std.error  95\% CIL 95\% CIU    P.val}
\CommentTok{\#   Rcde            1.44294   0.14115  1.19120   1.748 0.000178 ***}
\CommentTok{\#   Rpnde           1.44803   0.11133  1.24547   1.684 1.47e{-}06 ***}
\CommentTok{\#   Rtnde           1.45034   0.10585  1.25704   1.673 3.50e{-}07 ***}
\CommentTok{\#   Rpnie           1.04836   0.00982  1.02929   1.068 4.62e{-}07 ***}
\CommentTok{\#   Rtnie           1.05003   0.01879  1.01384   1.088 0.006368 **}
\CommentTok{\#   Rte             1.52048   0.11148  1.31695   1.755 1.10e{-}08 ***}
\CommentTok{\#   ERcde           0.40204   0.12699  0.15315   0.651 0.001546 **  CDE(M=0)}
\CommentTok{\#   ERintref        0.04599   0.04821 {-}0.04850   0.140 0.340093     INTref}
\CommentTok{\#   ERintmed        0.02409   0.02543 {-}0.02576   0.074 0.343607     MIE}
\CommentTok{\#   ERpnie          0.04836   0.00982  0.02911   0.068 8.47e{-}07 *** PNIE}
\CommentTok{\#   ERcde(prop)     0.77244   0.14282  0.49252   1.052 6.36e{-}08 ***}
\CommentTok{\#   ERintref(prop)  0.08837   0.09311 {-}0.09413   0.271 0.342600}
\CommentTok{\#   ERintmed(prop)  0.04628   0.04901 {-}0.04978   0.142 0.345058}
\CommentTok{\#   ERpnie(prop)    0.09291   0.02602  0.04192   0.144 0.000356 ***}
\CommentTok{\#   pm              0.13919   0.05498  0.03142   0.247 0.011359 *}
\CommentTok{\#   int             0.13465   0.14186 {-}0.14340   0.413 0.342562}
\CommentTok{\#   pe              0.22756   0.14282 {-}0.05237   0.507 0.111092}
\CommentTok{\#   {-}{-}{-}}
\CommentTok{\#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1}


\DocumentationTok{\#\# for the 3{-}way decomposition, the excess relative risk due to}
\DocumentationTok{\#\# the PNDE, PNIE and MIE are given by:}
\FunctionTok{data.frame}\NormalTok{(}\StringTok{"Estimate"} \OtherTok{=}\NormalTok{ res\_rb\_param\_delta}\SpecialCharTok{$}\NormalTok{effect.pe }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{,}
           \StringTok{"lower95CI"} \OtherTok{=}\NormalTok{ res\_rb\_param\_delta}\SpecialCharTok{$}\NormalTok{effect.ci.low }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{,}
           \StringTok{"upper95CI"} \OtherTok{=}\NormalTok{ res\_rb\_param\_delta}\SpecialCharTok{$}\NormalTok{effect.ci.high }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{)[}\FunctionTok{c}\NormalTok{(}\StringTok{"Rpnde"}\NormalTok{,}\StringTok{"Rpnie"}\NormalTok{),]}
\CommentTok{\#        Estimate lower95CI upper95CI}
\CommentTok{\# Rpnde 0.44803473 0.24546995 0.68354491}
\CommentTok{\# Rpnie 0.04835753 0.02928532 0.06778313}
\CommentTok{\# and the excess relative risk due to MIE is given by:}
\FunctionTok{data.frame}\NormalTok{(}\StringTok{"Estimate"} \OtherTok{=}\NormalTok{ res\_rb\_param\_delta}\SpecialCharTok{$}\NormalTok{effect.pe,}
           \StringTok{"lower95CI"} \OtherTok{=}\NormalTok{ res\_rb\_param\_delta}\SpecialCharTok{$}\NormalTok{effect.ci.low,}
           \StringTok{"upper95CI"} \OtherTok{=}\NormalTok{ res\_rb\_param\_delta}\SpecialCharTok{$}\NormalTok{effect.ci.high,}
           \StringTok{"P.value"} \OtherTok{=}\NormalTok{ res\_rb\_param\_delta}\SpecialCharTok{$}\NormalTok{effect.pval)[}\FunctionTok{c}\NormalTok{(}\StringTok{"ERintmed"}\NormalTok{),]}
\CommentTok{\#            Estimate   lower95CI  upper95CI      P.value}
\CommentTok{\# ERintmed 0.02408674 {-}0.02576124 0.07393472 3.436070e{-}01}


\DocumentationTok{\#\# for the 4{-}way decomposition, the CDE(M=0), the excess relative risk due to}
\DocumentationTok{\#\# CDE(M=0), Intref, MIE and PNIE are given by}
\FunctionTok{data.frame}\NormalTok{(}\StringTok{"Estimate"} \OtherTok{=}\NormalTok{ res\_rb\_param\_delta}\SpecialCharTok{$}\NormalTok{effect.pe,}
           \StringTok{"lower95CI"} \OtherTok{=}\NormalTok{ res\_rb\_param\_delta}\SpecialCharTok{$}\NormalTok{effect.ci.low,}
           \StringTok{"upper95CI"} \OtherTok{=}\NormalTok{ res\_rb\_param\_delta}\SpecialCharTok{$}\NormalTok{effect.ci.high,}
           \StringTok{"P.value"} \OtherTok{=}\NormalTok{ res\_rb\_param\_delta}\SpecialCharTok{$}\NormalTok{effect.pval)[}\FunctionTok{c}\NormalTok{(}\StringTok{"ERcde"}\NormalTok{,}\StringTok{"ERintref"}\NormalTok{,}
                                                         \StringTok{"ERintmed"}\NormalTok{,}\StringTok{"ERpnie"}\NormalTok{),]}
\CommentTok{\#            Estimate   lower95CI  upper95CI      P.value}
\CommentTok{\# ERcde    0.40204098  0.15315072 0.65093124 1.545523e{-}03}
\CommentTok{\# ERintref 0.04599376 {-}0.04850084 0.14048835 3.400930e{-}01}
\CommentTok{\# ERintmed 0.02408674 {-}0.02576124 0.07393472 3.436070e{-}01}
\CommentTok{\# ERpnie   0.04835753  0.02910970 0.06760535 8.473169e{-}07}
\end{Highlighting}
\end{Shaded}

\chapter{G-computation}\label{ChapGcomp}

If we make the assumption that the intermediate confounder \(L(1)\) of the \(M-Y\) relationship is affected by the exposure \(A\) (Causal model 2, Figure \ref{fig:figDAGM2}), it is necessary to use other methods than traditional regressions models. To illustrate g-computation estimators, we will use the \texttt{df2\_int.csv} data set, which was generated from a system corresponding to this assumption. Moreover, we will assume that there is an \(A \star M\) interaction effect on the outcome.

G-computation can be used for the estimation of the total effect and two-way decomposition (CDE, marginal and conditional randomized direct and indirect effects). Analogs of the 3-way and 4-way decompositions are also given by the \texttt{CMAverse} package.

\section{Estimation of the Average Total Effect (ATE)}\label{estimation-of-the-average-total-effect-ate-1}

The following steps describe the implementation of the g-computation estimator of the average total effect \(\text{ATE} = \mathbb{E}(Y_{A=1}) - \mathbb{E}(Y_{A=0})\):

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Fit a logistic or a linear regression to estimate \(\overline{Q} = \mathbb{E}(Y \mid A, L(0))\)
\item
  Use this estimate to predict an outcome for each subject \(\hat{\overline{Q}}(A=0)_i\) and \(\hat{\overline{Q}}(A=1)_i\), by evaluating the regression fit \(\overline{Q}\) at \(A=0\) and \(A=1\) respectively
\item
  Plug the predicted outcomes in the g-formula and use the sample mean to estimate \(\Psi_{ATE}\)
  \begin{equation}
  \hat{\Psi}^{\text{ATE}}_{\text{gcomp}} = \frac{1}{n} \sum_{i=1}^n \left[ \hat{\overline{Q}}(A=1)_i - \hat{\overline{Q}}(A=0)_i \right]
  \end{equation}
\end{enumerate}

For continuous outcomes, \(\overline{Q}(A=a)\) functions can be estimated using linear regressions. For binary outcomes, they can be estimated using logistic regressions.

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# 0. Import data}
\FunctionTok{rm}\NormalTok{(}\AttributeTok{list=}\FunctionTok{ls}\NormalTok{())}
\NormalTok{df2\_int }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file =} \StringTok{"./data/df2\_int.csv"}\NormalTok{)}

\DocumentationTok{\#\# 1. Estimate Qbar  }
\NormalTok{Q.tot.death }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Y\_death }\SpecialCharTok{\textasciitilde{}}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env, }
                   \AttributeTok{family =} \StringTok{"binomial"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df2\_int)}
\NormalTok{Q.tot.qol }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Y\_qol }\SpecialCharTok{\textasciitilde{}}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env, }
                 \AttributeTok{family =} \StringTok{"gaussian"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df2\_int)}

\DocumentationTok{\#\# 2. Predict an outcome for each subject, setting A=0 and A=1}
\CommentTok{\# prepare data sets used to predict the outcome under the counterfactual }
\CommentTok{\# scenarios setting A=0 and A=1}
\NormalTok{data.A1 }\OtherTok{\textless{}{-}}\NormalTok{ data.A0 }\OtherTok{\textless{}{-}}\NormalTok{ df2\_int}
\NormalTok{data.A1}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \OtherTok{\textless{}{-}} \DecValTok{1}
\NormalTok{data.A0}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \OtherTok{\textless{}{-}} \DecValTok{0}

\CommentTok{\# predict values}
\NormalTok{Y1.death.pred }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(Q.tot.death, }\AttributeTok{newdata =}\NormalTok{ data.A1, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}
\NormalTok{Y0.death.pred }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(Q.tot.death, }\AttributeTok{newdata =}\NormalTok{ data.A0, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}

\NormalTok{Y1.qol.pred }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(Q.tot.qol, }\AttributeTok{newdata =}\NormalTok{ data.A1, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}
\NormalTok{Y0.qol.pred }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(Q.tot.qol, }\AttributeTok{newdata =}\NormalTok{ data.A0, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}

\DocumentationTok{\#\# 3. Plug the predicted outcome in the gformula and use the sample mean }
\DocumentationTok{\#\#    to estimate the ATE}
\NormalTok{ATE.death.gcomp }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(Y1.death.pred }\SpecialCharTok{{-}}\NormalTok{ Y0.death.pred)}
\NormalTok{ATE.death.gcomp}
\CommentTok{\# [1] 0.08270821}

\NormalTok{ATE.qol.gcomp }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(Y1.qol.pred }\SpecialCharTok{{-}}\NormalTok{ Y0.qol.pred)}
\NormalTok{ATE.qol.gcomp}
\CommentTok{\# [1] {-}8.360691}
\end{Highlighting}
\end{Shaded}

A 95\% confidence interval can be estimated applying a bootstrap procedure. An example is given in the following code.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{1234}\NormalTok{)}
\NormalTok{B }\OtherTok{\textless{}{-}} \DecValTok{1000}
\NormalTok{bootstrap.estimates }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}\FunctionTok{matrix}\NormalTok{(}\ConstantTok{NA}\NormalTok{, }\AttributeTok{nrow =}\NormalTok{ B, }\AttributeTok{ncol =} \DecValTok{2}\NormalTok{))}
\FunctionTok{colnames}\NormalTok{(bootstrap.estimates) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"boot.death.est"}\NormalTok{, }\StringTok{"boot.qol.est"}\NormalTok{)}
\ControlFlowTok{for}\NormalTok{ (b }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{B)\{}
  \CommentTok{\# sample the indices 1 to n with replacement}
\NormalTok{  bootIndices }\OtherTok{\textless{}{-}} \FunctionTok{sample}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(df2\_int), }\AttributeTok{replace=}\NormalTok{T)}
\NormalTok{  bootData }\OtherTok{\textless{}{-}}\NormalTok{ df2\_int[bootIndices,]}

  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{round}\NormalTok{(b}\SpecialCharTok{/}\DecValTok{100}\NormalTok{, }\DecValTok{0}\NormalTok{) }\SpecialCharTok{==}\NormalTok{ b}\SpecialCharTok{/}\DecValTok{100}\NormalTok{ ) }\FunctionTok{print}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"bootstrap number "}\NormalTok{,b))}

\NormalTok{  Q.tot.death }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Y\_death }\SpecialCharTok{\textasciitilde{}}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env,}
                     \AttributeTok{family =} \StringTok{"binomial"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ bootData)}
\NormalTok{  Q.tot.qol }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Y\_qol }\SpecialCharTok{\textasciitilde{}}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env,}
                   \AttributeTok{family =} \StringTok{"gaussian"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ bootData)}

\NormalTok{  boot.A}\FloatTok{.1} \OtherTok{\textless{}{-}}\NormalTok{ boot.A}\FloatTok{.0} \OtherTok{\textless{}{-}}\NormalTok{ bootData}
\NormalTok{  boot.A}\FloatTok{.1}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \OtherTok{\textless{}{-}} \DecValTok{1}
\NormalTok{  boot.A}\FloatTok{.0}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \OtherTok{\textless{}{-}} \DecValTok{0}

\NormalTok{  Y1.death.boot }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(Q.tot.death, }\AttributeTok{newdata =}\NormalTok{ boot.A}\FloatTok{.1}\NormalTok{, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}
\NormalTok{  Y0.death.boot }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(Q.tot.death, }\AttributeTok{newdata =}\NormalTok{ boot.A}\FloatTok{.0}\NormalTok{, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}

\NormalTok{  Y1.qol.boot }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(Q.tot.qol, }\AttributeTok{newdata =}\NormalTok{ boot.A}\FloatTok{.1}\NormalTok{, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}
\NormalTok{  Y0.qol.boot }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(Q.tot.qol, }\AttributeTok{newdata =}\NormalTok{ boot.A}\FloatTok{.0}\NormalTok{, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}

\NormalTok{  bootstrap.estimates[b,}\StringTok{"boot.death.est"}\NormalTok{] }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(Y1.death.boot }\SpecialCharTok{{-}}\NormalTok{ Y0.death.boot)}
\NormalTok{  bootstrap.estimates[b,}\StringTok{"boot.qol.est"}\NormalTok{] }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(Y1.qol.boot }\SpecialCharTok{{-}}\NormalTok{ Y0.qol.boot)}
\NormalTok{\}}

\NormalTok{IC95.ATE.death }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(ATE.death.gcomp }\SpecialCharTok{{-}} 
                      \FunctionTok{qnorm}\NormalTok{(}\FloatTok{0.975}\NormalTok{) }\SpecialCharTok{*} \FunctionTok{sd}\NormalTok{(bootstrap.estimates[,}\StringTok{"boot.death.est"}\NormalTok{]),}
\NormalTok{                    ATE.death.gcomp }\SpecialCharTok{+} 
                      \FunctionTok{qnorm}\NormalTok{(}\FloatTok{0.975}\NormalTok{) }\SpecialCharTok{*} \FunctionTok{sd}\NormalTok{(bootstrap.estimates[,}\StringTok{"boot.death.est"}\NormalTok{]))}
\NormalTok{IC95.ATE.death}
\CommentTok{\# [1] 0.05612907 0.10928734}

\NormalTok{IC95.ATE.qol }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(ATE.qol.gcomp }\SpecialCharTok{{-}} 
                    \FunctionTok{qnorm}\NormalTok{(}\FloatTok{0.975}\NormalTok{) }\SpecialCharTok{*} \FunctionTok{sd}\NormalTok{(bootstrap.estimates[,}\StringTok{"boot.qol.est"}\NormalTok{]),}
\NormalTok{                  ATE.qol.gcomp }\SpecialCharTok{+} 
                    \FunctionTok{qnorm}\NormalTok{(}\FloatTok{0.975}\NormalTok{) }\SpecialCharTok{*} \FunctionTok{sd}\NormalTok{(bootstrap.estimates[,}\StringTok{"boot.qol.est"}\NormalTok{]))}
\NormalTok{IC95.ATE.qol}
\CommentTok{\# [1] {-}9.157856 {-}7.563526}
\end{Highlighting}
\end{Shaded}

\section{Estimation of Controlled Direct Effects (CDE)}\label{estimation-of-controlled-direct-effects-cde}

The controlled direct effect \(\Psi^{\text{CDE}_m} = \mathbb{E}(Y_{A=1,M=m}) - \mathbb{E}(Y_{A=0,M=m})\) is the difference between the mean outcome had the whole population been exposed to high levels of \(\text{PM}_{2.5}\) (setting \(A=1\)), compared to the mean outcome had the whole population been unexposed (setting \(A=0\)), while keeping the mediator (type-2 diabetes) equal to a constant given value (\(M=m\)) in both scenarios.

The g-formula for a CDE (\(\mathbb{E}(Y_{A=a^\prime,M=m})\)) is more complex than for the average total effect, and the simple substitution approach described previously is less convenient to apply:

\(\mathbb{E}(Y_{A=a^\prime,M=m}) = \sum_{l(0),l(1)} \left[ \mathbb{E}\left(Y \mid m, l(1), a^\prime, l(0) \right) \times P\left( L(1)=l(1) | a^\prime,l(0) \right) \right] \times P\left( L(0)=l(0) \right)\)

In our simple example with a binary exposure \(A\), a binary mediator \(M\) and a binary intermediate confounder \(L(1)\), it is still possible to apply the substitution approach (corresponding to a non-parametric g-computation estimation) by estimating the following components of the g-formula:

\begin{itemize}
\tightlist
\item
  \(\overline{Q}_Y(A,L(1),M)=\mathbb{E}\left(Y \mid L(0), A,L(1), M \right)\),
\item
  and \(\overline{Q}_{L(1)}(A)=P\left(L(1)=1) \mid A, l(0)\right)\)
\end{itemize}

We can then generate predicted outcomes from these 3 models for each subject in the data set, and obtain a \emph{non-parametric maximum likelihood estimator (NPMLE)} of the CDE using the empirical mean:
\[\scriptsize
\begin{array}{r l}
\Psi^{\text{CDE}_m}_{\text{NPMLE}} = \frac{1}{n}\sum & \left[\hat{\overline{Q}}_Y(A=1,L(1)=1,M=m) \times \hat{\overline{Q}}_{L(1)}(A=1) + \hat{\overline{Q}}_Y(A=1,L(1)=0,M=m) \times (1 - \hat{\overline{Q}}_{L(1)}(A=1))\right]\\
  &  - \left[\hat{\overline{Q}}_Y(A=0,L(1)=1,M=m) \times \hat{\overline{Q}}_{L(1)}(A=0) + \hat{\overline{Q}}_Y(A=0,L(1)=0,M=m) \times (1 - \hat{\overline{Q}}_{L(1)}(A=0))\right]
\end{array}\]

However NPMLE is tedious with high-dimensional intermediate confounders \(L(1)\) or if mediators is repeated over time. In that case, parametric g-computation using a Monte Carlo algorithm, or g-computation by iterative conditional expectation are easier to apply.

Below, we describe three g-computation procedures for the estimation of a CDE:

\begin{itemize}
\tightlist
\item
  parametric g-computation, using Monte Carlo simulation
\item
  g-computation by iterative conditional expectation
\item
  sequential g-estimator
\end{itemize}

\subsection{Parametric g-computation}\label{ChapGcomp-CDE-param}

Parametric g-computation by Monte Carlo simulation have been described by Robins (\citeproc{ref-robins1986}{Robins 1986}), Taubman \emph{et al.} (\citeproc{ref-taubman2009}{Taubman et al. 2009}), or Daniel \emph{et al.} (\citeproc{ref-daniel2013}{Daniel et al. 2013}).

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Fit a parametric model to estimate the density of the intermediate confounder \(L(1)\) conditional on its parents. If \(L(1)\) is a set of several variables, it is necessary to fit a model for each variable conditional on its parents (where the \(L(1)\) variables are put in an arbitrary order).
  \begin{equation}
    Q_{L(1)}(A) = P(L(1)=1 \mid L(0),A)
  \end{equation}
\item
  Fit a model of the outcome \(Y\) conditional on its parents:
  \begin{equation}
    \overline{Q}_Y(A,L(1),M) = \mathbb{E}\left(Y \mid L(0),A,L(1),M \right)
  \end{equation}
\item
  Simulate individual values of \(L(1)_a\) using the estimated density \(\hat{Q}_{L(1)}(A=a)\) under the counterfactual scenarios setting \(A=0\) or \(A=1\)
\item
  Estimate mean values of the outcome under the counterfactual scenarios setting \(A=0\) (or \(A=1\)), \(L(1)=l(1)_{A=0}\) (or \(L(1)=l(1)_{A=1}\)) and \(M=m\), using \(\hat{\overline{Q}}_Y(A=a,L(1)=l(1)_a,M=m)\)
\item
  Estimate the controlled direct effect \(\Psi_{\text{CDE}_m}\) by the sample mean:
  \begin{equation}
    \small \hat{\Psi}^{\text{CDE}_m}_{\text{param.gcomp}} = \frac{1}{n} \sum_{i=1}^n \left[ \hat{\overline{Q}}_Y(A=1,L(1)=l(1)_{A=1},M=m)_i - \hat{\overline{Q}}_Y(A=0,L(1)=l(1)_{A=0},M=m)_i \right]
  \end{equation}
\end{enumerate}

For continuous outcomes, \(\overline{Q}_Y(A,L(1),M)\) functions can be estimated using linear regressions. For binary outcomes, they can be estimated using logistic regressions.

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# 1. Fit parametric models to estimate the density of intermediate confounders, }
\DocumentationTok{\#\#    conditional on the parents of the intermediate confounders}
\NormalTok{L1.model }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(L1 }\SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5}\NormalTok{, }
                \AttributeTok{family =} \StringTok{"binomial"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df2\_int)}

\DocumentationTok{\#\# 2. Fit parametric models for the outcome conditional on past}
\NormalTok{Y.death.model }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Y\_death }\SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+}\NormalTok{ L1 }\SpecialCharTok{+} 
\NormalTok{                       M\_diabetes }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5}\SpecialCharTok{:}\NormalTok{M\_diabetes, }
                     \AttributeTok{family =} \StringTok{"binomial"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df2\_int)}
\NormalTok{                      family }\OtherTok{=} \StringTok{"binomial"}\NormalTok{, data }\OtherTok{=}\NormalTok{ df2\_int}\ErrorTok{)}
\NormalTok{Y.qol.model }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Y\_qol }\SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+}\NormalTok{ L1 }\SpecialCharTok{+} 
\NormalTok{                     M\_diabetes }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5}\SpecialCharTok{:}\NormalTok{M\_diabetes, }
                   \AttributeTok{family =} \StringTok{"gaussian"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df2\_int)}

\DocumentationTok{\#\# 3. Simulate individual L1 values under the counterfactual scenarios setting A0=0 or A0=1}
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{54321}\NormalTok{)}
\NormalTok{data.A0  }\OtherTok{\textless{}{-}}\NormalTok{ data.A1 }\OtherTok{\textless{}{-}}\NormalTok{ df2\_int}
\NormalTok{data.A0}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \OtherTok{\textless{}{-}} \DecValTok{0}
\NormalTok{data.A1}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \OtherTok{\textless{}{-}} \DecValTok{1}
\NormalTok{p.L1.A0 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(L1.model, }\AttributeTok{newdata =}\NormalTok{ data.A0, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)}
\NormalTok{p.L1.A1 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(L1.model, }\AttributeTok{newdata =}\NormalTok{ data.A1, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)}
\NormalTok{sim.L1.A0 }\OtherTok{\textless{}{-}} \FunctionTok{rbinom}\NormalTok{(}\AttributeTok{n =} \FunctionTok{nrow}\NormalTok{(df2\_int), }\AttributeTok{size =} \DecValTok{1}\NormalTok{, }\AttributeTok{prob =}\NormalTok{ p.L1.A0)}
\NormalTok{sim.L1.A1 }\OtherTok{\textless{}{-}} \FunctionTok{rbinom}\NormalTok{(}\AttributeTok{n =} \FunctionTok{nrow}\NormalTok{(df2\_int), }\AttributeTok{size =} \DecValTok{1}\NormalTok{, }\AttributeTok{prob =}\NormalTok{ p.L1.A1)}

\DocumentationTok{\#\# 4. Estimate mean outcomes under the counterfactual scenarios setting different }
\DocumentationTok{\#\#    levels of exposures for A and M:}
\DocumentationTok{\#\#    \{A=0, M=0\} or \{A=1, M=0\} or \{A=0, M=1\} or \{A=1, M=1\}}

\NormalTok{data.A0.M0 }\OtherTok{\textless{}{-}}\NormalTok{ data.A0.M1 }\OtherTok{\textless{}{-}}\NormalTok{ data.A0}
\NormalTok{data.A1.M0 }\OtherTok{\textless{}{-}}\NormalTok{ data.A1.M1 }\OtherTok{\textless{}{-}}\NormalTok{ data.A1}

\CommentTok{\# L1 variable is replaced by the simulated values in step 3)}
\NormalTok{data.A0.M0}\SpecialCharTok{$}\NormalTok{L1 }\OtherTok{\textless{}{-}}\NormalTok{ sim.L1.A0}
\NormalTok{data.A0.M1}\SpecialCharTok{$}\NormalTok{L1 }\OtherTok{\textless{}{-}}\NormalTok{ sim.L1.A0}
\NormalTok{data.A1.M0}\SpecialCharTok{$}\NormalTok{L1 }\OtherTok{\textless{}{-}}\NormalTok{ sim.L1.A1}
\NormalTok{data.A1.M1}\SpecialCharTok{$}\NormalTok{L1 }\OtherTok{\textless{}{-}}\NormalTok{ sim.L1.A1}

\CommentTok{\# set M to 0 or 1}
\NormalTok{data.A0.M0}\SpecialCharTok{$}\NormalTok{M\_diabetes }\OtherTok{\textless{}{-}} \DecValTok{0}
\NormalTok{data.A0.M1}\SpecialCharTok{$}\NormalTok{M\_diabetes }\OtherTok{\textless{}{-}} \DecValTok{1}
\NormalTok{data.A1.M0}\SpecialCharTok{$}\NormalTok{M\_diabetes }\OtherTok{\textless{}{-}} \DecValTok{0}
\NormalTok{data.A1.M1}\SpecialCharTok{$}\NormalTok{M\_diabetes }\OtherTok{\textless{}{-}} \DecValTok{1}

\CommentTok{\# predict the probability of death}
\NormalTok{p.death.A0.M0 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(Y.death.model, }\AttributeTok{newdata =}\NormalTok{ data.A0.M0, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}
\NormalTok{p.death.A1.M0 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(Y.death.model, }\AttributeTok{newdata =}\NormalTok{ data.A1.M0, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}
\NormalTok{p.death.A0.M1 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(Y.death.model, }\AttributeTok{newdata =}\NormalTok{ data.A0.M1, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}
\NormalTok{p.death.A1.M1 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(Y.death.model, }\AttributeTok{newdata =}\NormalTok{ data.A1.M1, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}

\CommentTok{\# predict the mean value of QoL}
\NormalTok{m.qol.A0.M0 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(Y.qol.model, }\AttributeTok{newdata =}\NormalTok{ data.A0.M0, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}
\NormalTok{m.qol.A1.M0 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(Y.qol.model, }\AttributeTok{newdata =}\NormalTok{ data.A1.M0, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}
\NormalTok{m.qol.A0.M1 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(Y.qol.model, }\AttributeTok{newdata =}\NormalTok{ data.A0.M1, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}
\NormalTok{m.qol.A1.M1 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(Y.qol.model, }\AttributeTok{newdata =}\NormalTok{ data.A1.M1, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}

\DocumentationTok{\#\# 5. Estimate the CDE}
\CommentTok{\# CDE setting M=0}
\NormalTok{CDE.death.m0.gcomp.param }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(p.death.A1.M0) }\SpecialCharTok{{-}} \FunctionTok{mean}\NormalTok{(p.death.A0.M0)}
\NormalTok{CDE.death.m0.gcomp.param}
\CommentTok{\# [1] 0.06289087}

\NormalTok{CDE.qol.m0.gcomp.param }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(m.qol.A1.M0) }\SpecialCharTok{{-}} \FunctionTok{mean}\NormalTok{(m.qol.A0.M0)}
\NormalTok{CDE.qol.m0.gcomp.param}
\CommentTok{\# [1] {-}4.838654}

\CommentTok{\# CDE setting M=1}
\NormalTok{CDE.death.m1.gcomp.param }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(p.death.A1.M1) }\SpecialCharTok{{-}} \FunctionTok{mean}\NormalTok{(p.death.A0.M1)}
\NormalTok{CDE.death.m1.gcomp.param}
\CommentTok{\# [1] 0.08751016}

\NormalTok{CDE.qol.m1.gcomp.param }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(m.qol.A1.M1) }\SpecialCharTok{{-}} \FunctionTok{mean}\NormalTok{(m.qol.A0.M1)}
\NormalTok{CDE.qol.m1.gcomp.param}
\CommentTok{\# [1] {-}10.35059}
\end{Highlighting}
\end{Shaded}

\subsection{G-computation by iterative conditional expectation}\label{ChapGcomp-CDE-ICE}

The following steps describe the implementation of the g-computation estimator by iterative conditional expectation for the component \(\mathbb{E}(Y_{A=a^\prime,M=m})\) used in the definition of CDE \(\Psi^{\text{CDE}_m} = \mathbb{E}(Y_{A=1,M=m}) - \mathbb{E}(Y_{A=0,M=m})\). Interestingly, there is no need to estimate or simulate \(L(1)\) density with this method.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Fit a logistic or a linear regression of the final outcome, conditional on the exposure \(A\), the mediator \(M\) and all the parents of \(Y\) preceding \(M\), to estimate \(\overline{Q}_{Y} = \mathbb{E}(Y \mid L(0),A,L(1),M)\);
\item
  Use this estimate to predict an outcome for each subject \(\hat{\overline{Q}}_{Y}(A=a^\prime,M=m)_i\), by evaluating the regression fit \(\overline{Q}_{Y}\) at the chosen value for the exposure \(A=a^\prime\) and the mediator \(M=m\);
\item
  Fit a quasibinomial or a linear regression of the predicted values \(\hat{\overline{Q}}_{Y}(M=m)_i\) conditional on the exposure \(A\) and baseline confounders \(L(0)\) to estimate \(\overline{Q}_{L(1)} = \mathbb{E}\left(\hat{\overline{Q}}_{Y}(A=a^\prime,M=m) \middle| L(0),A\right)\);
\item
  Use this estimate to predict the outcome \(\hat{\overline{Q}}_{L(1)}(A=a^\prime)_i\) for each subject, by evaluating the regression fit \(\overline{Q}_{L(1)}\) at \(A=a^\prime\);
\item
  Use the sample mean to estimate \(\Psi^{\text{CDE}_m}_{\text{gcomp}}\)
  \begin{equation}
  \hat{\Psi}^{\text{CDE}_m}_{\text{gcomp}} = \frac{1}{n} \sum_{i=1}^n \left[ \hat{\overline{Q}}_{L(1)}(A=1)_i - \hat{\overline{Q}}_{L(1)}(A=0)_i \right]
  \end{equation}
\end{enumerate}

Note that G-computation by iterative expectation is preferable if the set of intermediate confounders \(L(1)\) is high-dimensional as we only need to fit 1 model by counterfactual scenario (for a whole set of \(L(1)\) variables) in the procedure described below, whereas at least 1 model by \(L(1)\) variable and by counterfactual scenario are needed with parametric g-computation.

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# 1) Regress the outcome on L0, A, L1 and M (and the A*M interaction if appropriate)}
\NormalTok{Y.death.model }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Y\_death }\SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+}\NormalTok{ L1 }\SpecialCharTok{+}
\NormalTok{                       M\_diabetes }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5}\SpecialCharTok{:}\NormalTok{M\_diabetes,}
                     \AttributeTok{family =} \StringTok{"binomial"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df2\_int)}
\NormalTok{Y.qol.model }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Y\_qol }\SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+}\NormalTok{ L1 }\SpecialCharTok{+}
\NormalTok{                     M\_diabetes }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5}\SpecialCharTok{:}\NormalTok{M\_diabetes,}
                   \AttributeTok{family =} \StringTok{"gaussian"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df2\_int)}

\CommentTok{\# 2) Generate predicted values by evaluating the regression setting the exposure}
\CommentTok{\#    and the mediator at exposure history of interest:}
\CommentTok{\#    \{A=1,M=0\},\{A=0,M=0\},\{A=1,M=1\},\{A=0,M=1\}}
\NormalTok{data.Ais0.Mis0 }\OtherTok{\textless{}{-}}\NormalTok{ data.Ais0.Mis1 }\OtherTok{\textless{}{-}}\NormalTok{ df2\_int}
\NormalTok{data.Ais1.Mis0 }\OtherTok{\textless{}{-}}\NormalTok{ data.Ais1.Mis1 }\OtherTok{\textless{}{-}}\NormalTok{ df2\_int}

\NormalTok{data.Ais0.Mis0}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \OtherTok{\textless{}{-}} \DecValTok{0}
\NormalTok{data.Ais0.Mis0}\SpecialCharTok{$}\NormalTok{M\_diabetes }\OtherTok{\textless{}{-}} \DecValTok{0}

\NormalTok{data.Ais0.Mis1}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \OtherTok{\textless{}{-}} \DecValTok{0}
\NormalTok{data.Ais0.Mis1}\SpecialCharTok{$}\NormalTok{M\_diabetes }\OtherTok{\textless{}{-}} \DecValTok{1}

\NormalTok{data.Ais1.Mis0}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \OtherTok{\textless{}{-}} \DecValTok{1}
\NormalTok{data.Ais1.Mis0}\SpecialCharTok{$}\NormalTok{M\_diabetes }\OtherTok{\textless{}{-}} \DecValTok{0}

\NormalTok{data.Ais1.Mis1}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \OtherTok{\textless{}{-}} \DecValTok{1}
\NormalTok{data.Ais1.Mis1}\SpecialCharTok{$}\NormalTok{M\_diabetes }\OtherTok{\textless{}{-}} \DecValTok{1}

\NormalTok{Q.L2.death.A0M0 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(Y.death.model, }\AttributeTok{newdata =}\NormalTok{ data.Ais0.Mis0, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)}
\NormalTok{Q.L2.death.A0M1 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(Y.death.model, }\AttributeTok{newdata =}\NormalTok{ data.Ais0.Mis1, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)}
\NormalTok{Q.L2.death.A1M0 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(Y.death.model, }\AttributeTok{newdata =}\NormalTok{ data.Ais1.Mis0, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)}
\NormalTok{Q.L2.death.A1M1 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(Y.death.model, }\AttributeTok{newdata =}\NormalTok{ data.Ais1.Mis1, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)}

\NormalTok{Q.L2.qol.A0M0 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(Y.qol.model, }\AttributeTok{newdata =}\NormalTok{ data.Ais0.Mis0, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)}
\NormalTok{Q.L2.qol.A0M1 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(Y.qol.model, }\AttributeTok{newdata =}\NormalTok{ data.Ais0.Mis1, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)}
\NormalTok{Q.L2.qol.A1M0 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(Y.qol.model, }\AttributeTok{newdata =}\NormalTok{ data.Ais1.Mis0, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)}
\NormalTok{Q.L2.qol.A1M1 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(Y.qol.model, }\AttributeTok{newdata =}\NormalTok{ data.Ais1.Mis1, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)}

\DocumentationTok{\#\# 3) Regress the predicted values conditional on the exposure A}
\DocumentationTok{\#\#    and baseline confounders L(0)}
\NormalTok{L1.death.A0M0.model }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Q.L2.death.A0M0 }\SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5}\NormalTok{,}
                           \AttributeTok{family =} \StringTok{"quasibinomial"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df2\_int)}
\NormalTok{L1.death.A0M1.model }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Q.L2.death.A0M1 }\SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5}\NormalTok{,}
                           \AttributeTok{family =} \StringTok{"quasibinomial"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df2\_int)}
\NormalTok{L1.death.A1M0.model }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Q.L2.death.A1M0 }\SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5}\NormalTok{,}
                           \AttributeTok{family =} \StringTok{"quasibinomial"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df2\_int)}
\NormalTok{L1.death.A1M1.model }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Q.L2.death.A1M1 }\SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5}\NormalTok{,}
                           \AttributeTok{family =} \StringTok{"quasibinomial"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df2\_int)}

\NormalTok{L1.qol.A0M0.model }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Q.L2.qol.A0M0 }\SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5}\NormalTok{,}
                         \AttributeTok{family =} \StringTok{"gaussian"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df2\_int)}
\NormalTok{L1.qol.A0M1.model }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Q.L2.qol.A0M1 }\SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5}\NormalTok{,}
                         \AttributeTok{family =} \StringTok{"gaussian"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df2\_int)}
\NormalTok{L1.qol.A1M0.model }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Q.L2.qol.A1M0 }\SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5}\NormalTok{,}
                         \AttributeTok{family =} \StringTok{"gaussian"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df2\_int)}
\NormalTok{L1.qol.A1M1.model }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Q.L2.qol.A1M1 }\SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5}\NormalTok{,}
                         \AttributeTok{family =} \StringTok{"gaussian"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df2\_int)}

\DocumentationTok{\#\# 4) generate predicted values by evaluating the regression at exposure }
\DocumentationTok{\#\#    of interest: \{A=1\} \& \{A=0\}}
\NormalTok{Q.L1.death.A0M0 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(L1.death.A0M0.model, }\AttributeTok{newdata =}\NormalTok{ data.Ais0.Mis0, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)}
\NormalTok{Q.L1.death.A0M1 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(L1.death.A0M1.model, }\AttributeTok{newdata =}\NormalTok{ data.Ais0.Mis1, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)}
\NormalTok{Q.L1.death.A1M0 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(L1.death.A1M0.model, }\AttributeTok{newdata =}\NormalTok{ data.Ais1.Mis0, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)}
\NormalTok{Q.L1.death.A1M1 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(L1.death.A1M1.model, }\AttributeTok{newdata =}\NormalTok{ data.Ais1.Mis1, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)}

\NormalTok{Q.L1.qol.A0M0 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(L1.qol.A0M0.model, }\AttributeTok{newdata =}\NormalTok{ data.Ais0.Mis0, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)}
\NormalTok{Q.L1.qol.A0M1 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(L1.qol.A0M1.model, }\AttributeTok{newdata =}\NormalTok{ data.Ais0.Mis1, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)}
\NormalTok{Q.L1.qol.A1M0 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(L1.qol.A1M0.model, }\AttributeTok{newdata =}\NormalTok{ data.Ais1.Mis0, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)}
\NormalTok{Q.L1.qol.A1M1 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(L1.qol.A1M1.model, }\AttributeTok{newdata =}\NormalTok{ data.Ais1.Mis1, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)}

\DocumentationTok{\#\# 5) Take empirical mean of final predicted outcomes to estimate CDE}
\CommentTok{\# CDE setting M=0}
\NormalTok{CDE.death.m0.gcomp.ice }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(Q.L1.death.A1M0) }\SpecialCharTok{{-}} \FunctionTok{mean}\NormalTok{(Q.L1.death.A0M0)}
\NormalTok{CDE.death.m0.gcomp.ice}
\CommentTok{\# [1] 0.06342833}

\NormalTok{CDE.qol.m0.gcomp.ice }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(Q.L1.qol.A1M0) }\SpecialCharTok{{-}} \FunctionTok{mean}\NormalTok{(Q.L1.qol.A0M0)}
\NormalTok{CDE.qol.m0.gcomp.ice}
\CommentTok{\# [1] {-}4.869509}

\CommentTok{\# CDE setting M=1}
\NormalTok{CDE.death.m1.gcomp.ice }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(Q.L1.death.A1M1) }\SpecialCharTok{{-}} \FunctionTok{mean}\NormalTok{(Q.L1.death.A0M1)}
\NormalTok{CDE.death.m1.gcomp.ice}
\CommentTok{\# [1] 0.08812318}

\NormalTok{CDE.qol.m1.gcomp.ice }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(Q.L1.qol.A1M1) }\SpecialCharTok{{-}} \FunctionTok{mean}\NormalTok{(Q.L1.qol.A0M1)}
\NormalTok{CDE.qol.m1.gcomp.ice}
\CommentTok{\# [1] {-}10.38144}
\end{Highlighting}
\end{Shaded}

\subsubsection{\texorpdfstring{G-computation by ICE using the \texttt{ltmle} package}{G-computation by ICE using the ltmle package}}\label{g-computation-by-ice-using-the-ltmle-package}

The \texttt{ltmle} package can be used to estimate Controlled Direct Effects by g-computation.

An application is shown below.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ltmle)}
\NormalTok{df2\_int }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file =} \StringTok{"df2\_int.csv"}\NormalTok{)}

\CommentTok{\# the data set should be composed of continuous or binary variables,}
\CommentTok{\# ordered following the cause{-}effect sequence of each variables.}
\CommentTok{\# Note that within a set of exposures or intermediate confounders measured at a}
\CommentTok{\# single discrete time t, any causal sequence can be applied (for example,}
\CommentTok{\# with several L1 variable, it can be \{L1.1, L1.2, L1.3\} or \{L1.2,L1.3,L1.1\},}
\CommentTok{\# without any consequences on the estimation.}
\NormalTok{df.death }\OtherTok{\textless{}{-}} \FunctionTok{subset}\NormalTok{(df2\_int, }\AttributeTok{select =} \SpecialCharTok{{-}}\NormalTok{Y\_qol)}
\NormalTok{df.qol }\OtherTok{\textless{}{-}} \FunctionTok{subset}\NormalTok{(df2\_int, }\AttributeTok{select =} \SpecialCharTok{{-}}\NormalTok{Y\_death)}

\DocumentationTok{\#\# 1) Define Q formulas (Qbar\_L1 and Qbar\_Y functions)}
\NormalTok{Q\_formulas.death }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\AttributeTok{L1 =} \StringTok{"Q.kplus1 \textasciitilde{} L0\_male + L0\_soc\_env + A0\_PM2.5"}\NormalTok{,}
                      \AttributeTok{Y\_death =} \StringTok{"Q.kplus1 \textasciitilde{} L0\_male + L0\_soc\_env + L1 +}
\StringTok{                                 A0\_PM2.5 * M\_diabetes"}\NormalTok{) }\CommentTok{\# add interaction}
\NormalTok{Q\_formulas.qol }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\AttributeTok{L1 =} \StringTok{"Q.kplus1 \textasciitilde{} L0\_male + L0\_soc\_env + A0\_PM2.5"}\NormalTok{,}
                    \AttributeTok{Y\_qol =} \StringTok{"Q.kplus1 \textasciitilde{} L0\_male + L0\_soc\_env + L1 +}
\StringTok{                             A0\_PM2.5 * M\_diabetes"}\NormalTok{) }\CommentTok{\# add interaction}
\DocumentationTok{\#\# 2) Define g formulas (needed for the ltmle package) but they are not used}
\CommentTok{\#    with the g{-}computation estimator}
\NormalTok{g\_formulas }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"A0\_PM2.5 \textasciitilde{} L0\_male + L0\_soc\_env"}\NormalTok{, }
                \StringTok{"M\_diabetes \textasciitilde{} L0\_male + L0\_soc\_env + A0\_PM2.5 + L1"}\NormalTok{)}

\DocumentationTok{\#\# 3) Use the ltmle() function}
\CommentTok{\# arguments:}
\CommentTok{\#  {-} Anodes: indicate the exposure and the mediator variables}
\CommentTok{\#  {-} Lnodes: indicate the intermediate confounders (+/{-} baseline confounders)}
\CommentTok{\#  {-} Cnodes: censoring nodes, useless in our example}
\CommentTok{\#  {-} Ynodes: outcome variable}
\CommentTok{\#  {-} survivalOutcome = FALSE in our example}
\CommentTok{\#  {-} abar: list of the two values used to define counterfactual outcomes}
\CommentTok{\#          for the contrast of interest. For example, setting M=0,}
\CommentTok{\#          CDE(M=0) = E(Y\_\{A=1,M=0\}) {-} E(Y\_\{A=0,M=0\})}
\CommentTok{\#  {-} rule: to define dynamic rules (useless in our example)}
\CommentTok{\#  {-} gbounds = c(0.01, 1) by default. This parameter is not used with g{-}computation}
\CommentTok{\#  {-} Yrange = NULL, can be used to define range (min,max) for continuous outcomes}
\CommentTok{\#  {-} SL.library = "glm",  will apply main terms glm models.}
\CommentTok{\#                 The argument can be used to specify SuperLearner libraries.}
\CommentTok{\#                 However, simple glm models might be preferable as data.adaptive}
\CommentTok{\#                 algorithms rely on cross{-}validation, which is difficult and long to}
\CommentTok{\#                 implement with the bootstrap procedure needed for 95\% confidence}
\CommentTok{\#                 intervals}
\CommentTok{\#  {-} stratify = FALSE by default. If TRUE, glm estimations are stratified for}
\CommentTok{\#               each counterfactual scenario defined in abar.}
\CommentTok{\#  {-} estimate.time = FALSE. If TRUE, print a rough estimate of computation time}
\CommentTok{\#  {-} iptw.only = FALSE, useless with g{-}computation}
\CommentTok{\#  {-} variance.method = "ic", computation is faster than with "tmle" which}
\CommentTok{\#  {-}                     is useless with g{-}comp: variance estimates rely on}
\CommentTok{\#                        influence curves which cannot be used with g{-}comp because}
\CommentTok{\#                       g{-}computation is not a asymptotically efficient estimator.}
\CommentTok{\#  {-} observation.weights = NULL, can be used to specify individual weights}

\DocumentationTok{\#\# With a binary outcome, CDE(M=1) = P(Y\_\{A=1,M=0\} = 1) {-} P(Y\_\{A=0,M=0\} = 1)}
\NormalTok{ltmle.gcomp.CDE.M0 }\OtherTok{\textless{}{-}} \FunctionTok{ltmle}\NormalTok{(}\AttributeTok{data =}\NormalTok{ df.death,}
                            \AttributeTok{Anodes =} \FunctionTok{c}\NormalTok{(}\StringTok{"A0\_PM2.5"}\NormalTok{, }\StringTok{"M\_diabetes"}\NormalTok{),}
                            \AttributeTok{Lnodes =} \FunctionTok{c}\NormalTok{(}\StringTok{"L1"}\NormalTok{),}
                            \AttributeTok{Ynodes =} \FunctionTok{c}\NormalTok{(}\StringTok{"Y\_death"}\NormalTok{), }\CommentTok{\# binary outcome}
                            \AttributeTok{survivalOutcome =} \ConstantTok{FALSE}\NormalTok{,}
                            \AttributeTok{Qform =}\NormalTok{ Q\_formulas.death, }\CommentTok{\# Q formulas}
                            \AttributeTok{gform =}\NormalTok{ g\_formulas, }\CommentTok{\# g formulas}
                            \AttributeTok{abar =} \FunctionTok{list}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{0}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{)), }\CommentTok{\# Y\_\{A=1,M=0\} vs Y\_\{A=0,M=0\}}
                            \AttributeTok{rule =} \ConstantTok{NULL}\NormalTok{,}
                            \AttributeTok{gbounds =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.01}\NormalTok{, }\DecValTok{1}\NormalTok{), }\CommentTok{\# by default}
                            \AttributeTok{Yrange =} \ConstantTok{NULL}\NormalTok{,}
                            \AttributeTok{deterministic.g.function =} \ConstantTok{NULL}\NormalTok{,}
                            \AttributeTok{stratify =} \ConstantTok{FALSE}\NormalTok{,}
                            \AttributeTok{SL.library =} \StringTok{"glm"}\NormalTok{,}
                            \AttributeTok{SL.cvControl =} \FunctionTok{list}\NormalTok{(),}
                            \AttributeTok{estimate.time =} \ConstantTok{FALSE}\NormalTok{,}
                            \AttributeTok{gcomp =} \ConstantTok{TRUE}\NormalTok{, }\CommentTok{\# should be TRUE for g{-}computation}
                            \AttributeTok{iptw.only =} \ConstantTok{FALSE}\NormalTok{,}
                            \AttributeTok{deterministic.Q.function =} \ConstantTok{NULL}\NormalTok{,}
                            \AttributeTok{variance.method =} \StringTok{"ic"}\NormalTok{,}
                            \AttributeTok{observation.weights =} \ConstantTok{NULL}\NormalTok{,}
                            \AttributeTok{id =} \ConstantTok{NULL}\NormalTok{)}
\FunctionTok{summary}\NormalTok{(ltmle.gcomp.CDE.M0)}
\CommentTok{\# Additive Treatment Effect:}
\CommentTok{\#   Parameter Estimate:  0.063428 \# same as manual computation}
\CommentTok{\#    Estimated Std Err:  0.018159}
\CommentTok{\#              p{-}value:  0.00047789}
\CommentTok{\#    95\% Conf Interval: (0.027836, 0.09902) \# those 95\%CI should not be used}
\CommentTok{\#                      =\textgreater{} apply a bootstrap computation instead}

\DocumentationTok{\#\# With a continuous outcome, CDE(M=1) = E(Y\_\{A=1,M=1\}) {-} E(Y\_\{A=0,M=1\})}
\NormalTok{ltmle.gcomp.CDE.M1 }\OtherTok{\textless{}{-}} \FunctionTok{ltmle}\NormalTok{(}\AttributeTok{data =}\NormalTok{ df.qol,}
                            \AttributeTok{Anodes =} \FunctionTok{c}\NormalTok{(}\StringTok{"A0\_PM2.5"}\NormalTok{, }\StringTok{"M\_diabetes"}\NormalTok{),}
                            \AttributeTok{Lnodes =} \FunctionTok{c}\NormalTok{(}\StringTok{"L1"}\NormalTok{),}
                            \AttributeTok{Ynodes =} \FunctionTok{c}\NormalTok{(}\StringTok{"Y\_qol"}\NormalTok{), }\CommentTok{\# continous outcome}
                            \AttributeTok{survivalOutcome =} \ConstantTok{FALSE}\NormalTok{,}
                            \AttributeTok{Qform =}\NormalTok{ Q\_formulas.qol, }\CommentTok{\# Q formulas}
                            \AttributeTok{gform =}\NormalTok{ g\_formulas, }\CommentTok{\# g formulas}
                            \AttributeTok{abar =} \FunctionTok{list}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{)), }\CommentTok{\# Y\_\{A=1,M=1\} vs Y\_\{A=0,M=1\}}
                            \AttributeTok{rule =} \ConstantTok{NULL}\NormalTok{,}
                            \AttributeTok{gbounds =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.01}\NormalTok{, }\DecValTok{1}\NormalTok{), }\CommentTok{\# by default}
                            \AttributeTok{Yrange =} \ConstantTok{NULL}\NormalTok{,}
                            \AttributeTok{deterministic.g.function =} \ConstantTok{NULL}\NormalTok{,}
                            \AttributeTok{stratify =} \ConstantTok{FALSE}\NormalTok{,}
                            \AttributeTok{SL.library =} \StringTok{"glm"}\NormalTok{,}
                            \AttributeTok{SL.cvControl =} \FunctionTok{list}\NormalTok{(),}
                            \AttributeTok{estimate.time =} \ConstantTok{FALSE}\NormalTok{,}
                            \AttributeTok{gcomp =} \ConstantTok{TRUE}\NormalTok{, }\CommentTok{\# should be TRUE for g{-}computation}
                            \AttributeTok{iptw.only =} \ConstantTok{FALSE}\NormalTok{,}
                            \AttributeTok{deterministic.Q.function =} \ConstantTok{NULL}\NormalTok{,}
                            \AttributeTok{variance.method =} \StringTok{"ic"}\NormalTok{,}
                            \AttributeTok{observation.weights =} \ConstantTok{NULL}\NormalTok{,}
                            \AttributeTok{id =} \ConstantTok{NULL}\NormalTok{)}
\FunctionTok{summary}\NormalTok{(ltmle.gcomp.CDE.M1)}
\CommentTok{\# Additive Treatment Effect:}
\CommentTok{\#   Parameter Estimate:  {-}10.432}
\CommentTok{\#    Estimated Std Err:  0.55975}
\CommentTok{\#              p{-}value:  \textless{}2e{-}16}
\CommentTok{\#    95\% Conf Interval: ({-}11.529, {-}9.335) those 95\%CI should not be used}
\CommentTok{\#                      =\textgreater{} apply a bootstrap computation instead}

\CommentTok{\# For quantitative outcomes, the outcome is first transformed into a continuous variable}
\CommentTok{\# with [0;1] range: Y\textquotesingle{} = (Y {-} min(Y)) / (max(Y) {-} min(Y)) to run a quasi{-}binomial}
\CommentTok{\# regression, and then estimations are back{-}transformed on the original scale.}
\end{Highlighting}
\end{Shaded}

\subsection{Sequential g-estimator}\label{sequential-g-estimator}

For quantitative outcomes, Vansteelandt et al.~(Epidemiology 20(6);2009) described a sequential g-estimator for CDE. An extension for binary outcomes in case-control studies is also described using OR.

The following 2 steps are applied:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Fit a regression model for the outcome conditional on the exposure \(A\), the mediator \(M\), baseline and intermediate confounders \(L(0)\) and \(L(1)\), in order to estimate the regression coefficients \(\hat{\gamma}_{M}\) and \(\hat{\gamma}_{A \ast M}\) (in case of \((A \ast M)\) interaction effect).
  \begin{equation}
  \mathbb{E}(Y\mid L(0),A,L(1),M) = \gamma_0 + \gamma_A A + \gamma_M M + \psi_{A \ast M} (A \ast M) + \gamma_{L(0)} L(0) + \gamma_{L(1)} L(1)
  \end{equation}
\item
  Remove the effect of mediator on the outcome, by evaluating the residual outcome:
  \begin{equation}
  Y_{res} = Y - \hat{\gamma}_M M - \hat{\psi}_{A \ast M} \times A \times M
  \end{equation}
\end{enumerate}

and regress the residual outcome on the exposure \(A\) and baseline confounders \(L(0)\):
\begin{equation}
\mathbb{E}(Y_{res}\mid A, L(0)) = \alpha_0 + \psi_A A + \beta_{L(0)} L(0)
\end{equation}

The controlled direct effect \(\text{CDE}_m\) can then be estimated by:
\begin{equation}
\hat{\Psi}^{\text{CDE}_m}_{\text{seq.g.est}} = \hat{\psi}_A + \hat{\psi}_{A \ast M} \times m
\end{equation}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# 1) Regress the outcome on past}
\NormalTok{Y.qol.model }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Y\_qol }\SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+}\NormalTok{ L1 }\SpecialCharTok{+}
\NormalTok{                     M\_diabetes }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5}\SpecialCharTok{:}\NormalTok{M\_diabetes,}
                   \AttributeTok{family =} \StringTok{"gaussian"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df2\_int)}

\DocumentationTok{\#\# 2) Calculate a residual outcome Y {-} (coef.M * M\_diabetes) {-} (coef.A0:M * A0:M)}
\NormalTok{Y.res }\OtherTok{\textless{}{-}}\NormalTok{ (df2\_int}\SpecialCharTok{$}\NormalTok{Y\_qol }\SpecialCharTok{{-}}
\NormalTok{            (Y.qol.model}\SpecialCharTok{$}\NormalTok{coefficients[}\StringTok{"M\_diabetes"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ df2\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes) }\SpecialCharTok{{-}}
\NormalTok{            (Y.qol.model}\SpecialCharTok{$}\NormalTok{coefficients[}\StringTok{"A0\_PM2.5:M\_diabetes"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \SpecialCharTok{*}
\NormalTok{               df2\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes) )}

\DocumentationTok{\#\# 3) Regress the residual outcome on the exposure A and baseline confounders L(0)}
\NormalTok{Y.res.model }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Y.res }\SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5}\NormalTok{,}
                   \AttributeTok{family =} \StringTok{"gaussian"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df2\_int)}

\DocumentationTok{\#\# 4) Use coefficients estimated from the 1st and 2nd regression to estimate CDE:}
\NormalTok{CDE.qol.m0.seq }\OtherTok{\textless{}{-}}\NormalTok{ (Y.res.model}\SpecialCharTok{$}\NormalTok{coefficients[}\StringTok{"A0\_PM2.5"}\NormalTok{] }\SpecialCharTok{+} 
                     \DecValTok{0} \SpecialCharTok{*}\NormalTok{ Y.qol.model}\SpecialCharTok{$}\NormalTok{coefficients[}\StringTok{"A0\_PM2.5:M\_diabetes"}\NormalTok{])}
\NormalTok{CDE.qol.m0.seq}
\CommentTok{\# {-}4.869509}

\NormalTok{CDE.qol.m1.seq }\OtherTok{\textless{}{-}}\NormalTok{ (Y.res.model}\SpecialCharTok{$}\NormalTok{coefficients[}\StringTok{"A0\_PM2.5"}\NormalTok{] }\SpecialCharTok{+} 
                     \DecValTok{1} \SpecialCharTok{*}\NormalTok{ Y.qol.model}\SpecialCharTok{$}\NormalTok{coefficients[}\StringTok{"A0\_PM2.5:M\_diabetes"}\NormalTok{])}
\NormalTok{CDE.qol.m1.seq}
\CommentTok{\# {-}10.38144}
\end{Highlighting}
\end{Shaded}

\section{Estimation of Natural Direct (NDE) and Indirect Effects (NIE)}\label{estimation-of-natural-direct-nde-and-indirect-effects-nie}

When Natural Direct Effects and Natural Indirect Effects are identifiable (i.e.~making the assumption that the confounder \(L(1)\) of the \(M-Y\) relationship is NOT affected by the exposure \(A\) as in Causal model 1, in Figure \ref{fig:figDAGM1}), estimations are based on traditional regression models as described in chapter \ref{ChapTradRegModels}.

The g-formulas for the PNDE and TNIE are:
\begin{align*}
  \Psi^\text{PNDE} &= \sum_{l(0),l(1)} \sum_m \left[ \mathbb{E}\left(Y \mid A=1,m,l(0),l(1)\right) - \left(Y \mid A=0,m,l(0),l(1)\right) \right] \\
  & \qquad \qquad \quad \times \mathbb{P}\left(M=m \mid A=0,l(0),l(1)\right) \times \mathbb{P}(l(0),l(1)) \\
  \Psi^\text{TNIE} &= \sum_{l(0),l(1)} \sum_m \mathbb{E}\left(Y \mid A=1,m,l(0),l(1)\right) \\
  & \qquad \qquad \quad \times \left[ \mathbb{P}\left(M=m \mid A=1,l(0),l(1)\right) - \mathbb{P}\left(M=m \mid A=0,l(0),l(1)\right) \right] \\
  & \qquad \qquad \quad \times \mathbb{P}(l(0),l(1))
\end{align*}

\subsection{Simple ``plug-in'' estimator}\label{simple-plug-in-estimator}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# For the example, we will use the df1\_int.csv data set (with an A*M interaction}
\DocumentationTok{\#\# effect on the outcome, but no intermediate confounder affected by the exposure)}
\FunctionTok{rm}\NormalTok{(}\AttributeTok{list=}\FunctionTok{ls}\NormalTok{())}
\NormalTok{df1\_int }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file =} \StringTok{"./data/df1\_int.csv"}\NormalTok{)}

\DocumentationTok{\#\# 1) Regress a model of the mediator and models of the outcomes (for binary and}
\DocumentationTok{\#\#    continuous outcomes)}
\CommentTok{\# Estimate a model of the mediator (logistic regression)}
\NormalTok{trad\_m }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(M\_diabetes }\SpecialCharTok{\textasciitilde{}}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ L1, }
              \AttributeTok{family =} \StringTok{"binomial"}\NormalTok{,}
              \AttributeTok{data =}\NormalTok{ df1\_int)}

\CommentTok{\# Estimate models of the outcome (for continuous and binary outcomes)}
\NormalTok{trad\_qol\_am }\OtherTok{\textless{}{-}} \FunctionTok{lm}\NormalTok{(Y\_qol }\SpecialCharTok{\textasciitilde{}}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+}\NormalTok{ M\_diabetes }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5}\SpecialCharTok{:}\NormalTok{M\_diabetes }\SpecialCharTok{+}
\NormalTok{                    L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ L1,}
                  \AttributeTok{data =}\NormalTok{ df1\_int)}
\NormalTok{trad\_death\_am }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Y\_death }\SpecialCharTok{\textasciitilde{}}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+}\NormalTok{ M\_diabetes }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5}\SpecialCharTok{:}\NormalTok{M\_diabetes }\SpecialCharTok{+}
\NormalTok{                       L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ L1,}
                     \AttributeTok{family =} \StringTok{"binomial"}\NormalTok{,}
                     \AttributeTok{data =}\NormalTok{ df1\_int)}

\DocumentationTok{\#\# 2) Generate predicted values for every combination of A=\{0,1\} and M=\{0,1\}}
\DocumentationTok{\#\# 2.a) Predict counterfactual probabilities of the mediator}
\NormalTok{data.Ais0 }\OtherTok{\textless{}{-}}\NormalTok{ data.Ais1 }\OtherTok{\textless{}{-}}\NormalTok{ df1\_int}
\NormalTok{data.Ais0}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \OtherTok{\textless{}{-}} \DecValTok{0}
\NormalTok{data.Ais1}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \OtherTok{\textless{}{-}} \DecValTok{1}

\CommentTok{\# Predict the counterfactual probabilities}
\CommentTok{\# P(M\_\{A=0\}|l(0),l(1)) and  P(M\_\{A=0\}|l(0),l(1))}
\NormalTok{P.M.Ais0 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(trad\_m, }\AttributeTok{newdata =}\NormalTok{ data.Ais0, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}
\NormalTok{P.M.Ais1 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(trad\_m, }\AttributeTok{newdata =}\NormalTok{ data.Ais1, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}

\DocumentationTok{\#\# 2.b) Predict counterfactual expected values of the outcomes}
\NormalTok{data.Ais0.Mis0 }\OtherTok{\textless{}{-}}\NormalTok{ data.Ais0.Mis1 }\OtherTok{\textless{}{-}}\NormalTok{ df1\_int}
\NormalTok{data.Ais1.Mis0 }\OtherTok{\textless{}{-}}\NormalTok{ data.Ais1.Mis1 }\OtherTok{\textless{}{-}}\NormalTok{ df1\_int}

\NormalTok{data.Ais0.Mis0}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \OtherTok{\textless{}{-}} \DecValTok{0}
\NormalTok{data.Ais0.Mis0}\SpecialCharTok{$}\NormalTok{M\_diabetes }\OtherTok{\textless{}{-}} \DecValTok{0}

\NormalTok{data.Ais0.Mis1}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \OtherTok{\textless{}{-}} \DecValTok{0}
\NormalTok{data.Ais0.Mis1}\SpecialCharTok{$}\NormalTok{M\_diabetes }\OtherTok{\textless{}{-}} \DecValTok{1}

\NormalTok{data.Ais1.Mis0}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \OtherTok{\textless{}{-}} \DecValTok{1}
\NormalTok{data.Ais1.Mis0}\SpecialCharTok{$}\NormalTok{M\_diabetes }\OtherTok{\textless{}{-}} \DecValTok{0}

\NormalTok{data.Ais1.Mis1}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \OtherTok{\textless{}{-}} \DecValTok{1}
\NormalTok{data.Ais1.Mis1}\SpecialCharTok{$}\NormalTok{M\_diabetes }\OtherTok{\textless{}{-}} \DecValTok{1}

\CommentTok{\# Predict E(Y\_\{am\} | l(0),l(1))}
\NormalTok{Q.death.A0M0 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(trad\_death\_am, }\AttributeTok{newdata =}\NormalTok{ data.Ais0.Mis0, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)}
\NormalTok{Q.death.A0M1 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(trad\_death\_am, }\AttributeTok{newdata =}\NormalTok{ data.Ais0.Mis1, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)}
\NormalTok{Q.death.A1M0 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(trad\_death\_am, }\AttributeTok{newdata =}\NormalTok{ data.Ais1.Mis0, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)}
\NormalTok{Q.death.A1M1 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(trad\_death\_am, }\AttributeTok{newdata =}\NormalTok{ data.Ais1.Mis1, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)}

\NormalTok{Q.qol.A0M0 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(trad\_qol\_am, }\AttributeTok{newdata =}\NormalTok{ data.Ais0.Mis0, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)}
\NormalTok{Q.qol.A0M1 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(trad\_qol\_am, }\AttributeTok{newdata =}\NormalTok{ data.Ais0.Mis1, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)}
\NormalTok{Q.qol.A1M0 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(trad\_qol\_am, }\AttributeTok{newdata =}\NormalTok{ data.Ais1.Mis0, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)}
\NormalTok{Q.qol.A1M1 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(trad\_qol\_am, }\AttributeTok{newdata =}\NormalTok{ data.Ais1.Mis1, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)}


\DocumentationTok{\#\# 3) Plug{-}in the predicted values in the g{-}formulas }
\DocumentationTok{\#\#    and estimate the population means}
\NormalTok{PNDE.death.gcomp }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{((Q.death.A1M0 }\SpecialCharTok{{-}}\NormalTok{ Q.death.A0M0) }\SpecialCharTok{*}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ P.M.Ais0) }\SpecialCharTok{+}
\NormalTok{                           (Q.death.A1M1 }\SpecialCharTok{{-}}\NormalTok{ Q.death.A0M1) }\SpecialCharTok{*}\NormalTok{ P.M.Ais0)}
\CommentTok{\# [1] 0.0638596}
\NormalTok{TNIE.death.gcomp }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(Q.death.A1M0 }\SpecialCharTok{*}\NormalTok{ ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ P.M.Ais1) }\SpecialCharTok{{-}}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ P.M.Ais0)) }\SpecialCharTok{+}
\NormalTok{                           Q.death.A1M1 }\SpecialCharTok{*}\NormalTok{ (P.M.Ais1 }\SpecialCharTok{{-}}\NormalTok{ P.M.Ais0) )}
\CommentTok{\# [1] 0.01044539}

\NormalTok{PNDE.qol.gcomp }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{((Q.qol.A1M0 }\SpecialCharTok{{-}}\NormalTok{ Q.qol.A0M0) }\SpecialCharTok{*}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ P.M.Ais0) }\SpecialCharTok{+}
\NormalTok{                           (Q.qol.A1M1 }\SpecialCharTok{{-}}\NormalTok{ Q.qol.A0M1) }\SpecialCharTok{*}\NormalTok{ P.M.Ais0)}
\CommentTok{\# [1] {-}5.310172}
\NormalTok{TNIE.qol.gcomp }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(Q.qol.A1M0 }\SpecialCharTok{*}\NormalTok{ ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ P.M.Ais1) }\SpecialCharTok{{-}}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ P.M.Ais0)) }\SpecialCharTok{+}
\NormalTok{                         Q.qol.A1M1 }\SpecialCharTok{*}\NormalTok{ (P.M.Ais1 }\SpecialCharTok{{-}}\NormalTok{ P.M.Ais0) )}
\CommentTok{\# [1] {-}1.774295}
\end{Highlighting}
\end{Shaded}

\subsection{\texorpdfstring{Using the \texttt{mediation} R package}{Using the mediation R package}}\label{using-the-mediation-r-package}

The \href{https://cran.r-project.org/web/packages/mediation/index.html}{\texttt{mediation}} R package can be used to estimate Natural Direct and Indirect Effects for causal models where the intermediate confounders are not affected by the exposure (as in Figure \ref{fig:figDAGM1}).

The estimation relies on the model of the mediator and the model of the outcome. Then a quasi-bayesian Monte Carlo method is applied, simulating counterfactual distributions of the mediator. The approach is rather similar to the parametric g-computation to estimate ``Marginal'' Randomized/Interventional Direct and Indirect Effects, described in the next paragraph.

Note that the \texttt{mediation} package can also be used for multilevel data.

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# Using the "mediation" package : R Package for Causal Mediation Analysis}
\FunctionTok{library}\NormalTok{(mediation)}
\NormalTok{?mediation}\SpecialCharTok{::}\NormalTok{mediate}

\DocumentationTok{\#\# We will use the previous model of the mediator (logistic regression)}
\NormalTok{trad\_m}
\CommentTok{\# Call:  glm(formula = M\_diabetes \textasciitilde{} A0\_PM2.5 + L0\_male + L0\_soc\_env +}
\CommentTok{\#              L1, family = "binomial", data = df1\_int)}
\CommentTok{\# Coefficients:}
\CommentTok{\#   (Intercept)     A0\_PM2.5      L0\_male   L0\_soc\_env           L1}
\CommentTok{\#       {-}1.3788       0.5626       0.2586       0.3305       0.3346}

\DocumentationTok{\#\# We will use the previous models of the outcomes (continuous and binary outcomes)}
\NormalTok{trad\_qol\_am}
\CommentTok{\# Call:}
\CommentTok{\#   lm(formula = Y\_qol \textasciitilde{} A0\_PM2.5 + M\_diabetes + A0\_PM2.5:M\_diabetes +}
\CommentTok{\#        L0\_male + L0\_soc\_env + L1, data = df1\_int)}
\CommentTok{\# Coefficients:}
\CommentTok{\# (Intercept) A0\_PM2.5  M\_diabetes  L0\_male L0\_soc\_env       L1  A0\_PM2.5:M\_diabetes}
\CommentTok{\#    74.7669   {-}3.7153     {-}8.6317  {-}0.7235    {-}2.8899  {-}3.4280              {-}5.6154}

\NormalTok{trad\_death\_am}
\CommentTok{\# Call:  glm(formula = Y\_death \textasciitilde{} A0\_PM2.5 + M\_diabetes + A0\_PM2.5:M\_diabetes +}
\CommentTok{\#              L0\_male + L0\_soc\_env + L1, family = "binomial", data = df1\_int)}
\CommentTok{\# Coefficients:}
\CommentTok{\# (Intercept) A0\_PM2.5  M\_diabetes  L0\_male L0\_soc\_env       L1  A0\_PM2.5:M\_diabetes}
\CommentTok{\#    {-}2.06294  0.36668     0.40921  0.29249    0.36360  0.44716              0.01275}

\DocumentationTok{\#\# Use the mediate() function to estimate the TNDE, PNIE}
\DocumentationTok{\#\# Estimations relies on quasi{-}bayesian Monte Carlo method (especially for continuous}
\DocumentationTok{\#\# mediators) =\textgreater{} set seed for reproducibility}
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{2024}\NormalTok{)}

\DocumentationTok{\#\# For the quantitative outcome}
\NormalTok{mediation.res.qol }\OtherTok{\textless{}{-}} \FunctionTok{mediate}\NormalTok{(trad\_m,                   }\CommentTok{\# model of the mediator}
\NormalTok{                             trad\_qol\_am,              }\CommentTok{\# model of the outcome}
                             \AttributeTok{treat =} \StringTok{"A0\_PM2.5"}\NormalTok{,       }\CommentTok{\# exposure}
                             \AttributeTok{mediator =} \StringTok{"M\_diabetes"}\NormalTok{,  }\CommentTok{\# mediator}
                             \AttributeTok{robustSE =} \ConstantTok{TRUE}\NormalTok{,          }\CommentTok{\# estimate sandwich SEs}
                             \AttributeTok{sims =} \DecValTok{100}\NormalTok{)               }\CommentTok{\# better to use \textgreater{}= 1000}
\FunctionTok{summary}\NormalTok{(mediation.res.qol)}
\CommentTok{\#                            Estimate 95\% CI Lower 95\% CI Upper p{-}value}
\CommentTok{\#   ACME (control)             {-}1.074       {-}1.356        {-}0.82  \textless{}2e{-}16 *** PNIE}
\CommentTok{\#   ACME (treated)             {-}1.778       {-}2.239        {-}1.38  \textless{}2e{-}16 *** TNIE}
\CommentTok{\#   ADE (control)              {-}5.301       {-}5.950        {-}4.63  \textless{}2e{-}16 *** PNDE}
\CommentTok{\#   ADE (treated)              {-}6.005       {-}6.646        {-}5.27  \textless{}2e{-}16 *** TNDE}
\CommentTok{\#   Total Effect               {-}7.079       {-}7.768        {-}6.24  \textless{}2e{-}16 ***}
\CommentTok{\#   Prop. Mediated (control)    0.151        0.118         0.19  \textless{}2e{-}16 ***}
\CommentTok{\#   Prop. Mediated (treated)    0.251        0.197         0.31  \textless{}2e{-}16 ***}
\CommentTok{\#   ACME (average)             {-}1.426       {-}1.811        {-}1.11  \textless{}2e{-}16 ***}
\CommentTok{\#   ADE (average)              {-}5.653       {-}6.267        {-}4.95  \textless{}2e{-}16 ***}
\CommentTok{\#   Prop. Mediated (average)    0.201        0.160         0.25  \textless{}2e{-}16 ***}
\end{Highlighting}
\end{Shaded}

In the output,

\begin{itemize}
\tightlist
\item
  \texttt{ACME\ (control)} (Average Causal Mediated Effect) corresponds to the Pure Natural Indirect Effect,
\item
  \texttt{ACME\ (treated)} corresponds to the Total Natural Indirect Effect,
\item
  \texttt{ADE\ (control)} (Average Direct Effect) corresponds to the Pure Natural Direct Effect,
\item
  \texttt{ADE\ (treated)} corresponds to the Total Natural Direct Effect,
\end{itemize}

So the sum of ACME (control) + ADE (treated) is equal to the total effect. Similarly, the sum of ACME (treated) + ADE (control) is equal to the total effect.

We can plot the results. For example the results for the decomposition of the effect of exposure to high-levels of \(\text{PM}_{2.5}\) on quality of life, through type-2 diabetes is described in the Figure

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# Plot the estimations}
\FunctionTok{plot}\NormalTok{(mediation.res.qol)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.8\linewidth]{./figures/mediation_package_res} 

}

\caption{Plot of the 2-way decomposition (mediation package)}\label{fig:FigmediationPackage}
\end{figure}

For the binary outcome:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mediation.res.death }\OtherTok{\textless{}{-}} \FunctionTok{mediate}\NormalTok{(trad\_m,                   }\CommentTok{\# model of the mediator}
\NormalTok{                               trad\_death\_am,            }\CommentTok{\# model of the outcome)}
                               \AttributeTok{treat =} \StringTok{"A0\_PM2.5"}\NormalTok{,       }\CommentTok{\# exposure}
                               \AttributeTok{mediator =} \StringTok{"M\_diabetes"}\NormalTok{,  }\CommentTok{\# mediator}
                               \AttributeTok{robustSE =} \ConstantTok{TRUE}\NormalTok{,          }\CommentTok{\# estimate sandwich SEs}
                               \AttributeTok{sims =} \DecValTok{100}\NormalTok{)               }\CommentTok{\# better to use \textgreater{}= 1000}
\FunctionTok{summary}\NormalTok{(mediation.res.death)}
\CommentTok{\#                          Estimate 95\% CI Lower 95\% CI Upper p{-}value}
\CommentTok{\# ACME (control)            0.00860      0.00569         0.01  \textless{}2e{-}16 *** PNIE}
\CommentTok{\# ACME (treated)            0.00979      0.00377         0.02  \textless{}2e{-}16 *** TNIE}
\CommentTok{\# ADE (control)             0.06543      0.03658         0.09  \textless{}2e{-}16 *** PNDE}
\CommentTok{\# ADE (treated)             0.06662      0.03946         0.09  \textless{}2e{-}16 *** TNDE}
\CommentTok{\# Total Effect              0.07522      0.04800         0.10  \textless{}2e{-}16 ***}
\CommentTok{\# Prop. Mediated (control)  0.11172      0.07323         0.18  \textless{}2e{-}16 ***}
\CommentTok{\# Prop. Mediated (treated)  0.13066      0.05714         0.22  \textless{}2e{-}16 ***}
\CommentTok{\# ACME (average)            0.00920      0.00567         0.01  \textless{}2e{-}16 ***}
\CommentTok{\# ADE (average)             0.06603      0.03803         0.09  \textless{}2e{-}16 ***}
\CommentTok{\# Prop. Mediated (average)  0.12119      0.07330         0.20  \textless{}2e{-}16 ***}
\end{Highlighting}
\end{Shaded}

Interestingly, the \texttt{mediation} package enable to carry-out a sensitivity analysis to test if unmeasured confounders of the mediator-outcome relationship could offset the estimated direct or indirect effects. This sensitivity analysis relies on assumptions on the mediator-outcome correlation coefficient. I.e., it can be used to test for unmeasured variables within the \(L(1)\) set in the causal structure of Figure \ref{fig:figDAGM1}.

If there exist unobserved (baseline) confounders of the M-Y relationship, we expect that \(\rho\) is no longer zero. The sensitivity analysis is conducted by varying the value of \(\rho\) and examining how the estimated ACME and ADE change.

Note 1: this sensitivity analysis cannot be used to test the assumption that no intermediate confounder \(L(1)\) of the mediator-outcome relationship is affected by the exposure (like in Figure \ref{fig:figDAGM2}).

Note 2: Sensitivity analysis from the \texttt{mediation} package cannot be applied when the mediator and the outcome are both binary. We will only use it for the ``Quality of Life'' outcome.

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# Sensitivity analysis to test sequential ignorability (assess the possible }
\DocumentationTok{\#\# existence of unobserved (baseline) confounders of the M{-}Y relationship)}

\DocumentationTok{\#\# Estimate a probit model of the mediator}
\NormalTok{trad\_m }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(M\_diabetes }\SpecialCharTok{\textasciitilde{}}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ L1,}
              \AttributeTok{family =} \FunctionTok{binomial}\NormalTok{(}\StringTok{"probit"}\NormalTok{), }\CommentTok{\# sensitivity analysis works only for}
                                           \CommentTok{\# probit models if M is binary}
              \AttributeTok{data =}\NormalTok{ df1\_int)}
\NormalTok{mediation.res.qol }\OtherTok{\textless{}{-}} \FunctionTok{mediate}\NormalTok{(trad\_m,                   }\CommentTok{\# model of the mediator}
\NormalTok{                             trad\_qol\_am,              }\CommentTok{\# model of the outcome)}
                             \AttributeTok{treat =} \StringTok{"A0\_PM2.5"}\NormalTok{,       }\CommentTok{\# exposure}
                             \AttributeTok{mediator =} \StringTok{"M\_diabetes"}\NormalTok{,  }\CommentTok{\# mediator}
                             \AttributeTok{robustSE =} \ConstantTok{TRUE}\NormalTok{,          }\CommentTok{\# estimate sandwich SEs}
                             \AttributeTok{sims =} \DecValTok{100}\NormalTok{)               }\CommentTok{\# better to use \textgreater{}= 1000}
\FunctionTok{summary}\NormalTok{(mediation.res.qol)}
\CommentTok{\#                            Estimate 95\% CI Lower 95\% CI Upper p{-}value}
\CommentTok{\#   ACME (control)             {-}1.071       {-}1.416        {-}0.79  \textless{}2e{-}16 ***}
\CommentTok{\#   ACME (treated)             {-}1.784       {-}2.333        {-}1.31  \textless{}2e{-}16 ***}
\CommentTok{\#   ADE (control)              {-}5.266       {-}5.809        {-}4.56  \textless{}2e{-}16 ***}
\CommentTok{\#   ADE (treated)              {-}5.979       {-}6.515        {-}5.31  \textless{}2e{-}16 ***}
\CommentTok{\#   Total Effect               {-}7.050       {-}7.754        {-}6.34  \textless{}2e{-}16 ***}
\CommentTok{\#   Prop. Mediated (control)    0.151        0.119         0.19  \textless{}2e{-}16 ***}
\CommentTok{\#   Prop. Mediated (treated)    0.254        0.194         0.32  \textless{}2e{-}16 ***}
\CommentTok{\#   ACME (average)             {-}1.427       {-}1.889        {-}1.06  \textless{}2e{-}16 ***}
\CommentTok{\#   ADE (average)              {-}5.623       {-}6.152        {-}4.97  \textless{}2e{-}16 ***}
\CommentTok{\#   Prop. Mediated (average)    0.203        0.159         0.26  \textless{}2e{-}16 ***}

\NormalTok{sensisitivy }\OtherTok{\textless{}{-}} \FunctionTok{medsens}\NormalTok{(mediation.res.qol,}
                       \AttributeTok{rho.by =} \FloatTok{0.1}\NormalTok{, }\CommentTok{\# sensitivity parameter = correlation between}
                       \CommentTok{\# the residuals of the mediator \& outcome regressions}
                       \CommentTok{\# here, rho varies from {-}0.9 to +0.9 by 0.1 increments}
                       \AttributeTok{effect.type =} \StringTok{"both"}\NormalTok{, }\CommentTok{\# "direct", "indirect" or "both"}
                       \AttributeTok{sims =} \DecValTok{100}\NormalTok{)}
\FunctionTok{summary}\NormalTok{(sensisitivy)}
\CommentTok{\# Mediation Sensitivity Analysis: Average Mediation Effect}
\CommentTok{\#   Sensitivity Region: ACME for Control Group}
\CommentTok{\#         Rho ACME(control) 95\% CI Lower 95\% CI Upper R\^{}2\_M*R\^{}2\_Y* R\^{}2\_M\textasciitilde{}R\^{}2\_Y\textasciitilde{}}
\CommentTok{\#   [1,] {-}0.6        0.0474      {-}0.0093       0.1229         0.36       0.2647}
\CommentTok{\#}
\CommentTok{\# Rho at which ACME for Control Group = 0: {-}0.6}
\CommentTok{\# R\^{}2\_M*R\^{}2\_Y* at which ACME for Control Group = 0: 0.36}
\CommentTok{\# R\^{}2\_M\textasciitilde{}R\^{}2\_Y\textasciitilde{} at which ACME for Control Group = 0: 0.2647}
\CommentTok{\#}
\CommentTok{\# Rho at which ACME for Treatment Group = 0: {-}0.9}
\CommentTok{\# R\^{}2\_M*R\^{}2\_Y* at which ACME for Treatment Group = 0: 0.81}
\CommentTok{\# R\^{}2\_M\textasciitilde{}R\^{}2\_Y\textasciitilde{} at which ACME for Treatment Group = 0: 0.5956}
\CommentTok{\#}
\CommentTok{\#   Mediation Sensitivity Analysis: Average Direct Effect}
\CommentTok{\# Rho at which ADE for Control Group = 0: 0.8}
\CommentTok{\# R\^{}2\_M*R\^{}2\_Y* at which ADE for Control Group = 0: 0.64}
\CommentTok{\# R\^{}2\_M\textasciitilde{}R\^{}2\_Y\textasciitilde{} at which ADE for Control Group = 0: 0.4706}
\CommentTok{\#}
\CommentTok{\# Rho at which ADE for Treatment Group = 0: 0.8}
\CommentTok{\# R\^{}2\_M*R\^{}2\_Y* at which ADE for Treatment Group = 0: 0.64}
\CommentTok{\# R\^{}2\_M\textasciitilde{}R\^{}2\_Y\textasciitilde{} at which ADE for Treatment Group = 0: 0.4706}

\FunctionTok{par}\NormalTok{(}\AttributeTok{mfrow =} \FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{,}\DecValTok{2}\NormalTok{))}
\FunctionTok{plot}\NormalTok{(sensisitivy)}
\FunctionTok{par}\NormalTok{(}\AttributeTok{mfrow =} \FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{,}\DecValTok{1}\NormalTok{))}

\FunctionTok{par}\NormalTok{(}\AttributeTok{mfrow =} \FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{,}\DecValTok{2}\NormalTok{))}
\FunctionTok{plot}\NormalTok{(sensisitivy)}
\FunctionTok{par}\NormalTok{(}\AttributeTok{mfrow =} \FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{,}\DecValTok{1}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{figure}

{\centering \includegraphics[width=0.8\linewidth]{./figures/sensitivity_analysis} 

}

\caption{Sensitivity analysis testing unmeasured confounding of the M-Y relationship}\label{fig:Figmedsens}
\end{figure}

Here, for the Pure Natural Indirect Effect:

\begin{itemize}
\tightlist
\item
  the confidence interval of the ACME (PNIE) contains zero when \(\rho=-0.6\);
\item
  when the product of the residual variance explained by the omitted confounding is 0.36, the point estimate of PNIE = 0;
\item
  when the product of the total variance explained by the omitted confounding is 0.27, the point estimate of PNIE = 0;
\end{itemize}

For the TNDE and PNDE,

\begin{itemize}
\tightlist
\item
  the confidence interval of the ADE (TNDE and PNDE) containt zero when \(\rho > +0.8\);
\item
  when the product of the residual variance explained by the omitted confounding is 0.64, the point estimate of TNDE = 0;
\item
  when the product of the total variance explained by the omitted confounding is 0.47, the point estimate of TNDE = 0;
\end{itemize}

We can conclude that the possibility of the PNIE and the TNIE cancelling out because of unmeasured M-Y confounding is unlikely in our example (it requires rather strong correlations).

\section{Estimation of ``Marginal'' Randomized/Interventional Natural Direct (MRDE) and Indirect Effects (MRIE)}\label{estimation-of-marginal-randomizedinterventional-natural-direct-mrde-and-indirect-effects-mrie}

When we assume that the intermediate confounder \(L(1)\) of the \(M-Y\) relationship is affected by the exposure \(A\) (Causal model 2, Figure \ref{fig:figDAGM2}), an ``interventional analogue'' of the Average Total Effect decomposition into a Natural Direct and Indirect Effect has been suggested.(\citeproc{ref-vanderweele2016}{VanderWeele and Tchetgen Tchetgen 2017}) (\citeproc{ref-lin2017}{Lin et al. 2017}) For these effects, counterfactual scenarios are defined by setting different values for the exposure (\(A = 0\) or \(A=1\)) and random draw in the distribution \(G_{A=a^\prime \mid L(0)}\) of the mediator (conditional on baseline counfounders \(L(0)\)) under the counterfactual scenario setting \(A=a^\prime\).

An Overall (Total) Effect can be defined by the contrast \(\text{OE} = \mathbb{E}\left[Y_{A=1,G_{A=1\mid L(0)}} \right] - \mathbb{E}\left[ Y_{A=0,G_{A=0\mid L(0)}} \right]\).

This Overall Effect can be decomposed into the sum of:

\begin{itemize}
\tightlist
\item
  a Marginal Randomised (or Interventional) Direct Effect: \(\text{MRDE}=\mathbb{E}\left[Y_{A=1,G_{A=0\mid L(0)}} \right] - \mathbb{E}\left[ Y_{A=0,G_{A=0\mid L(0)}} \right]\)
\item
  a Marginal Randomised (or Interventional) Indirect Effect: \(\text{MRIE}=\mathbb{E}\left[Y_{A=1,G_{A=1\mid L(0)}} \right] - \mathbb{E}\left[ Y_{A=1,G_{A=0\mid L(0)}} \right]\)
\end{itemize}

For this 2-way decomposition, we have to estimate 3 causal quantities: \(\mathbb{E}\left[Y_{A=1,G_{A=1\mid L(0)}} \right]\), \(\mathbb{E}\left[ Y_{A=0,G_{A=0\mid L(0)}} \right]\) and \(\mathbb{E}\left[ Y_{A=1,G_{A=0\mid L(0)}} \right]\).

Under the identifiability conditions, in particular:

\begin{itemize}
\tightlist
\item
  no unmeasured exposure-outcome confounding
\item
  no unmeasured mediator-outcome confounding
\item
  and exposure-mediator confounding
\end{itemize}

the quantity of \(\mathbb{E}\left[Y_{a,G_{a^\prime\mid L(0)}} \right]\) can be estimated by the g-formula:
\begin{multline*}
\mathbb{E}\left[Y_{a,G_{a^\prime\mid L(0)}} \right]=\sum_{l(0),l(1),m} \mathbb{E}\left(Y \mid m,l(1),A=a,l(0),\right) \times P[L(1)=l(1) \mid a,l(0)] \\
  \times P[M=m \mid a^\prime, l(0)] \times P(L(0)=l(0))
\end{multline*}
These causal effects can be estimated by g-computation, IPTW, or TMLE. G-computation approaches are described below.

\subsection{Parametric g-computation}\label{parametric-g-computation}

The estimation using parametric g-computation is described in (\citeproc{ref-lin2017}{Lin et al. 2017}). The approach is described as an adaptation of the parametric g-computation presented for controlled direct effects, in order to estimate causal quantities \(\mathbb{E}(Y_{a,G_{a^\prime\mid L(0)}})\) corresponding to a counterfactual scenario where the exposures is set to \(A=a\) for all individuals and \(M\) is a random draw from the distribution \(G_{a^\prime \mid L(0)}\) of the mediator (conditional on \(L(0)\)) had the exposure been set to \(A=a^\prime\).

Estimation of \(\mathbb{E}(Y_{a,G_{a^\prime\mid L(0)}})\) relies on the following steps:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Fit parametric models for the time-varying confounders \(L(1)\), the mediator \(M\) and the outcome \(Y\) given the measured past;
\item
  Estimate the joint distribution of time-varying confounders (\(L(1)_{A=1}\) and \(L(1)_{A=0}\)) and of the mediator (\(M_{G_{A=0}}\) and \(M_{G_{A=1}}\)) under the counterfactual scenarios setting \(A = 1\) or \(A=0\);
\item
  Simulate the outcomes \(Y_{A=0,G_{A=0}}\), \(Y_{A=1,G_{A=1}}\) and \(Y_{A=1,G_{A=0}}\) in order to compute the randomized natural direct and indirect effects.
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{rm}\NormalTok{(}\AttributeTok{list=}\FunctionTok{ls}\NormalTok{())}
\NormalTok{df2\_int }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file =} \StringTok{"data/df2\_int.csv"}\NormalTok{)}

\FunctionTok{set.seed}\NormalTok{(}\DecValTok{54321}\NormalTok{)}

\CommentTok{\# steps 1) to 3) will be repeated some fixed number k (for example k = 25)}
\CommentTok{\# we will save the k results in a matrix of k rows and 4 columns for the randomized}
\CommentTok{\# direct and indirect effects on death (binary) and QoL (continuous) outcomes}
\NormalTok{est }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\ConstantTok{NA}\NormalTok{, }\AttributeTok{nrow =} \DecValTok{25}\NormalTok{, }\AttributeTok{ncol =} \DecValTok{4}\NormalTok{)}
\FunctionTok{colnames}\NormalTok{(est) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"rNDE.death"}\NormalTok{, }\StringTok{"rNIE.death"}\NormalTok{, }\StringTok{"rNDE.qol"}\NormalTok{, }\StringTok{"rNIE.qol"}\NormalTok{)}

\CommentTok{\# repeat k = 25 times the following steps 1) to 3)}
\ControlFlowTok{for}\NormalTok{ (k }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{25}\NormalTok{) \{}
  \DocumentationTok{\#\# 1) Fit parametric models for the time{-}varying confounders L(1), the mediator M}
  \DocumentationTok{\#\#    and the outcome Y}
  \DocumentationTok{\#\#\# 1a) fit parametric models of the confounders and mediators given the past}
\NormalTok{  L1.model }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(L1 }\SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5}\NormalTok{,}
                  \AttributeTok{family =} \StringTok{"binomial"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df2\_int)}
\NormalTok{  M.model }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(M\_diabetes }\SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+}\NormalTok{ L1,}
                 \AttributeTok{family =} \StringTok{"binomial"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df2\_int)}
  \DocumentationTok{\#\#\# 1b) fit parametric models of the outcomes given the past}
\NormalTok{  Y.death.model }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Y\_death }\SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+}\NormalTok{ L1 }\SpecialCharTok{+}
\NormalTok{                         M\_diabetes }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5}\SpecialCharTok{:}\NormalTok{M\_diabetes,}
                       \AttributeTok{family =} \StringTok{"binomial"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df2\_int)}
\NormalTok{  Y.qol.model }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Y\_qol }\SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+}\NormalTok{ L1 }\SpecialCharTok{+}
\NormalTok{                       M\_diabetes }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5}\SpecialCharTok{:}\NormalTok{M\_diabetes,}
                     \AttributeTok{family =} \StringTok{"gaussian"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df2\_int)}

  \DocumentationTok{\#\# 2) Estimate the joint distribution of time{-}varying confounders and of the}
  \DocumentationTok{\#\#    mediator under the counterfactual scenarios setting A0\_PM2.5 = 1 or 0}

  \CommentTok{\# set the exposure A0\_PM2.5 to 0 or 1 in two new counterfactual data sets}
\NormalTok{  data.A0  }\OtherTok{\textless{}{-}}\NormalTok{ data.A1 }\OtherTok{\textless{}{-}}\NormalTok{ df2\_int}
\NormalTok{  data.A0}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \OtherTok{\textless{}{-}} \DecValTok{0}
\NormalTok{  data.A1}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \OtherTok{\textless{}{-}} \DecValTok{1}
  \CommentTok{\# simulate L1 values under the counterfactual exposures A0\_PM2.5=0 or A0\_PM2.5=1}
\NormalTok{  p.L1.A0 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(L1.model, }\AttributeTok{newdata =}\NormalTok{ data.A0, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)}
\NormalTok{  p.L1.A1 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(L1.model, }\AttributeTok{newdata =}\NormalTok{ data.A1, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)}
\NormalTok{  sim.L1.A0 }\OtherTok{\textless{}{-}} \FunctionTok{rbinom}\NormalTok{(}\AttributeTok{n =} \FunctionTok{nrow}\NormalTok{(df2\_int), }\AttributeTok{size =} \DecValTok{1}\NormalTok{, }\AttributeTok{prob =}\NormalTok{ p.L1.A0)}
\NormalTok{  sim.L1.A1 }\OtherTok{\textless{}{-}} \FunctionTok{rbinom}\NormalTok{(}\AttributeTok{n =} \FunctionTok{nrow}\NormalTok{(df2\_int), }\AttributeTok{size =} \DecValTok{1}\NormalTok{, }\AttributeTok{prob =}\NormalTok{ p.L1.A1)}

  \CommentTok{\# replace L(1) by their counterfactual values in the data under A=0 or A=1}
\NormalTok{  data.A0.L }\OtherTok{\textless{}{-}}\NormalTok{ data.A0}
\NormalTok{  data.A1.L }\OtherTok{\textless{}{-}}\NormalTok{ data.A1}
\NormalTok{  data.A0.L}\SpecialCharTok{$}\NormalTok{L1 }\OtherTok{\textless{}{-}}\NormalTok{ sim.L1.A0}
\NormalTok{  data.A1.L}\SpecialCharTok{$}\NormalTok{L1 }\OtherTok{\textless{}{-}}\NormalTok{ sim.L1.A1}

  \CommentTok{\# simulate M values under the counterfactual exposures A0\_PM2.5=0 or A0\_PM2.5=1}
\NormalTok{  p.M.A0 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(M.model, }\AttributeTok{newdata =}\NormalTok{ data.A0.L, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)}
\NormalTok{  p.M.A1 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(M.model, }\AttributeTok{newdata =}\NormalTok{ data.A1.L, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)}
\NormalTok{  sim.M.A0 }\OtherTok{\textless{}{-}} \FunctionTok{rbinom}\NormalTok{(}\AttributeTok{n =} \FunctionTok{nrow}\NormalTok{(df2\_int), }\AttributeTok{size =} \DecValTok{1}\NormalTok{, }\AttributeTok{prob =}\NormalTok{ p.M.A0)}
\NormalTok{  sim.M.A1 }\OtherTok{\textless{}{-}} \FunctionTok{rbinom}\NormalTok{(}\AttributeTok{n =} \FunctionTok{nrow}\NormalTok{(df2\_int), }\AttributeTok{size =} \DecValTok{1}\NormalTok{, }\AttributeTok{prob =}\NormalTok{ p.M.A1)}
  \CommentTok{\# permute the n values of the joint mediator to obtain the random distributions}
  \CommentTok{\# of the mediator: G\_\{A=0\} and G\_\{A=1\}}
\NormalTok{  marg.M.A0 }\OtherTok{\textless{}{-}} \FunctionTok{sample}\NormalTok{(sim.M.A0, }\AttributeTok{replace =} \ConstantTok{FALSE}\NormalTok{)}
\NormalTok{  marg.M.A1 }\OtherTok{\textless{}{-}} \FunctionTok{sample}\NormalTok{(sim.M.A1, }\AttributeTok{replace =} \ConstantTok{FALSE}\NormalTok{)}

  \DocumentationTok{\#\# 3) Simulate the outcomes Y\_\{A=0,G\_\{A=0\}\}}
  \DocumentationTok{\#\#\# 3a) use the previous permutation to replace the mediator}
  \DocumentationTok{\#\#\# in the counterfactual data sets for Y\_\{A=0,G\_\{A=0\}\}, Y\_\{A=1,G\_\{A=1\}\} and}
  \DocumentationTok{\#\#\# Y\_\{A=1,G\_\{A=0\}\}}
\NormalTok{  data.A0.G0 }\OtherTok{\textless{}{-}}\NormalTok{ data.A0.G1 }\OtherTok{\textless{}{-}}\NormalTok{ data.A0.L}
\NormalTok{  data.A1.G0 }\OtherTok{\textless{}{-}}\NormalTok{ data.A1.G1 }\OtherTok{\textless{}{-}}\NormalTok{ data.A1.L}

\NormalTok{  data.A0.G0}\SpecialCharTok{$}\NormalTok{M\_diabetes }\OtherTok{\textless{}{-}}\NormalTok{ marg.M.A0}
  \CommentTok{\# data.A0.G1$M\_diabetes \textless{}{-} marg.M.A1 \# note: this data set will not be useful}

\NormalTok{  data.A1.G0}\SpecialCharTok{$}\NormalTok{M\_diabetes }\OtherTok{\textless{}{-}}\NormalTok{ marg.M.A0}
\NormalTok{  data.A1.G1}\SpecialCharTok{$}\NormalTok{M\_diabetes }\OtherTok{\textless{}{-}}\NormalTok{ marg.M.A1}

  \CommentTok{\# simulate the average outcome using the models fitted at step 1)}
\NormalTok{  p.death.A1.G1 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(Y.death.model, }\AttributeTok{newdata =}\NormalTok{ data.A1.G1, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)}
\NormalTok{  p.death.A1.G0 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(Y.death.model, }\AttributeTok{newdata =}\NormalTok{ data.A1.G0, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)}
\NormalTok{  p.death.A0.G0 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(Y.death.model, }\AttributeTok{newdata =}\NormalTok{ data.A0.G0, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)}

\NormalTok{  m.qol.A1.G1 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(Y.qol.model, }\AttributeTok{newdata =}\NormalTok{ data.A1.G1, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)}
\NormalTok{  m.qol.A1.G0 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(Y.qol.model, }\AttributeTok{newdata =}\NormalTok{ data.A1.G0, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)}
\NormalTok{  m.qol.A0.G0 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(Y.qol.model, }\AttributeTok{newdata =}\NormalTok{ data.A0.G0, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)}

  \DocumentationTok{\#\# save the results in row k}
  \CommentTok{\# rNDE = E(Y\_\{A=1,G\_\{A=0\}\}) {-} E(Y\_\{A=0,G\_\{A=0\}\})}
  \CommentTok{\# rNIE = E(Y\_\{A=1,G\_\{A=1\}\}) {-} E(Y\_\{A=1,G\_\{A=0\}\})}
\NormalTok{  est[k,}\StringTok{"rNDE.death"}\NormalTok{]}\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(p.death.A1.G0) }\SpecialCharTok{{-}} \FunctionTok{mean}\NormalTok{(p.death.A0.G0)}
\NormalTok{  est[k,}\StringTok{"rNIE.death"}\NormalTok{] }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(p.death.A1.G1) }\SpecialCharTok{{-}} \FunctionTok{mean}\NormalTok{(p.death.A1.G0)}

\NormalTok{  est[k,}\StringTok{"rNDE.qol"}\NormalTok{] }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(m.qol.A1.G0) }\SpecialCharTok{{-}} \FunctionTok{mean}\NormalTok{(m.qol.A0.G0)}
\NormalTok{  est[k,}\StringTok{"rNIE.qol"}\NormalTok{] }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(m.qol.A1.G1) }\SpecialCharTok{{-}} \FunctionTok{mean}\NormalTok{(m.qol.A1.G0)}
\NormalTok{\}}

\CommentTok{\# take empirical mean of final predicted outcomes}
\NormalTok{rNDE.death }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(est[,}\StringTok{"rNDE.death"}\NormalTok{])}
\NormalTok{rNDE.death}
\CommentTok{\# [1] 0.07118987}
\NormalTok{rNIE.death }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(est[,}\StringTok{"rNIE.death"}\NormalTok{])}
\NormalTok{rNIE.death}
\CommentTok{\# [1] 0.0110088}

\NormalTok{rNDE.qol }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(est[,}\StringTok{"rNDE.qol"}\NormalTok{])}
\NormalTok{rNDE.qol}
\CommentTok{\# [1] {-}6.649923}
\NormalTok{rNIE.qol }\OtherTok{\textless{}{-}}  \FunctionTok{mean}\NormalTok{(est[,}\StringTok{"rNIE.qol"}\NormalTok{])}
\NormalTok{rNIE.qol}
\CommentTok{\# [1] {-}1.585373}
\end{Highlighting}
\end{Shaded}

In this example,

\begin{itemize}
\tightlist
\item
  the marginal ``randomized'' Natural Direct and Indirect effect on death are a \(MRDE \approx +7.1\%\) and \(MRIE \approx +1.1\%\);
\item
  the marginal ``randomized'' Natural Direct and Indirect effect on quality of life are a \(MRDE \approx -6.6\) and \(MRIE \approx -1.6\);
\end{itemize}

95\% confidence intervals can be calculated by repeating the algorithm in \textgreater500 bootstrap samples of the original data set.

\subsection{G-computation by iterative conditional expectation}\label{g-computation-by-iterative-conditional-expectation}

We describe below the g-computation algorithm which is used in the \href{https://github.com/romainkp/stremr}{stremr package} (``Streamlined Causal Inference for Static, Dynamic and Stochastic Regimes in Longitudinal Data'').

Note that G-computation by iterative expectation is preferable if the set of intermediate confounders \(L(1)\) is high-dimensional as we only need to fit 1 model by counterfactual scenario in the procedure described below (whatever the dimensionaly of the set \(L(1)\)), whereas at least 1 model by \(L(1)\) variable and by counterfactual scenario are needed with parametric g-computation.

The following 4 steps are applied:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Fit a parametric model for the mediator conditional on \(A\) and \(L(0)\). This model will be used to predict the probabilities \(G_{A=0|L(0)}=P(M=1|A=0,L(0))\) and \(G_{A=1|L(0)}=P(M=1|A=1,L(0))\) under the counterfactual scenarios setting \(A=0\) and \(A=1\).
\item
  Fit parametric models for the outcome \(Y\) given the past and generate predicted values \(\bar{Q}_{L(2)}(M=0)\) and \(\bar{Q}_{L(2)}(M=1)\) by evaluating the regression setting the mediator value to \(M=0\) or to \(M=1\).
\end{enumerate}

Then calculate a weighted sum of the predicted \(\bar{Q}_{L(2)}(M)\), with weights given by \(G_{A=1|L(0)}\) or \(G_{A=0|L(0)}\):
\begin{align*}
  \bar{Q}_{L(2),G_{A=0 \mid L(0)}} &= \bar{Q}_{L(2)}(M=1) \times G_{A=0|L(0)} + \bar{Q}_{L(2)}(M=0) \times \left[1 - G_{A=0 \mid L(0)} \right] \\
  \bar{Q}_{L(2),G_{A=1 \mid L(0)}} &= \bar{Q}_{L(2)}(M=1) \times G_{A=1|L(0)} + \bar{Q}_{L(2)}(M=0) \times \left[1 - G_{A=1 \mid L(0)} \right]
\end{align*}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{2}
\item
  Fit parametric models for the predicted values \(\bar{Q}_{L(2),G_{A=a \mid L(0)}}\) conditional on the exposure \(A\) and baseline confounders \(L(0)\), and generate predicted values \(\bar{Q}_{L(1),G_{A=0 \mid L(0)}}(A=0)\), \(\bar{Q}_{L(1),G_{A=0 \mid L(0)}}(A=1)\) and \(\bar{Q}_{L(1),G_{A=1 \mid L(0)}}(A=1)\).
\item
  Estimate the marginal randomized natural direct and indirect effects, using the means of the \(\bar{Q}_{L(1),G_{A=a^\prime \mid L(0)}}(A=a)\) calculated at the previous step
\end{enumerate}

\begin{align*}
\text{MRDE}_\text{ICE.gcomp} &= \frac{1}{n} \sum_{i=1}^n \left[ \bar{Q}_{L(1),G_{A=0 \mid L(0)}}(A=1) \right] - \frac{1}{n} \sum_{i=1}^n \left[ \bar{Q}_{L(1),G_{A=0 \mid L(0)}}(A=0) \right] \\
\text{MRIE}_\text{ICE.gcomp} &= \frac{1}{n} \sum_{i=1}^n \left[ \bar{Q}_{L(1),G_{A=1 \mid L(0)}}(A=1) \right] - \frac{1}{n} \sum_{i=1}^n \left[ \bar{Q}_{L(1),G_{A=0 \mid L(0)}}(A=1) \right] \\
\end{align*}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{rm}\NormalTok{(}\AttributeTok{list=}\FunctionTok{ls}\NormalTok{())}
\NormalTok{df2\_int }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file =} \StringTok{"data/df2\_int.csv"}\NormalTok{)}

\DocumentationTok{\#\# 1) Fit a parametric model for the mediator conditional on A and L(0)}
\DocumentationTok{\#\#    and generate predicted values by evaluating the regression setting the exposure}
\DocumentationTok{\#\#    value to A=0 or A=1}
\DocumentationTok{\#\#\# 1a) Fit parametric models for the mediator M, conditional on the exposure A and}
\DocumentationTok{\#\#\#    baseline confounder Pr(M=1|A,L(0)) (but not conditional on L(1))}
\NormalTok{G.model }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(M\_diabetes }\SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5}\NormalTok{,}
               \AttributeTok{family =} \StringTok{"binomial"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df2\_int)}

\DocumentationTok{\#\#\# 1b) generate predicted probabilites by evaluating the regression setting the}
\DocumentationTok{\#\#\#     exposure value to A=0 or to A=1}
\CommentTok{\# create datasets corresponding to the counterfactual scenarios setting A=0 and A=1}
\NormalTok{data.Ais0  }\OtherTok{\textless{}{-}}\NormalTok{ data.Ais1 }\OtherTok{\textless{}{-}}\NormalTok{ df2\_int}
\NormalTok{data.Ais0}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \OtherTok{\textless{}{-}} \DecValTok{0}
\NormalTok{data.Ais1}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \OtherTok{\textless{}{-}} \DecValTok{1}

\CommentTok{\# estimate G\_\{A=0|L(0)\} = Pr(M=1|A=0,L(0)) and G\_\{A=1|L(0)\} = Pr(M=1|A=1,L(0))}
\NormalTok{G.Ais0.L0 }\OtherTok{\textless{}{-}}\FunctionTok{predict}\NormalTok{(G.model, }\AttributeTok{newdata =}\NormalTok{ data.Ais0, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)}
\NormalTok{G.Ais1.L0 }\OtherTok{\textless{}{-}}\FunctionTok{predict}\NormalTok{(G.model, }\AttributeTok{newdata =}\NormalTok{ data.Ais1, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)}

\DocumentationTok{\#\# 2) Fit parametric models for the observed data for the outcome Y given the past}
\DocumentationTok{\#\#    and generate predicted values by evaluating the regression setting the mediator}
\DocumentationTok{\#\#    value to M=0 or to M=1}
\DocumentationTok{\#\#    then calculate a weighted sum of the predicted Q.L2, with weights given by G}
\DocumentationTok{\#\#\# 2a) fit parametric models of the outcomes given the past}
\NormalTok{Y.death.model }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Y\_death }\SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+}\NormalTok{ L1 }\SpecialCharTok{+}
\NormalTok{                       M\_diabetes }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5}\SpecialCharTok{:}\NormalTok{M\_diabetes,}
                     \AttributeTok{family =} \StringTok{"binomial"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df2\_int)}
\NormalTok{Y.qol.model }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Y\_qol }\SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+}\NormalTok{ L1 }\SpecialCharTok{+}
\NormalTok{                     M\_diabetes }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5}\SpecialCharTok{:}\NormalTok{M\_diabetes,}
                   \AttributeTok{family =} \StringTok{"gaussian"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df2\_int)}

\DocumentationTok{\#\#\# 2b) generate predicted values by evaluating the regression setting the mediator}
\DocumentationTok{\#\#\#     value to M=0 or to M=1}
\NormalTok{data.Mis0  }\OtherTok{\textless{}{-}}\NormalTok{ data.Mis1 }\OtherTok{\textless{}{-}}\NormalTok{ df2\_int}
\NormalTok{data.Mis0}\SpecialCharTok{$}\NormalTok{M\_diabetes }\OtherTok{\textless{}{-}} \DecValTok{0}
\NormalTok{data.Mis1}\SpecialCharTok{$}\NormalTok{M\_diabetes }\OtherTok{\textless{}{-}} \DecValTok{1}

\NormalTok{Q.L2.death.Mis0 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(Y.death.model, }\AttributeTok{newdata =}\NormalTok{ data.Mis0, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)}
\NormalTok{Q.L2.death.Mis1 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(Y.death.model, }\AttributeTok{newdata =}\NormalTok{ data.Mis1, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)}

\NormalTok{Q.L2.qol.Mis0 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(Y.qol.model, }\AttributeTok{newdata =}\NormalTok{ data.Mis0, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)}
\NormalTok{Q.L2.qol.Mis1 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(Y.qol.model, }\AttributeTok{newdata =}\NormalTok{ data.Mis1, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)}

\DocumentationTok{\#\#\# 2c) calculate a weighted sum of the predicted Q.L2, with weights given by the}
\DocumentationTok{\#\#\#     predicted probabilities of the mediator G\_\{A=0|L(0)\} or G\_\{A=1|L(0)\}}
\CommentTok{\# calculate barQ.L2\_\{A=0,G\_\{A=0|L(0)\}\}}
\NormalTok{Q.L2.death.A0.G0 }\OtherTok{\textless{}{-}}\NormalTok{ Q.L2.death.Mis1 }\SpecialCharTok{*}\NormalTok{ G.Ais0.L0 }\SpecialCharTok{+}\NormalTok{ Q.L2.death.Mis0 }\SpecialCharTok{*}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ G.Ais0.L0)}
\NormalTok{Q.L2.qol.A0.G0 }\OtherTok{\textless{}{-}}\NormalTok{ Q.L2.qol.Mis1 }\SpecialCharTok{*}\NormalTok{ G.Ais0.L0 }\SpecialCharTok{+}\NormalTok{ Q.L2.qol.Mis0 }\SpecialCharTok{*}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ G.Ais0.L0)}

\CommentTok{\# calculate barQ.L2\_\{A=1,G\_\{A=0|L(0)\}\}}
\CommentTok{\# note at this step, quantities are similar to barQ.L2\_\{A=0,G\_\{A=0|L(0)\}\}}
\NormalTok{Q.L2.death.A1.G0 }\OtherTok{\textless{}{-}}\NormalTok{ Q.L2.death.Mis1 }\SpecialCharTok{*}\NormalTok{ G.Ais0.L0 }\SpecialCharTok{+}\NormalTok{ Q.L2.death.Mis0 }\SpecialCharTok{*}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ G.Ais0.L0)}
\NormalTok{Q.L2.qol.A1.G0 }\OtherTok{\textless{}{-}}\NormalTok{ Q.L2.qol.Mis1 }\SpecialCharTok{*}\NormalTok{ G.Ais0.L0 }\SpecialCharTok{+}\NormalTok{ Q.L2.qol.Mis0 }\SpecialCharTok{*}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ G.Ais0.L0)}

\CommentTok{\# calculate barQ.L2\_\{A=1,G\_\{A=1|L(0)\}\}}
\NormalTok{Q.L2.death.A1.G1 }\OtherTok{\textless{}{-}}\NormalTok{ Q.L2.death.Mis1 }\SpecialCharTok{*}\NormalTok{ G.Ais1.L0 }\SpecialCharTok{+}\NormalTok{ Q.L2.death.Mis0 }\SpecialCharTok{*}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ G.Ais1.L0)}
\NormalTok{Q.L2.qol.A1.G1 }\OtherTok{\textless{}{-}}\NormalTok{ Q.L2.qol.Mis1 }\SpecialCharTok{*}\NormalTok{ G.Ais1.L0 }\SpecialCharTok{+}\NormalTok{ Q.L2.qol.Mis0 }\SpecialCharTok{*}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ G.Ais1.L0)}

\DocumentationTok{\#\# 3) Fit parametric models for the predicted values barQ.L2 conditional on the}
\DocumentationTok{\#\#    exposure A and baseline confounders L(0)}
\DocumentationTok{\#\#    and generate predicted values by evaluating the regression setting the exposure}
\DocumentationTok{\#\#    value to A=0 or to A=1}
\DocumentationTok{\#\#\# 3a) Fit parametric models for the predicted values barQ.L2 conditional on the}
\DocumentationTok{\#\#\#    exposure A and baseline confounders L(0)}
\NormalTok{L1.death.A0.G0.model }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Q.L2.death.A0.G0 }\SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5}\NormalTok{,}
                            \AttributeTok{family =} \StringTok{"quasibinomial"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df2\_int)}
\NormalTok{L1.death.A1.G0.model }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Q.L2.death.A1.G0 }\SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5}\NormalTok{,}
                            \AttributeTok{family =} \StringTok{"quasibinomial"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df2\_int)}
\NormalTok{L1.death.A1.G1.model }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Q.L2.death.A1.G1 }\SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5}\NormalTok{,}
                            \AttributeTok{family =} \StringTok{"quasibinomial"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df2\_int)}

\NormalTok{L1.qol.A0.G0.model }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Q.L2.qol.A0.G0 }\SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5}\NormalTok{,}
                          \AttributeTok{family =} \StringTok{"gaussian"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df2\_int)}
\NormalTok{L1.qol.A1.G0.model }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Q.L2.qol.A1.G0 }\SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5}\NormalTok{,}
                          \AttributeTok{family =} \StringTok{"gaussian"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df2\_int)}
\NormalTok{L1.qol.A1.G1.model }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Q.L2.qol.A1.G1 }\SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5}\NormalTok{,}
                          \AttributeTok{family =} \StringTok{"gaussian"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df2\_int)}

\DocumentationTok{\#\#\# 3b) generate predicted values by evaluating the regression setting the exposure}
\DocumentationTok{\#\#\#     value to A=0 or to A=1}
\NormalTok{Q.L1.death.A0.G0 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(L1.death.A0.G0.model, }\AttributeTok{newdata =}\NormalTok{ data.Ais0, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)}
\NormalTok{Q.L1.death.A1.G0 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(L1.death.A1.G0.model, }\AttributeTok{newdata =}\NormalTok{ data.Ais1, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)}
\NormalTok{Q.L1.death.A1.G1 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(L1.death.A1.G1.model, }\AttributeTok{newdata =}\NormalTok{ data.Ais1, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)}

\NormalTok{Q.L1.qol.A0.G0 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(L1.qol.A0.G0.model, }\AttributeTok{newdata =}\NormalTok{ data.Ais0, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)}
\NormalTok{Q.L1.qol.A1.G0 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(L1.qol.A1.G0.model, }\AttributeTok{newdata =}\NormalTok{ data.Ais1, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)}
\NormalTok{Q.L1.qol.A1.G1 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(L1.qol.A1.G1.model, }\AttributeTok{newdata =}\NormalTok{ data.Ais1, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)}

\DocumentationTok{\#\# 4) Estimate the marginal randomized natural direct and indirect effects}
\DocumentationTok{\#\#\# MRDE = E(Y\_\{A=1,G\_\{A=0|L(0)\}\}) {-} E(Y\_\{A=0,G\_\{A=0|L(0)\}\})}
\DocumentationTok{\#\#\# MRIE = E(Y\_\{A=1,G\_\{A=1|L(0)\}\}) {-} E(Y\_\{A=1,G\_\{A=0|L(0)\}\})}

\DocumentationTok{\#\#\# for deaths:}
\NormalTok{MRDE.death }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(Q.L1.death.A1.G0) }\SpecialCharTok{{-}} \FunctionTok{mean}\NormalTok{(Q.L1.death.A0.G0)}
\NormalTok{MRDE.death}
\CommentTok{\# [1] 0.0714693}
\NormalTok{MRIE.death }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(Q.L1.death.A1.G1) }\SpecialCharTok{{-}} \FunctionTok{mean}\NormalTok{(Q.L1.death.A1.G0)}
\NormalTok{MRIE.death}
\CommentTok{\# [1] 0.01130057}

\DocumentationTok{\#\#\# for quality of life}
\NormalTok{MRDE.qol }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(Q.L1.qol.A1.G0) }\SpecialCharTok{{-}} \FunctionTok{mean}\NormalTok{(Q.L1.qol.A0.G0)}
\NormalTok{MRDE.qol}
\CommentTok{\# [1] {-}6.719193}
\NormalTok{MRIE.qol }\OtherTok{\textless{}{-}}  \FunctionTok{mean}\NormalTok{(Q.L1.qol.A1.G1) }\SpecialCharTok{{-}} \FunctionTok{mean}\NormalTok{(Q.L1.qol.A1.G0)}
\NormalTok{MRIE.qol}
\CommentTok{\# [1] {-}1.624645}
\end{Highlighting}
\end{Shaded}

Results are close to the estimations obtained previously with parametric g-computation.

\begin{itemize}
\tightlist
\item
  the marginal ``randomized'' Natural Direct and Indirect effect on death are a \(MRDE \approx +7.1\%\) and \(MRIE \approx +1.1\%\);
\item
  the marginal ``randomized'' Natural Direct and Indirect effect on quality of life are a \(MRDE \approx -6.6\) and \(MRIE \approx -1.6\);
\end{itemize}

95\% confidence intervals can be calculated by bootstrap.

\section{\texorpdfstring{Using the \texttt{CMAverse} package for 2-way, 3-way and 4-way decomposition}{Using the CMAverse package for 2-way, 3-way and 4-way decomposition}}\label{using-the-cmaverse-package-for-2-way-3-way-and-4-way-decomposition}

The \texttt{CMAverse} package can be used to estimate the 2-way, 3-way and 4-way decompositions of a total effect by parametric g-computation, whether the intermediate confounder \(L(1)\) of the \(M-Y\) relationship is affected by the exposure \(A\) or not.

Here is an example with a continuous outcome using the \texttt{cmest} function. Note that :

\begin{itemize}
\tightlist
\item
  parametric g-computation is applied by specifying \texttt{model\ =\ "gformula"}. The \texttt{estimation} argument should be set to \texttt{imputation} (as the counterfactual values will be imputed).
\item
  the presence of intermediate confounder \(L(1)\) of the \(M-Y\) relationship affected by the exposure \(A\) can be specified using the \texttt{postcreg} argument,
\item
  the presence of an \(A \ast M\) interaction effect on the outcome is indicated using the \texttt{EMint} argument,
\item
  for the estimation of the Controlled direct effect, the fixed value set for the mediator is indicated using the \texttt{mval} argument.
\end{itemize}

The function returns the following results:

\begin{itemize}
\tightlist
\item
  fit of the Outcome regression \(\overline{Q}_Y = \mathbb{E}(Y \mid L(0),A,L(1),M)\),
\item
  fit of the Mediator regression \(g_A = P(M=1 \mid L(0),A,L(1))\),
\item
  fit of the intermediate confounder regression \(\overline{Q}_{L(1)} = P(L(1)=1\mid L(0),A)\),
\item
  the 2-way, 3-way and 4-way decompositions.
\end{itemize}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(CMAverse)}
\FunctionTok{rm}\NormalTok{(}\AttributeTok{list=}\FunctionTok{ls}\NormalTok{())}
\NormalTok{df2\_int }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file =} \StringTok{"data/df2\_int.csv"}\NormalTok{)}

\FunctionTok{set.seed}\NormalTok{(}\DecValTok{1234}\NormalTok{)}
\NormalTok{res\_gformula\_Qol\_M0 }\OtherTok{\textless{}{-}} \FunctionTok{cmest}\NormalTok{(}\AttributeTok{data =}\NormalTok{ df2\_int, }
                         \AttributeTok{model =} \StringTok{"gformula"}\NormalTok{, }\CommentTok{\# for parametric g{-}computation}
                         \AttributeTok{outcome =} \StringTok{"Y\_qol"}\NormalTok{, }\CommentTok{\# outcome variable}
                         \AttributeTok{exposure =} \StringTok{"A0\_PM2.5"}\NormalTok{, }\CommentTok{\# exposure variable}
                         \AttributeTok{mediator =} \StringTok{"M\_diabetes"}\NormalTok{, }\CommentTok{\# mediator}
                         \AttributeTok{basec =} \FunctionTok{c}\NormalTok{(}\StringTok{"L0\_male"}\NormalTok{,     }\CommentTok{\# confounders}
                                   \StringTok{"L0\_soc\_env"}\NormalTok{), }
                         \AttributeTok{postc =} \StringTok{"L1"}\NormalTok{, }\CommentTok{\# intermediate confounder (post{-}exposure)}
                         \AttributeTok{EMint =} \ConstantTok{TRUE}\NormalTok{, }\CommentTok{\# exposures*mediator interaction}
                         \AttributeTok{mreg =} \FunctionTok{list}\NormalTok{(}\StringTok{"logistic"}\NormalTok{), }\CommentTok{\# g(M=1|L1,A,L0)}
                         \AttributeTok{yreg =} \StringTok{"linear"}\NormalTok{,}\CommentTok{\# Qbar.L2 = P(Y=1|M,L1,A,L0)}
                         \AttributeTok{postcreg =} \FunctionTok{list}\NormalTok{(}\StringTok{"logistic"}\NormalTok{), }\CommentTok{\# Qbar.L1 = P(L1=1|A,L0)}
                         \AttributeTok{astar =} \DecValTok{0}\NormalTok{,}
                         \AttributeTok{a =} \DecValTok{1}\NormalTok{,}
                         \AttributeTok{mval =} \FunctionTok{list}\NormalTok{(}\DecValTok{0}\NormalTok{), }\CommentTok{\# do(M=0) to estimate CDE\_m}
                         \AttributeTok{estimation =} \StringTok{"imputation"}\NormalTok{, }\CommentTok{\# if model= gformula}
                         \AttributeTok{inference =} \StringTok{"bootstrap"}\NormalTok{,}
                         \AttributeTok{boot.ci.type =} \StringTok{"per"}\NormalTok{, }\CommentTok{\# for percentile, other option: "bca"}
                         \AttributeTok{nboot =} \DecValTok{2}\NormalTok{) }\CommentTok{\# we should use a large number of bootstrap samples}
\FunctionTok{summary}\NormalTok{(res\_gformula\_Qol\_M0)}

\DocumentationTok{\#\#\# 1) Estimation of Qbar.Y = P(Y=1|M,L1,A,L0) with A*M interaction,}
\DocumentationTok{\#\#\# Outcome regression:}
\CommentTok{\# Call:}
\CommentTok{\#   glm(formula = Y\_qol \textasciitilde{} A0\_PM2.5 + M\_diabetes + A0\_PM2.5 * M\_diabetes +}
\CommentTok{\#         L0\_male + L0\_soc\_env + L1, family = gaussian(),}
\CommentTok{\#       data = getCall(x$reg.output$yreg)$data, weights = getCall(x$reg.output$yreg)$weights)}
\CommentTok{\# Coefficients:}
\CommentTok{\#                         Estimate Std. Error t value Pr(\textgreater{}|t|)}
\CommentTok{\#   (Intercept)            74.8247     0.2133 350.823  \textless{} 2e{-}16 ***}
\CommentTok{\#   A0\_PM2.5               {-}3.7014     0.4295  {-}8.617  \textless{} 2e{-}16 ***}
\CommentTok{\#   M\_diabetes             {-}8.6336     0.2331 {-}37.042  \textless{} 2e{-}16 ***}
\CommentTok{\#   L0\_male                {-}0.7280     0.2019  {-}3.605 0.000313 ***}
\CommentTok{\#   L0\_soc\_env             {-}2.8828     0.2116 {-}13.621  \textless{} 2e{-}16 ***}
\CommentTok{\#   L1                     {-}5.1668     0.2189 {-}23.608  \textless{} 2e{-}16 ***}
\CommentTok{\#   A0\_PM2.5:M\_diabetes    {-}5.5119     0.6440  {-}8.559  \textless{} 2e{-}16 ***}

\DocumentationTok{\#\#\# 2) Estimation of g(M=1|L1,A,L0), model of the mediator}
\DocumentationTok{\#\#\# Mediator regressions:}
\CommentTok{\# Call:}
\CommentTok{\#   glm(formula = M\_diabetes \textasciitilde{} A0\_PM2.5 + L0\_male + L0\_soc\_env +}
\CommentTok{\#         L1, family = binomial(), data = getCall(x$reg.output$mreg[[1L]])$data,}
\CommentTok{\#       weights = getCall(x$reg.output$mreg[[1L]])$weights)}
\CommentTok{\# Coefficients:}
\CommentTok{\#                         Estimate Std. Error z value Pr(\textgreater{}|z|)}
\CommentTok{\#   (Intercept)           {-}1.36249    0.04783 {-}28.488  \textless{} 2e{-}16 ***}
\CommentTok{\#   A0\_PM2.5               0.30994    0.06668   4.648 3.35e{-}06 ***}
\CommentTok{\#   L0\_male                0.24661    0.04369   5.644 1.66e{-}08 ***}
\CommentTok{\#   L0\_soc\_env             0.30628    0.04650   6.587 4.50e{-}11 ***}
\CommentTok{\#   L1                     0.86045    0.04493  19.152  \textless{} 2e{-}16 ***}

\DocumentationTok{\#\#\# 3) Estimation of Qbar.L1 = P(L1=1|A,L0), model of intermediate confounder}
\DocumentationTok{\#\#\# Regressions for mediator{-}outcome confounders affected by the exposure:}
\CommentTok{\# Call:}
\CommentTok{\#   glm(formula = L1 \textasciitilde{} A0\_PM2.5 + L0\_male + L0\_soc\_env,}
\CommentTok{\#       family = binomial(), data = getCall(x$reg.output$postcreg[[1L]])$data,}
\CommentTok{\#       weights = getCall(x$reg.output$postcreg[[1L]])$weights)}
\CommentTok{\#}
\CommentTok{\# Coefficients:}
\CommentTok{\#                         Estimate Std. Error z value Pr(\textgreater{}|z|)}
\CommentTok{\#   (Intercept)           {-}0.86983    0.04292 {-}20.267  \textless{} 2e{-}16 ***}
\CommentTok{\#   A0\_PM2.5               0.94354    0.06475  14.572  \textless{} 2e{-}16 ***}
\CommentTok{\#   L0\_male               {-}0.19827    0.04289  {-}4.622 3.80e{-}06 ***}
\CommentTok{\#   L0\_soc\_env             0.32047    0.04556   7.034 2.01e{-}12 ***}

\DocumentationTok{\#\#\# 4) Effect decomposition on the mean difference scale via the g{-}formula approach}
\CommentTok{\#}
\CommentTok{\# Direct counterfactual imputation estimation with}
\CommentTok{\# bootstrap standard errors, percentile confidence intervals and p{-}values}
\CommentTok{\#}
\CommentTok{\#                  Estimate Std.error   95\% CIL 95\% CIU  P.val}
\CommentTok{\#   cde           {-}5.863750  0.233488 {-}4.933234  {-}4.620 \textless{}2e{-}16 ***}
\CommentTok{\#   rpnde         {-}7.565835  0.199867 {-}6.689581  {-}6.421 \textless{}2e{-}16 ***}
\CommentTok{\#   rtnde         {-}8.463729  0.157383 {-}7.266085  {-}7.055 \textless{}2e{-}16 ***}
\CommentTok{\#   rpnie         {-}1.406410  0.021876 {-}0.971101  {-}0.942 \textless{}2e{-}16 ***}
\CommentTok{\#   rtnie         {-}2.304304  0.064359 {-}1.604682  {-}1.518 \textless{}2e{-}16 ***}
\CommentTok{\#   te            {-}9.870139  0.135507 {-}8.207796  {-}8.026 \textless{}2e{-}16 ***}
\CommentTok{\#   rintref       {-}1.702085  0.033622 {-}1.801518  {-}1.756 \textless{}2e{-}16 ***}
\CommentTok{\#   rintmed       {-}0.897894  0.042484 {-}0.633581  {-}0.577 \textless{}2e{-}16 ***}
\CommentTok{\#   cde(prop)      0.594090  0.018945  0.575575   0.601 \textless{}2e{-}16 ***}
\CommentTok{\#   rintref(prop)  0.172448  0.007802  0.213991   0.224 \textless{}2e{-}16 ***}
\CommentTok{\#   rintmed(prop)  0.090971  0.006479  0.070244   0.079 \textless{}2e{-}16 ***}
\CommentTok{\#   rpnie(prop)    0.142491  0.004663  0.114737   0.121 \textless{}2e{-}16 ***}
\CommentTok{\#   rpm            0.233462  0.011142  0.184981   0.200 \textless{}2e{-}16 ***}
\CommentTok{\#   rint           0.263419  0.014282  0.284235   0.303 \textless{}2e{-}16 ***}
\CommentTok{\#   rpe            0.405910  0.018945  0.398973   0.424 \textless{}2e{-}16 ***}
\CommentTok{\#   {-}{-}{-}}
\CommentTok{\#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1}
\CommentTok{\#}
\CommentTok{\# cde: controlled direct effect;}
\CommentTok{\# rpnde: randomized analogue of pure natural direct effect;}
\CommentTok{\# rtnde: randomized analogue of total natural direct effect;}
\CommentTok{\# rpnie: randomized analogue of pure natural indirect effect;}
\CommentTok{\# rtnie: randomized analogue of total natural indirect effect;}
\CommentTok{\# te: total effect; rintref: randomized analogue of reference interaction;}
\CommentTok{\# rintmed: randomized analogue of mediated interaction;}
\CommentTok{\# cde(prop): proportion cde;}
\CommentTok{\# rintref(prop): proportion rintref;}
\CommentTok{\# rintmed(prop): proportion rintmed;}
\CommentTok{\# rpnie(prop): proportion rpnie;}
\CommentTok{\# rpm: randomized analogue of overall proportion mediated;}
\CommentTok{\# rint: randomized analogue of overall proportion attributable to interaction;}
\CommentTok{\# rpe: randomized analogue of overall proportion eliminated}
\end{Highlighting}
\end{Shaded}

Using the \texttt{CMAverse} package,

\begin{itemize}
\tightlist
\item
  the total effect (overall effect) on the QoL quantitative outcome is estimated to be \(TE = \mathbb{E}\left(Y_{A=1,G_{A=1\mid L(0)}} \right) - \mathbb{E}\left(Y_{A=0,G_{A=0\mid L(0)}} \right) \approx -9.87\),
\item
  the controlled direct effect (\(CDE_{M=0}\)), setting \(M=0\) is \(CDE_{M=0}=\mathbb{E}\left(Y_{A=1,M=0} \right) - \mathbb{E}\left(Y_{A=0,M=0} \right)\approx -5.86\),
\item
  the randomized pure natural direct effect is \(rPNDE = \mathbb{E}\left(Y_{A=1,G_{A=0\mid L(0)}} \right) - \mathbb{E}\left(Y_{A=0,G_{A=0\mid L(0)}} \right)\approx -7.57\)
\item
  the randomized total natural indirect effect is \(rTNIE = \mathbb{E}\left(Y_{A=1,G_{A=1\mid L(0)}} \right) - \mathbb{E}\left(Y_{A=1,G_{A=0\mid L(0)}} \right)\approx -2.30\)
\end{itemize}

(\citeproc{ref-vanderweele2014}{VanderWeele 2014}) defined the 3-way or 4-way decomposition in causal structures with no intermediate confounder \(L(1)\) of the \(M-Y\) relationship affected by the exposure \(A\). In causal structures with such intermediate confounders (Causal model 2, Figure \ref{fig:figDAGM2}), analogues of the 3-way and 4-way decomposition can still be defined. Those analogues are estimated by the \texttt{CMAverse} package. They can be calculated from the controlled direct effect (setting \(M=0\)) and the pure Natural Direct and Indirect Effects, using the following relationships:

\begin{itemize}
\tightlist
\item
  We can start by estimating the Total Effect (Overall effect), the CDE (setting \(M=0\)), the randomized Pure Natural Direct effect and the randomized Pure Natural Indirect Effect:
  \begin{align*}
  TE &= \mathbb{E}\left(Y_{A=1,G_{A=1\mid L(0)}} \right) - \mathbb{E}\left(Y_{A=0,G_{A=0\mid L(0)}} \right) \\
  CDE_{M=0} &=\mathbb{E}\left(Y_{A=1,M=0} \right) - \mathbb{E}\left(Y_{A=0,M=0} \right) \\
  rPNDE &= \mathbb{E}\left(Y_{A=1,G_{A=0\mid L(0)}} \right) - \mathbb{E}\left(Y_{A=0,G_{A=0\mid L(0)}} \right) \\
  rPNIE &= \mathbb{E}\left(Y_{A=0,G_{A=1\mid L(0)}} \right) - \mathbb{E}\left(Y_{A=0,G_{A=0\mid L(0)}} \right)
    \end{align*}
\item
  the Mediated Interaction can then be obtained by :
  \begin{align*}
  MIE &= rTNDE - rPNDE = rTNIE - rPNIE \\
  MIE &= \left[\mathbb{E}\left(Y_{A=1,G_{A=1\mid L(0)}} \right) - \mathbb{E}\left(Y_{A=0,G_{A=1\mid L(0)}} \right)\right] \\
    & \quad \quad - \left[\mathbb{E}\left(Y_{A=1,G_{A=0\mid L(0)}} \right) - \mathbb{E}\left(Y_{A=1,G_{A=0\mid L(0)}} \right)\right] \\
    &= \left[\mathbb{E}\left(Y_{A=1,G_{A=1\mid L(0)}} \right) - \mathbb{E}\left(Y_{A=1,G_{A=0\mid L(0)}} \right)\right] \\
    & \quad \quad - \left[\mathbb{E}\left(Y_{A=0,G_{A=1\mid L(0)}} \right) - \mathbb{E}\left(Y_{A=0,G_{A=0\mid L(0)}} \right)\right]
    \end{align*}
\item
  and the Reference Interaction can be obtained by :
  \begin{align*}
  RIE &= rPNDE - CDE_{M=0} \\
  RIE &= \left[\mathbb{E}\left(Y_{A=1,G_{A=0\mid L(0)}} \right) - \mathbb{E}\left(Y_{A=0,G_{A=0\mid L(0)}} \right) \right] - \left[ \mathbb{E}\left(Y_{A=1,M=0} \right) - \mathbb{E}\left(Y_{A=0,M=0} \right) \right]
    \end{align*}
\end{itemize}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# Using the previous results, we can check those equalities for the analogues }
\DocumentationTok{\#\# of the 3{-}way and 4{-}way decomposition}
\NormalTok{res\_gformula\_Qol\_M0}\SpecialCharTok{$}\NormalTok{effect.pe[}\StringTok{"te"}\NormalTok{]}
\CommentTok{\# TE = {-}9.870139}
\NormalTok{res\_gformula\_Qol\_M0}\SpecialCharTok{$}\NormalTok{effect.pe[}\StringTok{"cde"}\NormalTok{]}
\CommentTok{\# CDE(M=0) = {-}5.86375}
\NormalTok{res\_gformula\_Qol\_M0}\SpecialCharTok{$}\NormalTok{effect.pe[}\StringTok{"rpnde"}\NormalTok{]}
\CommentTok{\# rPNDE = {-}7.565835}
\NormalTok{res\_gformula\_Qol\_M0}\SpecialCharTok{$}\NormalTok{effect.pe[}\StringTok{"rpnie"}\NormalTok{]}
\CommentTok{\# rPNIE = {-}1.40641}

\DocumentationTok{\#\# Check that MI = rTNIE {-} rPNIE = rTNDE {-} rPNDE}
\NormalTok{(res\_gformula\_Qol}\SpecialCharTok{$}\NormalTok{effect.pe[}\StringTok{"rtnie"}\NormalTok{] }\SpecialCharTok{{-}}\NormalTok{ res\_gformula\_Qol}\SpecialCharTok{$}\NormalTok{effect.pe[}\StringTok{"rpnie"}\NormalTok{])}
\CommentTok{\# {-}0.897894}
\NormalTok{(res\_gformula\_Qol}\SpecialCharTok{$}\NormalTok{effect.pe[}\StringTok{"rtnde"}\NormalTok{] }\SpecialCharTok{{-}}\NormalTok{ res\_gformula\_Qol}\SpecialCharTok{$}\NormalTok{effect.pe[}\StringTok{"rpnde"}\NormalTok{])}
\CommentTok{\# {-}0.897894}
\NormalTok{res\_gformula\_Qol\_M0}\SpecialCharTok{$}\NormalTok{effect.pe[}\StringTok{"rintmed"}\NormalTok{]}
\CommentTok{\# {-}0.897894 \# we have MI = rTNIE {-} rPNIE = rTNDE {-} rPNDE}

\DocumentationTok{\#\# Check that RE = PNDE {-} CDE\_\{M=0\}}
\NormalTok{res\_gformula\_Qol\_M0}\SpecialCharTok{$}\NormalTok{effect.pe[}\StringTok{"rpnde"}\NormalTok{] }\SpecialCharTok{{-}}\NormalTok{ res\_gformula\_Qol\_M0}\SpecialCharTok{$}\NormalTok{effect.pe[}\StringTok{"cde"}\NormalTok{]}
\CommentTok{\# {-}1.702085}
\NormalTok{res\_gformula\_Qol\_M0}\SpecialCharTok{$}\NormalTok{effect.pe[}\StringTok{"rintref"}\NormalTok{]}
\CommentTok{\# {-}1.702085 \# we have RE = PNDE {-} CDE\_\{M=0\}}
\end{Highlighting}
\end{Shaded}

With a binary outcome, we can use the same \texttt{cmest} function as previously, replacing the \texttt{yreg\ =\ "linear"} argument by \texttt{yreg\ =\ "logistic"}. The results will be given on the Odds Ratio scale:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{1234}\NormalTok{)}
\NormalTok{res\_gformula\_OR\_M0 }\OtherTok{\textless{}{-}} \FunctionTok{cmest}\NormalTok{(}\AttributeTok{data =}\NormalTok{ df2\_int,}
                      \AttributeTok{model =} \StringTok{"gformula"}\NormalTok{,}
                      \AttributeTok{outcome =} \StringTok{"Y\_death"}\NormalTok{,}
                      \AttributeTok{exposure =} \StringTok{"A0\_PM2.5"}\NormalTok{,}
                      \AttributeTok{mediator =} \StringTok{"M\_diabetes"}\NormalTok{,}
                      \AttributeTok{basec =} \FunctionTok{c}\NormalTok{(}\StringTok{"L0\_male"}\NormalTok{, }\StringTok{"L0\_soc\_env"}\NormalTok{),}
                      \AttributeTok{postc =} \StringTok{"L1"}\NormalTok{,}
                      \AttributeTok{EMint =} \ConstantTok{TRUE}\NormalTok{,}
                      \AttributeTok{mreg =} \FunctionTok{list}\NormalTok{(}\StringTok{"logistic"}\NormalTok{), }\CommentTok{\# g(M=1|L1,A,L0)}
                      \AttributeTok{yreg =} \StringTok{"logistic"}\NormalTok{,}\CommentTok{\# Qbar.L2 = P(Y=1|M,L1,A,L0)}
                      \AttributeTok{postcreg =} \FunctionTok{list}\NormalTok{(}\StringTok{"logistic"}\NormalTok{), }\CommentTok{\# Qbar.L1 = P(L1=1|A,L0)}
                      \AttributeTok{astar =} \DecValTok{0}\NormalTok{,}
                      \AttributeTok{a =} \DecValTok{1}\NormalTok{,}
                      \AttributeTok{mval =} \FunctionTok{list}\NormalTok{(}\DecValTok{0}\NormalTok{), }\CommentTok{\# do(M=0) to estimate CDE\_m}
                      \AttributeTok{estimation =} \StringTok{"imputation"}\NormalTok{, }\CommentTok{\# parametric g{-}comp if model= gformula}
                      \AttributeTok{inference =} \StringTok{"bootstrap"}\NormalTok{,}
                      \AttributeTok{boot.ci.type =} \StringTok{"per"}\NormalTok{, }\CommentTok{\# forpercentile, other option: "bca"}
                      \AttributeTok{nboot =} \DecValTok{2}\NormalTok{) }\CommentTok{\# we should use a large number of bootstrap samples}
\FunctionTok{summary}\NormalTok{(res\_gformula\_OR\_M0)}
\DocumentationTok{\#\#\# 1) Estimation of Qbar.Y = P(Y=1|M,L1,A,L0) with A*M interaction,}
\DocumentationTok{\#\#\#    by logistic regression}
\CommentTok{\# Outcome regression:}
\CommentTok{\# Call:}
\CommentTok{\# glm(formula = Y\_death \textasciitilde{} A0\_PM2.5 + M\_diabetes + A0\_PM2.5 * M\_diabetes + }
\CommentTok{\#     L0\_male + L0\_soc\_env + L1, family = binomial(), }
\CommentTok{\#     data = getCall(x$reg.output$yreg)$data, weights = getCall(x$reg.output$yreg)$weights)}
\CommentTok{\# }
\CommentTok{\# Coefficients:}
\CommentTok{\#                       Estimate Std. Error z value Pr(\textgreater{}|z|)    }
\CommentTok{\# (Intercept)           {-}2.04033    0.05855 {-}34.849  \textless{} 2e{-}16 ***}
\CommentTok{\# A0\_PM2.5               0.28922    0.10123   2.857  0.00428 ** }
\CommentTok{\# M\_diabetes             0.44406    0.05569   7.974 1.53e{-}15 ***}
\CommentTok{\# L0\_male                0.26913    0.04996   5.387 7.15e{-}08 ***}
\CommentTok{\# L0\_soc\_env             0.34603    0.05432   6.370 1.89e{-}10 ***}
\CommentTok{\# L11                    0.42894    0.05195   8.257  \textless{} 2e{-}16 ***}
\CommentTok{\# A0\_PM2.5:M\_diabetes    0.04387    0.14311   0.307  0.75919   }

\CommentTok{\# etc}

\DocumentationTok{\#\#\# 4) Effect decomposition on the odds ratio scale via the g{-}formula approach}
\CommentTok{\#                 Estimate Std.error  95\% CIL 95\% CIU  P.val    }
\CommentTok{\# Rcde            1.592115  0.121242 1.401748   1.565 \textless{}2e{-}16 ***}
\CommentTok{\# rRpnde          1.610141  0.064880 1.458433   1.546 \textless{}2e{-}16 ***}
\CommentTok{\# rRtnde          1.621371  0.046720 1.479227   1.542 \textless{}2e{-}16 ***}
\CommentTok{\# rRpnie          1.076471  0.001714 1.036683   1.039 \textless{}2e{-}16 ***}
\CommentTok{\# rRtnie          1.083979  0.014539 1.034267   1.054 \textless{}2e{-}16 ***}
\CommentTok{\# Rte             1.745359  0.045898 1.536897   1.599 \textless{}2e{-}16 ***}
\CommentTok{\# ERcde           0.392219  0.073776 0.277167   0.376 \textless{}2e{-}16 ***}
\CommentTok{\# rERintref       0.217921  0.008895 0.169383   0.181 \textless{}2e{-}16 ***}
\CommentTok{\# rERintmed       0.058747  0.017268 0.016243   0.039 \textless{}2e{-}16 ***}
\CommentTok{\# rERpnie         0.076471  0.001714 0.036684   0.039 \textless{}2e{-}16 ***}
\CommentTok{\# ERcde(prop)     0.526216  0.083694 0.515858   0.628 \textless{}2e{-}16 ***}
\CommentTok{\# rERintref(prop) 0.292371  0.040769 0.283120   0.338 \textless{}2e{-}16 ***}
\CommentTok{\# rERintmed(prop) 0.078817  0.034491 0.027264   0.074 \textless{}2e{-}16 ***}
\CommentTok{\# rERpnie(prop)   0.102596  0.008434 0.061314   0.073 \textless{}2e{-}16 ***}
\CommentTok{\# rpm             0.181413  0.042925 0.088578   0.146 \textless{}2e{-}16 ***}
\CommentTok{\# rint            0.371188  0.075260 0.310384   0.411 \textless{}2e{-}16 ***}
\CommentTok{\# rpe             0.473784  0.083694 0.371698   0.484 \textless{}2e{-}16 ***}
\CommentTok{\# {-}{-}{-}}
\CommentTok{\# Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1}
\CommentTok{\# }
\CommentTok{\# Rcde: controlled direct effect odds ratio; }
\CommentTok{\# rRpnde: randomized analogue of pure natural direct effect odds ratio; }
\CommentTok{\# rRtnde: randomized analogue of total natural direct effect odds ratio; }
\CommentTok{\# rRpnie: randomized analogue of pure natural indirect effect odds ratio; }
\CommentTok{\# rRtnie: randomized analogue of total natural indirect effect odds ratio; }
\CommentTok{\# Rte: total effect odds ratio; }
\CommentTok{\# ERcde: excess relative risk due to controlled direct effect; }
\CommentTok{\# rERintref: randomized analogue of excess relative risk due to reference interaction; }
\CommentTok{\# rERintmed: randomized analogue of excess relative risk due to mediated interaction; }
\CommentTok{\# rERpnie: randomized analogue of excess relative risk due to pure natural indirect effect; }
\CommentTok{\# ERcde(prop): proportion ERcde; }
\CommentTok{\# rERintref(prop): proportion rERintref; }
\CommentTok{\# rERintmed(prop): proportion rERintmed; }
\CommentTok{\# rERpnie(prop): proportion rERpnie; }
\CommentTok{\# rpm: randomized analogue of overall proportion mediated; }
\CommentTok{\# rint: randomized analogue of overall proportion attributable to interaction; }
\CommentTok{\# rpe: randomized analogue of overall proportion eliminated)}
\end{Highlighting}
\end{Shaded}

If we prefer to estimate results for the binary outcome on a risk difference scale, it is still possible, by appyling a linear regression for the outcome model, using the argument \texttt{yreg\ =\ "linear"}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{1234}\NormalTok{)}
\NormalTok{res\_gformula\_RD\_M0 }\OtherTok{\textless{}{-}} \FunctionTok{cmest}\NormalTok{(}\AttributeTok{data =}\NormalTok{ df2\_int,}
                      \AttributeTok{model =} \StringTok{"gformula"}\NormalTok{,}
                      \AttributeTok{outcome =} \StringTok{"Y\_death"}\NormalTok{,}
                      \AttributeTok{exposure =} \StringTok{"A0\_PM2.5"}\NormalTok{,}
                      \AttributeTok{mediator =} \StringTok{"M\_diabetes"}\NormalTok{,}
                      \AttributeTok{basec =} \FunctionTok{c}\NormalTok{(}\StringTok{"L0\_male"}\NormalTok{, }\StringTok{"L0\_soc\_env"}\NormalTok{),}
                      \AttributeTok{postc =} \StringTok{"L1"}\NormalTok{,}
                      \AttributeTok{EMint =} \ConstantTok{TRUE}\NormalTok{,}
                      \AttributeTok{mreg =} \FunctionTok{list}\NormalTok{(}\StringTok{"logistic"}\NormalTok{), }\CommentTok{\# g(M=1|L1,A,L0)}
                      \AttributeTok{yreg =} \StringTok{"linear"}\NormalTok{,}\CommentTok{\# Qbar.L2 = P(Y=1|M,L1,A,L0)}
                      \AttributeTok{postcreg =} \FunctionTok{list}\NormalTok{(}\StringTok{"logistic"}\NormalTok{), }\CommentTok{\# Qbar.L1 = P(L1=1|A,L0)}
                      \AttributeTok{astar =} \DecValTok{0}\NormalTok{,}
                      \AttributeTok{a =} \DecValTok{1}\NormalTok{,}
                      \AttributeTok{mval =} \FunctionTok{list}\NormalTok{(}\DecValTok{0}\NormalTok{), }\CommentTok{\# do(M=0) to estimate CDE\_m}
                      \AttributeTok{estimation =} \StringTok{"imputation"}\NormalTok{, }\CommentTok{\# parametric g{-}comp if model= gformula}
                      \AttributeTok{inference =} \StringTok{"bootstrap"}\NormalTok{,}
                      \AttributeTok{boot.ci.type =} \StringTok{"per"}\NormalTok{, }\CommentTok{\# forpercentile, other option: "bca"}
                      \AttributeTok{nboot =} \DecValTok{2}\NormalTok{) }\CommentTok{\# we should use a large number of bootstrap samples}
\FunctionTok{summary}\NormalTok{(res\_gformula\_RD\_M0)}
\DocumentationTok{\#\# 4) Effect decomposition on the mean difference scale via the g{-}formula approach}
\CommentTok{\# Direct counterfactual imputation estimation with}
\CommentTok{\# bootstrap standard errors, percentile confidence intervals and p{-}values}
\CommentTok{\#}
\CommentTok{\# Direct counterfactual imputation estimation with}
\CommentTok{\# bootstrap standard errors, percentile confidence intervals and p{-}values}
\CommentTok{\#}
\CommentTok{\#                  Estimate Std.error   95\% CIL 95\% CIU  P.val}
\CommentTok{\#   cde           0.0638914 0.0158641 0.0467659   0.068 \textless{}2e{-}16 *** }
\CommentTok{\#   rpnde         0.0734700 0.0307357 0.0598528   0.101 \textless{}2e{-}16 *** }
\CommentTok{\#   rtnde         0.0771555 0.0333264 0.0647151   0.109 \textless{}2e{-}16 ***}
\CommentTok{\#   rpnie         0.0090890 0.0033498 0.0050769   0.010 \textless{}2e{-}16 ***}
\CommentTok{\#   rtnie         0.0127744 0.0007591 0.0134198   0.014 \textless{}2e{-}16 *** }
\CommentTok{\#   te            0.0862445 0.0299766 0.0742924   0.115 \textless{}2e{-}16 ***}
\CommentTok{\#   rintref       0.0095786 0.0148716 0.0130869   0.033 \textless{}2e{-}16 ***}
\CommentTok{\#   rintmed       0.0036855 0.0025907 0.0048623   0.008 \textless{}2e{-}16 ***}
\CommentTok{\#   cde(prop)     0.7408176 0.0263715 0.5945733   0.630 \textless{}2e{-}16 ***}
\CommentTok{\#   rintref(prop) 0.1110634 0.0841501 0.1744983   0.288 \textless{}2e{-}16 ***}
\CommentTok{\#   rintmed(prop) 0.0427328 0.0055167 0.0653396   0.073 \textless{}2e{-}16 ***}
\CommentTok{\#   rpnie(prop)   0.1053862 0.0632953 0.0451212   0.130 \textless{}2e{-}16 ***}
\CommentTok{\#   rpm           0.1481190 0.0577786 0.1178726   0.195 \textless{}2e{-}16 ***}
\CommentTok{\#   rint          0.1537963 0.0896668 0.2398378   0.360 \textless{}2e{-}16 ***}
\CommentTok{\#   rpe           0.2591824 0.0263715 0.3699965   0.405 \textless{}2e{-}16 ***}
\end{Highlighting}
\end{Shaded}

Using the \texttt{CMAverse} package,

\begin{itemize}
\tightlist
\item
  the total effect (overall effect) on the probability of death (binary outcome) is estimated to be \(TE = P\left(Y_{A=1,G_{A=1\mid L(0)}} = 1\right) - P\left(Y_{A=0,G_{A=0\mid L(0)}} = 1\right) \approx 0.086\),
\item
  the controlled direct effect (\(CDE_{M=0}\)), setting \(M=0\) is \(CDE_{M=0}=P\left(Y_{A=1,M=0} =1 \right) - P\left(Y_{A=0,M=0} = 1 \right)\approx 0.064\),
\item
  the randomized pure natural direct effect is \(rPNDE = P\left(Y_{A=1,G_{A=0\mid L(0)}} = 1 \right) - P\left(Y_{A=0,G_{A=0\mid L(0)}}  = 1\right)\approx 0.073\)
\item
  the randomized total natural indirect effect is \(rTNIE = P\left(Y_{A=1,G_{A=1\mid L(0)}} =1\right) - P\left(Y_{A=1,G_{A=0\mid L(0)}} =1\right)\approx 0.013\)
\end{itemize}

\section{Estimation of ``Conditional'' Randomized/Interventional Natural Direct (CRDE) and Indirect Effects (CRIE)}\label{estimation-of-conditional-randomizedinterventional-natural-direct-crde-and-indirect-effects-crie}

Zheng and van der Laan (\citeproc{ref-zheng2017longitudinal}{Zheng and van der Laan 2017}) described ``Conditional'' Randomized Direct and Indirect Effects, using random draws from the counterfactual distribution of the mediator, conditional on both \(L(0)\) and \(L(1)\). The Average Total Effect (ATE) can be decomposed into the sum of :

\begin{itemize}
\tightlist
\item
  a Conditional Randomized Natural Direct Effect (CRDE):
  \(\text{CRDE}=\mathbb{E}(Y_{1,\Gamma_{0} \mid L(0),L(1)})-\mathbb{E}(Y_{0,\Gamma_{0} \mid L(0), L(1)})\)
\item
  and Conditional Randomized Natural Indirect Effect (CRIE)
  \(\text{CRIE}=\mathbb{E}(Y_{1,\Gamma_{1} \mid L(0), L(1)})-\mathbb{E}(Y_{1,\Gamma_{0} \mid L(0), L(1)})\)
\end{itemize}

For this 2-way decomposition, we have to estimate 3 causal quantities: \(\mathbb{E}(Y_{1,\Gamma_{1} \mid L(0), L(1)})\), \(\mathbb{E}(Y_{1,\Gamma_{0} \mid L(0), L(1)})\) and \(\mathbb{E}(Y_{0,\Gamma_{0} \mid L(0), L(1)})\).

Under the identifiability conditions, in particular:

\begin{itemize}
\tightlist
\item
  no unmeasured confounding between \(A\) and \(Y\), given \(L(0)\)
\item
  no unmeasured confounding between \(M\) and \(Y\), given \(A\), \(L(0)\) and \(L(1)\)
\item
  no unmeasured confounding between \(A\) and \(M\), given \(L(0)\)
\item
  and no unmeasured confounding between \(A\) and \(L(1)\), given \(L(0)\)
\end{itemize}

the quantity of \(\mathbb{E}(Y_{a,\Gamma_{a^\prime} \mid L(0), L(1)})\) can be estimated by the g-formula:
\begin{multline*}
\mathbb{E}\left[Y_{a,\Gamma_{a^\prime} \mid L(0), L(1)} \right]=\sum_{l(0),l(1),m} \mathbb{E}\left(Y \mid m,l(1),A=a,l(0),\right) \times P[L(1)=l(1) \mid a,l(0)] \\
  \times P[M=m \mid l(1), a^\prime, l(0)] \times P(L(0)=l(0))
\end{multline*}
These causal effects can be estimated by g-computation, IPTW, or TMLE. The G-computation approach is described below.

\subsection{G-computation by iterative conditional expectation (simple substitution estimator)}\label{g-computation-by-iterative-conditional-expectation-simple-substitution-estimator}

We describe below the g-computation algorithm (``non targeted substitution estimator'') which is described in (\citeproc{ref-zheng2017longitudinal}{Zheng and van der Laan 2017}).

The following steps are applied to estimate the quantity \(\Psi^{a,a^\prime} = \mathbb{E}\left[Y_{a,\Gamma_{a^\prime} \mid L(0), L(1)} \right]\):

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Define \(\bar{Q}^{a,a^\prime}_{R_2} = Y\)
\item
  Calculate \(\bar{Q}^{a,a^\prime}_{L_1}\), \(\bar{Q}^{a,a^\prime}_{M_1}\) and \(\bar{Q}^{a,a^\prime}_{R_1}\)
\end{enumerate}

\begin{enumerate}
\def\labelenumi{(\alph{enumi})}
\item
  Regress \(\bar{Q}^{a,a^\prime}_{R_2}\) on the observed values of \(\{M,L(1),A,L(0)\}\),
  \begin{equation*}
      \mathbb{E}\left(\bar{Q}^{a,a^\prime}_{R_2} \mid M,L(1),A,L(0) \right) = \mathbb{E}\left(Y \mid M,L(1),A,L(0) \right)
    \end{equation*}
  Evaluate the fitted function at the observed mediator and covariates histories \(\{L(1),M,L(0)\}\) and the intervened exposure \(A=a\). This gives the estimates
  \begin{equation*} 
      \hat{\bar{Q}}^{a,a^\prime}_{L_1}(L(1),M,L(0)) = \mathbb{E}\left( Y \mid A = a,L(1),M,L(0) \right)
    \end{equation*}
\item
  Regress the predicted value \(\hat{\bar{Q}}^{a,a^\prime}_{L_1}(L(1),M,L(0))\) on the observed values of \(\{L(1),A,L(0)\}\)
  \begin{equation*}
      \mathbb{E}\left(\hat{\bar{Q}}^{a,a^\prime}_{L_1}(L(1),M,L(0)) \mid L(1),A,L(0) \right)
    \end{equation*}
  Then, evaluate the fitted function at the observed covariates histories \(\{L(1),L(0)\}\) and the intervened exposure \(A=a^\prime\). This gives the estimates
  \begin{equation*} 
      \hat{\bar{Q}}^{a,a^\prime}_{M_1}(L(1),L(0)) = \mathbb{E}\left( \hat{\bar{Q}}^{a,a^\prime}_{L_1}(L(1),M,L(0)) \mid A = a^\prime,L(1),L(0) \right)
    \end{equation*}
\item
  Regress the predicted value \(\hat{\bar{Q}}^{a,a^\prime}_{M_1}(L(1),L(0))\) on the observed values of \(\{A,L(0)\}\)
  \begin{equation*}
      \mathbb{E}\left(\hat{\bar{Q}}^{a,a^\prime}_{M_1}(L(1),L(0)) \mid A,L(0) \right)
    \end{equation*}
  Then, evaluate the fitted function at the observed covariates histories \(\{L(0)\}\) and the intervened exposure \(A=a\). This gives the estimates
  \begin{equation*} 
      \hat{\bar{Q}}^{a,a^\prime}_{R_1}(L(0)) = \mathbb{E}\left( \hat{\bar{Q}}^{a,a^\prime}_{M_1}(L(1),L(0)) \mid A = a,L(0) \right)
    \end{equation*}
\end{enumerate}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{2}
\tightlist
\item
  We have now estimated \(\hat{\bar{Q}}^{a,a^\prime}_{R_1}(L(0))\) for each individual.
  \begin{align*}
   \hat{\Psi}^{a,a^\prime} &= \frac{1}{n} \sum_{i=1}^n \hat{\bar{Q}}^{a,a^\prime}_{R_1}(L(0)) \\
   \text{CRDE} &= \hat{\Psi}^{1,0} - \hat{\Psi}^{0,0} \\
   \text{CRIE} &= \hat{\Psi}^{1,1} - \hat{\Psi}^{1,0} \\
    \end{align*}
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{rm}\NormalTok{(}\AttributeTok{list=}\FunctionTok{ls}\NormalTok{())}
\NormalTok{df2\_int }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file =} \StringTok{"data/df2\_int.csv"}\NormalTok{)}

\DocumentationTok{\#\# 1) Q\^{}\{a,a\textquotesingle{}\}\_R2 =  Y}
\NormalTok{Q.death\_R2 }\OtherTok{\textless{}{-}}\NormalTok{ df2\_int}\SpecialCharTok{$}\NormalTok{Y\_death}
\NormalTok{Q.qol\_R2 }\OtherTok{\textless{}{-}}\NormalTok{ df2\_int}\SpecialCharTok{$}\NormalTok{Y\_qol}

\DocumentationTok{\#\# 2) Obtain Q\^{}\{a,a\textquotesingle{}\}\_L1, Q\^{}\{a,a\textquotesingle{}\}\_M1, Q\^{}\{a,a\textquotesingle{}\}\_R1}
\DocumentationTok{\#\# 2.a) Obtain Q\^{}\{a,a\textquotesingle{}\}\_L1}
\CommentTok{\# Regress Q\^{}\{a,a\textquotesingle{}\}\_R2 on observed values (L(0),A,L(1),M)}
\NormalTok{L1.model.death }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Q.death\_R2 }\SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+}\NormalTok{ L1 }\SpecialCharTok{+}
\NormalTok{                        M\_diabetes }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5}\SpecialCharTok{:}\NormalTok{M\_diabetes,}
                      \AttributeTok{family =} \StringTok{"binomial"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df2\_int)}
\NormalTok{L1.model.qol }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Q.qol\_R2 }\SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+}\NormalTok{ L1 }\SpecialCharTok{+}
\NormalTok{                      M\_diabetes }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5}\SpecialCharTok{:}\NormalTok{M\_diabetes,}
                    \AttributeTok{family =} \StringTok{"gaussian"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df2\_int)}

\CommentTok{\# Evaluate the fitted function at the observed mediator M and covariate history L(1),L(0)}
\CommentTok{\# and the intervened exposure A = a}
\NormalTok{data.Ais0 }\OtherTok{\textless{}{-}}\NormalTok{ data.Ais1 }\OtherTok{\textless{}{-}}\NormalTok{ df2\_int}
\NormalTok{data.Ais0}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \OtherTok{\textless{}{-}} \DecValTok{0}
\NormalTok{data.Ais1}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \OtherTok{\textless{}{-}} \DecValTok{1}

\CommentTok{\# We will need 3 counterfactual quantities Q\^{}\{a,a\textquotesingle{}\}: Q\^{}\{1,1\}, Q\^{}\{1,0\} and Q\^{}\{0,0\}}
\NormalTok{Q11.death.L1 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(L1.model.death, }\AttributeTok{newdata =}\NormalTok{ data.Ais1, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}
\NormalTok{Q10.death.L1 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(L1.model.death, }\AttributeTok{newdata =}\NormalTok{ data.Ais1, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}
\NormalTok{Q00.death.L1 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(L1.model.death, }\AttributeTok{newdata =}\NormalTok{ data.Ais0, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}

\NormalTok{Q11.qol.L1 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(L1.model.qol, }\AttributeTok{newdata =}\NormalTok{ data.Ais1, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}
\NormalTok{Q10.qol.L1 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(L1.model.qol, }\AttributeTok{newdata =}\NormalTok{ data.Ais1, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}
\NormalTok{Q00.qol.L1 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(L1.model.qol, }\AttributeTok{newdata =}\NormalTok{ data.Ais0, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}

\DocumentationTok{\#\# 2.b) Obtain Q\^{}\{a,a\textquotesingle{}\}\_M1}
\CommentTok{\# Regress Q\^{}\{a,a\textquotesingle{}\}\_L1 on observed values (L(0),A,L(1))}
\NormalTok{M1.model.death}\FloatTok{.11} \OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Q11.death.L1 }\SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+}\NormalTok{ L1,}
                         \AttributeTok{family =} \StringTok{"quasibinomial"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df2\_int)}
\NormalTok{M1.model.death}\FloatTok{.10} \OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Q10.death.L1 }\SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+}\NormalTok{ L1,}
                         \AttributeTok{family =} \StringTok{"quasibinomial"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df2\_int)}
\NormalTok{M1.model.death}\FloatTok{.00} \OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Q00.death.L1 }\SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+}\NormalTok{ L1,}
                         \AttributeTok{family =} \StringTok{"quasibinomial"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df2\_int)}

\NormalTok{M1.model.qol}\FloatTok{.11} \OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Q11.qol.L1 }\SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+}\NormalTok{ L1,}
                       \AttributeTok{family =} \StringTok{"gaussian"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df2\_int)}
\NormalTok{M1.model.qol}\FloatTok{.10} \OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Q10.qol.L1 }\SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+}\NormalTok{ L1,}
                       \AttributeTok{family =} \StringTok{"gaussian"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df2\_int)}
\NormalTok{M1.model.qol}\FloatTok{.00} \OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Q00.qol.L1 }\SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+}\NormalTok{ L1,}
                       \AttributeTok{family =} \StringTok{"gaussian"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df2\_int)}

\CommentTok{\# Evaluate the fitted function at the observed covariate history L(1),L(0)}
\CommentTok{\# and the intervened exposure A = a\textquotesingle{}}
\NormalTok{Q11.death.M1 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(M1.model.death}\FloatTok{.11}\NormalTok{, }\AttributeTok{newdata =}\NormalTok{ data.Ais1, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}
\NormalTok{Q10.death.M1 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(M1.model.death}\FloatTok{.10}\NormalTok{, }\AttributeTok{newdata =}\NormalTok{ data.Ais0, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}
\NormalTok{Q00.death.M1 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(M1.model.death}\FloatTok{.00}\NormalTok{, }\AttributeTok{newdata =}\NormalTok{ data.Ais0, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}

\NormalTok{Q11.qol.M1 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(M1.model.qol}\FloatTok{.11}\NormalTok{, }\AttributeTok{newdata =}\NormalTok{ data.Ais1, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}
\NormalTok{Q10.qol.M1 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(M1.model.qol}\FloatTok{.10}\NormalTok{, }\AttributeTok{newdata =}\NormalTok{ data.Ais0, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}
\NormalTok{Q00.qol.M1 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(M1.model.qol}\FloatTok{.00}\NormalTok{, }\AttributeTok{newdata =}\NormalTok{ data.Ais0, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}

\DocumentationTok{\#\# 2.c) Obtain Q\^{}\{a,a\textquotesingle{}\}\_R1}
\CommentTok{\# Regress Q\^{}\{a,a\textquotesingle{}\}\_M1 on observed values (L(0),A)}
\NormalTok{R1.model.death}\FloatTok{.11} \OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Q11.death.M1 }\SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5}\NormalTok{,}
                         \AttributeTok{family =} \StringTok{"quasibinomial"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df2\_int)}
\NormalTok{R1.model.death}\FloatTok{.10} \OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Q10.death.M1 }\SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5}\NormalTok{,}
                         \AttributeTok{family =} \StringTok{"quasibinomial"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df2\_int)}
\NormalTok{R1.model.death}\FloatTok{.00} \OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Q00.death.M1 }\SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5}\NormalTok{,}
                         \AttributeTok{family =} \StringTok{"quasibinomial"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df2\_int)}

\NormalTok{R1.model.qol}\FloatTok{.11} \OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Q11.qol.M1 }\SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5}\NormalTok{,}
                       \AttributeTok{family =} \StringTok{"gaussian"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df2\_int)}
\NormalTok{R1.model.qol}\FloatTok{.10} \OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Q10.qol.M1 }\SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5}\NormalTok{,}
                       \AttributeTok{family =} \StringTok{"gaussian"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df2\_int)}
\NormalTok{R1.model.qol}\FloatTok{.00} \OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Q00.qol.M1 }\SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5}\NormalTok{,}
                       \AttributeTok{family =} \StringTok{"gaussian"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df2\_int)}

\CommentTok{\# Evaluate the fitted function at the observed covariate history L(0)}
\CommentTok{\# and the intervened exposure A = a}
\NormalTok{Q11.death.R1 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(R1.model.death}\FloatTok{.11}\NormalTok{, }\AttributeTok{newdata =}\NormalTok{ data.Ais1, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}
\NormalTok{Q10.death.R1 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(R1.model.death}\FloatTok{.10}\NormalTok{, }\AttributeTok{newdata =}\NormalTok{ data.Ais1, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}
\NormalTok{Q00.death.R1 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(R1.model.death}\FloatTok{.00}\NormalTok{, }\AttributeTok{newdata =}\NormalTok{ data.Ais0, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}

\NormalTok{Q11.qol.R1 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(R1.model.qol}\FloatTok{.11}\NormalTok{, }\AttributeTok{newdata =}\NormalTok{ data.Ais1, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}
\NormalTok{Q10.qol.R1 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(R1.model.qol}\FloatTok{.10}\NormalTok{, }\AttributeTok{newdata =}\NormalTok{ data.Ais1, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}
\NormalTok{Q00.qol.R1 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(R1.model.qol}\FloatTok{.00}\NormalTok{, }\AttributeTok{newdata =}\NormalTok{ data.Ais0, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}

\DocumentationTok{\#\# 4) Estimate the Conditional Randomized Direct and Indirect Effects}
\DocumentationTok{\#\# For death}
\NormalTok{CRDE.death }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(Q10.death.R1) }\SpecialCharTok{{-}} \FunctionTok{mean}\NormalTok{(Q00.death.R1)}
\NormalTok{CRDE.death}
\CommentTok{\# [1] 0.07585836}
\NormalTok{CRIE.death }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(Q11.death.R1) }\SpecialCharTok{{-}} \FunctionTok{mean}\NormalTok{(Q10.death.R1)}
\NormalTok{CRIE.death}
\CommentTok{\# [1] 0.006802907}

\DocumentationTok{\#\# For quality of life}
\NormalTok{CRDE.qol }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(Q10.qol.R1) }\SpecialCharTok{{-}} \FunctionTok{mean}\NormalTok{(Q00.qol.R1)}
\NormalTok{CRDE.qol}
\CommentTok{\# [1] {-}7.278295}
\NormalTok{CRIE.qol }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(Q11.qol.R1) }\SpecialCharTok{{-}} \FunctionTok{mean}\NormalTok{(Q10.qol.R1)}
\NormalTok{CRIE.qol}
\CommentTok{\# [1] {-}1.015901}
\end{Highlighting}
\end{Shaded}

Results are close to the estimations obtained previously with parametric g-computation.

\begin{itemize}
\tightlist
\item
  the conditional ``randomized'' Natural Indirect effect is \(\text{CRIE} \approx +0.7\%\) on death and \(\text{CRIE} \approx -1.0\) on quality of life. This indirect effect corresponds to the specific path \(A \rightarrow M \rightarrow Y\) (and can also contain the mediated interactive effect of due to the \(A \ast M\) interaction on \(Y\)).
\item
  the conditional ``randomized'' Natural Direct effect is \(\text{CRDE} \approx +7.6\%\) on death and \(\text{CRDE} \approx -7.3\) on quality of life. This direct effect corresponds to the combination of the paths \(A \rightarrow Y\), \(A \rightarrow L(1) \rightarrow Y\) and \(A \rightarrow L(1) \rightarrow M \rightarrow Y\).
\end{itemize}

95\% confidence intervals can be calculated by bootstrap.

\chapter{Inverse Probability of Treatment Weighting (IPTW)}\label{ChapIptw}

\section{Estimation of the Average total effect}\label{estimation-of-the-average-total-effect}

\subsection{IPTW for the ATE}\label{iptw-for-the-ate}

If the average total effect (ATE) is identifiable, \(\Psi_{ATE} = \mathbb{E}(Y_{A=1}) - \mathbb{E}(Y_{A=0})\) can be expressed using Inverse probability of treatment weighting (IPTW), denoting \(\mathbb{P}(A=a \mid L(0)) = g(A=a \mid L(0))\):
\begin{equation}
\Psi_{ATE} = \mathbb{E}\left( \frac{\mathbb{I}(A=1)}{g(A=1 \mid L(0))} Y \right) - \mathbb{E}\left( \frac{\mathbb{I}(A=0)}{g(A=0 \mid L(0))} Y \right)
\end{equation}

The following steps describe the implementation of the IPTW estimator

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Estimate the treatment mechanism \(g(A=1 \mid L(0))\)
\item
  Predict each individual's probability of being exposed to her own exposure
\item
  Apply weights corresponding to the inverse of the predicted probability \(w_i = \frac{1}{\hat{g}(A = a_i \mid L(0)_i)}\)
\item
  Use the empirical mean of the weighted outcome \(Y\): \(\hat{\mathbb{E}}(Y_a) = \frac{1}{n} \sum_{i=1}^n \frac{\mathbb{I}(A_i=a)}{\hat{g}(A=a_i \mid L(0)_i)} Y_i\)
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# 1. Estimate g}
\NormalTok{g.L }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(A0\_PM2}\FloatTok{.5} \SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env, }
           \AttributeTok{family =} \StringTok{"binomial"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df2\_int)}

\DocumentationTok{\#\# 2. Predict each individual\textquotesingle{}s probability of being exposed to her own exposure}
\CommentTok{\# predict the probabilities P(A0\_PM2.5=1|L(0)) \& P(A0\_PM2.5=0|L(0))}
\NormalTok{pred.g1.L }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(g.L, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)}
\NormalTok{pred.g0.L }\OtherTok{\textless{}{-}} \DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ pred.g1.L}
\CommentTok{\# the predicted probability of the observed treatment A=a\_i is :}
\NormalTok{gA.L }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{, }\FunctionTok{nrow}\NormalTok{(df2\_int))}
\NormalTok{gA.L[df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \SpecialCharTok{==} \DecValTok{1}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ pred.g1.L[df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \SpecialCharTok{==} \DecValTok{1}\NormalTok{]}
\NormalTok{gA.L[df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \SpecialCharTok{==} \DecValTok{0}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ pred.g0.L[df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \SpecialCharTok{==} \DecValTok{0}\NormalTok{]}

\DocumentationTok{\#\# 3. Apply weights corresponding to the inverse of the predicted probability}
\NormalTok{wt }\OtherTok{\textless{}{-}} \DecValTok{1} \SpecialCharTok{/}\NormalTok{ gA.L}

\DocumentationTok{\#\# 4. Use the empirical mean of the weighted outcome}
\CommentTok{\# point estimates:}
\NormalTok{IPTW.death }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(wt }\SpecialCharTok{*} \FunctionTok{as.numeric}\NormalTok{(df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \SpecialCharTok{==} \DecValTok{1}\NormalTok{) }\SpecialCharTok{*}\NormalTok{ df2\_int}\SpecialCharTok{$}\NormalTok{Y\_death) }\SpecialCharTok{{-}}
  \FunctionTok{mean}\NormalTok{(wt }\SpecialCharTok{*} \FunctionTok{as.numeric}\NormalTok{(df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \SpecialCharTok{==} \DecValTok{0}\NormalTok{) }\SpecialCharTok{*}\NormalTok{ df2\_int}\SpecialCharTok{$}\NormalTok{Y\_death)}
\NormalTok{IPTW.death}
\CommentTok{\# [1] 0.08224947}

\NormalTok{IPTW.qol }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(wt }\SpecialCharTok{*} \FunctionTok{as.numeric}\NormalTok{(df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \SpecialCharTok{==} \DecValTok{1}\NormalTok{) }\SpecialCharTok{*}\NormalTok{ df2\_int}\SpecialCharTok{$}\NormalTok{Y\_qol) }\SpecialCharTok{{-}}
  \FunctionTok{mean}\NormalTok{(wt }\SpecialCharTok{*} \FunctionTok{as.numeric}\NormalTok{(df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \SpecialCharTok{==} \DecValTok{0}\NormalTok{) }\SpecialCharTok{*}\NormalTok{ df2\_int}\SpecialCharTok{$}\NormalTok{Y\_qol)}
\NormalTok{IPTW.qol}
\CommentTok{\# [1] {-}8.436797}
\end{Highlighting}
\end{Shaded}

The ATE estimates using IPTW for death probability and mean quality of life are respectively +8.2\% and -8.44.

\subsection{Stabilized IPTW for the ATE}\label{stabilized-iptw-for-the-ate}

If the average total effect (ATE) is identifiable, \(\Psi_{ATE}\) can be estimated using a stabilized IPTW estimator:
\begin{equation}
\hat{\mathbb{E}}(Y_1) - \hat{\mathbb{E}}(Y_0) =  \frac{\frac{1}{n} \sum_{i=1}^n \frac{\mathbb{I}(A_i=1)\hat{g}^*(A_i=1)}{\hat{g}(A_i=1 \mid L(0)_i)} Y_i}{ \frac{1}{n} \sum_{i=1}^n \frac{\mathbb{I}(A_i=1)\hat{g}^*(A_i=1)}{\hat{g}(A_i=1 \mid L(0)_i)}} - \frac{\frac{1}{n} \sum_{i=1}^n \frac{\mathbb{I}(A_i=0)\hat{g}^*(A_i=0)}{\hat{g}(A_i=0 \mid L(0)_i)} Y_i}{ \frac{1}{n} \sum_{i=1}^n \frac{\mathbb{I}(A_i=0)\hat{g}^*(A_i=0)}{\hat{g}(A_i=0 \mid L(0)_i)}}
\end{equation}
The estimation algorithm is the same as for IPTW, but taking into account any non-null function of \(A\) (\(g^*(A_i=a)\)) in the denominator of the weight in step 3, and applying the stabilized estimator in step 4.

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# 3. For example, applying g\^{}*(A) = 1}
\DocumentationTok{\#\# 4. Applying the stabilized estimator}
\CommentTok{\# point estimates:}
\NormalTok{s.IPTW.death }\OtherTok{\textless{}{-}}\NormalTok{ (}\FunctionTok{mean}\NormalTok{(wt }\SpecialCharTok{*} \FunctionTok{as.numeric}\NormalTok{(df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \SpecialCharTok{==} \DecValTok{1}\NormalTok{) }\SpecialCharTok{*}\NormalTok{ df2\_int}\SpecialCharTok{$}\NormalTok{Y\_death) }\SpecialCharTok{/}
                   \FunctionTok{mean}\NormalTok{(wt }\SpecialCharTok{*} \FunctionTok{as.numeric}\NormalTok{(df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \SpecialCharTok{==} \DecValTok{1}\NormalTok{))) }\SpecialCharTok{{-}}
\NormalTok{  (}\FunctionTok{mean}\NormalTok{(wt }\SpecialCharTok{*} \FunctionTok{as.numeric}\NormalTok{(df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \SpecialCharTok{==} \DecValTok{0}\NormalTok{) }\SpecialCharTok{*}\NormalTok{ df2\_int}\SpecialCharTok{$}\NormalTok{Y\_death) }\SpecialCharTok{/}
     \FunctionTok{mean}\NormalTok{(wt }\SpecialCharTok{*} \FunctionTok{as.numeric}\NormalTok{(df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \SpecialCharTok{==} \DecValTok{0}\NormalTok{)))}
\NormalTok{s.IPTW.death}
\CommentTok{\# [1] 0.08294185}

\NormalTok{s.IPTW.qol }\OtherTok{\textless{}{-}}\NormalTok{ (}\FunctionTok{mean}\NormalTok{(wt }\SpecialCharTok{*} \FunctionTok{as.numeric}\NormalTok{(df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \SpecialCharTok{==} \DecValTok{1}\NormalTok{) }\SpecialCharTok{*}\NormalTok{ df2\_int}\SpecialCharTok{$}\NormalTok{Y\_qol) }\SpecialCharTok{/}
                 \FunctionTok{mean}\NormalTok{(wt }\SpecialCharTok{*} \FunctionTok{as.numeric}\NormalTok{(df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \SpecialCharTok{==} \DecValTok{1}\NormalTok{))) }\SpecialCharTok{{-}}
\NormalTok{  (}\FunctionTok{mean}\NormalTok{(wt }\SpecialCharTok{*} \FunctionTok{as.numeric}\NormalTok{(df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \SpecialCharTok{==} \DecValTok{0}\NormalTok{) }\SpecialCharTok{*}\NormalTok{ df2\_int}\SpecialCharTok{$}\NormalTok{Y\_qol) }\SpecialCharTok{/}
     \FunctionTok{mean}\NormalTok{(wt }\SpecialCharTok{*} \FunctionTok{as.numeric}\NormalTok{(df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \SpecialCharTok{==} \DecValTok{0}\NormalTok{)))}
\NormalTok{s.IPTW.qol}
\CommentTok{\# [1] {-}8.291992}
\end{Highlighting}
\end{Shaded}

The ATE estimates using stabilized IPTW for death probability and mean quality of life are respectively +8.3\% and -8.29.

\section{Estimation of the Controlled direct effect (CDE)}\label{estimation-of-the-controlled-direct-effect-cde}

\subsection{IPTW for the CDE}\label{iptw-for-the-cde}

If the controlled direct effect (CDE) is identifiable, \(\Psi^{\text{CDE}_m} = \mathbb{E}(Y_{A=1,M=m}) - \mathbb{E}(Y_{A=0,M=m})\) can be expressed by the basic Horvitz Thompson estimator (using Inverse probability of treatment weighting (IPTW)), denoting \(\mathbb{P}\left(A=a \mid L(0)) = g(A=a \mid L(0)\right)\) and \(\mathbb{P}\left(M=m \mid L(0),A,L(1)) = g(M=m \mid L(0),A,L(1)\right)\):
\begin{equation}
\small
\Psi^{\text{CDE}_m} = \mathbb{E}\left[ \frac{\mathbb{I}(A=1 \cap M=m)}{g(A=1 \mid L(0)) \times g(M=m \mid L(0),A,L(1))} Y \right] - \mathbb{E}\left[ \frac{\mathbb{I}(A=0 \cap M=m)}{g(A=0 \mid L(0)) \times g(M=m \mid L(0),A,L(1))} Y \right]
\end{equation}

The following steps describe the implementation of the IPTW estimator

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Estimate the treatment mechanisms \(g\left(A=1 \mid L(0)\right)\) and \(g\left(M=1 \mid L(0),A,L(1)\right)\)
\item
  Predict each individual's probability of being exposed to her own exposure
\item
  Apply weights corresponding to the inverse of the predicted probability \(w_{A_i} = \frac{1}{\hat{g}(A = a_i \mid L(0)_i)}\) and \(w_{M_i} = \frac{1}{\hat{g}(M = m_i \mid L(0)_i,A_i,L(1)_i)}\)
\item
  Use the empirical mean of the weighted outcome \(Y\): \(\hat{\mathbb{E}}(Y_{a,m}) = \frac{1}{n} \sum_{i=1}^n \frac{\mathbb{I}(A_i=a \cap M_i=m)}{\hat{g}(A=a_i \mid L(0)_i) \times \hat{g}(M=m_i \mid L(0)_i,A_i,L(1)_i)} Y_i\)
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# 1. Estimate gA and gM}
\NormalTok{gA.L }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(A0\_PM2}\FloatTok{.5} \SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env, }
            \AttributeTok{family =} \StringTok{"binomial"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df2\_int)}
\NormalTok{gM.L }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(M\_diabetes }\SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+}\NormalTok{ L1, }
            \AttributeTok{family =} \StringTok{"binomial"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df2\_int)}

\DocumentationTok{\#\# 2. Predict each individual\textquotesingle{}s probability of being exposed to her own exposure}
\CommentTok{\# predict the probabilities P(A0\_PM2.5=1|L(0)) \& P(A0\_PM2.5=0|L(0))}
\NormalTok{pred.gA1.L }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(gA.L, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}
\NormalTok{pred.gA0.L }\OtherTok{\textless{}{-}} \DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ pred.gA1.L}
\CommentTok{\# the predicted probability of the observed treatment A\_i=a is :}
\NormalTok{gAobs.L }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{, }\FunctionTok{nrow}\NormalTok{(df2\_int))}
\NormalTok{gAobs.L[df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \SpecialCharTok{==} \DecValTok{1}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ pred.gA1.L[df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \SpecialCharTok{==} \DecValTok{1}\NormalTok{]}
\NormalTok{gAobs.L[df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \SpecialCharTok{==} \DecValTok{0}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ pred.gA0.L[df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \SpecialCharTok{==} \DecValTok{0}\NormalTok{]}

\CommentTok{\# predict the probabilities P(M=1|L(0),A,L(1)) \& P(M=0|L(0),A,L(1))}
\NormalTok{pred.gM1.L }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(gM.L, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}
\NormalTok{pred.gM0.L }\OtherTok{\textless{}{-}} \DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ pred.gM1.L}
\CommentTok{\# the predicted probability of the observed treatment M\_i=m is :}
\NormalTok{gMobs.L }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{, }\FunctionTok{nrow}\NormalTok{(df2\_int))}
\NormalTok{gMobs.L[df2\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes }\SpecialCharTok{==} \DecValTok{1}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ pred.gM1.L[df2\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes }\SpecialCharTok{==} \DecValTok{1}\NormalTok{]}
\NormalTok{gMobs.L[df2\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes }\SpecialCharTok{==} \DecValTok{0}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ pred.gM0.L[df2\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes }\SpecialCharTok{==} \DecValTok{0}\NormalTok{]}

\DocumentationTok{\#\# 3. Apply weights corresponding to the inverse of the predicted probability}
\NormalTok{wt\_A }\OtherTok{\textless{}{-}} \DecValTok{1} \SpecialCharTok{/}\NormalTok{ gAobs.L}
\NormalTok{wt\_M }\OtherTok{\textless{}{-}} \DecValTok{1} \SpecialCharTok{/}\NormalTok{ gMobs.L}
\NormalTok{wt }\OtherTok{\textless{}{-}}\NormalTok{ wt\_A }\SpecialCharTok{*}\NormalTok{ wt\_M}

\DocumentationTok{\#\# 4. Use the empirical mean of the weighted outcome}
\CommentTok{\# point estimates of CDE, setting M=0}
\NormalTok{CDE\_IPTW\_m0\_death }\OtherTok{\textless{}{-}}\NormalTok{ (}\FunctionTok{mean}\NormalTok{(wt }\SpecialCharTok{*} \FunctionTok{as.numeric}\NormalTok{(df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \SpecialCharTok{==} \DecValTok{1} \SpecialCharTok{\&} 
\NormalTok{                                             df2\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes }\SpecialCharTok{==} \DecValTok{0}\NormalTok{) }\SpecialCharTok{*} 
\NormalTok{                             df2\_int}\SpecialCharTok{$}\NormalTok{Y\_death) }\SpecialCharTok{{-}}
                        \FunctionTok{mean}\NormalTok{(wt }\SpecialCharTok{*} \FunctionTok{as.numeric}\NormalTok{(df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&} 
\NormalTok{                                               df2\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes }\SpecialCharTok{==} \DecValTok{0}\NormalTok{) }\SpecialCharTok{*} 
\NormalTok{                               df2\_int}\SpecialCharTok{$}\NormalTok{Y\_death))}
\NormalTok{CDE\_IPTW\_m0\_death}
\CommentTok{\# [1] 0.05874684}

\NormalTok{CDE\_IPTW\_m0\_qol }\OtherTok{\textless{}{-}}\NormalTok{ (}\FunctionTok{mean}\NormalTok{(wt }\SpecialCharTok{*} \FunctionTok{as.numeric}\NormalTok{(df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \SpecialCharTok{==} \DecValTok{1} \SpecialCharTok{\&} 
\NormalTok{                                           df2\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes }\SpecialCharTok{==} \DecValTok{0}\NormalTok{) }\SpecialCharTok{*} 
\NormalTok{                           df2\_int}\SpecialCharTok{$}\NormalTok{Y\_qol) }\SpecialCharTok{{-}}
                      \FunctionTok{mean}\NormalTok{(wt }\SpecialCharTok{*} \FunctionTok{as.numeric}\NormalTok{(df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&} 
\NormalTok{                                             df2\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes }\SpecialCharTok{==} \DecValTok{0}\NormalTok{) }\SpecialCharTok{*} 
\NormalTok{                             df2\_int}\SpecialCharTok{$}\NormalTok{Y\_qol))}
\NormalTok{CDE\_IPTW\_m0\_qol}
\CommentTok{\# [1] {-}5.341138}

\CommentTok{\# point estimates of CDE, setting M=1}
\NormalTok{CDE\_IPTW\_m1\_death }\OtherTok{\textless{}{-}}\NormalTok{ (}\FunctionTok{mean}\NormalTok{(wt }\SpecialCharTok{*} \FunctionTok{as.numeric}\NormalTok{(df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \SpecialCharTok{==} \DecValTok{1} \SpecialCharTok{\&} 
\NormalTok{                                             df2\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes }\SpecialCharTok{==} \DecValTok{1}\NormalTok{) }\SpecialCharTok{*} 
\NormalTok{                             df2\_int}\SpecialCharTok{$}\NormalTok{Y\_death) }\SpecialCharTok{{-}}
                        \FunctionTok{mean}\NormalTok{(wt }\SpecialCharTok{*} \FunctionTok{as.numeric}\NormalTok{(df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&} 
\NormalTok{                                               df2\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes }\SpecialCharTok{==} \DecValTok{1}\NormalTok{) }\SpecialCharTok{*} 
\NormalTok{                               df2\_int}\SpecialCharTok{$}\NormalTok{Y\_death))}
\NormalTok{CDE\_IPTW\_m1\_death}
\CommentTok{\# [1] 0.101733}

\NormalTok{CDE\_IPTW\_m1\_qol }\OtherTok{\textless{}{-}}\NormalTok{ (}\FunctionTok{mean}\NormalTok{(wt }\SpecialCharTok{*} \FunctionTok{as.numeric}\NormalTok{(df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \SpecialCharTok{==} \DecValTok{1} \SpecialCharTok{\&} 
\NormalTok{                                           df2\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes }\SpecialCharTok{==} \DecValTok{1}\NormalTok{) }\SpecialCharTok{*} 
\NormalTok{                           df2\_int}\SpecialCharTok{$}\NormalTok{Y\_qol) }\SpecialCharTok{{-}}
                      \FunctionTok{mean}\NormalTok{(wt }\SpecialCharTok{*} \FunctionTok{as.numeric}\NormalTok{(df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&} 
\NormalTok{                                             df2\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes }\SpecialCharTok{==} \DecValTok{1}\NormalTok{) }\SpecialCharTok{*} 
\NormalTok{                             df2\_int}\SpecialCharTok{$}\NormalTok{Y\_qol))}
\NormalTok{CDE\_IPTW\_m1\_qol}
\CommentTok{\# [1] {-}8.185866}
\end{Highlighting}
\end{Shaded}

\subsection{Stabilized IPTW for the CDE}\label{stabilized-iptw-for-the-cde}

If the controlled dired effect (CDE) is identifiable, \(\Psi^{CDE}\) can be estimated using a stabilized IPTW estimator (modified Horvitz Thompson estimator):
\begin{equation}
\small
\hat{\mathbb{E}}(Y_{1,m}) - \hat{\mathbb{E}}(Y_{0,m}) =  \frac{ \sum_{i=1}^n \frac{\mathbb{I}(A_i=1 \cap M_i=m)}{\hat{g}(A_i=1 \mid L(0)_i) \times \hat{g}(M_i=m \mid L(0)_i,A_i,L(1)_i)} Y_i}{\sum_{i=1}^n \frac{\mathbb{I}(A_i=1 \cap M_i=m)}{\hat{g}(A_i=1 \mid L(0)_i) \hat{g}(M_i=m \mid L(0)_i,A_i,L(1)_i)}} - \frac{ \sum_{i=1}^n \frac{\mathbb{I}(A_i=0 \cap M_i=m)}{\hat{g}(A_i=0 \mid L(0)_i) \times \hat{g}(M_i=m \mid L(0)_i,A_i,L(1)_i)} Y_i}{ \sum_{i=1}^n \frac{\mathbb{I}(A_i=0 \cap M_i=m)}{\hat{g}(A_i=0 \mid L(0)_i) \times \hat{g}(M_i=m \mid L(0)_i,A_i,L(1)_i)}}
\end{equation}
The estimation algorithm is the same as for IPTW, but applying the stabilized estimator in step 4.

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# 4. Applying the stabilized estimator}
\CommentTok{\# point estimates of CDE, setting M=0:}
\NormalTok{CDE\_sIPTW\_m0\_death }\OtherTok{\textless{}{-}}\NormalTok{ (}\FunctionTok{mean}\NormalTok{(wt }\SpecialCharTok{*} \FunctionTok{as.numeric}\NormalTok{(df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \SpecialCharTok{==} \DecValTok{1} \SpecialCharTok{\&} 
\NormalTok{                                              df2\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes }\SpecialCharTok{==} \DecValTok{0}\NormalTok{) }\SpecialCharTok{*} 
\NormalTok{                              df2\_int}\SpecialCharTok{$}\NormalTok{Y\_death) }\SpecialCharTok{/} 
                         \FunctionTok{mean}\NormalTok{(wt }\SpecialCharTok{*} \FunctionTok{as.numeric}\NormalTok{(df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \SpecialCharTok{==} \DecValTok{1} \SpecialCharTok{\&} 
\NormalTok{                                                df2\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes }\SpecialCharTok{==} \DecValTok{0}\NormalTok{))) }\SpecialCharTok{{-}}
\NormalTok{                         (}\FunctionTok{mean}\NormalTok{(wt }\SpecialCharTok{*} \FunctionTok{as.numeric}\NormalTok{(df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \SpecialCharTok{==} \DecValTok{0} \SpecialCharTok{\&} 
\NormalTok{                                              df2\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes }\SpecialCharTok{==} \DecValTok{0}\NormalTok{) }\SpecialCharTok{*} 
\NormalTok{                              df2\_int}\SpecialCharTok{$}\NormalTok{Y\_death) }\SpecialCharTok{/} 
                         \FunctionTok{mean}\NormalTok{(wt }\SpecialCharTok{*} \FunctionTok{as.numeric}\NormalTok{(df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \SpecialCharTok{==} \DecValTok{0} \SpecialCharTok{\&} 
\NormalTok{                                                df2\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes }\SpecialCharTok{==} \DecValTok{0}\NormalTok{)))}
\NormalTok{CDE\_sIPTW\_m0\_death}
\CommentTok{\# [1] 0.0601292}

\NormalTok{CDE\_sIPTW\_m0\_qol }\OtherTok{\textless{}{-}}\NormalTok{ (}\FunctionTok{mean}\NormalTok{(wt }\SpecialCharTok{*} \FunctionTok{as.numeric}\NormalTok{(df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \SpecialCharTok{==} \DecValTok{1} \SpecialCharTok{\&} 
\NormalTok{                                              df2\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes }\SpecialCharTok{==} \DecValTok{0}\NormalTok{) }\SpecialCharTok{*} 
\NormalTok{                              df2\_int}\SpecialCharTok{$}\NormalTok{Y\_qol) }\SpecialCharTok{/} 
                         \FunctionTok{mean}\NormalTok{(wt }\SpecialCharTok{*} \FunctionTok{as.numeric}\NormalTok{(df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \SpecialCharTok{==} \DecValTok{1} \SpecialCharTok{\&} 
\NormalTok{                                                df2\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes }\SpecialCharTok{==} \DecValTok{0}\NormalTok{))) }\SpecialCharTok{{-}}
\NormalTok{                         (}\FunctionTok{mean}\NormalTok{(wt }\SpecialCharTok{*} \FunctionTok{as.numeric}\NormalTok{(df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \SpecialCharTok{==} \DecValTok{0} \SpecialCharTok{\&} 
\NormalTok{                                              df2\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes }\SpecialCharTok{==} \DecValTok{0}\NormalTok{) }\SpecialCharTok{*} 
\NormalTok{                              df2\_int}\SpecialCharTok{$}\NormalTok{Y\_qol) }\SpecialCharTok{/} 
                         \FunctionTok{mean}\NormalTok{(wt }\SpecialCharTok{*} \FunctionTok{as.numeric}\NormalTok{(df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \SpecialCharTok{==} \DecValTok{0} \SpecialCharTok{\&} 
\NormalTok{                                                df2\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes }\SpecialCharTok{==} \DecValTok{0}\NormalTok{)))}
\NormalTok{CDE\_sIPTW\_m0\_qol}
\CommentTok{\# [1] {-}4.966328}

\CommentTok{\# point estimates of CDE, setting M=1:}
\NormalTok{CDE\_sIPTW\_m1\_death }\OtherTok{\textless{}{-}}\NormalTok{ (}\FunctionTok{mean}\NormalTok{(wt }\SpecialCharTok{*} \FunctionTok{as.numeric}\NormalTok{(df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \SpecialCharTok{==} \DecValTok{1} \SpecialCharTok{\&} 
\NormalTok{                                              df2\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes }\SpecialCharTok{==} \DecValTok{1}\NormalTok{) }\SpecialCharTok{*} 
\NormalTok{                              df2\_int}\SpecialCharTok{$}\NormalTok{Y\_death) }\SpecialCharTok{/} 
                         \FunctionTok{mean}\NormalTok{(wt }\SpecialCharTok{*} \FunctionTok{as.numeric}\NormalTok{(df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \SpecialCharTok{==} \DecValTok{1} \SpecialCharTok{\&} 
\NormalTok{                                                df2\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes }\SpecialCharTok{==} \DecValTok{1}\NormalTok{))) }\SpecialCharTok{{-}}
\NormalTok{                         (}\FunctionTok{mean}\NormalTok{(wt }\SpecialCharTok{*} \FunctionTok{as.numeric}\NormalTok{(df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \SpecialCharTok{==} \DecValTok{0} \SpecialCharTok{\&} 
\NormalTok{                                              df2\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes }\SpecialCharTok{==} \DecValTok{1}\NormalTok{) }\SpecialCharTok{*} 
\NormalTok{                              df2\_int}\SpecialCharTok{$}\NormalTok{Y\_death) }\SpecialCharTok{/} 
                         \FunctionTok{mean}\NormalTok{(wt }\SpecialCharTok{*} \FunctionTok{as.numeric}\NormalTok{(df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \SpecialCharTok{==} \DecValTok{0} \SpecialCharTok{\&} 
\NormalTok{                                                df2\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes }\SpecialCharTok{==} \DecValTok{1}\NormalTok{)))}
\NormalTok{CDE\_sIPTW\_m1\_death}
\CommentTok{\# [1] 0.09030186}

\NormalTok{CDE\_sIPTW\_m1\_qol }\OtherTok{\textless{}{-}}\NormalTok{ (}\FunctionTok{mean}\NormalTok{(wt }\SpecialCharTok{*} \FunctionTok{as.numeric}\NormalTok{(df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \SpecialCharTok{==} \DecValTok{1} \SpecialCharTok{\&} 
\NormalTok{                                              df2\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes }\SpecialCharTok{==} \DecValTok{1}\NormalTok{) }\SpecialCharTok{*} 
\NormalTok{                              df2\_int}\SpecialCharTok{$}\NormalTok{Y\_qol) }\SpecialCharTok{/} 
                         \FunctionTok{mean}\NormalTok{(wt }\SpecialCharTok{*} \FunctionTok{as.numeric}\NormalTok{(df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \SpecialCharTok{==} \DecValTok{1} \SpecialCharTok{\&} 
\NormalTok{                                                df2\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes }\SpecialCharTok{==} \DecValTok{1}\NormalTok{))) }\SpecialCharTok{{-}}
\NormalTok{                         (}\FunctionTok{mean}\NormalTok{(wt }\SpecialCharTok{*} \FunctionTok{as.numeric}\NormalTok{(df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \SpecialCharTok{==} \DecValTok{0} \SpecialCharTok{\&} 
\NormalTok{                                              df2\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes }\SpecialCharTok{==} \DecValTok{1}\NormalTok{) }\SpecialCharTok{*} 
\NormalTok{                              df2\_int}\SpecialCharTok{$}\NormalTok{Y\_qol) }\SpecialCharTok{/} 
                         \FunctionTok{mean}\NormalTok{(wt }\SpecialCharTok{*} \FunctionTok{as.numeric}\NormalTok{(df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \SpecialCharTok{==} \DecValTok{0} \SpecialCharTok{\&} 
\NormalTok{                                                df2\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes }\SpecialCharTok{==} \DecValTok{1}\NormalTok{)))}
\NormalTok{CDE\_sIPTW\_m1\_qol}
\CommentTok{\# [1] {-}10.03045}
\end{Highlighting}
\end{Shaded}

\section{Estimation of ``Conditional'' Randomized/Interventional Natural Direct (CRDE) and Indirect Effects (CRIE)}\label{estimation-of-conditional-randomizedinterventional-natural-direct-crde-and-indirect-effects-crie-1}

\subsection{IPTW for the CRDE and CRIE}\label{iptw-for-the-crde-and-crie}

Zheng and van der Laan (\citeproc{ref-zheng2017longitudinal}{Zheng and van der Laan 2017}) described ``Conditional'' Randomized Direct and Indirect Effects, using random draws from the counterfactual distribution of the mediator, conditional on both \(L(0)\) and \(L(1)\). The Average Total Effect (ATE) can be decomposed into the sum of :

\begin{itemize}
\tightlist
\item
  a Conditional Randomized Natural Direct Effect (CRDE):
  \(\text{CRDE}=\mathbb{E}(Y_{1,\Gamma_{0} \mid L(0),L(1)})-\mathbb{E}(Y_{0,\Gamma_{0} \mid L(0), L(1)})\),
\item
  and Conditional Randomized Natural Indirect Effect (CRIE)
  \(\text{CRIE}=\mathbb{E}(Y_{1,\Gamma_{1} \mid L(0), L(1)})-\mathbb{E}(Y_{1,\Gamma_{0} \mid L(0), L(1)})\).
\end{itemize}

Under the identifiability conditions, the quantity of \(\mathbb{E}(Y_{a,\Gamma_{a^\prime} \mid L(0), L(1)})\) can be estimated by IPTW:
\begin{equation*}
  \Psi^{a,a^\prime}_\text{IPTW} = \mathbb{E}\left[Y_{a,\Gamma_{a^\prime} \mid L(0), L(1)} \right] = \frac{1}{n} \sum_{i=1}^n D_\text{IPTW}^{a,a^\prime}
\end{equation*}
where
\begin{equation*}
  D_\text{IPTW}^{a,a^\prime} = Y \frac{I(A=a)}{p_A(A=a\mid L(0))} \frac{p_M(M \mid A=a^\prime,L(1),L(0))}{p_M(M \mid A=a,L(1),L(0))}
\end{equation*}
and the variance of the estimator \(\Psi^{a,a^\prime}_\text{IPTW}\) is \(\text{var}\left(\Psi^{a,a^\prime}_\text{IPTW}\right) = \frac{\text{var}\left(D_\text{IPTW}^{a,a^\prime}\right)}{n}\), which can be used to estimate 90\% confidence intervals.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{rm}\NormalTok{(}\AttributeTok{list=}\FunctionTok{ls}\NormalTok{())}
\NormalTok{df2\_int }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file =} \StringTok{"./data/df2\_int.csv"}\NormalTok{)}

\DocumentationTok{\#\# In order to estimate Psi\^{}\{a,a\textquotesingle{}\}}
\DocumentationTok{\#\# 1. Estimate gA and gM}
\NormalTok{gA }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(A0\_PM2}\FloatTok{.5} \SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env,}
          \AttributeTok{family =} \StringTok{"binomial"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df2\_int)}
\NormalTok{gM }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(M\_diabetes }\SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+}\NormalTok{ L1,}
          \AttributeTok{family =} \StringTok{"binomial"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df2\_int)}

\DocumentationTok{\#\# 2. Predict each individual\textquotesingle{}s probability of being exposed to her own exposure}
\CommentTok{\# predict the probabilities P(A0\_PM2.5=1|L(0)) \& P(A0\_PM2.5=0|L(0))}
\NormalTok{pred.gA1 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(gA, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}
\NormalTok{pred.gA0 }\OtherTok{\textless{}{-}} \DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ pred.gA1}
\CommentTok{\# the predicted probability of the observed treatment A\_i=a is :}
\NormalTok{gAobs }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{, }\FunctionTok{nrow}\NormalTok{(df2\_int))}
\NormalTok{gAobs[df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \SpecialCharTok{==} \DecValTok{1}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ pred.gA1[df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \SpecialCharTok{==} \DecValTok{1}\NormalTok{]}
\NormalTok{gAobs[df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \SpecialCharTok{==} \DecValTok{0}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ pred.gA0[df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \SpecialCharTok{==} \DecValTok{0}\NormalTok{]}

\CommentTok{\# predict the probabilities}
\CommentTok{\# P(M=1|L(0),A=1,L(1)) \& P(M=0|L(0),A=1,L(1)) setting A = 1}
\CommentTok{\# and P(M=1|L(0),A=0,L(1)) \& P(M=0|L(0),A=0,L(1)) setting A = 0}
\NormalTok{data.Ais0 }\OtherTok{\textless{}{-}}\NormalTok{ data.Ais1 }\OtherTok{\textless{}{-}}\NormalTok{ df2\_int}
\NormalTok{data.Ais0}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \OtherTok{\textless{}{-}} \DecValTok{0}
\NormalTok{data.Ais1}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \OtherTok{\textless{}{-}} \DecValTok{1}

\NormalTok{pred.gM1.Ais1 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(gM, }\AttributeTok{newdata =}\NormalTok{ data.Ais1, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}
\NormalTok{pred.gM0.Ais1 }\OtherTok{\textless{}{-}} \DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ pred.gM1.Ais1}
\CommentTok{\# the predicted probability of the observed treatment M\_i=m is :}
\NormalTok{gMobs.Ais1 }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{, }\FunctionTok{nrow}\NormalTok{(df2\_int))}
\NormalTok{gMobs.Ais1[df2\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes }\SpecialCharTok{==} \DecValTok{1}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ pred.gM1.Ais1[df2\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes }\SpecialCharTok{==} \DecValTok{1}\NormalTok{]}
\NormalTok{gMobs.Ais1[df2\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes }\SpecialCharTok{==} \DecValTok{0}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ pred.gM0.Ais1[df2\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes }\SpecialCharTok{==} \DecValTok{0}\NormalTok{]}

\NormalTok{pred.gM1.Ais0 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(gM, }\AttributeTok{newdata =}\NormalTok{ data.Ais0, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}
\NormalTok{pred.gM0.Ais0 }\OtherTok{\textless{}{-}} \DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ pred.gM1.Ais0}
\CommentTok{\# the predicted probability of the observed treatment M\_i=m is :}
\NormalTok{gMobs.Ais0 }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{, }\FunctionTok{nrow}\NormalTok{(df2\_int))}
\NormalTok{gMobs.Ais0[df2\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes }\SpecialCharTok{==} \DecValTok{1}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ pred.gM1.Ais0[df2\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes }\SpecialCharTok{==} \DecValTok{1}\NormalTok{]}
\NormalTok{gMobs.Ais0[df2\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes }\SpecialCharTok{==} \DecValTok{0}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ pred.gM0.Ais0[df2\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes }\SpecialCharTok{==} \DecValTok{0}\NormalTok{]}

\DocumentationTok{\#\# 3. Calculate D\^{}\{a,a\textquotesingle{}\} {-} influence curve of the IPTW estimator}
\NormalTok{D.death}\FloatTok{.11} \OtherTok{\textless{}{-}}\NormalTok{ (df2\_int}\SpecialCharTok{$}\NormalTok{Y\_death }\SpecialCharTok{*}\NormalTok{ (}\FunctionTok{I}\NormalTok{(df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \SpecialCharTok{==} \DecValTok{1}\NormalTok{) }\SpecialCharTok{/}\NormalTok{ gAobs) }\SpecialCharTok{*}
\NormalTok{                 (gMobs.Ais1 }\SpecialCharTok{/}\NormalTok{ gMobs.Ais1))}
\NormalTok{D.death}\FloatTok{.10} \OtherTok{\textless{}{-}}\NormalTok{ (df2\_int}\SpecialCharTok{$}\NormalTok{Y\_death }\SpecialCharTok{*}\NormalTok{ (}\FunctionTok{I}\NormalTok{(df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \SpecialCharTok{==} \DecValTok{1}\NormalTok{) }\SpecialCharTok{/}\NormalTok{ gAobs) }\SpecialCharTok{*}
\NormalTok{                 (gMobs.Ais0 }\SpecialCharTok{/}\NormalTok{ gMobs.Ais1))}
\NormalTok{D.death}\FloatTok{.00} \OtherTok{\textless{}{-}}\NormalTok{ (df2\_int}\SpecialCharTok{$}\NormalTok{Y\_death }\SpecialCharTok{*}\NormalTok{ (}\FunctionTok{I}\NormalTok{(df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \SpecialCharTok{==} \DecValTok{0}\NormalTok{) }\SpecialCharTok{/}\NormalTok{ gAobs) }\SpecialCharTok{*}
\NormalTok{                 (gMobs.Ais0 }\SpecialCharTok{/}\NormalTok{ gMobs.Ais0))}

\NormalTok{D.qol}\FloatTok{.11} \OtherTok{\textless{}{-}}\NormalTok{ (df2\_int}\SpecialCharTok{$}\NormalTok{Y\_qol }\SpecialCharTok{*}\NormalTok{ (}\FunctionTok{I}\NormalTok{(df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \SpecialCharTok{==} \DecValTok{1}\NormalTok{) }\SpecialCharTok{/}\NormalTok{ gAobs) }\SpecialCharTok{*}
\NormalTok{               (gMobs.Ais1 }\SpecialCharTok{/}\NormalTok{ gMobs.Ais1))}
\NormalTok{D.qol}\FloatTok{.10} \OtherTok{\textless{}{-}}\NormalTok{ (df2\_int}\SpecialCharTok{$}\NormalTok{Y\_qol }\SpecialCharTok{*}\NormalTok{ (}\FunctionTok{I}\NormalTok{(df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \SpecialCharTok{==} \DecValTok{1}\NormalTok{) }\SpecialCharTok{/}\NormalTok{ gAobs) }\SpecialCharTok{*}
\NormalTok{               (gMobs.Ais0 }\SpecialCharTok{/}\NormalTok{ gMobs.Ais1))}
\NormalTok{D.qol}\FloatTok{.00} \OtherTok{\textless{}{-}}\NormalTok{ (df2\_int}\SpecialCharTok{$}\NormalTok{Y\_qol }\SpecialCharTok{*}\NormalTok{ (}\FunctionTok{I}\NormalTok{(df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \SpecialCharTok{==} \DecValTok{0}\NormalTok{) }\SpecialCharTok{/}\NormalTok{ gAobs) }\SpecialCharTok{*}
\NormalTok{               (gMobs.Ais0 }\SpecialCharTok{/}\NormalTok{ gMobs.Ais0))}

\DocumentationTok{\#\# 4. Calculate CRDE and CRIE}
\DocumentationTok{\#\# For death}
\NormalTok{CRDE.death }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(D.death}\FloatTok{.10}\NormalTok{) }\SpecialCharTok{{-}} \FunctionTok{mean}\NormalTok{(D.death}\FloatTok{.00}\NormalTok{)}
\NormalTok{CRDE.death}
\CommentTok{\# [1] 0.07405068}
\NormalTok{CRIE.death }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(D.death}\FloatTok{.11}\NormalTok{) }\SpecialCharTok{{-}} \FunctionTok{mean}\NormalTok{(D.death}\FloatTok{.10}\NormalTok{)}
\NormalTok{CRIE.death}
\CommentTok{\# [1] 0.00819879}

\DocumentationTok{\#\# For quality of life}
\NormalTok{CRDE.qol }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(D.qol}\FloatTok{.10}\NormalTok{) }\SpecialCharTok{{-}} \FunctionTok{mean}\NormalTok{(D.qol}\FloatTok{.00}\NormalTok{)}
\NormalTok{CRDE.qol}
\CommentTok{\# [1] {-}7.563116}
\NormalTok{CRIE.qol }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(D.qol}\FloatTok{.11}\NormalTok{) }\SpecialCharTok{{-}} \FunctionTok{mean}\NormalTok{(D.qol}\FloatTok{.10}\NormalTok{)}
\NormalTok{CRIE.qol}
\CommentTok{\# [1] {-}0.8736813}

\DocumentationTok{\#\# 5. Calculate 95\% CI based on the influence curve D\^{}\{a,a\textquotesingle{}\}}
\CommentTok{\# the variance of the estimator Psi\^{}\{a,a\textquotesingle{}\} = mean(D\^{}\{a,a\textquotesingle{}\}) is var(D\^{}\{a,a\textquotesingle{}\}) / n)}
\NormalTok{se.CRDE.death }\OtherTok{\textless{}{-}} \FunctionTok{sqrt}\NormalTok{(}\FunctionTok{var}\NormalTok{(D.death}\FloatTok{.10} \SpecialCharTok{{-}}\NormalTok{ D.death}\FloatTok{.00}\NormalTok{) }\SpecialCharTok{/} \FunctionTok{nrow}\NormalTok{(df2\_int))}
\FunctionTok{c}\NormalTok{(CRDE.death }\SpecialCharTok{{-}} \FunctionTok{qnorm}\NormalTok{(}\FloatTok{0.975}\NormalTok{) }\SpecialCharTok{*}\NormalTok{ se.CRDE.death,}
\NormalTok{  CRDE.death }\SpecialCharTok{+} \FunctionTok{qnorm}\NormalTok{(}\FloatTok{0.975}\NormalTok{) }\SpecialCharTok{*}\NormalTok{ se.CRDE.death)}
\CommentTok{\# [1] 0.04141535 0.10668602}
\NormalTok{se.CRIE.death }\OtherTok{\textless{}{-}} \FunctionTok{sqrt}\NormalTok{(}\FunctionTok{var}\NormalTok{(D.death}\FloatTok{.11} \SpecialCharTok{{-}}\NormalTok{ D.death}\FloatTok{.10}\NormalTok{) }\SpecialCharTok{/} \FunctionTok{nrow}\NormalTok{(df2\_int))}
\FunctionTok{c}\NormalTok{(CRIE.death }\SpecialCharTok{{-}} \FunctionTok{qnorm}\NormalTok{(}\FloatTok{0.975}\NormalTok{) }\SpecialCharTok{*}\NormalTok{ se.CRIE.death,}
\NormalTok{  CRIE.death }\SpecialCharTok{+} \FunctionTok{qnorm}\NormalTok{(}\FloatTok{0.975}\NormalTok{) }\SpecialCharTok{*}\NormalTok{ se.CRIE.death)}
\CommentTok{\# [1] 0.003380238 0.013017342}

\NormalTok{se.CRDE.qol }\OtherTok{\textless{}{-}} \FunctionTok{sqrt}\NormalTok{(}\FunctionTok{var}\NormalTok{(D.qol}\FloatTok{.10} \SpecialCharTok{{-}}\NormalTok{ D.qol}\FloatTok{.00}\NormalTok{) }\SpecialCharTok{/} \FunctionTok{nrow}\NormalTok{(df2\_int))}
\FunctionTok{c}\NormalTok{(CRDE.qol }\SpecialCharTok{{-}} \FunctionTok{qnorm}\NormalTok{(}\FloatTok{0.975}\NormalTok{) }\SpecialCharTok{*}\NormalTok{ se.CRDE.qol,}
\NormalTok{  CRDE.qol }\SpecialCharTok{+} \FunctionTok{qnorm}\NormalTok{(}\FloatTok{0.975}\NormalTok{) }\SpecialCharTok{*}\NormalTok{ se.CRDE.qol)}
\CommentTok{\# [1] {-}11.748095  {-}3.378137}
\NormalTok{se.CRIE.qol }\OtherTok{\textless{}{-}} \FunctionTok{sqrt}\NormalTok{(}\FunctionTok{var}\NormalTok{(D.qol}\FloatTok{.11} \SpecialCharTok{{-}}\NormalTok{ D.qol}\FloatTok{.10}\NormalTok{) }\SpecialCharTok{/} \FunctionTok{nrow}\NormalTok{(df2\_int))}
\FunctionTok{c}\NormalTok{(CRIE.qol }\SpecialCharTok{{-}} \FunctionTok{qnorm}\NormalTok{(}\FloatTok{0.975}\NormalTok{) }\SpecialCharTok{*}\NormalTok{ se.CRIE.qol,}
\NormalTok{  CRIE.qol }\SpecialCharTok{+} \FunctionTok{qnorm}\NormalTok{(}\FloatTok{0.975}\NormalTok{) }\SpecialCharTok{*}\NormalTok{ se.CRIE.qol)}
\CommentTok{\# [1] {-}1.4111404 {-}0.3362223}
\end{Highlighting}
\end{Shaded}

Results are close to the estimations obtained by g-computation. IPTW estimations are know to be more sensitive to positivity issues, with larger confidence intervals (they can be too conservative with more than 95\% coverage).

\begin{itemize}
\tightlist
\item
  the conditional ``randomized'' Natural Indirect effect is \(\text{CRIE} \approx +0.8\%, \quad 95\%CI=[0.3\%,1.3\%]\) on death and \(\text{CRIE} \approx -0.9, \quad 95\%CI=[-1.4,-0.3]\) on quality of life. This indirect effect corresponds to the specific path \(A \rightarrow M \rightarrow Y\) (and can also contain the mediated interactive effect of due to the \(A \ast M\) interaction on \(Y\)).
\item
  the conditional ``randomized'' Natural Direct effect is \(\text{CRDE} \approx +7.4\, \quad 95\%CI=[4.1\%,10.7\%]\) on death and \(\text{CRDE} \approx -7.6, \quad 95\%CI=[-11.7,-3.4]\) on quality of life. This direct effect corresponds to the combination of the paths \(A \rightarrow Y\), \(A \rightarrow L(1) \rightarrow Y\) and \(A \rightarrow L(1) \rightarrow M \rightarrow Y\).
\end{itemize}

95\% confidence intervals can be calculated by bootstrap.

\chapter{Marginal structural models}\label{msm_chapter}

Marginal structural models (MSM) are parametric models that are used to summarize the relationship between the counterfactual outcome (\(Y_a\) or \(Y_{am}\) for example) and the exposure(s) \(A\) and mediators \(M\). It also possible to summarize the relationship according to a subset of the baseline confounders if it is relevant for the scientific question.

To illustrate the application of MSMs, we will first use the data simulated from the Causal model 1 (with an \(A \ast M\) interaction effect on the outcome) where the exposure \(A\) doesn't affect the confounder \(L(1)\) between the mediator and the outcome.

\section{MSM for the Average Total Effect (ATE)}\label{msm_ATE_paragraph}

\subsection{Expressing the ATE using coefficients of an MSM}\label{expressing-the-ate-using-coefficients-of-an-msm}

For a continuous or binary outcome, we can use the following MSM to summarize the relationship between the counterfactual outcome (\(Y_a\)) and the exposure(s) \(A\):
\begin{equation} 
  \mathbb{E}(Y_a) = \alpha_0 + \alpha_A a 
  \label{eq:MSMATEmarg}
\end{equation}

The Average Total Effect \(\text{ATE} = \mathbb{E}(Y_{A=1}) - \mathbb{E}(Y_{A=0})\) can then be expressed using the coefficients of this MSM \eqref{eq:MSMATEmarg}:
\begin{equation*} 
  \text{ATE} := \left(\alpha_0 + \alpha_A \times 1 \right) - \left(\alpha_0 + \alpha_A \times 0 \right) = \alpha_A 
\end{equation*}

In this example, the coefficient \(\alpha_A\) corresponds to the \(\text{ATE}\).

Such a model is not very useful for a binary exposure. It would be much more useful for higher-dimensional exposures, for example with a continuous exposure, where the relationship between all the possible continuous values of the exposure \(A=a\) and the corresponding outcomes \(Y_a\) is summarized (and arbitrarily simplified) by a single line and the slope coefficient \(\alpha_A\).

It is also possible to define MSMs adjusted for a subset \(V\) of the baseline confounders (\(V \subset L(0)\)). Such MSMs can be useful to estimate conditional effects. For example it is possible to define an average ``conditional'' total effect \(\text{ATE}|L(0)\) (instead of the marginal ATE defined above), projecting the counterfactual outcomes on a parametric model such as the following:

\begin{equation} 
  \mathbb{E}(Y_a \mid L(0)) = \alpha_0 + \alpha_A a + \alpha_\text{male} L_\text{male}(0) + \alpha_\text{soc.env.} L_\text{soc.env.}(0)
  \label{eq:MSMATEcond}
\end{equation}

so that \(\text{ATE} \mid L(0) = \mathbb{E}(Y_{A=1} \mid L(0)) - \mathbb{E}(Y_{A=0} \mid L(0)) = \alpha_A\) using the coefficient from the MSM \eqref{eq:MSMATEcond}.

MSMs are also very useful to study interactions, or effect modification of the exposure \(A\) by a baseline confounder. For example, in order to study the average total effect according to sex, we can use the following MSM:

\begin{equation} 
  \mathbb{E}(Y_a \mid L_\text{male}(0)) = \alpha_0 + \alpha_A a + \alpha_\text{male} L_\text{male}(0) + \alpha_{A \ast L_\text{male}} \left(a \times L_\text{male}(0)\right)
  \label{eq:MSMATEsex}
\end{equation}

and express the average total effect in each strata of sex using the coefficients of the MSM \eqref{eq:MSMATEsex}:

\begin{align*}
 \{\text{ATE} \mid L_\text{male}(0) = 0\} &:= \mathbb{E}(Y_1 \mid L_\text{male}(0) = 0) - \mathbb{E}(Y_0 \mid L_\text{male}(0) = 0) = \alpha_A \\
 \{\text{ATE} \mid L_\text{male}(0) = 1\} &:= \mathbb{E}(Y_1 \mid L_\text{male}(0) = 1) - \mathbb{E}(Y_0 \mid L_\text{male}(0) = 1) = \alpha_A + \alpha_{A \ast L_\text{male}}
\end{align*}

Because MSMs are models of unobserved counterfactual outcomes, estimators of the MSM coefficients are necessary. We will describe two possible approaches : estimation by IPTW or by G-computation.

In both approaches, 95\% confidence intervals can be computed by bootstrap.

\subsection{Estimation of the MSM coefficients by IPTW}\label{estimation-of-the-msm-coefficients-by-iptw}

MSM coefficients can be easily estimated using an Inverse Probability of Treatment (IPTW) approach based on weighted regressions.

For example, in order to fit the MSM \eqref{eq:MSMATEsex} described above, we can use a linear regression of the (observed) outcome \(Y\) on the exposure and sex, weigthed by individual weights \(w_i\) or \(sw_i\):
\begin{equation} 
  \mathbb{E}\left[Y \mid L_\text{male}(0)\right] = \alpha_0 + \alpha_A a + \alpha_\text{male} L_\text{male}(0) + \alpha_{A \ast L_\text{male}} \left(a \times L_\text{male}(0)\right)
\end{equation}

where \(w_i=\frac{1}{P(A=a_i \mid L(0)=l(0)_i)}\) or \(sw_i=\frac{P(A=a_i \mid L_\text{male}(0))}{P(A=a_i \mid L(0)=l(0)_i)}\).

As in chapter \ref{ChapIptw}, the ``no-unmeasured confounding'' assumption is addressed by the application of weights \(w_i\) or \(sw_i\), which balance confounders \(L(0)\) relative to the exposure \(A\).

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{rm}\NormalTok{(}\AttributeTok{list=}\FunctionTok{ls}\NormalTok{())}
\NormalTok{df1\_int }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file =} \StringTok{"data/df1\_int.csv"}\NormalTok{)}

\DocumentationTok{\#\# 1. Denominator of the weight}
\CommentTok{\# 1a. Estimate g(A=a\_i|L(0)) (denominator of the weight)}
\NormalTok{g.A.L }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(A0\_PM2}\FloatTok{.5} \SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env,}
           \AttributeTok{family =} \StringTok{"binomial"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df1\_int)}

\CommentTok{\# 1b. Predict each individual\textquotesingle{}s probability of being exposed to her own exposure}
\CommentTok{\# predict the probabilities P(A0\_PM2.5 = 1) \& P(A0\_PM2.5 = 0)}
\NormalTok{pred.g1.L }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(g.A.L, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)}
\NormalTok{pred.g0.L }\OtherTok{\textless{}{-}} \DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ pred.g1.L}
\CommentTok{\# the predicted probability of the observed treatment P(A = a\_i | L(0)) is :}
\NormalTok{gAi.L }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{, }\FunctionTok{nrow}\NormalTok{(df1\_int))}
\NormalTok{gAi.L[df1\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\SpecialCharTok{==}\DecValTok{1}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ pred.g1.L[df1\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\SpecialCharTok{==}\DecValTok{1}\NormalTok{]}
\NormalTok{gAi.L[df1\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\SpecialCharTok{==}\DecValTok{0}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ pred.g0.L[df1\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\SpecialCharTok{==}\DecValTok{0}\NormalTok{]}

\DocumentationTok{\#\# 2. Numerator of the weight}
\CommentTok{\# The numerator of the weight can be 1 for simple weights,}
\CommentTok{\# or g(A=a\_i|V) to obtain stabilized weights which put less weight to individuals}
\CommentTok{\# with less observation. Stabilized weights enable a weaker positivity assumption.}

\CommentTok{\# 2a. Estimate g(A=a\_i | sex) (numerator of the stabilized weight)}
\NormalTok{g.A.sex }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(A0\_PM2}\FloatTok{.5} \SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male,}
               \AttributeTok{family =} \StringTok{"binomial"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df1\_int)}

\CommentTok{\# 2b. Predict each individual\textquotesingle{}s probability of being exposed to her own exposure}
\CommentTok{\# predict the probabilities P(A0\_PM2.5 = 1 | sex) \& P(A0\_PM2.5 = 0 | sex)}
\NormalTok{pred.g1.sex }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(g.A.sex, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)}
\NormalTok{pred.g0.sex }\OtherTok{\textless{}{-}} \DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ pred.g1.sex}
\CommentTok{\# the predicted probability of the observed treatment P(A = a\_i | sex) is :}
\NormalTok{gAi.sex }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{, }\FunctionTok{nrow}\NormalTok{(df1\_int))}
\NormalTok{gAi.sex[df1\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\SpecialCharTok{==}\DecValTok{1}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ pred.g1.sex[df1\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\SpecialCharTok{==}\DecValTok{1}\NormalTok{]}
\NormalTok{gAi.sex[df1\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\SpecialCharTok{==}\DecValTok{0}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ pred.g0.sex[df1\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\SpecialCharTok{==}\DecValTok{0}\NormalTok{]}

\DocumentationTok{\#\# 3. Define individual weights:}
\CommentTok{\# We can use simple weights w = 1 / g(A=a\_i | L(0))}
\NormalTok{w }\OtherTok{\textless{}{-}} \DecValTok{1} \SpecialCharTok{/}\NormalTok{ gAi.L}
\CommentTok{\# Or alternatively, we can use stabilized weights : }
\CommentTok{\# sw = g(A=a\_i | sex) / g(A=a\_i | L(0))}
\NormalTok{sw }\OtherTok{\textless{}{-}}\NormalTok{ gAi.sex }\SpecialCharTok{/}\NormalTok{ gAi.L}

\CommentTok{\# we can see that stabilized weights have less extreme values}
\FunctionTok{par}\NormalTok{(}\AttributeTok{mfcol =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{2}\NormalTok{))}
\FunctionTok{boxplot}\NormalTok{(w }\SpecialCharTok{\textasciitilde{}}\NormalTok{ df1\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\NormalTok{)}
\FunctionTok{boxplot}\NormalTok{(sw }\SpecialCharTok{\textasciitilde{}}\NormalTok{ df1\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\NormalTok{)}
\FunctionTok{par}\NormalTok{(}\AttributeTok{mfcol =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{))}

\DocumentationTok{\#\# applying these weights creates a pseudo{-}population were the baseline}
\DocumentationTok{\#\# confounders are balanced, relative to the exposure:}
\DocumentationTok{\#\# before applying weights to the individuals:}
\FunctionTok{table}\NormalTok{(df1\_int}\SpecialCharTok{$}\NormalTok{L0\_male, df1\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\NormalTok{, }\AttributeTok{deparse.level =} \DecValTok{2}\NormalTok{)}
\CommentTok{\#                df1\_int$A0\_PM2.5}
\CommentTok{\# df1\_int$L0\_male    0    1}
\CommentTok{\#               0 4527  463}
\CommentTok{\#               1 4349  661}
\FunctionTok{prop.table}\NormalTok{(}\FunctionTok{table}\NormalTok{(df1\_int}\SpecialCharTok{$}\NormalTok{L0\_male, df1\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\NormalTok{, }\AttributeTok{deparse.level =} \DecValTok{2}\NormalTok{),}
           \AttributeTok{margin =} \DecValTok{2}\NormalTok{)}
\CommentTok{\#                          df1\_int$A0\_PM2.5}
\CommentTok{\# df1\_int$L0\_male         0         1}
\CommentTok{\#               0 0.5100270 0.4119217}
\CommentTok{\#               1 0.4899730 0.5880783   \# sex is unbalanced: 49\% versus 59\%}

\DocumentationTok{\#\# after applying weights to the individuals:}
\FunctionTok{library}\NormalTok{(questionr) }\CommentTok{\# The questionr package enables to describe weighted populations}
\FunctionTok{wtd.table}\NormalTok{(}\AttributeTok{x =}\NormalTok{ df1\_int}\SpecialCharTok{$}\NormalTok{L0\_male, }\AttributeTok{y =}\NormalTok{ df1\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\NormalTok{,}
          \AttributeTok{weights =}\NormalTok{ w)}
\CommentTok{\#          0        1}
\CommentTok{\# 0 4989.425 4918.462}
\CommentTok{\# 1 5010.862 5057.676}
\FunctionTok{prop.table}\NormalTok{(}\FunctionTok{wtd.table}\NormalTok{(}\AttributeTok{x =}\NormalTok{ df1\_int}\SpecialCharTok{$}\NormalTok{L0\_male, }\AttributeTok{y =}\NormalTok{ df1\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\NormalTok{,}
                     \AttributeTok{weights =}\NormalTok{ w), }\AttributeTok{margin =} \DecValTok{2}\NormalTok{)}
\CommentTok{\#           0         1}
\CommentTok{\# 0 0.4989282 0.4930227}
\CommentTok{\# 1 0.5010718 0.5069773 \# sex is balanced in the weighted population}

\DocumentationTok{\#\# 4. Estimate coefficients of the MSM using a weighted regression E(Y | A, sex)}
\CommentTok{\# a GLM with gaussian family can be applied to estimate risk differences}
\CommentTok{\# (for relative risk or rate ratios, we can apply a Poisson family; }
\CommentTok{\#  for OR, we can apply a binomial family)}
\NormalTok{msm1 }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Y\_death }\SpecialCharTok{\textasciitilde{}}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5}\SpecialCharTok{*}\NormalTok{L0\_male,}
           \AttributeTok{weights =}\NormalTok{ w,}
           \AttributeTok{family =} \StringTok{"gaussian"}\NormalTok{,}
           \AttributeTok{data =}\NormalTok{ df1\_int)}
\FunctionTok{coef}\NormalTok{(msm1)}
\CommentTok{\# (Intercept)         A0\_PM2.5          L0\_male A0\_PM2.5:L0\_male}
\CommentTok{\#  0.17573472       0.05883228       0.04598911       0.03077614}

\NormalTok{msm2 }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Y\_death }\SpecialCharTok{\textasciitilde{}}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5}\SpecialCharTok{*}\NormalTok{L0\_male,}
            \AttributeTok{weights =}\NormalTok{ sw,}
            \AttributeTok{family =} \StringTok{"gaussian"}\NormalTok{,}
            \AttributeTok{data =}\NormalTok{ df1\_int)}
\FunctionTok{coef}\NormalTok{(msm2)}
\CommentTok{\# (Intercept)         A0\_PM2.5          L0\_male A0\_PM2.5:L0\_male}
\CommentTok{\#  0.17573472       0.05883228       0.04598911       0.03077614}

\DocumentationTok{\#\# 5. Estimate the ATE stratified by sex}
\CommentTok{\# According to MSM1 (with simple weights)}
\NormalTok{ATE.msm1.male0 }\OtherTok{\textless{}{-}} \FunctionTok{coef}\NormalTok{(msm1)[}\StringTok{"A0\_PM2.5"}\NormalTok{]}
\CommentTok{\# 0.05883228}
\NormalTok{ATE.msm1.male1 }\OtherTok{\textless{}{-}} \FunctionTok{coef}\NormalTok{(msm1)[}\StringTok{"A0\_PM2.5"}\NormalTok{] }\SpecialCharTok{+} \FunctionTok{coef}\NormalTok{(msm1)[}\StringTok{"A0\_PM2.5:L0\_male"}\NormalTok{]}
\CommentTok{\# 0.08960842}

\CommentTok{\# According to the MSM2 (with stabilized weights)}
\NormalTok{ATE.msm2.male0 }\OtherTok{\textless{}{-}} \FunctionTok{coef}\NormalTok{(msm2)[}\StringTok{"A0\_PM2.5"}\NormalTok{]}
\CommentTok{\# 0.05883228}
\NormalTok{ATE.msm2.male1 }\OtherTok{\textless{}{-}} \FunctionTok{coef}\NormalTok{(msm2)[}\StringTok{"A0\_PM2.5"}\NormalTok{] }\SpecialCharTok{+} \FunctionTok{coef}\NormalTok{(msm2)[}\StringTok{"A0\_PM2.5:L0\_male"}\NormalTok{]}
\CommentTok{\# 0.08960842}
\CommentTok{\# The results are the same because there is no violation of the positivity assumption}
\CommentTok{\# In case of positivity violation, stabilized weights would give more accurate estimates}
\end{Highlighting}
\end{Shaded}

The ATE estimates of death probability using an MSM estimated by IPTW are respectively +5.9\% in women and +9.0\% in men.

95\% confidence intervals can be calculated by bootstrap.

Note: Using the true data generating model used to simulate the illustrative datasets, the ``true'' value of the ATE stratified by sex can be calculated:

\begin{itemize}
\item
  the ``true'' \((ATE \mid L_\text{male}(0) = 0) = 0.0688\) in women,
\item
  the ``true'' \((ATE \mid L_\text{male}(0) = 1) = 0.0703\) in men.
\end{itemize}

\subsection{Estimation of the MSM coefficients by G-computation (imputation)}\label{estimation-of-the-msm-coefficients-by-g-computation-imputation}

We can also use a G-computation (sometimes described as an imputation) approach to estimate the coefficients of an MSM.

The following steps can be applied:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Fit a (logistic or a linear) regression to estimate \(\overline{Q} = \mathbb{E}(Y \mid A, L(0))\)
\item
  Use this estimate to predict an outcome for each subject under the counterfactual scenarios \(\hat{\overline{Q}}(A=0)_i\) and \(\hat{\overline{Q}}(A=1)_i\), by evaluating the regression fit \(\overline{Q}\) at \(A=0\) and \(A=1\) respectively
\item
  Duplicate the initial dataset in a single long dataset in which:
\end{enumerate}

\begin{itemize}
\tightlist
\item
  the first half of the long dataset corresponds to the first counterfactual scenario with \(A=0\) for all individuals and an additional column for the predicted counterfactual outcome \(\hat{\overline{Q}}(A=0)\) ;
\item
  the second half of the long dataset corresponds to the second counterfactual scenario with \(A=1\) for all individuals and \(\hat{\overline{Q}}(A=1)\) for the predicted counterfactual column.
\end{itemize}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{3}
\tightlist
\item
  Fit the MSM \(\mathbb{E}\left[Y_a \mid L_\text{male}(0)\right]\) using the long dataset.
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{rm}\NormalTok{(}\AttributeTok{list=}\FunctionTok{ls}\NormalTok{())}
\NormalTok{df1\_int }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file =} \StringTok{"data/df1\_int.csv"}\NormalTok{)}

\DocumentationTok{\#\# 1. Estimate Qbar}
\NormalTok{Q.tot.death }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Y\_death }\SpecialCharTok{\textasciitilde{}}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env,}
                   \AttributeTok{family =} \StringTok{"gaussian"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df1\_int)}
\CommentTok{\# The final result would be sligthly different if we apply a binomial family.}

\DocumentationTok{\#\# 2. Predict an outcome for each subject, in 2 counterfactual scenarios }
\DocumentationTok{\#\#    setting A=0 and A=1}
\CommentTok{\# prepare data sets used to predict the outcome under the counterfactual}
\CommentTok{\# scenarios setting A=0 and A=1}
\NormalTok{data.A1 }\OtherTok{\textless{}{-}}\NormalTok{ data.A0 }\OtherTok{\textless{}{-}}\NormalTok{ df1\_int}
\NormalTok{data.A1}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \OtherTok{\textless{}{-}} \DecValTok{1}
\NormalTok{data.A0}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \OtherTok{\textless{}{-}} \DecValTok{0}

\CommentTok{\# predict values under the same name in the corresponding counterfactual dataset}
\NormalTok{data.A1}\SpecialCharTok{$}\NormalTok{Ya.death.pred }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(Q.tot.death, }\AttributeTok{newdata =}\NormalTok{ data.A1, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}
\NormalTok{data.A0}\SpecialCharTok{$}\NormalTok{Ya.death.pred }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(Q.tot.death, }\AttributeTok{newdata =}\NormalTok{ data.A0, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}

\DocumentationTok{\#\# 3. Append both counterfactual datasets in a single long dataset}
\CommentTok{\# (the number of row is twice the initial number of row because there are 2 }
\CommentTok{\# counterfactual scenarios)}
\NormalTok{data}\FloatTok{.2}\NormalTok{scenarios }\OtherTok{\textless{}{-}} \FunctionTok{rbind}\NormalTok{(data.A0, data.A1)}

\DocumentationTok{\#\# 4. fit the MSM: E(Y\_a|sex)}
\CommentTok{\# a GLM with gaussian family can be applied to estimate risk differences}
\NormalTok{MSM.ATE.gcomp }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Ya.death.pred }\SpecialCharTok{\textasciitilde{}}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5}\SpecialCharTok{:}\NormalTok{L0\_male,}
                     \AttributeTok{family =} \StringTok{"gaussian"}\NormalTok{,}
                     \AttributeTok{data =}\NormalTok{ data}\FloatTok{.2}\NormalTok{scenarios)}
\FunctionTok{coef}\NormalTok{(MSM.ATE.gcomp)}
\CommentTok{\#  (Intercept)         A0\_PM2.5          L0\_male A0\_PM2.5:L0\_male }
\CommentTok{\# 1.743994e{-}01     7.720726e{-}02     4.874750e{-}02     5.087110e{-}16}

\DocumentationTok{\#\# 5. Estimate the ATE stratified by sex}
\CommentTok{\# According to MSM.ATE.gcomp}
\NormalTok{ATE.MSM.gcomp.male0 }\OtherTok{\textless{}{-}} \FunctionTok{coef}\NormalTok{(MSM.ATE.gcomp)[}\StringTok{"A0\_PM2.5"}\NormalTok{]}
\CommentTok{\# 0.07720726}
\NormalTok{ATE.MSM.gcomp.male1 }\OtherTok{\textless{}{-}}\NormalTok{ (}\FunctionTok{coef}\NormalTok{(MSM.ATE.gcomp)[}\StringTok{"A0\_PM2.5"}\NormalTok{] }\SpecialCharTok{+}
                          \FunctionTok{coef}\NormalTok{(MSM.ATE.gcomp)[}\StringTok{"A0\_PM2.5:L0\_male"}\NormalTok{])}
\CommentTok{\# 0.07720726}
\CommentTok{\# The results are the same in both strata, because in the first Qbar model,}
\CommentTok{\# we did not include any (A * sex) interaction term}

\CommentTok{\# Applying a binomial family for the first Qbar model would result in two}
\CommentTok{\# different values of the ATE stratified by sex.}
\CommentTok{\# =\textgreater{} 0.06880798 in the L0\_male = 0 strata}
\CommentTok{\# =\textgreater{} 0.08053575 in the L0\_male = 1 strata}

\CommentTok{\# Comments: For the estimation of the first Qbar model, applying a gaussian family }
\CommentTok{\# (additive model) with no interaction terms implies the presence of some interaction }
\CommentTok{\# terms in a multiplicative model (such as a glm with a binomial family).}
\CommentTok{\# On the contrary, applying a binomial family (multiplicative model) with no}
\CommentTok{\# interaction terms implies some interaction terms in an additive model (such as}
\CommentTok{\# a glm with a gaussian family)}
\end{Highlighting}
\end{Shaded}

\section{MSM for Controlled Direct Effects}\label{msm_CDE_paragraph}

\subsection{Expressing the CDE using coefficients of an MSM}\label{expressing-the-cde-using-coefficients-of-an-msm}

The controlled direct effect is defined as \(\text{CDE}_m= \mathbb{E}(Y_{am}) - \mathbb{E}(Y_{a^*m})\).

Using the following MSM
\begin{equation} 
  \mathbb{E}(Y_{am}) = \alpha_0 + \alpha_A a + \alpha_M m + \alpha_{A \ast M} a \times m
  \label{eq:MSMCDE}
\end{equation}
the controlled direct effect (keeping the mediator constant to the value \(M=m\)) can be expressed using the coefficients of the MSM \eqref{eq:MSMCDE}:
\begin{align*} 
  \text{CDE}_m &= (\alpha_0 + \alpha_A a + \alpha_M m + \alpha_{A \ast M} a \times m) - (\alpha_0 + \alpha_A a^* + \alpha_M m + \alpha_{A \ast M} a^* \times m) \\
  \text{CDE}_m &= \alpha_A(a - a^* ) + \alpha_{A \ast M} \times (a - a^*) \times m
\end{align*}
For a binary exposure \(A\), we have \(\text{CDE}_m=\alpha_A + \alpha_{A \ast M} \times m\).

\subsection{Estimation of the MSM coefficients by IPTW}\label{estimation-of-the-msm-coefficients-by-iptw-1}

MSM coefficients can be easily estimated using an Inverse Probability of Treatment (IPTW) approach based on weighted regressions.

In order to fit the MSM \eqref{eq:MSMCDE}, we can use a linear regression of the (observed) outcome \(Y\) on the exposure and mediator, weighted by individual stabilized weights \(sw_i\) ((\citeproc{ref-vanderweele2009}{VanderWeele 2009})):
\begin{equation} 
  \mathbb{E}\left(Y \mid A,M\right) = \alpha_0 + \alpha_A a + \alpha_M m + \alpha_{A \ast M} a \times m
\end{equation}

where \(sw_i\) is the product of two weights \(sw_i = sw_{A,i} \times sw_{M,i}\),

\(sw_{A,i}=\frac{P(A=a_i)}{P(A=a_i \mid L(0)=l(0)_i)}\) and \(sw_{M,i}=\frac{P(M=m_i \mid A=a_i)}{P(M = m_i \mid A=a_i,L(0)=l(0)_i), L(1)=l(1)_i}\).

The ``no-unmeasured confounding'' assumption is addressed by the application of weights \(sw_i\), which balances confounders \(L(0)\) relative to the exposure-outcome \(A-Y\) relationship, and balance the set of confounders \(\{L(0),A,L(1)\}\) relative to the mediator-outcome \(M-Y\) relationship.

\subsubsection{Example 1, with no intermediate confounder affected by the exposure}\label{example-1-with-no-intermediate-confounder-affected-by-the-exposure}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\#\# MSM of CDE, estimated by IPTW {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\FunctionTok{rm}\NormalTok{(}\AttributeTok{list=}\FunctionTok{ls}\NormalTok{())}
\NormalTok{df1\_int }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file =} \StringTok{"data/df1\_int.csv"}\NormalTok{)}

\DocumentationTok{\#\# 1. Stabilized weight for the exposure sw\_\{A,i\}}
\CommentTok{\# 1a. Estimate g(A=a\_i|L(0)) (denominator of the weight)}
\NormalTok{g.A.L }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(A0\_PM2}\FloatTok{.5} \SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env,}
             \AttributeTok{family =} \StringTok{"binomial"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df1\_int)}
\CommentTok{\# 1b. Predict each individual\textquotesingle{}s probability of being exposed to her own exposure}
\CommentTok{\# the predicted probability of the observed treatment g(A = a\_i | L(0)) is :}
\NormalTok{gAi.L }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{, }\FunctionTok{nrow}\NormalTok{(df1\_int))}
\NormalTok{gAi.L[df1\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\SpecialCharTok{==}\DecValTok{1}\NormalTok{] }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(g.A.L, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)[df1\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\SpecialCharTok{==}\DecValTok{1}\NormalTok{]}
\NormalTok{gAi.L[df1\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\SpecialCharTok{==}\DecValTok{0}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}} \FunctionTok{predict}\NormalTok{(g.A.L, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{))[df1\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\SpecialCharTok{==}\DecValTok{0}\NormalTok{]}

\CommentTok{\# 1c. Estimate g(A=a\_i) (numerator of the weight)}
\NormalTok{g.A }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(A0\_PM2}\FloatTok{.5} \SpecialCharTok{\textasciitilde{}} \DecValTok{1}\NormalTok{, }\AttributeTok{family =} \StringTok{"binomial"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df1\_int)}
\CommentTok{\# 1d. Predict each individual\textquotesingle{}s probability of being exposed to her own exposure}
\CommentTok{\# the predicted probability of the observed treatment g(A = a\_i) is :}
\NormalTok{gAi }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{, }\FunctionTok{nrow}\NormalTok{(df1\_int))}
\NormalTok{gAi[df1\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\SpecialCharTok{==}\DecValTok{1}\NormalTok{] }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(g.A, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)[df1\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\SpecialCharTok{==}\DecValTok{1}\NormalTok{]}
\NormalTok{gAi[df1\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\SpecialCharTok{==}\DecValTok{0}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}} \FunctionTok{predict}\NormalTok{(g.A, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{))[df1\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\SpecialCharTok{==}\DecValTok{0}\NormalTok{]}

\CommentTok{\# 1e. Calculate the weight for the exposure A: sw\_\{A,i\}}
\NormalTok{sw\_Ai }\OtherTok{\textless{}{-}}\NormalTok{ gAi }\SpecialCharTok{/}\NormalTok{ gAi.L}

\DocumentationTok{\#\# 2. Stabilized weight for the mediator sw\_\{M,i\}}
\CommentTok{\# 2a. Estimate g(M=m\_i|L(0),A,L(1)) (denominator of the weight)}
\NormalTok{g.M.L }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(M\_diabetes }\SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+}\NormalTok{ L1,}
             \AttributeTok{family =} \StringTok{"binomial"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df1\_int)}
\CommentTok{\# 2b. Predict each individual\textquotesingle{}s probability of being exposed to her own exposure}
\CommentTok{\# the predicted probability of the observed treatment g(A = a\_i | L(0)) is :}
\NormalTok{gMi.L }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{, }\FunctionTok{nrow}\NormalTok{(df1\_int))}
\NormalTok{gMi.L[df1\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes}\SpecialCharTok{==}\DecValTok{1}\NormalTok{] }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(g.M.L, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)[df1\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes}\SpecialCharTok{==}\DecValTok{1}\NormalTok{]}
\NormalTok{gMi.L[df1\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes}\SpecialCharTok{==}\DecValTok{0}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}} \FunctionTok{predict}\NormalTok{(g.M.L, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{))[df1\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes}\SpecialCharTok{==}\DecValTok{0}\NormalTok{]}

\CommentTok{\# 2c. Estimate g(M=m\_i|A) (numerator of the weight)}
\NormalTok{g.M.A }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(M\_diabetes }\SpecialCharTok{\textasciitilde{}}\NormalTok{ A0\_PM2}\FloatTok{.5}\NormalTok{, }\AttributeTok{family =} \StringTok{"binomial"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df1\_int)}
\CommentTok{\# 2d. Predict each individual\textquotesingle{}s probability of being exposed to her own exposure}
\CommentTok{\# the predicted probability of the observed treatment g(M = m\_i|A) is :}
\NormalTok{gMi.A }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{, }\FunctionTok{nrow}\NormalTok{(df1\_int))}
\NormalTok{gMi.A[df1\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes}\SpecialCharTok{==}\DecValTok{1}\NormalTok{] }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(g.M.A, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)[df1\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes}\SpecialCharTok{==}\DecValTok{1}\NormalTok{]}
\NormalTok{gMi.A[df1\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes}\SpecialCharTok{==}\DecValTok{0}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}} \FunctionTok{predict}\NormalTok{(g.M.A, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{))[df1\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes}\SpecialCharTok{==}\DecValTok{0}\NormalTok{]}
\CommentTok{\# 2e. Calculate the weight for the mediator M: sw\_\{M,i\}}
\NormalTok{sw\_Mi }\OtherTok{\textless{}{-}}\NormalTok{ gMi.A }\SpecialCharTok{/}\NormalTok{ gMi.L}

\DocumentationTok{\#\# 3. Define the individual stabilized weight for the CDE\_m}
\NormalTok{sw\_cde }\OtherTok{\textless{}{-}}\NormalTok{ sw\_Ai }\SpecialCharTok{*}\NormalTok{ sw\_Mi}

\DocumentationTok{\#\# 4. Estimate coefficients of the MSM using a weighted regression E(Y | A, sex)}
\CommentTok{\# a GLM with gaussian family can be applied to estimate risk differences}
\NormalTok{msm\_cde }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Y\_death }\SpecialCharTok{\textasciitilde{}}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+}\NormalTok{ M\_diabetes }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5}\SpecialCharTok{*}\NormalTok{M\_diabetes,}
               \AttributeTok{weights =}\NormalTok{ sw\_cde,}
               \AttributeTok{family =} \StringTok{"gaussian"}\NormalTok{,}
               \AttributeTok{data =}\NormalTok{ df1\_int)}
\FunctionTok{coef}\NormalTok{(msm\_cde)}
\CommentTok{\# (Intercept)            A0\_PM2.5          M\_diabetes A0\_PM2.5:M\_diabetes }
\CommentTok{\#  0.17891689          0.06798282          0.06729724         {-}0.00495314}

\DocumentationTok{\#\# 5. Estimate CDE for m=0 and for m=1 using the MSM\textquotesingle{}s coefficients}
\NormalTok{CDE\_mis0 }\OtherTok{\textless{}{-}} \FunctionTok{coef}\NormalTok{(msm\_cde)[}\StringTok{"A0\_PM2.5"}\NormalTok{]}
\CommentTok{\# 0.06798282}
\NormalTok{CDE\_mis1 }\OtherTok{\textless{}{-}} \FunctionTok{coef}\NormalTok{(msm\_cde)[}\StringTok{"A0\_PM2.5"}\NormalTok{] }\SpecialCharTok{+} \FunctionTok{coef}\NormalTok{(msm\_cde)[}\StringTok{"A0\_PM2.5:M\_diabetes"}\NormalTok{]}
\CommentTok{\# 0.06302968}
\end{Highlighting}
\end{Shaded}

In this example, our estimates of the controlled direct effects are \(CDE_{M=0} = 6.8\%\) and \(CDE_{M=1} = 6.3\%\). Confidence intervals can be calculated by bootstrap.

Importantly, this approach for the estimation of the controlled direct effect \(\text{CDE}_m\) by IPTW is also valid if the exposure \(A\) affects the intermediate confounder \(L(1)\) (as with the Causal model 2).

\subsubsection{Example 2, with intermediate confounder affected by the exposure}\label{example-2-with-intermediate-confounder-affected-by-the-exposure}

Below, we estimate the CDE by hand, and using the \texttt{ltmle} package and the \texttt{CMAverse} package

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\#\# MSM of CDE, estimated by IPTW}
\FunctionTok{rm}\NormalTok{(}\AttributeTok{list=}\FunctionTok{ls}\NormalTok{())}
\NormalTok{df2\_int }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file =} \StringTok{"data/df2\_int.csv"}\NormalTok{)}

\DocumentationTok{\#\# 1. Stabilized weight for the exposure sw\_\{A,i\}}
\CommentTok{\# 1a. Estimate g(A=a\_i|L(0)) (denominator of the weight)}
\NormalTok{g.A.L }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(A0\_PM2}\FloatTok{.5} \SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env,}
             \AttributeTok{family =} \StringTok{"binomial"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df2\_int)}
\CommentTok{\# 1b. Predict each individual\textquotesingle{}s probability of being exposed to her own exposure}
\CommentTok{\# the predicted probability of the observed treatment g(A = a\_i | L(0)) is :}
\NormalTok{gAi.L }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{, }\FunctionTok{nrow}\NormalTok{(df2\_int))}
\NormalTok{gAi.L[df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\SpecialCharTok{==}\DecValTok{1}\NormalTok{] }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(g.A.L, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)[df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\SpecialCharTok{==}\DecValTok{1}\NormalTok{]}
\NormalTok{gAi.L[df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\SpecialCharTok{==}\DecValTok{0}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}} \FunctionTok{predict}\NormalTok{(g.A.L, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{))[df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\SpecialCharTok{==}\DecValTok{0}\NormalTok{]}

\CommentTok{\# 1c. Estimate g(A=a\_i) (numerator of the weight)}
\NormalTok{g.A }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(A0\_PM2}\FloatTok{.5} \SpecialCharTok{\textasciitilde{}} \DecValTok{1}\NormalTok{, }\AttributeTok{family =} \StringTok{"binomial"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df2\_int)}
\CommentTok{\# 1d. Predict each individual\textquotesingle{}s probability of being exposed to her own exposure}
\CommentTok{\# the predicted probability of the observed treatment g(A = a\_i) is :}
\NormalTok{gAi }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{, }\FunctionTok{nrow}\NormalTok{(df2\_int))}
\NormalTok{gAi[df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\SpecialCharTok{==}\DecValTok{1}\NormalTok{] }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(g.A, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)[df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\SpecialCharTok{==}\DecValTok{1}\NormalTok{]}
\NormalTok{gAi[df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\SpecialCharTok{==}\DecValTok{0}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}} \FunctionTok{predict}\NormalTok{(g.A, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{))[df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\SpecialCharTok{==}\DecValTok{0}\NormalTok{]}

\CommentTok{\# 1e. Calculate the weight for the exposure A: sw\_\{A,i\}}
\NormalTok{sw\_Ai }\OtherTok{\textless{}{-}}\NormalTok{ gAi }\SpecialCharTok{/}\NormalTok{ gAi.L}

\DocumentationTok{\#\# 2. Stabilized weight for the mediator sw\_\{M,i\}}
\CommentTok{\# 2a. Estimate g(M=m\_i|L(0),A,L(1)) (denominator of the weight)}
\NormalTok{g.M.L }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(M\_diabetes }\SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+}\NormalTok{ L1,}
             \AttributeTok{family =} \StringTok{"binomial"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df2\_int)}
\CommentTok{\# 2b. Predict each individual\textquotesingle{}s probability of being exposed to her own exposure}
\CommentTok{\# the predicted probability of the observed treatment g(A = a\_i | L(0)) is :}
\NormalTok{gMi.L }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{, }\FunctionTok{nrow}\NormalTok{(df2\_int))}
\NormalTok{gMi.L[df2\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes}\SpecialCharTok{==}\DecValTok{1}\NormalTok{] }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(g.M.L, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)[df2\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes}\SpecialCharTok{==}\DecValTok{1}\NormalTok{]}
\NormalTok{gMi.L[df2\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes}\SpecialCharTok{==}\DecValTok{0}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}} \FunctionTok{predict}\NormalTok{(g.M.L, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{))[df2\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes}\SpecialCharTok{==}\DecValTok{0}\NormalTok{]}

\CommentTok{\# 2c. Estimate g(M=m\_i|A) (numerator of the weight)}
\NormalTok{g.M.A }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(M\_diabetes }\SpecialCharTok{\textasciitilde{}}\NormalTok{ A0\_PM2}\FloatTok{.5}\NormalTok{, }\AttributeTok{family =} \StringTok{"binomial"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df2\_int)}
\CommentTok{\# 2d. Predict each individual\textquotesingle{}s probability of being exposed to her own exposure}
\CommentTok{\# the predicted probability of the observed treatment g(M = m\_i|A) is :}
\NormalTok{gMi.A }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{, }\FunctionTok{nrow}\NormalTok{(df2\_int))}
\NormalTok{gMi.A[df2\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes}\SpecialCharTok{==}\DecValTok{1}\NormalTok{] }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(g.M.A, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)[df2\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes}\SpecialCharTok{==}\DecValTok{1}\NormalTok{]}
\NormalTok{gMi.A[df2\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes}\SpecialCharTok{==}\DecValTok{0}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}} \FunctionTok{predict}\NormalTok{(g.M.A, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{))[df2\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes}\SpecialCharTok{==}\DecValTok{0}\NormalTok{]}
\CommentTok{\# 2e. Calculate the weight for the mediator M: sw\_\{M,i\}}
\NormalTok{sw\_Mi }\OtherTok{\textless{}{-}}\NormalTok{ gMi.A }\SpecialCharTok{/}\NormalTok{ gMi.L}

\DocumentationTok{\#\# 3. Define the individual stabilized weight for the CDE\_m}
\NormalTok{sw\_cde }\OtherTok{\textless{}{-}}\NormalTok{ sw\_Ai }\SpecialCharTok{*}\NormalTok{ sw\_Mi}

\DocumentationTok{\#\# 4. Estimate coefficients of the MSM using a weighted regression E(Y | A, sex)}
\CommentTok{\# a GLM with gaussian family can be applied to estimate risk differences}
\NormalTok{msm\_cde }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Y\_death }\SpecialCharTok{\textasciitilde{}}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+}\NormalTok{ M\_diabetes }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5}\SpecialCharTok{*}\NormalTok{M\_diabetes,}
               \AttributeTok{weights =}\NormalTok{ sw\_cde,}
               \AttributeTok{family =} \StringTok{"gaussian"}\NormalTok{,}
               \AttributeTok{data =}\NormalTok{ df2\_int)}
\FunctionTok{coef}\NormalTok{(msm\_cde)}
\CommentTok{\# (Intercept)            A0\_PM2.5          M\_diabetes A0\_PM2.5:M\_diabetes}
\CommentTok{\#  0.17932146          0.06012920          0.07239661          0.03017266}

\DocumentationTok{\#\# 5. Estimate CDE for m=0 and for m=1 using the MSM\textquotesingle{}s coefficients}
\NormalTok{CDE\_mis0 }\OtherTok{\textless{}{-}} \FunctionTok{coef}\NormalTok{(msm\_cde)[}\StringTok{"A0\_PM2.5"}\NormalTok{]}
\CommentTok{\# 0.0601292}
\NormalTok{CDE\_mis1 }\OtherTok{\textless{}{-}} \FunctionTok{coef}\NormalTok{(msm\_cde)[}\StringTok{"A0\_PM2.5"}\NormalTok{] }\SpecialCharTok{+} \FunctionTok{coef}\NormalTok{(msm\_cde)[}\StringTok{"A0\_PM2.5:M\_diabetes"}\NormalTok{]}
\CommentTok{\# 0.09030186}


\DocumentationTok{\#\#\# Estimation by IPTW using ltmle package}
\FunctionTok{library}\NormalTok{(ltmle)}
\NormalTok{Qform }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\AttributeTok{L1=}\StringTok{"Q.kplus1 \textasciitilde{} L0\_male + L0\_soc\_env + A0\_PM2.5"}\NormalTok{,}
           \AttributeTok{Y\_death=}\StringTok{"Q.kplus1 \textasciitilde{} L0\_male + L0\_soc\_env + L1 +}
\StringTok{                    A0\_PM2.5 * M\_diabetes"}\NormalTok{)}
\NormalTok{gform }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"A0\_PM2.5 \textasciitilde{} L0\_male + L0\_soc\_env"}\NormalTok{,}
           \StringTok{"M\_diabetes \textasciitilde{} L0\_male + L0\_soc\_env + A0\_PM2.5 + L1"}\NormalTok{)}
\NormalTok{data\_binary }\OtherTok{\textless{}{-}} \FunctionTok{subset}\NormalTok{(df2\_int, }\AttributeTok{select =} \FunctionTok{c}\NormalTok{(L0\_male, L0\_soc\_env,}
\NormalTok{                                          A0\_PM2}\FloatTok{.5}\NormalTok{, L1,}
\NormalTok{                                          M\_diabetes, Y\_death))}
\NormalTok{CDE\_ltmle\_M0\_death }\OtherTok{\textless{}{-}} \FunctionTok{ltmle}\NormalTok{(}\AttributeTok{data =}\NormalTok{ data\_binary,}
                            \AttributeTok{Anodes =} \FunctionTok{c}\NormalTok{(}\StringTok{"A0\_PM2.5"}\NormalTok{, }\StringTok{"M\_diabetes"}\NormalTok{),}
                            \AttributeTok{Lnodes =} \FunctionTok{c}\NormalTok{(}\StringTok{"L1"}\NormalTok{), }\CommentTok{\# intermediate confounders +/{-} baseline}
                            \AttributeTok{Ynodes =} \FunctionTok{c}\NormalTok{(}\StringTok{"Y\_death"}\NormalTok{),}
                            \AttributeTok{survivalOutcome =} \ConstantTok{FALSE}\NormalTok{, }\CommentTok{\# TRUE for time{-}to{-}event outcomes Y}
                            \AttributeTok{Qform =}\NormalTok{ Qform,}
                            \AttributeTok{gform =}\NormalTok{ gform,}
                            \AttributeTok{abar =} \FunctionTok{list}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{0}\NormalTok{), }\CommentTok{\# counterfactual intervention do(A=1,M=0)}
                                        \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{)), }\CommentTok{\# counterfactual intervention do(A=0,M=0)}
                            \AttributeTok{SL.library =} \ConstantTok{NULL}\NormalTok{,}
                            \AttributeTok{estimate.time =} \ConstantTok{FALSE}\NormalTok{, }\CommentTok{\# estimate computation time?}
                            \AttributeTok{iptw.only =} \ConstantTok{TRUE}\NormalTok{, }\CommentTok{\# for only IPTW estimations (no TMLE)}
                            \AttributeTok{gcomp =} \ConstantTok{FALSE}\NormalTok{,}
                            \AttributeTok{variance.method =} \StringTok{"iptw"}\NormalTok{) }\CommentTok{\# IPTW influence curve}
\CommentTok{\# CDE with M=0}
\FunctionTok{summary}\NormalTok{(CDE\_ltmle\_M0\_death, }\AttributeTok{estimator =} \StringTok{"iptw"}\NormalTok{)}\SpecialCharTok{$}\NormalTok{effect.measures}\SpecialCharTok{$}\NormalTok{ATE}
\CommentTok{\# $estimate}
\CommentTok{\# [1] 0.0601292}
\CommentTok{\# $CI}
\CommentTok{\#            2.5\%      97.5\%}
\CommentTok{\# [1,] 0.02424819 0.09601021}

\NormalTok{CDE\_ltmle\_M1\_death }\OtherTok{\textless{}{-}} \FunctionTok{ltmle}\NormalTok{(}\AttributeTok{data =}\NormalTok{ data\_binary,}
                            \AttributeTok{Anodes =} \FunctionTok{c}\NormalTok{(}\StringTok{"A0\_PM2.5"}\NormalTok{, }\StringTok{"M\_diabetes"}\NormalTok{),}
                            \AttributeTok{Lnodes =} \FunctionTok{c}\NormalTok{(}\StringTok{"L1"}\NormalTok{), }\CommentTok{\# intermediate confounders +/{-} baseline}
                            \AttributeTok{Ynodes =} \FunctionTok{c}\NormalTok{(}\StringTok{"Y\_death"}\NormalTok{),}
                            \AttributeTok{survivalOutcome =} \ConstantTok{FALSE}\NormalTok{, }\CommentTok{\# TRUE for time{-}to{-}event outcomes Y}
                            \AttributeTok{Qform =}\NormalTok{ Qform,}
                            \AttributeTok{gform =}\NormalTok{ gform,}
                            \AttributeTok{abar =} \FunctionTok{list}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{), }\CommentTok{\# counterfactual intervention do(A=1,M=0)}
                                        \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{)), }\CommentTok{\# counterfactual intervention do(A=0,M=0)}
                            \AttributeTok{SL.library =} \ConstantTok{NULL}\NormalTok{,}
                            \AttributeTok{estimate.time =} \ConstantTok{FALSE}\NormalTok{, }\CommentTok{\# estimate computation time?}
                            \AttributeTok{iptw.only =} \ConstantTok{TRUE}\NormalTok{, }\CommentTok{\# for only IPTW estimations (no TMLE)}
                            \AttributeTok{gcomp =} \ConstantTok{FALSE}\NormalTok{,}
                            \AttributeTok{variance.method =} \StringTok{"iptw"}\NormalTok{) }\CommentTok{\# IPTW influence curve}
\CommentTok{\# CDE with M=1}
\FunctionTok{summary}\NormalTok{(CDE\_ltmle\_M1\_death, }\AttributeTok{estimator =} \StringTok{"iptw"}\NormalTok{)}\SpecialCharTok{$}\NormalTok{effect.measures}\SpecialCharTok{$}\NormalTok{ATE}
\CommentTok{\# $estimate}
\CommentTok{\# [1] 0.09030186}
\CommentTok{\# $CI}
\CommentTok{\#            2.5\%     97.5\%}
\CommentTok{\# [1,] 0.04084792 0.1397558}

\DocumentationTok{\#\# we obtain the same results as the IPTW estimation by hand}


\DocumentationTok{\#\#\# Estimation by IPTW using ltmle package}
\FunctionTok{library}\NormalTok{(CMAverse)}
\FunctionTok{rm}\NormalTok{(}\AttributeTok{list=}\FunctionTok{ls}\NormalTok{())}
\NormalTok{df2\_int }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file =} \StringTok{"data/df2\_int.csv"}\NormalTok{)}
\FunctionTok{cmdag}\NormalTok{(}\AttributeTok{outcome =} \StringTok{"Y\_death"}\NormalTok{, }\AttributeTok{exposure =} \StringTok{"A0\_PM2.5"}\NormalTok{, }\AttributeTok{mediator =} \StringTok{"M\_diabetes"}\NormalTok{,}
      \AttributeTok{basec =} \FunctionTok{c}\NormalTok{(}\StringTok{"L0\_male"}\NormalTok{, }\StringTok{"L0\_soc\_env"}\NormalTok{), }\AttributeTok{postc =} \StringTok{"L1"}\NormalTok{, }\AttributeTok{node =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{text\_col =} \StringTok{"white"}\NormalTok{)}
\CommentTok{\# In this setting, we can use the marginal structural model and the $g${-}formula approach. The results are shown below.}

\DocumentationTok{\#\# The Marginal Structural Model}
\NormalTok{res\_msm\_RD }\OtherTok{\textless{}{-}} \FunctionTok{cmest}\NormalTok{(}\AttributeTok{data =}\NormalTok{ df2\_int,}
                    \AttributeTok{model =} \StringTok{"msm"}\NormalTok{,}
                    \AttributeTok{outcome =} \StringTok{"Y\_death"}\NormalTok{,}
                    \AttributeTok{exposure =} \StringTok{"A0\_PM2.5"}\NormalTok{,}
                    \AttributeTok{mediator =} \StringTok{"M\_diabetes"}\NormalTok{,}
                    \AttributeTok{basec =} \FunctionTok{c}\NormalTok{(}\StringTok{"L0\_male"}\NormalTok{, }\StringTok{"L0\_soc\_env"}\NormalTok{),}
                    \AttributeTok{postc =} \StringTok{"L1"}\NormalTok{,}
                    \AttributeTok{EMint =} \ConstantTok{TRUE}\NormalTok{, }\CommentTok{\# E*M interaction}
                    \AttributeTok{ereg =} \StringTok{"logistic"}\NormalTok{,}
                    \AttributeTok{yreg =} \StringTok{"linear"}\NormalTok{, }\CommentTok{\# MSM is a linear regression (to get RD)}
                    \AttributeTok{mreg =} \FunctionTok{list}\NormalTok{(}\StringTok{"logistic"}\NormalTok{),}
                    \AttributeTok{wmnomreg =} \FunctionTok{list}\NormalTok{(}\StringTok{"logistic"}\NormalTok{),}
                    \AttributeTok{wmdenomreg =} \FunctionTok{list}\NormalTok{(}\StringTok{"logistic"}\NormalTok{),}
                    \AttributeTok{astar =} \DecValTok{0}\NormalTok{, }\CommentTok{\#E(Y\_\{A=0,M=1\})}
                    \AttributeTok{a =} \DecValTok{1}\NormalTok{,  }\CommentTok{\#E(Y\_\{A=1,M=1\})}
                    \AttributeTok{mval =} \FunctionTok{list}\NormalTok{(}\DecValTok{1}\NormalTok{), }\CommentTok{\# for the CDE, set mediator to M=1}
                    \AttributeTok{estimation =} \StringTok{"imputation"}\NormalTok{,}
                    \AttributeTok{inference =} \StringTok{"bootstrap"}\NormalTok{,}
                    \AttributeTok{nboot =} \DecValTok{2}\NormalTok{)}

\FunctionTok{summary}\NormalTok{(res\_msm\_RD)}
\CommentTok{\# Causal Mediation Analysis}
\CommentTok{\# \# Outcome regression:}
\CommentTok{\# Call:}
\CommentTok{\#   glm(formula = Y\_death \textasciitilde{} A0\_PM2.5 + M\_diabetes + A0\_PM2.5 * M\_diabetes, }
\CommentTok{\#       family = gaussian(), data = getCall(x$reg.output$yreg)$data, }
\CommentTok{\#       weights = getCall(x$reg.output$yreg)$weights)}
\CommentTok{\# Coefficients:}
\CommentTok{\#                       Estimate Std. Error t value Pr(\textgreater{}|t|)      \# MSM coef}
\CommentTok{\#   (Intercept)         0.179321   0.005242  34.210  \textless{} 2e{-}16 ***  \# are the}
\CommentTok{\#   A0\_PM2.5            0.060129   0.017253   3.485 0.000494 ***  \# same as}
\CommentTok{\#   M\_diabetes          0.072397   0.009242   7.834 5.21e{-}15 ***  \# calculation}
\CommentTok{\#   A0\_PM2.5:M\_diabetes 0.030173   0.025895   1.165 0.243960      \# by hand}
\CommentTok{\#}
\CommentTok{\# \# Mediator regressions: }
\CommentTok{\# Call:}
\CommentTok{\#   glm(formula = M\_diabetes \textasciitilde{} A0\_PM2.5, family = binomial(), data = getCall(x$reg.output$mreg[[1L]])$data, }
\CommentTok{\#       weights = getCall(x$reg.output$mreg[[1L]])$weights)}
\CommentTok{\# Coefficients:}
\CommentTok{\#               Estimate Std. Error z value Pr(\textgreater{}|z|)    }
\CommentTok{\#   (Intercept) {-}0.73432    0.02268 {-}32.384  \textless{} 2e{-}16 ***}
\CommentTok{\#   A0\_PM2.5     0.51531    0.06422   8.024 1.02e{-}15 ***}
\CommentTok{\# }
\CommentTok{\# \# Mediator regressions for weighting (denominator): }
\CommentTok{\# Call:}
\CommentTok{\#   glm(formula = M\_diabetes \textasciitilde{} A0\_PM2.5 + L0\_male + L0\_soc\_env + }
\CommentTok{\#         L1, family = binomial(), data = getCall(x$reg.output$wmdenomreg[[1L]])$data, }
\CommentTok{\#       weights = getCall(x$reg.output$wmdenomreg[[1L]])$weights)}
\CommentTok{\# Coefficients:}
\CommentTok{\#               Estimate Std. Error z value Pr(\textgreater{}|z|)    }
\CommentTok{\#   (Intercept) {-}1.36249    0.04783 {-}28.488  \textless{} 2e{-}16 ***}
\CommentTok{\#   A0\_PM2.5     0.30994    0.06668   4.648 3.35e{-}06 ***}
\CommentTok{\#   L0\_male      0.24661    0.04369   5.644 1.66e{-}08 ***}
\CommentTok{\#   L0\_soc\_env   0.30628    0.04650   6.587 4.50e{-}11 ***}
\CommentTok{\#   L1           0.86045    0.04493  19.152  \textless{} 2e{-}16 ***}
\CommentTok{\# }
\CommentTok{\# \# Mediator regressions for weighting (nominator): }
\CommentTok{\# Call:}
\CommentTok{\#   glm(formula = M\_diabetes \textasciitilde{} A0\_PM2.5, family = binomial(), data = getCall(x$reg.output$wmnomreg[[1L]])$data, }
\CommentTok{\#       weights = getCall(x$reg.output$wmnomreg[[1L]])$weights)}
\CommentTok{\# Coefficients:}
\CommentTok{\#               Estimate Std. Error z value Pr(\textgreater{}|z|)    }
\CommentTok{\#   (Intercept) {-}0.74205    0.02271 {-}32.680   \textless{}2e{-}16 ***}
\CommentTok{\#   A0\_PM2.5     0.55288    0.06408   8.628   \textless{}2e{-}16 ***}
\CommentTok{\# }
\CommentTok{\# \# Exposure regression for weighting: }
\CommentTok{\# Call:}
\CommentTok{\#   glm(formula = A0\_PM2.5 \textasciitilde{} L0\_male + L0\_soc\_env, family = binomial(), }
\CommentTok{\#       data = getCall(x$reg.output$ereg)$data, weights = getCall(x$reg.output$ereg)$weights)}
\CommentTok{\# Coefficients:}
\CommentTok{\#               Estimate Std. Error z value Pr(\textgreater{}|z|)    }
\CommentTok{\#   (Intercept) {-}2.73244    0.07425 {-}36.799  \textless{} 2e{-}16 ***}
\CommentTok{\#   L0\_male      0.40580    0.06447   6.294 3.09e{-}10 ***}
\CommentTok{\#   L0\_soc\_env   0.64060    0.07350   8.716  \textless{} 2e{-}16 ***}
\CommentTok{\# }
\CommentTok{\# \# Effect decomposition on the mean difference scale via the marginal structural model}
\CommentTok{\# Direct counterfactual imputation estimation with }
\CommentTok{\# bootstrap standard errors, percentile confidence intervals and p{-}values }
\CommentTok{\#                   Estimate  Std.error    95\% CIL 95\% CIU  P.val    }
\CommentTok{\#   cde            9.030e{-}02  1.601e{-}02  6.094e{-}02   0.082 \textless{}2e{-}16 *** \# same result}
\CommentTok{\#   rpnde          7.003e{-}02  1.600e{-}02  5.838e{-}02   0.080 \textless{}2e{-}16 ***}
\CommentTok{\#   rtnde          7.374e{-}02  1.597e{-}02  5.888e{-}02   0.080 \textless{}2e{-}16 ***}
\CommentTok{\#   rpnie          8.903e{-}03  9.159e{-}04  8.284e{-}03   0.010 \textless{}2e{-}16 ***}
\CommentTok{\#   rtnie          1.261e{-}02  9.523e{-}04  8.738e{-}03   0.010 \textless{}2e{-}16 ***}
\CommentTok{\#   te             8.265e{-}02  1.505e{-}02  6.839e{-}02   0.089 \textless{}2e{-}16 ***}
\CommentTok{\#   rintref       {-}2.027e{-}02  7.341e{-}06 {-}2.571e{-}03  {-}0.003 \textless{}2e{-}16 ***}
\CommentTok{\#   rintmed        3.710e{-}03  3.634e{-}05  4.542e{-}04   0.001 \textless{}2e{-}16 ***}
\CommentTok{\#   cde(prop)      1.093e+00  2.940e{-}02  8.907e{-}01   0.930 \textless{}2e{-}16 ***}
\CommentTok{\#   rintref(prop) {-}2.452e{-}01  6.289e{-}03 {-}3.752e{-}02  {-}0.029 \textless{}2e{-}16 ***}
\CommentTok{\#   rintmed(prop)  4.489e{-}02  1.662e{-}03  5.140e{-}03   0.007 \textless{}2e{-}16 ***}
\CommentTok{\#   rpnie(prop)    1.077e{-}01  3.403e{-}02  9.376e{-}02   0.139 \textless{}2e{-}16 ***}
\CommentTok{\#   rpm            1.526e{-}01  3.569e{-}02  9.890e{-}02   0.147 \textless{}2e{-}16 ***}
\CommentTok{\#   rint          {-}2.004e{-}01  4.627e{-}03 {-}3.014e{-}02  {-}0.024 \textless{}2e{-}16 ***}
\CommentTok{\#   rpe           {-}9.263e{-}02  2.940e{-}02  6.983e{-}02   0.109 \textless{}2e{-}16 ***}
\CommentTok{\#   {-}{-}{-}}
\CommentTok{\#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1}
\CommentTok{\# }
\CommentTok{\#  (cde: controlled direct effect; }
\CommentTok{\#  rpnde: randomized analogue of pure natural direct effect; }
\CommentTok{\#  rtnde: randomized analogue of total natural direct effect; }
\CommentTok{\#  rpnie: randomized analogue of pure natural indirect effect; }
\CommentTok{\#  rtnie: randomized analogue of total natural indirect effect; }
\CommentTok{\#  te: total effect; rintref: randomized analogue of reference interaction; }
\CommentTok{\#  rintmed: randomized analogue of mediated interaction; }
\CommentTok{\#  cde(prop): proportion cde; }
\CommentTok{\#  rintref(prop): proportion rintref; }
\CommentTok{\#  rintmed(prop): proportion rintmed; }
\CommentTok{\#  rpnie(prop): proportion rpnie; }
\CommentTok{\#  rpm: randomized analogue of overall proportion mediated; }
\CommentTok{\#  rint: randomized analogue of overall proportion attributable to interaction; }
\CommentTok{\#  rpe: randomized analogue of overall proportion eliminated)}
\end{Highlighting}
\end{Shaded}

\subsection{Estimation of the MSM coefficients by G-computation}\label{estimation-of-the-msm-coefficients-by-g-computation}

As for the ATE, we can use G-computation to estimate the coefficients of the MSM to estimate Controlled Direct Effects.

Note that the algorithm described below is correct only if the exposure \(A\) doesn't affect the intermediate confounders \(L(1)\) of the \(M \rightarrow Y\) relationship (such as the data simulated from the Causal model 1 in our examples). In that case, the following steps can be applied:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Fit a (logistic or a linear) regression to estimate \(\overline{Q} = \mathbb{E}(Y \mid A,M, L(0),L(1))\)
\item
  Use this estimate to predict an outcome for each subject under the counterfactual scenarios \(\hat{\overline{Q}}(A=0,M=m,L(0),L(1))_i\) and \(\hat{\overline{Q}}(A=1,M=m,L(0),L(1))_i\), by evaluating the regression fit \(\overline{Q}\) at \((A=0,M=m)\) and \((A=1,M=m)\) respectively. If we want to set the level of the mediator to \(M=0\) and \(M=1\), this would give 4 counterfactual scenarios \(\text{do}(A=0,M=0)\), \(\text{do}(A=1,M=0)\), \(\text{do}(A=0,M=1)\) and \(\text{do}(A=1,M=1)\).
\item
  Duplicate the initial dataset for each scenario in a single long dataset in which:
\end{enumerate}

\begin{itemize}
\tightlist
\item
  the 1st part of the long dataset corresponds to the first counterfactual scenario with \((A=0,M=0)\) for all individuals and an additional column for the predicted counterfactual outcome \(\mathbb{E}(Y_{A=0,M=0}\mid L(0),L(1)) = \hat{\overline{Q}}(A=0,M=0,L(0),L(1))\) ;
\item
  the 2d part of the long dataset corresponds to the second counterfactual scenario with \((A=1,M=0)\) for all individuals and an additional column for the predicted counterfactual outcome \(\mathbb{E}(Y_{A=1,M=0}\mid L(0),L(1)) = \hat{\overline{Q}}(A=1,M=0,L(0),L(1))\) ;
\item
  the 3d part of the long dataset corresponds to the second counterfactual scenario with \((A=0,M=1)\) for all individuals and an additional column for the predicted counterfactual outcome \(\mathbb{E}(Y_{A=0,M=1}\mid L(0),L(1)) = \hat{\overline{Q}}(A=0,M=1,L(0),L(1))\) ;
\item
  the 4th part of the long dataset corresponds to the second counterfactual scenario with \((A=1,M=1)\) for all individuals and an additional column for the predicted counterfactual outcome \(\mathbb{E}(Y_{A=1,M=1}\mid L(0),L(1)) = \hat{\overline{Q}}(A=1,M=1,L(0),L(1))\) ;
\end{itemize}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{3}
\tightlist
\item
  Fit the MSM \(\mathbb{E}(Y_{am}) = \alpha_0 + \alpha_A a + \alpha_M m + \alpha_{A \ast M} a \times m\) using the long dataset.
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{rm}\NormalTok{(}\AttributeTok{list=}\FunctionTok{ls}\NormalTok{())}
\NormalTok{df1\_int }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file =} \StringTok{"data/df1\_int.csv"}\NormalTok{)}

\DocumentationTok{\#\#\# MSM of CDE, estimated by G{-}computation {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\DocumentationTok{\#\# 1. Estimate Qbar(A,M,L0,L1)}
\NormalTok{Q.cde.death }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Y\_death }\SpecialCharTok{\textasciitilde{}}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+}\NormalTok{ M\_diabetes }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5}\SpecialCharTok{:}\NormalTok{M\_diabetes }\SpecialCharTok{+} 
\NormalTok{                     L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ L1,}
                   \AttributeTok{family =} \StringTok{"gaussian"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df1\_int)}
\CommentTok{\# The final result would be sligthly different if we applied a binomial family}
\CommentTok{\# The Gaussian family corresponds to the true generating model in this example.}

\DocumentationTok{\#\# 2. Predict an outcome for each subject, in each counterfactual scenario}
\CommentTok{\# Prepare data sets that will be used to predict the outcome under the counterfactual}
\CommentTok{\# 4 counterfactual scenarios setting (A=0,M=0), (A=1,M=0), (A=0,M=1) and (A=1,M=1)}
\NormalTok{data.A0M0 }\OtherTok{\textless{}{-}}\NormalTok{ data.A1M0 }\OtherTok{\textless{}{-}}\NormalTok{ data.A0M1 }\OtherTok{\textless{}{-}}\NormalTok{ data.A1M1 }\OtherTok{\textless{}{-}}\NormalTok{ df1\_int}
\NormalTok{data.A0M0}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \OtherTok{\textless{}{-}} \DecValTok{0}
\NormalTok{data.A0M0}\SpecialCharTok{$}\NormalTok{M\_diabetes }\OtherTok{\textless{}{-}} \DecValTok{0}

\NormalTok{data.A1M0}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \OtherTok{\textless{}{-}} \DecValTok{1}
\NormalTok{data.A1M0}\SpecialCharTok{$}\NormalTok{M\_diabetes }\OtherTok{\textless{}{-}} \DecValTok{0}

\NormalTok{data.A0M1}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \OtherTok{\textless{}{-}} \DecValTok{0}
\NormalTok{data.A0M1}\SpecialCharTok{$}\NormalTok{M\_diabetes }\OtherTok{\textless{}{-}} \DecValTok{1}

\NormalTok{data.A1M1}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \OtherTok{\textless{}{-}} \DecValTok{1}
\NormalTok{data.A1M1}\SpecialCharTok{$}\NormalTok{M\_diabetes }\OtherTok{\textless{}{-}} \DecValTok{1}

\CommentTok{\# predict values under the same name in the corresponding counterfactual dataset}
\NormalTok{data.A0M0}\SpecialCharTok{$}\NormalTok{Yam.death.pred }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(Q.cde.death, }\AttributeTok{newdata =}\NormalTok{ data.A0M0, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}
\NormalTok{data.A1M0}\SpecialCharTok{$}\NormalTok{Yam.death.pred }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(Q.cde.death, }\AttributeTok{newdata =}\NormalTok{ data.A1M0, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}
\NormalTok{data.A0M1}\SpecialCharTok{$}\NormalTok{Yam.death.pred }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(Q.cde.death, }\AttributeTok{newdata =}\NormalTok{ data.A0M1, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}
\NormalTok{data.A1M1}\SpecialCharTok{$}\NormalTok{Yam.death.pred }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(Q.cde.death, }\AttributeTok{newdata =}\NormalTok{ data.A1M1, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}

\DocumentationTok{\#\# 3. Append the 4 counterfactual datasets in a single long dataset}
\CommentTok{\# number of row is 4 times the initial value (we have 4 counterfactual scenarios)}
\NormalTok{data}\FloatTok{.4}\NormalTok{scenarios }\OtherTok{\textless{}{-}} \FunctionTok{rbind}\NormalTok{(data.A0M0, data.A1M0,data.A0M1,data.A1M1)}

\DocumentationTok{\#\# 4. fit the MSM: E(Y\_am) = alpha\_0 + alpha\_A a + alpha\_M m + alpha\_AM a:m}
\NormalTok{MSM.CDE.gcomp }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Yam.death.pred }\SpecialCharTok{\textasciitilde{}}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+}\NormalTok{  M\_diabetes }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5}\SpecialCharTok{:}\NormalTok{M\_diabetes,}
                     \AttributeTok{family =} \StringTok{"gaussian"}\NormalTok{, }\CommentTok{\# gaussian family for risk differences}
                     \AttributeTok{data =}\NormalTok{ data}\FloatTok{.4}\NormalTok{scenarios)}
\FunctionTok{coef}\NormalTok{(MSM.CDE.gcomp)}
\CommentTok{\# (Intercept)            A0\_PM2.5          M\_diabetes A0\_PM2.5:M\_diabetes }
\CommentTok{\#  0.17968603          0.06000138          0.06757214          0.01918153}

\DocumentationTok{\#\# 5. Estimate the CDE(M=m)}
\CommentTok{\# CDE(M=0) = E(Y\_\{A=1,M=0\}) {-} E(Y\_\{A=0,M=0\})}
\NormalTok{CDE\_mis0\_gcomp }\OtherTok{\textless{}{-}} \FunctionTok{coef}\NormalTok{(MSM.CDE.gcomp)[}\StringTok{"A0\_PM2.5"}\NormalTok{]}
\CommentTok{\# 0.06000138}

\CommentTok{\# CDE(M=1) = E(Y\_\{A=1,M=1\}) {-} E(Y\_\{A=0,M=1\})}
\NormalTok{CDE\_mis1\_gcomp }\OtherTok{\textless{}{-}}\NormalTok{ (}\FunctionTok{coef}\NormalTok{(MSM.CDE.gcomp)[}\StringTok{"A0\_PM2.5"}\NormalTok{] }\SpecialCharTok{+}
                     \FunctionTok{coef}\NormalTok{(MSM.CDE.gcomp)[}\StringTok{"A0\_PM2.5:M\_diabetes"}\NormalTok{])}
\CommentTok{\# 0.07918291}

\CommentTok{\# Note: Applying a binomial family for the first Qbar model would result in two}
\CommentTok{\# sligthly different values of the CDE(M=m)}
\CommentTok{\# =\textgreater{} 0.05934409 in setting M=0}
\CommentTok{\# =\textgreater{} 0.07537874 in setting M=1}
\end{Highlighting}
\end{Shaded}

If the exposure \(A\) affects the intermediate confounder \(L(1)\), as in the Causal model 2, the steps 1) and 2) of the algorithm should follow the method described in paragraph \ref{ChapGcomp-CDE-param} or \ref{ChapGcomp-CDE-ICE}.

Here is an example applying G-computation by iterative conditional expectation:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{rm}\NormalTok{(}\AttributeTok{list=}\FunctionTok{ls}\NormalTok{())}
\NormalTok{df2\_int }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file =} \StringTok{"data/df2\_int.csv"}\NormalTok{)}

\DocumentationTok{\#\#\# MSM of CDE, estimated by G{-}computation (by ICE) {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\DocumentationTok{\#\# 1a) Regress the outcome on L0, A, L1 and M (and the A*M interaction if appropriate)}
\NormalTok{Y.death.model }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Y\_death }\SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+}\NormalTok{ L1 }\SpecialCharTok{+}
\NormalTok{                       M\_diabetes }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5}\SpecialCharTok{:}\NormalTok{M\_diabetes,}
                     \AttributeTok{family =} \StringTok{"binomial"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df2\_int)}

\DocumentationTok{\#\# 1b) Generate predicted values by evaluating the regression  }
\DocumentationTok{\#\#     under the 4 counterfactual scenarios}
\NormalTok{data.A0M0 }\OtherTok{\textless{}{-}}\NormalTok{ data.A1M0 }\OtherTok{\textless{}{-}}\NormalTok{ data.A0M1 }\OtherTok{\textless{}{-}}\NormalTok{ data.A1M1 }\OtherTok{\textless{}{-}}\NormalTok{ df2\_int}
\NormalTok{data.A0M0}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \OtherTok{\textless{}{-}} \DecValTok{0}
\NormalTok{data.A0M0}\SpecialCharTok{$}\NormalTok{M\_diabetes }\OtherTok{\textless{}{-}} \DecValTok{0}

\NormalTok{data.A1M0}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \OtherTok{\textless{}{-}} \DecValTok{1}
\NormalTok{data.A1M0}\SpecialCharTok{$}\NormalTok{M\_diabetes }\OtherTok{\textless{}{-}} \DecValTok{0}

\NormalTok{data.A0M1}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \OtherTok{\textless{}{-}} \DecValTok{0}
\NormalTok{data.A0M1}\SpecialCharTok{$}\NormalTok{M\_diabetes }\OtherTok{\textless{}{-}} \DecValTok{1}

\NormalTok{data.A1M1}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \OtherTok{\textless{}{-}} \DecValTok{1}
\NormalTok{data.A1M1}\SpecialCharTok{$}\NormalTok{M\_diabetes }\OtherTok{\textless{}{-}} \DecValTok{1}

\NormalTok{Q.Y.death.A0M0 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(Y.death.model, }\AttributeTok{newdata =}\NormalTok{ data.A0M0, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}
\NormalTok{Q.Y.death.A1M0 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(Y.death.model, }\AttributeTok{newdata =}\NormalTok{ data.A1M0, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}
\NormalTok{Q.Y.death.A0M1 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(Y.death.model, }\AttributeTok{newdata =}\NormalTok{ data.A0M1, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}
\NormalTok{Q.Y.death.A1M1 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(Y.death.model, }\AttributeTok{newdata =}\NormalTok{ data.A1M1, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}

\DocumentationTok{\#\# 2a) Regress the predicted values conditional on the observed exposure A}
\DocumentationTok{\#\#    and baseline confounders L(0)}
\NormalTok{L1.death.A0M0.model }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Q.Y.death.A0M0 }\SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5}\NormalTok{,}
                           \AttributeTok{family =} \StringTok{"quasibinomial"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df2\_int)}
\NormalTok{L1.death.A1M0.model }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Q.Y.death.A1M0 }\SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5}\NormalTok{,}
                           \AttributeTok{family =} \StringTok{"quasibinomial"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df2\_int)}
\NormalTok{L1.death.A0M1.model }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Q.Y.death.A0M1 }\SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5}\NormalTok{,}
                           \AttributeTok{family =} \StringTok{"quasibinomial"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df2\_int)}
\NormalTok{L1.death.A1M1.model }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Q.Y.death.A1M1 }\SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5}\NormalTok{,}
                           \AttributeTok{family =} \StringTok{"quasibinomial"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df2\_int)}


\DocumentationTok{\#\# 2b) generate predicted values by evaluating the regression at exposure}
\DocumentationTok{\#\#    of interest: \{A=0,M=0\}, \{A=1,M=0\}, \{A=0,M=1\}, \{A=1,M=1\}}
\NormalTok{data.A0M0}\SpecialCharTok{$}\NormalTok{Yam.death.pred }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(L1.death.A0M0.model,}
                                    \AttributeTok{newdata =}\NormalTok{ data.A0M0, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}
\NormalTok{data.A1M0}\SpecialCharTok{$}\NormalTok{Yam.death.pred }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(L1.death.A1M0.model,}
                                    \AttributeTok{newdata =}\NormalTok{ data.A1M0, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}
\NormalTok{data.A0M1}\SpecialCharTok{$}\NormalTok{Yam.death.pred }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(L1.death.A0M1.model,}
                                    \AttributeTok{newdata =}\NormalTok{ data.A0M1, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}
\NormalTok{data.A1M1}\SpecialCharTok{$}\NormalTok{Yam.death.pred }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(L1.death.A1M1.model,}
                                    \AttributeTok{newdata =}\NormalTok{ data.A1M1, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}


\DocumentationTok{\#\# 3. Append the 4 counterfactual datasets in a single long dataset}
\CommentTok{\# number of row is 4 times the initial value (we have 4 counterfactual scenarios)}
\NormalTok{data}\FloatTok{.4}\NormalTok{scenarios }\OtherTok{\textless{}{-}} \FunctionTok{rbind}\NormalTok{(data.A0M0, data.A1M0,data.A0M1,data.A1M1)}

\DocumentationTok{\#\# 4. fit the MSM: E(Y\_am) = alpha\_0 + alpha\_A a + alpha\_M m + alpha\_AM a:m}
\NormalTok{MSM.CDE.gcomp }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Yam.death.pred }\SpecialCharTok{\textasciitilde{}}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+}\NormalTok{  M\_diabetes }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5}\SpecialCharTok{:}\NormalTok{M\_diabetes,}
                     \AttributeTok{family =} \StringTok{"gaussian"}\NormalTok{, }\CommentTok{\# gaussian family for risk differences}
                     \AttributeTok{data =}\NormalTok{ data}\FloatTok{.4}\NormalTok{scenarios)}
\FunctionTok{coef}\NormalTok{(MSM.CDE.gcomp)}
\CommentTok{\# (Intercept)            A0\_PM2.5          M\_diabetes A0\_PM2.5:M\_diabetes }
\CommentTok{\#  0.17974947          0.06342833          0.07366466          0.02469485}

\DocumentationTok{\#\# 5. Estimate the CDE(M=m)}
\CommentTok{\# CDE(M=0) = E(Y\_\{A=1,M=0\}) {-} E(Y\_\{A=0,M=0\})}
\NormalTok{CDE\_mis0\_gcomp\_ice }\OtherTok{\textless{}{-}} \FunctionTok{coef}\NormalTok{(MSM.CDE.gcomp)[}\StringTok{"A0\_PM2.5"}\NormalTok{]}
\CommentTok{\# 0.06342833}

\CommentTok{\# CDE(M=1) = E(Y\_\{A=1,M=1\}) {-} E(Y\_\{A=0,M=1\})}
\NormalTok{CDE\_mis1\_gcomp\_ice }\OtherTok{\textless{}{-}}\NormalTok{ (}\FunctionTok{coef}\NormalTok{(MSM.CDE.gcomp)[}\StringTok{"A0\_PM2.5"}\NormalTok{] }\SpecialCharTok{+}
                         \FunctionTok{coef}\NormalTok{(MSM.CDE.gcomp)[}\StringTok{"A0\_PM2.5:M\_diabetes"}\NormalTok{])}
\CommentTok{\# 0.08812318}
\end{Highlighting}
\end{Shaded}

The example above (MSM estimation using G-computation by ICE) corresponds to the algorithm applied by the \texttt{ltmle} package:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ltmle)}
\NormalTok{Qform }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\AttributeTok{L1=}\StringTok{"Q.kplus1 \textasciitilde{} L0\_male + L0\_soc\_env + A0\_PM2.5"}\NormalTok{,}
           \AttributeTok{Y\_death=}\StringTok{"Q.kplus1 \textasciitilde{} L0\_male + L0\_soc\_env + L1 +}
\StringTok{                    A0\_PM2.5 * M\_diabetes"}\NormalTok{)}
\NormalTok{gform }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"A0\_PM2.5 \textasciitilde{} L0\_male + L0\_soc\_env"}\NormalTok{,}
           \StringTok{"M\_diabetes \textasciitilde{} L0\_male + L0\_soc\_env + A0\_PM2.5 + L1"}\NormalTok{)}
\CommentTok{\# in this example of g{-}computation, the propensity scores \textquotesingle{}gform\textquotesingle{} will not be used}

\NormalTok{data\_binary }\OtherTok{\textless{}{-}} \FunctionTok{subset}\NormalTok{(df2\_int, }\AttributeTok{select =} \FunctionTok{c}\NormalTok{(L0\_male, L0\_soc\_env,}
\NormalTok{                                          A0\_PM2}\FloatTok{.5}\NormalTok{, L1,}
\NormalTok{                                          M\_diabetes, Y\_death))}
\NormalTok{CDE\_ltmle\_M0 }\OtherTok{\textless{}{-}} \FunctionTok{ltmle}\NormalTok{(}\AttributeTok{data =}\NormalTok{ data\_binary,}
                      \AttributeTok{Anodes =} \FunctionTok{c}\NormalTok{(}\StringTok{"A0\_PM2.5"}\NormalTok{, }\StringTok{"M\_diabetes"}\NormalTok{),}
                      \AttributeTok{Lnodes =} \FunctionTok{c}\NormalTok{(}\StringTok{"L1"}\NormalTok{), }\CommentTok{\# intermediate confounders +/{-} baseline}
                      \AttributeTok{Ynodes =} \FunctionTok{c}\NormalTok{(}\StringTok{"Y\_death"}\NormalTok{),}
                      \AttributeTok{survivalOutcome =} \ConstantTok{FALSE}\NormalTok{, }\CommentTok{\# TRUE for time{-}to{-}event outcomes Y}
                      \AttributeTok{Qform =}\NormalTok{ Qform,}
                      \AttributeTok{gform =}\NormalTok{ gform,}
                      \AttributeTok{abar =} \FunctionTok{list}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{0}\NormalTok{), }\CommentTok{\# counterfactual intervention do(A=1,M=0)}
                                  \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{)), }\CommentTok{\# counterfactual intervention do(A=0,M=0)}
                      \AttributeTok{SL.library =} \ConstantTok{NULL}\NormalTok{, }\CommentTok{\# calls glm() instead of SuperLearner}
                      \AttributeTok{estimate.time =} \ConstantTok{FALSE}\NormalTok{, }\CommentTok{\# estimate computation time?}
                      \AttributeTok{gcomp =} \ConstantTok{TRUE}\NormalTok{, }\CommentTok{\# to apply g{-}computation}
                      \AttributeTok{variance.method =} \StringTok{"ic"}\NormalTok{)}
\CommentTok{\# CDE with M=0}
\FunctionTok{summary}\NormalTok{(CDE\_ltmle\_M0)}\SpecialCharTok{$}\NormalTok{effect.measures}\SpecialCharTok{$}\NormalTok{ATE}\SpecialCharTok{$}\NormalTok{estimate}
\CommentTok{\#   Parameter Estimate:  0.06342833}

\NormalTok{CDE\_ltmle\_M1 }\OtherTok{\textless{}{-}} \FunctionTok{ltmle}\NormalTok{(}\AttributeTok{data =}\NormalTok{ data\_binary,}
                      \AttributeTok{Anodes =} \FunctionTok{c}\NormalTok{(}\StringTok{"A0\_PM2.5"}\NormalTok{, }\StringTok{"M\_diabetes"}\NormalTok{),}
                      \AttributeTok{Lnodes =} \FunctionTok{c}\NormalTok{(}\StringTok{"L1"}\NormalTok{), }\CommentTok{\# intermediate confounders +/{-} baseline}
                      \AttributeTok{Ynodes =} \FunctionTok{c}\NormalTok{(}\StringTok{"Y\_death"}\NormalTok{),}
                      \AttributeTok{survivalOutcome =} \ConstantTok{FALSE}\NormalTok{, }\CommentTok{\# TRUE for time{-}to{-}event outcomes Y}
                      \AttributeTok{Qform =}\NormalTok{ Qform,}
                      \AttributeTok{gform =}\NormalTok{ gform,}
                      \AttributeTok{abar =} \FunctionTok{list}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{), }\CommentTok{\# counterfactual intervention do(A=1,M=0)}
                                  \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{)), }\CommentTok{\# counterfactual intervention do(A=0,M=0)}
                      \AttributeTok{SL.library =} \ConstantTok{NULL}\NormalTok{, }\CommentTok{\# calls glm() instead of SuperLearner}
                      \AttributeTok{estimate.time =} \ConstantTok{FALSE}\NormalTok{, }\CommentTok{\# estimate computation time?}
                      \AttributeTok{gcomp =} \ConstantTok{TRUE}\NormalTok{, }\CommentTok{\# to apply g{-}computation}
                      \AttributeTok{variance.method =} \StringTok{"ic"}\NormalTok{)}
\CommentTok{\# CDE with M=1}
\FunctionTok{summary}\NormalTok{(CDE\_ltmle\_M1)}\SpecialCharTok{$}\NormalTok{effect.measures}\SpecialCharTok{$}\NormalTok{ATE}\SpecialCharTok{$}\NormalTok{estimate}
\CommentTok{\#   Parameter Estimate:  0.08812318}
\end{Highlighting}
\end{Shaded}

\section{MSM for Natural Direct and Indirect Effects}\label{msm_NDE_NIE_paragraph}

\subsection{Expressing the NDE and NIE using coefficients of 2 MSMs}\label{expressing-the-nde-and-nie-using-coefficients-of-2-msms}

The (Pure) Natural Direct Effect is defined by \(\text{PNDE} = \mathbb{E}(Y_{a,M_{a^*}}) - \mathbb{E}(Y_{a^*,M_{a^*}})\) and the (Total) Natural Indirect Effect is defined by \(\text{TNIE} = \mathbb{E}(Y_{a,M_a}) - \mathbb{E}(Y_{a,M_{a^*}})\).

VanderWeele suggested using 2 MSMs conditional on baseline confounders \(L(0)\) in order to estimate natural direct and indirect effects (\citeproc{ref-vanderweele2009}{VanderWeele 2009}):

\begin{enumerate}
\def\labelenumi{\arabic{enumi})}
\item
  a model of the counterfactual values of the outcome \(\mathbb{E}(Y_{a,m} \mid l(0))=h^{-1}(a,m,l(0))\), where \(h\) is a link function. For example:
  \begin{equation}
      \mathbb{E}(Y_{a,m} \mid l(0)) = \alpha_0 + \alpha_A a + \alpha_M m + \alpha_{AM} a \times m + \alpha_{L(0)} l(0) \label{eq:MSM-Indirect-model1}
    \end{equation}
  (where \(h\) is the identity function, so that the model can be used to express risk differences)
\item
  a model of the counterfactual values of the mediator \(\mathbb{E}(M_{a} \mid L(0))=g^{-1}(a,l(0))\), where \(g\) is a link function. For example with a binary mediator:
  \begin{equation}
      \mathbb{E}(M_a \mid l(0)) = g^{-1}\left[\beta_0 + \beta_A a + \beta_{L(0)} l(0) \right]
      \label{eq:MSM-Indirect-model2}
    \end{equation}
  (where \(g\) is the logit function because the mediator is binary).
\end{enumerate}

VanderWeele shows that if the function \(h\) is linear in \(m\) (no quadratic terms in \(m\), nor transformations such as \(\log(m)\) or \(\sqrt{m}\), etc) and the exposure \(A\) does not affect the intermediate confounder \(L(1)\), then
\begin{equation*}
  \mathbb{E}(Y_{a,M_{a^*}}) = h^{-1}\left[a,g^{-1}\left(a^*,l(0)\right),l(0)\right]
\end{equation*}

Using the 2 MSMs, we can express the Natural Direct and Indirect Effects conditional on baseline confounders \(L(0)\). In our example:
\begin{align*}
  \text{PNDE} \mid L(0) &= \mathbb{E}(Y_{a,M_{a^*}} \mid L(0)) - \mathbb{E}(Y_{a^*,M_{a^*}} \mid L(0)) \\
  &= \{\alpha_0 + \alpha_A a + [\alpha_M + \alpha_{AM}a] \times g^{-1}(a^*,l(0)) + \alpha_{L(0)} l(0) \} \\
  & \quad \quad - \{ \alpha_0 + \alpha_A a^*+ [\alpha_M + \alpha_{AM}a^*] \times g^{-1}(a^*,l(0)) + \alpha_{L(0)} l(0) \} \\
  &= (a - a^*) \times [\alpha_A + \alpha_{AM} \times g^{-1}(a^*,l(0))]
\end{align*}

\begin{align*}
  \text{TNIE} \mid L(0) &= \mathbb{E}(Y_{a,M_{a}} \mid L(0)) - \mathbb{E}(Y_{a,M_{a^*}} \mid L(0)) \\
  &= \{\alpha_0 + \alpha_A a + [\alpha_M + \alpha_{AM}a] \times g^{-1}(a,l(0)) + \alpha_{L(0)} l(0) \} \\
  & \quad \quad - \{ \alpha_0 + \alpha_A a+ [\alpha_M + \alpha_{AM}a] \times g^{-1}(a^*,l(0)) + \alpha_{L(0)} l(0) \} \\
  &= \left[ g^{-1}(a,l(0)) - g^{-1}(a^*,l(0)) \right](\alpha_M + \alpha_{AM} a)
\end{align*}

Marginal Natural Direct and Indirect effect can then be obtained:
\begin{align*}
  \text{PNDE} &= \sum_{l(0)} \left[ \text{PNDE} \mid L(0) = l(0) \right] \times P(L(0)=l(0)) \\
  \quad \text{TNIE} &= \sum_{l(0)} \left[ \text{TNIE} \mid L(0) = l(0) \right] \times P(L(0)=l(0))
\end{align*}

\subsection{Estimation of the 2 MSMs coefficients by IPTW for NDE and NIE}\label{estimation-of-the-2-msms-coefficients-by-iptw-for-nde-and-nie}

As previously, MSM coefficients can be estimated using an Inverse Probability of Treatment (IPTW) approach based on weighted regressions.

In order to fit the 1st MSM \eqref{eq:MSM-Indirect-model1}, we can use a linear regression of the (observed) outcome \(Y\) on the exposure and mediator, adjusted for \(L(0)\), weighted by individual stabilized weights \(sw_{msm1,i}\) (\citeproc{ref-vanderweele2009}{VanderWeele 2009}):
\begin{equation*} 
  \mathbb{E}\left(Y \mid A,M,L(0)\right) = \alpha_0 + \alpha_A a + \alpha_M m + \alpha_{AM} a \times m + \alpha_{L(0)} L(0)
\end{equation*}

where \(sw_{msm1,i}\) is the product of two weights \(sw_{msm1,i} = sw_{A,i} \times sw_{M,i}\),
\begin{align*}
  sw_{A,i} =& \frac{P(A=a_i)}{P(A=a_i \mid L(0)=l(0)_i)} \quad \text{or} \quad sw_{A,i} = \frac{P(A=a_i \mid L(0)=l(0)_i)}{P(A=a_i \mid L(0)=l(0)_i)} = 1 \\
  sw_{M,i} =& \frac{P(M=m_i \mid A=a_i)}{P(M = m_i \mid A=a_i,L(0)=l(0)_i), L(1)=l(1)_i} \\
  & \quad \text{or} \quad sw_{M,i} = \frac{P(M=m_i \mid A=a_i,L(0)=l(0)_i)}{P(M = m_i \mid A=a_i,L(0)=l(0)_i), L(1)=l(1)_i} \\
\end{align*}

In order to fit the 2nd MSM \eqref{eq:MSM-Indirect-model2}, we can use a logistic regression of the (observed) mediator \(M\) on the exposure, adjusted for \(L(0)\), weighted by individual stabilized weights \(sw_{msm2,i}\):
\begin{equation*}
 \text{logit} \mathbb{E}(M \mid a,l(0)) = \beta_0 + \beta_A a + \beta_{L(0)} l(0)
\end{equation*}

\begin{equation*}
 \text{where} \quad sw_{msm2,i} = \frac{P(A=a_i)}{P(A=a_i \mid L(0)=l(0)_i)}
\end{equation*}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\#\# MSM of NDE \& NIE, estimated by IPTW {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\DocumentationTok{\#\# 1. Stabilized weight for the MSM1}
\CommentTok{\# 1a. sw\_Ai = g(A=a\_i | L(0)) / g(A=a\_i | L(0)) = 1}
\NormalTok{sw\_Ai }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\DecValTok{1}\NormalTok{, }\FunctionTok{nrow}\NormalTok{(df1\_int))}

\CommentTok{\# 1b. sw\_Mi = g(M=m\_i | A,L(0)) / g(M=m\_i | A,L(0),L(1))}
\NormalTok{g.M.AL0 }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(M\_diabetes }\SpecialCharTok{\textasciitilde{}}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env,}
               \AttributeTok{family =} \StringTok{"binomial"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df1\_int)}
\NormalTok{g.Mis1.AL0 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(g.M.AL0, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}
\NormalTok{sw\_M.num }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{, }\FunctionTok{nrow}\NormalTok{(df1\_int))}
\NormalTok{sw\_M.num[df1\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes}\SpecialCharTok{==}\DecValTok{1}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ g.Mis1.AL0[df1\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes}\SpecialCharTok{==}\DecValTok{1}\NormalTok{]}
\NormalTok{sw\_M.num[df1\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes}\SpecialCharTok{==}\DecValTok{0}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ g.Mis1.AL0[df1\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes}\SpecialCharTok{==}\DecValTok{0}\NormalTok{])}

\NormalTok{g.M.AL0L1 }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(M\_diabetes }\SpecialCharTok{\textasciitilde{}}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ L1,}
                 \AttributeTok{family =} \StringTok{"binomial"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df1\_int)}
\NormalTok{g.Mis1.AL0L1 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(g.M.AL0L1, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}
\NormalTok{sw\_M.denom }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{, }\FunctionTok{nrow}\NormalTok{(df1\_int))}
\NormalTok{sw\_M.denom[df1\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes}\SpecialCharTok{==}\DecValTok{1}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ g.Mis1.AL0L1[df1\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes}\SpecialCharTok{==}\DecValTok{1}\NormalTok{]}
\NormalTok{sw\_M.denom[df1\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes}\SpecialCharTok{==}\DecValTok{0}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ g.Mis1.AL0L1[df1\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes}\SpecialCharTok{==}\DecValTok{0}\NormalTok{])}

\NormalTok{sw\_msm1 }\OtherTok{\textless{}{-}}\NormalTok{ sw\_Ai }\SpecialCharTok{*}\NormalTok{ sw\_M.num }\SpecialCharTok{/}\NormalTok{ sw\_M.denom}

\DocumentationTok{\#\# 2. Estimate coefficients of the MSM1}
\NormalTok{MSM1 }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Y\_death }\SpecialCharTok{\textasciitilde{}}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+}\NormalTok{ M\_diabetes }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5}\SpecialCharTok{:}\NormalTok{M\_diabetes }\SpecialCharTok{+}
\NormalTok{              L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env,}
            \AttributeTok{weights =}\NormalTok{ sw\_msm1,}
            \AttributeTok{family =} \StringTok{"gaussian"}\NormalTok{,}
            \AttributeTok{data =}\NormalTok{ df1\_int)}
\FunctionTok{coef}\NormalTok{(MSM1)}
\CommentTok{\# (Intercept)     A0\_PM2.5  M\_diabetes    L0\_male L0\_soc\_env  A0\_PM2.5:M\_diabetes}
\CommentTok{\#  0.12033221   0.06381257  0.06691712 0.04671886 0.05521263           0.01652446}

\DocumentationTok{\#\# 3. Stabilized weight for the MSM2}
\CommentTok{\# 3a. sw\_A = g(A=a\_i) / g(A=a\_i | L(0))}
\CommentTok{\# numerator}
\NormalTok{g.A }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(A0\_PM2}\FloatTok{.5} \SpecialCharTok{\textasciitilde{}} \DecValTok{1}\NormalTok{, }\AttributeTok{family =} \StringTok{"binomial"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df1\_int)}
\NormalTok{g.Ais1 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(g.A, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}
\NormalTok{sw\_msm2.num }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{, }\FunctionTok{nrow}\NormalTok{(df1\_int))}
\NormalTok{sw\_msm2.num[df1\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\SpecialCharTok{==}\DecValTok{1}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ g.Ais1[df1\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\SpecialCharTok{==}\DecValTok{1}\NormalTok{]}
\NormalTok{sw\_msm2.num[df1\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\SpecialCharTok{==}\DecValTok{0}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ g.Ais1[df1\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\SpecialCharTok{==}\DecValTok{0}\NormalTok{])}

\CommentTok{\# denominator}
\NormalTok{g.A.L0 }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(A0\_PM2}\FloatTok{.5} \SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env,}
              \AttributeTok{family =} \StringTok{"binomial"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df1\_int)}
\NormalTok{g.Ais1.L0 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(g.A.L0, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}
\NormalTok{sw\_msm2.denom }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{, }\FunctionTok{nrow}\NormalTok{(df1\_int))}
\NormalTok{sw\_msm2.denom[df1\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\SpecialCharTok{==}\DecValTok{1}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ g.Ais1.L0[df1\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\SpecialCharTok{==}\DecValTok{1}\NormalTok{]}
\NormalTok{sw\_msm2.denom[df1\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\SpecialCharTok{==}\DecValTok{0}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ g.Ais1.L0[df1\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\SpecialCharTok{==}\DecValTok{0}\NormalTok{])}

\CommentTok{\# stabilized weight}
\NormalTok{sw\_msm2 }\OtherTok{\textless{}{-}}\NormalTok{ sw\_msm2.num }\SpecialCharTok{/}\NormalTok{ sw\_msm2.denom}

\DocumentationTok{\#\# 3. Estimate coefficients of the MSM2}
\NormalTok{MSM2 }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(M\_diabetes }\SpecialCharTok{\textasciitilde{}}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env,}
            \AttributeTok{weights =}\NormalTok{ sw\_msm2,}
            \AttributeTok{family =} \StringTok{"binomial"}\NormalTok{,}
            \AttributeTok{data =}\NormalTok{ df1\_int)}
\FunctionTok{coef}\NormalTok{(MSM2)}
\CommentTok{\# (Intercept)    A0\_PM2.5     L0\_male   L0\_soc\_env}
\CommentTok{\#  {-}1.2723106   0.5883720   0.2566129    0.3270087}

\DocumentationTok{\#\# 4. Estimate PNDE conditional on L(0), and the marginal value of PNDE}
\CommentTok{\# a = 1 and a* = 0}
\CommentTok{\# PNDE|L(0) = (a {-} a*)[alpha\_A + alpha\_AM.g\^{}{-}1(a\^{}*,l(0))]}
\NormalTok{g.minus1.A0 }\OtherTok{\textless{}{-}} \FunctionTok{plogis}\NormalTok{(}\FunctionTok{coef}\NormalTok{(MSM2)[}\StringTok{"(Intercept)"}\NormalTok{] }\SpecialCharTok{+} \FunctionTok{coef}\NormalTok{(MSM2)[}\StringTok{"A0\_PM2.5"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+}
                      \FunctionTok{coef}\NormalTok{(MSM2)[}\StringTok{"L0\_male"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ df1\_int}\SpecialCharTok{$}\NormalTok{L0\_male }\SpecialCharTok{+}
                      \FunctionTok{coef}\NormalTok{(MSM2)[}\StringTok{"L0\_soc\_env"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ df1\_int}\SpecialCharTok{$}\NormalTok{L0\_soc\_env)}

\CommentTok{\# PNDE conditional on L(0)}
\NormalTok{PNDE\_L0 }\OtherTok{\textless{}{-}}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}} \DecValTok{0}\NormalTok{) }\SpecialCharTok{*}\NormalTok{ (}\FunctionTok{coef}\NormalTok{(MSM1)[}\StringTok{"A0\_PM2.5"}\NormalTok{] }\SpecialCharTok{+}
                        \FunctionTok{coef}\NormalTok{(MSM1)[}\StringTok{"A0\_PM2.5:M\_diabetes"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ g.minus1.A0)}
\CommentTok{\# marginal PNDE}
\NormalTok{PNDE }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(PNDE\_L0)}
\CommentTok{\# [1] 0.06850657}

\DocumentationTok{\#\# 4. Estimate TNIE conditional on L(0), and the marginal value of TNIE}
\CommentTok{\# TNIE|L(0) = [g\^{}{-}1(a,l(0)) {-} g\^{}{-}1(a\^{}*,l(0))] * (alpha\_M + alpha\_AM * a)}
\NormalTok{g.minus1.A1 }\OtherTok{\textless{}{-}} \FunctionTok{plogis}\NormalTok{(}\FunctionTok{coef}\NormalTok{(MSM2)[}\StringTok{"(Intercept)"}\NormalTok{] }\SpecialCharTok{+} \FunctionTok{coef}\NormalTok{(MSM2)[}\StringTok{"A0\_PM2.5"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+}
                        \FunctionTok{coef}\NormalTok{(MSM2)[}\StringTok{"L0\_male"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ df1\_int}\SpecialCharTok{$}\NormalTok{L0\_male }\SpecialCharTok{+}
                        \FunctionTok{coef}\NormalTok{(MSM2)[}\StringTok{"L0\_soc\_env"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ df1\_int}\SpecialCharTok{$}\NormalTok{L0\_soc\_env)}

\CommentTok{\# TNIE conditional on L(0)}
\NormalTok{TNIE\_L0 }\OtherTok{\textless{}{-}}\NormalTok{ (g.minus1.A1 }\SpecialCharTok{{-}}\NormalTok{ g.minus1.A0) }\SpecialCharTok{*}\NormalTok{ (}\FunctionTok{coef}\NormalTok{(MSM1)[}\StringTok{"M\_diabetes"}\NormalTok{] }\SpecialCharTok{+}
                                            \FunctionTok{coef}\NormalTok{(MSM1)[}\StringTok{"A0\_PM2.5:M\_diabetes"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{)}
\CommentTok{\# marginal PNDE}
\NormalTok{TNIE }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(TNIE\_L0)}
\CommentTok{\# [1] 0.01096799}
\end{Highlighting}
\end{Shaded}

In this example, the estimation of the PNDE is 6.9\% and the estimation of the TNIE is 1.1\%. Confidence intervals can be calculated by bootstrap.

\section{\texorpdfstring{MSM estimated by the \texttt{CMAverse} package}{MSM estimated by the CMAverse package}}\label{msm_CMAverse}

\subsection{Calculation by hand, using the ``mediation formula''}\label{calculation-by-hand-using-the-mediation-formula}

The counterfactual quantity \(\mathbb{E}(Y_{a,M_{a^\prime}})\) used to defined the Natural Direct and Indirect effects can be expressed by the \emph{mediation formula} (conditional on \(\{L(0),L(1)\}\), or the population average):
\begin{align*}
  \mathbb{E}\left( Y_{a,M_{a^\prime}} \mid L(0),L(1) \right) &= \sum_m \mathbb{E}\left( Y_{a,m} \mid L(0),L(1) \right) \times \mathbb{P}\left(M_{a^\prime} = m \mid L(0),L(1)\right) \\
  \text{ or } & \\
  \mathbb{E}\left( Y_{a,M_{a^\prime}} \right) &= \sum_m \mathbb{E}\left( Y_{a,m} \right) \times \mathbb{P}(M_{a^\prime} = m) \\
\end{align*}

In order to estimate the \(\text{PNDE} = \mathbb{E}(Y_{1,M_0}) - \mathbb{E}(Y_{0,M_0})\) and the \(\text{TNIE} = \mathbb{E}(Y_{1,M_1}) - \mathbb{E}(Y_{1,M_0})\) we can estimate 2 Marginal Structural Models:

\begin{itemize}
\tightlist
\item
  a model of the counterfactual mediator (where \(g\) is a link function), for example:
  \begin{equation*}
    g \left[ \mathbb{P}(M_{a^\prime} = 1)\right] = \beta_0 + \beta_A a^\prime
  \end{equation*}
\item
  a model of the counterfactual outcome (where \(h\) is a link function), for example:
  \begin{equation*}
    h \left[ \mathbb{E}(Y_{a,m})\right] = \alpha_0 + \alpha_A a + \alpha_M m + \alpha_{A \ast M} a \times m)
  \end{equation*}
\end{itemize}

Below, we will estimate the coefficients of the 2 MSMs by Inverse Probability of Treatment Weighting (IPTW).

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{rm}\NormalTok{(}\AttributeTok{list=}\FunctionTok{ls}\NormalTok{())}
\NormalTok{df1\_int }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file =} \StringTok{"data/df1\_int.csv"}\NormalTok{)}

\DocumentationTok{\#\# 1. Stabilized weight for the exposure sw\_\{A,i\}}
\CommentTok{\# 1a. Estimate g(A=a\_i|L(0)) (denominator of the weight)}
\NormalTok{g.A.L }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(A0\_PM2}\FloatTok{.5} \SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ L1,}
             \AttributeTok{family =} \StringTok{"binomial"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df1\_int)}
\FunctionTok{summary}\NormalTok{(g.A.L)}
\CommentTok{\# Coefficients:}
\CommentTok{\#               Estimate Std. Error z value Pr(\textgreater{}|z|)}
\CommentTok{\#   (Intercept) {-}2.74236    0.07729 {-}35.484  \textless{} 2e{-}16 ***}
\CommentTok{\#   L0\_male      0.40610    0.06448   6.298 3.01e{-}10 ***}
\CommentTok{\#   L0\_soc\_env   0.64079    0.07350   8.718  \textless{} 2e{-}16 ***}
\CommentTok{\#   L1           0.03257    0.06968   0.467     0.64}

\CommentTok{\# 1b. Predict each individual\textquotesingle{}s probability of being exposed to her own exposure}
\CommentTok{\# the predicted probability of the observed treatment g(A = a\_i | L(0)) is :}
\NormalTok{gAi.L }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{, }\FunctionTok{nrow}\NormalTok{(df1\_int))}
\NormalTok{gAi.L[df1\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\SpecialCharTok{==}\DecValTok{1}\NormalTok{] }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(g.A.L, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)[df1\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\SpecialCharTok{==}\DecValTok{1}\NormalTok{]}
\NormalTok{gAi.L[df1\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\SpecialCharTok{==}\DecValTok{0}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}} \FunctionTok{predict}\NormalTok{(g.A.L, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{))[df1\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\SpecialCharTok{==}\DecValTok{0}\NormalTok{]}

\CommentTok{\# 1c. Estimate g(A=a\_i) (numerator of the weight)}
\NormalTok{g.A }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(A0\_PM2}\FloatTok{.5} \SpecialCharTok{\textasciitilde{}} \DecValTok{1}\NormalTok{, }\AttributeTok{family =} \StringTok{"binomial"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df1\_int)}
\CommentTok{\# 1d. Predict each individual\textquotesingle{}s probability of being exposed to her own exposure}
\CommentTok{\# the predicted probability of the observed treatment g(A = a\_i) is :}
\NormalTok{gAi }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{, }\FunctionTok{nrow}\NormalTok{(df1\_int))}
\NormalTok{gAi[df1\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\SpecialCharTok{==}\DecValTok{1}\NormalTok{] }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(g.A, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)[df1\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\SpecialCharTok{==}\DecValTok{1}\NormalTok{]}
\NormalTok{gAi[df1\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\SpecialCharTok{==}\DecValTok{0}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}} \FunctionTok{predict}\NormalTok{(g.A, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{))[df1\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\SpecialCharTok{==}\DecValTok{0}\NormalTok{]}

\CommentTok{\# 1e. Calculate sw\_\{A,i\}}
\NormalTok{sw\_Ai }\OtherTok{\textless{}{-}}\NormalTok{ gAi }\SpecialCharTok{/}\NormalTok{ gAi.L}

\DocumentationTok{\#\# 2. Stabilized weight for the mediator sw\_\{M,i\}}
\CommentTok{\# 2a. Estimate g(M=m\_i|L(0),A,L(1)) (denominator of the weight)}
\NormalTok{g.M.L }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(M\_diabetes }\SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+}\NormalTok{ L1,}
             \AttributeTok{family =} \StringTok{"binomial"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df1\_int)}
\FunctionTok{summary}\NormalTok{(g.M.L)}
\CommentTok{\#               Estimate Std. Error z value Pr(\textgreater{}|z|)}
\CommentTok{\#   (Intercept) {-}1.37880    0.04872 {-}28.303  \textless{} 2e{-}16 ***}
\CommentTok{\#   L0\_male      0.25861    0.04437   5.829 5.57e{-}09 ***}
\CommentTok{\#   L0\_soc\_env   0.33050    0.04744   6.967 3.23e{-}12 ***}
\CommentTok{\#   A0\_PM2.5     0.56260    0.06555   8.583  \textless{} 2e{-}16 ***}
\CommentTok{\#   L1           0.33462    0.04744   7.054 1.74e{-}12 ***}

\CommentTok{\# 2b. Predict each individual\textquotesingle{}s probability of being exposed to her own exposure}
\CommentTok{\# the predicted probability of the observed treatment g(A = a\_i | L(0)) is :}
\NormalTok{gMi.L }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{, }\FunctionTok{nrow}\NormalTok{(df1\_int))}
\NormalTok{gMi.L[df1\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes}\SpecialCharTok{==}\DecValTok{1}\NormalTok{] }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(g.M.L, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)[df1\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes}\SpecialCharTok{==}\DecValTok{1}\NormalTok{]}
\NormalTok{gMi.L[df1\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes}\SpecialCharTok{==}\DecValTok{0}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}} \FunctionTok{predict}\NormalTok{(g.M.L, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{))[df1\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes}\SpecialCharTok{==}\DecValTok{0}\NormalTok{]}

\CommentTok{\# 2c. Estimate g(M=m\_i|A) (numerator of the weight)}
\NormalTok{g.M.A }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(M\_diabetes }\SpecialCharTok{\textasciitilde{}}\NormalTok{ A0\_PM2}\FloatTok{.5}\NormalTok{, }\AttributeTok{family =} \StringTok{"binomial"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df1\_int)}
\FunctionTok{summary}\NormalTok{(g.M.A)}
\CommentTok{\#               Estimate Std. Error z value Pr(\textgreater{}|z|)}
\CommentTok{\#   (Intercept) {-}0.93236    0.02358 {-}39.544   \textless{}2e{-}16 ***}
\CommentTok{\#   A0\_PM2.5     0.62388    0.06481   9.627   \textless{}2e{-}16 ***}

\CommentTok{\# 2d. Predict each individual\textquotesingle{}s probability of being exposed to her own exposure}
\CommentTok{\# the predicted probability of the observed treatment g(M = m\_i|A) is :}
\NormalTok{gMi.A }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{, }\FunctionTok{nrow}\NormalTok{(df1\_int))}
\NormalTok{gMi.A[df1\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes}\SpecialCharTok{==}\DecValTok{1}\NormalTok{] }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(g.M.A, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)[df1\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes}\SpecialCharTok{==}\DecValTok{1}\NormalTok{]}
\NormalTok{gMi.A[df1\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes}\SpecialCharTok{==}\DecValTok{0}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}} \FunctionTok{predict}\NormalTok{(g.M.A, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{))[df1\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes}\SpecialCharTok{==}\DecValTok{0}\NormalTok{]}
\CommentTok{\# 2e. Calculate sw\_\{M,i\}}
\NormalTok{sw\_Mi }\OtherTok{\textless{}{-}}\NormalTok{ gMi.A }\SpecialCharTok{/}\NormalTok{ gMi.L}

\DocumentationTok{\#\# 3. Estimate marginal model for the counterfactual outcome Y\_\{am\}}
\NormalTok{model.Yam.death }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Y\_death }\SpecialCharTok{\textasciitilde{}}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{*}\NormalTok{ M\_diabetes,}
                       \AttributeTok{weights =}\NormalTok{ sw\_Ai }\SpecialCharTok{*}\NormalTok{ sw\_Mi,}
                       \AttributeTok{family =} \StringTok{"gaussian"}\NormalTok{,}
                       \AttributeTok{data =}\NormalTok{ df1\_int)}
\FunctionTok{summary}\NormalTok{(model.Yam.death)}
\CommentTok{\# Coefficients:}
\CommentTok{\#                        Estimate Std. Error t value Pr(\textgreater{}|t|)}
\CommentTok{\#   (Intercept)          0.178967   0.005049  35.445  \textless{} 2e{-}16 ***}
\CommentTok{\#   A0\_PM2.5             0.067151   0.016679   4.026 5.72e{-}05 ***}
\CommentTok{\#   M\_diabetes           0.067321   0.009508   7.080 1.54e{-}12 ***}
\CommentTok{\#   A0\_PM2.5:M\_diabetes {-}0.004491   0.026027  {-}0.173    0.863}

\DocumentationTok{\#\# 4) Estimate marginal model for the counterfactual mediator P(M\_a* = 1)}
\NormalTok{model.Ma }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(M\_diabetes }\SpecialCharTok{\textasciitilde{}}\NormalTok{ A0\_PM2}\FloatTok{.5}\NormalTok{,}
                \AttributeTok{weights =}\NormalTok{ sw\_Ai,}
                \AttributeTok{family =} \StringTok{"binomial"}\NormalTok{,}
                \AttributeTok{data =}\NormalTok{ df1\_int)}
\FunctionTok{summary}\NormalTok{(model.Ma)}
\CommentTok{\# Coefficients:}
\CommentTok{\#               Estimate Std. Error z value Pr(\textgreater{}|z|)}
\CommentTok{\#   (Intercept) {-}0.92405    0.02353 {-}39.264   \textless{}2e{-}16 ***}
\CommentTok{\#   A0\_PM2.5     0.58413    0.06501   8.986   \textless{}2e{-}16 ***}

\DocumentationTok{\#\# 5) Estimate population average counterfactuals using the "mediation formula"}
\DocumentationTok{\#\#    E(Y\_\{a,M\_a*\}) = sum\_m E(Y\_\{am\}) * P(M\_a\^{}* = m)}
\NormalTok{E.Y0M0 }\OtherTok{\textless{}{-}}\NormalTok{ ((}\FunctionTok{coef}\NormalTok{(model.Yam.death)[}\StringTok{"(Intercept)"}\NormalTok{] }\SpecialCharTok{+} \CommentTok{\# sum\_m E(Y\_\{a0\}) * P(M\_a\^{}* = 0)}
             \FunctionTok{coef}\NormalTok{(model.Yam.death)[}\StringTok{"A0\_PM2.5"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+}
             \FunctionTok{coef}\NormalTok{(model.Yam.death)[}\StringTok{"M\_diabetes"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+}
             \FunctionTok{coef}\NormalTok{(model.Yam.death)[}\StringTok{"A0\_PM2.5:M\_diabetes"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{*} \DecValTok{0}\NormalTok{) }\SpecialCharTok{*}
\NormalTok{             (}\DecValTok{1} \SpecialCharTok{{-}} \FunctionTok{plogis}\NormalTok{(}\FunctionTok{coef}\NormalTok{(model.Ma)[}\StringTok{"(Intercept)"}\NormalTok{] }\SpecialCharTok{+}
                           \FunctionTok{coef}\NormalTok{(model.Ma)[}\StringTok{"A0\_PM2.5"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{))) }\SpecialCharTok{+}
\NormalTok{  ((}\FunctionTok{coef}\NormalTok{(model.Yam.death)[}\StringTok{"(Intercept)"}\NormalTok{] }\SpecialCharTok{+}  \CommentTok{\# sum\_m E(Y\_\{a1\}) * P(M\_a\^{}* = 1)}
      \FunctionTok{coef}\NormalTok{(model.Yam.death)[}\StringTok{"A0\_PM2.5"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+}
      \FunctionTok{coef}\NormalTok{(model.Yam.death)[}\StringTok{"M\_diabetes"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+}
      \FunctionTok{coef}\NormalTok{(model.Yam.death)[}\StringTok{"A0\_PM2.5:M\_diabetes"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{*} \DecValTok{1}\NormalTok{) }\SpecialCharTok{*}
\NormalTok{     (}\FunctionTok{plogis}\NormalTok{(}\FunctionTok{coef}\NormalTok{(model.Ma)[}\StringTok{"(Intercept)"}\NormalTok{] }\SpecialCharTok{+}
               \FunctionTok{coef}\NormalTok{(model.Ma)[}\StringTok{"A0\_PM2.5"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{)))}

\NormalTok{E.Y1M0 }\OtherTok{\textless{}{-}}\NormalTok{ ((}\FunctionTok{coef}\NormalTok{(model.Yam.death)[}\StringTok{"(Intercept)"}\NormalTok{] }\SpecialCharTok{+} \CommentTok{\# sum\_m E(Y\_\{a,M=0\}) * P(M\_0 = 0)}
              \FunctionTok{coef}\NormalTok{(model.Yam.death)[}\StringTok{"A0\_PM2.5"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+}
              \FunctionTok{coef}\NormalTok{(model.Yam.death)[}\StringTok{"M\_diabetes"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+}
              \FunctionTok{coef}\NormalTok{(model.Yam.death)[}\StringTok{"A0\_PM2.5:M\_diabetes"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*} \DecValTok{0}\NormalTok{) }\SpecialCharTok{*}
\NormalTok{             (}\DecValTok{1} \SpecialCharTok{{-}} \FunctionTok{plogis}\NormalTok{(}\FunctionTok{coef}\NormalTok{(model.Ma)[}\StringTok{"(Intercept)"}\NormalTok{] }\SpecialCharTok{+}
                           \FunctionTok{coef}\NormalTok{(model.Ma)[}\StringTok{"A0\_PM2.5"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{))) }\SpecialCharTok{+}
\NormalTok{  ((}\FunctionTok{coef}\NormalTok{(model.Yam.death)[}\StringTok{"(Intercept)"}\NormalTok{] }\SpecialCharTok{+}  \CommentTok{\# sum\_m E(Y\_\{a,M=1\}) * P(M\_0 = 1)}
      \FunctionTok{coef}\NormalTok{(model.Yam.death)[}\StringTok{"A0\_PM2.5"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+}
      \FunctionTok{coef}\NormalTok{(model.Yam.death)[}\StringTok{"M\_diabetes"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+}
      \FunctionTok{coef}\NormalTok{(model.Yam.death)[}\StringTok{"A0\_PM2.5:M\_diabetes"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*} \DecValTok{1}\NormalTok{) }\SpecialCharTok{*}
\NormalTok{     (}\FunctionTok{plogis}\NormalTok{(}\FunctionTok{coef}\NormalTok{(model.Ma)[}\StringTok{"(Intercept)"}\NormalTok{] }\SpecialCharTok{+}
               \FunctionTok{coef}\NormalTok{(model.Ma)[}\StringTok{"A0\_PM2.5"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{)))}

\NormalTok{E.Y1M1 }\OtherTok{\textless{}{-}}\NormalTok{ ((}\FunctionTok{coef}\NormalTok{(model.Yam.death)[}\StringTok{"(Intercept)"}\NormalTok{] }\SpecialCharTok{+} \CommentTok{\#  E(Y\_\{a,M=0\}) * P(M\_1 = 0)}
              \FunctionTok{coef}\NormalTok{(model.Yam.death)[}\StringTok{"A0\_PM2.5"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+}
              \FunctionTok{coef}\NormalTok{(model.Yam.death)[}\StringTok{"M\_diabetes"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+}
              \FunctionTok{coef}\NormalTok{(model.Yam.death)[}\StringTok{"A0\_PM2.5:M\_diabetes"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*} \DecValTok{0}\NormalTok{) }\SpecialCharTok{*}
\NormalTok{             (}\DecValTok{1} \SpecialCharTok{{-}} \FunctionTok{plogis}\NormalTok{(}\FunctionTok{coef}\NormalTok{(model.Ma)[}\StringTok{"(Intercept)"}\NormalTok{] }\SpecialCharTok{+}
                           \FunctionTok{coef}\NormalTok{(model.Ma)[}\StringTok{"A0\_PM2.5"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{))) }\SpecialCharTok{+}
\NormalTok{  ((}\FunctionTok{coef}\NormalTok{(model.Yam.death)[}\StringTok{"(Intercept)"}\NormalTok{] }\SpecialCharTok{+}  \CommentTok{\#  E(Y\_\{a,M=1\}) * P(M\_1 = 1)}
      \FunctionTok{coef}\NormalTok{(model.Yam.death)[}\StringTok{"A0\_PM2.5"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+}
      \FunctionTok{coef}\NormalTok{(model.Yam.death)[}\StringTok{"M\_diabetes"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+}
      \FunctionTok{coef}\NormalTok{(model.Yam.death)[}\StringTok{"A0\_PM2.5:M\_diabetes"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*} \DecValTok{1}\NormalTok{) }\SpecialCharTok{*}
\NormalTok{     (}\FunctionTok{plogis}\NormalTok{(}\FunctionTok{coef}\NormalTok{(model.Ma)[}\StringTok{"(Intercept)"}\NormalTok{] }\SpecialCharTok{+}
               \FunctionTok{coef}\NormalTok{(model.Ma)[}\StringTok{"A0\_PM2.5"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{)))}

\NormalTok{PNDE.death }\OtherTok{\textless{}{-}}\NormalTok{ E.Y1M0 }\SpecialCharTok{{-}}\NormalTok{ E.Y0M0}
\CommentTok{\# 0.06587481}
\NormalTok{TNIE.death }\OtherTok{\textless{}{-}}\NormalTok{ E.Y1M1 }\SpecialCharTok{{-}}\NormalTok{ E.Y1M0}
\CommentTok{\# 0.008274351}
\end{Highlighting}
\end{Shaded}

In the example above, we directly used the estimated coefficients of the MSMs to calculate the quantities \(\mathbb{E}(Y_{a,M_{a^\prime}})\) for the PNDE and the TNIE. When using the CMAverse, individual values for the counterfactual mediator are simulated as shown below. This strategy can be useful if the mediator is continuous of high-dimensional.

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# 6) Estimate population average counterfactuals using simulated}
\DocumentationTok{\#\#    values of the mediator}
\NormalTok{PNDE.death.sim }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{,}\DecValTok{5}\NormalTok{)}
\NormalTok{TNIE.death.sim }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{,}\DecValTok{5}\NormalTok{)}

\FunctionTok{set.seed}\NormalTok{(}\DecValTok{1234}\NormalTok{)}
\ControlFlowTok{for}\NormalTok{(k }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{15}\NormalTok{)\{}
\NormalTok{  M0 }\OtherTok{\textless{}{-}} \FunctionTok{rbinom}\NormalTok{(}\AttributeTok{n =} \FunctionTok{nrow}\NormalTok{(df1\_int), }\AttributeTok{size =} \DecValTok{1}\NormalTok{,}
               \AttributeTok{prob =} \FunctionTok{plogis}\NormalTok{(}\FunctionTok{coef}\NormalTok{(model.Ma)[}\StringTok{"(Intercept)"}\NormalTok{] }\SpecialCharTok{+}
                               \FunctionTok{coef}\NormalTok{(model.Ma)[}\StringTok{"A0\_PM2.5"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{))}
\NormalTok{  M1 }\OtherTok{\textless{}{-}} \FunctionTok{rbinom}\NormalTok{(}\AttributeTok{n =} \FunctionTok{nrow}\NormalTok{(df1\_int), }\AttributeTok{size =} \DecValTok{1}\NormalTok{,}
               \AttributeTok{prob =} \FunctionTok{plogis}\NormalTok{(}\FunctionTok{coef}\NormalTok{(model.Ma)[}\StringTok{"(Intercept)"}\NormalTok{] }\SpecialCharTok{+}
                               \FunctionTok{coef}\NormalTok{(model.Ma)[}\StringTok{"A0\_PM2.5"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{))}
\NormalTok{  E.Y0M0 }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{((}\FunctionTok{coef}\NormalTok{(model.Yam.death)[}\StringTok{"(Intercept)"}\NormalTok{] }\SpecialCharTok{+}
                    \FunctionTok{coef}\NormalTok{(model.Yam.death)[}\StringTok{"A0\_PM2.5"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+}
                    \FunctionTok{coef}\NormalTok{(model.Yam.death)[}\StringTok{"M\_diabetes"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ M0 }\SpecialCharTok{+}
                    \FunctionTok{coef}\NormalTok{(model.Yam.death)[}\StringTok{"A0\_PM2.5:M\_diabetes"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{*}\NormalTok{ M0))}
\NormalTok{  E.Y1M0 }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{((}\FunctionTok{coef}\NormalTok{(model.Yam.death)[}\StringTok{"(Intercept)"}\NormalTok{] }\SpecialCharTok{+}
                    \FunctionTok{coef}\NormalTok{(model.Yam.death)[}\StringTok{"A0\_PM2.5"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+}
                    \FunctionTok{coef}\NormalTok{(model.Yam.death)[}\StringTok{"M\_diabetes"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ M0 }\SpecialCharTok{+}
                    \FunctionTok{coef}\NormalTok{(model.Yam.death)[}\StringTok{"A0\_PM2.5:M\_diabetes"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*}\NormalTok{ M0))}
\NormalTok{  E.Y1M1 }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{((}\FunctionTok{coef}\NormalTok{(model.Yam.death)[}\StringTok{"(Intercept)"}\NormalTok{] }\SpecialCharTok{+}
                \FunctionTok{coef}\NormalTok{(model.Yam.death)[}\StringTok{"A0\_PM2.5"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+}
                \FunctionTok{coef}\NormalTok{(model.Yam.death)[}\StringTok{"M\_diabetes"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ M1 }\SpecialCharTok{+}
                \FunctionTok{coef}\NormalTok{(model.Yam.death)[}\StringTok{"A0\_PM2.5:M\_diabetes"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*}\NormalTok{ M1))}
\NormalTok{  PNDE.death.sim[k] }\OtherTok{\textless{}{-}}\NormalTok{ E.Y1M0  }\SpecialCharTok{{-}}\NormalTok{ E.Y0M0}
\NormalTok{  TNIE.death.sim[k] }\OtherTok{\textless{}{-}}\NormalTok{ E.Y1M1 }\SpecialCharTok{{-}}\NormalTok{ E.Y1M0}
\NormalTok{\}}
\FunctionTok{mean}\NormalTok{(PNDE.death.sim)}
\CommentTok{\# [1] 0.06587304}
\FunctionTok{mean}\NormalTok{(TNIE.death.sim)}
\CommentTok{\# [1] 0.00824998}
\end{Highlighting}
\end{Shaded}

\subsection{Estimation of NDE and NIE using CMAverse (by IPTW or gcomputation)}\label{estimation-of-nde-and-nie-using-cmaverse-by-iptw-or-gcomputation}

We can use the \texttt{CMAverse} package to estimate the coefficients of the 2 MSMs required to estimate Natural Direct and Indirect Effects.

For estimation by IPTW, we have to specify the following arguments \texttt{model\ =\ msm} (to estimate the MSM of the outcome and the MSM of the mediator), and that the counterfactual mediator values are simulated (\texttt{estimation\ =\ "imputation"}). Because the coefficients of the MSMs are estimated by IPTW, we have to specify

\begin{itemize}
\tightlist
\item
  the link functions for the MSM of the outcome (\texttt{yreg}) and the MSM of the mediator (\texttt{mreg})
\item
  and the link function to calculate the weights \texttt{ereg} for \(\mathbb{P}(A=1|L(0))\), \texttt{wmnomreg} for the numerator of the mediator's weight and \texttt{wmdenomreg} for the denominator of the mediator's weight.
\end{itemize}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# Using the CMAverse to estimate MSM estimated by IPTW}
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{1234}\NormalTok{) }\CommentTok{\# note: there is randomness, even with estimation by IPTW}
               \CommentTok{\#       =\textgreater{} counterfactuals are imputed (estimation = "imputation")}
\NormalTok{res\_msm\_df1 }\OtherTok{\textless{}{-}} \FunctionTok{cmest}\NormalTok{(}\AttributeTok{data =}\NormalTok{ df1\_int,}
                     \AttributeTok{model =} \StringTok{"msm"}\NormalTok{,}
                     \AttributeTok{outcome =} \StringTok{"Y\_death"}\NormalTok{,}
                     \AttributeTok{exposure =} \StringTok{"A0\_PM2.5"}\NormalTok{,}
                     \AttributeTok{mediator =} \StringTok{"M\_diabetes"}\NormalTok{,}
                     \AttributeTok{basec =} \FunctionTok{c}\NormalTok{(}\StringTok{"L0\_male"}\NormalTok{, }\StringTok{"L0\_soc\_env"}\NormalTok{,}\StringTok{"L1"}\NormalTok{),}
                     \AttributeTok{postc =} \ConstantTok{NULL}\NormalTok{,}
                     \AttributeTok{EMint =} \ConstantTok{TRUE}\NormalTok{, }\CommentTok{\# E*M interaction}
                     \AttributeTok{ereg =} \StringTok{"logistic"}\NormalTok{, }\CommentTok{\# exposure regression model g(A=1|L(0))}
                     \AttributeTok{yreg =} \StringTok{"linear"}\NormalTok{, }\CommentTok{\# to get risk difference}
                     \AttributeTok{mreg =} \FunctionTok{list}\NormalTok{(}\StringTok{"logistic"}\NormalTok{), }\CommentTok{\# mediation model g(M=1|L1,A,L0)}
                     \AttributeTok{wmnomreg =} \FunctionTok{list}\NormalTok{(}\StringTok{"logistic"}\NormalTok{), }\CommentTok{\#g(M=1|A) wgt nominator}
                     \AttributeTok{wmdenomreg =} \FunctionTok{list}\NormalTok{(}\StringTok{"logistic"}\NormalTok{), }\CommentTok{\# g(M=1|L1,A,L(0)) wgt denom}
                     \AttributeTok{astar =} \DecValTok{0}\NormalTok{, }\CommentTok{\#E(Y\_\{A=0,M=1\})}
                     \AttributeTok{a =} \DecValTok{1}\NormalTok{,  }\CommentTok{\#E(Y\_\{A=1,M=1\})}
                     \AttributeTok{mval =} \FunctionTok{list}\NormalTok{(}\DecValTok{0}\NormalTok{), }\CommentTok{\# mediator value at which the variable is controlled}
                     \AttributeTok{estimation =} \StringTok{"imputation"}\NormalTok{,}
                     \AttributeTok{inference =} \StringTok{"bootstrap"}\NormalTok{,}
                     \AttributeTok{nboot =} \DecValTok{2}\NormalTok{)}
\FunctionTok{summary}\NormalTok{(res\_msm\_df1)}
\CommentTok{\# Causal Mediation Analysis}
\CommentTok{\#}
\CommentTok{\# \# Outcome regression:}
\CommentTok{\# Call:}
\CommentTok{\#   glm(formula = Y\_death \textasciitilde{} A0\_PM2.5 + M\_diabetes + A0\_PM2.5 * M\_diabetes,}
\CommentTok{\#       family = gaussian(), data = getCall(x$reg.output$yreg)$data,}
\CommentTok{\#       weights = getCall(x$reg.output$yreg)$weights)}
\CommentTok{\# Coefficients:}
\CommentTok{\#                        Estimate Std. Error t value Pr(\textgreater{}|t|)}
\CommentTok{\#   (Intercept)          0.178967   0.005049  35.445  \textless{} 2e{-}16 ***}
\CommentTok{\#   A0\_PM2.5             0.067151   0.016679   4.026 5.72e{-}05 ***}
\CommentTok{\#   M\_diabetes           0.067321   0.009508   7.080 1.54e{-}12 ***}
\CommentTok{\#   A0\_PM2.5:M\_diabetes {-}0.004491   0.026027  {-}0.173    0.863}
\CommentTok{\#}
\CommentTok{\# \# Mediator regressions:}
\CommentTok{\# Call:}
\CommentTok{\#   glm(formula = M\_diabetes \textasciitilde{} A0\_PM2.5, family = binomial(), }
\CommentTok{\#       data = getCall(x$reg.output$mreg[[1L]])$data,}
\CommentTok{\#       weights = getCall(x$reg.output$mreg[[1L]])$weights)}
\CommentTok{\# Coefficients:}
\CommentTok{\#               Estimate Std. Error z value Pr(\textgreater{}|z|)}
\CommentTok{\#   (Intercept) {-}0.92405    0.02353 {-}39.264   \textless{}2e{-}16 ***}
\CommentTok{\#   A0\_PM2.5     0.58413    0.06501   8.986   \textless{}2e{-}16 ***}
\CommentTok{\#}
\CommentTok{\# \# Mediator regressions for weighting (denominator):}
\CommentTok{\# Call:}
\CommentTok{\#   glm(formula = M\_diabetes \textasciitilde{} A0\_PM2.5 + L0\_male + L0\_soc\_env +}
\CommentTok{\#         L1, family = binomial(), data = getCall(x$reg.output$wmdenomreg[[1L]])$data,}
\CommentTok{\#       weights = getCall(x$reg.output$wmdenomreg[[1L]])$weights)}
\CommentTok{\# Coefficients:}
\CommentTok{\#               Estimate Std. Error z value Pr(\textgreater{}|z|)}
\CommentTok{\#   (Intercept) {-}1.37880    0.04872 {-}28.303  \textless{} 2e{-}16 ***}
\CommentTok{\#   A0\_PM2.5     0.56260    0.06555   8.583  \textless{} 2e{-}16 ***}
\CommentTok{\#   L0\_male      0.25861    0.04437   5.829 5.57e{-}09 ***}
\CommentTok{\#   L0\_soc\_env   0.33050    0.04744   6.967 3.23e{-}12 ***}
\CommentTok{\#   L1           0.33462    0.04744   7.054 1.74e{-}12 ***}
\CommentTok{\#}
\CommentTok{\# \# Mediator regressions for weighting (nominator):}
\CommentTok{\# Call:}
\CommentTok{\#   glm(formula = M\_diabetes \textasciitilde{} A0\_PM2.5, family = binomial(), }
\CommentTok{\#       data = getCall(x$reg.output$wmnomreg[[1L]])$data,}
\CommentTok{\#       weights = getCall(x$reg.output$wmnomreg[[1L]])$weights)}
\CommentTok{\# Coefficients:}
\CommentTok{\#               Estimate Std. Error z value Pr(\textgreater{}|z|)}
\CommentTok{\#   (Intercept) {-}0.93236    0.02358 {-}39.544   \textless{}2e{-}16 ***}
\CommentTok{\#   A0\_PM2.5     0.62388    0.06481   9.627   \textless{}2e{-}16 ***}
\CommentTok{\#}
\CommentTok{\# \# Exposure regression for weighting:}
\CommentTok{\# Call:}
\CommentTok{\#   glm(formula = A0\_PM2.5 \textasciitilde{} L0\_male + L0\_soc\_env + L1, family = binomial(),}
\CommentTok{\#       data = getCall(x$reg.output$ereg)$data, }
\CommentTok{\#       weights = getCall(x$reg.output$ereg)$weights)}
\CommentTok{\# Coefficients:}
\CommentTok{\#               Estimate Std. Error z value Pr(\textgreater{}|z|)}
\CommentTok{\#   (Intercept) {-}2.74236    0.07729 {-}35.484  \textless{} 2e{-}16 ***}
\CommentTok{\#   L0\_male      0.40610    0.06448   6.298 3.01e{-}10 ***}
\CommentTok{\#   L0\_soc\_env   0.64079    0.07350   8.718  \textless{} 2e{-}16 ***}
\CommentTok{\#   L1           0.03257    0.06968   0.467     0.64}
\CommentTok{\#}
\CommentTok{\# \# Effect decomposition on the mean difference scale via the marginal structural model}
\CommentTok{\# Direct counterfactual imputation estimation with}
\CommentTok{\# bootstrap standard errors, percentile confidence intervals and p{-}values}
\CommentTok{\#}
\CommentTok{\#                  Estimate  Std.error    95\% CIL 95\% CIU  P.val}
\CommentTok{\#   cde           0.0671509  0.0157808  0.0761499   0.097 \textless{}2e{-}16 ***}
\CommentTok{\#   pnde          0.0658727  0.0169713  0.0643983   0.087 \textless{}2e{-}16 *** \textless{}{-} PNDE}
\CommentTok{\#   tnde          0.0652889  0.0172698  0.0594343   0.083 \textless{}2e{-}16 ***}
\CommentTok{\#   pnie          0.0087514  0.0013389  0.0070189   0.009 \textless{}2e{-}16 ***}
\CommentTok{\#   tnie          0.0081675  0.0010405  0.0024559   0.004 \textless{}2e{-}16 *** \textless{}{-} TNDE}
\CommentTok{\#   te            0.0740402  0.0159309  0.0682520   0.090 \textless{}2e{-}16 ***}
\CommentTok{\#   intref       {-}0.0012782  0.0011906 {-}0.0117517  {-}0.010 \textless{}2e{-}16 ***}
\CommentTok{\#   intmed       {-}0.0005839  0.0002984 {-}0.0049640  {-}0.005 \textless{}2e{-}16 ***}
\CommentTok{\#   cde(prop)     0.9069522  0.0222813  1.0860362   1.116 \textless{}2e{-}16 ***}
\CommentTok{\#   intref(prop) {-}0.0172642  0.0439631 {-}0.1726807  {-}0.114 \textless{}2e{-}16 ***}
\CommentTok{\#   intmed(prop) {-}0.0078856  0.0162851 {-}0.0729153  {-}0.051 \textless{}2e{-}16 ***}
\CommentTok{\#   pnie(prop)    0.1181976  0.0379668  0.0786163   0.130 \textless{}2e{-}16 ***}
\CommentTok{\#   pm            0.1103120  0.0216818  0.0275800   0.057 \textless{}2e{-}16 ***}
\CommentTok{\#   int          {-}0.0251498  0.0602482 {-}0.2455960  {-}0.165 \textless{}2e{-}16 ***}
\CommentTok{\#   pe            0.0930478  0.0222813 {-}0.1159712  {-}0.086 \textless{}2e{-}16 ***}
\CommentTok{\#   {-}{-}{-}}
\CommentTok{\#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1}
\CommentTok{\#}
\CommentTok{\# (cde: controlled direct effect;}
\CommentTok{\#  pnde: pure natural direct effect;}
\CommentTok{\#  tnde: total natural direct effect;}
\CommentTok{\#  pnie: pure natural indirect effect;}
\CommentTok{\#  tnie: total natural indirect effect;}
\CommentTok{\#  te: total effect;}
\CommentTok{\#  intref: reference interaction;}
\CommentTok{\#  intmed: mediated interaction;}
\CommentTok{\#  cde(prop): proportion cde;}
\CommentTok{\#  intref(prop): proportion intref;}
\CommentTok{\#  intmed(prop): proportion intmed;}
\CommentTok{\#  pnie(prop): proportion pnie;}
\CommentTok{\#  pm: overall proportion mediated;}
\CommentTok{\#  int: overall proportion attributable to interaction;}
\CommentTok{\#  pe: overall proportion eliminated)}
\end{Highlighting}
\end{Shaded}

The CMAverse can also estimate the coefficients of the 2 MSM by (parametric) g-computation. For this estimation, we have to specify the following arguments \texttt{model\ =\ gformula}, and that the counterfactual outcome and mediator values are simulated (\texttt{estimation\ =\ "imputation"}). We don't need to specify the \texttt{ereg}, \texttt{wmnomreg} and \texttt{wmdenomreg} arguments which were used to calculate weights in the previous approach.

Note that the estimated models of the outcome and the mediator are conditional on baseline confounders \(L(0)\) and \(L(1)\).

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# Using the CMAverse to estimate MSM estimated by g{-}comp}
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{1234}\NormalTok{) }\CommentTok{\# note: there is randomness, even with estimation by IPTW}
\CommentTok{\#       =\textgreater{} counterfactuals are imputed (estimation = "imputation")}
\NormalTok{res\_msm\_df1.qol }\OtherTok{\textless{}{-}} \FunctionTok{cmest}\NormalTok{(}\AttributeTok{data =}\NormalTok{ df1\_int,}
                     \AttributeTok{model =} \StringTok{"gformula"}\NormalTok{,}
                     \AttributeTok{outcome =} \StringTok{"Y\_qol"}\NormalTok{,}
                     \AttributeTok{exposure =} \StringTok{"A0\_PM2.5"}\NormalTok{,}
                     \AttributeTok{mediator =} \StringTok{"M\_diabetes"}\NormalTok{,}
                     \AttributeTok{basec =} \FunctionTok{c}\NormalTok{(}\StringTok{"L0\_male"}\NormalTok{, }\StringTok{"L0\_soc\_env"}\NormalTok{,}\StringTok{"L1"}\NormalTok{),}
                     \AttributeTok{postc =} \ConstantTok{NULL}\NormalTok{,}
                     \AttributeTok{EMint =} \ConstantTok{TRUE}\NormalTok{, }\CommentTok{\# E*M interaction}
                     \CommentTok{\# ereg = "logistic", \# \# not needed with gcomp}
                     \AttributeTok{yreg =} \StringTok{"linear"}\NormalTok{, }\CommentTok{\# to get risk difference}
                     \AttributeTok{mreg =} \FunctionTok{list}\NormalTok{(}\StringTok{"logistic"}\NormalTok{), }\CommentTok{\# mediation model g(M=1|L1,A,L0)}
                     \CommentTok{\# wmnomreg = list("logistic"), \# not needed with gcomp}
                     \CommentTok{\# wmdenomreg = list("logistic"), \#\# not needed with gcomp}
                     \AttributeTok{astar =} \DecValTok{0}\NormalTok{, }\CommentTok{\#E(Y\_\{A=0,M=1\})}
                     \AttributeTok{a =} \DecValTok{1}\NormalTok{,  }\CommentTok{\#E(Y\_\{A=1,M=1\})}
                     \AttributeTok{mval =} \FunctionTok{list}\NormalTok{(}\DecValTok{0}\NormalTok{), }\CommentTok{\# mediator value at which the variable is controlled}
                     \AttributeTok{estimation =} \StringTok{"imputation"}\NormalTok{,}
                     \AttributeTok{inference =} \StringTok{"bootstrap"}\NormalTok{,}
                     \AttributeTok{nboot =} \DecValTok{2}\NormalTok{)}
\FunctionTok{summary}\NormalTok{(res\_msm\_df1.qol)}
\CommentTok{\# Causal Mediation Analysis}
\CommentTok{\#}
\CommentTok{\# \# Outcome regression:}
\CommentTok{\# Call:}
\CommentTok{\#   glm(formula = Y\_qol \textasciitilde{} A0\_PM2.5 + M\_diabetes + A0\_PM2.5 * M\_diabetes +}
\CommentTok{\#         L0\_male + L0\_soc\_env + L1, family = gaussian(), data = getCall(x$reg.output$yreg)$data,}
\CommentTok{\#       weights = getCall(x$reg.output$yreg)$weights)}
\CommentTok{\# Coefficients:}
\CommentTok{\#                       Estimate Std. Error t value Pr(\textgreater{}|t|)}
\CommentTok{\#   (Intercept)          74.7669     0.2139 349.557  \textless{} 2e{-}16 ***}
\CommentTok{\#   A0\_PM2.5             {-}3.7153     0.4160  {-}8.931  \textless{} 2e{-}16 ***}
\CommentTok{\#   M\_diabetes           {-}8.6317     0.2385 {-}36.197  \textless{} 2e{-}16 ***}
\CommentTok{\#   L0\_male              {-}0.7235     0.2018  {-}3.586 0.000337 ***}
\CommentTok{\#   L0\_soc\_env           {-}2.8899     0.2112 {-}13.684  \textless{} 2e{-}16 ***}
\CommentTok{\#   L1                   {-}3.4280     0.2212 {-}15.494  \textless{} 2e{-}16 ***}
\CommentTok{\#   A0\_PM2.5:M\_diabetes  {-}5.6154     0.6514  {-}8.621  \textless{} 2e{-}16 ***}
\CommentTok{\#}
\CommentTok{\# \# Mediator regressions:}
\CommentTok{\# Call:}
\CommentTok{\#   glm(formula = M\_diabetes \textasciitilde{} A0\_PM2.5 + L0\_male + L0\_soc\_env +}
\CommentTok{\#         L1, family = binomial(), data = getCall(x$reg.output$mreg[[1L]])$data,}
\CommentTok{\#       weights = getCall(x$reg.output$mreg[[1L]])$weights)}
\CommentTok{\# Coefficients:}
\CommentTok{\#               Estimate Std. Error z value Pr(\textgreater{}|z|)}
\CommentTok{\#   (Intercept) {-}1.37880    0.04872 {-}28.303  \textless{} 2e{-}16 ***}
\CommentTok{\#   A0\_PM2.5     0.56260    0.06555   8.583  \textless{} 2e{-}16 ***}
\CommentTok{\#   L0\_male      0.25861    0.04437   5.829 5.57e{-}09 ***}
\CommentTok{\#   L0\_soc\_env   0.33050    0.04744   6.967 3.23e{-}12 ***}
\CommentTok{\#   L1           0.33462    0.04744   7.054 1.74e{-}12 ***}
\CommentTok{\#}
\CommentTok{\# \# Effect decomposition on the mean difference scale via the g{-}formula approach}
\CommentTok{\#}
\CommentTok{\# Direct counterfactual imputation estimation with}
\CommentTok{\# bootstrap standard errors, percentile confidence intervals and p{-}values}
\CommentTok{\#}
\CommentTok{\#                 Estimate Std.error   95\% CIL 95\% CIU  P.val}
\CommentTok{\#   cde          {-}3.715265  0.114707 {-}3.084527  {-}2.930 \textless{}2e{-}16 ***}
\CommentTok{\#   pnde         {-}5.103390  0.008919 {-}4.820137  {-}4.808 \textless{}2e{-}16 ***}
\CommentTok{\#   tnde         {-}5.659875  0.006095 {-}5.579563  {-}5.571 \textless{}2e{-}16 ***}
\CommentTok{\#   pnie         {-}0.855400  0.040149 {-}1.006846  {-}0.953 \textless{}2e{-}16 ***}
\CommentTok{\#   tnie         {-}1.411886  0.025135 {-}1.758083  {-}1.724 \textless{}2e{-}16 ***}
\CommentTok{\#   te           {-}6.515276  0.034054 {-}6.578220  {-}6.532 \textless{}2e{-}16 ***}
\CommentTok{\#   intref       {-}1.388125  0.105788 {-}1.877736  {-}1.736 \textless{}2e{-}16 ***}
\CommentTok{\#   intmed       {-}0.556485  0.015014 {-}0.771408  {-}0.751 \textless{}2e{-}16 ***}
\CommentTok{\#   cde(prop)     0.570239  0.015115  0.448589   0.469 \textless{}2e{-}16 ***}
\CommentTok{\#   intref(prop)  0.213057  0.017570  0.263846   0.287 \textless{}2e{-}16 ***}
\CommentTok{\#   intmed(prop)  0.085412  0.002894  0.114201   0.118 \textless{}2e{-}16 ***}
\CommentTok{\#   pnie(prop)    0.131292  0.005348  0.145871   0.153 \textless{}2e{-}16 ***}
\CommentTok{\#   pm            0.216704  0.002454  0.263960   0.267 \textless{}2e{-}16 ***}
\CommentTok{\#   int           0.298469  0.020463  0.378048   0.406 \textless{}2e{-}16 ***}
\CommentTok{\#   pe            0.429761  0.015115  0.531104   0.551 \textless{}2e{-}16 ***}
\CommentTok{\#   {-}{-}{-}}
\CommentTok{\#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1}
\CommentTok{\#}
\CommentTok{\# (cde: controlled direct effect;}
\CommentTok{\#  pnde: pure natural direct effect;}
\CommentTok{\#  tnde: total natural direct effect;}
\CommentTok{\#  pnie: pure natural indirect effect;}
\CommentTok{\#  tnie: total natural indirect effect;}
\CommentTok{\#  te: total effect; intref:}
\CommentTok{\#  reference interaction;}
\CommentTok{\#  intmed: mediated interaction;}
\CommentTok{\#  cde(prop): proportion cde;}
\CommentTok{\#  intref(prop): proportion intref;}
\CommentTok{\#  intmed(prop): proportion intmed;}
\CommentTok{\#  pnie(prop): proportion pnie;}
\CommentTok{\#  pm: overall proportion mediated;}
\CommentTok{\#  int: overall proportion attributable to interaction;}
\CommentTok{\#  pe: overall proportion eliminated)}
\end{Highlighting}
\end{Shaded}

\section{``Unified'' approach for estimating Natural Direct and Indirect effects}\label{msm_unified}

(\citeproc{ref-lange2012}{Lange, Vansteelandt, and Bekaert 2012}) suggested to use a ``unified'' approach for estimating Natural Direct and Indirect effects (when they are identifiable), based on the following Marginal Structural Model:
\begin{equation*}
  h\left[\mathbb{E}(Y_{a,M_{a^*}})\right] = \gamma_0 + \gamma_1 a + \gamma_2 a^* + \gamma_3 (a \times a^*) \text{ where } h \text{ is a link function}
\end{equation*}

So that we can express the PNDE as:
\begin{align*}
  \text{PNDE} &= \mathbb{E}(Y_{1,M_{0}}) - \mathbb{E}(Y_{0,M_{0}}) \\
  \text{PNDE} &= h^{-1}\left(\gamma_0 + \gamma_1 \right) - h^{-1}\left(\gamma_0 \right) \\
  \text{PNDE} &= \gamma_1 \text{ if the link function is the identity function}
\end{align*}

and we can express the TNIE as:
\begin{align*}
  \text{TNIE} &= \mathbb{E}(Y_{1,M_{1}}) - \mathbb{E}(Y_{1,M_{0}}) \\
  \text{TNIE} &= h^{-1}\left(\gamma_0 + \gamma_1 + \gamma_2 + \gamma_3 \right) - h^{-1}\left(\gamma_0 + \gamma_1 \right) \\
  \text{TNIE} &= \gamma_2 + \gamma_3 \text{ if the link function is the identity function}
\end{align*}

Note that this model can also be extended to study effect modifications by baseline confounders.

\subsection{Estimation of the MSM by IPTW}\label{estimation-of-the-msm-by-iptw}

\subsubsection{Manual calculation}\label{manual-calculation}

The estimation of the ``unified'' MSM for Natural Direct and Indirect effects relies on the following steps:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Estimate suitable models for the exposure conditional on baseline confounders (\(L(0)\) and \(L(1)\)), using the original data set, in order to compute weights for the exposure \(A\)
\item
  Estimate a suitable model for the mediator conditional on baseline confounders (\(L(0)\) and \(L(1)\)), using the original data set, in order to compute weights for the mediator \(M\)
\item
  Construct a new data set by repeating the original data set twice, and including an additional variable \(A^*\), equal to the original exposure in the 1st data set, and equal to \(1-A\) in the 2nd data set (for multicategorical exposures, see supplementary material of (\citeproc{ref-lange2012}{Lange, Vansteelandt, and Bekaert 2012})).
\item
  Compute weights by applying the fitted models from steps 1 and 2
  \begin{align*}
      w_i &= \frac{1}{P(A=A_i\mid L(0)=L(0)_i,L(1)=L(1)_i)} \times \frac{P(M=M_i \mid A = A^*_i,L(0)=L(0)_i,L(1)=L(1)_i)}{P(M=M_i \mid A = A_i,L(0)=L(0)_i,L(1)=L(1)_i)} \\
      \text{ or } sw_i &= \frac{P(A=A_i)}{P(A=A_i\mid L(0)=L(0)_i,L(1)=L(1)_i)} \times \frac{P(M=M_i \mid A = A^*_i,L(0)=L(0)_i,L(1)=L(1)_i)}{P(M=M_i \mid A = A_i,L(0)=L(0)_i,L(1)=L(1)_i)} \\
    \end{align*}
\item
  Estimate the unified MSM as a weighted model of the outcome including only \(A\) and \(A^*\) (and their interaction), weighted by simple weights or stabilized weights. Use the estimated coefficients of the MSM to calculate the PNDE and TNIE
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{rm}\NormalTok{(}\AttributeTok{list=}\FunctionTok{ls}\NormalTok{())}
\NormalTok{df1\_int }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file =} \StringTok{"data/df1\_int.csv"}\NormalTok{)}

\DocumentationTok{\#\# Step 1. Estimate a suitable model for the exposure conditional on confounders,}
\DocumentationTok{\#\#         using the original data set}
\CommentTok{\# for A weight numerator}
\NormalTok{g.A }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(A0\_PM2}\FloatTok{.5} \SpecialCharTok{\textasciitilde{}} \DecValTok{1}\NormalTok{,}
           \AttributeTok{family =} \StringTok{"binomial"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df1\_int)}

\CommentTok{\# for A weight denominator}
\NormalTok{g.A.L0 }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(A0\_PM2}\FloatTok{.5} \SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ L1, }\CommentTok{\# L1 not necessary in our example}
              \AttributeTok{family =} \StringTok{"binomial"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df1\_int)}

\DocumentationTok{\#\# Step 2. Estimate a suitable model for the mediator conditional on confounders,}
\DocumentationTok{\#\#         using the original data set}
\NormalTok{df1\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\NormalTok{\_temp }\OtherTok{\textless{}{-}}\NormalTok{ df1\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}
\NormalTok{g.M.AL0 }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(M\_diabetes }\SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5}\NormalTok{\_temp }\SpecialCharTok{+}\NormalTok{ L1,}
               \AttributeTok{family =} \StringTok{"binomial"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df1\_int)}

\DocumentationTok{\#\# Step 3. Construct a new data set by repeating the original data set twice,}
\DocumentationTok{\#\#         and including an additional variable A*, equal to the original exposure}
\DocumentationTok{\#\#         in the 1st data set, and equal to 1{-}A in the 2nd data set}
\DocumentationTok{\#\#         (note for multicategorical exposure, see supplementary material of Lange et al)}

\CommentTok{\# create identifier}
\NormalTok{df1\_int}\SpecialCharTok{$}\NormalTok{id }\OtherTok{\textless{}{-}} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(df1\_int)}

\CommentTok{\# dupplicate the original data set}
\NormalTok{df1\_int}\FloatTok{.1} \OtherTok{\textless{}{-}}\NormalTok{ df1\_int}\FloatTok{.2} \OtherTok{\textless{}{-}}\NormalTok{ df1\_int}

\CommentTok{\# Add an A* variable}
\NormalTok{df1\_int}\FloatTok{.1}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\NormalTok{\_star }\OtherTok{\textless{}{-}}\NormalTok{ df1\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \CommentTok{\# A* = A in the 1st data set}
\NormalTok{df1\_int}\FloatTok{.2}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\NormalTok{\_star }\OtherTok{\textless{}{-}} \DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ df1\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \CommentTok{\# A* = 1 {-} A in the 2d data set}

\CommentTok{\# stack the 2 new datasets}
\NormalTok{df1\_int.new }\OtherTok{\textless{}{-}} \FunctionTok{rbind}\NormalTok{(df1\_int}\FloatTok{.1}\NormalTok{,df1\_int}\FloatTok{.2}\NormalTok{)}
\CommentTok{\# sort the data set by the id{-}variable to use geeglm}
\CommentTok{\# (necessary to use geepack and the geeglm() later)}
\NormalTok{df1\_int.new }\OtherTok{\textless{}{-}}\NormalTok{ df1\_int.new[}\FunctionTok{order}\NormalTok{(df1\_int.new}\SpecialCharTok{$}\NormalTok{id), ]}

\FunctionTok{head}\NormalTok{(df1\_int.new, }\DecValTok{12}\NormalTok{)}
\CommentTok{\#       L0\_male L0\_soc\_env A0\_PM2.5 L1 M\_diabetes Y\_death Y\_qol A0\_PM2.5\_temp id A0\_PM2.5\_star}
\CommentTok{\# 1           0          1        0  1          0       0  93.4             0  1             0}
\CommentTok{\# 10001       0          1        0  1          0       0  93.4             0  1             1}
\CommentTok{\# 2           1          1        1  1          0       1  64.0             1  2             1}
\CommentTok{\# 10002       1          1        1  1          0       1  64.0             1  2             0}
\CommentTok{\# 3           1          1        0  0          0       0  75.6             0  3             0}
\CommentTok{\# 10003       1          1        0  0          0       0  75.6             0  3             1}
\CommentTok{\# 4           1          0        0  0          0       0  89.8             0  4             0}
\CommentTok{\# 10004       1          0        0  0          0       0  89.8             0  4             1}
\CommentTok{\# 5           1          1        0  0          0       0  77.2             0  5             0}
\CommentTok{\# 10005       1          1        0  0          0       0  77.2             0  5             1}
\CommentTok{\# 6           1          1        0  0          1       0  73.9             0  6             0}
\CommentTok{\# 10006       1          1        0  0          1       0  73.9             0  6             1}


\DocumentationTok{\#\# Step 4. Compute weights by applying the fitted models from steps 1 and 2}
\CommentTok{\# weights for A}
\NormalTok{g.Ais1 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(g.A, }\AttributeTok{newdata =}\NormalTok{ df1\_int.new, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}
\NormalTok{sw\_A.num }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{, }\FunctionTok{nrow}\NormalTok{(df1\_int.new))}
\NormalTok{sw\_A.num[df1\_int.new}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\SpecialCharTok{==}\DecValTok{1}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ g.Ais1[df1\_int.new}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\SpecialCharTok{==}\DecValTok{1}\NormalTok{]}
\NormalTok{sw\_A.num[df1\_int.new}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\SpecialCharTok{==}\DecValTok{0}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ g.Ais1[df1\_int.new}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\SpecialCharTok{==}\DecValTok{0}\NormalTok{])}

\NormalTok{g.Ais1.L0 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(g.A.L0, }\AttributeTok{newdata =}\NormalTok{ df1\_int.new, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}
\NormalTok{sw\_A.denom }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{, }\FunctionTok{nrow}\NormalTok{(df1\_int.new))}
\NormalTok{sw\_A.denom[df1\_int.new}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\SpecialCharTok{==}\DecValTok{1}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ g.Ais1.L0[df1\_int.new}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\SpecialCharTok{==}\DecValTok{1}\NormalTok{]}
\NormalTok{sw\_A.denom[df1\_int.new}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\SpecialCharTok{==}\DecValTok{0}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ g.Ais1.L0[df1\_int.new}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\SpecialCharTok{==}\DecValTok{0}\NormalTok{])}

\NormalTok{w\_A }\OtherTok{\textless{}{-}} \DecValTok{1} \SpecialCharTok{/}\NormalTok{ sw\_A.denom}
\NormalTok{sw\_A }\OtherTok{\textless{}{-}}\NormalTok{ sw\_A.num }\SpecialCharTok{/}\NormalTok{ sw\_A.denom}

\CommentTok{\# weights for M|A*}
\NormalTok{df1\_int.new}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\NormalTok{\_temp }\OtherTok{\textless{}{-}}\NormalTok{ df1\_int.new}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\NormalTok{\_star}
\NormalTok{g.Mis1.Astar }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(g.M.AL0, }\AttributeTok{newdata =}\NormalTok{ df1\_int.new, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}
\NormalTok{sw\_M.Astar }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{, }\FunctionTok{nrow}\NormalTok{(df1\_int.new))}
\NormalTok{sw\_M.Astar[df1\_int.new}\SpecialCharTok{$}\NormalTok{M\_diabetes}\SpecialCharTok{==}\DecValTok{1}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ g.Mis1.Astar[df1\_int.new}\SpecialCharTok{$}\NormalTok{M\_diabetes}\SpecialCharTok{==}\DecValTok{1}\NormalTok{]}
\NormalTok{sw\_M.Astar[df1\_int.new}\SpecialCharTok{$}\NormalTok{M\_diabetes}\SpecialCharTok{==}\DecValTok{0}\NormalTok{] }\OtherTok{\textless{}{-}} \DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ g.Mis1.Astar[df1\_int.new}\SpecialCharTok{$}\NormalTok{M\_diabetes}\SpecialCharTok{==}\DecValTok{0}\NormalTok{]}

\CommentTok{\# weight for M|A}
\NormalTok{df1\_int.new}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\NormalTok{\_temp }\OtherTok{\textless{}{-}}\NormalTok{ df1\_int.new}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}
\NormalTok{g.Mis1.A }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(g.M.AL0, }\AttributeTok{newdata =}\NormalTok{ df1\_int.new, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}
\NormalTok{sw\_M.A }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{, }\FunctionTok{nrow}\NormalTok{(df1\_int.new))}
\NormalTok{sw\_M.A[df1\_int.new}\SpecialCharTok{$}\NormalTok{M\_diabetes}\SpecialCharTok{==}\DecValTok{1}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ g.Mis1.A[df1\_int.new}\SpecialCharTok{$}\NormalTok{M\_diabetes}\SpecialCharTok{==}\DecValTok{1}\NormalTok{]}
\NormalTok{sw\_M.A[df1\_int.new}\SpecialCharTok{$}\NormalTok{M\_diabetes}\SpecialCharTok{==}\DecValTok{0}\NormalTok{] }\OtherTok{\textless{}{-}} \DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ g.Mis1.A[df1\_int.new}\SpecialCharTok{$}\NormalTok{M\_diabetes}\SpecialCharTok{==}\DecValTok{0}\NormalTok{]}

\CommentTok{\# non{-}stabilized weight}
\NormalTok{w }\OtherTok{\textless{}{-}}\NormalTok{ w\_A }\SpecialCharTok{*}\NormalTok{ (sw\_M.Astar }\SpecialCharTok{/}\NormalTok{ sw\_M.A)}
\CommentTok{\# stabilized weight}
\NormalTok{sw }\OtherTok{\textless{}{-}}\NormalTok{ sw\_A }\SpecialCharTok{*}\NormalTok{ (sw\_M.Astar }\SpecialCharTok{/}\NormalTok{ sw\_M.A)}

\FunctionTok{boxplot}\NormalTok{(}\FunctionTok{data.frame}\NormalTok{(w, sw))}

\DocumentationTok{\#\# Step 5. Fit a suitable model to the outcome including only A and A* (and their}
\DocumentationTok{\#\#         interaction) using a weighted regression}

\CommentTok{\# we will use a GEE model in order to get "robust" standard errors}
\FunctionTok{library}\NormalTok{(geepack)}
\CommentTok{\# note: be careful that individuals in the "df1\_int.new" data set}
\CommentTok{\#       and in the "w" vector have the same order}

\DocumentationTok{\#\# for a risk difference in death}
\NormalTok{MSM.model.death }\OtherTok{\textless{}{-}} \FunctionTok{geeglm}\NormalTok{(Y\_death }\SpecialCharTok{\textasciitilde{}}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{*}\NormalTok{ A0\_PM2}\FloatTok{.5}\NormalTok{\_star,}
                          \AttributeTok{weights =}\NormalTok{ sw,}
                          \AttributeTok{family =} \StringTok{"gaussian"}\NormalTok{,}
                          \AttributeTok{id =}\NormalTok{ df1\_int.new}\SpecialCharTok{$}\NormalTok{id,}
                          \AttributeTok{data =}\NormalTok{ df1\_int.new,}
                          \AttributeTok{scale.fix =} \ConstantTok{TRUE}\NormalTok{)}
\FunctionTok{summary}\NormalTok{(MSM.model.death)}
\CommentTok{\# Coefficients:}
\CommentTok{\#                           Estimate   Std.err    Wald Pr(\textgreater{}|W|)}
\CommentTok{\#   (Intercept)             0.198840  0.004251 2187.61  \textless{} 2e{-}16 ***}
\CommentTok{\#   A0\_PM2.5                0.065950  0.014539   20.58  5.7e{-}06 ***}
\CommentTok{\#   A0\_PM2.5\_star           0.008534  0.001242   47.25  6.2e{-}12 ***}
\CommentTok{\#   A0\_PM2.5:A0\_PM2.5\_star {-}0.000406  0.003762    0.01     0.91}

\DocumentationTok{\#\# Calculate PNDE and PNIE using the MSM\textquotesingle{}s coefficients}
\NormalTok{unif.PNDE.death }\OtherTok{\textless{}{-}} \FunctionTok{coef}\NormalTok{(MSM.model.death)[}\StringTok{"A0\_PM2.5"}\NormalTok{]}
\CommentTok{\# 0.066}
\NormalTok{unif.TNIE.death }\OtherTok{\textless{}{-}}\NormalTok{ (}\FunctionTok{coef}\NormalTok{(MSM.model.death)[}\StringTok{"A0\_PM2.5\_star"}\NormalTok{] }\SpecialCharTok{+}
                      \FunctionTok{coef}\NormalTok{(MSM.model.death)[}\StringTok{"A0\_PM2.5:A0\_PM2.5\_star"}\NormalTok{])}
\CommentTok{\# 0.00813}

\DocumentationTok{\#\# For Quality of life}
\NormalTok{MSM.model.qol }\OtherTok{\textless{}{-}} \FunctionTok{geeglm}\NormalTok{(Y\_qol }\SpecialCharTok{\textasciitilde{}}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{*}\NormalTok{ A0\_PM2}\FloatTok{.5}\NormalTok{\_star,}
                        \AttributeTok{weights =}\NormalTok{ sw,}
                        \AttributeTok{family =} \StringTok{"gaussian"}\NormalTok{,}
                        \AttributeTok{id =}\NormalTok{ df1\_int.new}\SpecialCharTok{$}\NormalTok{id,}
                        \AttributeTok{data =}\NormalTok{ df1\_int.new,}
                        \AttributeTok{scale.fix =} \ConstantTok{TRUE}\NormalTok{)}
\FunctionTok{summary}\NormalTok{(MSM.model.qol)}
\CommentTok{\# Coefficients:}
\CommentTok{\#                          Estimate Std.err     Wald Pr(\textgreater{}|W|)}
\CommentTok{\#   (Intercept)             69.0853  0.1174 346240.4  \textless{} 2e{-}16 ***}
\CommentTok{\#   A0\_PM2.5                {-}5.3771  0.4010    179.8  \textless{} 2e{-}16 ***}
\CommentTok{\#   A0\_PM2.5\_star           {-}1.0769  0.0311   1197.2  \textless{} 2e{-}16 ***}
\CommentTok{\#   A0\_PM2.5:A0\_PM2.5\_star  {-}0.6947  0.0909     58.4  2.2e{-}14 ***}

\DocumentationTok{\#\# Calculate PNDE and PNIE using the MSM\textquotesingle{}s coefficients}
\NormalTok{unif.PNDE.qol }\OtherTok{\textless{}{-}} \FunctionTok{coef}\NormalTok{(MSM.model.qol)[}\StringTok{"A0\_PM2.5"}\NormalTok{]}
\CommentTok{\# {-}5.38}
\NormalTok{unif.TNIE.qol }\OtherTok{\textless{}{-}}\NormalTok{ (}\FunctionTok{coef}\NormalTok{(MSM.model.qol)[}\StringTok{"A0\_PM2.5\_star"}\NormalTok{] }\SpecialCharTok{+}
                    \FunctionTok{coef}\NormalTok{(MSM.model.qol)[}\StringTok{"A0\_PM2.5:A0\_PM2.5\_star"}\NormalTok{])}
\CommentTok{\# {-}1.77}

\CommentTok{\# 95\% confidence intervals can also be computed by bootstrap}
\end{Highlighting}
\end{Shaded}

\subsubsection{\texorpdfstring{Using the \texttt{medflex} package}{Using the medflex package}}\label{using-the-medflex-package}

We can used the \texttt{medflex} package to apply this approach, as described below.

The ``unified'' MSM can be defined as a model of the expected counterfactual outcome \(\mathbb{E}(Y_{a,M_{a^*}} \mid L(0),L(1))\) conditional on the baseline confounders \(L(0)\) and \(L(1)\), or as a model the marginal expected counterfactual outcome \(\mathbb{E}(Y_{a,M_{a^*}}\).

For estimation by IPTW, the data is expanded using the \texttt{neWeight} function, and the MSM is estimated using the \texttt{neModel} function.Population average estimations are obtained using a weighted regression, where the weights are calcuated using a model of the exposure, stated at the \texttt{xFit} argument inside the \texttt{neModel} function.

Standard errors can be computed by bootstrap or as robust ``Sandwich'' standard errors.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(medflex)}
\CommentTok{\# this package can used to estimate Natural direct and indirect effects when they are}
\CommentTok{\# identifiable}

\DocumentationTok{\#\#\# 5.2.1) estimate PNDE and TNDE, conditional on L0 and L1 }
\CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} \#}
\CommentTok{\# get back to the original data set}
\NormalTok{df1\_int }\OtherTok{\textless{}{-}} \FunctionTok{subset}\NormalTok{(df1\_int, }\AttributeTok{select =} \SpecialCharTok{{-}}\FunctionTok{c}\NormalTok{(A0\_PM2}\FloatTok{.5}\NormalTok{\_temp, id))}

\DocumentationTok{\#\# 1) Expand the dataset and calculate weights using the neWeight() function}
\NormalTok{g.M }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(M\_diabetes }\SpecialCharTok{\textasciitilde{}} \FunctionTok{factor}\NormalTok{(A0\_PM2}\FloatTok{.5}\NormalTok{) }\SpecialCharTok{+} \CommentTok{\# the 1st variable should be the exposure}
\NormalTok{             L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ L1, }\CommentTok{\# then add baseline confounders}
           \AttributeTok{family =} \StringTok{"binomial"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df1\_int)}

\CommentTok{\# expend the data set and add a second column A* = 1 {-} A}
\CommentTok{\# and calculate the weights = sw\_M.Astar / sw\_M.A}
\NormalTok{exp.Data }\OtherTok{\textless{}{-}} \FunctionTok{neWeight}\NormalTok{(g.M)}

\CommentTok{\# it is also possible to use the neWeight function directly:}
\CommentTok{\# exp.Data \textless{}{-} neWeight(M\_diabetes \textasciitilde{} factor(A0\_PM2.5) + \# the 1st variable should be the exposure}
\CommentTok{\#                        L0\_male + L0\_soc\_env + L1, \# then add baseline confounders}
\CommentTok{\#                      family = "binomial", data = df1\_int)}

\FunctionTok{class}\NormalTok{(exp.Data)}
\CommentTok{\# [1] "data.frame" "expData"    "weightData"}
\FunctionTok{head}\NormalTok{(exp.Data)}
\CommentTok{\#   id A0\_PM2.50 A0\_PM2.51 L0\_male L0\_soc\_env L1 M\_diabetes Y\_death Y\_qol}
\CommentTok{\# 1  1         0         0       0          1  1          0       0  93.4}
\CommentTok{\# 2  1         0         1       0          1  1          0       0  93.4}
\CommentTok{\# 3  2         1         1       1          1  1          0       1  64.0}
\CommentTok{\# 4  2         1         0       1          1  1          0       1  64.0}
\CommentTok{\# 5  3         0         0       1          1  0          0       0  75.6}
\CommentTok{\# 6  3         0         1       1          1  0          0       0  75.6}

\CommentTok{\# the new variables A0\_PM2.50 and A0\_PM2.51 correspond to A and A*}

\CommentTok{\# check the weights:}
\NormalTok{w }\OtherTok{\textless{}{-}} \FunctionTok{weights}\NormalTok{(exp.Data)}
\FunctionTok{boxplot}\NormalTok{(w)}

\CommentTok{\# Note that we estimated the same weights by hand previously:}
\FunctionTok{head}\NormalTok{(}\FunctionTok{data.frame}\NormalTok{(w, sw\_M.Astar }\SpecialCharTok{/}\NormalTok{ sw\_M.A), }\DecValTok{6}\NormalTok{)}
\CommentTok{\#       w sw\_M.Astar.sw\_M.A}
\CommentTok{\# 1 1.000             1.000}
\CommentTok{\# 2 0.801             0.801}
\CommentTok{\# 3 1.000             1.000}
\CommentTok{\# 4 1.293             1.293}
\CommentTok{\# 5 1.000             1.000}
\CommentTok{\# 6 0.809             0.809}
\FunctionTok{plot}\NormalTok{(w, sw\_M.Astar }\SpecialCharTok{/}\NormalTok{ sw\_M.A)}
\FunctionTok{abline}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{)}

\DocumentationTok{\#\# 2) Fit the natural effect model using the neModel() function}
\DocumentationTok{\#\#    (adjusted for baseline confounders)}

\DocumentationTok{\#\# for death}
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{1234}\NormalTok{)}
\NormalTok{neMod.death }\OtherTok{\textless{}{-}} \FunctionTok{neModel}\NormalTok{(Y\_death }\SpecialCharTok{\textasciitilde{}}\NormalTok{ A0\_PM2}\FloatTok{.50} \SpecialCharTok{*}\NormalTok{ A0\_PM2}\FloatTok{.51} \SpecialCharTok{+}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ L1,}
                       \AttributeTok{family =} \StringTok{"gaussian"}\NormalTok{, }\CommentTok{\# to estimate risk difference}
                       \AttributeTok{expData =}\NormalTok{ exp.Data,}
                       \AttributeTok{se =} \FunctionTok{c}\NormalTok{(}\StringTok{"bootstrap"}\NormalTok{), }\CommentTok{\# or "robust"}
                       \AttributeTok{nBoot =} \DecValTok{10}\NormalTok{, }\CommentTok{\# use \textgreater{}= 1000 samples, if se = bootstrap}
\NormalTok{                       )}
\FunctionTok{summary}\NormalTok{(neMod.death)}
\CommentTok{\#                         Estimate Std. Error z value Pr(\textgreater{}|z|)}
\CommentTok{\#   (Intercept)            0.10982    0.00807   13.61  \textless{} 2e{-}16 ***}
\CommentTok{\#   A0\_PM2.501             0.06576    0.01642    4.01  6.2e{-}05 ***}
\CommentTok{\#   A0\_PM2.511             0.00836    0.00214    3.91  9.1e{-}05 ***}
\CommentTok{\#   L0\_male                0.05041    0.00741    6.80  1.0e{-}11 ***}
\CommentTok{\#   L0\_soc\_env             0.06113    0.00609   10.03  \textless{} 2e{-}16 ***}
\CommentTok{\#   L1                     0.08341    0.01281    6.51  7.5e{-}11 ***}
\CommentTok{\#   A0\_PM2.501:A0\_PM2.511  0.00238    0.00446    0.53     0.59}

\DocumentationTok{\#\# estimate the conditional PNDE and TNDE, given L(0)=0 and L(1)=0}
\NormalTok{medflex.PNDE.death.L0 }\OtherTok{\textless{}{-}} \FunctionTok{coef}\NormalTok{(neMod.death)[}\StringTok{"A0\_PM2.501"}\NormalTok{]}
\CommentTok{\# 0.0658}
\NormalTok{medflex.TNIE.death.L0 }\OtherTok{\textless{}{-}}\NormalTok{ (}\FunctionTok{coef}\NormalTok{(neMod.death)[}\StringTok{"A0\_PM2.511"}\NormalTok{] }\SpecialCharTok{+}
                            \FunctionTok{coef}\NormalTok{(neMod.death)[}\StringTok{"A0\_PM2.501:A0\_PM2.511"}\NormalTok{])}
\CommentTok{\# 0.0107}

\CommentTok{\# 95\% CI of the TNIE (which combines 2 coefficients) ?}
\CommentTok{\# cov(b1,b2) = var(b1) + var(b2) + 2 * cov(b1,b2)}
\FunctionTok{c}\NormalTok{(medflex.TNIE.death.L0 }\SpecialCharTok{{-}}
    \FunctionTok{qnorm}\NormalTok{(}\FloatTok{0.975}\NormalTok{) }\SpecialCharTok{*} \FunctionTok{sqrt}\NormalTok{(}\FunctionTok{var}\NormalTok{(neMod.death}\SpecialCharTok{$}\NormalTok{bootRes}\SpecialCharTok{$}\NormalTok{t[,}\DecValTok{3}\NormalTok{]) }\SpecialCharTok{+} \CommentTok{\# column of A0\_PM2.511}
                          \FunctionTok{var}\NormalTok{(neMod.death}\SpecialCharTok{$}\NormalTok{bootRes}\SpecialCharTok{$}\NormalTok{t[,}\DecValTok{7}\NormalTok{]) }\SpecialCharTok{+} \CommentTok{\# column of A0\_PM2.501:A0\_PM2.511}
                          \DecValTok{2} \SpecialCharTok{*} \FunctionTok{var}\NormalTok{(neMod.death}\SpecialCharTok{$}\NormalTok{bootRes}\SpecialCharTok{$}\NormalTok{t[,}\FunctionTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{,}\DecValTok{7}\NormalTok{)])[}\DecValTok{1}\NormalTok{,}\DecValTok{2}\NormalTok{]),}
\NormalTok{  medflex.TNIE.death.L0 }\SpecialCharTok{+}
    \FunctionTok{qnorm}\NormalTok{(}\FloatTok{0.975}\NormalTok{) }\SpecialCharTok{*} \FunctionTok{sqrt}\NormalTok{(}\FunctionTok{var}\NormalTok{(neMod.death}\SpecialCharTok{$}\NormalTok{bootRes}\SpecialCharTok{$}\NormalTok{t[,}\DecValTok{3}\NormalTok{]) }\SpecialCharTok{+}
                          \FunctionTok{var}\NormalTok{(neMod.death}\SpecialCharTok{$}\NormalTok{bootRes}\SpecialCharTok{$}\NormalTok{t[,}\DecValTok{7}\NormalTok{]) }\SpecialCharTok{+}
                          \DecValTok{2} \SpecialCharTok{*} \FunctionTok{var}\NormalTok{(neMod.death}\SpecialCharTok{$}\NormalTok{bootRes}\SpecialCharTok{$}\NormalTok{t[,}\FunctionTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{,}\DecValTok{7}\NormalTok{)])[}\DecValTok{1}\NormalTok{,}\DecValTok{2}\NormalTok{]))}
\CommentTok{\# A0\_PM2.511 A0\_PM2.511}
\CommentTok{\#     0.0027     0.0188}

\DocumentationTok{\#\# for quality of life}
\NormalTok{neMod.qol }\OtherTok{\textless{}{-}} \FunctionTok{neModel}\NormalTok{(Y\_qol }\SpecialCharTok{\textasciitilde{}}\NormalTok{ A0\_PM2}\FloatTok{.50} \SpecialCharTok{*}\NormalTok{ A0\_PM2}\FloatTok{.51} \SpecialCharTok{+}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ L1,}
                     \AttributeTok{family =} \StringTok{"gaussian"}\NormalTok{, }\CommentTok{\# to estimate risk difference}
                     \AttributeTok{expData =}\NormalTok{ exp.Data,}
                     \AttributeTok{se =} \FunctionTok{c}\NormalTok{(}\StringTok{"robust"}\NormalTok{) }\CommentTok{\# or "bootstrap"}
                     \CommentTok{\# nBoot = 1000, \# if se = bootstrap}
\NormalTok{                     )}
\FunctionTok{summary}\NormalTok{(neMod.qol)}
\CommentTok{\#                         Estimate Std. Error z value Pr(\textgreater{}|z|)}
\CommentTok{\#   (Intercept)             73.187      0.226  324.09  \textless{} 2e{-}16 ***}
\CommentTok{\#   A0\_PM2.501              {-}5.336      0.338  {-}15.77  \textless{} 2e{-}16 ***}
\CommentTok{\#   A0\_PM2.511              {-}1.069      0.136   {-}7.87  3.4e{-}15 ***}
\CommentTok{\#   L0\_male                 {-}1.231      0.223   {-}5.53  3.3e{-}08 ***}
\CommentTok{\#   L0\_soc\_env              {-}3.546      0.230  {-}15.41  \textless{} 2e{-}16 ***}
\CommentTok{\#   L1                      {-}4.101      0.243  {-}16.87  \textless{} 2e{-}16 ***}
\CommentTok{\#   A0\_PM2.501:A0\_PM2.511   {-}0.765      0.126   {-}6.09  1.1e{-}09 ***}

\DocumentationTok{\#\# estimate the conditional PNDE and TNDE, given L(0)=0 and L(1)=0}
\NormalTok{medflex.PNDE.qol.L0 }\OtherTok{\textless{}{-}} \FunctionTok{coef}\NormalTok{(neMod.qol)[}\StringTok{"A0\_PM2.501"}\NormalTok{]}
\CommentTok{\# {-}5.34}
\NormalTok{medflex.TNIE.qol.L0 }\OtherTok{\textless{}{-}}\NormalTok{ (}\FunctionTok{coef}\NormalTok{(neMod.qol)[}\StringTok{"A0\_PM2.511"}\NormalTok{] }\SpecialCharTok{+}
                            \FunctionTok{coef}\NormalTok{(neMod.qol)[}\StringTok{"A0\_PM2.501:A0\_PM2.511"}\NormalTok{])}
\CommentTok{\# {-}1.83}

\CommentTok{\# 95\% CI of the TNIE (which combines 2 coefficients) ?}
\CommentTok{\# cov(b1,b2) = var(b1) + var(b2) + 2cov(b1,b2)}
\FunctionTok{c}\NormalTok{(medflex.TNIE.qol.L0 }\SpecialCharTok{{-}}
    \FunctionTok{qnorm}\NormalTok{(}\FloatTok{0.975}\NormalTok{) }\SpecialCharTok{*} \FunctionTok{sqrt}\NormalTok{(neMod.qol}\SpecialCharTok{$}\NormalTok{vcov[}\StringTok{"A0\_PM2.511"}\NormalTok{,}\StringTok{"A0\_PM2.511"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                          neMod.qol}\SpecialCharTok{$}\NormalTok{vcov[}\StringTok{"A0\_PM2.501:A0\_PM2.511"}\NormalTok{,}\StringTok{"A0\_PM2.501:A0\_PM2.511"}\NormalTok{] }\SpecialCharTok{+}
                          \DecValTok{2} \SpecialCharTok{*}\NormalTok{ neMod.qol}\SpecialCharTok{$}\NormalTok{vcov[}\StringTok{"A0\_PM2.511"}\NormalTok{,}\StringTok{"A0\_PM2.501:A0\_PM2.511"}\NormalTok{]),}
\NormalTok{  medflex.TNIE.qol.L0 }\SpecialCharTok{+}
    \FunctionTok{qnorm}\NormalTok{(}\FloatTok{0.975}\NormalTok{) }\SpecialCharTok{*} \FunctionTok{sqrt}\NormalTok{(neMod.qol}\SpecialCharTok{$}\NormalTok{vcov[}\StringTok{"A0\_PM2.511"}\NormalTok{,}\StringTok{"A0\_PM2.511"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                          neMod.qol}\SpecialCharTok{$}\NormalTok{vcov[}\StringTok{"A0\_PM2.501:A0\_PM2.511"}\NormalTok{,}\StringTok{"A0\_PM2.501:A0\_PM2.511"}\NormalTok{] }\SpecialCharTok{+}
                          \DecValTok{2} \SpecialCharTok{*}\NormalTok{ neMod.qol}\SpecialCharTok{$}\NormalTok{vcov[}\StringTok{"A0\_PM2.511"}\NormalTok{,}\StringTok{"A0\_PM2.501:A0\_PM2.511"}\NormalTok{]))}
\CommentTok{\# A0\_PM2.511 A0\_PM2.511}
\CommentTok{\#     {-}2.30      {-}1.37}

\CommentTok{\# plot results}
\FunctionTok{plot}\NormalTok{(neMod.qol)}

\DocumentationTok{\#\#\# 5.2.2) estimate marginal PNDE and TNDE (population average) }
\CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} \#}

\DocumentationTok{\#\# 1) Expand the dataset and calculate weights using the neWeight() function}

\DocumentationTok{\#\# Estimate a model of the exposure}
\NormalTok{g.A.L0 }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(A0\_PM2}\FloatTok{.5} \SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ L1, }\CommentTok{\# will no work without L(1) !}
              \AttributeTok{family =} \StringTok{"binomial"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df1\_int)}

\DocumentationTok{\#\# Estimate a model of the mediator}
\NormalTok{g.M }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(M\_diabetes }\SpecialCharTok{\textasciitilde{}} \FunctionTok{factor}\NormalTok{(A0\_PM2}\FloatTok{.5}\NormalTok{) }\SpecialCharTok{+} \CommentTok{\# the 1st variable should be the exposure}
\NormalTok{             L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ L1, }\CommentTok{\# then add baseline confounders}
           \AttributeTok{family =} \StringTok{"binomial"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df1\_int)}

\CommentTok{\# expend the data set and add a second column A* = 1 {-} A}
\CommentTok{\# and calculate the weights = sw\_M.Astar / sw\_M.A}
\NormalTok{exp.Data }\OtherTok{\textless{}{-}} \FunctionTok{neWeight}\NormalTok{(g.M)}

\DocumentationTok{\#\# 2) Fit the natural effect model using the neModel() function}
\DocumentationTok{\#\# for death}
\NormalTok{neMod.death.pop }\OtherTok{\textless{}{-}} \FunctionTok{neModel}\NormalTok{(Y\_death }\SpecialCharTok{\textasciitilde{}}\NormalTok{ A0\_PM2}\FloatTok{.50} \SpecialCharTok{*}\NormalTok{ A0\_PM2}\FloatTok{.51}\NormalTok{, }\CommentTok{\# no need for L(0),L(1)}
                       \AttributeTok{family =} \StringTok{"gaussian"}\NormalTok{, }\CommentTok{\# to estimate risk difference}
                       \AttributeTok{expData =}\NormalTok{ exp.Data,}
                       \AttributeTok{xFit =}\NormalTok{ g.A.L0, }\CommentTok{\# model of the exposure}
                       \AttributeTok{se =} \FunctionTok{c}\NormalTok{(}\StringTok{"robust"}\NormalTok{)) }\CommentTok{\# or "bootstrap"}
\FunctionTok{summary}\NormalTok{(neMod.death.pop)}
\CommentTok{\# Parameter estimates:}
\CommentTok{\#   Estimate Std. Error z value Pr(\textgreater{}|z|)}
\CommentTok{\#   (Intercept)            0.198840   0.004247   46.82  \textless{} 2e{-}16 ***}
\CommentTok{\#   A0\_PM2.501             0.065950   0.014346    4.60  4.3e{-}06 ***}
\CommentTok{\#   A0\_PM2.511             0.008534   0.001619    5.27  1.4e{-}07 ***}
\CommentTok{\#   A0\_PM2.501:A0\_PM2.511 {-}0.000406   0.003744   {-}0.11     0.91}

\DocumentationTok{\#\# estimate the population average PNDE and TNDE,}
\NormalTok{medflex.PNDE.death }\OtherTok{\textless{}{-}} \FunctionTok{coef}\NormalTok{(neMod.death.pop)[}\StringTok{"A0\_PM2.501"}\NormalTok{]}
\CommentTok{\# 0.066}
\NormalTok{medflex.TNIE.death }\OtherTok{\textless{}{-}}\NormalTok{ (}\FunctionTok{coef}\NormalTok{(neMod.death.pop)[}\StringTok{"A0\_PM2.511"}\NormalTok{] }\SpecialCharTok{+}
                          \FunctionTok{coef}\NormalTok{(neMod.death.pop)[}\StringTok{"A0\_PM2.501:A0\_PM2.511"}\NormalTok{])}
\CommentTok{\# 0.00813}
\CommentTok{\# the results are the same than results calculated by hand}

\DocumentationTok{\#\# for quality of life}
\NormalTok{neMod.qol.pop }\OtherTok{\textless{}{-}} \FunctionTok{neModel}\NormalTok{(Y\_qol }\SpecialCharTok{\textasciitilde{}}\NormalTok{ A0\_PM2}\FloatTok{.50} \SpecialCharTok{*}\NormalTok{ A0\_PM2}\FloatTok{.51}\NormalTok{, }\CommentTok{\# no need for L(0),L(1)}
                         \AttributeTok{family =} \StringTok{"gaussian"}\NormalTok{, }\CommentTok{\# to estimate risk difference}
                         \AttributeTok{expData =}\NormalTok{ exp.Data,}
                         \AttributeTok{xFit =}\NormalTok{ g.A.L0, }\CommentTok{\# model of the exposure}
                         \AttributeTok{se =} \FunctionTok{c}\NormalTok{(}\StringTok{"robust"}\NormalTok{)) }\CommentTok{\# or "bootstrap"}
\FunctionTok{summary}\NormalTok{(neMod.qol.pop)}
\CommentTok{\# Parameter estimates:}
\CommentTok{\#                         Estimate Std. Error z value Pr(\textgreater{}|z|)}
\CommentTok{\#   (Intercept)             69.085      0.117  590.36  \textless{} 2e{-}16 ***}
\CommentTok{\#   A0\_PM2.501              {-}5.377      0.350  {-}15.38  \textless{} 2e{-}16 ***}
\CommentTok{\#   A0\_PM2.511              {-}1.077      0.137   {-}7.88  3.3e{-}15 ***}
\CommentTok{\#   A0\_PM2.501:A0\_PM2.511   {-}0.695      0.120   {-}5.80  6.7e{-}09 ***}

\DocumentationTok{\#\# estimate the population average PNDE and TNDE,}
\NormalTok{medflex.PNDE.qol }\OtherTok{\textless{}{-}} \FunctionTok{coef}\NormalTok{(neMod.qol.pop)[}\StringTok{"A0\_PM2.501"}\NormalTok{]}
\CommentTok{\# {-}5.38}
\NormalTok{medflex.TNIE.qol }\OtherTok{\textless{}{-}}\NormalTok{ (}\FunctionTok{coef}\NormalTok{(neMod.qol.pop)[}\StringTok{"A0\_PM2.511"}\NormalTok{] }\SpecialCharTok{+}
                       \FunctionTok{coef}\NormalTok{(neMod.qol.pop)[}\StringTok{"A0\_PM2.501:A0\_PM2.511"}\NormalTok{])}
\CommentTok{\# {-}1.77}
\CommentTok{\# the results are the same than results calculated by hand}
\end{Highlighting}
\end{Shaded}

\subsection{Estimation of the MSM by g-computation}\label{estimation-of-the-msm-by-g-computation}

\subsubsection{Manual calculation}\label{manual-calculation-1}

The ``unified'' MSM can also be estimated by g-computation. Note that for the estimation of the population average effects, calculation relies on a weighted regression, as with the IPTW approach.

We can apply the following steps:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Estimate a suitable model for the outcome conditional on the exposure, mediator and confounders, using the original data set
\item
  Construct a new data set by repeating the original data set twice, and including an additional variable \(A^*\), equal to the original exposure in the 1st data set, and equal to \(1-A\) in the 2nd data set. Then impute counterfactuals \(\mathbb{E}(Y_{a,M_a*}|L(0),L(1))\)
\item
  Estimate the unified MSM as a model of the outcome including \(A\) and \(A^*\) (and their interaction), adjusted for baseline confounders \(L(0)\) and \(L(1)\). In order to obtain population average model (unconditional on baseline confounders), coefficients can be estimated using a weighted regression (with simple weights or stabilized weights of the exposure). Use the estimated coefficients of the MSM to calculate the PNDE and TNIE.
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{rm}\NormalTok{(}\AttributeTok{list=}\FunctionTok{ls}\NormalTok{())}
\NormalTok{df1\_int }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file =} \StringTok{"data/df1\_int.csv"}\NormalTok{)}

\DocumentationTok{\#\# Step 1. Estimate a suitable model for the outcome conditional on the exposure,}
\DocumentationTok{\#\#         mediator and confounders, using the original data set}
\NormalTok{Q.Y.death }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Y\_death }\SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ L1  }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{*}\NormalTok{ M\_diabetes,}
                 \AttributeTok{family =} \StringTok{"binomial"}\NormalTok{,}
                 \AttributeTok{data =}\NormalTok{ df1\_int)}

\NormalTok{Q.Y.qol }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Y\_qol }\SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ L1 }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{*}\NormalTok{ M\_diabetes,}
               \AttributeTok{family =} \StringTok{"gaussian"}\NormalTok{,}
               \AttributeTok{data =}\NormalTok{ df1\_int)}

\DocumentationTok{\#\# Step 2. Expand data and impute counterfactuals E(Y\_\{a,M\_a*\}|L(0),L(1))}
\DocumentationTok{\#\# Expand data}
\CommentTok{\# create identifier}
\NormalTok{df1\_int}\SpecialCharTok{$}\NormalTok{id }\OtherTok{\textless{}{-}} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(df1\_int)}

\CommentTok{\# dupplicate the original data set}
\NormalTok{df1\_int}\FloatTok{.1} \OtherTok{\textless{}{-}}\NormalTok{ df1\_int}\FloatTok{.2} \OtherTok{\textless{}{-}}\NormalTok{ df1\_int}

\CommentTok{\# Add an A* variable where A* = A}
\NormalTok{df1\_int}\FloatTok{.1}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\NormalTok{\_star }\OtherTok{\textless{}{-}}\NormalTok{ df1\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}
\NormalTok{df1\_int}\FloatTok{.2}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\NormalTok{\_star }\OtherTok{\textless{}{-}}\NormalTok{ df1\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}

\CommentTok{\# for the 2nd data set, change the exposure A = 1 {-} A}
\NormalTok{df1\_int}\FloatTok{.2}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \OtherTok{\textless{}{-}} \DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ df1\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}

\CommentTok{\# stack the 2 new datasets}
\NormalTok{df1\_int.new }\OtherTok{\textless{}{-}} \FunctionTok{rbind}\NormalTok{(df1\_int}\FloatTok{.1}\NormalTok{,df1\_int}\FloatTok{.2}\NormalTok{)}
\CommentTok{\# sort the data set by the id{-}variable to use geeglm}
\CommentTok{\# (necessary to use geepack and the geeglm() later)}
\NormalTok{df1\_int.new }\OtherTok{\textless{}{-}}\NormalTok{ df1\_int.new[}\FunctionTok{order}\NormalTok{(df1\_int.new}\SpecialCharTok{$}\NormalTok{id), ]}

\FunctionTok{head}\NormalTok{(df1\_int.new, }\DecValTok{12}\NormalTok{)}
\CommentTok{\#       L0\_male L0\_soc\_env A0\_PM2.5 L1 M\_diabetes Y\_death Y\_qol A0\_PM2.5\_temp id A0\_PM2.5\_star}
\CommentTok{\# 1           0          1        0  1          0       0  93.4             0  1             0}
\CommentTok{\# 10001       0          1        1  1          0       0  93.4             0  1             0}
\CommentTok{\# 2           1          1        1  1          0       1  64.0             1  2             1}
\CommentTok{\# 10002       1          1        0  1          0       1  64.0             1  2             1}
\CommentTok{\# 3           1          1        0  0          0       0  75.6             0  3             0}
\CommentTok{\# 10003       1          1        1  0          0       0  75.6             0  3             0}
\CommentTok{\# 4           1          0        0  0          0       0  89.8             0  4             0}
\CommentTok{\# 10004       1          0        1  0          0       0  89.8             0  4             0}
\CommentTok{\# 5           1          1        0  0          0       0  77.2             0  5             0}
\CommentTok{\# 10005       1          1        1  0          0       0  77.2             0  5             0}
\CommentTok{\# 6           1          1        0  0          1       0  73.9             0  6             0}
\CommentTok{\# 10006       1          1        1  0          1       0  73.9             0  6             0}

\DocumentationTok{\#\# Impute counterfactuals}
\CommentTok{\# death {-} we predict the probability P(Y=1|A,M,L(0),L(1))}
\NormalTok{Y.pred.death }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(Q.Y.death, }\AttributeTok{newdata =}\NormalTok{ df1\_int.new, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}

\CommentTok{\# qol {-} we can predict the mean E(Y|A,M,L(0),L(1))}
\NormalTok{Y.pred.qol }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(Q.Y.qol, }\AttributeTok{newdata =}\NormalTok{ df1\_int.new, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}

\DocumentationTok{\#\# Step 3. Fit a suitable model to the outcome incluing only A and A* (and their}
\DocumentationTok{\#\#         interaction)}
\FunctionTok{library}\NormalTok{(geepack)}
\CommentTok{\# for death (conditional)}
\NormalTok{MSM.model.death}\FloatTok{.1} \OtherTok{\textless{}{-}} \FunctionTok{geeglm}\NormalTok{(Y.pred.death }\SpecialCharTok{\textasciitilde{}}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{*}\NormalTok{ A0\_PM2}\FloatTok{.5}\NormalTok{\_star }\SpecialCharTok{+}
\NormalTok{                              L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ L1,}
                            \AttributeTok{family =} \StringTok{"gaussian"}\NormalTok{,}
                            \AttributeTok{id =}\NormalTok{ df1\_int.new}\SpecialCharTok{$}\NormalTok{id,}
                            \AttributeTok{data =}\NormalTok{ df1\_int.new,}
                            \AttributeTok{scale.fix =} \ConstantTok{TRUE}\NormalTok{)}
\FunctionTok{summary}\NormalTok{(MSM.model.death}\FloatTok{.1}\NormalTok{)}
\CommentTok{\#                          Estimate  Std.err   Wald Pr(\textgreater{}|W|)}
\CommentTok{\#   (Intercept)            0.104153 0.000611  29104  \textless{} 2e{-}16 ***}
\CommentTok{\#   A0\_PM2.5               0.063543 0.000138 210638  \textless{} 2e{-}16 ***}
\CommentTok{\#   A0\_PM2.5\_star          0.007032 0.001112     40  2.5e{-}10 ***}
\CommentTok{\#   L0\_male                0.054291 0.000706   5922  \textless{} 2e{-}16 ***}
\CommentTok{\#   L0\_soc\_env             0.065692 0.000692   9004  \textless{} 2e{-}16 ***}
\CommentTok{\#   L1                     0.086446 0.000860  10100  \textless{} 2e{-}16 ***}
\CommentTok{\#   A0\_PM2.5:A0\_PM2.5\_star 0.004918 0.000397    154  \textless{} 2e{-}16 ***}

\DocumentationTok{\#\# estimate the conditional PNDE and TNDE, given L(0)=0 and L(1)=0}
\NormalTok{PNDE.death.L0 }\OtherTok{\textless{}{-}} \FunctionTok{coef}\NormalTok{(MSM.model.death}\FloatTok{.1}\NormalTok{)[}\StringTok{"A0\_PM2.5"}\NormalTok{]}
\CommentTok{\# 0.0635}
\NormalTok{TNIE.death.L0 }\OtherTok{\textless{}{-}}\NormalTok{ (}\FunctionTok{coef}\NormalTok{(MSM.model.death}\FloatTok{.1}\NormalTok{)[}\StringTok{"A0\_PM2.5\_star"}\NormalTok{] }\SpecialCharTok{+}
                            \FunctionTok{coef}\NormalTok{(MSM.model.death}\FloatTok{.1}\NormalTok{)[}\StringTok{"A0\_PM2.5:A0\_PM2.5\_star"}\NormalTok{])}
\CommentTok{\# 0.012}

\CommentTok{\# For quality of life (conditional)}
\NormalTok{MSM.model.qol}\FloatTok{.1} \OtherTok{\textless{}{-}} \FunctionTok{geeglm}\NormalTok{(Y.pred.qol }\SpecialCharTok{\textasciitilde{}}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{*}\NormalTok{ A0\_PM2}\FloatTok{.5}\NormalTok{\_star }\SpecialCharTok{+}
\NormalTok{                              L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ L1,}
                            \AttributeTok{family =} \StringTok{"gaussian"}\NormalTok{,}
                            \AttributeTok{id =}\NormalTok{ df1\_int.new}\SpecialCharTok{$}\NormalTok{id,}
                            \AttributeTok{data =}\NormalTok{ df1\_int.new,}
                            \AttributeTok{scale.fix =} \ConstantTok{TRUE}\NormalTok{)}
\FunctionTok{summary}\NormalTok{(MSM.model.qol}\FloatTok{.1}\NormalTok{)}
\CommentTok{\#                          Estimate Std.err     Wald Pr(\textgreater{}|W|)}
\CommentTok{\#   (Intercept)             73.3371  0.0949 597466.3  \textless{} 2e{-}16 ***}
\CommentTok{\#   A0\_PM2.5                {-}5.3013  0.0268  39033.2  \textless{} 2e{-}16 ***}
\CommentTok{\#   A0\_PM2.5\_star           {-}1.0535  0.1353     60.6  6.9e{-}15 ***}
\CommentTok{\#   L0\_male                 {-}1.3289  0.1038    164.0  \textless{} 2e{-}16 ***}
\CommentTok{\#   L0\_soc\_env              {-}3.6467  0.1061   1180.6  \textless{} 2e{-}16 ***}
\CommentTok{\#   L1                      {-}4.2325  0.1168   1312.8  \textless{} 2e{-}16 ***}
\CommentTok{\#   A0\_PM2.5:A0\_PM2.5\_star  {-}0.7920  0.0870     82.9  \textless{} 2e{-}16 ***}

\DocumentationTok{\#\# estimate the conditional PNDE and TNDE, given L(0)=0 and L(1)=0}
\NormalTok{PNDE.qol.L0 }\OtherTok{\textless{}{-}} \FunctionTok{coef}\NormalTok{(MSM.model.qol}\FloatTok{.1}\NormalTok{)[}\StringTok{"A0\_PM2.5"}\NormalTok{]}
\CommentTok{\# {-}5.3}
\NormalTok{TNIE.qol.L0 }\OtherTok{\textless{}{-}}\NormalTok{ (}\FunctionTok{coef}\NormalTok{(MSM.model.qol}\FloatTok{.1}\NormalTok{)[}\StringTok{"A0\_PM2.5\_star"}\NormalTok{] }\SpecialCharTok{+}
                  \FunctionTok{coef}\NormalTok{(MSM.model.qol}\FloatTok{.1}\NormalTok{)[}\StringTok{"A0\_PM2.5:A0\_PM2.5\_star"}\NormalTok{])}
\CommentTok{\# {-}1.85}

\DocumentationTok{\#\# For population average estimations}
\DocumentationTok{\#\# Estimate a model of the exposure}
\NormalTok{g.A.L0 }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(A0\_PM2}\FloatTok{.5} \SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ L1, }\CommentTok{\# will no work without L(1) !}
              \AttributeTok{family =} \StringTok{"binomial"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df1\_int)}
\NormalTok{g.Ais1.L0 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(g.A.L0, }\AttributeTok{newdata =}\NormalTok{ df1\_int.new, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}

\NormalTok{w }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{, }\FunctionTok{nrow}\NormalTok{(df1\_int.new))}
\NormalTok{w[df1\_int.new}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\NormalTok{\_star }\SpecialCharTok{==} \DecValTok{1}\NormalTok{] }\OtherTok{\textless{}{-}} \DecValTok{1} \SpecialCharTok{/}\NormalTok{ g.Ais1.L0[df1\_int.new}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\NormalTok{\_star }\SpecialCharTok{==} \DecValTok{1}\NormalTok{]}
\NormalTok{w[df1\_int.new}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\NormalTok{\_star }\SpecialCharTok{==} \DecValTok{0}\NormalTok{] }\OtherTok{\textless{}{-}} \DecValTok{1} \SpecialCharTok{/}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ g.Ais1.L0[df1\_int.new}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\NormalTok{\_star }\SpecialCharTok{==} \DecValTok{0}\NormalTok{])}

\CommentTok{\# for death (population average), we use the weighted regression}
\NormalTok{MSM.model.death}\FloatTok{.2} \OtherTok{\textless{}{-}} \FunctionTok{geeglm}\NormalTok{(Y.pred.death }\SpecialCharTok{\textasciitilde{}}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{*}\NormalTok{ A0\_PM2}\FloatTok{.5}\NormalTok{\_star,}
                            \AttributeTok{family =} \StringTok{"gaussian"}\NormalTok{,}
                            \AttributeTok{weights =}\NormalTok{ w,}
                            \AttributeTok{id =}\NormalTok{ df1\_int.new}\SpecialCharTok{$}\NormalTok{id,}
                            \AttributeTok{data =}\NormalTok{ df1\_int.new,}
                            \AttributeTok{scale.fix =} \ConstantTok{TRUE}\NormalTok{)}
\FunctionTok{summary}\NormalTok{(MSM.model.death}\FloatTok{.2}\NormalTok{)}
\CommentTok{\#                          Estimate  Std.err    Wald Pr(\textgreater{}|W|)}
\CommentTok{\#   (Intercept)            0.198882 0.000644  95250.3  \textless{} 2e{-}16 ***}
\CommentTok{\#   A0\_PM2.5               0.063867 0.000138 213552.3  \textless{} 2e{-}16 ***}
\CommentTok{\#   A0\_PM2.5\_star          0.009213 0.002009     21.0  4.5e{-}06 ***}
\CommentTok{\#   A0\_PM2.5:A0\_PM2.5\_star 0.002330 0.000445     27.4  1.7e{-}07 ***}

\DocumentationTok{\#\# estimate the conditional PNDE and TNDE, given L(0)=0 and L(1)=0}
\NormalTok{PNDE.death }\OtherTok{\textless{}{-}} \FunctionTok{coef}\NormalTok{(MSM.model.death}\FloatTok{.2}\NormalTok{)[}\StringTok{"A0\_PM2.5"}\NormalTok{]}
\CommentTok{\# 0.0639}
\NormalTok{TNIE.death }\OtherTok{\textless{}{-}}\NormalTok{ (}\FunctionTok{coef}\NormalTok{(MSM.model.death}\FloatTok{.2}\NormalTok{)[}\StringTok{"A0\_PM2.5\_star"}\NormalTok{] }\SpecialCharTok{+}
                 \FunctionTok{coef}\NormalTok{(MSM.model.death}\FloatTok{.2}\NormalTok{)[}\StringTok{"A0\_PM2.5:A0\_PM2.5\_star"}\NormalTok{])}
\CommentTok{\# 0.0115}

\CommentTok{\# For quality of life (population average), we use the weighted regression}
\NormalTok{MSM.model.qol}\FloatTok{.2} \OtherTok{\textless{}{-}} \FunctionTok{geeglm}\NormalTok{(Y.pred.qol }\SpecialCharTok{\textasciitilde{}}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{*}\NormalTok{ A0\_PM2}\FloatTok{.5}\NormalTok{\_star,}
                          \AttributeTok{family =} \StringTok{"gaussian"}\NormalTok{,}
                          \AttributeTok{weights =}\NormalTok{ w,}
                          \AttributeTok{id =}\NormalTok{ df1\_int.new}\SpecialCharTok{$}\NormalTok{id,}
                          \AttributeTok{data =}\NormalTok{ df1\_int.new,}
                          \AttributeTok{scale.fix =} \ConstantTok{TRUE}\NormalTok{)}
\FunctionTok{summary}\NormalTok{(MSM.model.qol}\FloatTok{.2}\NormalTok{)}
\CommentTok{\#                          Estimate Std.err     Wald Pr(\textgreater{}|W|)}
\CommentTok{\#   (Intercept)             69.0849  0.0492 1.97e+06  \textless{} 2e{-}16 ***}
\CommentTok{\#   A0\_PM2.5                {-}5.3108  0.0269 3.88e+04  \textless{} 2e{-}16 ***}
\CommentTok{\#   A0\_PM2.5\_star           {-}1.1690  0.1624 5.18e+01  6.1e{-}13 ***}
\CommentTok{\#   A0\_PM2.5:A0\_PM2.5\_star  {-}0.7395  0.0906 6.66e+01  3.3e{-}16 ***}

\DocumentationTok{\#\# estimate the conditional PNDE and TNDE, given L(0)=0 and L(1)=0}
\NormalTok{PNDE.qol.L0 }\OtherTok{\textless{}{-}} \FunctionTok{coef}\NormalTok{(MSM.model.qol}\FloatTok{.2}\NormalTok{)[}\StringTok{"A0\_PM2.5"}\NormalTok{]}
\CommentTok{\# {-}5.31}
\NormalTok{TNIE.qol.L0 }\OtherTok{\textless{}{-}}\NormalTok{ (}\FunctionTok{coef}\NormalTok{(MSM.model.qol}\FloatTok{.2}\NormalTok{)[}\StringTok{"A0\_PM2.5\_star"}\NormalTok{] }\SpecialCharTok{+}
                  \FunctionTok{coef}\NormalTok{(MSM.model.qol}\FloatTok{.2}\NormalTok{)[}\StringTok{"A0\_PM2.5:A0\_PM2.5\_star"}\NormalTok{])}
\CommentTok{\# {-}1.91}
\end{Highlighting}
\end{Shaded}

\subsubsection{\texorpdfstring{Using the \texttt{medflex} package}{Using the medflex package}}\label{using-the-medflex-package-1}

We can used the \texttt{medflex} package to apply this approach, as described below.

The ``unified'' MSM can be defined as a model of the expected counterfactual outcome \(\mathbb{E}(Y_{a,M_{a^*}} \mid L(0),L(1))\) conditional on the baseline confounders \(L(0)\) and \(L(1)\), or as a model the marginal expected counterfactual outcome \(\mathbb{E}(Y_{a,M_{a^*}}\).

For estimation by g-computation, the data is expanded using the \texttt{neImpute} function, and the MSM is estimated using the \texttt{neModel} function. Population average estimations are obtained using a weighted regression, where the weights are calcuated using a model of the exposure, stated at the \texttt{xFit} argument inside the \texttt{neModel} function.

Standard errors can be computed by bootstrap or as robust ``Sandwich'' standard errors.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(medflex)}

\DocumentationTok{\#\#\# 6.2.1) estimate PNDE and TNDE, conditional on L0 and L1}
\CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} \#}
\CommentTok{\# get back to the original data set}
\NormalTok{df1\_int }\OtherTok{\textless{}{-}} \FunctionTok{subset}\NormalTok{(df1\_int, }\AttributeTok{select =} \SpecialCharTok{{-}}\FunctionTok{c}\NormalTok{(id))}
\NormalTok{df1\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5} \OtherTok{\textless{}{-}} \FunctionTok{factor}\NormalTok{(df1\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\NormalTok{)}

\DocumentationTok{\#\# 1) Fit a model for the outcome}
\NormalTok{Q.Y.death }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Y\_death }\SpecialCharTok{\textasciitilde{}}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+} \CommentTok{\# start with the exposure}
\NormalTok{                   M\_diabetes }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5}\SpecialCharTok{:}\NormalTok{M\_diabetes }\SpecialCharTok{+} \CommentTok{\# then the mediator}
\NormalTok{                   L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ L1, }\CommentTok{\# then baseline confounders}
                 \AttributeTok{family =} \StringTok{"binomial"}\NormalTok{,}
                 \AttributeTok{data =}\NormalTok{ df1\_int)}

\NormalTok{Q.Y.qol }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Y\_qol }\SpecialCharTok{\textasciitilde{}}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+} \CommentTok{\# start with the exposure}
\NormalTok{                 M\_diabetes }\SpecialCharTok{+}\NormalTok{ A0\_PM2}\FloatTok{.5}\SpecialCharTok{:}\NormalTok{M\_diabetes }\SpecialCharTok{+} \CommentTok{\# then the mediator}
\NormalTok{                 L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ L1, }\CommentTok{\# then baseline confounders}
               \AttributeTok{family =} \StringTok{"gaussian"}\NormalTok{,}
               \AttributeTok{data =}\NormalTok{ df1\_int)}


\DocumentationTok{\#\# 2) expend the data set and add a second column A* = 1 {-} A}
\NormalTok{exp.Data.death }\OtherTok{\textless{}{-}} \FunctionTok{neImpute}\NormalTok{(Q.Y.death)}
\FunctionTok{head}\NormalTok{(exp.Data.death)}
\CommentTok{\#   id A0\_PM2.50 A0\_PM2.51 L0\_male L0\_soc\_env L1 M\_diabetes Y\_death Y\_qol}
\CommentTok{\# 1  1         0         0       0          1  1          0   0.222  93.4}
\CommentTok{\# 2  1         1         0       0          1  1          0   0.292  93.4}
\CommentTok{\# 3  2         1         1       1          1  1          0   0.356  64.0}
\CommentTok{\# 4  2         0         1       1          1  1          0   0.277  64.0}
\CommentTok{\# 5  3         0         0       1          1  0          0   0.197  75.6}
\CommentTok{\# 6  3         1         0       1          1  0          0   0.261  75.6}

\NormalTok{exp.Data.qol }\OtherTok{\textless{}{-}} \FunctionTok{neImpute}\NormalTok{(Q.Y.qol)}
\FunctionTok{head}\NormalTok{(exp.Data.qol)}
\CommentTok{\#   id A0\_PM2.50 A0\_PM2.51 L0\_male L0\_soc\_env L1 M\_diabetes Y\_death Y\_qol}
\CommentTok{\# 1  1         0         0       0          1  1          0       0  68.4}
\CommentTok{\# 2  1         1         0       0          1  1          0       0  64.7}
\CommentTok{\# 3  2         1         1       1          1  1          0       1  64.0}
\CommentTok{\# 4  2         0         1       1          1  1          0       1  67.7}
\CommentTok{\# 5  3         0         0       1          1  0          0       0  71.2}
\CommentTok{\# 6  3         1         0       1          1  0          0       0  67.4}

\CommentTok{\# the predicted outcomes by medflex are the same than our previous predictions}
\FunctionTok{plot}\NormalTok{(exp.Data.death}\SpecialCharTok{$}\NormalTok{Y\_death, Y.pred.death)}
\FunctionTok{abline}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{)}

\FunctionTok{plot}\NormalTok{(exp.Data.qol}\SpecialCharTok{$}\NormalTok{Y\_qol, Y.pred.qol)}
\FunctionTok{abline}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{)}

\DocumentationTok{\#\# 3) Fit the natural effect model using the neModel() function}
\DocumentationTok{\#\#    (adjusted for baseline confounders)}

\DocumentationTok{\#\# for death}
\NormalTok{neMod.death }\OtherTok{\textless{}{-}} \FunctionTok{neModel}\NormalTok{(Y\_death }\SpecialCharTok{\textasciitilde{}}\NormalTok{ A0\_PM2}\FloatTok{.50} \SpecialCharTok{*}\NormalTok{ A0\_PM2}\FloatTok{.51} \SpecialCharTok{+}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ L1,}
                       \AttributeTok{family =} \StringTok{"gaussian"}\NormalTok{, }\CommentTok{\# to estimate risk difference}
                       \AttributeTok{expData =}\NormalTok{ exp.Data.death,}
                       \AttributeTok{se =} \FunctionTok{c}\NormalTok{(}\StringTok{"robust"}\NormalTok{) }\CommentTok{\# or "bootstrap"}
\NormalTok{                       )}
\FunctionTok{summary}\NormalTok{(neMod.death)}
\CommentTok{\#                         Estimate Std. Error z value Pr(\textgreater{}|z|)}
\CommentTok{\#   (Intercept)            0.10415    0.00829   12.56  \textless{} 2e{-}16 ***}
\CommentTok{\#   A0\_PM2.501             0.06354    0.01373    4.63  3.7e{-}06 ***}
\CommentTok{\#   A0\_PM2.511             0.00703    0.00175    4.01  6.1e{-}05 ***}
\CommentTok{\#   L0\_male                0.05429    0.00867    6.26  3.8e{-}10 ***}
\CommentTok{\#   L0\_soc\_env             0.06569    0.00882    7.45  9.3e{-}14 ***}
\CommentTok{\#   L1                     0.08645    0.00999    8.66  \textless{} 2e{-}16 ***}
\CommentTok{\#   A0\_PM2.501:A0\_PM2.511  0.00492    0.00391    1.26     0.21}

\DocumentationTok{\#\# estimate the conditional PNDE and TNDE, given L(0)=0 and L(1)=0}
\NormalTok{medflex.PNDE.death.L0 }\OtherTok{\textless{}{-}} \FunctionTok{coef}\NormalTok{(neMod.death)[}\StringTok{"A0\_PM2.501"}\NormalTok{]}
\CommentTok{\# 0.0635}
\NormalTok{medflex.TNIE.death.L0 }\OtherTok{\textless{}{-}}\NormalTok{ (}\FunctionTok{coef}\NormalTok{(neMod.death)[}\StringTok{"A0\_PM2.511"}\NormalTok{] }\SpecialCharTok{+}
                            \FunctionTok{coef}\NormalTok{(neMod.death)[}\StringTok{"A0\_PM2.501:A0\_PM2.511"}\NormalTok{])}
\CommentTok{\# 0.012}

\DocumentationTok{\#\# for quality of life}
\NormalTok{neMod.qol }\OtherTok{\textless{}{-}} \FunctionTok{neModel}\NormalTok{(Y\_qol }\SpecialCharTok{\textasciitilde{}}\NormalTok{ A0\_PM2}\FloatTok{.50} \SpecialCharTok{*}\NormalTok{ A0\_PM2}\FloatTok{.51} \SpecialCharTok{+}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ L1,}
                     \AttributeTok{family =} \StringTok{"gaussian"}\NormalTok{, }\CommentTok{\# to estimate risk difference}
                     \AttributeTok{expData =}\NormalTok{ exp.Data.qol,}
                     \AttributeTok{se =} \FunctionTok{c}\NormalTok{(}\StringTok{"robust"}\NormalTok{)) }\CommentTok{\# or "bootstrap"}
\FunctionTok{summary}\NormalTok{(neMod.qol)}
\CommentTok{\#                         Estimate Std. Error z value Pr(\textgreater{}|z|)}
\CommentTok{\#   (Intercept)             73.337      0.230  319.17  \textless{} 2e{-}16 ***}
\CommentTok{\#   A0\_PM2.501              {-}5.301      0.340  {-}15.61  \textless{} 2e{-}16 ***}
\CommentTok{\#   A0\_PM2.511              {-}1.054      0.139   {-}7.58  3.6e{-}14 ***}
\CommentTok{\#   L0\_male                 {-}1.329      0.227   {-}5.85  5.0e{-}09 ***}
\CommentTok{\#   L0\_soc\_env              {-}3.647      0.235  {-}15.54  \textless{} 2e{-}16 ***}
\CommentTok{\#   L1                      {-}4.233      0.249  {-}17.01  \textless{} 2e{-}16 ***}
\CommentTok{\#   A0\_PM2.501:A0\_PM2.511   {-}0.792      0.127   {-}6.21  5.1e{-}10 ***}

\DocumentationTok{\#\# estimate the conditional PNDE and TNDE, given L(0)=0 and L(1)=0}
\NormalTok{medflex.PNDE.qol.L0 }\OtherTok{\textless{}{-}} \FunctionTok{coef}\NormalTok{(neMod.qol)[}\StringTok{"A0\_PM2.501"}\NormalTok{]}
\CommentTok{\# {-}5.3}
\NormalTok{medflex.TNIE.qol.L0 }\OtherTok{\textless{}{-}}\NormalTok{ (}\FunctionTok{coef}\NormalTok{(neMod.qol)[}\StringTok{"A0\_PM2.511"}\NormalTok{] }\SpecialCharTok{+}
                          \FunctionTok{coef}\NormalTok{(neMod.qol)[}\StringTok{"A0\_PM2.501:A0\_PM2.511"}\NormalTok{])}
\CommentTok{\# {-}1.85}


\DocumentationTok{\#\#\# 6.2.2) estimate marginal PNDE and TNDE (population average) }
\CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} \#}
\DocumentationTok{\#\# Estimate a model of the exposure}
\NormalTok{g.A.L0 }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(A0\_PM2}\FloatTok{.5} \SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}\NormalTok{ L1, }\CommentTok{\# will no work without L(1) !}
              \AttributeTok{family =} \StringTok{"binomial"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df1\_int)}

\DocumentationTok{\#\# 3) Fit the natural effect model using the neModel() function}
\DocumentationTok{\#\# for death}
\NormalTok{neMod.death.pop }\OtherTok{\textless{}{-}} \FunctionTok{neModel}\NormalTok{(Y\_death }\SpecialCharTok{\textasciitilde{}}\NormalTok{ A0\_PM2}\FloatTok{.50} \SpecialCharTok{*}\NormalTok{ A0\_PM2}\FloatTok{.51}\NormalTok{, }\CommentTok{\# no need for L(0),L(1)}
                           \AttributeTok{family =} \StringTok{"gaussian"}\NormalTok{, }\CommentTok{\# to estimate risk difference}
                           \AttributeTok{expData =}\NormalTok{ exp.Data.death,}
                           \AttributeTok{xFit =}\NormalTok{ g.A.L0, }\CommentTok{\# model of the exposure}
                           \AttributeTok{se =} \FunctionTok{c}\NormalTok{(}\StringTok{"robust"}\NormalTok{)) }\CommentTok{\# or "bootstrap"}
\FunctionTok{summary}\NormalTok{(neMod.death.pop)}
\CommentTok{\# Parameter estimates:}
\CommentTok{\#                         Estimate Std. Error z value Pr(\textgreater{}|z|)}
\CommentTok{\#   (Intercept)            0.19888    0.00425   46.83  \textless{} 2e{-}16 ***}
\CommentTok{\#   A0\_PM2.501             0.06387    0.01378    4.64  3.6e{-}06 ***}
\CommentTok{\#   A0\_PM2.511             0.00921    0.00169    5.45  5.1e{-}08 ***}
\CommentTok{\#   A0\_PM2.501:A0\_PM2.511  0.00233    0.00367    0.64     0.53}

\DocumentationTok{\#\# estimate the population average PNDE and TNDE,}
\NormalTok{medflex.PNDE.death }\OtherTok{\textless{}{-}} \FunctionTok{coef}\NormalTok{(neMod.death.pop)[}\StringTok{"A0\_PM2.501"}\NormalTok{]}
\CommentTok{\# 0.0639}
\NormalTok{medflex.TNIE.death }\OtherTok{\textless{}{-}}\NormalTok{ (}\FunctionTok{coef}\NormalTok{(neMod.death.pop)[}\StringTok{"A0\_PM2.511"}\NormalTok{] }\SpecialCharTok{+}
                         \FunctionTok{coef}\NormalTok{(neMod.death.pop)[}\StringTok{"A0\_PM2.501:A0\_PM2.511"}\NormalTok{])}
\CommentTok{\# 0.0115}
\CommentTok{\# the results are the same than results calculated by hand}

\DocumentationTok{\#\# for quality of life}
\NormalTok{neMod.qol.pop }\OtherTok{\textless{}{-}} \FunctionTok{neModel}\NormalTok{(Y\_qol }\SpecialCharTok{\textasciitilde{}}\NormalTok{ A0\_PM2}\FloatTok{.50} \SpecialCharTok{*}\NormalTok{ A0\_PM2}\FloatTok{.51}\NormalTok{, }\CommentTok{\# no need for L(0),L(1)}
                         \AttributeTok{family =} \StringTok{"gaussian"}\NormalTok{, }\CommentTok{\# to estimate risk difference}
                         \AttributeTok{expData =}\NormalTok{ exp.Data.qol,}
                         \AttributeTok{xFit =}\NormalTok{ g.A.L0, }\CommentTok{\# model of the exposure}
                         \AttributeTok{se =} \FunctionTok{c}\NormalTok{(}\StringTok{"robust"}\NormalTok{)) }\CommentTok{\# or "bootstrap"}
\FunctionTok{summary}\NormalTok{(neMod.qol.pop)}
\CommentTok{\# Parameter estimates:}
\CommentTok{\#                         Estimate Std. Error z value Pr(\textgreater{}|z|)}
\CommentTok{\#   (Intercept)             69.085      0.117  590.50  \textless{} 2e{-}16 ***}
\CommentTok{\#   A0\_PM2.501              {-}5.311      0.339  {-}15.65  \textless{} 2e{-}16 ***}
\CommentTok{\#   A0\_PM2.511              {-}1.169      0.145   {-}8.09  6.1e{-}16 ***}
\CommentTok{\#   A0\_PM2.501:A0\_PM2.511   {-}0.740      0.125   {-}5.92  3.2e{-}09 ***}

\DocumentationTok{\#\# estimate the population average PNDE and TNDE,}
\NormalTok{medflex.PNDE.qol }\OtherTok{\textless{}{-}} \FunctionTok{coef}\NormalTok{(neMod.qol.pop)[}\StringTok{"A0\_PM2.501"}\NormalTok{]}
\CommentTok{\# {-}5.31}
\NormalTok{medflex.TNIE.qol }\OtherTok{\textless{}{-}}\NormalTok{ (}\FunctionTok{coef}\NormalTok{(neMod.qol.pop)[}\StringTok{"A0\_PM2.511"}\NormalTok{] }\SpecialCharTok{+}
                       \FunctionTok{coef}\NormalTok{(neMod.qol.pop)[}\StringTok{"A0\_PM2.501:A0\_PM2.511"}\NormalTok{])}
\CommentTok{\# {-}1.91}
\CommentTok{\# the results are the same than results calculated by hand}
\end{Highlighting}
\end{Shaded}

\chapter{Targeted Maximum Likelihood Estimation (TMLE)}\label{chap_tmle}

When estimating a mean counterfactual outcome using g-computation methods, we have to estimate some \(\bar{Q}\) functions (functions of the outcome conditional on the exposures and confounders, \(\bar{Q}=\mathbb{E}\left(Y\mid A,L(0)\right)\)). For example, the Average Total Effect (ATE) is defined as a marginal effect, estimated using the empirical mean of such \(\bar{Q}\) functions:
\begin{equation*}
\hat{\Psi}^{\text{ATE}}_{\text{gcomp}} = \frac{1}{n} \sum_{i=1}^n \left[ \hat{\overline{Q}}(A=1)_i - \hat{\overline{Q}}(A=0)_i \right]
\end{equation*}

Unless the \(\bar{Q}\) functions are not misspecified, its estimate is expected to be biased (and \(\bar{Q}\) are expected to be misspecified, especially if the set of baseline confounders \(L(0)\) is high dimensional, for example if it includes is a large number of variables or continuous variables). In order to improve the estimation of \(\bar{Q}(A,L)\), it is possible to use data-adaptive methods (machine learning algorithms) in order to optimize the bias-variance trade-off. However, this bias-variance trade-off would be optimized for the \(\bar{Q}\) functions, not for the ATE estimate \(\hat{\Psi}^\text{ATE}_\text{gcomp}\). If the \(\bar{Q}\) function is unknown and has to be estimated (preferably by data-adaptive methods), it can be shown that the g-computation estimate of \(\Psi^\text{ATE}\) is asymptotically biased.

The Targeted Maximum Likelihood Estimation (TMLE) method has been developed as an asymptotically linear estimator, so that the estimation of any target parameter in any semiparametric statistical model is unbiased and efficient. In order to estimate a parameter \(\Psi(P_0)\), where \(P_0\) is an unknown probability distribution among a set \(\mathcal{M}\) of possible statistical models, the TMLE is described as a two-step procedure (\citeproc{ref-vanderlaan_book2011}{Laan and Rose 2011}):

\begin{itemize}
\tightlist
\item
  The first step is to obtain an initial estimate of the relevant part (\(\bar{Q}_0\) in our applications) of the probability distribution \(P_0\). Data adaptive methods (machine learning algorithms) can be used to optimize this first step.
\item
  The second step is to update the initial fit in order to ``target toward making an optimal bias-variance tradeoff for the parameter of interest'' \(\Psi(\bar{Q})\).
\end{itemize}

Several R packages have been developed in order to carry out TMLE estimation of causal effects. We will begin using the \texttt{ltmle} package, as it can be used to estimate ATE or CDE. More generally, this package can be used to estimate the counterfactual effects of repeated exposure in time-to-event settings. In the setting of mediation analysis, a controlled direct effect (CDE) corresponds to a sequence of counterfactual interventions on 2 ``exposure variables'': the initial exposure \(A\) and the mediator of interest \(M\). The package can also be used in simpler settings with only one binary or continuous outcome, measure only once at the end a the study.

\section{TMLE for the ATE}\label{tmle-for-the-ate}

In order to illustrate the TMLE procedure, the estimation of a mean counterfactual outcome, denoted \(\Psi(A=1) = \mathbb{E} \left[\bar{Q}(A=1,L(0))\right]\), will be described in detail, following the algorithm implemented in the \texttt{ltmle} package.

The basic steps of the procedure are the following (\citeproc{ref-vanderlaan_book2011}{Laan and Rose 2011}):

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Estimate \(\bar{Q}_0\). Data-adaptive methods can be used here, the \texttt{ltmle} package relies on the \texttt{SuperLearner} package to fit and predict \(\hat{\bar{Q}}(A=1)\).
\item
  Estimate the treatment mechanism \(g(A=1 \mid L(0))\). Once again, data-adaptive methods can be used to improve the estimation.
\item
  The initial estimator of \(\bar{Q}_0(A=1)\) will be slightly modified using a parametric fluctuation model, in order to reduce the bias when estimating the ATE. For example, the following parametric model of \(\bar{Q}_0(A=1)\) and a ``clever covariate'' \(H = \frac{I(A=1)}{\hat{g}(A=1 \mid L(0))}\) can be applied:
  \begin{equation*}
   \text{logit} P(Y \mid \hat{\bar{Q}}, H) = \hat{\text{logit} \bar{Q}} + \varepsilon H
  \end{equation*}
  The parametric fluctuation model is chosen so that the derivative of its log-likelihood loss function is equal to the appropriate component of the efficient influence curve of the target parameter \(\Psi(A=1)\).
\item
  Modify the initial estimator of \(\bar{Q}_0(A=1)\) with the parametric fluctuation model (using the estimation \(\hat{\varepsilon}\) from the previous step). We denote \(\hat{\bar{Q}}^*(A=1)\) the updated value of \(\hat{\bar{Q}}(A=1)\)
\item
  Use the updated values \(\hat{\bar{Q}}^*(A=1)\) in the substitution estimator to estimate the target parameter \(\Psi(A=1)\) :
  \begin{equation*}
  \hat{\Psi}(A=1)_\text{TMLE} = \frac{1}{n} \sum_{i=1}^n \hat{\bar{Q}}^* (A=1,L(0)) 
  \end{equation*}
\item
  Estimate the efficient influence curve \(D^*(Q_0,g_0)\) :
  \begin{equation*}
  D^*(Q_0,g_0) = \frac{I(A=1)}{g_0(A=1 \mid L(0))}(Y - \bar{Q}_0(A,L(O))) + \bar{Q}_0(A=1,L(0))  + \Psi(A=1)
  \end{equation*}
\end{enumerate}

The variance of the target parameter can then be calculated using the variance of the efficient influence curve:
\begin{equation*}
\text{var} \hat{\Psi}(A=1)_\text{TMLE} = \frac{\text{var} \hat{D}^*}{n}
\end{equation*}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# 1) Estimate Qbar and predict Qbar when A0\_ace is set to 1}
\NormalTok{Q.fit }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Y\_death }\SpecialCharTok{\textasciitilde{}}\NormalTok{ A0\_ace }\SpecialCharTok{+}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_parent\_low\_educ\_lv,}
             \AttributeTok{family =} \StringTok{"binomial"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df2\_int)}
\NormalTok{data.A1 }\OtherTok{\textless{}{-}}\NormalTok{ df2\_int}
\NormalTok{data.A1}\SpecialCharTok{$}\NormalTok{A0\_ace }\OtherTok{\textless{}{-}} \DecValTok{1}

\CommentTok{\# predict the Qvar function when setting the exposure to A=1, on the logit scale}
\NormalTok{logit\_Qbar\_Ais1 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(Q.fit, }\AttributeTok{newdata =}\NormalTok{ data.A1, }\AttributeTok{type =} \StringTok{"link"}\NormalTok{)}

\DocumentationTok{\#\# 2) Estimate the treatment mechanism}
\NormalTok{g.L }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(A0\_ace }\SpecialCharTok{\textasciitilde{}}\NormalTok{ L0\_male }\SpecialCharTok{+}\NormalTok{ L0\_parent\_low\_educ\_lv,}
           \AttributeTok{family =} \StringTok{"binomial"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ df2\_int)}
\CommentTok{\# predict the probabilities g(A=1 | L(0)) = P(A0\_ace=1|L(0))}
\NormalTok{g1.L }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(g.L, }\AttributeTok{type=}\StringTok{"response"}\NormalTok{)}

\FunctionTok{head}\NormalTok{(g1.L)}
\CommentTok{\#          1          2          3          4          5          6}
\CommentTok{\# 0.10989220 0.15629749 0.15629749 0.08894074 0.15629749 0.15629749}

\CommentTok{\# It is useful to check the distribution of gA.L, as values close to 0 or 1 are }
\CommentTok{\# indicators of near positivity violation and can result in large variance for the }
\CommentTok{\# estimation. }
\CommentTok{\# In case of near positivity violation, gA.L values can be truncated to decrease}
\CommentTok{\# the variance (at the cost a increased bias).}
\FunctionTok{summary}\NormalTok{(g1.L)}
\CommentTok{\#     Min. 1st Qu.  Median    Mean 3rd Qu.    Max. }
\CommentTok{\# 0.06109 0.08894 0.10989 0.11240 0.15630 0.15630}
\CommentTok{\# there is no positivity issues in this example.}

\DocumentationTok{\#\# 3) Determine a parametric family of fluctuations of Qbar. }
\CommentTok{\# The fluctuation model is a model of logitQbar and g(A=1|L(0)) }

\CommentTok{\# The clever covariate H(A,L(0)) depends on g(A=1|L(0)):}
\NormalTok{H }\OtherTok{\textless{}{-}}\NormalTok{ (df2\_int}\SpecialCharTok{$}\NormalTok{A0\_ace }\SpecialCharTok{==} \DecValTok{1}\NormalTok{) }\SpecialCharTok{/}\NormalTok{ g1.L}

\CommentTok{\# Update the initial fit Qbar from step 1.}
\CommentTok{\# This is achieved by holding Qbar fixed (as intercept) while estimating the}
\CommentTok{\# coefficient epsilon for H}

\CommentTok{\# for example we could use the following fluctuation model (from the "Targeted }
\CommentTok{\# Learning" book)}
\NormalTok{update.fit }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(df2\_int}\SpecialCharTok{$}\NormalTok{Y\_death }\SpecialCharTok{\textasciitilde{}} \SpecialCharTok{{-}}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{offset}\NormalTok{(logitQ) }\SpecialCharTok{+}\NormalTok{ H,}
                  \AttributeTok{family =} \StringTok{"quasibinomial"}\NormalTok{)}
\CommentTok{\# Coefficients:}
\CommentTok{\#   H}
\CommentTok{\# {-}0.0001756}

\CommentTok{\# In the ltmle package, the fluctuation parametric model is slightly different}
\CommentTok{\# (but with the same purpose). The "clever covariate" H is scaled and used as a }
\CommentTok{\# weight in the parametric quasi{-}logistic regression}
\NormalTok{S1 }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\DecValTok{1}\NormalTok{, }\FunctionTok{nrow}\NormalTok{(df2\_int))}
\NormalTok{update.fit.ltmle }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(df2\_int}\SpecialCharTok{$}\NormalTok{Y\_death }\SpecialCharTok{\textasciitilde{}} \SpecialCharTok{{-}}\DecValTok{1} \SpecialCharTok{+}\NormalTok{ S1 }\SpecialCharTok{+} \FunctionTok{offset}\NormalTok{(logitQ),}
                        \AttributeTok{family =} \StringTok{"quasibinomial"}\NormalTok{,}
                        \AttributeTok{weights =} \FunctionTok{scale}\NormalTok{(H, }\AttributeTok{center =} \ConstantTok{FALSE}\NormalTok{))}
\CommentTok{\# Coefficients:}
\CommentTok{\#   S1}
\CommentTok{\# {-}0.001667}

\DocumentationTok{\#\# 4) Update the initial estimate of Qbar using the fluctuation parametric model}
\NormalTok{Qstar.tmle }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(update.fit.ltmle, }
                      \AttributeTok{data =} \FunctionTok{data.frame}\NormalTok{(logitQ, H), }
                      \AttributeTok{type =} \StringTok{"response"}\NormalTok{)}

\FunctionTok{head}\NormalTok{(Qstar.tmle)}
\CommentTok{\#         1         2         3         4         5         6 }
\CommentTok{\# 0.2872412 0.3441344 0.3441344 0.2591356 0.3441344 0.3441344}

\DocumentationTok{\#\# 5) Obtain the substition estimator of Psi\_Ais1}
\NormalTok{Psi\_Ais1 }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(Qstar.tmle)}
\CommentTok{\# [1] 0.2871408}

\DocumentationTok{\#\# 5) Calculate standard errors based on the influence curve of the TMLE}
\NormalTok{IC }\OtherTok{\textless{}{-}}\NormalTok{ H }\SpecialCharTok{*}\NormalTok{ (df2\_int}\SpecialCharTok{$}\NormalTok{Y\_death }\SpecialCharTok{{-}}\NormalTok{ Qstar.tmle) }\SpecialCharTok{+}\NormalTok{ Qstar.tmle }\SpecialCharTok{{-}}\NormalTok{ Psi\_Ais1}
\FunctionTok{head}\NormalTok{(IC)}
\CommentTok{\# 0.0001003559  4.2532581791  0.0569935644 {-}0.0280052148  0.0569935644  0.056993564}

\CommentTok{\# Teh standard error of the target parameter Psi(A=1) can be estimated by :}
\FunctionTok{sqrt}\NormalTok{(}\FunctionTok{var}\NormalTok{(IC)}\SpecialCharTok{/}\FunctionTok{nrow}\NormalTok{(df2\_int))}
\CommentTok{\# [1] 0.01383821}
\end{Highlighting}
\end{Shaded}

We can see that we can get the same output using the \texttt{ltmle} package:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ltmle)}
\NormalTok{?ltmle}

\CommentTok{\# The Qform and gform arguments are defined from the DAG}
\NormalTok{Qform }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\AttributeTok{Y\_death=}\StringTok{"Q.kplus1 \textasciitilde{} L0\_male + L0\_parent\_low\_educ\_lv + A0\_ace"}\NormalTok{)}
\NormalTok{gform }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"A0\_ace \textasciitilde{} L0\_male + L0\_parent\_low\_educ\_lv"}\NormalTok{)}

\CommentTok{\# in the ltmle package, the data set should be formated so that the order of the }
\CommentTok{\# columns corresponds to the time{-}ordering of the model}
\NormalTok{data\_ltmle }\OtherTok{\textless{}{-}} \FunctionTok{subset}\NormalTok{(df2\_int, }\AttributeTok{select =} \FunctionTok{c}\NormalTok{(L0\_male,L0\_parent\_low\_educ\_lv,}
\NormalTok{                                         A0\_ace,}
\NormalTok{                                         Y\_death))}

\CommentTok{\# the counterfactual intervention is defined in the abar argument}
\NormalTok{abar }\OtherTok{\textless{}{-}} \DecValTok{1}

\NormalTok{Psi\_Ais1 }\OtherTok{\textless{}{-}} \FunctionTok{ltmle}\NormalTok{(}\AttributeTok{data =}\NormalTok{ data\_ltmle,}
                  \AttributeTok{Anodes =} \StringTok{"A0\_ace"}\NormalTok{,}
                  \AttributeTok{Ynodes =} \StringTok{"Y\_death"}\NormalTok{,}
                  \AttributeTok{Qform =}\NormalTok{ Qform,}
                  \AttributeTok{gform =}\NormalTok{ gform,}
                  \AttributeTok{gbounds =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.01}\NormalTok{, }\DecValTok{1}\NormalTok{), }\CommentTok{\# by default, g function are truncated at 0.01}
                  \AttributeTok{abar =}\NormalTok{ abar,}
                  \AttributeTok{SL.library =} \StringTok{"glm"}\NormalTok{,}
                  \AttributeTok{variance.method =} \StringTok{"ic"}\NormalTok{)}

\CommentTok{\# from the ltmle() function, we can get the point estimate, its standard error, }
\CommentTok{\# 95\% confidence interval and the p{-}value for the null hypothesis.}
\FunctionTok{summary}\NormalTok{(Psi\_Ais1, }\StringTok{"tmle"}\NormalTok{)}
\CommentTok{\# Parameter Estimate:  0.28714}
\CommentTok{\#  Estimated Std Err:  0.013838}
\CommentTok{\#            p{-}value:  \textless{}2e{-}16}
\CommentTok{\#  95\% Conf Interval: (0.26002, 0.31426)}

\CommentTok{\# The ltmle() function returns an object with several outputs.}
\CommentTok{\# We can see that g functions are the same as in the previous manual calculation}
\FunctionTok{head}\NormalTok{(Psi\_Ais1}\SpecialCharTok{$}\NormalTok{cum.g)}
\CommentTok{\#            [,1]}
\CommentTok{\# [1,] 0.10989220}
\CommentTok{\# [2,] 0.15629749}
\CommentTok{\# [3,] 0.15629749}
\CommentTok{\# [4,] 0.08894074}
\CommentTok{\# [5,] 0.15629749}
\CommentTok{\# [6,] 0.15629749}

\CommentTok{\# we can get the estimation of the epsilon parameter from the fluctuation model}
\NormalTok{Psi\_Ais1}\SpecialCharTok{$}\NormalTok{fit}\SpecialCharTok{$}\NormalTok{Qstar}
\CommentTok{\# Coefficients:}
\CommentTok{\#   S1}
\CommentTok{\# {-}0.001667}
\CommentTok{\# Degrees of Freedom: 1124 Total (i.e. Null);  1123 Residual}

\CommentTok{\# we can get the updated Qbar functions:}
\FunctionTok{head}\NormalTok{(Psi\_Ais1}\SpecialCharTok{$}\NormalTok{Qstar)}
\CommentTok{\# [1] 0.2872412 0.3441344 0.3441344 0.2591356 0.3441344 0.3441344}

\CommentTok{\# we can get the influence curve }
\FunctionTok{head}\NormalTok{(Psi\_Ais1}\SpecialCharTok{$}\NormalTok{IC}\SpecialCharTok{$}\NormalTok{tmle)}
\CommentTok{\# [1]  0.0001003559  4.2532581791  0.0569935644 {-}0.0280052148  0.0569935644  0.0569935644}
\end{Highlighting}
\end{Shaded}

In practice, it is recommended to apply data-adaptive algorithms to estimate \(\bar{Q}\) and \(g\) functions: the \texttt{ltmle} package relies on the \texttt{SuperLearner} package. As indicated in the \href{https://cran.r-project.org/web/packages/SuperLearner/vignettes/Guide-to-SuperLearner.html}{Guide to SuperLearner},
The \texttt{SuperLearner} is ``an algorithm that uses cross-validation to estimate the performance of multiple machine learning models, or the same model with different settings. It then creates an optimal weighted average of those models (ensemble learning) using the test data performance.''

Here is an example for our estimation of the Average Total Effect (ATE).

The \texttt{SuperLearner} package includes a set of algorithms with default parameters (showed by \texttt{listWrappers()}). Because the simulated data set only have 2 binary baseline variables, the set \(\mathcal{M}\) of possible statistical models is limited. In order to estimate the ATE, we will include a library with:

\begin{itemize}
\tightlist
\item
  \texttt{SL.mean}, the null-model which only predict the marginal mean (it can be used as a reference for a bad model);
\item
  \texttt{SL.glm}, a glm using the main terms from the \texttt{Qform} and \texttt{gform} argument;
\item
  \texttt{SL.interaction.back}, a step-by-step backward GLM prodecure (based on the AIC), starting with all \(2 \times 2\) interactions between main terms. Interaction terms might be useful to estimate the \(\bar{Q}(A,L(0))\) function because the dataset was generated from and additive model, where as the function is estimated below using a logistic (multiplicative) model.
\item
  \texttt{SL.xgboost.custom} a customized xgboost algorithm from the initial \texttt{SL.xgboost} algorithm, showing how we can modify some default arguments.
\end{itemize}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(SuperLearner)}
\FunctionTok{library}\NormalTok{(xgboost)}
\CommentTok{\# Below, we use the same ltmle() function than previously, }
\CommentTok{\# and specify a family of algorithms to be used with the SuperLearner}

\DocumentationTok{\#\# we can change the default argument of the SL.xgboost algorithm and the }
\DocumentationTok{\#\# SL.step.interaction algorithm}

\CommentTok{\# We can check how arguments are used in the pre{-}specified algorithms}
\NormalTok{SL.step.interaction}
\CommentTok{\# function (Y, X, newX, family, direction = "both", trace = 0, }
\CommentTok{\#     k = 2, ...) }
\CommentTok{\# \{}
\CommentTok{\#     fit.glm \textless{}{-} glm(Y \textasciitilde{} ., data = X, family = family)}
\CommentTok{\#     fit.step \textless{}{-} step(fit.glm, scope = Y \textasciitilde{} .\^{}2, direction = direction, }
\CommentTok{\#         trace = trace, k = k)}
\CommentTok{\#     pred \textless{}{-} predict(fit.step, newdata = newX, type = "response")}
\CommentTok{\#     fit \textless{}{-} list(object = fit.step)}
\CommentTok{\#     out \textless{}{-} list(pred = pred, fit = fit)}
\CommentTok{\#     class(out$fit) \textless{}{-} c("SL.step")}
\CommentTok{\#     return(out)}
\CommentTok{\# \}}
\CommentTok{\# \textless{}bytecode: 0x000001b965ed0dc0\textgreater{}}
\CommentTok{\# \textless{}environment: namespace:SuperLearner\textgreater{}}

\CommentTok{\# The pre{-}specified algorithm can be easily modified to obtain a step{-}by{-}step backward }
\CommentTok{\# selection.}
\NormalTok{SL.interaction.back }\OtherTok{=} \ControlFlowTok{function}\NormalTok{(...) \{}
  \FunctionTok{SL.step.interaction}\NormalTok{(..., }\AttributeTok{direction =} \StringTok{"backward"}\NormalTok{)}
\NormalTok{\}}

\CommentTok{\# The same principle can be applied to modify the SL.xgboost default algorithm}
\NormalTok{SL.xgboost}
\NormalTok{SL.xgboost.custom }\OtherTok{=} \ControlFlowTok{function}\NormalTok{(...) \{}
  \FunctionTok{SL.xgboost}\NormalTok{(..., }\AttributeTok{ntrees =} \DecValTok{50}\NormalTok{)}
\NormalTok{\}}


\DocumentationTok{\#\# the algorithms we would like to use can be specified separately for the Q and }
\CommentTok{\# g functions}
\NormalTok{SL.library }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\AttributeTok{Q=}\FunctionTok{c}\NormalTok{(}\StringTok{"SL.mean"}\NormalTok{,}\StringTok{"SL.glm"}\NormalTok{,}\StringTok{"SL.interaction.back"}\NormalTok{, }\StringTok{"SL.xgboost.custom"}\NormalTok{),}
                   \AttributeTok{g=}\FunctionTok{c}\NormalTok{(}\StringTok{"SL.mean"}\NormalTok{,}\StringTok{"SL.glm"}\NormalTok{,}\StringTok{"SL.interaction.back"}\NormalTok{, }\StringTok{"SL.xgboost.custom"}\NormalTok{))}

\FunctionTok{set.seed}\NormalTok{(}\DecValTok{42}\NormalTok{)}
\NormalTok{Psi\_ATE\_tmle }\OtherTok{\textless{}{-}} \FunctionTok{ltmle}\NormalTok{(}\AttributeTok{data =}\NormalTok{ data\_ltmle,}
                      \AttributeTok{Anodes =} \StringTok{"A0\_ace"}\NormalTok{,}
                      \AttributeTok{Ynodes =} \StringTok{"Y\_death"}\NormalTok{,}
                      \AttributeTok{Qform =}\NormalTok{ Qform,}
                      \AttributeTok{gform =}\NormalTok{ gform,}
                      \AttributeTok{gbounds =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.01}\NormalTok{, }\DecValTok{1}\NormalTok{),}
                      \AttributeTok{abar =} \FunctionTok{list}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{0}\NormalTok{), }\CommentTok{\# vector of the counterfactual treatment }
                      \AttributeTok{SL.library =}\NormalTok{ SL.library,}
                      \AttributeTok{variance.method =} \StringTok{"ic"}\NormalTok{)}
\FunctionTok{summary}\NormalTok{(Psi\_ATE\_tmle, }\AttributeTok{estimator =} \StringTok{"tmle"}\NormalTok{)}
\CommentTok{\# The function give the ATE on the difference scale (as well, as RR and OR)}
\CommentTok{\# Additive Treatment Effect:}
   \CommentTok{\# Parameter Estimate:  0.081832 }
   \CommentTok{\#  Estimated Std Err:  0.014291 }
   \CommentTok{\#            p{-}value:  1.0275e{-}08 }
   \CommentTok{\#  95\% Conf Interval: (0.053822, 0.10984) }

\DocumentationTok{\#\# We can see how the SuperLearner used the algorithms for the g function}
\NormalTok{Psi\_ATE\_tmle}\SpecialCharTok{$}\NormalTok{fit}\SpecialCharTok{$}\NormalTok{g}
\CommentTok{\# [[1]]$A0\_ace}
\CommentTok{\#                               Risk        Coef}
\CommentTok{\# SL.mean\_All             0.09976892 0.003545569 \# risk is higher for the bad model}
\CommentTok{\# SL.glm\_All              0.09865424 0.416238369}
\CommentTok{\# SL.interaction.back\_All 0.09865424 0.000000000}
\CommentTok{\# SL.xgboost.custom\_All   0.09865550 0.580216062}

\CommentTok{\# for the g function, the SuperLearner predicts the treatment mechanism}
\CommentTok{\# base on a mix between the glm and the customized xgboost algorithm.}

\DocumentationTok{\#\# We can see how the SuperLearner used the algorithms for the g function}
\NormalTok{Psi\_ATE\_tmle}\SpecialCharTok{$}\NormalTok{fit}\SpecialCharTok{$}\NormalTok{Q}
\CommentTok{\#                              Risk       Coef}
\CommentTok{\# SL.mean\_All             0.1684737 0.02003166 \# risk is higher for the bad model}
\CommentTok{\# SL.glm\_All              0.1662241 0.00000000}
\CommentTok{\# SL.interaction.back\_All 0.1662241 0.55956284}
\CommentTok{\# SL.xgboost.custom\_All   0.1662422 0.42040550}

\CommentTok{\# The SuperLearner predicts both the treatment mechanism g and the Q function}
\CommentTok{\# from a mix between the backward interaction glm (or the main term glm) and the }
\CommentTok{\# customized xgboost algorithm. }
\CommentTok{\# However, the choice between the SL.glm and the SL.interaction.back }
\CommentTok{\# procedure was arbitrary: as we can see the Risk is exactly the same for both }
\CommentTok{\# algorithms. The final model from the step{-}by{-}step procedure was much probably }
\CommentTok{\# a main term glm.}


\DocumentationTok{\#\# The \textasciigrave{}ltmle\textasciigrave{} package can also be used to estimate the effect of binary exposures}
\DocumentationTok{\#\# on continous outcomes}
\NormalTok{Qform }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\AttributeTok{Y\_qol=}\StringTok{"Q.kplus1 \textasciitilde{} L0\_male + L0\_parent\_low\_educ\_lv + A0\_ace"}\NormalTok{)}
\NormalTok{gform }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"A0\_ace \textasciitilde{} L0\_male + L0\_parent\_low\_educ\_lv"}\NormalTok{)}

\FunctionTok{set.seed}\NormalTok{(}\DecValTok{42}\NormalTok{)}
\NormalTok{Psi\_ATE\_tmle\_qol }\OtherTok{\textless{}{-}} \FunctionTok{ltmle}\NormalTok{(}\AttributeTok{data =} \FunctionTok{subset}\NormalTok{(df2\_int, }\AttributeTok{select =} \FunctionTok{c}\NormalTok{(L0\_male,L0\_parent\_low\_educ\_lv,}
\NormalTok{                                         A0\_ace,}
\NormalTok{                                         Y\_qol)),}
                      \AttributeTok{Anodes =} \StringTok{"A0\_ace"}\NormalTok{,}
                      \AttributeTok{Ynodes =} \StringTok{"Y\_qol"}\NormalTok{,}
                      \AttributeTok{Qform =}\NormalTok{ Qform,}
                      \AttributeTok{gform =}\NormalTok{ gform,}
                      \AttributeTok{gbounds =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.01}\NormalTok{, }\DecValTok{1}\NormalTok{),}
                      \AttributeTok{abar =} \FunctionTok{list}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{0}\NormalTok{), }\CommentTok{\# vector of the counterfactual treatment }
                      \AttributeTok{SL.library =}\NormalTok{ SL.library,}
                      \AttributeTok{variance.method =} \StringTok{"ic"}\NormalTok{)}
\FunctionTok{summary}\NormalTok{(Psi\_ATE\_tmle\_qol, }\AttributeTok{estimator =} \StringTok{"tmle"}\NormalTok{)}
\CommentTok{\# Additive Treatment Effect:}
\CommentTok{\#    Parameter Estimate:  {-}8.265 }
\CommentTok{\#     Estimated Std Err:  0.41008 }
\CommentTok{\#               p{-}value:  \textless{}2e{-}16 }
\CommentTok{\#     95\% Conf Interval: ({-}9.0687, {-}7.4612)}
\end{Highlighting}
\end{Shaded}

The TMLE estimation of the ATE from the \texttt{ltmle} package for death probability and mean quality of life is +8.18\% (95\% CI={[}+5.38\%, +10.98\%{]}) and -8.27 {[}-9.07, -7.46{]}.

Note that the \texttt{ltmle} package can also be used to calculate the IPTW estimation of the ATE and the CDE.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# using the output from the previous ltmle() procedure}
\FunctionTok{summary}\NormalTok{(Psi\_ATE\_tmle, }\AttributeTok{estimator =} \StringTok{"iptw"}\NormalTok{)}
\CommentTok{\# Additive Treatment Effect:}
\CommentTok{\#    Parameter Estimate:  0.082578 }
\CommentTok{\#     Estimated Std Err:  0.014415 }
\CommentTok{\#               p{-}value:  1.0135e{-}08 }
\CommentTok{\#     95\% Conf Interval: (0.054325, 0.11083) }

\FunctionTok{summary}\NormalTok{(Psi\_ATE\_tmle\_qol, }\AttributeTok{estimator =} \StringTok{"iptw"}\NormalTok{)}
\CommentTok{\# Additive Treatment Effect:}
\CommentTok{\#    Parameter Estimate:  {-}8.2887 }
\CommentTok{\#     Estimated Std Err:  0.41799 }
\CommentTok{\#               p{-}value:  \textless{}2e{-}16 }
\CommentTok{\#     95\% Conf Interval: ({-}9.108, {-}7.4695) }
\end{Highlighting}
\end{Shaded}

The IPTW estimation of the ATE from the \texttt{ltmle} package for death probability and mean quality of life is +8.26\% (95\% CI={[}+5.43\%, +11.08\%{]}) and -8.29 {[}-9.11, -7.47{]}.

\section{TMLE of the Controlled direct effect (CDE)}\label{tmle-of-the-controlled-direct-effect-cde}

If the controlled direct effect (CDE) is identifiable, the \texttt{ltmle} package can be used to calculate a TMLE estimation of the CDE \(\Psi^{\text{CDE}_m} = \mathbb{E}(Y_{A=1,M=m}) - \mathbb{E}(Y_{A=0,M=m})\).

Below, we show how to use the \texttt{ltmle()} function to estimate CDE by TMLE, with data generated from the causal model with the presence of confounders of the mediator-outcome relationship (\(L(1)\)) affected by the exposure \(A\) (Figure \ref{fig:figDAGM2}), and an \(A \ast M\) interaction effect on the outcome.

As with the G-computation method by iterative conditional expectation, the TMLE procedure relies on the estimation of 2 \(\bar{Q}\) functions:

\begin{itemize}
\tightlist
\item
  \(\bar{Q}_Y = \mathbb{E}(Y \mid L(0),A,L(1),M)\)
\item
  and \(\bar{Q}_{L(1)} = \mathbb{E}(\hat{\bar{Q}}_Y(M=m) \mid L(0),A)\);
\end{itemize}

And as with the IPTW method, the TMLE procedure relies also on the estimation of the 2 treatment mechanisms \(g\):

\begin{itemize}
\tightlist
\item
  \(g_A(L(0)) = P(A=1 \mid L(0))\)
\item
  and \(g_M(L(0),A,L(1)) = P(M=1 \mid L(0),A,L(1))\).
\end{itemize}

Note: for continuous outcomes, the \texttt{ltmle} package transforms the outcome on a 0 to 1 continuous scale, \(Y_\text{transformed} = \frac{Y - \min(Y)}{\max(Y) - \min(Y)}\), so that quasi-binomial parametric models can be used in the computation procedure. Mean predictions are then back-transformed on the original scale.

\subsection{For binary outcomes}\label{for-binary-outcomes}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ltmle)}
\CommentTok{\# Define the formulas for the estimation of the 2 barQ functions}
\CommentTok{\# Note that it is possible to specify the A*M interaction, if we really want to}
\CommentTok{\# take it into account.}
\CommentTok{\# Another option is to indicate prediction algorithms well adapted to the estimation}
\CommentTok{\# of interaction phenomena into the SuperLearner arguments.}
\NormalTok{Qform }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\AttributeTok{L1=}\StringTok{"Q.kplus1 \textasciitilde{} L0\_male + L0\_parent\_low\_educ\_lv + A0\_ace"}\NormalTok{,}
           \AttributeTok{Y\_death=}\StringTok{"Q.kplus1 \textasciitilde{} L0\_male + L0\_parent\_low\_educ\_lv + L1 +}
\StringTok{                    A0\_ace * M\_smoking"}\NormalTok{)}

\CommentTok{\# Define the formulas for the estimation of the 2 g function}
\NormalTok{gform }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"A0\_ace \textasciitilde{} L0\_male + L0\_parent\_low\_educ\_lv"}\NormalTok{,}
           \StringTok{"M\_smoking \textasciitilde{} L0\_male + L0\_parent\_low\_educ\_lv + A0\_ace + L1"}\NormalTok{)}

\CommentTok{\# The data frame should follow the time{-}ordering of the nodes}
\NormalTok{data\_binary }\OtherTok{\textless{}{-}} \FunctionTok{subset}\NormalTok{(df2\_int, }\AttributeTok{select =} \FunctionTok{c}\NormalTok{(L0\_male, L0\_parent\_low\_educ\_lv,}
\NormalTok{                                          A0\_ace, L1,}
\NormalTok{                                          M\_smoking, Y\_death))}



\CommentTok{\# Choose a family of data{-}adaptive algorithms from the SuperLearner package}
\NormalTok{SL.library }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\AttributeTok{Q=}\FunctionTok{c}\NormalTok{(}\StringTok{"SL.mean"}\NormalTok{,}\StringTok{"SL.glm"}\NormalTok{,}\StringTok{"SL.step.interaction"}\NormalTok{,}\StringTok{"SL.xgboost"}\NormalTok{),}
                   \AttributeTok{g=}\FunctionTok{c}\NormalTok{(}\StringTok{"SL.mean"}\NormalTok{,}\StringTok{"SL.glm"}\NormalTok{,}\StringTok{"SL.step.interaction"}\NormalTok{,}\StringTok{"SL.xgboost"}\NormalTok{))}


\DocumentationTok{\#\# CDE, setting M=0}
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{42}\NormalTok{) }\CommentTok{\# for reproducibility (xgboost algorithm relies on random procedures)}
\NormalTok{CDE\_ltmle\_M0\_death }\OtherTok{\textless{}{-}} \FunctionTok{ltmle}\NormalTok{(}\AttributeTok{data =}\NormalTok{ data\_binary,}
                            \AttributeTok{Anodes =} \FunctionTok{c}\NormalTok{(}\StringTok{"A0\_ace"}\NormalTok{, }\StringTok{"M\_smoking"}\NormalTok{),}
                            \AttributeTok{Lnodes =} \FunctionTok{c}\NormalTok{(}\StringTok{"L1"}\NormalTok{), }\CommentTok{\# intermediate confounders +/{-} baseline}
                            \AttributeTok{Ynodes =} \FunctionTok{c}\NormalTok{(}\StringTok{"Y\_death"}\NormalTok{),}
                            \AttributeTok{survivalOutcome =} \ConstantTok{FALSE}\NormalTok{, }\CommentTok{\# TRUE for time{-}to{-}event outcomes Y}
                            \AttributeTok{Qform =}\NormalTok{ Qform,}
                            \AttributeTok{gform =}\NormalTok{ gform,}
                            \AttributeTok{abar =} \FunctionTok{list}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{0}\NormalTok{), }\CommentTok{\# counterfactual intervention do(A=1,M=0)}
                                        \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{)), }\CommentTok{\# counterfactual intervention do(A=0,M=0)}
                            \AttributeTok{SL.library =}\NormalTok{ SL.library,}
                            \AttributeTok{estimate.time =} \ConstantTok{FALSE}\NormalTok{, }\CommentTok{\# estimate computation time?}
                            \AttributeTok{gcomp =} \ConstantTok{FALSE}\NormalTok{,}
                            \AttributeTok{variance.method =} \StringTok{"ic"}\NormalTok{) }\CommentTok{\# a more robust variance can}
                                                    \CommentTok{\# be estimated with}
                                                    \CommentTok{\# variance.method = "tmle"}
\FunctionTok{summary}\NormalTok{(CDE\_ltmle\_M0\_death)}
\CommentTok{\# Parameter Estimate:  0.056766}
\CommentTok{\#  Estimated Std Err:  0.018037}
\CommentTok{\#            p{-}value:  0.0016488}
\CommentTok{\#  95\% Conf Interval: (0.021413, 0.092118)}

\DocumentationTok{\#\# CDE, setting M=1}
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{42}\NormalTok{) }\CommentTok{\# for reproducibility}
\NormalTok{CDE\_ltmle\_M1\_death }\OtherTok{\textless{}{-}} \FunctionTok{ltmle}\NormalTok{(}\AttributeTok{data =}\NormalTok{ data\_binary,}
                            \AttributeTok{Anodes =} \FunctionTok{c}\NormalTok{(}\StringTok{"A0\_ace"}\NormalTok{, }\StringTok{"M\_smoking"}\NormalTok{),}
                            \AttributeTok{Lnodes =} \FunctionTok{c}\NormalTok{(}\StringTok{"L1"}\NormalTok{), }\CommentTok{\# intermediate confounders +/{-} baseline}
                            \AttributeTok{Ynodes =} \FunctionTok{c}\NormalTok{(}\StringTok{"Y\_death"}\NormalTok{),}
                            \AttributeTok{survivalOutcome =} \ConstantTok{FALSE}\NormalTok{, }\CommentTok{\# TRUE for time{-}to{-}event outcomes Y}
                            \AttributeTok{Qform =}\NormalTok{ Qform,}
                            \AttributeTok{gform =}\NormalTok{ gform,}
                            \AttributeTok{abar =} \FunctionTok{list}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{), }\CommentTok{\# counterfactual intervention do(A=1,M=1)}
                                        \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{)), }\CommentTok{\# counterfactual intervention do(A=0,M=1)}
                            \AttributeTok{SL.library =}\NormalTok{ SL.library,}
                            \AttributeTok{estimate.time =} \ConstantTok{FALSE}\NormalTok{, }\CommentTok{\# estimate computation time?}
                            \AttributeTok{gcomp =} \ConstantTok{FALSE}\NormalTok{,}
                            \AttributeTok{variance.method =} \StringTok{"ic"}\NormalTok{)}
\FunctionTok{summary}\NormalTok{(CDE\_ltmle\_M1\_death)}
\CommentTok{\# Parameter Estimate:  0.094776}
\CommentTok{\#  Estimated Std Err:  0.024}
\CommentTok{\#            p{-}value:  7.8496e{-}05}
\CommentTok{\#  95\% Conf Interval: (0.047736, 0.14182)}
\end{Highlighting}
\end{Shaded}

The controlled direct effect of ACE on the probability of death, had the mediator been set to 0 for every participant is 5.68\%, 95\%CI={[}2.14\%, 9.21\%{]}.

The controlled direct effect of ACE on the probability of death, had the mediator been set to 1 for every participant is 9.48\%, 95\%CI={[}4.77\%, 14.18\%{]}.

\subsection{For continuous outcomes}\label{for-continuous-outcomes}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Define the data set with the continuous outcome Y\_qol}
\NormalTok{data\_continuous }\OtherTok{\textless{}{-}} \FunctionTok{subset}\NormalTok{(df2\_int, }\AttributeTok{select =} \FunctionTok{c}\NormalTok{(L0\_male, L0\_parent\_low\_educ\_lv,}
\NormalTok{                                              A0\_ace, L1,}
\NormalTok{                                              M\_smoking, Y\_qol))}

\CommentTok{\# Replace the Qbar function (the 2d formula should be named Y\_qol instead of Y\_death)}
\NormalTok{Qform }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\AttributeTok{L1=}\StringTok{"Q.kplus1 \textasciitilde{} L0\_male + L0\_parent\_low\_educ\_lv + A0\_ace"}\NormalTok{,}
           \AttributeTok{Y\_qol=}\StringTok{"Q.kplus1 \textasciitilde{} L0\_male + L0\_parent\_low\_educ\_lv + L1 +}
\StringTok{                    A0\_ace * M\_smoking"}\NormalTok{)}

\FunctionTok{set.seed}\NormalTok{(}\DecValTok{42}\NormalTok{)}
\DocumentationTok{\#\# CDE, setting M=0}
\NormalTok{CDE\_ltmle\_M0\_qol }\OtherTok{\textless{}{-}} \FunctionTok{ltmle}\NormalTok{(}\AttributeTok{data =}\NormalTok{ data\_continuous,}
                      \AttributeTok{Anodes =} \FunctionTok{c}\NormalTok{(}\StringTok{"A0\_ace"}\NormalTok{, }\StringTok{"M\_smoking"}\NormalTok{),}
                      \AttributeTok{Lnodes =} \FunctionTok{c}\NormalTok{(}\StringTok{"L1"}\NormalTok{), }\CommentTok{\# intermediate confounders +/{-} baseline confounders}
                      \AttributeTok{Ynodes =} \FunctionTok{c}\NormalTok{(}\StringTok{"Y\_qol"}\NormalTok{),}
                      \AttributeTok{survivalOutcome =} \ConstantTok{FALSE}\NormalTok{, }\CommentTok{\# TRUE for time{-}to{-}event outcomes Y}
                      \AttributeTok{Qform =}\NormalTok{ Qform,}
                      \AttributeTok{gform =}\NormalTok{ gform,}
                      \AttributeTok{abar =} \FunctionTok{list}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{0}\NormalTok{), }\CommentTok{\# counterfactual intervention do(A=1,M=0)}
                                  \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{)), }\CommentTok{\# counterfactual intervention do(A=0,M=0)}
                      \AttributeTok{SL.library =}\NormalTok{ SL.library,}
                      \AttributeTok{estimate.time =} \ConstantTok{FALSE}\NormalTok{, }\CommentTok{\# estimate computation time?}
                      \AttributeTok{gcomp =} \ConstantTok{FALSE}\NormalTok{,}
                      \AttributeTok{variance.method =} \StringTok{"ic"}\NormalTok{)}
\FunctionTok{summary}\NormalTok{(CDE\_ltmle\_M0\_qol)}
\CommentTok{\# Additive Treatment Effect:}
\CommentTok{\#   Parameter Estimate:  {-}4.8023}
\CommentTok{\#    Estimated Std Err:  0.43135}
\CommentTok{\#              p{-}value:  \textless{}2e{-}16}
\CommentTok{\#    95\% Conf Interval: ({-}5.6477, {-}3.9569)}

\DocumentationTok{\#\# CDE, setting M=1}
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{42}\NormalTok{)}
\NormalTok{CDE\_ltmle\_M1\_qol }\OtherTok{\textless{}{-}} \FunctionTok{ltmle}\NormalTok{(}\AttributeTok{data =}\NormalTok{ data\_continuous,}
                          \AttributeTok{Anodes =} \FunctionTok{c}\NormalTok{(}\StringTok{"A0\_ace"}\NormalTok{, }\StringTok{"M\_smoking"}\NormalTok{),}
                          \AttributeTok{Lnodes =} \FunctionTok{c}\NormalTok{(}\StringTok{"L1"}\NormalTok{), }\CommentTok{\# intermediate confounders +/{-} baseline}
                          \AttributeTok{Ynodes =} \FunctionTok{c}\NormalTok{(}\StringTok{"Y\_qol"}\NormalTok{),}
                          \AttributeTok{survivalOutcome =} \ConstantTok{FALSE}\NormalTok{, }\CommentTok{\# TRUE for time{-}to{-}event outcomes Y}
                          \AttributeTok{Qform =}\NormalTok{ Qform,}
                          \AttributeTok{gform =}\NormalTok{ gform,}
                          \AttributeTok{abar =} \FunctionTok{list}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{), }\CommentTok{\# counterfactual intervention do(A=1,M=1)}
                                      \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{)), }\CommentTok{\# counterfactual intervention do(A=0,M=1)}
                          \AttributeTok{SL.library =}\NormalTok{ SL.library,}
                          \AttributeTok{estimate.time =} \ConstantTok{FALSE}\NormalTok{, }\CommentTok{\# estimate computation time?}
                          \AttributeTok{gcomp =} \ConstantTok{FALSE}\NormalTok{,}
                          \AttributeTok{variance.method =} \StringTok{"ic"}\NormalTok{)}
\FunctionTok{summary}\NormalTok{(CDE\_ltmle\_M1\_qol)}
\CommentTok{\# Additive Treatment Effect:}
\CommentTok{\#   Parameter Estimate:  {-}10.219}
\CommentTok{\#    Estimated Std Err:  0.544}
\CommentTok{\#              p{-}value:  \textless{}2e{-}16}
\CommentTok{\#    95\% Conf Interval: ({-}11.285, {-}9.1523)}
\end{Highlighting}
\end{Shaded}

The controlled direct effect of ACE on the quality of life score, had the mediator been set to 0 for every participant is -4.8, 95\%CI={[}-5.6, -4.0{]}.

The controlled direct effect of ACE on the quality of life score, had the mediator been set to 1 for every participant is -10.2, 95\%CI={[}-11.3, -9.2{]}.

\section{One-step and TMLE estimator of the Marginal Randomized/Interventional Direct and Indirect Effects}\label{one-step-and-tmle-estimator-of-the-marginal-randomizedinterventional-direct-and-indirect-effects}

The \texttt{medoutcon} \href{https://github.com/nhejazi/medoutcon}{package} (\citeproc{ref-Hejazi2022}{Hejazi, Rudolph, and Díaz 2022}),(\citeproc{ref-Diaz2020}{Díaz et al. 2020}) enables the estimation of Marginal Randomized/Interventional Direct and Indirect Effects (analogues of the Natural direct and indirect effects) by one-step estimation or TMLE. The one-step estimator relies on ``cross-fitting'' and the TMLE relies on cross-validation.

More practical details can be found in the \href{https://codex.nimahejazi.org/ser2024_mediation_workshop/}{Materials for the workshop ``Modern Causal Mediation Analysis'' at the 2024 Society for Epidemiologic Research (SER) annual meeting in Austin, TX}.

This package is associated with the \texttt{tlverse} \href{https://tlverse.org/tlverse-handbook/}{ecosystem} which has been developed for applying Targeted Learning methodology in practice. To use the \texttt{medoutcon} package, we will need:

\begin{itemize}
\tightlist
\item
  the \texttt{sl3} \href{https://github.com/tlverse/sl3}{package} (to implement SuperLearning)
\item
  and the Highly-adaptive lasso \texttt{hal9001} \href{https://cran.r-project.org/web/packages/hal9001/index.html}{package} to estimate some functions of interest.
\end{itemize}

Note that the \texttt{medoutcon} package can deal with multiple mediators, but only a single binary intermediate confounder \(L(1)\). For causal structures with multiple mediators and multiple intermediate confounders, the \texttt{HDmediation} \href{https://github.com/nt-williams/HDmediation}{package} could be used instead.

Below, we apply the one-step estimator to the data set with an intermediate confounder \(L(1)\) affected by the exposure, and the presence of an \(A \ast M\) interaction effect on the outcome.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# remotes::install\_github("nhejazi/medoutcon")}
\CommentTok{\# remotes::install\_github("nhejazi/medoutcon", INSTALL\_opts=c("{-}{-}no{-}multiarch"))}
\CommentTok{\# https://arxiv.org/pdf/1912.09936}
\FunctionTok{rm}\NormalTok{(}\AttributeTok{list=}\FunctionTok{ls}\NormalTok{())}
\NormalTok{df2\_int }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file =} \StringTok{"data/df2\_int.csv"}\NormalTok{)}

\FunctionTok{library}\NormalTok{(tidyverse)}
\FunctionTok{library}\NormalTok{(sl3)}
\FunctionTok{library}\NormalTok{(medoutcon)}
\FunctionTok{library}\NormalTok{(hal9001)}

\NormalTok{?medoutcon}\SpecialCharTok{::}\NormalTok{medoutcon}

\DocumentationTok{\#\# 1) binary outcome }
\CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} \#}
\DocumentationTok{\#\#\# compute one{-}step estimate of the interventional direct effect}
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{1234}\NormalTok{)}
\NormalTok{os\_de }\OtherTok{\textless{}{-}} \FunctionTok{medoutcon}\NormalTok{(}\AttributeTok{W =}\NormalTok{ df2\_int[,}\FunctionTok{c}\NormalTok{(}\StringTok{"L0\_male"}\NormalTok{,}\StringTok{"L0\_soc\_env"}\NormalTok{)], }\CommentTok{\#matrix of baseline L(0)}
                   \AttributeTok{A =}\NormalTok{ df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\NormalTok{, }\CommentTok{\# numeric vector of the exposure}
                   \AttributeTok{Z =}\NormalTok{ df2\_int}\SpecialCharTok{$}\NormalTok{L1, }\CommentTok{\# numeric vector L(1) (only 1 variable)}
                   \AttributeTok{M =}\NormalTok{ df2\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes, }\CommentTok{\# numeric vector or matrix}
                   \AttributeTok{Y =}\NormalTok{ df2\_int}\SpecialCharTok{$}\NormalTok{Y\_death, }\CommentTok{\# numeric vector}
                   \AttributeTok{effect =} \StringTok{"direct"}\NormalTok{,}
                   \AttributeTok{b\_learners =}\NormalTok{ sl3}\SpecialCharTok{::}\NormalTok{Lrnr\_hal9001}\SpecialCharTok{$}\FunctionTok{new}\NormalTok{(), }\CommentTok{\# outcome regression}
                   \AttributeTok{estimator =} \StringTok{"onestep"}\NormalTok{)}
\NormalTok{os\_de}
\CommentTok{\# Interventional Direct Effect}
\CommentTok{\# Estimator: onestep}
\CommentTok{\# Estimate: 0.068}
\CommentTok{\# Std. Error: 0.015}
\CommentTok{\# 95\% CI: [0.039, 0.096]}

\NormalTok{os\_de}\SpecialCharTok{$}\NormalTok{theta}
\CommentTok{\# [1] 0.06763031}

\FunctionTok{sqrt}\NormalTok{(os\_de}\SpecialCharTok{$}\NormalTok{var)}
\CommentTok{\# [1] 0.01455125}

\FunctionTok{set.seed}\NormalTok{(}\DecValTok{1234}\NormalTok{)}
\NormalTok{os\_ie }\OtherTok{\textless{}{-}} \FunctionTok{medoutcon}\NormalTok{(}\AttributeTok{W =}\NormalTok{ df2\_int[,}\FunctionTok{c}\NormalTok{(}\StringTok{"L0\_male"}\NormalTok{,}\StringTok{"L0\_soc\_env"}\NormalTok{)], }\CommentTok{\#matrix of baseline L(0)}
                   \AttributeTok{A =}\NormalTok{ df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\NormalTok{, }\CommentTok{\# numeric vector of the exposure}
                   \AttributeTok{Z =}\NormalTok{ df2\_int}\SpecialCharTok{$}\NormalTok{L1, }\CommentTok{\# numeric vector L(1) (only 1 variable)}
                   \AttributeTok{M =}\NormalTok{ df2\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes, }\CommentTok{\# numeric vector or matrix}
                   \AttributeTok{Y =}\NormalTok{ df2\_int}\SpecialCharTok{$}\NormalTok{Y\_death, }\CommentTok{\# numeric vector}
                   \AttributeTok{effect =} \StringTok{"indirect"}\NormalTok{,}
                   \AttributeTok{b\_learners =}\NormalTok{ sl3}\SpecialCharTok{::}\NormalTok{Lrnr\_hal9001}\SpecialCharTok{$}\FunctionTok{new}\NormalTok{(), }\CommentTok{\# outcome regression}
                   \AttributeTok{estimator =} \StringTok{"onestep"}\NormalTok{)}
\NormalTok{os\_ie}
\CommentTok{\# Interventional Indirect Effect}
\CommentTok{\# Estimator: onestep}
\CommentTok{\# Estimate: 0.015}
\CommentTok{\# Std. Error: 0.004}
\CommentTok{\# 95\% CI: [0.008, 0.022]}

\NormalTok{os\_ie}\SpecialCharTok{$}\NormalTok{theta}
\CommentTok{\# [1] 0.01502601}

\DocumentationTok{\#\#\# Estimate counterfactuals E(Y\_\{a,G\_\{a*\}\})}
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{1234}\NormalTok{)}
\NormalTok{EY\_1M0 }\OtherTok{\textless{}{-}} \FunctionTok{medoutcon}\NormalTok{(}\AttributeTok{W =}\NormalTok{ df2\_int[,}\FunctionTok{c}\NormalTok{(}\StringTok{"L0\_male"}\NormalTok{,}\StringTok{"L0\_soc\_env"}\NormalTok{)],}
                    \AttributeTok{A =}\NormalTok{ df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\NormalTok{,}
                    \AttributeTok{Z =}\NormalTok{ df2\_int}\SpecialCharTok{$}\NormalTok{L1,}
                    \AttributeTok{M =}\NormalTok{ df2\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes,}
                    \AttributeTok{Y =}\NormalTok{ df2\_int}\SpecialCharTok{$}\NormalTok{Y\_death,}
                    \AttributeTok{contrast =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{0}\NormalTok{),}
                    \AttributeTok{b\_learners =}\NormalTok{ sl3}\SpecialCharTok{::}\NormalTok{Lrnr\_hal9001}\SpecialCharTok{$}\FunctionTok{new}\NormalTok{(), }\CommentTok{\# outcome regression}
                    \AttributeTok{estimator =} \StringTok{"onestep"}\NormalTok{)}
\NormalTok{EY\_1M0}
\CommentTok{\# Counterfactual TSM}
\CommentTok{\# Contrast: A = 1, M(A = 0)}
\CommentTok{\# Estimator: onestep}
\CommentTok{\# Estimate: 0.273}
\CommentTok{\# Std. Error: 0.014}
\CommentTok{\# 95\% CI: [0.246, 0.301]}

\NormalTok{EY\_0M0 }\OtherTok{\textless{}{-}} \FunctionTok{medoutcon}\NormalTok{(}\AttributeTok{W =}\NormalTok{ df2\_int[,}\FunctionTok{c}\NormalTok{(}\StringTok{"L0\_male"}\NormalTok{,}\StringTok{"L0\_soc\_env"}\NormalTok{)],}
                    \AttributeTok{A =}\NormalTok{ df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\NormalTok{,}
                    \AttributeTok{Z =}\NormalTok{ df2\_int}\SpecialCharTok{$}\NormalTok{L1,}
                    \AttributeTok{M =}\NormalTok{ df2\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes,}
                    \AttributeTok{Y =}\NormalTok{ df2\_int}\SpecialCharTok{$}\NormalTok{Y\_death,}
                    \AttributeTok{contrast =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{),}
                    \AttributeTok{b\_learners =}\NormalTok{ sl3}\SpecialCharTok{::}\NormalTok{Lrnr\_hal9001}\SpecialCharTok{$}\FunctionTok{new}\NormalTok{(), }\CommentTok{\# outcome regression}
                    \AttributeTok{estimator =} \StringTok{"onestep"}\NormalTok{)}
\NormalTok{EY\_0M0}
\CommentTok{\# Counterfactual TSM}
\CommentTok{\# Contrast: A = 0, M(A = 0)}
\CommentTok{\# Estimator: onestep}
\CommentTok{\# Estimate: 0.203}
\CommentTok{\# Std. Error: 0.004}
\CommentTok{\# 95\% CI: [0.195, 0.212]}

\DocumentationTok{\#\# randomized Natural Direct Effect =}
\NormalTok{rNDE }\OtherTok{\textless{}{-}}\NormalTok{ EY\_1M0}\SpecialCharTok{$}\NormalTok{theta }\SpecialCharTok{{-}}\NormalTok{ EY\_0M0}\SpecialCharTok{$}\NormalTok{theta}
\CommentTok{\# [1] 0.06964436}

\DocumentationTok{\#\# se}
\NormalTok{se\_rNDE }\OtherTok{\textless{}{-}} \FunctionTok{sqrt}\NormalTok{(}\FunctionTok{var}\NormalTok{(EY\_1M0}\SpecialCharTok{$}\NormalTok{eif }\SpecialCharTok{{-}}\NormalTok{ EY\_0M0}\SpecialCharTok{$}\NormalTok{eif) }\SpecialCharTok{/} \FunctionTok{nrow}\NormalTok{(df2\_int))}
\CommentTok{\# [1] 0.01459493}

\DocumentationTok{\#\# 95\%CI}
\FunctionTok{c}\NormalTok{(rNDE }\SpecialCharTok{{-}} \FunctionTok{qnorm}\NormalTok{(}\FloatTok{0.975}\NormalTok{) }\SpecialCharTok{*}\NormalTok{ se\_rNDE,}
\NormalTok{  rNDE }\SpecialCharTok{+} \FunctionTok{qnorm}\NormalTok{(}\FloatTok{0.975}\NormalTok{) }\SpecialCharTok{*}\NormalTok{ se\_rNDE)}
\CommentTok{\# [1] 0.04103882 0.09824989}

\DocumentationTok{\#\# 2) continuous outcome }
\CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} \#}
\DocumentationTok{\#\#\# compute one{-}step estimate of the interventional direct effect}
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{1234}\NormalTok{)}
\NormalTok{os\_de }\OtherTok{\textless{}{-}} \FunctionTok{medoutcon}\NormalTok{(}\AttributeTok{W =}\NormalTok{ df2\_int[,}\FunctionTok{c}\NormalTok{(}\StringTok{"L0\_male"}\NormalTok{,}\StringTok{"L0\_soc\_env"}\NormalTok{)], }\CommentTok{\#matrix of baseline L(0)}
                   \AttributeTok{A =}\NormalTok{ df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\NormalTok{, }\CommentTok{\# numeric vector of the exposure}
                   \AttributeTok{Z =}\NormalTok{ df2\_int}\SpecialCharTok{$}\NormalTok{L1, }\CommentTok{\# numeric vector L(1) (only 1 variable)}
                   \AttributeTok{M =}\NormalTok{ df2\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes, }\CommentTok{\# numeric vector or matrix}
                   \AttributeTok{Y =}\NormalTok{ df2\_int}\SpecialCharTok{$}\NormalTok{Y\_qol, }\CommentTok{\# numeric vector}
                   \AttributeTok{effect =} \StringTok{"direct"}\NormalTok{,}
                   \AttributeTok{b\_learners =}\NormalTok{ sl3}\SpecialCharTok{::}\NormalTok{Lrnr\_hal9001}\SpecialCharTok{$}\FunctionTok{new}\NormalTok{(), }\CommentTok{\# outcome regression}
                   \AttributeTok{estimator =} \StringTok{"onestep"}\NormalTok{)}
\NormalTok{os\_de}
\CommentTok{\# Interventional Direct Effect}
\CommentTok{\# Estimator: onestep}
\CommentTok{\# Estimate: {-}6.597}
\CommentTok{\# Std. Error: 0.346}
\CommentTok{\# 95\% CI: [{-}7.276, {-}5.918]}

\FunctionTok{set.seed}\NormalTok{(}\DecValTok{1234}\NormalTok{)}
\NormalTok{os\_ie }\OtherTok{\textless{}{-}} \FunctionTok{medoutcon}\NormalTok{(}\AttributeTok{W =}\NormalTok{ df2\_int[,}\FunctionTok{c}\NormalTok{(}\StringTok{"L0\_male"}\NormalTok{,}\StringTok{"L0\_soc\_env"}\NormalTok{)], }\CommentTok{\#matrix of baseline L(0)}
                   \AttributeTok{A =}\NormalTok{ df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\NormalTok{, }\CommentTok{\# numeric vector of the exposure}
                   \AttributeTok{Z =}\NormalTok{ df2\_int}\SpecialCharTok{$}\NormalTok{L1, }\CommentTok{\# numeric vector L(1) (only 1 variable)}
                   \AttributeTok{M =}\NormalTok{ df2\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes, }\CommentTok{\# numeric vector or matrix}
                   \AttributeTok{Y =}\NormalTok{ df2\_int}\SpecialCharTok{$}\NormalTok{Y\_qol, }\CommentTok{\# numeric vector}
                   \AttributeTok{effect =} \StringTok{"indirect"}\NormalTok{,}
                   \AttributeTok{b\_learners =}\NormalTok{ sl3}\SpecialCharTok{::}\NormalTok{Lrnr\_hal9001}\SpecialCharTok{$}\FunctionTok{new}\NormalTok{(), }\CommentTok{\# outcome regression}
                   \AttributeTok{estimator =} \StringTok{"onestep"}\NormalTok{)}
\NormalTok{os\_ie}
\CommentTok{\# Interventional Indirect Effect}
\CommentTok{\# Estimator: onestep}
\CommentTok{\# Estimate: {-}1.703}
\CommentTok{\# Std. Error: 0.239}
\CommentTok{\# 95\% CI: [{-}2.172, {-}1.234]}
\end{Highlighting}
\end{Shaded}

Below, we apply the TMLE estimator to the same data set. Note that the estimation of the direct effect seems to be biased (confirmed on simulations): maybe the arguments given in the \texttt{medoutcon} function are not correct?

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# 1) binary outcome }
\CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} \#}
\DocumentationTok{\#\#\# compute tmle estimate of the interventional direct effect \& indirect effects}
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{1234}\NormalTok{)}
\NormalTok{tmle\_de }\OtherTok{\textless{}{-}} \FunctionTok{medoutcon}\NormalTok{(}\AttributeTok{W =}\NormalTok{ df2\_int[,}\FunctionTok{c}\NormalTok{(}\StringTok{"L0\_male"}\NormalTok{,}\StringTok{"L0\_soc\_env"}\NormalTok{)], }\CommentTok{\#matrix of baseline L(0)}
                     \AttributeTok{A =}\NormalTok{ df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\NormalTok{, }\CommentTok{\# numeric vector of the exposure}
                     \AttributeTok{Z =}\NormalTok{ df2\_int}\SpecialCharTok{$}\NormalTok{L1, }\CommentTok{\# numeric vector L(1) (only 1 variable)}
                     \AttributeTok{M =}\NormalTok{ df2\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes, }\CommentTok{\# numeric vector or matrix}
                     \AttributeTok{Y =}\NormalTok{ df2\_int}\SpecialCharTok{$}\NormalTok{Y\_death, }\CommentTok{\# numeric vector}
                     \AttributeTok{effect =} \StringTok{"direct"}\NormalTok{,}
                     \AttributeTok{estimator =} \StringTok{"tmle"}\NormalTok{,}
                     \AttributeTok{b\_learners =}\NormalTok{ sl3}\SpecialCharTok{::}\NormalTok{Lrnr\_hal9001}\SpecialCharTok{$}\FunctionTok{new}\NormalTok{(), }\CommentTok{\# outcome regression}
                     \CommentTok{\# estimator\_args = list(cv\_folds = 10L, \# instead of 5L}
                     \CommentTok{\#                       max\_iter = 1L, \# instead of 5L}
                     \CommentTok{\#                       tiltmod\_tol = 1) \# instead of 5}
\NormalTok{                    )}
\NormalTok{tmle\_de}
\CommentTok{\# Interventional Direct Effect}
\CommentTok{\# Estimator: tmle}
\CommentTok{\# Estimate: 0.042             \textless{}{-} ?! biased (confirmed on simulations)}
\CommentTok{\# Std. Error: 0.015}
\CommentTok{\# 95\% CI: [0.014, 0.071]}

\NormalTok{tmle\_de}\SpecialCharTok{$}\NormalTok{theta}
\CommentTok{\# [1] 0.04222315}

\FunctionTok{sqrt}\NormalTok{(tmle\_de}\SpecialCharTok{$}\NormalTok{var)}
\CommentTok{\# [1] 0.01455125}

\FunctionTok{set.seed}\NormalTok{(}\DecValTok{1234}\NormalTok{)}
\NormalTok{tmle\_ie }\OtherTok{\textless{}{-}} \FunctionTok{medoutcon}\NormalTok{(}\AttributeTok{W =}\NormalTok{ df2\_int[,}\FunctionTok{c}\NormalTok{(}\StringTok{"L0\_male"}\NormalTok{,}\StringTok{"L0\_soc\_env"}\NormalTok{)], }\CommentTok{\#matrix of baseline L(0)}
                   \AttributeTok{A =}\NormalTok{ df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\NormalTok{, }\CommentTok{\# numeric vector of the exposure}
                   \AttributeTok{Z =}\NormalTok{ df2\_int}\SpecialCharTok{$}\NormalTok{L1, }\CommentTok{\# numeric vector L(1) (only 1 variable)}
                   \AttributeTok{M =}\NormalTok{ df2\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes, }\CommentTok{\# numeric vector or matrix}
                   \AttributeTok{Y =}\NormalTok{ df2\_int}\SpecialCharTok{$}\NormalTok{Y\_death, }\CommentTok{\# numeric vector}
                   \AttributeTok{effect =} \StringTok{"indirect"}\NormalTok{,}
                   \AttributeTok{b\_learners =}\NormalTok{ sl3}\SpecialCharTok{::}\NormalTok{Lrnr\_hal9001}\SpecialCharTok{$}\FunctionTok{new}\NormalTok{(), }\CommentTok{\# outcome regression}
                   \AttributeTok{estimator =} \StringTok{"tmle"}\NormalTok{)}
\NormalTok{tmle\_ie}
\CommentTok{\# Interventional Indirect Effect}
\CommentTok{\# Estimator: tmle}
\CommentTok{\# Estimate: 0.013}
\CommentTok{\# Std. Error: 0.004}
\CommentTok{\# 95\% CI: [0.006, 0.021]}

\DocumentationTok{\#\# 2) continuous outcome}
\CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} \#}
\DocumentationTok{\#\#\# compute tmle estimate of the interventional direct effect \& indirect effects}
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{1234}\NormalTok{)}
\NormalTok{tmle\_de }\OtherTok{\textless{}{-}} \FunctionTok{medoutcon}\NormalTok{(}\AttributeTok{W =}\NormalTok{ df2\_int[,}\FunctionTok{c}\NormalTok{(}\StringTok{"L0\_male"}\NormalTok{,}\StringTok{"L0\_soc\_env"}\NormalTok{)], }\CommentTok{\#matrix of baseline L(0)}
                     \AttributeTok{A =}\NormalTok{ df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\NormalTok{, }\CommentTok{\# numeric vector of the exposure}
                     \AttributeTok{Z =}\NormalTok{ df2\_int}\SpecialCharTok{$}\NormalTok{L1, }\CommentTok{\# numeric vector L(1) (only 1 variable)}
                     \AttributeTok{M =}\NormalTok{ df2\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes, }\CommentTok{\# numeric vector or matrix}
                     \AttributeTok{Y =}\NormalTok{ df2\_int}\SpecialCharTok{$}\NormalTok{Y\_qol, }\CommentTok{\# numeric vector}
                     \AttributeTok{effect =} \StringTok{"direct"}\NormalTok{,}
                     \AttributeTok{b\_learners =}\NormalTok{ sl3}\SpecialCharTok{::}\NormalTok{Lrnr\_hal9001}\SpecialCharTok{$}\FunctionTok{new}\NormalTok{(), }\CommentTok{\# outcome regression}
                     \AttributeTok{estimator =} \StringTok{"tmle"}\NormalTok{)}
\NormalTok{tmle\_de}
\CommentTok{\# Interventional Direct Effect}
\CommentTok{\# Estimator: tmle}
\CommentTok{\# Estimate: {-}4.808          \textless{}{-} also biased ?}
\CommentTok{\# Std. Error: 0.346}
\CommentTok{\# 95\% CI: [{-}5.487, {-}4.129]}

\FunctionTok{set.seed}\NormalTok{(}\DecValTok{1234}\NormalTok{)}
\NormalTok{tmle\_ie }\OtherTok{\textless{}{-}} \FunctionTok{medoutcon}\NormalTok{(}\AttributeTok{W =}\NormalTok{ df2\_int[,}\FunctionTok{c}\NormalTok{(}\StringTok{"L0\_male"}\NormalTok{,}\StringTok{"L0\_soc\_env"}\NormalTok{)], }\CommentTok{\#matrix of baseline L(0)}
                     \AttributeTok{A =}\NormalTok{ df2\_int}\SpecialCharTok{$}\NormalTok{A0\_PM2}\FloatTok{.5}\NormalTok{, }\CommentTok{\# numeric vector of the exposure}
                     \AttributeTok{Z =}\NormalTok{ df2\_int}\SpecialCharTok{$}\NormalTok{L1, }\CommentTok{\# numeric vector L(1) (only 1 variable)}
                     \AttributeTok{M =}\NormalTok{ df2\_int}\SpecialCharTok{$}\NormalTok{M\_diabetes, }\CommentTok{\# numeric vector or matrix}
                     \AttributeTok{Y =}\NormalTok{ df2\_int}\SpecialCharTok{$}\NormalTok{Y\_qol, }\CommentTok{\# numeric vector}
                     \AttributeTok{effect =} \StringTok{"indirect"}\NormalTok{,}
                     \AttributeTok{b\_learners =}\NormalTok{ sl3}\SpecialCharTok{::}\NormalTok{Lrnr\_hal9001}\SpecialCharTok{$}\FunctionTok{new}\NormalTok{(), }\CommentTok{\# outcome regression}
                     \AttributeTok{estimator =} \StringTok{"tmle"}\NormalTok{)}
\NormalTok{tmle\_ie}
\CommentTok{\# Interventional Indirect Effect}
\CommentTok{\# Estimator: tmle}
\CommentTok{\# Estimate: {-}1.738}
\CommentTok{\# Std. Error: 0.239}
\CommentTok{\# 95\% CI: [{-}2.207, {-}1.269]}
\end{Highlighting}
\end{Shaded}

\chapter{Appendix A: Data generating mechanisms}\label{appendix_a}

The data generating mechanisms are characterized by a causal model and a statistical model that generate data given in example.

In the first causal model, the mediator-outcome confounder \(L(1)\) is not affected by the exposure. In the second causal model, the mediator-outcome confounder \(L(1)\) is affected by the exposure.

\section{First causal model: Data generating mechanism without mediator-outcome confounder affected by the exposure}\label{first-causal-model-data-generating-mechanism-without-mediator-outcome-confounder-affected-by-the-exposure}

This data generating mechanism is defined by the following set of structural equations:
\[\begin{array}{lll}
P(L(0)_{male} = 1) &=& p_{L(0)_{male}}\\
P(L(0)_{soc.env} = 1) &=& p_{L(0)_{soc.env}}\\
P(A_{PM_{2.5}} = 1) &=& \beta_{A} + \beta_{male}^A \times L(0)_{male} + \beta_{soc.env}^A \times L(0)_{soc.env}\\
P(L(1) = 1) &=& p_{L(1)}\\
P(M_{smoking} = 1) &=& \beta_{M} + \beta_{male}^M \times L(0)_{male} + \beta_{soc.env}^M \times L(0)_{soc.env} + \beta_{L(1)}^M \times L(1) + \beta_{A}^M \times A_{PM_{2.5}}\\
P(Y_{death} = 1) &=& \beta_{Y} + \beta_{male}^Y \times L(0)_{male} + \beta_{soc.env}^Y \times L(0)_{soc.env} + \beta_{L(1)}^Y \times L(1)\\
                 & & + \beta_{A}^Y \times A_{PM_{2.5}} + \beta_{M}^Y \times M_{diabetes} + \beta_{A \ast M }^Y \times A_{PM_{2.5}} \times M_{diabetes}\\
\mathbb{E}(Y_{Qol} = 1) &=& \gamma_{Y} + \gamma_{male}^Y \times L(0)_{male} + \gamma_{soc.env}^Y \times L(0)_{soc.env} + \gamma_{L(1)}^Y \times L(1)\\
                 & &+ \gamma_{A}^Y \times A_{PM_{2.5}} + \gamma_{M}^Y \times M_{diabetes} + \gamma_{A \ast M }^Y \times A_{PM_{2.5}} \times M_{diabetes} + \varepsilon_Y
\end{array}\]
where \(\varepsilon_Y \sim \mathcal{N}(0,\sigma_Y = 10)\).

One can set the parameters of these structural equations using the following function \texttt{param.causal.model.1()}:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{param.causal.model}\FloatTok{.1} \OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(}\AttributeTok{A.M.interaction =} \ConstantTok{NULL}\NormalTok{) \{}
\CommentTok{\# L0}
\NormalTok{p\_L0\_male }\OtherTok{\textless{}{-}} \FloatTok{0.5}
\NormalTok{p\_L0\_soc\_env }\OtherTok{\textless{}{-}} \FloatTok{0.65}

\CommentTok{\# A: A0\_PM2.5 \textless{}{-} rbinom( 0.05 + 0.04 * L0\_male + 0.06 * L0\_soc\_env ) }
\NormalTok{b\_A }\OtherTok{\textless{}{-}} \FloatTok{0.05}   \CommentTok{\# reference prevalence is 5\%}
\NormalTok{b\_male\_A }\OtherTok{\textless{}{-}} \FloatTok{0.04}  \CommentTok{\# + 0.04 for the effect of L0\_male {-}\textgreater{} A0\_PM2.5}
\NormalTok{b\_soc\_env\_A }\OtherTok{\textless{}{-}} \FloatTok{0.06}  \CommentTok{\# +0.06 for the effect of L0\_soc\_env {-}\textgreater{} A0\_PM2.5}

\CommentTok{\# L1: intermediate confounder between M and Y, not influenced by A}
\NormalTok{p\_L1 }\OtherTok{\textless{}{-}} \FloatTok{0.3}

\CommentTok{\# M: M\_diabetes \textless{}{-} rbinom( 0.2 + 0.05 * L0\_male + 0.06 * L0\_soc\_env + 0.07 * L1 +}
\CommentTok{\#                         0.1 * A0\_PM2.5 ) }
\NormalTok{b\_M }\OtherTok{\textless{}{-}} \FloatTok{0.2} \CommentTok{\# reference prevalence is 20\%}
\NormalTok{b\_male\_M }\OtherTok{\textless{}{-}} \FloatTok{0.05} \CommentTok{\# +0.05 for the effect of L0\_male {-}\textgreater{} M\_diabetes}
\NormalTok{b\_soc\_env\_M }\OtherTok{\textless{}{-}} \FloatTok{0.06} \CommentTok{\# +0.06 for the effect of L0\_soc\_env {-}\textgreater{} M\_diabetes}
\NormalTok{b\_L1\_M }\OtherTok{\textless{}{-}} \FloatTok{0.07} \CommentTok{\# +0.07 for the effect of L1 {-}\textgreater{} M\_diabetes}
\NormalTok{b\_A\_M }\OtherTok{\textless{}{-}} \FloatTok{0.1} \CommentTok{\# +0.10 for the effect of A0\_PM2.5 {-}\textgreater{} M\_diabetes}

\CommentTok{\# Y binary: rbinom( 0.10 + 0.06 * L0\_male + 0.04 * L0\_soc\_env + 0.05 * A0\_PM2.5 +}
\CommentTok{\#                   0.07 * L1 + 0.08 * M\_diabetes +}
\CommentTok{\#                   0.03 * A0\_PM2.5 * M\_diabetes * A.M.inter ) }
\NormalTok{b\_Y }\OtherTok{\textless{}{-}} \FloatTok{0.1} \CommentTok{\# reference prevalence is 10\%}
\NormalTok{b\_male\_Y }\OtherTok{\textless{}{-}} \FloatTok{0.06} \CommentTok{\# +0.06 for the effect of L0\_male {-}\textgreater{} Y}
\NormalTok{b\_soc\_env\_Y }\OtherTok{\textless{}{-}} \FloatTok{0.04} \CommentTok{\# +0.04 for the effect of L0\_soc\_env {-}\textgreater{} Y}
\NormalTok{b\_A\_Y }\OtherTok{\textless{}{-}} \FloatTok{0.05} \CommentTok{\# 0.05 for the effect of A0\_PM2.5 {-}\textgreater{} Y}
\NormalTok{b\_L1\_Y }\OtherTok{\textless{}{-}} \FloatTok{0.07} \CommentTok{\# +0.07 for the effect of L1 {-}\textgreater{} Y}
\NormalTok{b\_M\_Y }\OtherTok{\textless{}{-}} \FloatTok{0.08} \CommentTok{\# 0.08 for the effect of M\_diabetes {-}\textgreater{} Y}
\NormalTok{b\_AM\_Y }\OtherTok{\textless{}{-}} \FloatTok{0.03} \CommentTok{\# 0.03 for the interaction effect A0\_PM2.5 * M\_diabetes {-}\textgreater{} Y}

\CommentTok{\# Y continuous: (75 {-} 1 * L0\_male {-} 3 * L0\_soc\_env {-} 4 * A0\_PM2.5 {-}3.5 * L1 {-} }
\CommentTok{\#                9 * M\_diabetes {-}5 * A0\_PM2.5 * M\_diabetes * A.M.inter ) + }
\CommentTok{\#                rnorm(N, mean = 0, sd = 10)}
\NormalTok{mu\_Y }\OtherTok{\textless{}{-}} \DecValTok{75} \CommentTok{\# reference mean for QoL}
\NormalTok{c\_male\_Y }\OtherTok{\textless{}{-}} \SpecialCharTok{{-}}\DecValTok{1} \CommentTok{\# {-}1 for the effect of L0\_male {-}\textgreater{} Y}
\NormalTok{c\_soc\_env\_Y }\OtherTok{\textless{}{-}} \SpecialCharTok{{-}}\DecValTok{3} \CommentTok{\# {-}3 for the effect of L0\_soc\_env {-}\textgreater{} Y}
\NormalTok{c\_A\_Y }\OtherTok{\textless{}{-}} \SpecialCharTok{{-}}\DecValTok{4} \CommentTok{\# {-}4 for the effect of A0\_PM2.5 {-}\textgreater{} Y}
\NormalTok{c\_L1\_Y }\OtherTok{\textless{}{-}} \SpecialCharTok{{-}}\FloatTok{3.5} \CommentTok{\# {-}3.5 for the effect of L1 {-}\textgreater{} Y}
\NormalTok{c\_M\_Y }\OtherTok{\textless{}{-}} \SpecialCharTok{{-}}\DecValTok{9} \CommentTok{\# {-}9 for the effect of M\_diabetes {-}\textgreater{} Y}
\NormalTok{c\_AM\_Y }\OtherTok{\textless{}{-}} \SpecialCharTok{{-}}\DecValTok{5}  \CommentTok{\# {-} 5 for the interaction effect A0\_PM2.5 * M\_diabetes  {-}\textgreater{} Y}
\NormalTok{sd\_Y }\OtherTok{\textless{}{-}} \DecValTok{10} \CommentTok{\# standard deviation of the residuals}

\CommentTok{\# A*M interaction ?}
\NormalTok{A.M.inter }\OtherTok{\textless{}{-}}\NormalTok{ A.M.interaction}

\NormalTok{coef }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{( }\AttributeTok{p\_L0\_male =}\NormalTok{ p\_L0\_male, }\AttributeTok{p\_L0\_soc\_env =}\NormalTok{ p\_L0\_soc\_env, }
           \AttributeTok{b\_A =}\NormalTok{ b\_A, }\AttributeTok{b\_male\_A =}\NormalTok{ b\_male\_A, }\AttributeTok{b\_soc\_env\_A =}\NormalTok{ b\_soc\_env\_A, }
           \AttributeTok{p\_L1 =}\NormalTok{ p\_L1,}
           \AttributeTok{b\_M =}\NormalTok{ b\_M, }\AttributeTok{b\_male\_M =}\NormalTok{ b\_male\_M, }\AttributeTok{b\_soc\_env\_M =}\NormalTok{ b\_soc\_env\_M, }
            \AttributeTok{b\_L1\_M =}\NormalTok{ b\_L1\_M, }\AttributeTok{b\_A\_M =}\NormalTok{ b\_A\_M,}
           \AttributeTok{b\_Y =}\NormalTok{ b\_Y, }\AttributeTok{b\_male\_Y =}\NormalTok{ b\_male\_Y, }\AttributeTok{b\_soc\_env\_Y =}\NormalTok{ b\_soc\_env\_Y, }
            \AttributeTok{b\_A\_Y =}\NormalTok{ b\_A\_Y, }\AttributeTok{b\_L1\_Y =}\NormalTok{ b\_L1\_Y, }\AttributeTok{b\_M\_Y =}\NormalTok{ b\_M\_Y, }\AttributeTok{b\_AM\_Y =}\NormalTok{ b\_AM\_Y,}
           \AttributeTok{mu\_Y =}\NormalTok{ mu\_Y, }\AttributeTok{c\_male\_Y =}\NormalTok{ c\_male\_Y, }\AttributeTok{c\_soc\_env\_Y =}\NormalTok{ c\_soc\_env\_Y, }
            \AttributeTok{c\_A\_Y =}\NormalTok{ c\_A\_Y, }\AttributeTok{c\_L1\_Y =}\NormalTok{ c\_L1\_Y, }\AttributeTok{c\_M\_Y =}\NormalTok{ c\_M\_Y, }\AttributeTok{c\_AM\_Y =}\NormalTok{ c\_AM\_Y, }
           \AttributeTok{sd\_Y =}\NormalTok{ sd\_Y, }\AttributeTok{A.M.inter =}\NormalTok{ A.M.inter)}
  
\FunctionTok{return}\NormalTok{(coef)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\section{Second causal model: Data generating mechanism with mediator-outcome confounder affected by the exposure}\label{second-causal-model-data-generating-mechanism-with-mediator-outcome-confounder-affected-by-the-exposure}

This data generating mechanism is defined by the following set of structural equations:
\[\begin{array}{lll}
P(L(0)_{male} = 1) &=& p_{L(0)_{male}}\\
P(L(0)_{soc.env} = 1) &=& p_{L(0)_{soc.env}}\\
P(A_{PM_{2.5}} = 1) &=& \beta_{A} + \beta_{male}^A \times L(0)_{male} + \beta_{soc.env}^A \times L(0)_{soc.env}\\
P(L(1) = 1) &=& \beta_{L(1)} + \beta_{male}^{L(1)} \times L(0)_{male} + \beta_{soc.env}^{L(1)} \times L(0)_{soc.env} + \beta_{A}^{L(1)} \times A_{PM_{2.5}}\\
P(M_{diabetes} = 1) &=& \beta_{M} + \beta_{male}^M \times L(0)_{male} + \beta_{soc.env}^M \times L(0)_{soc.env} + \beta_{L(1)}^M \times L(1) + \beta_{A}^M \times A_{PM_{2.5}}\\
P(Y_{death} = 1) &=& \beta_{Y} + \beta_{male}^Y \times L(0)_{male} + \beta_{soc.env}^Y \times L(0)_{soc.env} + \beta_{L(1)}^Y \times L(1)\\
                 & & + \beta_{A}^Y \times A_{PM_{2.5}} + \beta_{M}^Y \times M_{diabetes} + \beta_{A \ast M }^Y \times A_{PM_{2.5}} \times M_{diabetes}\\
\mathbb{E}(Y_{Qol} = 1) &=& \gamma_{Y} + \gamma_{male}^Y \times L(0)_{male} + \gamma_{soc.env}^Y \times L(0)_{soc.env} + \gamma_{L(1)}^Y \times L(1)\\
                        & &+ \gamma_{A}^Y \times A_{PM_{2.5}} + \gamma_{M}^Y \times M_{diabetes} + \gamma_{A \ast M }^Y \times A_{PM_{2.5}} \times M_{diabetes} + \varepsilon_Y
\end{array}\]
where \(\varepsilon_Y \sim \mathcal{N}(0,\sigma_Y = 10)\).

One can set the parameters of these structural equations using the following function \texttt{param.causal.model.2()}:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{param.causal.model}\FloatTok{.2} \OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(}\AttributeTok{A.M.interaction =} \ConstantTok{NULL}\NormalTok{) \{}
\CommentTok{\# L0}
\NormalTok{p\_L0\_male }\OtherTok{\textless{}{-}} \FloatTok{0.5}
\NormalTok{p\_L0\_soc\_env }\OtherTok{\textless{}{-}} \FloatTok{0.65}

\CommentTok{\# A: A0\_PM2.5 \textless{}{-} rbinom( 0.05 + 0.04 * L0\_male + 0.06 * L0\_soc\_env ) }
\NormalTok{b\_A }\OtherTok{\textless{}{-}} \FloatTok{0.05}   \CommentTok{\# reference prevalence is 5\%}
\NormalTok{b\_male\_A }\OtherTok{\textless{}{-}} \FloatTok{0.04}  \CommentTok{\# + 0.04 for the effect of L0\_male {-}\textgreater{} A0\_PM2.5}
\NormalTok{b\_soc\_env\_A }\OtherTok{\textless{}{-}} \FloatTok{0.06}  \CommentTok{\# +0.06 for the effect of L0\_soc\_env {-}\textgreater{} A0\_PM2.5}

\CommentTok{\# L1: L1 \textless{}{-} rbinom( 0.30 {-} 0.05 * L0\_male + 0.08 * L0\_soc\_env + }
\CommentTok{\#                   0.2 * A0\_PM2.5 ) }
\NormalTok{b\_L1 }\OtherTok{\textless{}{-}} \FloatTok{0.30}   \CommentTok{\# reference prevalence is 30\%}
\NormalTok{b\_male\_L1 }\OtherTok{\textless{}{-}} \SpecialCharTok{{-}}\FloatTok{0.05}  \CommentTok{\# {-} 0.05 for the effect of L0\_male {-}\textgreater{} L1}
\NormalTok{b\_soc\_env\_L1 }\OtherTok{\textless{}{-}} \SpecialCharTok{+}\FloatTok{0.08} \CommentTok{\# + 0.08 for the effect of L0\_soc\_env {-}\textgreater{} L1}
\NormalTok{b\_A\_L1 }\OtherTok{\textless{}{-}} \SpecialCharTok{+}\FloatTok{0.2} \CommentTok{\# +0.2 for the effect of A0\_PM2.5 {-}\textgreater{} L1}

\CommentTok{\# M: M\_diabetes \textless{}{-} rbinom( 0.2 + 0.05 * L0\_male + 0.06 * L0\_soc\_env + }
\CommentTok{\#                         0.2 * L1 + 0.1 * A0\_PM2.5 ) }
\NormalTok{b\_M }\OtherTok{\textless{}{-}} \FloatTok{0.2} \CommentTok{\# reference prevalence is 20\%}
\NormalTok{b\_male\_M }\OtherTok{\textless{}{-}} \FloatTok{0.05} \CommentTok{\# +0.05 for the effect of L0\_male {-}\textgreater{} M\_diabetes}
\NormalTok{b\_soc\_env\_M }\OtherTok{\textless{}{-}} \FloatTok{0.06} \CommentTok{\# +0.06 for the effect of L0\_soc\_env {-}\textgreater{} M\_diabetes}
\NormalTok{b\_A\_M }\OtherTok{\textless{}{-}} \FloatTok{0.1} \CommentTok{\# +0.10 for the effect of A0\_PM2.5 {-}\textgreater{} M\_diabetes}
\NormalTok{b\_L1\_M }\OtherTok{\textless{}{-}} \FloatTok{0.2} \CommentTok{\# +0.2 for the effect of L1 {-}\textgreater{} M\_diabetes}

\CommentTok{\# Y binary: rbinom( 0.10 + 0.06 * L0\_male + 0.04 * L0\_soc\_env + }
\CommentTok{\#                   0.05 * A0\_PM2.5 + 0.07 * L1 + 0.08 * M\_diabetes +}
\CommentTok{\#                   0.03 * A0\_PM2.5 * M\_diabetes * A.M.inter ) }
\NormalTok{b\_Y }\OtherTok{\textless{}{-}} \FloatTok{0.1} \CommentTok{\# reference prevalence is 10\%}
\NormalTok{b\_male\_Y }\OtherTok{\textless{}{-}} \FloatTok{0.06} \CommentTok{\# +0.06 for the effect of L0\_male {-}\textgreater{} Y}
\NormalTok{b\_soc\_env\_Y }\OtherTok{\textless{}{-}} \FloatTok{0.04} \CommentTok{\# +0.04 for the effect of L0\_soc\_env {-}\textgreater{} Y}
\NormalTok{b\_A\_Y }\OtherTok{\textless{}{-}} \FloatTok{0.05} \CommentTok{\# 0.05 for the effect of A0\_PM2.5 {-}\textgreater{} Y}
\NormalTok{b\_L1\_Y }\OtherTok{\textless{}{-}} \FloatTok{0.07} \CommentTok{\# +0.07 for the effect of L1 {-}\textgreater{} Y}
\NormalTok{b\_M\_Y }\OtherTok{\textless{}{-}} \FloatTok{0.08} \CommentTok{\# 0.08 for the effect of M\_diabetes {-}\textgreater{} Y}
\NormalTok{b\_AM\_Y }\OtherTok{\textless{}{-}} \FloatTok{0.03} \CommentTok{\# 0.03 for the interaction effect A0\_PM2.5 * M\_diabetes {-}\textgreater{} Y}

\CommentTok{\# Y continuous: (75 {-} 1 * L0\_male {-} 3 * L0\_soc\_env {-} 4 * A0\_PM2.5 +}
\CommentTok{\#                {-}3.5 * L1 {-} 9 * M\_diabetes + }
\CommentTok{\#                {-}5 * A0\_PM2.5 * M\_diabetes * A.M.inter ) + rnorm(N, mean = 0, sd = 10)}
\NormalTok{mu\_Y }\OtherTok{\textless{}{-}} \DecValTok{75} \CommentTok{\# reference mean for QoL}
\NormalTok{c\_male\_Y }\OtherTok{\textless{}{-}} \SpecialCharTok{{-}}\DecValTok{1} \CommentTok{\# {-}1 for the effect of L0\_male {-}\textgreater{} Y}
\NormalTok{c\_soc\_env\_Y }\OtherTok{\textless{}{-}} \SpecialCharTok{{-}}\DecValTok{3} \CommentTok{\# {-}3 for the effect of L0\_soc\_env {-}\textgreater{} Y}
\NormalTok{c\_A\_Y }\OtherTok{\textless{}{-}} \SpecialCharTok{{-}}\DecValTok{4} \CommentTok{\# {-}4 for the effect of A0\_PM2.5 {-}\textgreater{} Y}
\NormalTok{c\_L1\_Y }\OtherTok{\textless{}{-}} \SpecialCharTok{{-}}\DecValTok{5} \CommentTok{\# {-}5 for the effect of L1 {-}\textgreater{} Y}
\NormalTok{c\_M\_Y }\OtherTok{\textless{}{-}} \SpecialCharTok{{-}}\DecValTok{9} \CommentTok{\# {-}9 for the effect of M\_diabetes {-}\textgreater{} Y}
\NormalTok{c\_AM\_Y }\OtherTok{\textless{}{-}} \SpecialCharTok{{-}}\DecValTok{5}  \CommentTok{\# {-} 5 for the interaction effect A0\_PM2.5 * M\_diabetes  {-}\textgreater{} Y}
\NormalTok{sd\_Y }\OtherTok{\textless{}{-}} \DecValTok{10} \CommentTok{\# standard deviation of the residuals}

\CommentTok{\# A*M interaction ?}
\NormalTok{A.M.inter }\OtherTok{\textless{}{-}}\NormalTok{ A.M.interaction}

\NormalTok{coef }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{( }\AttributeTok{p\_L0\_male =}\NormalTok{ p\_L0\_male, }\AttributeTok{p\_L0\_soc\_env =}\NormalTok{ p\_L0\_soc\_env, }
           \AttributeTok{b\_A =}\NormalTok{ b\_A, }\AttributeTok{b\_male\_A =}\NormalTok{ b\_male\_A, }\AttributeTok{b\_soc\_env\_A =}\NormalTok{ b\_soc\_env\_A, }
           \AttributeTok{b\_L1 =}\NormalTok{ b\_L1, }\AttributeTok{b\_male\_L1 =}\NormalTok{ b\_male\_L1, }\AttributeTok{b\_soc\_env\_L1 =}\NormalTok{ b\_soc\_env\_L1, }
            \AttributeTok{b\_A\_L1 =}\NormalTok{ b\_A\_L1,}
           \AttributeTok{b\_M =}\NormalTok{ b\_M, }\AttributeTok{b\_male\_M =}\NormalTok{ b\_male\_M, }\AttributeTok{b\_soc\_env\_M =}\NormalTok{ b\_soc\_env\_M, }
            \AttributeTok{b\_L1\_M =}\NormalTok{ b\_L1\_M, }\AttributeTok{b\_A\_M =}\NormalTok{ b\_A\_M,}
           \AttributeTok{b\_Y =}\NormalTok{ b\_Y, }\AttributeTok{b\_male\_Y =}\NormalTok{ b\_male\_Y, }\AttributeTok{b\_soc\_env\_Y =}\NormalTok{ b\_soc\_env\_Y, }
            \AttributeTok{b\_A\_Y =}\NormalTok{ b\_A\_Y, }\AttributeTok{b\_L1\_Y =}\NormalTok{ b\_L1\_Y, }\AttributeTok{b\_M\_Y =}\NormalTok{ b\_M\_Y, }\AttributeTok{b\_AM\_Y =}\NormalTok{ b\_AM\_Y,}
           \AttributeTok{mu\_Y =}\NormalTok{ mu\_Y, }\AttributeTok{c\_male\_Y =}\NormalTok{ c\_male\_Y, }\AttributeTok{c\_soc\_env\_Y =}\NormalTok{ c\_soc\_env\_Y, }
            \AttributeTok{c\_A\_Y =}\NormalTok{ c\_A\_Y, }\AttributeTok{c\_L1\_Y =}\NormalTok{ c\_L1\_Y, }\AttributeTok{c\_M\_Y =}\NormalTok{ c\_M\_Y, }\AttributeTok{c\_AM\_Y =}\NormalTok{ c\_AM\_Y, }
              \AttributeTok{sd\_Y =}\NormalTok{ sd\_Y, }\AttributeTok{A.M.inter =}\NormalTok{ A.M.inter)}
  
  \FunctionTok{return}\NormalTok{(coef)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\section{Simulation of the four data sets used in examples}\label{simulation-of-the-four-data-sets-used-in-examples}

\subsection{Data sets generated from the causal model 1}\label{data-sets-generated-from-the-causal-model-1}

The following function \texttt{gen.data.causal.model.1} can be used to simulate data sets using the parameters defined previously in the \texttt{param.causal.model.1} function.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{gen.data.causal.model}\FloatTok{.1} \OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(N, A.M.inter) \{ }\CommentTok{\# input parameters are the }
  \CommentTok{\#   sample size N and the presence of A*M interaction with A.M.inter = 0 or 1}
  
\NormalTok{  b }\OtherTok{\textless{}{-}} \FunctionTok{param.causal.model.1}\NormalTok{(}\AttributeTok{A.M.interaction =}\NormalTok{ A.M.inter)}
    
  \CommentTok{\# baseline confounders: parent\textquotesingle{}s educational level=L0\_soc\_env \& sex=L0\_male}
\NormalTok{  L0\_male }\OtherTok{\textless{}{-}} \FunctionTok{rbinom}\NormalTok{(N, }\AttributeTok{size =} \DecValTok{1}\NormalTok{, }\AttributeTok{prob =}\NormalTok{ b[}\StringTok{"p\_L0\_male"}\NormalTok{]) }
\NormalTok{  L0\_soc\_env }\OtherTok{\textless{}{-}} \FunctionTok{rbinom}\NormalTok{(N, }\AttributeTok{size =} \DecValTok{1}\NormalTok{, }\AttributeTok{prob =}\NormalTok{ b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])  }
  
  \CommentTok{\# exposure: A0\_PM2.5}
\NormalTok{  A0\_PM2}\FloatTok{.5} \OtherTok{\textless{}{-}} \FunctionTok{rbinom}\NormalTok{(N, }\AttributeTok{size =} \DecValTok{1}\NormalTok{, }\AttributeTok{prob =}\NormalTok{  b[}\StringTok{"b\_A"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                     b[}\StringTok{"b\_male\_A"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ L0\_male }\SpecialCharTok{+} 
\NormalTok{                     b[}\StringTok{"b\_soc\_env\_A"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ L0\_soc\_env ) }
  
  \CommentTok{\# intermediate confounder between M\_diabetes and Y, not affected by A0 L1}
\NormalTok{  L1 }\OtherTok{\textless{}{-}} \FunctionTok{rbinom}\NormalTok{(N, }\AttributeTok{size =} \DecValTok{1}\NormalTok{, }\AttributeTok{prob =}\NormalTok{ b[}\StringTok{"p\_L1"}\NormalTok{])}
  
  \CommentTok{\# mediator: M\_diabetes}
\NormalTok{  M\_diabetes }\OtherTok{\textless{}{-}} \FunctionTok{rbinom}\NormalTok{(N, }\AttributeTok{size =} \DecValTok{1}\NormalTok{, }\AttributeTok{prob =}\NormalTok{ b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                        b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ L0\_male }\SpecialCharTok{+} 
\NormalTok{                        b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+} 
\NormalTok{                        b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+}
\NormalTok{                        b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ L1) }

  \CommentTok{\# Y\_death }
\NormalTok{  Y\_death }\OtherTok{\textless{}{-}} \FunctionTok{rbinom}\NormalTok{(N, }\AttributeTok{size =} \DecValTok{1}\NormalTok{, }\AttributeTok{prob =}\NormalTok{ b[}\StringTok{"b\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                      b[}\StringTok{"b\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ L0\_male }\SpecialCharTok{+} 
\NormalTok{                      b[}\StringTok{"b\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+} 
\NormalTok{                      b[}\StringTok{"b\_A\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+} 
\NormalTok{                      b[}\StringTok{"b\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ L1 }\SpecialCharTok{+}
\NormalTok{                      b[}\StringTok{"b\_M\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ M\_diabetes }\SpecialCharTok{+}
\NormalTok{                      b[}\StringTok{"b\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{*}\NormalTok{ M\_diabetes }\SpecialCharTok{*}\NormalTok{ A.M.inter ) }
  
  \CommentTok{\# Y\_qol }
\NormalTok{  Y\_qol }\OtherTok{\textless{}{-}}\NormalTok{ ( b[}\StringTok{"mu\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{               b[}\StringTok{"c\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ L0\_male }\SpecialCharTok{+} 
\NormalTok{               b[}\StringTok{"c\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}
\NormalTok{               b[}\StringTok{"c\_A\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+}
\NormalTok{               b[}\StringTok{"c\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ L1 }\SpecialCharTok{+}
\NormalTok{               b[}\StringTok{"c\_M\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ M\_diabetes }\SpecialCharTok{+} 
\NormalTok{               b[}\StringTok{"c\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{*}\NormalTok{ M\_diabetes }\SpecialCharTok{*}\NormalTok{ A.M.inter ) }\SpecialCharTok{+} 
    \FunctionTok{rnorm}\NormalTok{(N, }\AttributeTok{mean =} \DecValTok{0}\NormalTok{, }\AttributeTok{sd =}\NormalTok{ b[}\StringTok{"sd\_Y"}\NormalTok{])}
  
  \CommentTok{\# data.frame}
\NormalTok{  data.sim }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(L0\_male, L0\_soc\_env, A0\_PM2}\FloatTok{.5}\NormalTok{, L1, M\_diabetes, }
\NormalTok{                         Y\_death, Y\_qol)}

  \FunctionTok{return}\NormalTok{( data.sim )}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

Applying a sample size N=10000, we generate the \texttt{df1.csv} and \texttt{df1\_int.csv} data sets.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{1234}\NormalTok{)}
\NormalTok{df1 }\OtherTok{\textless{}{-}} \FunctionTok{gen.data.causal.model.1}\NormalTok{(}\AttributeTok{N=}\DecValTok{10000}\NormalTok{, }\AttributeTok{A.M.inter=}\DecValTok{0}\NormalTok{)}
\FunctionTok{write.csv}\NormalTok{(df1, }\AttributeTok{file =} \StringTok{"data/df1.csv"}\NormalTok{, }\AttributeTok{row.names =} \ConstantTok{FALSE}\NormalTok{)}

\FunctionTok{set.seed}\NormalTok{(}\DecValTok{1234}\NormalTok{)}
\NormalTok{df1\_int }\OtherTok{\textless{}{-}} \FunctionTok{gen.data.causal.model.1}\NormalTok{(}\AttributeTok{N=}\DecValTok{10000}\NormalTok{, }\AttributeTok{A.M.inter=}\DecValTok{1}\NormalTok{)}
\FunctionTok{write.csv}\NormalTok{(df1\_int, }\AttributeTok{file =} \StringTok{"data/df1\_int.csv"}\NormalTok{, }\AttributeTok{row.names =} \ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{head}\NormalTok{(df1)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   L0_male L0_soc_env A0_PM2.5 L1 M_diabetes Y_death    Y_qol
## 1       0          1        0  1          0       0 93.41819
## 2       1          1        1  1          0       1 64.03221
## 3       1          1        0  0          0       0 75.56249
## 4       1          0        0  0          0       0 89.77055
## 5       1          1        0  0          0       0 77.22353
## 6       1          1        0  0          1       0 73.87975
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{head}\NormalTok{(df1\_int)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   L0_male L0_soc_env A0_PM2.5 L1 M_diabetes Y_death    Y_qol
## 1       0          1        0  1          0       0 93.41819
## 2       1          1        1  1          0       1 64.03221
## 3       1          1        0  0          0       0 75.56249
## 4       1          0        0  0          0       0 89.77055
## 5       1          1        0  0          0       0 77.22353
## 6       1          1        0  0          1       0 73.87975
\end{verbatim}

\subsection{Data sets generated from the causal model 2}\label{data-sets-generated-from-the-causal-model-2}

The following function \texttt{gen.data.causal.model.2} can be used to simulate data sets using the parameters defined previously in the \texttt{param.causal.model.2} function.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{gen.data.causal.model}\FloatTok{.2} \OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(N, A.M.inter) \{ }\CommentTok{\# input parameters are the }
  \CommentTok{\#   sample size N and the presence of A*M interaction with A.M.inter = 0 or 1}
  
\NormalTok{  b }\OtherTok{\textless{}{-}} \FunctionTok{param.causal.model.2}\NormalTok{(}\AttributeTok{A.M.interaction =}\NormalTok{ A.M.inter)}
    
  \CommentTok{\# baseline confounders: parent\textquotesingle{}s educational level=L0\_soc\_env \& sex=L0\_male}
\NormalTok{  L0\_male }\OtherTok{\textless{}{-}} \FunctionTok{rbinom}\NormalTok{(N, }\AttributeTok{size =} \DecValTok{1}\NormalTok{, }\AttributeTok{prob =}\NormalTok{ b[}\StringTok{"p\_L0\_male"}\NormalTok{]) }
\NormalTok{  L0\_soc\_env }\OtherTok{\textless{}{-}} \FunctionTok{rbinom}\NormalTok{(N, }\AttributeTok{size =} \DecValTok{1}\NormalTok{, }\AttributeTok{prob =}\NormalTok{ b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])  }
  
  \CommentTok{\# exposure: A0\_PM2.5}
\NormalTok{  A0\_PM2}\FloatTok{.5} \OtherTok{\textless{}{-}} \FunctionTok{rbinom}\NormalTok{(N, }\AttributeTok{size =} \DecValTok{1}\NormalTok{, }\AttributeTok{prob =}\NormalTok{  b[}\StringTok{"b\_A"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                     b[}\StringTok{"b\_male\_A"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ L0\_male }\SpecialCharTok{+} 
\NormalTok{                     b[}\StringTok{"b\_soc\_env\_A"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ L0\_soc\_env ) }
  
  \CommentTok{\# intermediate confounder between M\_diabetes and Y, }
\NormalTok{  L1 }\OtherTok{\textless{}{-}} \FunctionTok{rbinom}\NormalTok{(N, }\AttributeTok{size =} \DecValTok{1}\NormalTok{, }\AttributeTok{prob =}\NormalTok{ b[}\StringTok{"b\_L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                 b[}\StringTok{"b\_male\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ L0\_male }\SpecialCharTok{+}
\NormalTok{                 b[}\StringTok{"b\_soc\_env\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+} 
\NormalTok{                 b[}\StringTok{"b\_A\_L1"}\NormalTok{]}\SpecialCharTok{*}\NormalTok{ A0\_PM2}\FloatTok{.5}\NormalTok{)}
  
  \CommentTok{\# mediator: M\_diabetes}
\NormalTok{  M\_diabetes }\OtherTok{\textless{}{-}} \FunctionTok{rbinom}\NormalTok{(N, }\AttributeTok{size =} \DecValTok{1}\NormalTok{, }\AttributeTok{prob =}\NormalTok{ b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                        b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ L0\_male }\SpecialCharTok{+} 
\NormalTok{                        b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+} 
\NormalTok{                        b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+}
\NormalTok{                        b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ L1) }

  \CommentTok{\# Y\_death }
\NormalTok{  Y\_death }\OtherTok{\textless{}{-}} \FunctionTok{rbinom}\NormalTok{(N, }\AttributeTok{size =} \DecValTok{1}\NormalTok{, }\AttributeTok{prob =}\NormalTok{ b[}\StringTok{"b\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                      b[}\StringTok{"b\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ L0\_male }\SpecialCharTok{+} 
\NormalTok{                      b[}\StringTok{"b\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+} 
\NormalTok{                      b[}\StringTok{"b\_A\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+} 
\NormalTok{                      b[}\StringTok{"b\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ L1 }\SpecialCharTok{+}
\NormalTok{                      b[}\StringTok{"b\_M\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ M\_diabetes }\SpecialCharTok{+}
\NormalTok{                      b[}\StringTok{"b\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{*}\NormalTok{ M\_diabetes }\SpecialCharTok{*}\NormalTok{ A.M.inter ) }
  
  \CommentTok{\# Y\_qol }
\NormalTok{  Y\_qol }\OtherTok{\textless{}{-}}\NormalTok{ ( b[}\StringTok{"mu\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{               b[}\StringTok{"c\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ L0\_male }\SpecialCharTok{+} 
\NormalTok{               b[}\StringTok{"c\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ L0\_soc\_env }\SpecialCharTok{+}
\NormalTok{               b[}\StringTok{"c\_A\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{+}
\NormalTok{               b[}\StringTok{"c\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ L1 }\SpecialCharTok{+}
\NormalTok{               b[}\StringTok{"c\_M\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ M\_diabetes }\SpecialCharTok{+} 
\NormalTok{               b[}\StringTok{"c\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ A0\_PM2}\FloatTok{.5} \SpecialCharTok{*}\NormalTok{ M\_diabetes }\SpecialCharTok{*}\NormalTok{ A.M.inter ) }\SpecialCharTok{+} 
    \FunctionTok{rnorm}\NormalTok{(N, }\AttributeTok{mean =} \DecValTok{0}\NormalTok{, }\AttributeTok{sd =}\NormalTok{ b[}\StringTok{"sd\_Y"}\NormalTok{])}
  
  \CommentTok{\# data.frame}
\NormalTok{  data.sim }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(L0\_male, L0\_soc\_env, A0\_PM2}\FloatTok{.5}\NormalTok{, L1, M\_diabetes, }
\NormalTok{                         Y\_death, Y\_qol)}

  \FunctionTok{return}\NormalTok{( data.sim )}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

Applying a sample size N=10000, we generate the \texttt{df2.csv} and \texttt{df2\_int.csv} data sets.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{1234}\NormalTok{)}
\NormalTok{df2 }\OtherTok{\textless{}{-}} \FunctionTok{gen.data.causal.model.2}\NormalTok{(}\AttributeTok{N=}\DecValTok{10000}\NormalTok{, }\AttributeTok{A.M.inter=}\DecValTok{0}\NormalTok{)}
\FunctionTok{write.csv}\NormalTok{(df2, }\AttributeTok{file =} \StringTok{"data/df2.csv"}\NormalTok{, }\AttributeTok{row.names =} \ConstantTok{FALSE}\NormalTok{)}

\FunctionTok{set.seed}\NormalTok{(}\DecValTok{1234}\NormalTok{)}
\NormalTok{df2\_int }\OtherTok{\textless{}{-}} \FunctionTok{gen.data.causal.model.2}\NormalTok{(}\AttributeTok{N=}\DecValTok{10000}\NormalTok{, }\AttributeTok{A.M.inter=}\DecValTok{1}\NormalTok{)}
\FunctionTok{write.csv}\NormalTok{(df2\_int, }\AttributeTok{file =} \StringTok{"data/df2\_int.csv"}\NormalTok{, }\AttributeTok{row.names =} \ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{tail}\NormalTok{(df2)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##       L0_male L0_soc_env A0_PM2.5 L1 M_diabetes Y_death    Y_qol
## 9995        0          1        0  1          1       0 53.25115
## 9996        0          1        0  0          1       0 66.36484
## 9997        0          1        1  1          1       0 74.20579
## 9998        1          1        0  0          1       0 41.30248
## 9999        0          0        0  1          0       0 85.60169
## 10000       1          1        0  0          0       0 61.56969
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{tail}\NormalTok{(df2\_int)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##       L0_male L0_soc_env A0_PM2.5 L1 M_diabetes Y_death    Y_qol
## 9995        0          1        0  1          1       0 53.25115
## 9996        0          1        0  0          1       0 66.36484
## 9997        0          1        1  1          1       0 69.20579
## 9998        1          1        0  0          1       0 41.30248
## 9999        0          0        0  1          0       0 85.60169
## 10000       1          1        0  0          0       0 61.56969
\end{verbatim}

\chapter{Appendix B: Calculation of the true causal quantities}\label{appendix_b}

\section{True causal quantities without mediator-ouctome confounder affected by the exposure}\label{true-causal-quantities-without-mediator-ouctome-confounder-affected-by-the-exposure}

\subsection{Average total effects (ATE)}\label{average-total-effects-ate}

The following function \texttt{true.ATE1} can be used to run the calculation for the average total effects (ATE).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{true.ATE1 }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(}\AttributeTok{interaction =} \ConstantTok{NULL}\NormalTok{) \{}
\NormalTok{  b }\OtherTok{\textless{}{-}} \FunctionTok{param.causal.model.1}\NormalTok{(}\AttributeTok{A.M.interaction =}\NormalTok{ interaction)}
  
  \CommentTok{\# binary outcome (death)}
\NormalTok{  S }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(}\FunctionTok{expand.grid}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{)), }\FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{,}\AttributeTok{n=}\DecValTok{2}\SpecialCharTok{\^{}}\DecValTok{4}\NormalTok{))}
  \FunctionTok{colnames}\NormalTok{(S) }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\StringTok{"male"}\NormalTok{,}\StringTok{"soc\_env"}\NormalTok{,}\StringTok{"L1"}\NormalTok{,}\StringTok{"M"}\NormalTok{,}\StringTok{"sum"}\NormalTok{)}
  \ControlFlowTok{for}\NormalTok{ (n }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{16}\NormalTok{) \{}
\NormalTok{    S[n,}\StringTok{"sum"}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ ( ( ( b[}\StringTok{"b\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                      b[}\StringTok{"b\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                      b[}\StringTok{"b\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                      b[}\StringTok{"b\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+} 
\NormalTok{                      b[}\StringTok{"b\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                      b[}\StringTok{"b\_M\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                      b[}\StringTok{"b\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{*}
\NormalTok{                    (( b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                           b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                           b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                           b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                           b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{ )}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{                    (( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ (b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                              b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                              b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                              b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                              b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{) )}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] )) ) }\SpecialCharTok{{-}} 
\NormalTok{                    ( ( b[}\StringTok{"b\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                          b[}\StringTok{"b\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                          b[}\StringTok{"b\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                          b[}\StringTok{"b\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+} 
\NormalTok{                          b[}\StringTok{"b\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                          b[}\StringTok{"b\_M\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                          b[}\StringTok{"b\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{*}
\NormalTok{                        (( b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{ )}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{                        (( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ (b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                  b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                  b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                  b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                                  b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{) )}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] )) ) ) }\SpecialCharTok{*}
\NormalTok{    ((b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{    ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{    ((b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{    ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{    ((b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{    ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{])) }
\NormalTok{\}}

\NormalTok{ATE.death }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(S[,}\StringTok{"sum"}\NormalTok{])}


\CommentTok{\# quantitative outcome (QoL)}
\NormalTok{S }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(}\FunctionTok{expand.grid}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{)), }\FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{,}\AttributeTok{n=}\DecValTok{2}\SpecialCharTok{\^{}}\DecValTok{4}\NormalTok{))}
\FunctionTok{colnames}\NormalTok{(S) }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\StringTok{"male"}\NormalTok{,}\StringTok{"soc\_env"}\NormalTok{,}\StringTok{"L1"}\NormalTok{,}\StringTok{"M"}\NormalTok{,}\StringTok{"sum"}\NormalTok{)}
\ControlFlowTok{for}\NormalTok{ (n }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{16}\NormalTok{) \{}
\NormalTok{  S[n,}\StringTok{"sum"}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ ( ( ( b[}\StringTok{"mu\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                        b[}\StringTok{"c\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                        b[}\StringTok{"c\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                        b[}\StringTok{"c\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+}
\NormalTok{                        b[}\StringTok{"c\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                        b[}\StringTok{"c\_M\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                        b[}\StringTok{"c\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{*}
\NormalTok{                      (( b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                           b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                           b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                           b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                           b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{ )}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{                      (( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ (b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                                b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{) )}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] )) ) }\SpecialCharTok{{-}} 
\NormalTok{                    ( ( b[}\StringTok{"mu\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                          b[}\StringTok{"c\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                          b[}\StringTok{"c\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                          b[}\StringTok{"c\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+}
\NormalTok{                          b[}\StringTok{"c\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                          b[}\StringTok{"c\_M\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                          b[}\StringTok{"c\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{*}
\NormalTok{                        (( b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{ )}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{                        (( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ (b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                  b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                  b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                  b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                                  b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{) )}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] )) ) ) }\SpecialCharTok{*}
\NormalTok{    ((b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{    ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{    ((b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{    ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{    ((b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{    ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{])) }
\NormalTok{\}}

\NormalTok{ATE.qol }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(S[,}\StringTok{"sum"}\NormalTok{])}

\FunctionTok{return}\NormalTok{(}\FunctionTok{list}\NormalTok{(}\AttributeTok{ATE.death =}\NormalTok{ ATE.death, }\AttributeTok{ATE.qol =}\NormalTok{ ATE.qol))}
  
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{true.ATE1.no.inter }\OtherTok{\textless{}{-}} \FunctionTok{true.ATE1}\NormalTok{(}\AttributeTok{interaction =} \DecValTok{0}\NormalTok{)}

\NormalTok{true.ATE1.with.inter }\OtherTok{\textless{}{-}} \FunctionTok{true.ATE1}\NormalTok{(}\AttributeTok{interaction =} \DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

The average total effects \(\text{ATE} = \mathbb{E}(Y_1) - \mathbb{E}(Y_0)\) are:

\begin{itemize}
\tightlist
\item
  0.058 for death and -4.9 for quality of life without interaction;
\item
  0.06955 for death and -6.825 for quality of life with interaction.
\end{itemize}

\subsection{Controlled direct effects (CDE)}\label{controlled-direct-effects-cde}

The following function \texttt{true.CDE1} can be used to run the calculation for controlled direct effects (CDE).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{true.CDE1 }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(}\AttributeTok{interaction =} \ConstantTok{NULL}\NormalTok{) \{}
\NormalTok{  b }\OtherTok{\textless{}{-}} \FunctionTok{param.causal.model.1}\NormalTok{(}\AttributeTok{A.M.interaction =}\NormalTok{ interaction)}
  
  \CommentTok{\# binary outcome (death)}
  \CommentTok{\# we estimate both CDE, fixing do(M) = 0 et do(M) = 1 and }
  \CommentTok{\# using the corresponding lines in the S matrix}
\NormalTok{  S }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(}\FunctionTok{expand.grid}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{)), }\FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{,}\AttributeTok{n=}\DecValTok{2}\SpecialCharTok{\^{}}\DecValTok{3}\NormalTok{))}
  \FunctionTok{colnames}\NormalTok{(S) }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\StringTok{"male"}\NormalTok{,}\StringTok{"soc\_env"}\NormalTok{,}\StringTok{"L1"}\NormalTok{,}\StringTok{"M"}\NormalTok{,}\StringTok{"sum"}\NormalTok{)}
  \ControlFlowTok{for}\NormalTok{ (n }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{16}\NormalTok{) \{}
\NormalTok{    S[n,}\StringTok{"sum"}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ ( ( b[}\StringTok{"b\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                        b[}\StringTok{"b\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                        b[}\StringTok{"b\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                        b[}\StringTok{"b\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+} 
\NormalTok{                        b[}\StringTok{"b\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                        b[}\StringTok{"b\_M\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                        b[}\StringTok{"b\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{{-}} 
\NormalTok{                      ( b[}\StringTok{"b\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                          b[}\StringTok{"b\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                          b[}\StringTok{"b\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                          b[}\StringTok{"b\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+} 
\NormalTok{                          b[}\StringTok{"b\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                          b[}\StringTok{"b\_M\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                          b[}\StringTok{"b\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) ) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{])) }
\NormalTok{    \}}
  
\NormalTok{  CDE.M0.death }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(S[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{8}\NormalTok{,}\StringTok{"sum"}\NormalTok{])}
\NormalTok{  CDE.M1.death }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(S[}\DecValTok{9}\SpecialCharTok{:}\DecValTok{16}\NormalTok{,}\StringTok{"sum"}\NormalTok{])}
  
  \CommentTok{\# quantitative outcome (QoL)}
  \CommentTok{\# we estimate both CDE, fixing do(M) = 0 et do(M) = 1 and using }
  \CommentTok{\# the corresponding lines in the S matrix}
  \ControlFlowTok{for}\NormalTok{ (n }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{16}\NormalTok{) \{}
\NormalTok{    S[n,}\StringTok{"sum"}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ ( ( b[}\StringTok{"mu\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                        b[}\StringTok{"c\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                        b[}\StringTok{"c\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                        b[}\StringTok{"c\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+} 
\NormalTok{                        b[}\StringTok{"c\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                        b[}\StringTok{"c\_M\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                        b[}\StringTok{"c\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{{-}} 
\NormalTok{                      ( b[}\StringTok{"mu\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                          b[}\StringTok{"c\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                          b[}\StringTok{"c\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                          b[}\StringTok{"c\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+} 
\NormalTok{                          b[}\StringTok{"c\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                          b[}\StringTok{"c\_M\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                          b[}\StringTok{"c\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) ) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{])) }
\NormalTok{    \}}
  
\NormalTok{  CDE.M0.qol }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(S[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{8}\NormalTok{,}\StringTok{"sum"}\NormalTok{])}
\NormalTok{  CDE.M1.qol }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(S[}\DecValTok{9}\SpecialCharTok{:}\DecValTok{16}\NormalTok{,}\StringTok{"sum"}\NormalTok{])}
  
  \FunctionTok{return}\NormalTok{(}\FunctionTok{list}\NormalTok{(}\AttributeTok{CDE.M0.death =}\NormalTok{ CDE.M0.death, }\AttributeTok{CDE.M1.death =}\NormalTok{ CDE.M1.death, }
              \AttributeTok{CDE.M0.qol =}\NormalTok{ CDE.M0.qol, }\AttributeTok{CDE.M1.qol =}\NormalTok{ CDE.M1.qol))}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{true.CDE1.no.inter }\OtherTok{\textless{}{-}} \FunctionTok{true.CDE1}\NormalTok{(}\AttributeTok{interaction =} \DecValTok{0}\NormalTok{)}

\NormalTok{true.CDE1.with.inter }\OtherTok{\textless{}{-}} \FunctionTok{true.CDE1}\NormalTok{(}\AttributeTok{interaction =} \DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Setting \(do(M=0)\), the controlled direct effects \(\text{CDE}_{M=0} = \mathbb{E}\left(Y_{1,0} \right) - \mathbb{E}\left(Y_{0,0} \right)\) are:

\begin{itemize}
\tightlist
\item
  0.05 for death and -4 for quality of life without interaction,
\item
  0.05 for death and -4 for quality of life with interaction.
\end{itemize}

Setting \(do(M=1)\), the controlled direct effects \(\text{CDE}_{M=1} = \mathbb{E}\left(Y_{1,1} \right) - \mathbb{E}\left(Y_{0,1} \right)\) are:

\begin{itemize}
\tightlist
\item
  0.05 for death and -4 for quality of life without interaction,
\item
  0.08 for death and -9 for quality of life with interaction.
\end{itemize}

\subsection{Pure natural direct effect and Total natural indirect effect}\label{pure-natural-direct-effect-and-total-natural-indirect-effect}

The following function \texttt{true.PNDE.TNIE1} can be used to run the calculation for pure natural direct effects (PNDE) and total natural indirect effects (TNIE).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{true.PNDE.TNIE1 }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(}\AttributeTok{interaction =} \ConstantTok{NULL}\NormalTok{) \{}
\NormalTok{  b }\OtherTok{\textless{}{-}} \FunctionTok{param.causal.model.1}\NormalTok{(}\AttributeTok{A.M.interaction =}\NormalTok{ interaction)}
  
  \CommentTok{\# binary outcome (death)}
\NormalTok{  S }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(}\FunctionTok{expand.grid}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{)), }\FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{,}\AttributeTok{n=}\DecValTok{2}\SpecialCharTok{\^{}}\DecValTok{4}\NormalTok{), }\FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{,}\AttributeTok{n=}\DecValTok{2}\SpecialCharTok{\^{}}\DecValTok{4}\NormalTok{))}
  \FunctionTok{colnames}\NormalTok{(S) }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\StringTok{"male"}\NormalTok{,}\StringTok{"soc\_env"}\NormalTok{,}\StringTok{"L1"}\NormalTok{,}\StringTok{"M"}\NormalTok{,}\StringTok{"sum.pnde"}\NormalTok{, }\StringTok{"sum.tnie"}\NormalTok{)}
  \ControlFlowTok{for}\NormalTok{ (n }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{16}\NormalTok{) \{}
    \CommentTok{\# PNDE }
\NormalTok{    S[n,}\StringTok{"sum.pnde"}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ ( ( b[}\StringTok{"b\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"b\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"b\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"b\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"b\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"b\_M\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"b\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{{-}} 
\NormalTok{                           ( b[}\StringTok{"b\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                               b[}\StringTok{"b\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                               b[}\StringTok{"b\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                               b[}\StringTok{"b\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+} 
\NormalTok{                               b[}\StringTok{"b\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                               b[}\StringTok{"b\_M\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                               b[}\StringTok{"b\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) ) }\SpecialCharTok{*}
\NormalTok{      (( b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{           b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{           b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{           b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{           b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{ )}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*} 
\NormalTok{      (( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ (b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{) )}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] ))  }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{])) }
    
    \CommentTok{\# TNIE }
\NormalTok{    S[n,}\StringTok{"sum.tnie"}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ ( b[}\StringTok{"b\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                           b[}\StringTok{"b\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                           b[}\StringTok{"b\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                           b[}\StringTok{"b\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+} 
\NormalTok{                           b[}\StringTok{"b\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                           b[}\StringTok{"b\_M\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                           b[}\StringTok{"b\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{*}
\NormalTok{      ( (( b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{             b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{             b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{             b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{             b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{ )}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{+}
\NormalTok{          (( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ (b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                    b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                    b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                    b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                    b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{) )}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{{-}}
\NormalTok{          (( b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{               b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{               b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{               b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{               b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{ )}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{{-}} 
\NormalTok{          (( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ (b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                    b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                    b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                    b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                    b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{) )}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] )) ) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{])) }
\NormalTok{    \}}
  
\NormalTok{  PNDE.death }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(S[,}\StringTok{"sum.pnde"}\NormalTok{])}
\NormalTok{  TNIE.death }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(S[,}\StringTok{"sum.tnie"}\NormalTok{])}
  
  
  \CommentTok{\# quantitative outcome (QoL)}
\NormalTok{  S }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(}\FunctionTok{expand.grid}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{)), }\FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{,}\AttributeTok{n=}\DecValTok{2}\SpecialCharTok{\^{}}\DecValTok{4}\NormalTok{), }\FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{,}\AttributeTok{n=}\DecValTok{2}\SpecialCharTok{\^{}}\DecValTok{4}\NormalTok{))}
  \FunctionTok{colnames}\NormalTok{(S) }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\StringTok{"male"}\NormalTok{,}\StringTok{"soc\_env"}\NormalTok{,}\StringTok{"L1"}\NormalTok{,}\StringTok{"M"}\NormalTok{,}\StringTok{"sum.pnde"}\NormalTok{, }\StringTok{"sum.tnie"}\NormalTok{)}
  \ControlFlowTok{for}\NormalTok{ (n }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{16}\NormalTok{) \{}
    \CommentTok{\# PNDE }
\NormalTok{    S[n,}\StringTok{"sum.pnde"}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ ( ( b[}\StringTok{"mu\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"c\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"c\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"c\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"c\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"c\_M\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"c\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{{-}} 
\NormalTok{                           ( b[}\StringTok{"mu\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                               b[}\StringTok{"c\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                               b[}\StringTok{"c\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                               b[}\StringTok{"c\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+} 
\NormalTok{                               b[}\StringTok{"c\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                               b[}\StringTok{"c\_M\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                               b[}\StringTok{"c\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) ) }\SpecialCharTok{*}
\NormalTok{      (( b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{           b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{           b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{           b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{           b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{ )}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*} 
\NormalTok{      (( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ (b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{) )}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] ))  }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{])) }
    
    \CommentTok{\# TNIE }
\NormalTok{    S[n,}\StringTok{"sum.tnie"}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ ( b[}\StringTok{"mu\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                           b[}\StringTok{"c\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                           b[}\StringTok{"c\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                           b[}\StringTok{"c\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+} 
\NormalTok{                           b[}\StringTok{"c\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                           b[}\StringTok{"c\_M\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                           b[}\StringTok{"c\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{*}
\NormalTok{      ( (( b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{             b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{             b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{             b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{             b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{ )}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{+}
\NormalTok{          (( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ (b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                    b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                    b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                    b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                    b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{) )}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{{-}}
\NormalTok{          (( b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{               b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{               b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{               b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{               b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{ )}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{{-}} 
\NormalTok{          (( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ (b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                    b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                    b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                    b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                    b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{) )}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] )) ) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{])) }
\NormalTok{    \}}
  
\NormalTok{  PNDE.qol }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(S[,}\StringTok{"sum.pnde"}\NormalTok{])}
\NormalTok{  TNIE.qol }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(S[,}\StringTok{"sum.tnie"}\NormalTok{])}
  
  \FunctionTok{return}\NormalTok{(}\FunctionTok{list}\NormalTok{(}\AttributeTok{PNDE.death =}\NormalTok{ PNDE.death, }\AttributeTok{TNIE.death =}\NormalTok{ TNIE.death, }
              \AttributeTok{PNDE.qol =}\NormalTok{ PNDE.qol, }\AttributeTok{TNIE.qol =}\NormalTok{ TNIE.qol))}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{true.PNDE.TNIE.no.inter }\OtherTok{\textless{}{-}} \FunctionTok{true.PNDE.TNIE1}\NormalTok{(}\AttributeTok{interaction =} \DecValTok{0}\NormalTok{)}

\NormalTok{true.PNDE.TNIE.with.inter }\OtherTok{\textless{}{-}} \FunctionTok{true.PNDE.TNIE1}\NormalTok{(}\AttributeTok{interaction =} \DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

The \(\text{PNDE}=\mathbb{E}\left( Y_{1,M_0}\right) - \mathbb{E}\left(Y_{0,M_0}\right)\) and \(\text{TNIE}=\mathbb{E}\left( Y_{1,M_1}\right) - \mathbb{E}\left(Y_{1,M_0}\right)\) are respectively:

\begin{itemize}
\tightlist
\item
  0.05 and 0.00800000000000001 for death without interaction,
\item
  0.05855 and 0.011 for death with interaction,
\item
  -4 and -0.9 for quality of life without interaction,
\item
  -5.425 and -1.4 for quality of life with interaction.
\end{itemize}

\subsection{Total natural direct effect and Pure natural indirect effect}\label{total-natural-direct-effect-and-pure-natural-indirect-effect}

The following function \texttt{true.TNDE.PNIE1} can be used to run the calculation for total natural direct effects (TNDE) and pure natural indirect effects (PNIE).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{true.TNDE.PNIE1 }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(}\AttributeTok{interaction =} \ConstantTok{NULL}\NormalTok{) \{}
\NormalTok{  b }\OtherTok{\textless{}{-}} \FunctionTok{param.causal.model.1}\NormalTok{(}\AttributeTok{A.M.interaction =}\NormalTok{ interaction)}
  
  \CommentTok{\# binary outcome (death)}
\NormalTok{  S }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(}\FunctionTok{expand.grid}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{)), }\FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{,}\AttributeTok{n=}\DecValTok{2}\SpecialCharTok{\^{}}\DecValTok{4}\NormalTok{), }\FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{,}\AttributeTok{n=}\DecValTok{2}\SpecialCharTok{\^{}}\DecValTok{4}\NormalTok{))}
  \FunctionTok{colnames}\NormalTok{(S) }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\StringTok{"male"}\NormalTok{,}\StringTok{"soc\_env"}\NormalTok{,}\StringTok{"L1"}\NormalTok{,}\StringTok{"M"}\NormalTok{,}\StringTok{"sum.tnde"}\NormalTok{, }\StringTok{"sum.pnie"}\NormalTok{)}
  
  \ControlFlowTok{for}\NormalTok{ (n }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{16}\NormalTok{) \{}
    \CommentTok{\# TNDE }
\NormalTok{    S[n,}\StringTok{"sum.tnde"}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ ( ( b[}\StringTok{"b\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"b\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"b\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"b\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"b\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"b\_M\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"b\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{{-}} 
\NormalTok{                           ( b[}\StringTok{"b\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                               b[}\StringTok{"b\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                               b[}\StringTok{"b\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                               b[}\StringTok{"b\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+} 
\NormalTok{                               b[}\StringTok{"b\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                               b[}\StringTok{"b\_M\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                               b[}\StringTok{"b\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) ) }\SpecialCharTok{*}
\NormalTok{      (( b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{           b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{           b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{           b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{           b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{ )}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*} 
\NormalTok{      (( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ (b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{) )}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] ))  }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{])) }
    
    \CommentTok{\# PNIE }
\NormalTok{    S[n,}\StringTok{"sum.pnie"}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ ( b[}\StringTok{"b\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                           b[}\StringTok{"b\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                           b[}\StringTok{"b\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                           b[}\StringTok{"b\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+} 
\NormalTok{                           b[}\StringTok{"b\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                           b[}\StringTok{"b\_M\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                           b[}\StringTok{"b\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{*}
\NormalTok{      ( (( b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{             b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{             b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{             b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{             b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{ )}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{+}
\NormalTok{          (( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ (b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                    b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                    b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                    b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                    b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{) )}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{{-}}
\NormalTok{          (( b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{               b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{               b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{               b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{               b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{ )}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{{-}} 
\NormalTok{          (( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ (b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                    b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                    b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                    b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                    b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{) )}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] )) ) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{])) }
\NormalTok{    \}}
  
\NormalTok{  TNDE.death }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(S[,}\StringTok{"sum.tnde"}\NormalTok{])}
\NormalTok{  PNIE.death }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(S[,}\StringTok{"sum.pnie"}\NormalTok{])}
  
  \CommentTok{\# quantitative outcome (QoL)}
\NormalTok{  S }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(}\FunctionTok{expand.grid}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{)), }\FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{,}\AttributeTok{n=}\DecValTok{2}\SpecialCharTok{\^{}}\DecValTok{4}\NormalTok{), }\FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{,}\AttributeTok{n=}\DecValTok{2}\SpecialCharTok{\^{}}\DecValTok{4}\NormalTok{))}
  \FunctionTok{colnames}\NormalTok{(S) }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\StringTok{"male"}\NormalTok{,}\StringTok{"soc\_env"}\NormalTok{,}\StringTok{"L1"}\NormalTok{,}\StringTok{"M"}\NormalTok{,}\StringTok{"sum.tnde"}\NormalTok{, }\StringTok{"sum.pnie"}\NormalTok{)}
  \ControlFlowTok{for}\NormalTok{ (n }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{16}\NormalTok{) \{}
    \CommentTok{\# TNDE }
\NormalTok{    S[n,}\StringTok{"sum.tnde"}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ ( ( b[}\StringTok{"mu\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"c\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"c\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"c\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"c\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"c\_M\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"c\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{{-}} 
\NormalTok{                           ( b[}\StringTok{"mu\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                               b[}\StringTok{"c\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                               b[}\StringTok{"c\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                               b[}\StringTok{"c\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+} 
\NormalTok{                               b[}\StringTok{"c\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                               b[}\StringTok{"c\_M\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                               b[}\StringTok{"c\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) ) }\SpecialCharTok{*}
\NormalTok{      (( b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{           b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{           b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{           b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{           b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{ )}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*} 
\NormalTok{      (( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ (b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{) )}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] ))  }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{])) }
    
    \CommentTok{\# PNIE }
\NormalTok{    S[n,}\StringTok{"sum.pnie"}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ ( b[}\StringTok{"mu\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                           b[}\StringTok{"c\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                           b[}\StringTok{"c\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                           b[}\StringTok{"c\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+} 
\NormalTok{                           b[}\StringTok{"c\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                           b[}\StringTok{"c\_M\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                           b[}\StringTok{"c\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{*}
\NormalTok{      ( (( b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{             b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{             b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{             b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{             b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{ )}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{+}
\NormalTok{          (( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ (b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                    b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                    b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                    b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                    b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{) )}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{{-}}
\NormalTok{          (( b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{               b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{               b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{               b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{               b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{ )}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{{-}} 
\NormalTok{          (( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ (b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                    b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                    b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                    b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                    b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{) )}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] )) ) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{])) }
\NormalTok{    \}}
  
\NormalTok{  TNDE.qol }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(S[,}\StringTok{"sum.tnde"}\NormalTok{])}
\NormalTok{  PNIE.qol }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(S[,}\StringTok{"sum.pnie"}\NormalTok{])}
   
  \FunctionTok{return}\NormalTok{(}\FunctionTok{list}\NormalTok{(}\AttributeTok{TNDE.death =}\NormalTok{ TNDE.death, }\AttributeTok{PNIE.death =}\NormalTok{ PNIE.death, }
              \AttributeTok{TNDE.qol =}\NormalTok{ TNDE.qol, }\AttributeTok{PNIE.qol =}\NormalTok{ PNIE.qol))}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{true.TNDE.PNIE.no.inter }\OtherTok{\textless{}{-}} \FunctionTok{true.TNDE.PNIE1}\NormalTok{(}\AttributeTok{interaction =} \DecValTok{0}\NormalTok{)}

\NormalTok{true.TNDE.PNIE.with.inter }\OtherTok{\textless{}{-}} \FunctionTok{true.TNDE.PNIE1}\NormalTok{(}\AttributeTok{interaction =} \DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

The \(\text{TNDE}=\mathbb{E}\left( Y_{1,M_1}\right) - \mathbb{E}\left(Y_{0,M_1}\right)\) and \(\text{PNIE}=\mathbb{E}\left( Y_{0,M_1}\right) - \mathbb{E}\left(Y_{0,M_0}\right)\) are respectively:

\begin{itemize}
\tightlist
\item
  0.05 and 0.00800000000000001 for death without interaction,
\item
  0.06155 and 0.00800000000000001 for death with interaction,
\item
  -4 and -0.899999999999999 for quality of life without interaction,
\item
  -5.925 and -0.899999999999999 for quality of life with interaction.
\end{itemize}

\subsection{Vanderweele's 3-way decomposition}\label{vanderweeles-3-way-decomposition}

The following function \texttt{true.3way.decomp} can be used to run the calculation for the 3-way decomposition of the total effect into a ``pure natural direct effect'' (PNDE), a ``pure natural indirect effect'' (PNIE) and a ``mediated interactive effect'' (MIE).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{true}\FloatTok{.3}\NormalTok{way.decomp }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(}\AttributeTok{interaction =} \ConstantTok{NULL}\NormalTok{) \{}
\NormalTok{  b }\OtherTok{\textless{}{-}} \FunctionTok{param.causal.model.1}\NormalTok{(}\AttributeTok{A.M.interaction =}\NormalTok{ interaction)}
  
  \CommentTok{\# binary outcome (death)}
\NormalTok{  S }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(}\FunctionTok{expand.grid}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{)), }\FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{,}\AttributeTok{n=}\DecValTok{2}\SpecialCharTok{\^{}}\DecValTok{4}\NormalTok{), }\FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{,}\AttributeTok{n=}\DecValTok{2}\SpecialCharTok{\^{}}\DecValTok{4}\NormalTok{))}
  \FunctionTok{colnames}\NormalTok{(S) }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\StringTok{"male"}\NormalTok{,}\StringTok{"soc\_env"}\NormalTok{,}\StringTok{"L1"}\NormalTok{,}\StringTok{"M"}\NormalTok{,}\StringTok{"sum.pde"}\NormalTok{, }\StringTok{"sum.pie"}\NormalTok{)}
  \ControlFlowTok{for}\NormalTok{ (n }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{16}\NormalTok{) \{}
    \CommentTok{\# PDE }
\NormalTok{    S[n,}\StringTok{"sum.pde"}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ ( ( b[}\StringTok{"b\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                            b[}\StringTok{"b\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                            b[}\StringTok{"b\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                            b[}\StringTok{"b\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+} 
\NormalTok{                            b[}\StringTok{"b\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                            b[}\StringTok{"b\_M\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                            b[}\StringTok{"b\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{{-}} 
\NormalTok{                          ( b[}\StringTok{"b\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                              b[}\StringTok{"b\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                              b[}\StringTok{"b\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                              b[}\StringTok{"b\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+} 
\NormalTok{                              b[}\StringTok{"b\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                              b[}\StringTok{"b\_M\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                              b[}\StringTok{"b\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) ) }\SpecialCharTok{*}
\NormalTok{    (( b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{         b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{         b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{         b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{         b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{ )}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*} 
\NormalTok{    (( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ (b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{              b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{              b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{              b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{              b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{) )}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] ))  }\SpecialCharTok{*}
\NormalTok{    ((b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{    ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{    ((b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{    ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{    ((b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{    ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{])) }
    
    \CommentTok{\# PIE }
\NormalTok{    S[n,}\StringTok{"sum.pie"}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ ( b[}\StringTok{"b\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                          b[}\StringTok{"b\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                          b[}\StringTok{"b\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                          b[}\StringTok{"b\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+} 
\NormalTok{                          b[}\StringTok{"b\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                          b[}\StringTok{"b\_M\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                          b[}\StringTok{"b\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{*}
\NormalTok{      ( (( b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{             b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{             b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{             b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{             b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{ )}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{+}
\NormalTok{          (( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ (b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                    b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                    b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                    b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                    b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{) )}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{{-}}
\NormalTok{          (( b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{               b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{               b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{               b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{               b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{ )}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{{-}} 
\NormalTok{          (( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ (b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                    b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                    b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                    b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                    b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{) )}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] )) ) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{])) }
\NormalTok{    \}}
  
  \CommentTok{\# MI }
\NormalTok{  S.MI }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(}\FunctionTok{expand.grid}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{)), }\FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{,}\AttributeTok{n=}\DecValTok{2}\SpecialCharTok{\^{}}\DecValTok{4}\NormalTok{))}
  \FunctionTok{colnames}\NormalTok{(S.MI) }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\StringTok{"male"}\NormalTok{,}\StringTok{"soc\_env"}\NormalTok{,}\StringTok{"L1"}\NormalTok{, }\StringTok{"sum.mi"}\NormalTok{)}
  \ControlFlowTok{for}\NormalTok{ (n }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{8}\NormalTok{) \{}
\NormalTok{    S.MI[n,}\StringTok{"sum.mi"}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ ( ( b[}\StringTok{"b\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                              b[}\StringTok{"b\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S.MI[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                              b[}\StringTok{"b\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S.MI[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                              b[}\StringTok{"b\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+} 
\NormalTok{                              b[}\StringTok{"b\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S.MI[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                              b[}\StringTok{"b\_M\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+}
\NormalTok{                              b[}\StringTok{"b\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{{-}} 
\NormalTok{                            ( b[}\StringTok{"b\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                b[}\StringTok{"b\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S.MI[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                b[}\StringTok{"b\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S.MI[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                b[}\StringTok{"b\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+} 
\NormalTok{                                b[}\StringTok{"b\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S.MI[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                                b[}\StringTok{"b\_M\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+}
\NormalTok{                                b[}\StringTok{"b\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{{-}} 
\NormalTok{                            ( b[}\StringTok{"b\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                b[}\StringTok{"b\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S.MI[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                b[}\StringTok{"b\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S.MI[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                b[}\StringTok{"b\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+} 
\NormalTok{                                b[}\StringTok{"b\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S.MI[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                                b[}\StringTok{"b\_M\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+}
\NormalTok{                                b[}\StringTok{"b\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{+} 
\NormalTok{                            ( b[}\StringTok{"b\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                b[}\StringTok{"b\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S.MI[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                b[}\StringTok{"b\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S.MI[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                b[}\StringTok{"b\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+} 
\NormalTok{                                b[}\StringTok{"b\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S.MI[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                                b[}\StringTok{"b\_M\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+}
\NormalTok{                                b[}\StringTok{"b\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      ( ( b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{            b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S.MI[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{            b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S.MI[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{            b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{            b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{ ) }\SpecialCharTok{{-}} 
\NormalTok{          ( b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{              b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S.MI[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{              b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S.MI[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{              b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{              b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{ )) }\SpecialCharTok{*} 
\NormalTok{      ((b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S.MI[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S.MI[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S.MI[n,}\StringTok{"soc\_env"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S.MI[n,}\StringTok{"soc\_env"}\NormalTok{])) }
\NormalTok{    \}}
  
\NormalTok{  PDE.death }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(S[,}\StringTok{"sum.pde"}\NormalTok{])}
\NormalTok{  PIE.death }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(S[,}\StringTok{"sum.pie"}\NormalTok{])}
\NormalTok{  MI.death }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(S.MI[,}\StringTok{"sum.mi"}\NormalTok{])}
  
  
  \CommentTok{\# quantitative outcome (QoL)}
\NormalTok{  S }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(}\FunctionTok{expand.grid}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{)), }\FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{,}\AttributeTok{n=}\DecValTok{2}\SpecialCharTok{\^{}}\DecValTok{4}\NormalTok{), }\FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{,}\AttributeTok{n=}\DecValTok{2}\SpecialCharTok{\^{}}\DecValTok{4}\NormalTok{))}
  \FunctionTok{colnames}\NormalTok{(S) }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\StringTok{"male"}\NormalTok{,}\StringTok{"soc\_env"}\NormalTok{,}\StringTok{"L1"}\NormalTok{,}\StringTok{"M"}\NormalTok{,}\StringTok{"sum.pde"}\NormalTok{, }\StringTok{"sum.pie"}\NormalTok{)}
  \ControlFlowTok{for}\NormalTok{ (n }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{16}\NormalTok{) \{}
    \CommentTok{\# PDE }
\NormalTok{    S[n,}\StringTok{"sum.pde"}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ ( ( b[}\StringTok{"mu\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                            b[}\StringTok{"c\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                            b[}\StringTok{"c\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                            b[}\StringTok{"c\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+} 
\NormalTok{                            b[}\StringTok{"c\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                            b[}\StringTok{"c\_M\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                            b[}\StringTok{"c\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{{-}} 
\NormalTok{                          ( b[}\StringTok{"mu\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                              b[}\StringTok{"c\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                              b[}\StringTok{"c\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                              b[}\StringTok{"c\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+} 
\NormalTok{                              b[}\StringTok{"c\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                              b[}\StringTok{"c\_M\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                              b[}\StringTok{"c\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) ) }\SpecialCharTok{*}
\NormalTok{      (( b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{           b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{           b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{           b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{           b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{ )}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*} 
\NormalTok{      (( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ (b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{) )}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] ))  }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{])) }
    
    \CommentTok{\# PIE }
\NormalTok{    S[n,}\StringTok{"sum.pie"}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ ( b[}\StringTok{"mu\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                          b[}\StringTok{"c\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                          b[}\StringTok{"c\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                          b[}\StringTok{"c\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+} 
\NormalTok{                          b[}\StringTok{"c\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                          b[}\StringTok{"c\_M\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                          b[}\StringTok{"c\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{*}
\NormalTok{      ( (( b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{             b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{             b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{             b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{             b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{ )}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{+}
\NormalTok{          (( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ (b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                    b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                    b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                    b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                    b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{) )}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{{-}}
\NormalTok{          (( b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{               b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{               b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{               b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{               b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{ )}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{{-}} 
\NormalTok{          (( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ (b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                    b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                    b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                    b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                    b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{) )}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] )) ) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{])) }
\NormalTok{    \}}
  
  \CommentTok{\# MI }
\NormalTok{  S.MI }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(}\FunctionTok{expand.grid}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{)), }\FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{,}\AttributeTok{n=}\DecValTok{2}\SpecialCharTok{\^{}}\DecValTok{4}\NormalTok{))}
  \FunctionTok{colnames}\NormalTok{(S.MI) }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\StringTok{"male"}\NormalTok{,}\StringTok{"soc\_env"}\NormalTok{,}\StringTok{"L1"}\NormalTok{,}\StringTok{"sum.mi"}\NormalTok{)}
  \ControlFlowTok{for}\NormalTok{ (n }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{8}\NormalTok{) \{}
\NormalTok{    S.MI[n,}\StringTok{"sum.mi"}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ ( ( b[}\StringTok{"mu\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                              b[}\StringTok{"c\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S.MI[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                              b[}\StringTok{"c\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S.MI[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                              b[}\StringTok{"c\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+} 
\NormalTok{                              b[}\StringTok{"c\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S.MI[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                              b[}\StringTok{"c\_M\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+}
\NormalTok{                              b[}\StringTok{"c\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{{-}} 
\NormalTok{                            ( b[}\StringTok{"mu\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                b[}\StringTok{"c\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S.MI[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                b[}\StringTok{"c\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S.MI[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                b[}\StringTok{"c\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+} 
\NormalTok{                                b[}\StringTok{"c\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S.MI[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                                b[}\StringTok{"c\_M\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+}
\NormalTok{                                b[}\StringTok{"c\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{{-}} 
\NormalTok{                            ( b[}\StringTok{"mu\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                b[}\StringTok{"c\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S.MI[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                b[}\StringTok{"c\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S.MI[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                b[}\StringTok{"c\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+} 
\NormalTok{                                b[}\StringTok{"c\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S.MI[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                                b[}\StringTok{"c\_M\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+}
\NormalTok{                                b[}\StringTok{"c\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{+} 
\NormalTok{                            ( b[}\StringTok{"mu\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                b[}\StringTok{"c\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S.MI[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                b[}\StringTok{"c\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S.MI[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                b[}\StringTok{"c\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+} 
\NormalTok{                                b[}\StringTok{"c\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S.MI[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                                b[}\StringTok{"c\_M\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+}
\NormalTok{                                b[}\StringTok{"c\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      ( ( b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{            b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S.MI[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{            b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S.MI[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{            b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{            b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{ ) }\SpecialCharTok{{-}} 
\NormalTok{          ( b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{              b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S.MI[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{              b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S.MI[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{              b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{              b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{ )) }\SpecialCharTok{*} 
\NormalTok{      ((b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S.MI[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S.MI[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S.MI[n,}\StringTok{"soc\_env"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S.MI[n,}\StringTok{"soc\_env"}\NormalTok{])) }
\NormalTok{    \}}
  
\NormalTok{  PDE.qol }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(S[,}\StringTok{"sum.pde"}\NormalTok{])}
\NormalTok{  PIE.qol }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(S[,}\StringTok{"sum.pie"}\NormalTok{])}
\NormalTok{  MI.qol }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(S.MI[,}\StringTok{"sum.mi"}\NormalTok{])}
  
  \FunctionTok{return}\NormalTok{(}\FunctionTok{list}\NormalTok{(}\AttributeTok{PDE.death =}\NormalTok{ PDE.death, }\AttributeTok{PIE.death =}\NormalTok{ PIE.death, }\AttributeTok{MI.death =}\NormalTok{ MI.death,}
              \AttributeTok{PDE.qol =}\NormalTok{ PDE.qol, }\AttributeTok{PIE.qol =}\NormalTok{ PIE.qol, }\AttributeTok{MI.qol =}\NormalTok{ MI.qol))}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{true}\FloatTok{.3}\NormalTok{way.no.inter }\OtherTok{\textless{}{-}} \FunctionTok{true.3way.decomp}\NormalTok{(}\AttributeTok{interaction =} \DecValTok{0}\NormalTok{)}

\NormalTok{true}\FloatTok{.3}\NormalTok{way.with.inter }\OtherTok{\textless{}{-}} \FunctionTok{true.3way.decomp}\NormalTok{(}\AttributeTok{interaction =} \DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

The \(\text{PNDE}=\mathbb{E}\left( Y_{1,M_0}\right) - \mathbb{E}\left( Y_{0,M_0}\right)\), the \(\text{PNIE}=\mathbb{E}\left(Y_{0,M_1}\right) - \mathbb{E}\left(Y_{0,M_0}\right)\) and the \(\text{MIE}=\mathbb{E}\left( (Y_{1,1} - Y_{1,0} - Y_{0,1} + Y_{0,0}) \times (M_1 - M_0) \right)\) are respectively:

\begin{itemize}
\tightlist
\item
  0.05, 0.00800000000000001 and 0.000 for death without interaction,
\item
  0.05855, 0.00800000000000001 and 0.003 for death with interaction,
\item
  -4, -0.899999999999999 and 0 for quality of life without interaction,
\item
  -5.425, -0.899999999999999 and -0.5 for quality of life with interaction.
\end{itemize}

\subsection{Vanderweele's 4-way decomposition}\label{vanderweeles-4-way-decomposition}

The following function \texttt{true.4way.decomp} can be used to run the calculation for the 4-way decomposition of the total effect into a ``controlled direct effect'' (CDE), a ``reference interaction effect'' (RIE), a ``mediated interaction effect'' (MIE) and a ``pure natural indirect effect'' (PNIE).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{true}\FloatTok{.4}\NormalTok{way.decomp }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(}\AttributeTok{interaction =} \ConstantTok{NULL}\NormalTok{) \{}
\NormalTok{  b }\OtherTok{\textless{}{-}} \FunctionTok{param.causal.model.1}\NormalTok{(}\AttributeTok{A.M.interaction =}\NormalTok{ interaction)}
  
  \CommentTok{\# binary outcome (death)}
\NormalTok{  S }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(}\FunctionTok{expand.grid}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{)), }\FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{,}\AttributeTok{n=}\DecValTok{2}\SpecialCharTok{\^{}}\DecValTok{3}\NormalTok{), }\FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{,}\AttributeTok{n=}\DecValTok{2}\SpecialCharTok{\^{}}\DecValTok{3}\NormalTok{), }
             \FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{,}\AttributeTok{n=}\DecValTok{2}\SpecialCharTok{\^{}}\DecValTok{3}\NormalTok{), }\FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{,}\AttributeTok{n=}\DecValTok{2}\SpecialCharTok{\^{}}\DecValTok{3}\NormalTok{))}
  \FunctionTok{colnames}\NormalTok{(S) }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\StringTok{"male"}\NormalTok{,}\StringTok{"soc\_env"}\NormalTok{, }\StringTok{"L1"}\NormalTok{, }\StringTok{"sum.cde"}\NormalTok{, }\StringTok{"sum.intref"}\NormalTok{, }
                      \StringTok{"sum.intmed"}\NormalTok{, }\StringTok{"sum.pie"}\NormalTok{)}
  \ControlFlowTok{for}\NormalTok{ (n }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{8}\NormalTok{) \{}
    \CommentTok{\# CDE }
\NormalTok{    S[n,}\StringTok{"sum.cde"}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ ( ( b[}\StringTok{"b\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                            b[}\StringTok{"b\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                            b[}\StringTok{"b\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                            b[}\StringTok{"b\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+} 
\NormalTok{                            b[}\StringTok{"b\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                            b[}\StringTok{"b\_M\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+}
\NormalTok{                            b[}\StringTok{"b\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{{-}} 
\NormalTok{                          ( b[}\StringTok{"b\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                              b[}\StringTok{"b\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                              b[}\StringTok{"b\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                              b[}\StringTok{"b\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+} 
\NormalTok{                              b[}\StringTok{"b\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                              b[}\StringTok{"b\_M\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+}
\NormalTok{                              b[}\StringTok{"b\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) ) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{])) }
    
    \CommentTok{\# INTref }
\NormalTok{    S[n,}\StringTok{"sum.intref"}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ ( ( b[}\StringTok{"b\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                               b[}\StringTok{"b\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                               b[}\StringTok{"b\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                               b[}\StringTok{"b\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+} 
\NormalTok{                               b[}\StringTok{"b\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                               b[}\StringTok{"b\_M\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+}
\NormalTok{                               b[}\StringTok{"b\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{{-}} 
\NormalTok{                             ( b[}\StringTok{"b\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                 b[}\StringTok{"b\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                 b[}\StringTok{"b\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                 b[}\StringTok{"b\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+} 
\NormalTok{                                 b[}\StringTok{"b\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                                 b[}\StringTok{"b\_M\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+}
\NormalTok{                                 b[}\StringTok{"b\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{{-}} 
\NormalTok{                             ( b[}\StringTok{"b\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                 b[}\StringTok{"b\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                 b[}\StringTok{"b\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                 b[}\StringTok{"b\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+} 
\NormalTok{                                 b[}\StringTok{"b\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                                 b[}\StringTok{"b\_M\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+}
\NormalTok{                                 b[}\StringTok{"b\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{+} 
\NormalTok{                             ( b[}\StringTok{"b\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                 b[}\StringTok{"b\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                 b[}\StringTok{"b\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                 b[}\StringTok{"b\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+} 
\NormalTok{                                 b[}\StringTok{"b\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                                 b[}\StringTok{"b\_M\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+}
\NormalTok{                                 b[}\StringTok{"b\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      ( b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{          b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{          b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{          b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{          b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{ ) }\SpecialCharTok{*} 
\NormalTok{      ((b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{]))}
    
    \CommentTok{\# INTmed }
\NormalTok{    S[n,}\StringTok{"sum.intmed"}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ ( ( b[}\StringTok{"b\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                               b[}\StringTok{"b\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                               b[}\StringTok{"b\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                               b[}\StringTok{"b\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+} 
\NormalTok{                               b[}\StringTok{"b\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                               b[}\StringTok{"b\_M\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+}
\NormalTok{                               b[}\StringTok{"b\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{{-}} 
\NormalTok{                             ( b[}\StringTok{"b\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                 b[}\StringTok{"b\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                 b[}\StringTok{"b\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                 b[}\StringTok{"b\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+} 
\NormalTok{                                 b[}\StringTok{"b\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                                 b[}\StringTok{"b\_M\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+}
\NormalTok{                                 b[}\StringTok{"b\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{{-}} 
\NormalTok{                             ( b[}\StringTok{"b\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                 b[}\StringTok{"b\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                 b[}\StringTok{"b\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                 b[}\StringTok{"b\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+} 
\NormalTok{                                 b[}\StringTok{"b\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                                 b[}\StringTok{"b\_M\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+}
\NormalTok{                                 b[}\StringTok{"b\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{+} 
\NormalTok{                             ( b[}\StringTok{"b\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                 b[}\StringTok{"b\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                 b[}\StringTok{"b\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                 b[}\StringTok{"b\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+} 
\NormalTok{                                 b[}\StringTok{"b\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                                 b[}\StringTok{"b\_M\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+}
\NormalTok{                                 b[}\StringTok{"b\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      ( ( b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{            b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{            b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{            b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{            b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{ ) }\SpecialCharTok{{-}} 
\NormalTok{          ( b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{              b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{              b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{              b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{              b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{ )) }\SpecialCharTok{*} 
\NormalTok{      ((b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{])) }
    
    \CommentTok{\# PIE }
\NormalTok{    S[n,}\StringTok{"sum.pie"}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ ( ( b[}\StringTok{"b\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                            b[}\StringTok{"b\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                            b[}\StringTok{"b\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                            b[}\StringTok{"b\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+} 
\NormalTok{                            b[}\StringTok{"b\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                            b[}\StringTok{"b\_M\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+}
\NormalTok{                            b[}\StringTok{"b\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{{-}} 
\NormalTok{                          ( b[}\StringTok{"b\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                              b[}\StringTok{"b\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                              b[}\StringTok{"b\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                              b[}\StringTok{"b\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+} 
\NormalTok{                              b[}\StringTok{"b\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                              b[}\StringTok{"b\_M\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+}
\NormalTok{                              b[}\StringTok{"b\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) ) }\SpecialCharTok{*}
\NormalTok{      ( ( b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{            b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{            b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{            b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{            b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{ ) }\SpecialCharTok{{-}} 
\NormalTok{          ( b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{              b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{              b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{              b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{              b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{ )) }\SpecialCharTok{*} 
\NormalTok{      ((b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{])) }
\NormalTok{    \}}
  
\NormalTok{  CDE.death }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(S[,}\StringTok{"sum.cde"}\NormalTok{])}
\NormalTok{  INTref.death }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(S[,}\StringTok{"sum.intref"}\NormalTok{])}
\NormalTok{  INTmed.death }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(S[,}\StringTok{"sum.intmed"}\NormalTok{])}
\NormalTok{  PIE.death }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(S[,}\StringTok{"sum.pie"}\NormalTok{])}
  
  \CommentTok{\# quantitative outcome (QoL)}
\NormalTok{  S }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(}\FunctionTok{expand.grid}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{)), }\FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{,}\AttributeTok{n=}\DecValTok{2}\SpecialCharTok{\^{}}\DecValTok{3}\NormalTok{), }\FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{,}\AttributeTok{n=}\DecValTok{2}\SpecialCharTok{\^{}}\DecValTok{3}\NormalTok{), }
             \FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{,}\AttributeTok{n=}\DecValTok{2}\SpecialCharTok{\^{}}\DecValTok{3}\NormalTok{), }\FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{,}\AttributeTok{n=}\DecValTok{2}\SpecialCharTok{\^{}}\DecValTok{3}\NormalTok{))}
  \FunctionTok{colnames}\NormalTok{(S) }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\StringTok{"male"}\NormalTok{,}\StringTok{"soc\_env"}\NormalTok{, }\StringTok{"L1"}\NormalTok{, }\StringTok{"sum.cde"}\NormalTok{, }\StringTok{"sum.intref"}\NormalTok{, }
                      \StringTok{"sum.intmed"}\NormalTok{, }\StringTok{"sum.pie"}\NormalTok{)}
  \ControlFlowTok{for}\NormalTok{ (n }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{8}\NormalTok{) \{}
    \CommentTok{\# CDE }
\NormalTok{    S[n,}\StringTok{"sum.cde"}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ ( ( b[}\StringTok{"mu\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                            b[}\StringTok{"c\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                            b[}\StringTok{"c\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                            b[}\StringTok{"c\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+} 
\NormalTok{                            b[}\StringTok{"c\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                            b[}\StringTok{"c\_M\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+}
\NormalTok{                            b[}\StringTok{"c\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{{-}} 
\NormalTok{                          ( b[}\StringTok{"mu\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                              b[}\StringTok{"c\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                              b[}\StringTok{"c\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                              b[}\StringTok{"c\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+} 
\NormalTok{                              b[}\StringTok{"c\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                              b[}\StringTok{"c\_M\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+}
\NormalTok{                              b[}\StringTok{"c\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) ) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{])) }
    
    \CommentTok{\# INTref }
\NormalTok{    S[n,}\StringTok{"sum.intref"}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ ( ( b[}\StringTok{"mu\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                               b[}\StringTok{"c\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                               b[}\StringTok{"c\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                               b[}\StringTok{"c\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+} 
\NormalTok{                               b[}\StringTok{"c\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                               b[}\StringTok{"c\_M\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+}
\NormalTok{                               b[}\StringTok{"c\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{{-}} 
\NormalTok{                             ( b[}\StringTok{"mu\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                 b[}\StringTok{"c\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                 b[}\StringTok{"c\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                 b[}\StringTok{"c\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+} 
\NormalTok{                                 b[}\StringTok{"c\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                                 b[}\StringTok{"c\_M\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+}
\NormalTok{                                 b[}\StringTok{"c\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{{-}} 
\NormalTok{                             ( b[}\StringTok{"mu\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                 b[}\StringTok{"c\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                 b[}\StringTok{"c\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                 b[}\StringTok{"c\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+} 
\NormalTok{                                 b[}\StringTok{"c\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                                 b[}\StringTok{"c\_M\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+}
\NormalTok{                                 b[}\StringTok{"c\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{+} 
\NormalTok{                             ( b[}\StringTok{"mu\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                 b[}\StringTok{"c\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                 b[}\StringTok{"c\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                 b[}\StringTok{"c\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+} 
\NormalTok{                                 b[}\StringTok{"c\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                                 b[}\StringTok{"c\_M\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+}
\NormalTok{                                 b[}\StringTok{"c\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      ( b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{          b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{          b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{          b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{          b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{ ) }\SpecialCharTok{*} 
\NormalTok{      ((b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{])) }
    
    \CommentTok{\# INTmed }
\NormalTok{    S[n,}\StringTok{"sum.intmed"}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ ( ( b[}\StringTok{"mu\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                               b[}\StringTok{"c\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                               b[}\StringTok{"c\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                               b[}\StringTok{"c\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+} 
\NormalTok{                               b[}\StringTok{"c\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                               b[}\StringTok{"c\_M\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+}
\NormalTok{                               b[}\StringTok{"c\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{{-}} 
\NormalTok{                             ( b[}\StringTok{"mu\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                 b[}\StringTok{"c\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                 b[}\StringTok{"c\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                 b[}\StringTok{"c\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+} 
\NormalTok{                                 b[}\StringTok{"c\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                                 b[}\StringTok{"c\_M\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+}
\NormalTok{                                 b[}\StringTok{"c\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{{-}} 
\NormalTok{                             ( b[}\StringTok{"mu\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                 b[}\StringTok{"c\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                 b[}\StringTok{"c\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                 b[}\StringTok{"c\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+} 
\NormalTok{                                 b[}\StringTok{"c\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                                 b[}\StringTok{"c\_M\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+}
\NormalTok{                                 b[}\StringTok{"c\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{+} 
\NormalTok{                             ( b[}\StringTok{"mu\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                 b[}\StringTok{"c\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                 b[}\StringTok{"c\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                 b[}\StringTok{"c\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+} 
\NormalTok{                                 b[}\StringTok{"c\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                                 b[}\StringTok{"c\_M\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+}
\NormalTok{                                 b[}\StringTok{"c\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      ( ( b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{            b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{            b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{            b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{            b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{ ) }\SpecialCharTok{{-}} 
\NormalTok{          ( b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{              b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{              b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{              b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{              b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{ )) }\SpecialCharTok{*} 
\NormalTok{      ((b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{])) }
    
    \CommentTok{\# PIE }
\NormalTok{    S[n,}\StringTok{"sum.pie"}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ ( ( b[}\StringTok{"mu\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                            b[}\StringTok{"c\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                            b[}\StringTok{"c\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                            b[}\StringTok{"c\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+} 
\NormalTok{                            b[}\StringTok{"c\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                            b[}\StringTok{"c\_M\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+}
\NormalTok{                            b[}\StringTok{"c\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{{-}} 
\NormalTok{                          ( b[}\StringTok{"mu\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                              b[}\StringTok{"c\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                              b[}\StringTok{"c\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                              b[}\StringTok{"c\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+} 
\NormalTok{                              b[}\StringTok{"c\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                              b[}\StringTok{"c\_M\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+}
\NormalTok{                              b[}\StringTok{"c\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) ) }\SpecialCharTok{*}
\NormalTok{      ( ( b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{            b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{            b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{            b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{            b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{ ) }\SpecialCharTok{{-}} 
\NormalTok{          ( b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{              b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{              b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{              b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{              b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{ )) }\SpecialCharTok{*} 
\NormalTok{      ((b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{])) }
\NormalTok{    \}}
  
\NormalTok{  CDE.qol }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(S[,}\StringTok{"sum.cde"}\NormalTok{])}
\NormalTok{  INTref.qol }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(S[,}\StringTok{"sum.intref"}\NormalTok{])}
\NormalTok{  INTmed.qol }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(S[,}\StringTok{"sum.intmed"}\NormalTok{])}
\NormalTok{  PIE.qol }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(S[,}\StringTok{"sum.pie"}\NormalTok{])}
  
  \FunctionTok{return}\NormalTok{(}\FunctionTok{list}\NormalTok{(}\AttributeTok{CDE.death =}\NormalTok{ CDE.death, }\AttributeTok{INTref.death =}\NormalTok{ INTref.death, }
              \AttributeTok{INTmed.death =}\NormalTok{ INTmed.death, }\AttributeTok{PIE.death =}\NormalTok{ PIE.death,}
              \AttributeTok{CDE.qol =}\NormalTok{ CDE.qol, }\AttributeTok{INTref.qol =}\NormalTok{ INTref.qol, }
              \AttributeTok{INTmed.qol =}\NormalTok{ INTmed.qol, }\AttributeTok{PIE.qol =}\NormalTok{ PIE.qol))}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{true}\FloatTok{.4}\NormalTok{way.no.inter }\OtherTok{\textless{}{-}} \FunctionTok{true.4way.decomp}\NormalTok{(}\AttributeTok{interaction =} \DecValTok{0}\NormalTok{)}

\NormalTok{true}\FloatTok{.4}\NormalTok{way.with.inter }\OtherTok{\textless{}{-}} \FunctionTok{true.4way.decomp}\NormalTok{(}\AttributeTok{interaction =} \DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

The \(\text{CDE}=\mathbb{E}\left(Y_{1,0} \right) - \mathbb{E}\left(Y_{0,0}\right)\), \(\text{RIE}=\left((Y_{1,1} - Y_{1,0} - Y_{0,1} + Y_{0,0}) \times M_0\right)\), \(\text{MIE}= \mathbb{E}\left((Y_{1,1} - Y_{1,0} - Y_{0,1} + Y_{0,0}) \times (M_1 - M_0)\right)\) and \(\text{PNIE}=\mathbb{E}\left(Y_{0,M_1}\right) - \mathbb{E}\left(Y_{0,M_0}\right)\) are respectively:

\begin{itemize}
\tightlist
\item
  0.05, 0.000, 0.000 and 0.008 for death without interaction,
\item
  0.05, 0.00855, 0.003 and 0.008 for death with interaction,
\item
  -4, 0, 0 and -0.9 for quality of life without interaction,
\item
  -4, -1.425, -0.5 and -0.9 for quality of life with interaction.
\end{itemize}

\subsection{Marginal randomized direct and indirect effects}\label{marginal-randomized-direct-and-indirect-effects}

The following function \texttt{true.marg.random} can be used to run the calculation for the marginal randomized natural direct (marginal MRDE) and indirect effects (marginal MRIE).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{true.marg.random }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(}\AttributeTok{interaction =} \ConstantTok{NULL}\NormalTok{) \{}
\NormalTok{  b }\OtherTok{\textless{}{-}} \FunctionTok{param.causal.model.1}\NormalTok{(}\AttributeTok{A.M.interaction =}\NormalTok{ interaction)}
  
  \CommentTok{\# marginal distribution of M}
\NormalTok{  M.S }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(}\FunctionTok{expand.grid}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{)), }\FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{,}\AttributeTok{n=}\DecValTok{2}\SpecialCharTok{\^{}}\DecValTok{5}\NormalTok{))}
  \FunctionTok{colnames}\NormalTok{(M.S) }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\StringTok{"male"}\NormalTok{,}\StringTok{"soc\_env"}\NormalTok{,}\StringTok{"L1"}\NormalTok{,}\StringTok{"M"}\NormalTok{,}\StringTok{"A"}\NormalTok{,}\StringTok{"sum"}\NormalTok{)}
  
  \ControlFlowTok{for}\NormalTok{ (n }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{32}\NormalTok{) \{}
\NormalTok{    M.S[n,}\StringTok{"sum"}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ (( b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+}                                                              
\NormalTok{                         b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ M.S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                         b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ M.S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                         b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ M.S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                         b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ M.S[n,}\StringTok{"A"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{( M.S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      (( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ (b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ M.S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ M.S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ M.S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ M.S[n,}\StringTok{"A"}\NormalTok{]) )}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ M.S[n,}\StringTok{"M"}\NormalTok{] )) }
\NormalTok{    \}}
  
\NormalTok{  M0.A0.L0\_00.L1\_0 }\OtherTok{\textless{}{-}}\NormalTok{ M.S[M.S[,}\StringTok{"M"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"A"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&} 
\NormalTok{                            M.S[,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{,}\StringTok{"sum"}\NormalTok{]}
\NormalTok{  M0.A0.L0\_01.L1\_0 }\OtherTok{\textless{}{-}}\NormalTok{ M.S[M.S[,}\StringTok{"M"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"A"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&} 
\NormalTok{                            M.S[,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{,}\StringTok{"sum"}\NormalTok{]}
\NormalTok{  M0.A0.L0\_10.L1\_0 }\OtherTok{\textless{}{-}}\NormalTok{ M.S[M.S[,}\StringTok{"M"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"A"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&} 
\NormalTok{                            M.S[,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{,}\StringTok{"sum"}\NormalTok{]}
\NormalTok{  M0.A0.L0\_11.L1\_0 }\OtherTok{\textless{}{-}}\NormalTok{ M.S[M.S[,}\StringTok{"M"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"A"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&} 
\NormalTok{                            M.S[,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{,}\StringTok{"sum"}\NormalTok{]}
\NormalTok{  M0.A0.L0\_00.L1\_1 }\OtherTok{\textless{}{-}}\NormalTok{ M.S[M.S[,}\StringTok{"M"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"A"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&} 
\NormalTok{                            M.S[,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{,}\StringTok{"sum"}\NormalTok{]}
\NormalTok{  M0.A0.L0\_01.L1\_1 }\OtherTok{\textless{}{-}}\NormalTok{ M.S[M.S[,}\StringTok{"M"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"A"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&} 
\NormalTok{                            M.S[,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{,}\StringTok{"sum"}\NormalTok{]}
\NormalTok{  M0.A0.L0\_10.L1\_1 }\OtherTok{\textless{}{-}}\NormalTok{ M.S[M.S[,}\StringTok{"M"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"A"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&} 
\NormalTok{                            M.S[,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{,}\StringTok{"sum"}\NormalTok{]}
\NormalTok{  M0.A0.L0\_11.L1\_1 }\OtherTok{\textless{}{-}}\NormalTok{ M.S[M.S[,}\StringTok{"M"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"A"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&} 
\NormalTok{                            M.S[,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{,}\StringTok{"sum"}\NormalTok{]}
  
\NormalTok{  M1.A0.L0\_00.L1\_0 }\OtherTok{\textless{}{-}}\NormalTok{ M.S[M.S[,}\StringTok{"M"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"A"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&} 
\NormalTok{                            M.S[,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{,}\StringTok{"sum"}\NormalTok{]}
\NormalTok{  M1.A0.L0\_01.L1\_0 }\OtherTok{\textless{}{-}}\NormalTok{ M.S[M.S[,}\StringTok{"M"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"A"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&} 
\NormalTok{                            M.S[,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{,}\StringTok{"sum"}\NormalTok{]}
\NormalTok{  M1.A0.L0\_10.L1\_0 }\OtherTok{\textless{}{-}}\NormalTok{ M.S[M.S[,}\StringTok{"M"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"A"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&} 
\NormalTok{                            M.S[,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{,}\StringTok{"sum"}\NormalTok{]}
\NormalTok{  M1.A0.L0\_11.L1\_0 }\OtherTok{\textless{}{-}}\NormalTok{ M.S[M.S[,}\StringTok{"M"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"A"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&} 
\NormalTok{                            M.S[,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{,}\StringTok{"sum"}\NormalTok{]}
\NormalTok{  M1.A0.L0\_00.L1\_1 }\OtherTok{\textless{}{-}}\NormalTok{ M.S[M.S[,}\StringTok{"M"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"A"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&} 
\NormalTok{                            M.S[,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{,}\StringTok{"sum"}\NormalTok{]}
\NormalTok{  M1.A0.L0\_01.L1\_1 }\OtherTok{\textless{}{-}}\NormalTok{ M.S[M.S[,}\StringTok{"M"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"A"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&} 
\NormalTok{                            M.S[,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{,}\StringTok{"sum"}\NormalTok{]}
\NormalTok{  M1.A0.L0\_10.L1\_1 }\OtherTok{\textless{}{-}}\NormalTok{ M.S[M.S[,}\StringTok{"M"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"A"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&} 
\NormalTok{                            M.S[,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{,}\StringTok{"sum"}\NormalTok{]}
\NormalTok{  M1.A0.L0\_11.L1\_1 }\OtherTok{\textless{}{-}}\NormalTok{ M.S[M.S[,}\StringTok{"M"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"A"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&} 
\NormalTok{                            M.S[,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{,}\StringTok{"sum"}\NormalTok{]}
  
\NormalTok{  M0.A1.L0\_00.L1\_0 }\OtherTok{\textless{}{-}}\NormalTok{ M.S[M.S[,}\StringTok{"M"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"A"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&} 
\NormalTok{                            M.S[,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{,}\StringTok{"sum"}\NormalTok{]}
\NormalTok{  M0.A1.L0\_01.L1\_0 }\OtherTok{\textless{}{-}}\NormalTok{ M.S[M.S[,}\StringTok{"M"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"A"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&} 
\NormalTok{                            M.S[,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{,}\StringTok{"sum"}\NormalTok{]}
\NormalTok{  M0.A1.L0\_10.L1\_0 }\OtherTok{\textless{}{-}}\NormalTok{ M.S[M.S[,}\StringTok{"M"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"A"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&} 
\NormalTok{                            M.S[,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{,}\StringTok{"sum"}\NormalTok{]}
\NormalTok{  M0.A1.L0\_11.L1\_0 }\OtherTok{\textless{}{-}}\NormalTok{ M.S[M.S[,}\StringTok{"M"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"A"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&} 
\NormalTok{                            M.S[,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{,}\StringTok{"sum"}\NormalTok{]}
\NormalTok{  M0.A1.L0\_00.L1\_1 }\OtherTok{\textless{}{-}}\NormalTok{ M.S[M.S[,}\StringTok{"M"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"A"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&} 
\NormalTok{                            M.S[,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{,}\StringTok{"sum"}\NormalTok{]}
\NormalTok{  M0.A1.L0\_01.L1\_1 }\OtherTok{\textless{}{-}}\NormalTok{ M.S[M.S[,}\StringTok{"M"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"A"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&} 
\NormalTok{                            M.S[,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{,}\StringTok{"sum"}\NormalTok{]}
\NormalTok{  M0.A1.L0\_10.L1\_1 }\OtherTok{\textless{}{-}}\NormalTok{ M.S[M.S[,}\StringTok{"M"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"A"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&} 
\NormalTok{                            M.S[,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{,}\StringTok{"sum"}\NormalTok{]}
\NormalTok{  M0.A1.L0\_11.L1\_1 }\OtherTok{\textless{}{-}}\NormalTok{ M.S[M.S[,}\StringTok{"M"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"A"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&} 
\NormalTok{                            M.S[,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{,}\StringTok{"sum"}\NormalTok{]}
  
\NormalTok{  M1.A1.L0\_00.L1\_0 }\OtherTok{\textless{}{-}}\NormalTok{ M.S[M.S[,}\StringTok{"M"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"A"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&} 
\NormalTok{                            M.S[,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{,}\StringTok{"sum"}\NormalTok{]}
\NormalTok{  M1.A1.L0\_01.L1\_0 }\OtherTok{\textless{}{-}}\NormalTok{ M.S[M.S[,}\StringTok{"M"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"A"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&} 
\NormalTok{                            M.S[,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{,}\StringTok{"sum"}\NormalTok{]}
\NormalTok{  M1.A1.L0\_10.L1\_0 }\OtherTok{\textless{}{-}}\NormalTok{ M.S[M.S[,}\StringTok{"M"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"A"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&} 
\NormalTok{                            M.S[,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{,}\StringTok{"sum"}\NormalTok{]}
\NormalTok{  M1.A1.L0\_11.L1\_0 }\OtherTok{\textless{}{-}}\NormalTok{ M.S[M.S[,}\StringTok{"M"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"A"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&} 
\NormalTok{                            M.S[,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{,}\StringTok{"sum"}\NormalTok{]}
\NormalTok{  M1.A1.L0\_00.L1\_1 }\OtherTok{\textless{}{-}}\NormalTok{ M.S[M.S[,}\StringTok{"M"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"A"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&} 
\NormalTok{                            M.S[,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{,}\StringTok{"sum"}\NormalTok{]}
\NormalTok{  M1.A1.L0\_01.L1\_1 }\OtherTok{\textless{}{-}}\NormalTok{ M.S[M.S[,}\StringTok{"M"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"A"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&} 
\NormalTok{                            M.S[,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{,}\StringTok{"sum"}\NormalTok{]}
\NormalTok{  M1.A1.L0\_10.L1\_1 }\OtherTok{\textless{}{-}}\NormalTok{ M.S[M.S[,}\StringTok{"M"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"A"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&} 
\NormalTok{                            M.S[,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{,}\StringTok{"sum"}\NormalTok{]}
\NormalTok{  M1.A1.L0\_11.L1\_1 }\OtherTok{\textless{}{-}}\NormalTok{ M.S[M.S[,}\StringTok{"M"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"A"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&} 
\NormalTok{                            M.S[,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{,}\StringTok{"sum"}\NormalTok{]}
  
  \CommentTok{\# binary outcome (death)}
\NormalTok{  S }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(}\FunctionTok{expand.grid}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{)), }\FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{,}\AttributeTok{n=}\DecValTok{2}\SpecialCharTok{\^{}}\DecValTok{4}\NormalTok{), }\FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{,}\AttributeTok{n=}\DecValTok{2}\SpecialCharTok{\^{}}\DecValTok{4}\NormalTok{), }
             \FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{,}\AttributeTok{n=}\DecValTok{2}\SpecialCharTok{\^{}}\DecValTok{4}\NormalTok{))}
  \FunctionTok{colnames}\NormalTok{(S) }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\StringTok{"male"}\NormalTok{,}\StringTok{"soc\_env"}\NormalTok{,}\StringTok{"L1"}\NormalTok{,}\StringTok{"M"}\NormalTok{,}\StringTok{"sum.psi11"}\NormalTok{, }\StringTok{"sum.psi10"}\NormalTok{, }\StringTok{"sum.psi00"}\NormalTok{)}
  \ControlFlowTok{for}\NormalTok{ (n }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{16}\NormalTok{) \{}
\NormalTok{    S[n,}\StringTok{"sum.psi11"}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{  ( b[}\StringTok{"b\_Y"}\NormalTok{] }\SpecialCharTok{+}                                            \CommentTok{\# A=1}
\NormalTok{                             b[}\StringTok{"b\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"b\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"b\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"b\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"b\_M\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"b\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{*}
\NormalTok{      ((M1.A1.L0\_00.L1\_0}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+} \CommentTok{\# A\textquotesingle{}=1             }
\NormalTok{          M1.A1.L0\_01.L1\_0}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M1.A1.L0\_10.L1\_0}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+} 
\NormalTok{          M1.A1.L0\_11.L1\_0}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M1.A1.L0\_00.L1\_1}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M1.A1.L0\_01.L1\_1}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M1.A1.L0\_10.L1\_1}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M1.A1.L0\_11.L1\_1}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}
\NormalTok{          (S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) )}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      ((M0.A1.L0\_00.L1\_0}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+}                
\NormalTok{          M0.A1.L0\_01.L1\_0}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M0.A1.L0\_10.L1\_0}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+} 
\NormalTok{          M0.A1.L0\_11.L1\_0}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M0.A1.L0\_00.L1\_1}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M0.A1.L0\_01.L1\_1}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M0.A1.L0\_10.L1\_1}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M0.A1.L0\_11.L1\_1}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}
\NormalTok{          (S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) )}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(M.S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ M.S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{])) }
    
\NormalTok{    S[n,}\StringTok{"sum.psi10"}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{  ( b[}\StringTok{"b\_Y"}\NormalTok{] }\SpecialCharTok{+}                                            \CommentTok{\# A=1}
\NormalTok{                             b[}\StringTok{"b\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"b\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"b\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"b\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"b\_M\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"b\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{*}
\NormalTok{      ((M1.A0.L0\_00.L1\_0}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+} \CommentTok{\# A\textquotesingle{}=0}
\NormalTok{          M1.A0.L0\_01.L1\_0}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M1.A0.L0\_10.L1\_0}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+} 
\NormalTok{          M1.A0.L0\_11.L1\_0}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M1.A0.L0\_00.L1\_1}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M1.A0.L0\_01.L1\_1}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M1.A0.L0\_10.L1\_1}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M1.A0.L0\_11.L1\_1}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}
\NormalTok{          (S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) )}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      ((M0.A0.L0\_00.L1\_0}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+}               
\NormalTok{          M0.A0.L0\_01.L1\_0}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M0.A0.L0\_10.L1\_0}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+} 
\NormalTok{          M0.A0.L0\_11.L1\_0}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M0.A0.L0\_00.L1\_1}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M0.A0.L0\_01.L1\_1}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M0.A0.L0\_10.L1\_1}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M0.A0.L0\_11.L1\_1}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}
\NormalTok{          (S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) )}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(M.S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ M.S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{])) }
    
\NormalTok{    S[n,}\StringTok{"sum.psi00"}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{  ( b[}\StringTok{"b\_Y"}\NormalTok{] }\SpecialCharTok{+}                                            \CommentTok{\# A=0}
\NormalTok{                             b[}\StringTok{"b\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"b\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"b\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"b\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"b\_M\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"b\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{*}
\NormalTok{      ((M1.A0.L0\_00.L1\_0}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+} \CommentTok{\# A\textquotesingle{}=0}
\NormalTok{          M1.A0.L0\_01.L1\_0}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M1.A0.L0\_10.L1\_0}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+} 
\NormalTok{          M1.A0.L0\_11.L1\_0}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M1.A0.L0\_00.L1\_1}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M1.A0.L0\_01.L1\_1}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M1.A0.L0\_10.L1\_1}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M1.A0.L0\_11.L1\_1}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}
\NormalTok{          (S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) )}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      ((M0.A0.L0\_00.L1\_0}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+}               
\NormalTok{          M0.A0.L0\_01.L1\_0}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M0.A0.L0\_10.L1\_0}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+} 
\NormalTok{          M0.A0.L0\_11.L1\_0}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M0.A0.L0\_00.L1\_1}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M0.A0.L0\_01.L1\_1}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M0.A0.L0\_10.L1\_1}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M0.A0.L0\_11.L1\_1}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}
\NormalTok{          (S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) )}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(M.S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ M.S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{])) }
\NormalTok{    \}}
  
\NormalTok{  mrNDE.death }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(S[,}\StringTok{"sum.psi10"}\NormalTok{]) }\SpecialCharTok{{-}} \FunctionTok{sum}\NormalTok{(S[,}\StringTok{"sum.psi00"}\NormalTok{])}
\NormalTok{  mrNIE.death }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(S[,}\StringTok{"sum.psi11"}\NormalTok{]) }\SpecialCharTok{{-}} \FunctionTok{sum}\NormalTok{(S[,}\StringTok{"sum.psi10"}\NormalTok{])}
  
  \CommentTok{\# quantitative outcome (QoL)}
\NormalTok{  S }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(}\FunctionTok{expand.grid}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{)), }\FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{,}\AttributeTok{n=}\DecValTok{2}\SpecialCharTok{\^{}}\DecValTok{4}\NormalTok{), }
             \FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{,}\AttributeTok{n=}\DecValTok{2}\SpecialCharTok{\^{}}\DecValTok{4}\NormalTok{), }\FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{,}\AttributeTok{n=}\DecValTok{2}\SpecialCharTok{\^{}}\DecValTok{4}\NormalTok{))}
  \FunctionTok{colnames}\NormalTok{(S) }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\StringTok{"male"}\NormalTok{,}\StringTok{"soc\_env"}\NormalTok{,}\StringTok{"L1"}\NormalTok{,}\StringTok{"M"}\NormalTok{,}\StringTok{"sum.psi11"}\NormalTok{, }\StringTok{"sum.psi10"}\NormalTok{, }
                      \StringTok{"sum.psi00"}\NormalTok{)}
  \ControlFlowTok{for}\NormalTok{ (n }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{16}\NormalTok{) \{}
\NormalTok{    S[n,}\StringTok{"sum.psi11"}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{  ( b[}\StringTok{"mu\_Y"}\NormalTok{] }\SpecialCharTok{+}                                          \CommentTok{\# A=1}
\NormalTok{                             b[}\StringTok{"c\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"c\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"c\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"c\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"c\_M\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"c\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{*}
\NormalTok{      ((M1.A1.L0\_00.L1\_0}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+} \CommentTok{\# A\textquotesingle{}=1}
\NormalTok{          M1.A1.L0\_01.L1\_0}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M1.A1.L0\_10.L1\_0}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+} 
\NormalTok{          M1.A1.L0\_11.L1\_0}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M1.A1.L0\_00.L1\_1}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M1.A1.L0\_01.L1\_1}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M1.A1.L0\_10.L1\_1}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M1.A1.L0\_11.L1\_1}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}
\NormalTok{          (S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) )}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      ((M0.A1.L0\_00.L1\_0}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+}                
\NormalTok{          M0.A1.L0\_01.L1\_0}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M0.A1.L0\_10.L1\_0}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+} 
\NormalTok{          M0.A1.L0\_11.L1\_0}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M0.A1.L0\_00.L1\_1}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M0.A1.L0\_01.L1\_1}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M0.A1.L0\_10.L1\_1}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M0.A1.L0\_11.L1\_1}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}
\NormalTok{          (S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) )}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(M.S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ M.S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{])) }
    
\NormalTok{    S[n,}\StringTok{"sum.psi10"}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{  ( b[}\StringTok{"mu\_Y"}\NormalTok{] }\SpecialCharTok{+}                                          \CommentTok{\# A=1}
\NormalTok{                             b[}\StringTok{"c\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"c\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"c\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"c\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"c\_M\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"c\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{*}
\NormalTok{      ((M1.A0.L0\_00.L1\_0}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+} \CommentTok{\# A\textquotesingle{}=0}
\NormalTok{          M1.A0.L0\_01.L1\_0}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M1.A0.L0\_10.L1\_0}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+} 
\NormalTok{          M1.A0.L0\_11.L1\_0}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M1.A0.L0\_00.L1\_1}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M1.A0.L0\_01.L1\_1}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M1.A0.L0\_10.L1\_1}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M1.A0.L0\_11.L1\_1}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}
\NormalTok{          (S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) )}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      ((M0.A0.L0\_00.L1\_0}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+}               
\NormalTok{          M0.A0.L0\_01.L1\_0}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M0.A0.L0\_10.L1\_0}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+} 
\NormalTok{          M0.A0.L0\_11.L1\_0}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M0.A0.L0\_00.L1\_1}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M0.A0.L0\_01.L1\_1}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M0.A0.L0\_10.L1\_1}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M0.A0.L0\_11.L1\_1}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}
\NormalTok{          (S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) )}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(M.S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ M.S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{])) }
    
\NormalTok{    S[n,}\StringTok{"sum.psi00"}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{  ( b[}\StringTok{"mu\_Y"}\NormalTok{] }\SpecialCharTok{+}                                          \CommentTok{\# A=0}
\NormalTok{                             b[}\StringTok{"c\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"c\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"c\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"c\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"c\_M\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"c\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{*}
\NormalTok{      ((M1.A0.L0\_00.L1\_0}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+} \CommentTok{\# A\textquotesingle{}=0}
\NormalTok{          M1.A0.L0\_01.L1\_0}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M1.A0.L0\_10.L1\_0}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+} 
\NormalTok{          M1.A0.L0\_11.L1\_0}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M1.A0.L0\_00.L1\_1}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M1.A0.L0\_01.L1\_1}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M1.A0.L0\_10.L1\_1}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M1.A0.L0\_11.L1\_1}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}
\NormalTok{          (S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) )}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      ((M0.A0.L0\_00.L1\_0}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+}               
\NormalTok{          M0.A0.L0\_01.L1\_0}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M0.A0.L0\_10.L1\_0}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+} 
\NormalTok{          M0.A0.L0\_11.L1\_0}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M0.A0.L0\_00.L1\_1}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M0.A0.L0\_01.L1\_1}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M0.A0.L0\_10.L1\_1}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M0.A0.L0\_11.L1\_1}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}
\NormalTok{          (S[n,}\StringTok{"L1"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) )}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(M.S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ M.S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{])) }
\NormalTok{    \}}
  
\NormalTok{  mrNDE.qol }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(S[,}\StringTok{"sum.psi10"}\NormalTok{]) }\SpecialCharTok{{-}} \FunctionTok{sum}\NormalTok{(S[,}\StringTok{"sum.psi00"}\NormalTok{])}
\NormalTok{  mrNIE.qol }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(S[,}\StringTok{"sum.psi11"}\NormalTok{]) }\SpecialCharTok{{-}} \FunctionTok{sum}\NormalTok{(S[,}\StringTok{"sum.psi10"}\NormalTok{])}
  
  \FunctionTok{return}\NormalTok{(}\FunctionTok{list}\NormalTok{(}\AttributeTok{mrNDE.death =}\NormalTok{ mrNDE.death, }\AttributeTok{mrNIE.death =}\NormalTok{ mrNIE.death, }
              \AttributeTok{mrNDE.qol =}\NormalTok{ mrNDE.qol, }\AttributeTok{mrNIE.qol =}\NormalTok{ mrNIE.qol))}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{true.marg.random.no.inter }\OtherTok{\textless{}{-}} \FunctionTok{true.marg.random}\NormalTok{(}\AttributeTok{interaction =} \DecValTok{0}\NormalTok{)}

\NormalTok{true.marg.random.with.inter }\OtherTok{\textless{}{-}} \FunctionTok{true.marg.random}\NormalTok{(}\AttributeTok{interaction =} \DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

The marginal randomized direct effect \(\text{MRDE}=\mathbb{E}\left(Y_{1,G_{0|L(0)}}\right) - \mathbb{E}\left(Y_{0,G_{0|L(0)}}\right)\) and the marginal randomized indirect effect \(\text{MRIE}=\mathbb{E}\left(Y_{1,G_{1|L(0)}}\right) - \mathbb{E}\left(Y_{1,G_{0|L(0)}}\right)\) are respectively:

\begin{itemize}
\tightlist
\item
  0.05 and 0.00800000000000003 for death without interaction,
\item
  0.05855 and 0.011 for death with interaction,
\item
  -3.99999999999999 and -0.900000000000006 for quality of life without interaction,
\item
  -5.42499999999999 and -1.40000000000001 for quality of life with interaction.
\end{itemize}

\subsection{Conditional randomized direct and indirect effects}\label{conditional-randomized-direct-and-indirect-effects}

The following function \texttt{true.cond.random} can be used to run the calculation for the conditional randomized natural direct (CRDE) and indirect effects (CRIE).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{true.cond.random }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(}\AttributeTok{interaction =} \ConstantTok{NULL}\NormalTok{) \{}
\NormalTok{  b }\OtherTok{\textless{}{-}} \FunctionTok{param.causal.model.1}\NormalTok{(}\AttributeTok{A.M.interaction =}\NormalTok{ interaction)}
  
  \CommentTok{\# binary outcome (death)}
\NormalTok{  S }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(}\FunctionTok{expand.grid}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{)), }\FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{,}\AttributeTok{n=}\DecValTok{2}\SpecialCharTok{\^{}}\DecValTok{4}\NormalTok{), }
             \FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{,}\AttributeTok{n=}\DecValTok{2}\SpecialCharTok{\^{}}\DecValTok{4}\NormalTok{), }\FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{,}\AttributeTok{n=}\DecValTok{2}\SpecialCharTok{\^{}}\DecValTok{4}\NormalTok{))}
  \FunctionTok{colnames}\NormalTok{(S) }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\StringTok{"male"}\NormalTok{,}\StringTok{"soc\_env"}\NormalTok{,}\StringTok{"L1"}\NormalTok{,}\StringTok{"M"}\NormalTok{,}\StringTok{"sum.psi11"}\NormalTok{, }\StringTok{"sum.psi10"}\NormalTok{, }
                      \StringTok{"sum.psi00"}\NormalTok{)}
  \ControlFlowTok{for}\NormalTok{ (n }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{16}\NormalTok{) \{}
\NormalTok{    S[n,}\StringTok{"sum.psi11"}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{  ( b[}\StringTok{"b\_Y"}\NormalTok{] }\SpecialCharTok{+}                                           \CommentTok{\# A=1}
\NormalTok{                             b[}\StringTok{"b\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"b\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"b\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"b\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"b\_M\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"b\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{*}
\NormalTok{      (( b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+}                                                             \CommentTok{\# A\textquotesingle{}=1}
\NormalTok{           b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{           b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{           b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{           b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{ )}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      (( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ (b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{ ) )}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{])) }
    
\NormalTok{    S[n,}\StringTok{"sum.psi10"}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{  ( b[}\StringTok{"b\_Y"}\NormalTok{] }\SpecialCharTok{+}                                           \CommentTok{\# A=1}
\NormalTok{                             b[}\StringTok{"b\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"b\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"b\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"b\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"b\_M\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"b\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{*}
\NormalTok{      (( b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+}                                                             \CommentTok{\# A\textquotesingle{}=0}
\NormalTok{           b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{           b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{           b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{           b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{ )}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      (( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ (b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{ ) )}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{])) }
    
\NormalTok{    S[n,}\StringTok{"sum.psi00"}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{  ( b[}\StringTok{"b\_Y"}\NormalTok{] }\SpecialCharTok{+}                                           \CommentTok{\# A=0}
\NormalTok{                             b[}\StringTok{"b\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"b\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"b\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"b\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"b\_M\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"b\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{*}
\NormalTok{      (( b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+}                                                             \CommentTok{\# A\textquotesingle{}=0}
\NormalTok{           b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{           b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{           b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{           b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{ )}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      (( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ (b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{ ) )}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{]))}
\NormalTok{    \}}
  
\NormalTok{  crNDE.death }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(S[,}\StringTok{"sum.psi10"}\NormalTok{]) }\SpecialCharTok{{-}} \FunctionTok{sum}\NormalTok{(S[,}\StringTok{"sum.psi00"}\NormalTok{])}
\NormalTok{  crNIE.death }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(S[,}\StringTok{"sum.psi11"}\NormalTok{]) }\SpecialCharTok{{-}} \FunctionTok{sum}\NormalTok{(S[,}\StringTok{"sum.psi10"}\NormalTok{])}
  
  \CommentTok{\# quantitative outcome (QoL)}
\NormalTok{  S }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(}\FunctionTok{expand.grid}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{)), }\FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{,}\AttributeTok{n=}\DecValTok{2}\SpecialCharTok{\^{}}\DecValTok{4}\NormalTok{), }
             \FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{,}\AttributeTok{n=}\DecValTok{2}\SpecialCharTok{\^{}}\DecValTok{4}\NormalTok{), }\FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{,}\AttributeTok{n=}\DecValTok{2}\SpecialCharTok{\^{}}\DecValTok{4}\NormalTok{))}
  \FunctionTok{colnames}\NormalTok{(S) }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\StringTok{"male"}\NormalTok{,}\StringTok{"soc\_env"}\NormalTok{,}\StringTok{"L1"}\NormalTok{,}\StringTok{"M"}\NormalTok{,}\StringTok{"sum.psi11"}\NormalTok{, }\StringTok{"sum.psi10"}\NormalTok{, }
                      \StringTok{"sum.psi00"}\NormalTok{)}
  \ControlFlowTok{for}\NormalTok{ (n }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{16}\NormalTok{) \{}
\NormalTok{    S[n,}\StringTok{"sum.psi11"}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{  ( b[}\StringTok{"mu\_Y"}\NormalTok{] }\SpecialCharTok{+}                                          \CommentTok{\# A=1}
\NormalTok{                             b[}\StringTok{"c\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"c\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"c\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"c\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"c\_M\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"c\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{*}
\NormalTok{      (( b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+}                                                             \CommentTok{\# A\textquotesingle{}=1}
\NormalTok{           b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{           b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{           b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{           b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{ )}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      (( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ (b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{ ) )}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{])) }
    
\NormalTok{    S[n,}\StringTok{"sum.psi10"}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{  ( b[}\StringTok{"mu\_Y"}\NormalTok{] }\SpecialCharTok{+}                                          \CommentTok{\# A=1}
\NormalTok{                             b[}\StringTok{"c\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"c\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"c\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"c\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"c\_M\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"c\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{*}
\NormalTok{      (( b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+}                                                             \CommentTok{\# A\textquotesingle{}=0}
\NormalTok{           b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{           b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{           b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{           b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{ )}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      (( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ (b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{ ) )}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{])) }
    
\NormalTok{    S[n,}\StringTok{"sum.psi00"}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{  ( b[}\StringTok{"mu\_Y"}\NormalTok{] }\SpecialCharTok{+}                                          \CommentTok{\# A=0}
\NormalTok{                             b[}\StringTok{"c\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"c\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"c\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"c\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"c\_M\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"c\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{*}
\NormalTok{      (( b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+}                                                             \CommentTok{\# A\textquotesingle{}=0}
\NormalTok{           b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{           b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{           b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{           b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{ )}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      (( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ (b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{ ) )}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L1"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{])) }
\NormalTok{    \}}
  
\NormalTok{  crNDE.qol }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(S[,}\StringTok{"sum.psi10"}\NormalTok{]) }\SpecialCharTok{{-}} \FunctionTok{sum}\NormalTok{(S[,}\StringTok{"sum.psi00"}\NormalTok{])}
\NormalTok{  crNIE.qol }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(S[,}\StringTok{"sum.psi11"}\NormalTok{]) }\SpecialCharTok{{-}} \FunctionTok{sum}\NormalTok{(S[,}\StringTok{"sum.psi10"}\NormalTok{])}
  
  \FunctionTok{return}\NormalTok{(}\FunctionTok{list}\NormalTok{(}\AttributeTok{crNDE.death =}\NormalTok{ crNDE.death, }\AttributeTok{crNIE.death =}\NormalTok{ crNIE.death, }
              \AttributeTok{crNDE.qol =}\NormalTok{ crNDE.qol, }\AttributeTok{crNIE.qol =}\NormalTok{ crNIE.qol))}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{true.cond.random.no.inter }\OtherTok{\textless{}{-}} \FunctionTok{true.cond.random}\NormalTok{(}\AttributeTok{interaction =} \DecValTok{0}\NormalTok{)}

\NormalTok{true.cond.random.with.inter }\OtherTok{\textless{}{-}} \FunctionTok{true.cond.random}\NormalTok{(}\AttributeTok{interaction =} \DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

The conditional randomized direct effect \(\text{CRDE}=\mathbb{E}\left(Y_{1,\Gamma_{0\mid L(0),L(1)}}\right) - \mathbb{E}\left(Y_{0,\Gamma_{0\mid L(0),L(1)}}\right)\) and conditional randomized indirect effect \(\text{CRIE}=\mathbb{E}\left(Y_{1,\Gamma_{1\mid L(0),L(1)}}\right) - \mathbb{E}\left(Y_{1,\Gamma_{0\mid L(0),L(1)}}\right)\) are respectively:

\begin{itemize}
\tightlist
\item
  0.05 and 0.00800000000000003 for death without interaction,
\item
  0.05855 and 0.011 for death with interaction,
\item
  -3.99999999999999 and -0.900000000000006 for quality of life without interaction,
\item
  -5.42499999999999 and -1.40000000000001 for quality of life with interaction.
\end{itemize}

\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 4\tabcolsep) * \real{0.2290}}
  >{\centering\arraybackslash}p{(\columnwidth - 4\tabcolsep) * \real{0.4046}}
  >{\centering\arraybackslash}p{(\columnwidth - 4\tabcolsep) * \real{0.3664}}@{}}
\caption{True values without time varying confounders}\tabularnewline
\toprule\noalign{}
\begin{minipage}[b]{\linewidth}\raggedright
Effects
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
Without \(A*M\) interaction
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
with \(A*M\) interaction
\end{minipage} \\
\midrule\noalign{}
\endfirsthead
\toprule\noalign{}
\begin{minipage}[b]{\linewidth}\raggedright
Effects
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
Without \(A*M\) interaction
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
with \(A*M\) interaction
\end{minipage} \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
\textbf{Binary outcome} & & \\
Average total effect (ATE) & 0.058 & 0.06955 \\
& & \\
Controlled direct effect (CDE) & & \\
- CDE, setting do(M=0) & 0.05 & 0.05 \\
- CDE, setting do(M=1) & 0.05 & 0.08 \\
& & \\
Pure NDE and Total NIE & & \\
- PNDE & 0.05 & 0.05855 \\
- TNIE & 0.00800000000000001 & 0.011 \\
& & \\
Total NDE and Pure NIE & & \\
- TNDE & 0.05 & 0.06155 \\
- PNIE & 0.00800000000000001 & 0.00800000000000001 \\
& & \\
3-way decomposition & & \\
- PDE & 0.05 & 0.05855 \\
- PIE & 0.00800000000000001 & 0.00800000000000001 \\
- MI & 0.000 & 0.003 \\
& & \\
4-way decomposition & & \\
- CDE & 0.05 & 0.05 \\
- INTref & 0.000 & 0.00855 \\
- INTmed & 0.000 & 0.003 \\
- PIE & 0.008 & 0.008 \\
& & \\
Marginal randomized & & \\
- marginal rNDE & 0.05 & 0.05855 \\
- marginal rNIE & 0.00800000000000003 & 0.011 \\
& & \\
Conditional randomized & & \\
- conditional rNDE & 0.05 & 0.05855 \\
- conditional rNIE & 0.00800000000000003 & 0.011 \\
& & \\
\textbf{Quantitative outcome} & & \\
Average total effect (ATE) & -4.9 & -6.825 \\
& & \\
Controlled direct effect (CDE) & & \\
- CDE, setting do(M=0) & -4 & -4 \\
- CDE, setting do(M=1) & -4 & -9 \\
& & \\
Pure NDE and Total NIE & & \\
- PNDE & -4 & -5.425 \\
- TNIE & -0.9 & -1.4 \\
& & \\
Total NDE and Pure NIE & & \\
- TNDE & -4 & -5.925 \\
- PNIE & -0.899999999999999 & -0.899999999999999 \\
& & \\
3-way decomposition & & \\
- PDE & -4 & -5.425 \\
- PIE & -0.899999999999999 & -0.899999999999999 \\
- MI & 0 & -0.5 \\
& & \\
4-way decomposition & & \\
- CDE & -4 & -4 \\
- INTref & 0.000 & -1.425 \\
- INTmed & 0.000 & -0.5 \\
- PIE & -0.9 & -0.9 \\
& & \\
Marginal randomized & & \\
- marginal rNDE & -3.99999999999999 & -5.42499999999999 \\
- marginal rNIE & -0.900000000000006 & -1.40000000000001 \\
& & \\
Conditional randomized & & \\
- conditional rNDE & -3.99999999999999 & -5.42499999999999 \\
- conditional rNIE & -0.900000000000006 & -1.40000000000001 \\
\end{longtable}

\section{True causal quantities with mediator-outcome confounder affected by the exposure}\label{true-causal-quantities-with-mediator-outcome-confounder-affected-by-the-exposure}

\subsection{Average total effects (ATE)}\label{average-total-effects-ate-1}

The following function \texttt{true.ATE.tv.conf} can be used to run the calculation for the average total effects (ATE).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{true.ATE.time.var.conf }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(}\AttributeTok{interaction =} \ConstantTok{NULL}\NormalTok{) \{}
\NormalTok{  b }\OtherTok{\textless{}{-}} \FunctionTok{param.causal.model.2}\NormalTok{(}\AttributeTok{A.M.interaction =}\NormalTok{ interaction)}
  
  \CommentTok{\# binary outcome (death)}
\NormalTok{  S }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(}\FunctionTok{expand.grid}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{)), }\FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{,}\AttributeTok{n=}\DecValTok{2}\SpecialCharTok{\^{}}\DecValTok{4}\NormalTok{))}
  \FunctionTok{colnames}\NormalTok{(S) }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\StringTok{"male"}\NormalTok{,}\StringTok{"soc\_env"}\NormalTok{,}\StringTok{"L1"}\NormalTok{,}\StringTok{"M"}\NormalTok{,}\StringTok{"sum"}\NormalTok{)}
  \ControlFlowTok{for}\NormalTok{ (n }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{16}\NormalTok{) \{}
\NormalTok{    S[n,}\StringTok{"sum"}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ ( ( ( b[}\StringTok{"b\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                      b[}\StringTok{"b\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                      b[}\StringTok{"b\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                      b[}\StringTok{"b\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+} 
\NormalTok{                      b[}\StringTok{"b\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                      b[}\StringTok{"b\_M\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                      b[}\StringTok{"b\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{*}
\NormalTok{                    (( b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                           b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                           b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                           b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                           b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{ )}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{                    (( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ (b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                              b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                              b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                              b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                              b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{) )}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{                        (( b[}\StringTok{"b\_L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"b\_male\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+}  
\NormalTok{                             b[}\StringTok{"b\_soc\_env\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"b\_A\_L1"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{)}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"L1"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{                        (( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ ( b[}\StringTok{"b\_L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                                   b[}\StringTok{"b\_male\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+}  
\NormalTok{                                   b[}\StringTok{"b\_soc\_env\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                                   b[}\StringTok{"b\_A\_L1"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{))}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] )) ) }\SpecialCharTok{{-}} 
\NormalTok{                    ( ( b[}\StringTok{"b\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                          b[}\StringTok{"b\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                          b[}\StringTok{"b\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                          b[}\StringTok{"b\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+} 
\NormalTok{                          b[}\StringTok{"b\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                          b[}\StringTok{"b\_M\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                          b[}\StringTok{"b\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{*}
\NormalTok{                        (( b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{ )}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{                        (( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ (b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                  b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                  b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                  b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                                  b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{) )}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{                        (( b[}\StringTok{"b\_L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"b\_male\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+}  
\NormalTok{                             b[}\StringTok{"b\_soc\_env\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"b\_A\_L1"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{)}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"L1"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{                        (( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ ( b[}\StringTok{"b\_L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                                   b[}\StringTok{"b\_male\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+}  
\NormalTok{                                   b[}\StringTok{"b\_soc\_env\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                                   b[}\StringTok{"b\_A\_L1"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{))}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] )) ) ) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{])) }
\NormalTok{    \}}
  
\NormalTok{  ATE.death }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(S[,}\StringTok{"sum"}\NormalTok{])}
  
  \CommentTok{\# quantitative outcome (QoL)}
\NormalTok{  S }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(}\FunctionTok{expand.grid}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{)), }\FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{,}\AttributeTok{n=}\DecValTok{2}\SpecialCharTok{\^{}}\DecValTok{4}\NormalTok{))}
  \FunctionTok{colnames}\NormalTok{(S) }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\StringTok{"male"}\NormalTok{,}\StringTok{"soc\_env"}\NormalTok{,}\StringTok{"L1"}\NormalTok{,}\StringTok{"M"}\NormalTok{,}\StringTok{"sum"}\NormalTok{)}
  \ControlFlowTok{for}\NormalTok{ (n }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{16}\NormalTok{) \{}
\NormalTok{    S[n,}\StringTok{"sum"}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ ( ( ( b[}\StringTok{"mu\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                          b[}\StringTok{"c\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                          b[}\StringTok{"c\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                          b[}\StringTok{"c\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+}
\NormalTok{                          b[}\StringTok{"c\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                          b[}\StringTok{"c\_M\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                          b[}\StringTok{"c\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{*}
\NormalTok{                        (( b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{ )}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{                        (( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ (b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                  b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                  b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                  b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                                  b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{) )}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{                        (( b[}\StringTok{"b\_L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"b\_male\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+}  
\NormalTok{                             b[}\StringTok{"b\_soc\_env\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"b\_A\_L1"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{)}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"L1"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{                        (( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ ( b[}\StringTok{"b\_L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                                   b[}\StringTok{"b\_male\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+}  
\NormalTok{                                   b[}\StringTok{"b\_soc\_env\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                                   b[}\StringTok{"b\_A\_L1"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{))}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] )) ) }\SpecialCharTok{{-}} 
\NormalTok{                      ( ( b[}\StringTok{"mu\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                            b[}\StringTok{"c\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                            b[}\StringTok{"c\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                            b[}\StringTok{"c\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+}
\NormalTok{                            b[}\StringTok{"c\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                            b[}\StringTok{"c\_M\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                            b[}\StringTok{"c\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{*}
\NormalTok{                          (( b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                               b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                               b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                               b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                               b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{ )}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{                          (( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ (b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                    b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                    b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                                    b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                                    b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{) )}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] )) ) }\SpecialCharTok{*}
\NormalTok{                        (( b[}\StringTok{"b\_L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"b\_male\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+}  
\NormalTok{                             b[}\StringTok{"b\_soc\_env\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"b\_A\_L1"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{)}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"L1"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{                        (( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ ( b[}\StringTok{"b\_L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                                   b[}\StringTok{"b\_male\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+}  
\NormalTok{                                   b[}\StringTok{"b\_soc\_env\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                                   b[}\StringTok{"b\_A\_L1"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{))}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] )) ) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{])) }
\NormalTok{    \}}
  
\NormalTok{  ATE.qol }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(S[,}\StringTok{"sum"}\NormalTok{])}
  
  \FunctionTok{return}\NormalTok{(}\FunctionTok{list}\NormalTok{(}\AttributeTok{ATE.death =}\NormalTok{ ATE.death, }\AttributeTok{ATE.qol =}\NormalTok{ ATE.qol))}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{true.ATE2.no.inter }\OtherTok{\textless{}{-}} \FunctionTok{true.ATE.time.var.conf}\NormalTok{(}\AttributeTok{interaction =} \DecValTok{0}\NormalTok{)}

\NormalTok{true.ATE2.with.inter }\OtherTok{\textless{}{-}} \FunctionTok{true.ATE.time.var.conf}\NormalTok{(}\AttributeTok{interaction =} \DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

The average total effects \(\text{ATE} = \mathbb{E}(Y_1) - \mathbb{E}(Y_0)\) are:

\begin{itemize}
\tightlist
\item
  0.0752 for death and -6.26 for quality of life without interaction
\item
  0.089282 for death and -8.607 for quality of life with interaction
\end{itemize}

\subsection{Controlled direct effects (CDE)}\label{controlled-direct-effects-cde-1}

The following function \texttt{true.CDE.time.var} can be used to run the calculation for controlled direct effects (CDE).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{true.CDE.time.var }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(}\AttributeTok{interaction =} \ConstantTok{NULL}\NormalTok{) \{}
\NormalTok{  b }\OtherTok{\textless{}{-}} \FunctionTok{param.causal.model.2}\NormalTok{(}\AttributeTok{A.M.interaction =}\NormalTok{ interaction)}
  
  \CommentTok{\# binary outcome (death)}
  \CommentTok{\# we estimate both CDE, fixing do(M) = 0 et do(M) = 1 and using the }
  \CommentTok{\# corresponding lines in the S matrix}
\NormalTok{  S }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(}\FunctionTok{expand.grid}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{)), }\FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{,}\AttributeTok{n=}\DecValTok{2}\SpecialCharTok{\^{}}\DecValTok{3}\NormalTok{))}
  \FunctionTok{colnames}\NormalTok{(S) }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\StringTok{"male"}\NormalTok{,}\StringTok{"soc\_env"}\NormalTok{,}\StringTok{"L1"}\NormalTok{,}\StringTok{"M"}\NormalTok{,}\StringTok{"sum"}\NormalTok{)}
  \ControlFlowTok{for}\NormalTok{ (n }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{16}\NormalTok{) \{}
\NormalTok{    S[n,}\StringTok{"sum"}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ ( (( b[}\StringTok{"b\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                        b[}\StringTok{"b\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                        b[}\StringTok{"b\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                        b[}\StringTok{"b\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+} 
\NormalTok{                        b[}\StringTok{"b\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                        b[}\StringTok{"b\_M\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                        b[}\StringTok{"b\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{*}
\NormalTok{                      (( b[}\StringTok{"b\_L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                           b[}\StringTok{"b\_male\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+}  
\NormalTok{                           b[}\StringTok{"b\_soc\_env\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                           b[}\StringTok{"b\_A\_L1"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{)}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"L1"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{                      (( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ ( b[}\StringTok{"b\_L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                                 b[}\StringTok{"b\_male\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+}  
\NormalTok{                                 b[}\StringTok{"b\_soc\_env\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                                 b[}\StringTok{"b\_A\_L1"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{))}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] )) ) }\SpecialCharTok{{-}} 
\NormalTok{                      (( b[}\StringTok{"b\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                          b[}\StringTok{"b\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                          b[}\StringTok{"b\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                          b[}\StringTok{"b\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+} 
\NormalTok{                          b[}\StringTok{"b\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                          b[}\StringTok{"b\_M\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                          b[}\StringTok{"b\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{*}
\NormalTok{                      (( b[}\StringTok{"b\_L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                           b[}\StringTok{"b\_male\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+}  
\NormalTok{                           b[}\StringTok{"b\_soc\_env\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                           b[}\StringTok{"b\_A\_L1"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{)}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"L1"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{                      (( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ ( b[}\StringTok{"b\_L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                                 b[}\StringTok{"b\_male\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+}  
\NormalTok{                                 b[}\StringTok{"b\_soc\_env\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                                 b[}\StringTok{"b\_A\_L1"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{))}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] )) ) ) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{])) }
\NormalTok{    \}}
  
\NormalTok{  CDE.M0.death }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(S[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{8}\NormalTok{,}\StringTok{"sum"}\NormalTok{])}
\NormalTok{  CDE.M1.death }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(S[}\DecValTok{9}\SpecialCharTok{:}\DecValTok{16}\NormalTok{,}\StringTok{"sum"}\NormalTok{])}
  
  \CommentTok{\# quantitative outcome (QoL)}
  \CommentTok{\# we estimate both CDE, fixing do(M) = 0 et do(M) = 1 and using the }
  \CommentTok{\# corresponding lines in the S matrix}
  \ControlFlowTok{for}\NormalTok{ (n }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{16}\NormalTok{) \{}
\NormalTok{    S[n,}\StringTok{"sum"}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ ( (( b[}\StringTok{"mu\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                        b[}\StringTok{"c\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                        b[}\StringTok{"c\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                        b[}\StringTok{"c\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+} 
\NormalTok{                        b[}\StringTok{"c\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                        b[}\StringTok{"c\_M\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                        b[}\StringTok{"c\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{*}
\NormalTok{                      (( b[}\StringTok{"b\_L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                           b[}\StringTok{"b\_male\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+}  
\NormalTok{                           b[}\StringTok{"b\_soc\_env\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                           b[}\StringTok{"b\_A\_L1"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{)}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"L1"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{                      (( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ ( b[}\StringTok{"b\_L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                                 b[}\StringTok{"b\_male\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+}  
\NormalTok{                                 b[}\StringTok{"b\_soc\_env\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                                 b[}\StringTok{"b\_A\_L1"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{))}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] ))) }\SpecialCharTok{{-}} 
\NormalTok{                      (( b[}\StringTok{"mu\_Y"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                          b[}\StringTok{"c\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                          b[}\StringTok{"c\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                          b[}\StringTok{"c\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+} 
\NormalTok{                          b[}\StringTok{"c\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                          b[}\StringTok{"c\_M\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                          b[}\StringTok{"c\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{*}
\NormalTok{                      (( b[}\StringTok{"b\_L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                           b[}\StringTok{"b\_male\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+}  
\NormalTok{                           b[}\StringTok{"b\_soc\_env\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                           b[}\StringTok{"b\_A\_L1"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{)}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"L1"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{                      (( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ ( b[}\StringTok{"b\_L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                                 b[}\StringTok{"b\_male\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+}  
\NormalTok{                                 b[}\StringTok{"b\_soc\_env\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                                 b[}\StringTok{"b\_A\_L1"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{))}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] )) ) ) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{])) }
\NormalTok{    \}}
  
\NormalTok{  CDE.M0.qol }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(S[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{8}\NormalTok{,}\StringTok{"sum"}\NormalTok{])}
\NormalTok{  CDE.M1.qol }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(S[}\DecValTok{9}\SpecialCharTok{:}\DecValTok{16}\NormalTok{,}\StringTok{"sum"}\NormalTok{])}
  
  \FunctionTok{return}\NormalTok{(}\FunctionTok{list}\NormalTok{(}\AttributeTok{CDE.M0.death =}\NormalTok{ CDE.M0.death, }\AttributeTok{CDE.M1.death =}\NormalTok{ CDE.M1.death, }
              \AttributeTok{CDE.M0.qol =}\NormalTok{ CDE.M0.qol, }\AttributeTok{CDE.M1.qol =}\NormalTok{ CDE.M1.qol))}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{true.CDE2.no.inter }\OtherTok{\textless{}{-}} \FunctionTok{true.CDE.time.var}\NormalTok{(}\AttributeTok{interaction =} \DecValTok{0}\NormalTok{)}

\NormalTok{true.CDE2.with.inter }\OtherTok{\textless{}{-}} \FunctionTok{true.CDE.time.var}\NormalTok{(}\AttributeTok{interaction =} \DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Setting \(do(M=0)\), the controlled direct effects \(\text{CDE}_{M=0} = \mathbb{E}\left(Y_{1,0} \right) - \mathbb{E}\left(Y_{0,0} \right)\) are:

\begin{itemize}
\tightlist
\item
  0.064 for death and -5 for quality of life without interaction
\item
  0.064 for death and -5 for quality of life with interaction
\end{itemize}

Setting \(do(M=1)\), the controlled direct effects \(\text{CDE}_{M=1} = \mathbb{E}\left(Y_{1,1} \right) - \mathbb{E}\left(Y_{0,1} \right)\) are:

\begin{itemize}
\tightlist
\item
  0.064 for death and -5 for quality of life without interaction
\item
  0.094 for death and -10 for quality of life with interaction
\end{itemize}

\subsection{Marginal randomized direct and indirect effects}\label{marginal-randomized-direct-and-indirect-effects-1}

The following function \texttt{true.marg.random.time.var} can be used to run the calculation for the marginal randomized natural direct (marginal MRDE) and indirect effects (marginal MRIE).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{true.marg.random.time.var }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(}\AttributeTok{interaction =} \ConstantTok{NULL}\NormalTok{) \{}
\NormalTok{  b }\OtherTok{\textless{}{-}} \FunctionTok{param.causal.model.2}\NormalTok{(}\AttributeTok{A.M.interaction =}\NormalTok{ interaction)}
  
  \CommentTok{\# marginal distribution of M}
\NormalTok{  M.S }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(}\FunctionTok{expand.grid}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{)), }\FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{,}\AttributeTok{n=}\DecValTok{2}\SpecialCharTok{\^{}}\DecValTok{5}\NormalTok{))}
  \FunctionTok{colnames}\NormalTok{(M.S) }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\StringTok{"male"}\NormalTok{,}\StringTok{"soc\_env"}\NormalTok{,}\StringTok{"L1"}\NormalTok{,}\StringTok{"M"}\NormalTok{,}\StringTok{"A"}\NormalTok{,}\StringTok{"sum"}\NormalTok{)}
  
  \ControlFlowTok{for}\NormalTok{ (n }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{32}\NormalTok{) \{}
\NormalTok{    M.S[n,}\StringTok{"sum"}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ (( b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+}                                                              
\NormalTok{                         b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ M.S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                         b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ M.S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                         b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ M.S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                         b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ M.S[n,}\StringTok{"A"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{( M.S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      (( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ (b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ M.S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ M.S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ M.S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ M.S[n,}\StringTok{"A"}\NormalTok{]) )}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ M.S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      (( b[}\StringTok{"b\_L1"}\NormalTok{] }\SpecialCharTok{+}                                                           
\NormalTok{           b[}\StringTok{"b\_male\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ M.S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+}  
\NormalTok{           b[}\StringTok{"b\_soc\_env\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ M.S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{           b[}\StringTok{"b\_A\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ M.S[n,}\StringTok{"A"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{( M.S[n,}\StringTok{"L1"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      (( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ ( b[}\StringTok{"b\_L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                 b[}\StringTok{"b\_male\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ M.S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+}  
\NormalTok{                 b[}\StringTok{"b\_soc\_env\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ M.S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                 b[}\StringTok{"b\_A\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ M.S[n,}\StringTok{"A"}\NormalTok{]))}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ M.S[n,}\StringTok{"L1"}\NormalTok{] )) }
\NormalTok{    \}}
  
\NormalTok{  M0.A0.L00 }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(M.S[M.S[,}\StringTok{"M"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"A"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&} 
\NormalTok{                         M.S[,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{,}\StringTok{"sum"}\NormalTok{])}
\NormalTok{  M0.A0.L01 }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(M.S[M.S[,}\StringTok{"M"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"A"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&} 
\NormalTok{                         M.S[,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{,}\StringTok{"sum"}\NormalTok{])}
\NormalTok{  M0.A0.L10 }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(M.S[M.S[,}\StringTok{"M"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"A"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&} 
\NormalTok{                         M.S[,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{,}\StringTok{"sum"}\NormalTok{])}
\NormalTok{  M0.A0.L11 }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(M.S[M.S[,}\StringTok{"M"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"A"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&} 
\NormalTok{                         M.S[,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{,}\StringTok{"sum"}\NormalTok{])}
  
\NormalTok{  M1.A0.L00 }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(M.S[M.S[,}\StringTok{"M"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"A"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&} 
\NormalTok{                         M.S[,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{,}\StringTok{"sum"}\NormalTok{])}
\NormalTok{  M1.A0.L01 }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(M.S[M.S[,}\StringTok{"M"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"A"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&} 
\NormalTok{                         M.S[,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{,}\StringTok{"sum"}\NormalTok{])}
\NormalTok{  M1.A0.L10 }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(M.S[M.S[,}\StringTok{"M"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"A"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&} 
\NormalTok{                         M.S[,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{,}\StringTok{"sum"}\NormalTok{])}
\NormalTok{  M1.A0.L11 }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(M.S[M.S[,}\StringTok{"M"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"A"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&} 
\NormalTok{                         M.S[,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{,}\StringTok{"sum"}\NormalTok{])}

\NormalTok{  M0.A1.L00 }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(M.S[M.S[,}\StringTok{"M"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"A"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&} 
\NormalTok{                         M.S[,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{,}\StringTok{"sum"}\NormalTok{])}
\NormalTok{  M0.A1.L01 }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(M.S[M.S[,}\StringTok{"M"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"A"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&} 
\NormalTok{                         M.S[,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{,}\StringTok{"sum"}\NormalTok{])}
\NormalTok{  M0.A1.L10 }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(M.S[M.S[,}\StringTok{"M"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"A"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&} 
\NormalTok{                         M.S[,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{,}\StringTok{"sum"}\NormalTok{])}
\NormalTok{  M0.A1.L11 }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(M.S[M.S[,}\StringTok{"M"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"A"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&} 
\NormalTok{                         M.S[,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{,}\StringTok{"sum"}\NormalTok{])}
  
\NormalTok{  M1.A1.L00 }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(M.S[M.S[,}\StringTok{"M"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"A"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&} 
\NormalTok{                         M.S[,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{,}\StringTok{"sum"}\NormalTok{])}
\NormalTok{  M1.A1.L01 }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(M.S[M.S[,}\StringTok{"M"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"A"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0} \SpecialCharTok{\&} 
\NormalTok{                         M.S[,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{,}\StringTok{"sum"}\NormalTok{])}
\NormalTok{  M1.A1.L10 }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(M.S[M.S[,}\StringTok{"M"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"A"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&} 
\NormalTok{                         M.S[,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{,}\StringTok{"sum"}\NormalTok{])}
\NormalTok{  M1.A1.L11 }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(M.S[M.S[,}\StringTok{"M"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"A"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ M.S[,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1} \SpecialCharTok{\&} 
\NormalTok{                         M.S[,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{,}\StringTok{"sum"}\NormalTok{])}
  
  \CommentTok{\# binary outcome (death)}
\NormalTok{  S }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(}\FunctionTok{expand.grid}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{)), }\FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{,}\AttributeTok{n=}\DecValTok{2}\SpecialCharTok{\^{}}\DecValTok{4}\NormalTok{), }
             \FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{,}\AttributeTok{n=}\DecValTok{2}\SpecialCharTok{\^{}}\DecValTok{4}\NormalTok{), }\FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{,}\AttributeTok{n=}\DecValTok{2}\SpecialCharTok{\^{}}\DecValTok{4}\NormalTok{))}
  \FunctionTok{colnames}\NormalTok{(S) }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\StringTok{"male"}\NormalTok{,}\StringTok{"soc\_env"}\NormalTok{,}\StringTok{"L1"}\NormalTok{,}\StringTok{"M"}\NormalTok{,}\StringTok{"sum.psi11"}\NormalTok{, }
                      \StringTok{"sum.psi10"}\NormalTok{, }\StringTok{"sum.psi00"}\NormalTok{)}
  \ControlFlowTok{for}\NormalTok{ (n }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{16}\NormalTok{) \{}
\NormalTok{    S[n,}\StringTok{"sum.psi11"}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{  ( b[}\StringTok{"b\_Y"}\NormalTok{] }\SpecialCharTok{+}                                           \CommentTok{\# A=1}
\NormalTok{                             b[}\StringTok{"b\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"b\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"b\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"b\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"b\_M\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"b\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{*}
\NormalTok{          ((M1.A1.L00}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+}                \CommentTok{\# A\textquotesingle{}=1}
\NormalTok{              M1.A1.L01}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{              M1.A1.L10}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+} 
\NormalTok{              M1.A1.L11}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) )}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      ((M0.A1.L00}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+}                
\NormalTok{          M0.A1.L01}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M0.A1.L10}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+} 
\NormalTok{          M0.A1.L11}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) )}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      (( b[}\StringTok{"b\_L1"}\NormalTok{] }\SpecialCharTok{+}                                                            \CommentTok{\# A=1}
\NormalTok{           b[}\StringTok{"b\_male\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+}  
\NormalTok{           b[}\StringTok{"b\_soc\_env\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{           b[}\StringTok{"b\_A\_L1"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{)}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"L1"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      (( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ ( b[}\StringTok{"b\_L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                 b[}\StringTok{"b\_male\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+}  
\NormalTok{                 b[}\StringTok{"b\_soc\_env\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                 b[}\StringTok{"b\_A\_L1"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{))}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{])) }
    
\NormalTok{    S[n,}\StringTok{"sum.psi10"}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{  ( b[}\StringTok{"b\_Y"}\NormalTok{] }\SpecialCharTok{+}                                           \CommentTok{\# A=1}
\NormalTok{                             b[}\StringTok{"b\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"b\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"b\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"b\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"b\_M\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"b\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{*}
\NormalTok{      ((M1.A0.L00}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+}                    \CommentTok{\# A\textquotesingle{}=0}
\NormalTok{          M1.A0.L01}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M1.A0.L10}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+} 
\NormalTok{          M1.A0.L11}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) )}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      ((M0.A0.L00}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+}                
\NormalTok{          M0.A0.L01}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M0.A0.L10}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+} 
\NormalTok{          M0.A0.L11}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) )}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      (( b[}\StringTok{"b\_L1"}\NormalTok{] }\SpecialCharTok{+}                                                            \CommentTok{\# A=1}
\NormalTok{           b[}\StringTok{"b\_male\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+}  
\NormalTok{           b[}\StringTok{"b\_soc\_env\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{           b[}\StringTok{"b\_A\_L1"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{)}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"L1"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      (( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ ( b[}\StringTok{"b\_L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                 b[}\StringTok{"b\_male\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+}  
\NormalTok{                 b[}\StringTok{"b\_soc\_env\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                 b[}\StringTok{"b\_A\_L1"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{))}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{])) }
    
\NormalTok{    S[n,}\StringTok{"sum.psi00"}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{  ( b[}\StringTok{"b\_Y"}\NormalTok{] }\SpecialCharTok{+}                                           \CommentTok{\# A=0}
\NormalTok{                             b[}\StringTok{"b\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"b\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"b\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"b\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"b\_M\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"b\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{*}
\NormalTok{      ((M1.A0.L00}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+}                    \CommentTok{\# A\textquotesingle{}=0}
\NormalTok{          M1.A0.L01}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M1.A0.L10}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+} 
\NormalTok{          M1.A0.L11}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) )}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      ((M0.A0.L00}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+}                
\NormalTok{          M0.A0.L01}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M0.A0.L10}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+} 
\NormalTok{          M0.A0.L11}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) )}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      (( b[}\StringTok{"b\_L1"}\NormalTok{] }\SpecialCharTok{+}                                                            \CommentTok{\# A=0}
\NormalTok{           b[}\StringTok{"b\_male\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+}  
\NormalTok{           b[}\StringTok{"b\_soc\_env\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{           b[}\StringTok{"b\_A\_L1"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{)}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"L1"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      (( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ ( b[}\StringTok{"b\_L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                 b[}\StringTok{"b\_male\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+}  
\NormalTok{                 b[}\StringTok{"b\_soc\_env\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                 b[}\StringTok{"b\_A\_L1"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{))}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{])) }
\NormalTok{    \}}
  
\NormalTok{  mrNDE.death }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(S[,}\StringTok{"sum.psi10"}\NormalTok{]) }\SpecialCharTok{{-}} \FunctionTok{sum}\NormalTok{(S[,}\StringTok{"sum.psi00"}\NormalTok{])}
\NormalTok{  mrNIE.death }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(S[,}\StringTok{"sum.psi11"}\NormalTok{]) }\SpecialCharTok{{-}} \FunctionTok{sum}\NormalTok{(S[,}\StringTok{"sum.psi10"}\NormalTok{])}
  
  \CommentTok{\# quantitative outcome (QoL)}
\NormalTok{  S }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(}\FunctionTok{expand.grid}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{)), }\FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{,}\AttributeTok{n=}\DecValTok{2}\SpecialCharTok{\^{}}\DecValTok{4}\NormalTok{), }
             \FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{,}\AttributeTok{n=}\DecValTok{2}\SpecialCharTok{\^{}}\DecValTok{4}\NormalTok{), }\FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{,}\AttributeTok{n=}\DecValTok{2}\SpecialCharTok{\^{}}\DecValTok{4}\NormalTok{))}
  \FunctionTok{colnames}\NormalTok{(S) }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\StringTok{"male"}\NormalTok{,}\StringTok{"soc\_env"}\NormalTok{,}\StringTok{"L1"}\NormalTok{,}\StringTok{"M"}\NormalTok{,}\StringTok{"sum.psi11"}\NormalTok{, }\StringTok{"sum.psi10"}\NormalTok{, }
                      \StringTok{"sum.psi00"}\NormalTok{)}
  \ControlFlowTok{for}\NormalTok{ (n }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{16}\NormalTok{) \{}
\NormalTok{    S[n,}\StringTok{"sum.psi11"}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{  ( b[}\StringTok{"mu\_Y"}\NormalTok{] }\SpecialCharTok{+}                                          \CommentTok{\# A=1}
\NormalTok{                             b[}\StringTok{"c\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"c\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"c\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"c\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"c\_M\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"c\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{*}
\NormalTok{      ((M1.A1.L00}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+}                    \CommentTok{\# A\textquotesingle{}=1}
\NormalTok{          M1.A1.L01}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M1.A1.L10}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+} 
\NormalTok{          M1.A1.L11}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) )}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      ((M0.A1.L00}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+}                
\NormalTok{          M0.A1.L01}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M0.A1.L10}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+} 
\NormalTok{          M0.A1.L11}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) )}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      (( b[}\StringTok{"b\_L1"}\NormalTok{] }\SpecialCharTok{+}                                                            \CommentTok{\# A=1}
\NormalTok{           b[}\StringTok{"b\_male\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+}  
\NormalTok{           b[}\StringTok{"b\_soc\_env\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{           b[}\StringTok{"b\_A\_L1"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{)}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"L1"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      (( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ ( b[}\StringTok{"b\_L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                 b[}\StringTok{"b\_male\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+}  
\NormalTok{                 b[}\StringTok{"b\_soc\_env\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                 b[}\StringTok{"b\_A\_L1"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{))}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{])) }
    
\NormalTok{    S[n,}\StringTok{"sum.psi10"}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{  ( b[}\StringTok{"mu\_Y"}\NormalTok{] }\SpecialCharTok{+}                                          \CommentTok{\# A=1}
\NormalTok{                             b[}\StringTok{"c\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"c\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"c\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"c\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"c\_M\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"c\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{*}
\NormalTok{      ((M1.A0.L00}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+}                    \CommentTok{\# A\textquotesingle{}=0}
\NormalTok{          M1.A0.L01}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M1.A0.L10}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+} 
\NormalTok{          M1.A0.L11}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) )}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      ((M0.A0.L00}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+}                
\NormalTok{          M0.A0.L01}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M0.A0.L10}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+} 
\NormalTok{          M0.A0.L11}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) )}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      (( b[}\StringTok{"b\_L1"}\NormalTok{] }\SpecialCharTok{+}                                                            \CommentTok{\# A=1}
\NormalTok{           b[}\StringTok{"b\_male\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+}  
\NormalTok{           b[}\StringTok{"b\_soc\_env\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{           b[}\StringTok{"b\_A\_L1"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{)}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"L1"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      (( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ ( b[}\StringTok{"b\_L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                 b[}\StringTok{"b\_male\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+}  
\NormalTok{                 b[}\StringTok{"b\_soc\_env\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                 b[}\StringTok{"b\_A\_L1"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{))}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{])) }
    
\NormalTok{    S[n,}\StringTok{"sum.psi00"}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{  ( b[}\StringTok{"mu\_Y"}\NormalTok{] }\SpecialCharTok{+}                                          \CommentTok{\# A=0}
\NormalTok{                             b[}\StringTok{"c\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"c\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"c\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"c\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"c\_M\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"c\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{*}
\NormalTok{      ((M1.A0.L00}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+}                    \CommentTok{\# A\textquotesingle{}=0}
\NormalTok{          M1.A0.L01}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M1.A0.L10}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+} 
\NormalTok{          M1.A0.L11}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) )}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      ((M0.A0.L00}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+}                
\NormalTok{          M0.A0.L01}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{          M0.A0.L10}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+} 
\NormalTok{          M0.A0.L11}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}\SpecialCharTok{*}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{]}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) )}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      (( b[}\StringTok{"b\_L1"}\NormalTok{] }\SpecialCharTok{+}                                                            \CommentTok{\# A=0}
\NormalTok{           b[}\StringTok{"b\_male\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+}  
\NormalTok{           b[}\StringTok{"b\_soc\_env\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{           b[}\StringTok{"b\_A\_L1"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{)}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"L1"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      (( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ ( b[}\StringTok{"b\_L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                 b[}\StringTok{"b\_male\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+}  
\NormalTok{                 b[}\StringTok{"b\_soc\_env\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                 b[}\StringTok{"b\_A\_L1"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{))}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{])) }
\NormalTok{    \}}
  
\NormalTok{  mrNDE.qol }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(S[,}\StringTok{"sum.psi10"}\NormalTok{]) }\SpecialCharTok{{-}} \FunctionTok{sum}\NormalTok{(S[,}\StringTok{"sum.psi00"}\NormalTok{])}
\NormalTok{  mrNIE.qol }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(S[,}\StringTok{"sum.psi11"}\NormalTok{]) }\SpecialCharTok{{-}} \FunctionTok{sum}\NormalTok{(S[,}\StringTok{"sum.psi10"}\NormalTok{])}
  
  \FunctionTok{return}\NormalTok{(}\FunctionTok{list}\NormalTok{(}\AttributeTok{mrNDE.death =}\NormalTok{ mrNDE.death, }\AttributeTok{mrNIE.death =}\NormalTok{ mrNIE.death, }
              \AttributeTok{mrNDE.qol =}\NormalTok{ mrNDE.qol, }\AttributeTok{mrNIE.qol =}\NormalTok{ mrNIE.qol))}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{true.marg.random2.no.inter }\OtherTok{\textless{}{-}} \FunctionTok{true.marg.random.time.var}\NormalTok{(}\AttributeTok{interaction =} \DecValTok{0}\NormalTok{)}

\NormalTok{true.marg.random2.with.inter }\OtherTok{\textless{}{-}} \FunctionTok{true.marg.random.time.var}\NormalTok{(}\AttributeTok{interaction =} \DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

The marginal randomized direct effect \(\text{MRDE}=\mathbb{E}\left(Y_{1,G_{0|L(0)}}\right) - \mathbb{E}\left(Y_{0,G_{0|L(0)}}\right)\) and the marginal randomized indirect effect \(\text{MRIE}=\mathbb{E}\left(Y_{1,G_{1|L(0)}}\right) - \mathbb{E}\left(Y_{1,G_{0|L(0)}}\right)\) are respectively:

\begin{itemize}
\tightlist
\item
  0.064 and 0.0112 for death without interaction
\item
  0.073882 and 0.0154000000000001 for death with interaction
\item
  -4.99999999999999 and -1.26 for quality of life without interaction
\item
  -6.64699999999998 and -1.96 for quality of life with interaction
\end{itemize}

\subsection{Conditional randomized direct and indirect effects}\label{conditional-randomized-direct-and-indirect-effects-1}

The following function \texttt{true.cond.random.time.var} can be used to run the calculation for the conditional randomized natural direct (CRDE) and the conditional randomized indirect effects (CRIE).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{true.cond.random.time.var }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(}\AttributeTok{interaction =} \ConstantTok{NULL}\NormalTok{) \{}
\NormalTok{  b }\OtherTok{\textless{}{-}} \FunctionTok{param.causal.model.2}\NormalTok{(}\AttributeTok{A.M.interaction =}\NormalTok{ interaction)}
  
  \CommentTok{\# binary outcome (death)}
\NormalTok{  S }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(}\FunctionTok{expand.grid}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{)), }\FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{,}\AttributeTok{n=}\DecValTok{2}\SpecialCharTok{\^{}}\DecValTok{4}\NormalTok{), }
             \FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{,}\AttributeTok{n=}\DecValTok{2}\SpecialCharTok{\^{}}\DecValTok{4}\NormalTok{), }\FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{,}\AttributeTok{n=}\DecValTok{2}\SpecialCharTok{\^{}}\DecValTok{4}\NormalTok{))}
  \FunctionTok{colnames}\NormalTok{(S) }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\StringTok{"male"}\NormalTok{,}\StringTok{"soc\_env"}\NormalTok{,}\StringTok{"L1"}\NormalTok{,}\StringTok{"M"}\NormalTok{,}\StringTok{"sum.psi11"}\NormalTok{, }\StringTok{"sum.psi10"}\NormalTok{, }
                      \StringTok{"sum.psi00"}\NormalTok{)}
  \ControlFlowTok{for}\NormalTok{ (n }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{16}\NormalTok{) \{}
\NormalTok{    S[n,}\StringTok{"sum.psi11"}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{  ( b[}\StringTok{"b\_Y"}\NormalTok{] }\SpecialCharTok{+}                                           \CommentTok{\# A=1}
\NormalTok{                             b[}\StringTok{"b\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"b\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"b\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"b\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"b\_M\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"b\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{*}
\NormalTok{      (( b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+}                                                             \CommentTok{\# A\textquotesingle{}=1}
\NormalTok{           b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{           b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{           b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{           b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{ )}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      (( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ (b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{ ) )}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      (( b[}\StringTok{"b\_L1"}\NormalTok{] }\SpecialCharTok{+}                                                            \CommentTok{\# A=1}
\NormalTok{           b[}\StringTok{"b\_male\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+}  
\NormalTok{           b[}\StringTok{"b\_soc\_env\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{           b[}\StringTok{"b\_A\_L1"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{)}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"L1"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      (( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ ( b[}\StringTok{"b\_L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                 b[}\StringTok{"b\_male\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+}  
\NormalTok{                 b[}\StringTok{"b\_soc\_env\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                 b[}\StringTok{"b\_A\_L1"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{))}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{])) }
    
\NormalTok{    S[n,}\StringTok{"sum.psi10"}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{  ( b[}\StringTok{"b\_Y"}\NormalTok{] }\SpecialCharTok{+}                                           \CommentTok{\# A=1}
\NormalTok{                             b[}\StringTok{"b\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"b\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"b\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"b\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"b\_M\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"b\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{*}
\NormalTok{      (( b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+}                                                             \CommentTok{\# A\textquotesingle{}=0}
\NormalTok{           b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{           b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{           b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{           b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{ )}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      (( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ (b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{ ) )}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      (( b[}\StringTok{"b\_L1"}\NormalTok{] }\SpecialCharTok{+}                                                            \CommentTok{\# A=1}
\NormalTok{           b[}\StringTok{"b\_male\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+}  
\NormalTok{           b[}\StringTok{"b\_soc\_env\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{           b[}\StringTok{"b\_A\_L1"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{)}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"L1"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      (( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ ( b[}\StringTok{"b\_L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                 b[}\StringTok{"b\_male\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+}  
\NormalTok{                 b[}\StringTok{"b\_soc\_env\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                 b[}\StringTok{"b\_A\_L1"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{))}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{])) }
    
\NormalTok{    S[n,}\StringTok{"sum.psi00"}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{  ( b[}\StringTok{"b\_Y"}\NormalTok{] }\SpecialCharTok{+}                                           \CommentTok{\# A=0}
\NormalTok{                             b[}\StringTok{"b\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"b\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"b\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"b\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"b\_M\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"b\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{*}
\NormalTok{      (( b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+}                                                             \CommentTok{\# A\textquotesingle{}=0}
\NormalTok{           b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{           b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{           b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{           b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{ )}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      (( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ (b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{ ) )}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      (( b[}\StringTok{"b\_L1"}\NormalTok{] }\SpecialCharTok{+}                                                            \CommentTok{\# A=0}
\NormalTok{           b[}\StringTok{"b\_male\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+}  
\NormalTok{           b[}\StringTok{"b\_soc\_env\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{           b[}\StringTok{"b\_A\_L1"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{)}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"L1"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      (( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ ( b[}\StringTok{"b\_L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                 b[}\StringTok{"b\_male\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+}  
\NormalTok{                 b[}\StringTok{"b\_soc\_env\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                 b[}\StringTok{"b\_A\_L1"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{))}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{]))}
\NormalTok{    \}}
  
\NormalTok{  crNDE.death }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(S[,}\StringTok{"sum.psi10"}\NormalTok{]) }\SpecialCharTok{{-}} \FunctionTok{sum}\NormalTok{(S[,}\StringTok{"sum.psi00"}\NormalTok{])}
\NormalTok{  crNIE.death }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(S[,}\StringTok{"sum.psi11"}\NormalTok{]) }\SpecialCharTok{{-}} \FunctionTok{sum}\NormalTok{(S[,}\StringTok{"sum.psi10"}\NormalTok{])}
  
  \CommentTok{\# quantitative outcome (QoL)}
\NormalTok{  S }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(}\FunctionTok{expand.grid}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{)), }\FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{,}\AttributeTok{n=}\DecValTok{2}\SpecialCharTok{\^{}}\DecValTok{4}\NormalTok{), }
             \FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{,}\AttributeTok{n=}\DecValTok{2}\SpecialCharTok{\^{}}\DecValTok{4}\NormalTok{), }\FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{,}\AttributeTok{n=}\DecValTok{2}\SpecialCharTok{\^{}}\DecValTok{4}\NormalTok{))}
  \FunctionTok{colnames}\NormalTok{(S) }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\StringTok{"male"}\NormalTok{,}\StringTok{"soc\_env"}\NormalTok{,}\StringTok{"L1"}\NormalTok{,}\StringTok{"M"}\NormalTok{,}\StringTok{"sum.psi11"}\NormalTok{, }\StringTok{"sum.psi10"}\NormalTok{, }
                      \StringTok{"sum.psi00"}\NormalTok{)}
  \ControlFlowTok{for}\NormalTok{ (n }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{16}\NormalTok{) \{}
\NormalTok{    S[n,}\StringTok{"sum.psi11"}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{  ( b[}\StringTok{"mu\_Y"}\NormalTok{] }\SpecialCharTok{+}                                          \CommentTok{\# A=1}
\NormalTok{                             b[}\StringTok{"c\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"c\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"c\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"c\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"c\_M\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"c\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{*}
\NormalTok{      (( b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+}                                                             \CommentTok{\# A\textquotesingle{}=1}
\NormalTok{           b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{           b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{           b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{           b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{ )}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      (( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ (b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{ ) )}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      (( b[}\StringTok{"b\_L1"}\NormalTok{] }\SpecialCharTok{+}                                                            \CommentTok{\# A=1}
\NormalTok{           b[}\StringTok{"b\_male\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+}  
\NormalTok{           b[}\StringTok{"b\_soc\_env\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{           b[}\StringTok{"b\_A\_L1"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{)}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"L1"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      (( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ ( b[}\StringTok{"b\_L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                 b[}\StringTok{"b\_male\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+}  
\NormalTok{                 b[}\StringTok{"b\_soc\_env\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                 b[}\StringTok{"b\_A\_L1"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{))}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{])) }
    
\NormalTok{    S[n,}\StringTok{"sum.psi10"}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{  ( b[}\StringTok{"mu\_Y"}\NormalTok{] }\SpecialCharTok{+}                                          \CommentTok{\# A=1}
\NormalTok{                             b[}\StringTok{"c\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"c\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"c\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"c\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"c\_M\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"c\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{*}
\NormalTok{      (( b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+}                                                             \CommentTok{\# A\textquotesingle{}=0}
\NormalTok{           b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{           b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{           b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{           b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{ )}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      (( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ (b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{ ) )}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      (( b[}\StringTok{"b\_L1"}\NormalTok{] }\SpecialCharTok{+}                                                            \CommentTok{\# A=1}
\NormalTok{           b[}\StringTok{"b\_male\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+}  
\NormalTok{           b[}\StringTok{"b\_soc\_env\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{           b[}\StringTok{"b\_A\_L1"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{)}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"L1"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      (( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ ( b[}\StringTok{"b\_L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                 b[}\StringTok{"b\_male\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+}  
\NormalTok{                 b[}\StringTok{"b\_soc\_env\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                 b[}\StringTok{"b\_A\_L1"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{1}\NormalTok{))}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{])) }
    
\NormalTok{    S[n,}\StringTok{"sum.psi00"}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{  ( b[}\StringTok{"mu\_Y"}\NormalTok{] }\SpecialCharTok{+}                                          \CommentTok{\# A=0}
\NormalTok{                             b[}\StringTok{"c\_male\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"c\_soc\_env\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"c\_A\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{+} 
\NormalTok{                             b[}\StringTok{"c\_L1\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"c\_M\_Y"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                             b[}\StringTok{"c\_AM\_Y"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0} \SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ b[}\StringTok{"A.M.inter"}\NormalTok{] ) }\SpecialCharTok{*}
\NormalTok{      (( b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+}                                                             \CommentTok{\# A\textquotesingle{}=0}
\NormalTok{           b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{           b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{           b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{           b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{ )}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      (( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ (b[}\StringTok{"b\_M"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                b[}\StringTok{"b\_male\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                b[}\StringTok{"b\_soc\_env\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+} 
\NormalTok{                b[}\StringTok{"b\_L1\_M"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                b[}\StringTok{"b\_A\_M"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{ ) )}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"M"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      (( b[}\StringTok{"b\_L1"}\NormalTok{] }\SpecialCharTok{+}                                                            \CommentTok{\# A=0}
\NormalTok{           b[}\StringTok{"b\_male\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+}  
\NormalTok{           b[}\StringTok{"b\_soc\_env\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{           b[}\StringTok{"b\_A\_L1"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{)}\SpecialCharTok{\^{}}\NormalTok{( S[n,}\StringTok{"L1"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      (( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ ( b[}\StringTok{"b\_L1"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                 b[}\StringTok{"b\_male\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{] }\SpecialCharTok{+}  
\NormalTok{                 b[}\StringTok{"b\_soc\_env\_L1"}\NormalTok{] }\SpecialCharTok{*}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{] }\SpecialCharTok{+}
\NormalTok{                 b[}\StringTok{"b\_A\_L1"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{0}\NormalTok{))}\SpecialCharTok{\^{}}\NormalTok{( }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"L1"}\NormalTok{] )) }\SpecialCharTok{*}
\NormalTok{      ((b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_male"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"male"}\NormalTok{])) }\SpecialCharTok{*} 
\NormalTok{      ((b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(S[n,}\StringTok{"soc\_env"}\NormalTok{])) }\SpecialCharTok{*}
\NormalTok{      ((}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ b[}\StringTok{"p\_L0\_soc\_env"}\NormalTok{])}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ S[n,}\StringTok{"soc\_env"}\NormalTok{])) }
\NormalTok{    \}}
  
\NormalTok{  crNDE.qol }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(S[,}\StringTok{"sum.psi10"}\NormalTok{]) }\SpecialCharTok{{-}} \FunctionTok{sum}\NormalTok{(S[,}\StringTok{"sum.psi00"}\NormalTok{])}
\NormalTok{  crNIE.qol }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(S[,}\StringTok{"sum.psi11"}\NormalTok{]) }\SpecialCharTok{{-}} \FunctionTok{sum}\NormalTok{(S[,}\StringTok{"sum.psi10"}\NormalTok{])}
  
  \FunctionTok{return}\NormalTok{(}\FunctionTok{list}\NormalTok{(}\AttributeTok{crNDE.death =}\NormalTok{ crNDE.death, }\AttributeTok{crNIE.death =}\NormalTok{ crNIE.death, }
              \AttributeTok{crNDE.qol =}\NormalTok{ crNDE.qol, }\AttributeTok{crNIE.qol =}\NormalTok{ crNIE.qol))}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{true.cond.random2.no.inter }\OtherTok{\textless{}{-}} \FunctionTok{true.cond.random.time.var}\NormalTok{(}\AttributeTok{interaction =} \DecValTok{0}\NormalTok{)}

\NormalTok{true.cond.random2.with.inter }\OtherTok{\textless{}{-}} \FunctionTok{true.cond.random.time.var}\NormalTok{(}\AttributeTok{interaction =} \DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

The conditional randomized direct effect \(\text{CRDE}=\mathbb{E}\left(Y_{1,\Gamma_{0\mid L(0),L(1)}}\right) - \mathbb{E}\left(Y_{0,\Gamma_{0\mid L(0),L(1)}}\right)\) and conditional randomized indirect effect \(\text{CRIE}=\mathbb{E}\left(Y_{1,\Gamma_{1\mid L(0),L(1)}}\right) - \mathbb{E}\left(Y_{1,\Gamma_{0\mid L(0),L(1)}}\right)\) are respectively:

\begin{itemize}
\tightlist
\item
  0.0672 and 0.00800000000000001 for death without interaction,
\item
  0.078282 and 0.011 for death with interaction,
\item
  -5.36 and -0.900000000000006 for quality of life without interaction,
\item
  -7.207 and -1.40000000000001 for quality of life with interaction.
\end{itemize}

\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 4\tabcolsep) * \real{0.2273}}
  >{\centering\arraybackslash}p{(\columnwidth - 4\tabcolsep) * \real{0.4015}}
  >{\centering\arraybackslash}p{(\columnwidth - 4\tabcolsep) * \real{0.3712}}@{}}
\caption{True values with time varying confounders}\tabularnewline
\toprule\noalign{}
\begin{minipage}[b]{\linewidth}\raggedright
Effects
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
Without \(A*M\) interaction
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
with \(A*M\) interaction
\end{minipage} \\
\midrule\noalign{}
\endfirsthead
\toprule\noalign{}
\begin{minipage}[b]{\linewidth}\raggedright
Effects
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
Without \(A*M\) interaction
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
with \(A*M\) interaction
\end{minipage} \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
\textbf{Binary outcome} & & \\
Average total effect (ATE) & 0.0752 & 0.089282 \\
& & \\
Controlled direct effect (CDE) & & \\
- CDE, setting do(M=0) & 0.064 & 0.064 \\
- CDE, setting do(M=1) & 0.064 & 0.094 \\
& & \\
Marginal randomized & & \\
- marginal rNDE & 0.064 & 0.073882 \\
- marginal rNIE & 0.0112 & 0.0154000000000001 \\
& & \\
Conditional randomized & & \\
- conditional rNDE & 0.0672 & 0.078282 \\
- conditional rNIE & 0.00800000000000001 & 0.011 \\
& & \\
\textbf{Quantitative outcome} & & \\
Average total effect (ATE) & -6.26 & -8.607 \\
& & \\
Controlled direct effect (CDE) & & \\
- CDE, setting do(M=0) & -5 & -5 \\
- CDE, setting do(M=1) & -5 & -10 \\
& & \\
Marginal randomized & & \\
- marginal rNDE & -4.99999999999999 & -6.64699999999998 \\
- marginal rNIE & -1.26 & -1.96 \\
& & \\
Conditional randomized & & \\
- conditional rNDE & -5.36 & -7.207 \\
- conditional rNIE & -0.900000000000006 & -1.40000000000001 \\
\end{longtable}

\phantomsection\label{refs}
\begin{CSLReferences}{1}{0}
\bibitem[\citeproctext]{ref-daniel2013}
Daniel, R M, S N Cousens, B L De Stavola, M G Kenward, and J A C Sterne. 2013. {``Methods for Dealing with Time-Dependent Confounding.''} \emph{Statistics in Medicine} 32 (9): 1584--1618.

\bibitem[\citeproctext]{ref-Diaz2020}
Díaz, I, N S Hejazi, K E Rudolph, and M J van Der Laan. 2020. {``{Nonparametric efficient causal mediation with intermediate confounders}.''} \emph{Biometrika} 108 (3): 627--41. \url{https://doi.org/10.1093/biomet/asaa085}.

\bibitem[\citeproctext]{ref-Hejazi2022}
Hejazi, Nima S., Kara E. Rudolph, and Iván Díaz. 2022. {```Medoutcon`: Nonparametric Efficient Causal Mediation Analysis with Machine Learning in `r`.''} \emph{Journal of Open Source Software} 7 (69): 3979. \url{https://doi.org/10.21105/joss.03979}.

\bibitem[\citeproctext]{ref-Iacobucci2008}
Iacobucci, Dawn. 2008. \emph{Mediation Analysis}. Thousand Oaks, California: Sage.

\bibitem[\citeproctext]{ref-Jak2023}
Jak, Suzanne and Jorgensen, Terrence D. 2024. {``A `Lavaan` Compendium for Structural Equation Modeling in Educational Research.''} \url{https://tdjorgensen.github.io/SEM-in-Ed-compendium/}.

\bibitem[\citeproctext]{ref-Jiang2023}
Jiang, Ge. 2023. {``R Cookbook for Structural Equation Modeling.''} \url{https://gabriellajg.github.io/EPSY-579-R-Cookbook-for-SEM/}.

\bibitem[\citeproctext]{ref-vanderlaan_book2011}
Laan, Mark J. van der, and Sherri Rose. 2011. \emph{Targeted Learning: Causal Inference for Observational and Experimental Data.} 1st ed. Springer Series in Statistics. New York, NY: Springer.

\bibitem[\citeproctext]{ref-lange2012}
Lange, Theis, Stijn Vansteelandt, and Maarten Bekaert. 2012. {``A Simple Unified Approach for Estimating Natural Direct and Indirect Effects.''} \emph{American Journal of Epidemiology} 176 (3): 190--95.

\bibitem[\citeproctext]{ref-lin2017}
Lin, Sheng-Hsuan, Jessica Young, Roger Logan, Eric J. Tchetgen Tchetgen, and Tyler J VanderWeele. 2017. {``Parametric Mediational g-Formula Approach to Mediation Analysis with Time-Varying Exposures, Mediators, and Confounders.''} \emph{Epidemiology} 28 (2): 266--74.

\bibitem[\citeproctext]{ref-naimi2020}
Naimi, Ashley I, and Brian W Whitcomb. 2020. {``Estimating Risk Ratios and Risk Differences Using Regression.''} \emph{American Journal of Epidemiology} 189 (6): 508--10.

\bibitem[\citeproctext]{ref-robins1986}
Robins, James. 1986. {``A New Approach to Causal Inference in Mortality Studies with a Sustained Exposure Period---Application to Control of the Healthy Worker Survivor Effect.''} \emph{Mathematical Modelling} 7 (9): 1393--1512.

\bibitem[\citeproctext]{ref-taubman2009}
Taubman, Sarah L, James M Robins, Murray A Mittleman, and Miguel A Hernán. 2009. {``Intervening on Risk Factors for Coronary Heart Disease: An Application of the Parametric g-Formula.''} \emph{International Journal of Epidemiology} 38 (6): 1599--1611.

\bibitem[\citeproctext]{ref-valeri2013}
Valeri, Linda, and Tyler J VanderWeele. 2013. {``Mediation Analysis Allowing for Exposure-Mediator Interactions and Causal Interpretation: Theoretical Assumptions and Implementation with SAS and SPSS Macros.''} \emph{Psycol Methods} 18 (2): 137--50.

\bibitem[\citeproctext]{ref-vanderweele2009}
VanderWeele, Tyler J. 2009. {``Marginal Structural Models for the Estimation of Direct and Indirect Effects.''} \emph{Epidemiology} 20: 18--26.

\bibitem[\citeproctext]{ref-vanderweele2013}
---------. 2013. {``A Three-Way Decomposition of a Total Effect into Direct, Indirect, and Interactive Effects.''} \emph{Epidemiology} 13: 224--32.

\bibitem[\citeproctext]{ref-vanderweele2014}
---------. 2014. {``A Unification of Mediation and Interaction. A 4-Way Decomposition.''} \emph{Epidemiology} 25: 749--61.

\bibitem[\citeproctext]{ref-vanderweele2016}
VanderWeele, Tyler J, and Eric J Tchetgen Tchetgen. 2017. {``Mediation Analysis with Time Varying Exposures and Mediators.''} \emph{J R Stat Soc Series B Stat Methodol} 79 (3): 917--38.

\bibitem[\citeproctext]{ref-zheng2017longitudinal}
Zheng, Wenjing, and Mark van der Laan. 2017. {``Longitudinal Mediation Analysis with Time-Varying Mediators and Exposures, with Application to Survival Outcomes.''} \emph{Journal of Causal Inference} 5 (2).

\end{CSLReferences}

\end{document}
