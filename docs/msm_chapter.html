<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 8 Marginal structural models | Mediation Workshop</title>
  <meta name="description" content="Expanse project - Mediation workshop. Online complementary document with practical examples in R." />
  <meta name="generator" content="bookdown 0.40 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 8 Marginal structural models | Mediation Workshop" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="Expanse project - Mediation workshop. Online complementary document with practical examples in R." />
  <meta name="github-repo" content="mediation_workshop" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 8 Marginal structural models | Mediation Workshop" />
  
  <meta name="twitter:description" content="Expanse project - Mediation workshop. Online complementary document with practical examples in R." />
  

<meta name="author" content="Benoît Lepage" />


<meta name="date" content="2024-10-24" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="ChapIptw.html"/>
<link rel="next" href="chap_tmle.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>
<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Mediation workshop</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a></li>
<li class="chapter" data-level="2" data-path="software.html"><a href="software.html"><i class="fa fa-check"></i><b>2</b> Software</a></li>
<li class="chapter" data-level="3" data-path="data-sets.html"><a href="data-sets.html"><i class="fa fa-check"></i><b>3</b> Data sets</a>
<ul>
<li class="chapter" data-level="3.1" data-path="data-sets.html"><a href="data-sets.html#general-presentation-of-the-data-used-in-our-examples"><i class="fa fa-check"></i><b>3.1</b> General presentation of the data used in our examples</a></li>
<li class="chapter" data-level="3.2" data-path="data-sets.html"><a href="data-sets.html#data-generating-mechanisms"><i class="fa fa-check"></i><b>3.2</b> Data generating mechanisms</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="ChapBaronKennySem.html"><a href="ChapBaronKennySem.html"><i class="fa fa-check"></i><b>4</b> Baron and Kenny, structural equation models</a>
<ul>
<li class="chapter" data-level="4.1" data-path="ChapBaronKennySem.html"><a href="ChapBaronKennySem.html#baron-and-kenny-approach"><i class="fa fa-check"></i><b>4.1</b> Baron and Kenny approach</a></li>
<li class="chapter" data-level="4.2" data-path="ChapBaronKennySem.html"><a href="ChapBaronKennySem.html#path-analysis-and-structural-equation-modeling"><i class="fa fa-check"></i><b>4.2</b> Path analysis and Structural Equation Modeling</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="ChapBaronKennySem.html"><a href="ChapBaronKennySem.html#first-application-without-intermediate-confouding-affected-by-the-exposure"><i class="fa fa-check"></i><b>4.2.1</b> First application, without intermediate confouding affected by the exposure</a></li>
<li class="chapter" data-level="4.2.2" data-path="ChapBaronKennySem.html"><a href="ChapBaronKennySem.html#dealing-with-categorical-endogenous-variables"><i class="fa fa-check"></i><b>4.2.2</b> Dealing with categorical endogenous variables</a></li>
<li class="chapter" data-level="4.2.3" data-path="ChapBaronKennySem.html"><a href="ChapBaronKennySem.html#application-with-intermediate-confounding-affected-by-the-exposure"><i class="fa fa-check"></i><b>4.2.3</b> Application with intermediate confounding affected by the exposure</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="ChapTradRegModels.html"><a href="ChapTradRegModels.html"><i class="fa fa-check"></i><b>5</b> Traditional regression models</a>
<ul>
<li class="chapter" data-level="5.1" data-path="ChapTradRegModels.html"><a href="ChapTradRegModels.html#estimation-of-the-average-total-effect-ate"><i class="fa fa-check"></i><b>5.1</b> Estimation of the Average Total Effect (ATE)</a></li>
<li class="chapter" data-level="5.2" data-path="ChapTradRegModels.html"><a href="ChapTradRegModels.html#trad2way"><i class="fa fa-check"></i><b>5.2</b> Two-way decomposition</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="ChapTradRegModels.html"><a href="ChapTradRegModels.html#trad2waycde"><i class="fa fa-check"></i><b>5.2.1</b> Controlled Direct Effect</a></li>
<li class="chapter" data-level="5.2.2" data-path="ChapTradRegModels.html"><a href="ChapTradRegModels.html#trad2waynatural"><i class="fa fa-check"></i><b>5.2.2</b> Natural Direct and Indirect effects</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="ChapTradRegModels.html"><a href="ChapTradRegModels.html#trad3way"><i class="fa fa-check"></i><b>5.3</b> Three-way decomposition</a></li>
<li class="chapter" data-level="5.4" data-path="ChapTradRegModels.html"><a href="ChapTradRegModels.html#four-way-decomposition"><i class="fa fa-check"></i><b>5.4</b> Four-way decomposition</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="ChapGcomp.html"><a href="ChapGcomp.html"><i class="fa fa-check"></i><b>6</b> G-computation</a>
<ul>
<li class="chapter" data-level="6.1" data-path="ChapGcomp.html"><a href="ChapGcomp.html#estimation-of-the-average-total-effect-ate-1"><i class="fa fa-check"></i><b>6.1</b> Estimation of the Average Total Effect (ATE)</a></li>
<li class="chapter" data-level="6.2" data-path="ChapGcomp.html"><a href="ChapGcomp.html#estimation-of-controlled-direct-effects-cde"><i class="fa fa-check"></i><b>6.2</b> Estimation of Controlled Direct Effects (CDE)</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="ChapGcomp.html"><a href="ChapGcomp.html#ChapGcomp-CDE-param"><i class="fa fa-check"></i><b>6.2.1</b> Parametric g-computation</a></li>
<li class="chapter" data-level="6.2.2" data-path="ChapGcomp.html"><a href="ChapGcomp.html#ChapGcomp-CDE-ICE"><i class="fa fa-check"></i><b>6.2.2</b> G-computation by iterative conditional expectation</a></li>
<li class="chapter" data-level="6.2.3" data-path="ChapGcomp.html"><a href="ChapGcomp.html#sequential-g-estimator"><i class="fa fa-check"></i><b>6.2.3</b> Sequential g-estimator</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="ChapGcomp.html"><a href="ChapGcomp.html#estimation-of-natural-direct-nde-and-indirect-effects-nie"><i class="fa fa-check"></i><b>6.3</b> Estimation of Natural Direct (NDE) and Indirect Effects (NIE)</a>
<ul>
<li class="chapter" data-level="6.3.1" data-path="ChapGcomp.html"><a href="ChapGcomp.html#simple-plug-in-estimator"><i class="fa fa-check"></i><b>6.3.1</b> Simple “plug-in” estimator</a></li>
<li class="chapter" data-level="6.3.2" data-path="ChapGcomp.html"><a href="ChapGcomp.html#using-the-mediation-r-package"><i class="fa fa-check"></i><b>6.3.2</b> Using the <code>mediation</code> R package</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="ChapGcomp.html"><a href="ChapGcomp.html#estimation-of-marginal-randomizedinterventional-natural-direct-mrde-and-indirect-effects-mrie"><i class="fa fa-check"></i><b>6.4</b> Estimation of “Marginal” Randomized/Interventional Natural Direct (MRDE) and Indirect Effects (MRIE)</a>
<ul>
<li class="chapter" data-level="6.4.1" data-path="ChapGcomp.html"><a href="ChapGcomp.html#parametric-g-computation"><i class="fa fa-check"></i><b>6.4.1</b> Parametric g-computation</a></li>
<li class="chapter" data-level="6.4.2" data-path="ChapGcomp.html"><a href="ChapGcomp.html#g-computation-by-iterative-conditional-expectation"><i class="fa fa-check"></i><b>6.4.2</b> G-computation by iterative conditional expectation</a></li>
</ul></li>
<li class="chapter" data-level="6.5" data-path="ChapGcomp.html"><a href="ChapGcomp.html#using-the-cmaverse-package-for-2-way-3-way-and-4-way-decomposition"><i class="fa fa-check"></i><b>6.5</b> Using the <code>CMAverse</code> package for 2-way, 3-way and 4-way decomposition</a></li>
<li class="chapter" data-level="6.6" data-path="ChapGcomp.html"><a href="ChapGcomp.html#estimation-of-conditional-randomizedinterventional-natural-direct-crde-and-indirect-effects-crie"><i class="fa fa-check"></i><b>6.6</b> Estimation of “Conditional” Randomized/Interventional Natural Direct (CRDE) and Indirect Effects (CRIE)</a>
<ul>
<li class="chapter" data-level="6.6.1" data-path="ChapGcomp.html"><a href="ChapGcomp.html#g-computation-by-iterative-conditional-expectation-simple-substitution-estimator"><i class="fa fa-check"></i><b>6.6.1</b> G-computation by iterative conditional expectation (simple substitution estimator)</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="ChapIptw.html"><a href="ChapIptw.html"><i class="fa fa-check"></i><b>7</b> Inverse Probability of Treatment Weighting (IPTW)</a>
<ul>
<li class="chapter" data-level="7.1" data-path="ChapIptw.html"><a href="ChapIptw.html#estimation-of-the-average-total-effect"><i class="fa fa-check"></i><b>7.1</b> Estimation of the Average total effect</a>
<ul>
<li class="chapter" data-level="7.1.1" data-path="ChapIptw.html"><a href="ChapIptw.html#iptw-for-the-ate"><i class="fa fa-check"></i><b>7.1.1</b> IPTW for the ATE</a></li>
<li class="chapter" data-level="7.1.2" data-path="ChapIptw.html"><a href="ChapIptw.html#stabilized-iptw-for-the-ate"><i class="fa fa-check"></i><b>7.1.2</b> Stabilized IPTW for the ATE</a></li>
</ul></li>
<li class="chapter" data-level="7.2" data-path="ChapIptw.html"><a href="ChapIptw.html#estimation-of-the-controlled-direct-effect-cde"><i class="fa fa-check"></i><b>7.2</b> Estimation of the Controlled direct effect (CDE)</a>
<ul>
<li class="chapter" data-level="7.2.1" data-path="ChapIptw.html"><a href="ChapIptw.html#iptw-for-the-cde"><i class="fa fa-check"></i><b>7.2.1</b> IPTW for the CDE</a></li>
<li class="chapter" data-level="7.2.2" data-path="ChapIptw.html"><a href="ChapIptw.html#stabilized-iptw-for-the-cde"><i class="fa fa-check"></i><b>7.2.2</b> Stabilized IPTW for the CDE</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="ChapIptw.html"><a href="ChapIptw.html#estimation-of-the-pnde-and-tnie-by-inverse-odds-ratio-weigthing"><i class="fa fa-check"></i><b>7.3</b> Estimation of the PNDE and TNIE by Inverse Odds Ratio Weigthing</a></li>
<li class="chapter" data-level="7.4" data-path="ChapIptw.html"><a href="ChapIptw.html#estimation-of-conditional-randomizedinterventional-natural-direct-crde-and-indirect-effects-crie-1"><i class="fa fa-check"></i><b>7.4</b> Estimation of “Conditional” Randomized/Interventional Natural Direct (CRDE) and Indirect Effects (CRIE)</a>
<ul>
<li class="chapter" data-level="7.4.1" data-path="ChapIptw.html"><a href="ChapIptw.html#iptw-for-the-crde-and-crie"><i class="fa fa-check"></i><b>7.4.1</b> IPTW for the CRDE and CRIE</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="msm_chapter.html"><a href="msm_chapter.html"><i class="fa fa-check"></i><b>8</b> Marginal structural models</a>
<ul>
<li class="chapter" data-level="8.1" data-path="msm_chapter.html"><a href="msm_chapter.html#msm_ATE_paragraph"><i class="fa fa-check"></i><b>8.1</b> MSM for the Average Total Effect (ATE)</a>
<ul>
<li class="chapter" data-level="8.1.1" data-path="msm_chapter.html"><a href="msm_chapter.html#expressing-the-ate-using-coefficients-of-an-msm"><i class="fa fa-check"></i><b>8.1.1</b> Expressing the ATE using coefficients of an MSM</a></li>
<li class="chapter" data-level="8.1.2" data-path="msm_chapter.html"><a href="msm_chapter.html#estimation-of-the-msm-coefficients-by-iptw"><i class="fa fa-check"></i><b>8.1.2</b> Estimation of the MSM coefficients by IPTW</a></li>
<li class="chapter" data-level="8.1.3" data-path="msm_chapter.html"><a href="msm_chapter.html#estimation-of-the-msm-coefficients-by-g-computation-imputation"><i class="fa fa-check"></i><b>8.1.3</b> Estimation of the MSM coefficients by G-computation (imputation)</a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="msm_chapter.html"><a href="msm_chapter.html#msm_CDE_paragraph"><i class="fa fa-check"></i><b>8.2</b> MSM for Controlled Direct Effects</a>
<ul>
<li class="chapter" data-level="8.2.1" data-path="msm_chapter.html"><a href="msm_chapter.html#expressing-the-cde-using-coefficients-of-an-msm"><i class="fa fa-check"></i><b>8.2.1</b> Expressing the CDE using coefficients of an MSM</a></li>
<li class="chapter" data-level="8.2.2" data-path="msm_chapter.html"><a href="msm_chapter.html#estimation-of-the-msm-coefficients-by-iptw-1"><i class="fa fa-check"></i><b>8.2.2</b> Estimation of the MSM coefficients by IPTW</a></li>
<li class="chapter" data-level="8.2.3" data-path="msm_chapter.html"><a href="msm_chapter.html#estimation-of-the-msm-coefficients-by-g-computation"><i class="fa fa-check"></i><b>8.2.3</b> Estimation of the MSM coefficients by G-computation</a></li>
</ul></li>
<li class="chapter" data-level="8.3" data-path="msm_chapter.html"><a href="msm_chapter.html#msm_NDE_NIE_paragraph"><i class="fa fa-check"></i><b>8.3</b> MSM for Natural Direct and Indirect Effects</a>
<ul>
<li class="chapter" data-level="8.3.1" data-path="msm_chapter.html"><a href="msm_chapter.html#expressing-the-nde-and-nie-using-coefficients-of-2-msms"><i class="fa fa-check"></i><b>8.3.1</b> Expressing the NDE and NIE using coefficients of 2 MSMs</a></li>
<li class="chapter" data-level="8.3.2" data-path="msm_chapter.html"><a href="msm_chapter.html#estimation-of-the-2-msms-coefficients-by-iptw-for-nde-and-nie"><i class="fa fa-check"></i><b>8.3.2</b> Estimation of the 2 MSMs coefficients by IPTW for NDE and NIE</a></li>
</ul></li>
<li class="chapter" data-level="8.4" data-path="msm_chapter.html"><a href="msm_chapter.html#msm_CMAverse"><i class="fa fa-check"></i><b>8.4</b> MSM estimated by the <code>CMAverse</code> package</a>
<ul>
<li class="chapter" data-level="8.4.1" data-path="msm_chapter.html"><a href="msm_chapter.html#calculation-by-hand-using-the-mediation-formula"><i class="fa fa-check"></i><b>8.4.1</b> Calculation by hand, using the “mediation formula”</a></li>
<li class="chapter" data-level="8.4.2" data-path="msm_chapter.html"><a href="msm_chapter.html#estimation-of-nde-and-nie-using-cmaverse-by-iptw-or-gcomputation"><i class="fa fa-check"></i><b>8.4.2</b> Estimation of NDE and NIE using CMAverse (by IPTW or gcomputation)</a></li>
</ul></li>
<li class="chapter" data-level="8.5" data-path="msm_chapter.html"><a href="msm_chapter.html#msm_unified"><i class="fa fa-check"></i><b>8.5</b> “Unified” approach for estimating Natural Direct and Indirect effects</a>
<ul>
<li class="chapter" data-level="8.5.1" data-path="msm_chapter.html"><a href="msm_chapter.html#estimation-of-the-msm-by-iptw"><i class="fa fa-check"></i><b>8.5.1</b> Estimation of the MSM by IPTW</a></li>
<li class="chapter" data-level="8.5.2" data-path="msm_chapter.html"><a href="msm_chapter.html#estimation-of-the-msm-by-g-computation"><i class="fa fa-check"></i><b>8.5.2</b> Estimation of the MSM by g-computation</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="9" data-path="chap_tmle.html"><a href="chap_tmle.html"><i class="fa fa-check"></i><b>9</b> Targeted Maximum Likelihood Estimation (TMLE)</a>
<ul>
<li class="chapter" data-level="9.1" data-path="chap_tmle.html"><a href="chap_tmle.html#tmle-for-the-ate"><i class="fa fa-check"></i><b>9.1</b> TMLE for the ATE</a></li>
<li class="chapter" data-level="9.2" data-path="chap_tmle.html"><a href="chap_tmle.html#tmle-of-the-controlled-direct-effect-cde"><i class="fa fa-check"></i><b>9.2</b> TMLE of the Controlled direct effect (CDE)</a>
<ul>
<li class="chapter" data-level="9.2.1" data-path="chap_tmle.html"><a href="chap_tmle.html#for-binary-outcomes"><i class="fa fa-check"></i><b>9.2.1</b> For binary outcomes</a></li>
<li class="chapter" data-level="9.2.2" data-path="chap_tmle.html"><a href="chap_tmle.html#for-continuous-outcomes"><i class="fa fa-check"></i><b>9.2.2</b> For continuous outcomes</a></li>
</ul></li>
<li class="chapter" data-level="9.3" data-path="chap_tmle.html"><a href="chap_tmle.html#one-step-and-tmle-estimator-of-the-marginal-randomizedinterventional-direct-and-indirect-effects"><i class="fa fa-check"></i><b>9.3</b> One-step and TMLE estimator of the Marginal Randomized/Interventional Direct and Indirect Effects</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="appendix_a.html"><a href="appendix_a.html"><i class="fa fa-check"></i><b>10</b> Appendix A: Data generating mechanisms</a>
<ul>
<li class="chapter" data-level="10.1" data-path="appendix_a.html"><a href="appendix_a.html#first-causal-model-data-generating-mechanism-without-mediator-outcome-confounder-affected-by-the-exposure"><i class="fa fa-check"></i><b>10.1</b> First causal model: Data generating mechanism without mediator-outcome confounder affected by the exposure</a></li>
<li class="chapter" data-level="10.2" data-path="appendix_a.html"><a href="appendix_a.html#second-causal-model-data-generating-mechanism-with-mediator-outcome-confounder-affected-by-the-exposure"><i class="fa fa-check"></i><b>10.2</b> Second causal model: Data generating mechanism with mediator-outcome confounder affected by the exposure</a></li>
<li class="chapter" data-level="10.3" data-path="appendix_a.html"><a href="appendix_a.html#simulation-of-the-four-data-sets-used-in-examples"><i class="fa fa-check"></i><b>10.3</b> Simulation of the four data sets used in examples</a>
<ul>
<li class="chapter" data-level="10.3.1" data-path="appendix_a.html"><a href="appendix_a.html#data-sets-generated-from-the-causal-model-1"><i class="fa fa-check"></i><b>10.3.1</b> Data sets generated from the causal model 1</a></li>
<li class="chapter" data-level="10.3.2" data-path="appendix_a.html"><a href="appendix_a.html#data-sets-generated-from-the-causal-model-2"><i class="fa fa-check"></i><b>10.3.2</b> Data sets generated from the causal model 2</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="11" data-path="appendix_b.html"><a href="appendix_b.html"><i class="fa fa-check"></i><b>11</b> Appendix B: Calculation of the true causal quantities</a>
<ul>
<li class="chapter" data-level="11.1" data-path="appendix_b.html"><a href="appendix_b.html#true-causal-quantities-without-mediator-ouctome-confounder-affected-by-the-exposure"><i class="fa fa-check"></i><b>11.1</b> True causal quantities without mediator-ouctome confounder affected by the exposure</a>
<ul>
<li class="chapter" data-level="11.1.1" data-path="appendix_b.html"><a href="appendix_b.html#average-total-effects-ate"><i class="fa fa-check"></i><b>11.1.1</b> Average total effects (ATE)</a></li>
<li class="chapter" data-level="11.1.2" data-path="appendix_b.html"><a href="appendix_b.html#controlled-direct-effects-cde"><i class="fa fa-check"></i><b>11.1.2</b> Controlled direct effects (CDE)</a></li>
<li class="chapter" data-level="11.1.3" data-path="appendix_b.html"><a href="appendix_b.html#pure-natural-direct-effect-and-total-natural-indirect-effect"><i class="fa fa-check"></i><b>11.1.3</b> Pure natural direct effect and Total natural indirect effect</a></li>
<li class="chapter" data-level="11.1.4" data-path="appendix_b.html"><a href="appendix_b.html#total-natural-direct-effect-and-pure-natural-indirect-effect"><i class="fa fa-check"></i><b>11.1.4</b> Total natural direct effect and Pure natural indirect effect</a></li>
<li class="chapter" data-level="11.1.5" data-path="appendix_b.html"><a href="appendix_b.html#vanderweeles-3-way-decomposition"><i class="fa fa-check"></i><b>11.1.5</b> Vanderweele’s 3-way decomposition</a></li>
<li class="chapter" data-level="11.1.6" data-path="appendix_b.html"><a href="appendix_b.html#vanderweeles-4-way-decomposition"><i class="fa fa-check"></i><b>11.1.6</b> Vanderweele’s 4-way decomposition</a></li>
<li class="chapter" data-level="11.1.7" data-path="appendix_b.html"><a href="appendix_b.html#marginal-randomized-direct-and-indirect-effects"><i class="fa fa-check"></i><b>11.1.7</b> Marginal randomized direct and indirect effects</a></li>
<li class="chapter" data-level="11.1.8" data-path="appendix_b.html"><a href="appendix_b.html#conditional-randomized-direct-and-indirect-effects"><i class="fa fa-check"></i><b>11.1.8</b> Conditional randomized direct and indirect effects</a></li>
</ul></li>
<li class="chapter" data-level="11.2" data-path="appendix_b.html"><a href="appendix_b.html#true-causal-quantities-with-mediator-outcome-confounder-affected-by-the-exposure"><i class="fa fa-check"></i><b>11.2</b> True causal quantities with mediator-outcome confounder affected by the exposure</a>
<ul>
<li class="chapter" data-level="11.2.1" data-path="appendix_b.html"><a href="appendix_b.html#average-total-effects-ate-1"><i class="fa fa-check"></i><b>11.2.1</b> Average total effects (ATE)</a></li>
<li class="chapter" data-level="11.2.2" data-path="appendix_b.html"><a href="appendix_b.html#controlled-direct-effects-cde-1"><i class="fa fa-check"></i><b>11.2.2</b> Controlled direct effects (CDE)</a></li>
<li class="chapter" data-level="11.2.3" data-path="appendix_b.html"><a href="appendix_b.html#marginal-randomized-direct-and-indirect-effects-1"><i class="fa fa-check"></i><b>11.2.3</b> Marginal randomized direct and indirect effects</a></li>
<li class="chapter" data-level="11.2.4" data-path="appendix_b.html"><a href="appendix_b.html#conditional-randomized-direct-and-indirect-effects-1"><i class="fa fa-check"></i><b>11.2.4</b> Conditional randomized direct and indirect effects</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Mediation Workshop</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="msm_chapter" class="section level1 hasAnchor" number="8">
<h1><span class="header-section-number">Chapter 8</span> Marginal structural models<a href="msm_chapter.html#msm_chapter" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>Marginal structural models (MSM) are parametric models that are used to summarize the relationship between the counterfactual outcome (<span class="math inline">\(Y_a\)</span> or <span class="math inline">\(Y_{am}\)</span> for example) and the exposure(s) <span class="math inline">\(A\)</span> and mediators <span class="math inline">\(M\)</span>. It also possible to summarize the relationship according to a subset of the baseline confounders if it is relevant for the scientific question.</p>
<p>To illustrate the application of MSMs, we will first use the data simulated from the Causal model 1 (with an <span class="math inline">\(A \ast M\)</span> interaction effect on the outcome) where the exposure <span class="math inline">\(A\)</span> doesn’t affect the confounder <span class="math inline">\(L(1)\)</span> between the mediator and the outcome.</p>
<div id="msm_ATE_paragraph" class="section level2 hasAnchor" number="8.1">
<h2><span class="header-section-number">8.1</span> MSM for the Average Total Effect (ATE)<a href="msm_chapter.html#msm_ATE_paragraph" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="expressing-the-ate-using-coefficients-of-an-msm" class="section level3 hasAnchor" number="8.1.1">
<h3><span class="header-section-number">8.1.1</span> Expressing the ATE using coefficients of an MSM<a href="msm_chapter.html#expressing-the-ate-using-coefficients-of-an-msm" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>For a continuous or binary outcome, we can use the following MSM to summarize the relationship between the counterfactual outcome (<span class="math inline">\(Y_a\)</span>) and the exposure(s) <span class="math inline">\(A\)</span>:
<span class="math display" id="eq:MSMATEmarg">\[\begin{equation}
  \mathbb{E}(Y_a) = \alpha_0 + \alpha_A a
  \tag{8.1}
\end{equation}\]</span></p>
<p>The Average Total Effect <span class="math inline">\(\text{ATE} = \mathbb{E}(Y_{A=1}) - \mathbb{E}(Y_{A=0})\)</span> can then be expressed using the coefficients of this MSM <a href="msm_chapter.html#eq:MSMATEmarg">(8.1)</a>:
<span class="math display">\[\begin{equation*}
  \text{ATE} := \left(\alpha_0 + \alpha_A \times 1 \right) - \left(\alpha_0 + \alpha_A \times 0 \right) = \alpha_A
\end{equation*}\]</span></p>
<p>In this example, the coefficient <span class="math inline">\(\alpha_A\)</span> corresponds to the <span class="math inline">\(\text{ATE}\)</span>.</p>
<p>Such a model is not very useful for a binary exposure. It would be much more useful for higher-dimensional exposures, for example with a continuous exposure, where the relationship between all the possible continuous values of the exposure <span class="math inline">\(A=a\)</span> and the corresponding outcomes <span class="math inline">\(Y_a\)</span> is summarized (and arbitrarily simplified) by a single line and the slope coefficient <span class="math inline">\(\alpha_A\)</span>.</p>
<p>It is also possible to define MSMs adjusted for a subset <span class="math inline">\(V\)</span> of the baseline confounders (<span class="math inline">\(V \subset L(0)\)</span>). Such MSMs can be useful to estimate conditional effects. For example it is possible to define an average “conditional” total effect <span class="math inline">\(\text{ATE}|L(0)\)</span> (instead of the marginal ATE defined above), projecting the counterfactual outcomes on a parametric model such as the following:</p>
<p><span class="math display" id="eq:MSMATEcond">\[\begin{equation}
  \mathbb{E}(Y_a \mid L(0)) = \alpha_0 + \alpha_A a + \alpha_\text{male} L_\text{male}(0) + \alpha_\text{soc.env.} L_\text{soc.env.}(0)
  \tag{8.2}
\end{equation}\]</span></p>
<p>so that <span class="math inline">\(\text{ATE} \mid L(0) = \mathbb{E}(Y_{A=1} \mid L(0)) - \mathbb{E}(Y_{A=0} \mid L(0)) = \alpha_A\)</span> using the coefficient from the MSM <a href="msm_chapter.html#eq:MSMATEcond">(8.2)</a>.</p>
<p>MSMs are also very useful to study interactions, or effect modification of the exposure <span class="math inline">\(A\)</span> by a baseline confounder. For example, in order to study the average total effect according to sex, we can use the following MSM:</p>
<p><span class="math display" id="eq:MSMATEsex">\[\begin{equation}
  \mathbb{E}(Y_a \mid L_\text{male}(0)) = \alpha_0 + \alpha_A a + \alpha_\text{male} L_\text{male}(0) + \alpha_{A \ast L_\text{male}} \left(a \times L_\text{male}(0)\right)
  \tag{8.3}
\end{equation}\]</span></p>
<p>and express the average total effect in each strata of sex using the coefficients of the MSM <a href="msm_chapter.html#eq:MSMATEsex">(8.3)</a>:</p>
<p><span class="math display">\[\begin{align*}
\{\text{ATE} \mid L_\text{male}(0) = 0\} &amp;:= \mathbb{E}(Y_1 \mid L_\text{male}(0) = 0) - \mathbb{E}(Y_0 \mid L_\text{male}(0) = 0) = \alpha_A \\
\{\text{ATE} \mid L_\text{male}(0) = 1\} &amp;:= \mathbb{E}(Y_1 \mid L_\text{male}(0) = 1) - \mathbb{E}(Y_0 \mid L_\text{male}(0) = 1) = \alpha_A + \alpha_{A \ast L_\text{male}}
\end{align*}\]</span></p>
<p>Because MSMs are models of unobserved counterfactual outcomes, estimators of the MSM coefficients are necessary. We will describe two possible approaches : estimation by IPTW or by G-computation.</p>
<p>In both approaches, 95% confidence intervals can be computed by bootstrap.</p>
</div>
<div id="estimation-of-the-msm-coefficients-by-iptw" class="section level3 hasAnchor" number="8.1.2">
<h3><span class="header-section-number">8.1.2</span> Estimation of the MSM coefficients by IPTW<a href="msm_chapter.html#estimation-of-the-msm-coefficients-by-iptw" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>MSM coefficients can be easily estimated using an Inverse Probability of Treatment (IPTW) approach based on weighted regressions.</p>
<p>For example, in order to fit the MSM <a href="msm_chapter.html#eq:MSMATEsex">(8.3)</a> described above, we can use a linear regression of the (observed) outcome <span class="math inline">\(Y\)</span> on the exposure and sex, weigthed by individual weights <span class="math inline">\(w_i\)</span> or <span class="math inline">\(sw_i\)</span>:
<span class="math display">\[\begin{equation}
  \mathbb{E}\left[Y \mid L_\text{male}(0)\right] = \alpha_0 + \alpha_A a + \alpha_\text{male} L_\text{male}(0) + \alpha_{A \ast L_\text{male}} \left(a \times L_\text{male}(0)\right)
\end{equation}\]</span></p>
<p>where <span class="math inline">\(w_i=\frac{1}{P(A=a_i \mid L(0)=l(0)_i)}\)</span> or <span class="math inline">\(sw_i=\frac{P(A=a_i \mid L_\text{male}(0))}{P(A=a_i \mid L(0)=l(0)_i)}\)</span>.</p>
<p>As in chapter <a href="ChapIptw.html#ChapIptw">7</a>, the “no-unmeasured confounding” assumption is addressed by the application of weights <span class="math inline">\(w_i\)</span> or <span class="math inline">\(sw_i\)</span>, which balance confounders <span class="math inline">\(L(0)\)</span> relative to the exposure <span class="math inline">\(A\)</span>.</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="msm_chapter.html#cb50-1" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list=</span><span class="fu">ls</span>())</span>
<span id="cb50-2"><a href="msm_chapter.html#cb50-2" tabindex="-1"></a>df1_int <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="st">&quot;data/df1_int.csv&quot;</span>)</span>
<span id="cb50-3"><a href="msm_chapter.html#cb50-3" tabindex="-1"></a></span>
<span id="cb50-4"><a href="msm_chapter.html#cb50-4" tabindex="-1"></a><span class="do">## 1. Denominator of the weight</span></span>
<span id="cb50-5"><a href="msm_chapter.html#cb50-5" tabindex="-1"></a><span class="co"># 1a. Estimate g(A=a_i|L(0)) (denominator of the weight)</span></span>
<span id="cb50-6"><a href="msm_chapter.html#cb50-6" tabindex="-1"></a>g.A.L <span class="ot">&lt;-</span> <span class="fu">glm</span>(A0_PM2<span class="fl">.5</span> <span class="sc">~</span> L0_male <span class="sc">+</span> L0_soc_env,</span>
<span id="cb50-7"><a href="msm_chapter.html#cb50-7" tabindex="-1"></a>           <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>, <span class="at">data =</span> df1_int)</span>
<span id="cb50-8"><a href="msm_chapter.html#cb50-8" tabindex="-1"></a></span>
<span id="cb50-9"><a href="msm_chapter.html#cb50-9" tabindex="-1"></a><span class="co"># 1b. Predict each individual&#39;s probability of being exposed to her own exposure</span></span>
<span id="cb50-10"><a href="msm_chapter.html#cb50-10" tabindex="-1"></a><span class="co"># predict the probabilities P(A0_PM2.5 = 1) &amp; P(A0_PM2.5 = 0)</span></span>
<span id="cb50-11"><a href="msm_chapter.html#cb50-11" tabindex="-1"></a>pred.g1.L <span class="ot">&lt;-</span> <span class="fu">predict</span>(g.A.L, <span class="at">type=</span><span class="st">&quot;response&quot;</span>)</span>
<span id="cb50-12"><a href="msm_chapter.html#cb50-12" tabindex="-1"></a>pred.g0.L <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> pred.g1.L</span>
<span id="cb50-13"><a href="msm_chapter.html#cb50-13" tabindex="-1"></a><span class="co"># the predicted probability of the observed treatment P(A = a_i | L(0)) is :</span></span>
<span id="cb50-14"><a href="msm_chapter.html#cb50-14" tabindex="-1"></a>gAi.L <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">nrow</span>(df1_int))</span>
<span id="cb50-15"><a href="msm_chapter.html#cb50-15" tabindex="-1"></a>gAi.L[df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">1</span>] <span class="ot">&lt;-</span> pred.g1.L[df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">1</span>]</span>
<span id="cb50-16"><a href="msm_chapter.html#cb50-16" tabindex="-1"></a>gAi.L[df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">0</span>] <span class="ot">&lt;-</span> pred.g0.L[df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">0</span>]</span>
<span id="cb50-17"><a href="msm_chapter.html#cb50-17" tabindex="-1"></a></span>
<span id="cb50-18"><a href="msm_chapter.html#cb50-18" tabindex="-1"></a><span class="do">## 2. Numerator of the weight</span></span>
<span id="cb50-19"><a href="msm_chapter.html#cb50-19" tabindex="-1"></a><span class="co"># The numerator of the weight can be 1 for simple weights,</span></span>
<span id="cb50-20"><a href="msm_chapter.html#cb50-20" tabindex="-1"></a><span class="co"># or g(A=a_i|V) to obtain stabilized weights which put less weight to individuals</span></span>
<span id="cb50-21"><a href="msm_chapter.html#cb50-21" tabindex="-1"></a><span class="co"># with less observation. Stabilized weights enable a weaker positivity assumption.</span></span>
<span id="cb50-22"><a href="msm_chapter.html#cb50-22" tabindex="-1"></a></span>
<span id="cb50-23"><a href="msm_chapter.html#cb50-23" tabindex="-1"></a><span class="co"># 2a. Estimate g(A=a_i | sex) (numerator of the stabilized weight)</span></span>
<span id="cb50-24"><a href="msm_chapter.html#cb50-24" tabindex="-1"></a>g.A.sex <span class="ot">&lt;-</span> <span class="fu">glm</span>(A0_PM2<span class="fl">.5</span> <span class="sc">~</span> L0_male,</span>
<span id="cb50-25"><a href="msm_chapter.html#cb50-25" tabindex="-1"></a>               <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>, <span class="at">data =</span> df1_int)</span>
<span id="cb50-26"><a href="msm_chapter.html#cb50-26" tabindex="-1"></a></span>
<span id="cb50-27"><a href="msm_chapter.html#cb50-27" tabindex="-1"></a><span class="co"># 2b. Predict each individual&#39;s probability of being exposed to her own exposure</span></span>
<span id="cb50-28"><a href="msm_chapter.html#cb50-28" tabindex="-1"></a><span class="co"># predict the probabilities P(A0_PM2.5 = 1 | sex) &amp; P(A0_PM2.5 = 0 | sex)</span></span>
<span id="cb50-29"><a href="msm_chapter.html#cb50-29" tabindex="-1"></a>pred.g1.sex <span class="ot">&lt;-</span> <span class="fu">predict</span>(g.A.sex, <span class="at">type=</span><span class="st">&quot;response&quot;</span>)</span>
<span id="cb50-30"><a href="msm_chapter.html#cb50-30" tabindex="-1"></a>pred.g0.sex <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> pred.g1.sex</span>
<span id="cb50-31"><a href="msm_chapter.html#cb50-31" tabindex="-1"></a><span class="co"># the predicted probability of the observed treatment P(A = a_i | sex) is :</span></span>
<span id="cb50-32"><a href="msm_chapter.html#cb50-32" tabindex="-1"></a>gAi.sex <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">nrow</span>(df1_int))</span>
<span id="cb50-33"><a href="msm_chapter.html#cb50-33" tabindex="-1"></a>gAi.sex[df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">1</span>] <span class="ot">&lt;-</span> pred.g1.sex[df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">1</span>]</span>
<span id="cb50-34"><a href="msm_chapter.html#cb50-34" tabindex="-1"></a>gAi.sex[df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">0</span>] <span class="ot">&lt;-</span> pred.g0.sex[df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">0</span>]</span>
<span id="cb50-35"><a href="msm_chapter.html#cb50-35" tabindex="-1"></a></span>
<span id="cb50-36"><a href="msm_chapter.html#cb50-36" tabindex="-1"></a><span class="do">## 3. Define individual weights:</span></span>
<span id="cb50-37"><a href="msm_chapter.html#cb50-37" tabindex="-1"></a><span class="co"># We can use simple weights w = 1 / g(A=a_i | L(0))</span></span>
<span id="cb50-38"><a href="msm_chapter.html#cb50-38" tabindex="-1"></a>w <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> gAi.L</span>
<span id="cb50-39"><a href="msm_chapter.html#cb50-39" tabindex="-1"></a><span class="co"># Or alternatively, we can use stabilized weights : </span></span>
<span id="cb50-40"><a href="msm_chapter.html#cb50-40" tabindex="-1"></a><span class="co"># sw = g(A=a_i | sex) / g(A=a_i | L(0))</span></span>
<span id="cb50-41"><a href="msm_chapter.html#cb50-41" tabindex="-1"></a>sw <span class="ot">&lt;-</span> gAi.sex <span class="sc">/</span> gAi.L</span>
<span id="cb50-42"><a href="msm_chapter.html#cb50-42" tabindex="-1"></a></span>
<span id="cb50-43"><a href="msm_chapter.html#cb50-43" tabindex="-1"></a><span class="co"># we can see that stabilized weights have less extreme values</span></span>
<span id="cb50-44"><a href="msm_chapter.html#cb50-44" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfcol =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb50-45"><a href="msm_chapter.html#cb50-45" tabindex="-1"></a><span class="fu">boxplot</span>(w <span class="sc">~</span> df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span>)</span>
<span id="cb50-46"><a href="msm_chapter.html#cb50-46" tabindex="-1"></a><span class="fu">boxplot</span>(sw <span class="sc">~</span> df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span>)</span>
<span id="cb50-47"><a href="msm_chapter.html#cb50-47" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfcol =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb50-48"><a href="msm_chapter.html#cb50-48" tabindex="-1"></a></span>
<span id="cb50-49"><a href="msm_chapter.html#cb50-49" tabindex="-1"></a><span class="do">## applying these weights creates a pseudo-population were the baseline</span></span>
<span id="cb50-50"><a href="msm_chapter.html#cb50-50" tabindex="-1"></a><span class="do">## confounders are balanced, relative to the exposure:</span></span>
<span id="cb50-51"><a href="msm_chapter.html#cb50-51" tabindex="-1"></a><span class="do">## before applying weights to the individuals:</span></span>
<span id="cb50-52"><a href="msm_chapter.html#cb50-52" tabindex="-1"></a><span class="fu">table</span>(df1_int<span class="sc">$</span>L0_male, df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span>, <span class="at">deparse.level =</span> <span class="dv">2</span>)</span>
<span id="cb50-53"><a href="msm_chapter.html#cb50-53" tabindex="-1"></a><span class="co">#                df1_int$A0_PM2.5</span></span>
<span id="cb50-54"><a href="msm_chapter.html#cb50-54" tabindex="-1"></a><span class="co"># df1_int$L0_male    0    1</span></span>
<span id="cb50-55"><a href="msm_chapter.html#cb50-55" tabindex="-1"></a><span class="co">#               0 4527  463</span></span>
<span id="cb50-56"><a href="msm_chapter.html#cb50-56" tabindex="-1"></a><span class="co">#               1 4349  661</span></span>
<span id="cb50-57"><a href="msm_chapter.html#cb50-57" tabindex="-1"></a><span class="fu">prop.table</span>(<span class="fu">table</span>(df1_int<span class="sc">$</span>L0_male, df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span>, <span class="at">deparse.level =</span> <span class="dv">2</span>),</span>
<span id="cb50-58"><a href="msm_chapter.html#cb50-58" tabindex="-1"></a>           <span class="at">margin =</span> <span class="dv">2</span>)</span>
<span id="cb50-59"><a href="msm_chapter.html#cb50-59" tabindex="-1"></a><span class="co">#                          df1_int$A0_PM2.5</span></span>
<span id="cb50-60"><a href="msm_chapter.html#cb50-60" tabindex="-1"></a><span class="co"># df1_int$L0_male         0         1</span></span>
<span id="cb50-61"><a href="msm_chapter.html#cb50-61" tabindex="-1"></a><span class="co">#               0 0.5100270 0.4119217</span></span>
<span id="cb50-62"><a href="msm_chapter.html#cb50-62" tabindex="-1"></a><span class="co">#               1 0.4899730 0.5880783   # sex is unbalanced: 49% versus 59%</span></span>
<span id="cb50-63"><a href="msm_chapter.html#cb50-63" tabindex="-1"></a></span>
<span id="cb50-64"><a href="msm_chapter.html#cb50-64" tabindex="-1"></a><span class="do">## after applying weights to the individuals:</span></span>
<span id="cb50-65"><a href="msm_chapter.html#cb50-65" tabindex="-1"></a><span class="fu">library</span>(questionr) <span class="co"># The questionr package enables to describe weighted populations</span></span>
<span id="cb50-66"><a href="msm_chapter.html#cb50-66" tabindex="-1"></a><span class="fu">wtd.table</span>(<span class="at">x =</span> df1_int<span class="sc">$</span>L0_male, <span class="at">y =</span> df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span>,</span>
<span id="cb50-67"><a href="msm_chapter.html#cb50-67" tabindex="-1"></a>          <span class="at">weights =</span> w)</span>
<span id="cb50-68"><a href="msm_chapter.html#cb50-68" tabindex="-1"></a><span class="co">#          0        1</span></span>
<span id="cb50-69"><a href="msm_chapter.html#cb50-69" tabindex="-1"></a><span class="co"># 0 4989.425 4918.462</span></span>
<span id="cb50-70"><a href="msm_chapter.html#cb50-70" tabindex="-1"></a><span class="co"># 1 5010.862 5057.676</span></span>
<span id="cb50-71"><a href="msm_chapter.html#cb50-71" tabindex="-1"></a><span class="fu">prop.table</span>(<span class="fu">wtd.table</span>(<span class="at">x =</span> df1_int<span class="sc">$</span>L0_male, <span class="at">y =</span> df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span>,</span>
<span id="cb50-72"><a href="msm_chapter.html#cb50-72" tabindex="-1"></a>                     <span class="at">weights =</span> w), <span class="at">margin =</span> <span class="dv">2</span>)</span>
<span id="cb50-73"><a href="msm_chapter.html#cb50-73" tabindex="-1"></a><span class="co">#           0         1</span></span>
<span id="cb50-74"><a href="msm_chapter.html#cb50-74" tabindex="-1"></a><span class="co"># 0 0.4989282 0.4930227</span></span>
<span id="cb50-75"><a href="msm_chapter.html#cb50-75" tabindex="-1"></a><span class="co"># 1 0.5010718 0.5069773 # sex is balanced in the weighted population</span></span>
<span id="cb50-76"><a href="msm_chapter.html#cb50-76" tabindex="-1"></a></span>
<span id="cb50-77"><a href="msm_chapter.html#cb50-77" tabindex="-1"></a><span class="do">## 4. Estimate coefficients of the MSM using a weighted regression E(Y | A, sex)</span></span>
<span id="cb50-78"><a href="msm_chapter.html#cb50-78" tabindex="-1"></a><span class="co"># a GLM with gaussian family can be applied to estimate risk differences</span></span>
<span id="cb50-79"><a href="msm_chapter.html#cb50-79" tabindex="-1"></a><span class="co"># (for relative risk or rate ratios, we can apply a Poisson family; </span></span>
<span id="cb50-80"><a href="msm_chapter.html#cb50-80" tabindex="-1"></a><span class="co">#  for OR, we can apply a binomial family)</span></span>
<span id="cb50-81"><a href="msm_chapter.html#cb50-81" tabindex="-1"></a>msm1 <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y_death <span class="sc">~</span> A0_PM2<span class="fl">.5</span> <span class="sc">+</span> L0_male <span class="sc">+</span> A0_PM2<span class="fl">.5</span><span class="sc">*</span>L0_male,</span>
<span id="cb50-82"><a href="msm_chapter.html#cb50-82" tabindex="-1"></a>           <span class="at">weights =</span> w,</span>
<span id="cb50-83"><a href="msm_chapter.html#cb50-83" tabindex="-1"></a>           <span class="at">family =</span> <span class="st">&quot;gaussian&quot;</span>,</span>
<span id="cb50-84"><a href="msm_chapter.html#cb50-84" tabindex="-1"></a>           <span class="at">data =</span> df1_int)</span>
<span id="cb50-85"><a href="msm_chapter.html#cb50-85" tabindex="-1"></a><span class="fu">coef</span>(msm1)</span>
<span id="cb50-86"><a href="msm_chapter.html#cb50-86" tabindex="-1"></a><span class="co"># (Intercept)         A0_PM2.5          L0_male A0_PM2.5:L0_male</span></span>
<span id="cb50-87"><a href="msm_chapter.html#cb50-87" tabindex="-1"></a><span class="co">#  0.17573472       0.05883228       0.04598911       0.03077614</span></span>
<span id="cb50-88"><a href="msm_chapter.html#cb50-88" tabindex="-1"></a></span>
<span id="cb50-89"><a href="msm_chapter.html#cb50-89" tabindex="-1"></a>msm2 <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y_death <span class="sc">~</span> A0_PM2<span class="fl">.5</span> <span class="sc">+</span> L0_male <span class="sc">+</span> A0_PM2<span class="fl">.5</span><span class="sc">*</span>L0_male,</span>
<span id="cb50-90"><a href="msm_chapter.html#cb50-90" tabindex="-1"></a>            <span class="at">weights =</span> sw,</span>
<span id="cb50-91"><a href="msm_chapter.html#cb50-91" tabindex="-1"></a>            <span class="at">family =</span> <span class="st">&quot;gaussian&quot;</span>,</span>
<span id="cb50-92"><a href="msm_chapter.html#cb50-92" tabindex="-1"></a>            <span class="at">data =</span> df1_int)</span>
<span id="cb50-93"><a href="msm_chapter.html#cb50-93" tabindex="-1"></a><span class="fu">coef</span>(msm2)</span>
<span id="cb50-94"><a href="msm_chapter.html#cb50-94" tabindex="-1"></a><span class="co"># (Intercept)         A0_PM2.5          L0_male A0_PM2.5:L0_male</span></span>
<span id="cb50-95"><a href="msm_chapter.html#cb50-95" tabindex="-1"></a><span class="co">#  0.17573472       0.05883228       0.04598911       0.03077614</span></span>
<span id="cb50-96"><a href="msm_chapter.html#cb50-96" tabindex="-1"></a></span>
<span id="cb50-97"><a href="msm_chapter.html#cb50-97" tabindex="-1"></a><span class="do">## 5. Estimate the ATE stratified by sex</span></span>
<span id="cb50-98"><a href="msm_chapter.html#cb50-98" tabindex="-1"></a><span class="co"># According to MSM1 (with simple weights)</span></span>
<span id="cb50-99"><a href="msm_chapter.html#cb50-99" tabindex="-1"></a>ATE.msm1.male0 <span class="ot">&lt;-</span> <span class="fu">coef</span>(msm1)[<span class="st">&quot;A0_PM2.5&quot;</span>]</span>
<span id="cb50-100"><a href="msm_chapter.html#cb50-100" tabindex="-1"></a><span class="co"># 0.05883228</span></span>
<span id="cb50-101"><a href="msm_chapter.html#cb50-101" tabindex="-1"></a>ATE.msm1.male1 <span class="ot">&lt;-</span> <span class="fu">coef</span>(msm1)[<span class="st">&quot;A0_PM2.5&quot;</span>] <span class="sc">+</span> <span class="fu">coef</span>(msm1)[<span class="st">&quot;A0_PM2.5:L0_male&quot;</span>]</span>
<span id="cb50-102"><a href="msm_chapter.html#cb50-102" tabindex="-1"></a><span class="co"># 0.08960842</span></span>
<span id="cb50-103"><a href="msm_chapter.html#cb50-103" tabindex="-1"></a></span>
<span id="cb50-104"><a href="msm_chapter.html#cb50-104" tabindex="-1"></a><span class="co"># According to the MSM2 (with stabilized weights)</span></span>
<span id="cb50-105"><a href="msm_chapter.html#cb50-105" tabindex="-1"></a>ATE.msm2.male0 <span class="ot">&lt;-</span> <span class="fu">coef</span>(msm2)[<span class="st">&quot;A0_PM2.5&quot;</span>]</span>
<span id="cb50-106"><a href="msm_chapter.html#cb50-106" tabindex="-1"></a><span class="co"># 0.05883228</span></span>
<span id="cb50-107"><a href="msm_chapter.html#cb50-107" tabindex="-1"></a>ATE.msm2.male1 <span class="ot">&lt;-</span> <span class="fu">coef</span>(msm2)[<span class="st">&quot;A0_PM2.5&quot;</span>] <span class="sc">+</span> <span class="fu">coef</span>(msm2)[<span class="st">&quot;A0_PM2.5:L0_male&quot;</span>]</span>
<span id="cb50-108"><a href="msm_chapter.html#cb50-108" tabindex="-1"></a><span class="co"># 0.08960842</span></span>
<span id="cb50-109"><a href="msm_chapter.html#cb50-109" tabindex="-1"></a><span class="co"># The results are the same because there is no violation of the positivity assumption</span></span>
<span id="cb50-110"><a href="msm_chapter.html#cb50-110" tabindex="-1"></a><span class="co"># In case of positivity violation, stabilized weights would give more accurate estimates</span></span></code></pre></div>
<p>The ATE estimates of death probability using an MSM estimated by IPTW are respectively +5.9% in women and +9.0% in men.</p>
<p>95% confidence intervals can be calculated by bootstrap.</p>
<p>Note: Using the true data generating model used to simulate the illustrative datasets, the “true” value of the ATE stratified by sex can be calculated:</p>
<ul>
<li><p>the “true” <span class="math inline">\((ATE \mid L_\text{male}(0) = 0) = 0.0688\)</span> in women,</p></li>
<li><p>the “true” <span class="math inline">\((ATE \mid L_\text{male}(0) = 1) = 0.0703\)</span> in men.</p></li>
</ul>
</div>
<div id="estimation-of-the-msm-coefficients-by-g-computation-imputation" class="section level3 hasAnchor" number="8.1.3">
<h3><span class="header-section-number">8.1.3</span> Estimation of the MSM coefficients by G-computation (imputation)<a href="msm_chapter.html#estimation-of-the-msm-coefficients-by-g-computation-imputation" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We can also use a G-computation (sometimes described as an imputation) approach to estimate the coefficients of an MSM.</p>
<p>The following steps can be applied:</p>
<ol style="list-style-type: decimal">
<li><p>Fit a (logistic or a linear) regression to estimate <span class="math inline">\(\overline{Q} = \mathbb{E}(Y \mid A, L(0))\)</span></p></li>
<li><p>Use this estimate to predict an outcome for each subject under the counterfactual scenarios <span class="math inline">\(\hat{\overline{Q}}(A=0)_i\)</span> and <span class="math inline">\(\hat{\overline{Q}}(A=1)_i\)</span>, by evaluating the regression fit <span class="math inline">\(\overline{Q}\)</span> at <span class="math inline">\(A=0\)</span> and <span class="math inline">\(A=1\)</span> respectively</p></li>
<li><p>Duplicate the initial dataset in a single long dataset in which:</p></li>
</ol>
<ul>
<li>the first half of the long dataset corresponds to the first counterfactual scenario with <span class="math inline">\(A=0\)</span> for all individuals and an additional column for the predicted counterfactual outcome <span class="math inline">\(\hat{\overline{Q}}(A=0)\)</span> ;</li>
<li>the second half of the long dataset corresponds to the second counterfactual scenario with <span class="math inline">\(A=1\)</span> for all individuals and <span class="math inline">\(\hat{\overline{Q}}(A=1)\)</span> for the predicted counterfactual column.</li>
</ul>
<ol start="4" style="list-style-type: decimal">
<li>Fit the MSM <span class="math inline">\(\mathbb{E}\left[Y_a \mid L_\text{male}(0)\right]\)</span> using the long dataset.</li>
</ol>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="msm_chapter.html#cb51-1" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list=</span><span class="fu">ls</span>())</span>
<span id="cb51-2"><a href="msm_chapter.html#cb51-2" tabindex="-1"></a>df1_int <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="st">&quot;data/df1_int.csv&quot;</span>)</span>
<span id="cb51-3"><a href="msm_chapter.html#cb51-3" tabindex="-1"></a></span>
<span id="cb51-4"><a href="msm_chapter.html#cb51-4" tabindex="-1"></a><span class="do">## 1. Estimate Qbar</span></span>
<span id="cb51-5"><a href="msm_chapter.html#cb51-5" tabindex="-1"></a>Q.tot.death <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y_death <span class="sc">~</span> A0_PM2<span class="fl">.5</span> <span class="sc">+</span> L0_male <span class="sc">+</span> L0_soc_env,</span>
<span id="cb51-6"><a href="msm_chapter.html#cb51-6" tabindex="-1"></a>                   <span class="at">family =</span> <span class="st">&quot;gaussian&quot;</span>, <span class="at">data =</span> df1_int)</span>
<span id="cb51-7"><a href="msm_chapter.html#cb51-7" tabindex="-1"></a><span class="co"># The final result would be sligthly different if we apply a binomial family.</span></span>
<span id="cb51-8"><a href="msm_chapter.html#cb51-8" tabindex="-1"></a></span>
<span id="cb51-9"><a href="msm_chapter.html#cb51-9" tabindex="-1"></a><span class="do">## 2. Predict an outcome for each subject, in 2 counterfactual scenarios </span></span>
<span id="cb51-10"><a href="msm_chapter.html#cb51-10" tabindex="-1"></a><span class="do">##    setting A=0 and A=1</span></span>
<span id="cb51-11"><a href="msm_chapter.html#cb51-11" tabindex="-1"></a><span class="co"># prepare data sets used to predict the outcome under the counterfactual</span></span>
<span id="cb51-12"><a href="msm_chapter.html#cb51-12" tabindex="-1"></a><span class="co"># scenarios setting A=0 and A=1</span></span>
<span id="cb51-13"><a href="msm_chapter.html#cb51-13" tabindex="-1"></a>data.A1 <span class="ot">&lt;-</span> data.A0 <span class="ot">&lt;-</span> df1_int</span>
<span id="cb51-14"><a href="msm_chapter.html#cb51-14" tabindex="-1"></a>data.A1<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb51-15"><a href="msm_chapter.html#cb51-15" tabindex="-1"></a>data.A0<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb51-16"><a href="msm_chapter.html#cb51-16" tabindex="-1"></a></span>
<span id="cb51-17"><a href="msm_chapter.html#cb51-17" tabindex="-1"></a><span class="co"># predict values under the same name in the corresponding counterfactual dataset</span></span>
<span id="cb51-18"><a href="msm_chapter.html#cb51-18" tabindex="-1"></a>data.A1<span class="sc">$</span>Ya.death.pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(Q.tot.death, <span class="at">newdata =</span> data.A1, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb51-19"><a href="msm_chapter.html#cb51-19" tabindex="-1"></a>data.A0<span class="sc">$</span>Ya.death.pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(Q.tot.death, <span class="at">newdata =</span> data.A0, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb51-20"><a href="msm_chapter.html#cb51-20" tabindex="-1"></a></span>
<span id="cb51-21"><a href="msm_chapter.html#cb51-21" tabindex="-1"></a><span class="do">## 3. Append both counterfactual datasets in a single long dataset</span></span>
<span id="cb51-22"><a href="msm_chapter.html#cb51-22" tabindex="-1"></a><span class="co"># (the number of row is twice the initial number of row because there are 2 </span></span>
<span id="cb51-23"><a href="msm_chapter.html#cb51-23" tabindex="-1"></a><span class="co"># counterfactual scenarios)</span></span>
<span id="cb51-24"><a href="msm_chapter.html#cb51-24" tabindex="-1"></a>data<span class="fl">.2</span>scenarios <span class="ot">&lt;-</span> <span class="fu">rbind</span>(data.A0, data.A1)</span>
<span id="cb51-25"><a href="msm_chapter.html#cb51-25" tabindex="-1"></a></span>
<span id="cb51-26"><a href="msm_chapter.html#cb51-26" tabindex="-1"></a><span class="do">## 4. fit the MSM: E(Y_a|sex)</span></span>
<span id="cb51-27"><a href="msm_chapter.html#cb51-27" tabindex="-1"></a><span class="co"># a GLM with gaussian family can be applied to estimate risk differences</span></span>
<span id="cb51-28"><a href="msm_chapter.html#cb51-28" tabindex="-1"></a>MSM.ATE.gcomp <span class="ot">&lt;-</span> <span class="fu">glm</span>(Ya.death.pred <span class="sc">~</span> A0_PM2<span class="fl">.5</span> <span class="sc">+</span> L0_male <span class="sc">+</span> A0_PM2<span class="fl">.5</span><span class="sc">:</span>L0_male,</span>
<span id="cb51-29"><a href="msm_chapter.html#cb51-29" tabindex="-1"></a>                     <span class="at">family =</span> <span class="st">&quot;gaussian&quot;</span>,</span>
<span id="cb51-30"><a href="msm_chapter.html#cb51-30" tabindex="-1"></a>                     <span class="at">data =</span> data<span class="fl">.2</span>scenarios)</span>
<span id="cb51-31"><a href="msm_chapter.html#cb51-31" tabindex="-1"></a><span class="fu">coef</span>(MSM.ATE.gcomp)</span>
<span id="cb51-32"><a href="msm_chapter.html#cb51-32" tabindex="-1"></a><span class="co">#  (Intercept)         A0_PM2.5          L0_male A0_PM2.5:L0_male </span></span>
<span id="cb51-33"><a href="msm_chapter.html#cb51-33" tabindex="-1"></a><span class="co"># 1.743994e-01     7.720726e-02     4.874750e-02     5.087110e-16</span></span>
<span id="cb51-34"><a href="msm_chapter.html#cb51-34" tabindex="-1"></a></span>
<span id="cb51-35"><a href="msm_chapter.html#cb51-35" tabindex="-1"></a><span class="do">## 5. Estimate the ATE stratified by sex</span></span>
<span id="cb51-36"><a href="msm_chapter.html#cb51-36" tabindex="-1"></a><span class="co"># According to MSM.ATE.gcomp</span></span>
<span id="cb51-37"><a href="msm_chapter.html#cb51-37" tabindex="-1"></a>ATE.MSM.gcomp.male0 <span class="ot">&lt;-</span> <span class="fu">coef</span>(MSM.ATE.gcomp)[<span class="st">&quot;A0_PM2.5&quot;</span>]</span>
<span id="cb51-38"><a href="msm_chapter.html#cb51-38" tabindex="-1"></a><span class="co"># 0.07720726</span></span>
<span id="cb51-39"><a href="msm_chapter.html#cb51-39" tabindex="-1"></a>ATE.MSM.gcomp.male1 <span class="ot">&lt;-</span> (<span class="fu">coef</span>(MSM.ATE.gcomp)[<span class="st">&quot;A0_PM2.5&quot;</span>] <span class="sc">+</span></span>
<span id="cb51-40"><a href="msm_chapter.html#cb51-40" tabindex="-1"></a>                          <span class="fu">coef</span>(MSM.ATE.gcomp)[<span class="st">&quot;A0_PM2.5:L0_male&quot;</span>])</span>
<span id="cb51-41"><a href="msm_chapter.html#cb51-41" tabindex="-1"></a><span class="co"># 0.07720726</span></span>
<span id="cb51-42"><a href="msm_chapter.html#cb51-42" tabindex="-1"></a><span class="co"># The results are the same in both strata, because in the first Qbar model,</span></span>
<span id="cb51-43"><a href="msm_chapter.html#cb51-43" tabindex="-1"></a><span class="co"># we did not include any (A * sex) interaction term</span></span>
<span id="cb51-44"><a href="msm_chapter.html#cb51-44" tabindex="-1"></a></span>
<span id="cb51-45"><a href="msm_chapter.html#cb51-45" tabindex="-1"></a><span class="co"># Applying a binomial family for the first Qbar model would result in two</span></span>
<span id="cb51-46"><a href="msm_chapter.html#cb51-46" tabindex="-1"></a><span class="co"># different values of the ATE stratified by sex.</span></span>
<span id="cb51-47"><a href="msm_chapter.html#cb51-47" tabindex="-1"></a><span class="co"># =&gt; 0.06880798 in the L0_male = 0 strata</span></span>
<span id="cb51-48"><a href="msm_chapter.html#cb51-48" tabindex="-1"></a><span class="co"># =&gt; 0.08053575 in the L0_male = 1 strata</span></span>
<span id="cb51-49"><a href="msm_chapter.html#cb51-49" tabindex="-1"></a></span>
<span id="cb51-50"><a href="msm_chapter.html#cb51-50" tabindex="-1"></a><span class="co"># Comments: For the estimation of the first Qbar model, applying a gaussian family </span></span>
<span id="cb51-51"><a href="msm_chapter.html#cb51-51" tabindex="-1"></a><span class="co"># (additive model) with no interaction terms implies the presence of some interaction </span></span>
<span id="cb51-52"><a href="msm_chapter.html#cb51-52" tabindex="-1"></a><span class="co"># terms in a multiplicative model (such as a glm with a binomial family).</span></span>
<span id="cb51-53"><a href="msm_chapter.html#cb51-53" tabindex="-1"></a><span class="co"># On the contrary, applying a binomial family (multiplicative model) with no</span></span>
<span id="cb51-54"><a href="msm_chapter.html#cb51-54" tabindex="-1"></a><span class="co"># interaction terms implies some interaction terms in an additive model (such as</span></span>
<span id="cb51-55"><a href="msm_chapter.html#cb51-55" tabindex="-1"></a><span class="co"># a glm with a gaussian family)</span></span></code></pre></div>
</div>
</div>
<div id="msm_CDE_paragraph" class="section level2 hasAnchor" number="8.2">
<h2><span class="header-section-number">8.2</span> MSM for Controlled Direct Effects<a href="msm_chapter.html#msm_CDE_paragraph" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="expressing-the-cde-using-coefficients-of-an-msm" class="section level3 hasAnchor" number="8.2.1">
<h3><span class="header-section-number">8.2.1</span> Expressing the CDE using coefficients of an MSM<a href="msm_chapter.html#expressing-the-cde-using-coefficients-of-an-msm" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The controlled direct effect is defined as <span class="math inline">\(\text{CDE}_m= \mathbb{E}(Y_{am}) - \mathbb{E}(Y_{a^*m})\)</span>.</p>
<p>Using the following MSM
<span class="math display" id="eq:MSMCDE">\[\begin{equation}
  \mathbb{E}(Y_{am}) = \alpha_0 + \alpha_A a + \alpha_M m + \alpha_{A \ast M} a \times m
  \tag{8.4}
\end{equation}\]</span>
the controlled direct effect (keeping the mediator constant to the value <span class="math inline">\(M=m\)</span>) can be expressed using the coefficients of the MSM <a href="msm_chapter.html#eq:MSMCDE">(8.4)</a>:
<span class="math display">\[\begin{align*}
  \text{CDE}_m &amp;= (\alpha_0 + \alpha_A a + \alpha_M m + \alpha_{A \ast M} a \times m) - (\alpha_0 + \alpha_A a^* + \alpha_M m + \alpha_{A \ast M} a^* \times m) \\
  \text{CDE}_m &amp;= \alpha_A(a - a^* ) + \alpha_{A \ast M} \times (a - a^*) \times m
\end{align*}\]</span>
For a binary exposure <span class="math inline">\(A\)</span>, we have <span class="math inline">\(\text{CDE}_m=\alpha_A + \alpha_{A \ast M} \times m\)</span>.</p>
</div>
<div id="estimation-of-the-msm-coefficients-by-iptw-1" class="section level3 hasAnchor" number="8.2.2">
<h3><span class="header-section-number">8.2.2</span> Estimation of the MSM coefficients by IPTW<a href="msm_chapter.html#estimation-of-the-msm-coefficients-by-iptw-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>MSM coefficients can be easily estimated using an Inverse Probability of Treatment (IPTW) approach based on weighted regressions.</p>
<p>In order to fit the MSM <a href="msm_chapter.html#eq:MSMCDE">(8.4)</a>, we can use a linear regression of the (observed) outcome <span class="math inline">\(Y\)</span> on the exposure and mediator, weighted by individual stabilized weights <span class="math inline">\(sw_i\)</span> (<span class="citation">(<a href="#ref-vanderweele2009">VanderWeele 2009</a>)</span>):
<span class="math display">\[\begin{equation}
  \mathbb{E}\left(Y \mid A,M\right) = \alpha_0 + \alpha_A a + \alpha_M m + \alpha_{A \ast M} a \times m
\end{equation}\]</span></p>
<p>where <span class="math inline">\(sw_i\)</span> is the product of two weights <span class="math inline">\(sw_i = sw_{A,i} \times sw_{M,i}\)</span>,</p>
<p><span class="math inline">\(sw_{A,i}=\frac{P(A=a_i)}{P(A=a_i \mid L(0)=l(0)_i)}\)</span> and <span class="math inline">\(sw_{M,i}=\frac{P(M=m_i \mid A=a_i)}{P(M = m_i \mid A=a_i,L(0)=l(0)_i), L(1)=l(1)_i}\)</span>.</p>
<p>The “no-unmeasured confounding” assumption is addressed by the application of weights <span class="math inline">\(sw_i\)</span>, which balances confounders <span class="math inline">\(L(0)\)</span> relative to the exposure-outcome <span class="math inline">\(A-Y\)</span> relationship, and balance the set of confounders <span class="math inline">\(\{L(0),A,L(1)\}\)</span> relative to the mediator-outcome <span class="math inline">\(M-Y\)</span> relationship.</p>
<div id="example-1-with-no-intermediate-confounder-affected-by-the-exposure" class="section level4 hasAnchor" number="8.2.2.1">
<h4><span class="header-section-number">8.2.2.1</span> Example 1, with no intermediate confounder affected by the exposure<a href="msm_chapter.html#example-1-with-no-intermediate-confounder-affected-by-the-exposure" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="msm_chapter.html#cb52-1" tabindex="-1"></a><span class="do">### MSM of CDE, estimated by IPTW ----------------------------------------------</span></span>
<span id="cb52-2"><a href="msm_chapter.html#cb52-2" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list=</span><span class="fu">ls</span>())</span>
<span id="cb52-3"><a href="msm_chapter.html#cb52-3" tabindex="-1"></a>df1_int <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="st">&quot;data/df1_int.csv&quot;</span>)</span>
<span id="cb52-4"><a href="msm_chapter.html#cb52-4" tabindex="-1"></a></span>
<span id="cb52-5"><a href="msm_chapter.html#cb52-5" tabindex="-1"></a><span class="do">## 1. Stabilized weight for the exposure sw_{A,i}</span></span>
<span id="cb52-6"><a href="msm_chapter.html#cb52-6" tabindex="-1"></a><span class="co"># 1a. Estimate g(A=a_i|L(0)) (denominator of the weight)</span></span>
<span id="cb52-7"><a href="msm_chapter.html#cb52-7" tabindex="-1"></a>g.A.L <span class="ot">&lt;-</span> <span class="fu">glm</span>(A0_PM2<span class="fl">.5</span> <span class="sc">~</span> L0_male <span class="sc">+</span> L0_soc_env,</span>
<span id="cb52-8"><a href="msm_chapter.html#cb52-8" tabindex="-1"></a>             <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>, <span class="at">data =</span> df1_int)</span>
<span id="cb52-9"><a href="msm_chapter.html#cb52-9" tabindex="-1"></a><span class="co"># 1b. Predict each individual&#39;s probability of being exposed to her own exposure</span></span>
<span id="cb52-10"><a href="msm_chapter.html#cb52-10" tabindex="-1"></a><span class="co"># the predicted probability of the observed treatment g(A = a_i | L(0)) is :</span></span>
<span id="cb52-11"><a href="msm_chapter.html#cb52-11" tabindex="-1"></a>gAi.L <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">nrow</span>(df1_int))</span>
<span id="cb52-12"><a href="msm_chapter.html#cb52-12" tabindex="-1"></a>gAi.L[df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">predict</span>(g.A.L, <span class="at">type=</span><span class="st">&quot;response&quot;</span>)[df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">1</span>]</span>
<span id="cb52-13"><a href="msm_chapter.html#cb52-13" tabindex="-1"></a>gAi.L[df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">0</span>] <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="fu">predict</span>(g.A.L, <span class="at">type=</span><span class="st">&quot;response&quot;</span>))[df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">0</span>]</span>
<span id="cb52-14"><a href="msm_chapter.html#cb52-14" tabindex="-1"></a></span>
<span id="cb52-15"><a href="msm_chapter.html#cb52-15" tabindex="-1"></a><span class="co"># 1c. Estimate g(A=a_i) (numerator of the weight)</span></span>
<span id="cb52-16"><a href="msm_chapter.html#cb52-16" tabindex="-1"></a>g.A <span class="ot">&lt;-</span> <span class="fu">glm</span>(A0_PM2<span class="fl">.5</span> <span class="sc">~</span> <span class="dv">1</span>, <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>, <span class="at">data =</span> df1_int)</span>
<span id="cb52-17"><a href="msm_chapter.html#cb52-17" tabindex="-1"></a><span class="co"># 1d. Predict each individual&#39;s probability of being exposed to her own exposure</span></span>
<span id="cb52-18"><a href="msm_chapter.html#cb52-18" tabindex="-1"></a><span class="co"># the predicted probability of the observed treatment g(A = a_i) is :</span></span>
<span id="cb52-19"><a href="msm_chapter.html#cb52-19" tabindex="-1"></a>gAi <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">nrow</span>(df1_int))</span>
<span id="cb52-20"><a href="msm_chapter.html#cb52-20" tabindex="-1"></a>gAi[df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">predict</span>(g.A, <span class="at">type=</span><span class="st">&quot;response&quot;</span>)[df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">1</span>]</span>
<span id="cb52-21"><a href="msm_chapter.html#cb52-21" tabindex="-1"></a>gAi[df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">0</span>] <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="fu">predict</span>(g.A, <span class="at">type=</span><span class="st">&quot;response&quot;</span>))[df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">0</span>]</span>
<span id="cb52-22"><a href="msm_chapter.html#cb52-22" tabindex="-1"></a></span>
<span id="cb52-23"><a href="msm_chapter.html#cb52-23" tabindex="-1"></a><span class="co"># 1e. Calculate the weight for the exposure A: sw_{A,i}</span></span>
<span id="cb52-24"><a href="msm_chapter.html#cb52-24" tabindex="-1"></a>sw_Ai <span class="ot">&lt;-</span> gAi <span class="sc">/</span> gAi.L</span>
<span id="cb52-25"><a href="msm_chapter.html#cb52-25" tabindex="-1"></a></span>
<span id="cb52-26"><a href="msm_chapter.html#cb52-26" tabindex="-1"></a><span class="do">## 2. Stabilized weight for the mediator sw_{M,i}</span></span>
<span id="cb52-27"><a href="msm_chapter.html#cb52-27" tabindex="-1"></a><span class="co"># 2a. Estimate g(M=m_i|L(0),A,L(1)) (denominator of the weight)</span></span>
<span id="cb52-28"><a href="msm_chapter.html#cb52-28" tabindex="-1"></a>g.M.L <span class="ot">&lt;-</span> <span class="fu">glm</span>(M_diabetes <span class="sc">~</span> L0_male <span class="sc">+</span> L0_soc_env <span class="sc">+</span> A0_PM2<span class="fl">.5</span> <span class="sc">+</span> L1,</span>
<span id="cb52-29"><a href="msm_chapter.html#cb52-29" tabindex="-1"></a>             <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>, <span class="at">data =</span> df1_int)</span>
<span id="cb52-30"><a href="msm_chapter.html#cb52-30" tabindex="-1"></a><span class="co"># 2b. Predict each individual&#39;s probability of being exposed to her own exposure</span></span>
<span id="cb52-31"><a href="msm_chapter.html#cb52-31" tabindex="-1"></a><span class="co"># the predicted probability of the observed treatment g(A = a_i | L(0)) is :</span></span>
<span id="cb52-32"><a href="msm_chapter.html#cb52-32" tabindex="-1"></a>gMi.L <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">nrow</span>(df1_int))</span>
<span id="cb52-33"><a href="msm_chapter.html#cb52-33" tabindex="-1"></a>gMi.L[df1_int<span class="sc">$</span>M_diabetes<span class="sc">==</span><span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">predict</span>(g.M.L, <span class="at">type=</span><span class="st">&quot;response&quot;</span>)[df1_int<span class="sc">$</span>M_diabetes<span class="sc">==</span><span class="dv">1</span>]</span>
<span id="cb52-34"><a href="msm_chapter.html#cb52-34" tabindex="-1"></a>gMi.L[df1_int<span class="sc">$</span>M_diabetes<span class="sc">==</span><span class="dv">0</span>] <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="fu">predict</span>(g.M.L, <span class="at">type=</span><span class="st">&quot;response&quot;</span>))[df1_int<span class="sc">$</span>M_diabetes<span class="sc">==</span><span class="dv">0</span>]</span>
<span id="cb52-35"><a href="msm_chapter.html#cb52-35" tabindex="-1"></a></span>
<span id="cb52-36"><a href="msm_chapter.html#cb52-36" tabindex="-1"></a><span class="co"># 2c. Estimate g(M=m_i|A) (numerator of the weight)</span></span>
<span id="cb52-37"><a href="msm_chapter.html#cb52-37" tabindex="-1"></a>g.M.A <span class="ot">&lt;-</span> <span class="fu">glm</span>(M_diabetes <span class="sc">~</span> A0_PM2<span class="fl">.5</span>, <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>, <span class="at">data =</span> df1_int)</span>
<span id="cb52-38"><a href="msm_chapter.html#cb52-38" tabindex="-1"></a><span class="co"># 2d. Predict each individual&#39;s probability of being exposed to her own exposure</span></span>
<span id="cb52-39"><a href="msm_chapter.html#cb52-39" tabindex="-1"></a><span class="co"># the predicted probability of the observed treatment g(M = m_i|A) is :</span></span>
<span id="cb52-40"><a href="msm_chapter.html#cb52-40" tabindex="-1"></a>gMi.A <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">nrow</span>(df1_int))</span>
<span id="cb52-41"><a href="msm_chapter.html#cb52-41" tabindex="-1"></a>gMi.A[df1_int<span class="sc">$</span>M_diabetes<span class="sc">==</span><span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">predict</span>(g.M.A, <span class="at">type=</span><span class="st">&quot;response&quot;</span>)[df1_int<span class="sc">$</span>M_diabetes<span class="sc">==</span><span class="dv">1</span>]</span>
<span id="cb52-42"><a href="msm_chapter.html#cb52-42" tabindex="-1"></a>gMi.A[df1_int<span class="sc">$</span>M_diabetes<span class="sc">==</span><span class="dv">0</span>] <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="fu">predict</span>(g.M.A, <span class="at">type=</span><span class="st">&quot;response&quot;</span>))[df1_int<span class="sc">$</span>M_diabetes<span class="sc">==</span><span class="dv">0</span>]</span>
<span id="cb52-43"><a href="msm_chapter.html#cb52-43" tabindex="-1"></a><span class="co"># 2e. Calculate the weight for the mediator M: sw_{M,i}</span></span>
<span id="cb52-44"><a href="msm_chapter.html#cb52-44" tabindex="-1"></a>sw_Mi <span class="ot">&lt;-</span> gMi.A <span class="sc">/</span> gMi.L</span>
<span id="cb52-45"><a href="msm_chapter.html#cb52-45" tabindex="-1"></a></span>
<span id="cb52-46"><a href="msm_chapter.html#cb52-46" tabindex="-1"></a><span class="do">## 3. Define the individual stabilized weight for the CDE_m</span></span>
<span id="cb52-47"><a href="msm_chapter.html#cb52-47" tabindex="-1"></a>sw_cde <span class="ot">&lt;-</span> sw_Ai <span class="sc">*</span> sw_Mi</span>
<span id="cb52-48"><a href="msm_chapter.html#cb52-48" tabindex="-1"></a></span>
<span id="cb52-49"><a href="msm_chapter.html#cb52-49" tabindex="-1"></a><span class="do">## 4. Estimate coefficients of the MSM using a weighted regression E(Y | A, sex)</span></span>
<span id="cb52-50"><a href="msm_chapter.html#cb52-50" tabindex="-1"></a><span class="co"># a GLM with gaussian family can be applied to estimate risk differences</span></span>
<span id="cb52-51"><a href="msm_chapter.html#cb52-51" tabindex="-1"></a>msm_cde <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y_death <span class="sc">~</span> A0_PM2<span class="fl">.5</span> <span class="sc">+</span> M_diabetes <span class="sc">+</span> A0_PM2<span class="fl">.5</span><span class="sc">*</span>M_diabetes,</span>
<span id="cb52-52"><a href="msm_chapter.html#cb52-52" tabindex="-1"></a>               <span class="at">weights =</span> sw_cde,</span>
<span id="cb52-53"><a href="msm_chapter.html#cb52-53" tabindex="-1"></a>               <span class="at">family =</span> <span class="st">&quot;gaussian&quot;</span>,</span>
<span id="cb52-54"><a href="msm_chapter.html#cb52-54" tabindex="-1"></a>               <span class="at">data =</span> df1_int)</span>
<span id="cb52-55"><a href="msm_chapter.html#cb52-55" tabindex="-1"></a><span class="fu">coef</span>(msm_cde)</span>
<span id="cb52-56"><a href="msm_chapter.html#cb52-56" tabindex="-1"></a><span class="co"># (Intercept)            A0_PM2.5          M_diabetes A0_PM2.5:M_diabetes </span></span>
<span id="cb52-57"><a href="msm_chapter.html#cb52-57" tabindex="-1"></a><span class="co">#  0.17891689          0.06798282          0.06729724         -0.00495314</span></span>
<span id="cb52-58"><a href="msm_chapter.html#cb52-58" tabindex="-1"></a></span>
<span id="cb52-59"><a href="msm_chapter.html#cb52-59" tabindex="-1"></a><span class="do">## 5. Estimate CDE for m=0 and for m=1 using the MSM&#39;s coefficients</span></span>
<span id="cb52-60"><a href="msm_chapter.html#cb52-60" tabindex="-1"></a>CDE_mis0 <span class="ot">&lt;-</span> <span class="fu">coef</span>(msm_cde)[<span class="st">&quot;A0_PM2.5&quot;</span>]</span>
<span id="cb52-61"><a href="msm_chapter.html#cb52-61" tabindex="-1"></a><span class="co"># 0.06798282</span></span>
<span id="cb52-62"><a href="msm_chapter.html#cb52-62" tabindex="-1"></a>CDE_mis1 <span class="ot">&lt;-</span> <span class="fu">coef</span>(msm_cde)[<span class="st">&quot;A0_PM2.5&quot;</span>] <span class="sc">+</span> <span class="fu">coef</span>(msm_cde)[<span class="st">&quot;A0_PM2.5:M_diabetes&quot;</span>]</span>
<span id="cb52-63"><a href="msm_chapter.html#cb52-63" tabindex="-1"></a><span class="co"># 0.06302968</span></span></code></pre></div>
<p>In this example, our estimates of the controlled direct effects are <span class="math inline">\(CDE_{M=0} = 6.8\%\)</span> and <span class="math inline">\(CDE_{M=1} = 6.3\%\)</span>. Confidence intervals can be calculated by bootstrap.</p>
<p>Importantly, this approach for the estimation of the controlled direct effect <span class="math inline">\(\text{CDE}_m\)</span> by IPTW is also valid if the exposure <span class="math inline">\(A\)</span> affects the intermediate confounder <span class="math inline">\(L(1)\)</span> (as with the Causal model 2).</p>
</div>
<div id="example-2-with-intermediate-confounder-affected-by-the-exposure" class="section level4 hasAnchor" number="8.2.2.2">
<h4><span class="header-section-number">8.2.2.2</span> Example 2, with intermediate confounder affected by the exposure<a href="msm_chapter.html#example-2-with-intermediate-confounder-affected-by-the-exposure" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Below, we estimate the CDE by hand, and using the <code>ltmle</code> package and the <code>CMAverse</code> package</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="msm_chapter.html#cb53-1" tabindex="-1"></a><span class="do">### MSM of CDE, estimated by IPTW</span></span>
<span id="cb53-2"><a href="msm_chapter.html#cb53-2" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list=</span><span class="fu">ls</span>())</span>
<span id="cb53-3"><a href="msm_chapter.html#cb53-3" tabindex="-1"></a>df2_int <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="st">&quot;data/df2_int.csv&quot;</span>)</span>
<span id="cb53-4"><a href="msm_chapter.html#cb53-4" tabindex="-1"></a></span>
<span id="cb53-5"><a href="msm_chapter.html#cb53-5" tabindex="-1"></a><span class="do">## 1. Stabilized weight for the exposure sw_{A,i}</span></span>
<span id="cb53-6"><a href="msm_chapter.html#cb53-6" tabindex="-1"></a><span class="co"># 1a. Estimate g(A=a_i|L(0)) (denominator of the weight)</span></span>
<span id="cb53-7"><a href="msm_chapter.html#cb53-7" tabindex="-1"></a>g.A.L <span class="ot">&lt;-</span> <span class="fu">glm</span>(A0_PM2<span class="fl">.5</span> <span class="sc">~</span> L0_male <span class="sc">+</span> L0_soc_env,</span>
<span id="cb53-8"><a href="msm_chapter.html#cb53-8" tabindex="-1"></a>             <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>, <span class="at">data =</span> df2_int)</span>
<span id="cb53-9"><a href="msm_chapter.html#cb53-9" tabindex="-1"></a><span class="co"># 1b. Predict each individual&#39;s probability of being exposed to her own exposure</span></span>
<span id="cb53-10"><a href="msm_chapter.html#cb53-10" tabindex="-1"></a><span class="co"># the predicted probability of the observed treatment g(A = a_i | L(0)) is :</span></span>
<span id="cb53-11"><a href="msm_chapter.html#cb53-11" tabindex="-1"></a>gAi.L <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">nrow</span>(df2_int))</span>
<span id="cb53-12"><a href="msm_chapter.html#cb53-12" tabindex="-1"></a>gAi.L[df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">predict</span>(g.A.L, <span class="at">type=</span><span class="st">&quot;response&quot;</span>)[df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">1</span>]</span>
<span id="cb53-13"><a href="msm_chapter.html#cb53-13" tabindex="-1"></a>gAi.L[df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">0</span>] <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="fu">predict</span>(g.A.L, <span class="at">type=</span><span class="st">&quot;response&quot;</span>))[df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">0</span>]</span>
<span id="cb53-14"><a href="msm_chapter.html#cb53-14" tabindex="-1"></a></span>
<span id="cb53-15"><a href="msm_chapter.html#cb53-15" tabindex="-1"></a><span class="co"># 1c. Estimate g(A=a_i) (numerator of the weight)</span></span>
<span id="cb53-16"><a href="msm_chapter.html#cb53-16" tabindex="-1"></a>g.A <span class="ot">&lt;-</span> <span class="fu">glm</span>(A0_PM2<span class="fl">.5</span> <span class="sc">~</span> <span class="dv">1</span>, <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>, <span class="at">data =</span> df2_int)</span>
<span id="cb53-17"><a href="msm_chapter.html#cb53-17" tabindex="-1"></a><span class="co"># 1d. Predict each individual&#39;s probability of being exposed to her own exposure</span></span>
<span id="cb53-18"><a href="msm_chapter.html#cb53-18" tabindex="-1"></a><span class="co"># the predicted probability of the observed treatment g(A = a_i) is :</span></span>
<span id="cb53-19"><a href="msm_chapter.html#cb53-19" tabindex="-1"></a>gAi <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">nrow</span>(df2_int))</span>
<span id="cb53-20"><a href="msm_chapter.html#cb53-20" tabindex="-1"></a>gAi[df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">predict</span>(g.A, <span class="at">type=</span><span class="st">&quot;response&quot;</span>)[df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">1</span>]</span>
<span id="cb53-21"><a href="msm_chapter.html#cb53-21" tabindex="-1"></a>gAi[df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">0</span>] <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="fu">predict</span>(g.A, <span class="at">type=</span><span class="st">&quot;response&quot;</span>))[df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">0</span>]</span>
<span id="cb53-22"><a href="msm_chapter.html#cb53-22" tabindex="-1"></a></span>
<span id="cb53-23"><a href="msm_chapter.html#cb53-23" tabindex="-1"></a><span class="co"># 1e. Calculate the weight for the exposure A: sw_{A,i}</span></span>
<span id="cb53-24"><a href="msm_chapter.html#cb53-24" tabindex="-1"></a>sw_Ai <span class="ot">&lt;-</span> gAi <span class="sc">/</span> gAi.L</span>
<span id="cb53-25"><a href="msm_chapter.html#cb53-25" tabindex="-1"></a></span>
<span id="cb53-26"><a href="msm_chapter.html#cb53-26" tabindex="-1"></a><span class="do">## 2. Stabilized weight for the mediator sw_{M,i}</span></span>
<span id="cb53-27"><a href="msm_chapter.html#cb53-27" tabindex="-1"></a><span class="co"># 2a. Estimate g(M=m_i|L(0),A,L(1)) (denominator of the weight)</span></span>
<span id="cb53-28"><a href="msm_chapter.html#cb53-28" tabindex="-1"></a>g.M.L <span class="ot">&lt;-</span> <span class="fu">glm</span>(M_diabetes <span class="sc">~</span> L0_male <span class="sc">+</span> L0_soc_env <span class="sc">+</span> A0_PM2<span class="fl">.5</span> <span class="sc">+</span> L1,</span>
<span id="cb53-29"><a href="msm_chapter.html#cb53-29" tabindex="-1"></a>             <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>, <span class="at">data =</span> df2_int)</span>
<span id="cb53-30"><a href="msm_chapter.html#cb53-30" tabindex="-1"></a><span class="co"># 2b. Predict each individual&#39;s probability of being exposed to her own exposure</span></span>
<span id="cb53-31"><a href="msm_chapter.html#cb53-31" tabindex="-1"></a><span class="co"># the predicted probability of the observed treatment g(A = a_i | L(0)) is :</span></span>
<span id="cb53-32"><a href="msm_chapter.html#cb53-32" tabindex="-1"></a>gMi.L <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">nrow</span>(df2_int))</span>
<span id="cb53-33"><a href="msm_chapter.html#cb53-33" tabindex="-1"></a>gMi.L[df2_int<span class="sc">$</span>M_diabetes<span class="sc">==</span><span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">predict</span>(g.M.L, <span class="at">type=</span><span class="st">&quot;response&quot;</span>)[df2_int<span class="sc">$</span>M_diabetes<span class="sc">==</span><span class="dv">1</span>]</span>
<span id="cb53-34"><a href="msm_chapter.html#cb53-34" tabindex="-1"></a>gMi.L[df2_int<span class="sc">$</span>M_diabetes<span class="sc">==</span><span class="dv">0</span>] <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="fu">predict</span>(g.M.L, <span class="at">type=</span><span class="st">&quot;response&quot;</span>))[df2_int<span class="sc">$</span>M_diabetes<span class="sc">==</span><span class="dv">0</span>]</span>
<span id="cb53-35"><a href="msm_chapter.html#cb53-35" tabindex="-1"></a></span>
<span id="cb53-36"><a href="msm_chapter.html#cb53-36" tabindex="-1"></a><span class="co"># 2c. Estimate g(M=m_i|A) (numerator of the weight)</span></span>
<span id="cb53-37"><a href="msm_chapter.html#cb53-37" tabindex="-1"></a>g.M.A <span class="ot">&lt;-</span> <span class="fu">glm</span>(M_diabetes <span class="sc">~</span> A0_PM2<span class="fl">.5</span>, <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>, <span class="at">data =</span> df2_int)</span>
<span id="cb53-38"><a href="msm_chapter.html#cb53-38" tabindex="-1"></a><span class="co"># 2d. Predict each individual&#39;s probability of being exposed to her own exposure</span></span>
<span id="cb53-39"><a href="msm_chapter.html#cb53-39" tabindex="-1"></a><span class="co"># the predicted probability of the observed treatment g(M = m_i|A) is :</span></span>
<span id="cb53-40"><a href="msm_chapter.html#cb53-40" tabindex="-1"></a>gMi.A <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">nrow</span>(df2_int))</span>
<span id="cb53-41"><a href="msm_chapter.html#cb53-41" tabindex="-1"></a>gMi.A[df2_int<span class="sc">$</span>M_diabetes<span class="sc">==</span><span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">predict</span>(g.M.A, <span class="at">type=</span><span class="st">&quot;response&quot;</span>)[df2_int<span class="sc">$</span>M_diabetes<span class="sc">==</span><span class="dv">1</span>]</span>
<span id="cb53-42"><a href="msm_chapter.html#cb53-42" tabindex="-1"></a>gMi.A[df2_int<span class="sc">$</span>M_diabetes<span class="sc">==</span><span class="dv">0</span>] <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="fu">predict</span>(g.M.A, <span class="at">type=</span><span class="st">&quot;response&quot;</span>))[df2_int<span class="sc">$</span>M_diabetes<span class="sc">==</span><span class="dv">0</span>]</span>
<span id="cb53-43"><a href="msm_chapter.html#cb53-43" tabindex="-1"></a><span class="co"># 2e. Calculate the weight for the mediator M: sw_{M,i}</span></span>
<span id="cb53-44"><a href="msm_chapter.html#cb53-44" tabindex="-1"></a>sw_Mi <span class="ot">&lt;-</span> gMi.A <span class="sc">/</span> gMi.L</span>
<span id="cb53-45"><a href="msm_chapter.html#cb53-45" tabindex="-1"></a></span>
<span id="cb53-46"><a href="msm_chapter.html#cb53-46" tabindex="-1"></a><span class="do">## 3. Define the individual stabilized weight for the CDE_m</span></span>
<span id="cb53-47"><a href="msm_chapter.html#cb53-47" tabindex="-1"></a>sw_cde <span class="ot">&lt;-</span> sw_Ai <span class="sc">*</span> sw_Mi</span>
<span id="cb53-48"><a href="msm_chapter.html#cb53-48" tabindex="-1"></a></span>
<span id="cb53-49"><a href="msm_chapter.html#cb53-49" tabindex="-1"></a><span class="do">## 4. Estimate coefficients of the MSM using a weighted regression E(Y | A, sex)</span></span>
<span id="cb53-50"><a href="msm_chapter.html#cb53-50" tabindex="-1"></a><span class="co"># a GLM with gaussian family can be applied to estimate risk differences</span></span>
<span id="cb53-51"><a href="msm_chapter.html#cb53-51" tabindex="-1"></a>msm_cde <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y_death <span class="sc">~</span> A0_PM2<span class="fl">.5</span> <span class="sc">+</span> M_diabetes <span class="sc">+</span> A0_PM2<span class="fl">.5</span><span class="sc">*</span>M_diabetes,</span>
<span id="cb53-52"><a href="msm_chapter.html#cb53-52" tabindex="-1"></a>               <span class="at">weights =</span> sw_cde,</span>
<span id="cb53-53"><a href="msm_chapter.html#cb53-53" tabindex="-1"></a>               <span class="at">family =</span> <span class="st">&quot;gaussian&quot;</span>,</span>
<span id="cb53-54"><a href="msm_chapter.html#cb53-54" tabindex="-1"></a>               <span class="at">data =</span> df2_int)</span>
<span id="cb53-55"><a href="msm_chapter.html#cb53-55" tabindex="-1"></a><span class="fu">coef</span>(msm_cde)</span>
<span id="cb53-56"><a href="msm_chapter.html#cb53-56" tabindex="-1"></a><span class="co"># (Intercept)            A0_PM2.5          M_diabetes A0_PM2.5:M_diabetes</span></span>
<span id="cb53-57"><a href="msm_chapter.html#cb53-57" tabindex="-1"></a><span class="co">#  0.17932146          0.06012920          0.07239661          0.03017266</span></span>
<span id="cb53-58"><a href="msm_chapter.html#cb53-58" tabindex="-1"></a></span>
<span id="cb53-59"><a href="msm_chapter.html#cb53-59" tabindex="-1"></a><span class="do">## 5. Estimate CDE for m=0 and for m=1 using the MSM&#39;s coefficients</span></span>
<span id="cb53-60"><a href="msm_chapter.html#cb53-60" tabindex="-1"></a>CDE_mis0 <span class="ot">&lt;-</span> <span class="fu">coef</span>(msm_cde)[<span class="st">&quot;A0_PM2.5&quot;</span>]</span>
<span id="cb53-61"><a href="msm_chapter.html#cb53-61" tabindex="-1"></a><span class="co"># 0.0601292</span></span>
<span id="cb53-62"><a href="msm_chapter.html#cb53-62" tabindex="-1"></a>CDE_mis1 <span class="ot">&lt;-</span> <span class="fu">coef</span>(msm_cde)[<span class="st">&quot;A0_PM2.5&quot;</span>] <span class="sc">+</span> <span class="fu">coef</span>(msm_cde)[<span class="st">&quot;A0_PM2.5:M_diabetes&quot;</span>]</span>
<span id="cb53-63"><a href="msm_chapter.html#cb53-63" tabindex="-1"></a><span class="co"># 0.09030186</span></span>
<span id="cb53-64"><a href="msm_chapter.html#cb53-64" tabindex="-1"></a></span>
<span id="cb53-65"><a href="msm_chapter.html#cb53-65" tabindex="-1"></a></span>
<span id="cb53-66"><a href="msm_chapter.html#cb53-66" tabindex="-1"></a><span class="do">### Estimation by IPTW using ltmle package</span></span>
<span id="cb53-67"><a href="msm_chapter.html#cb53-67" tabindex="-1"></a><span class="fu">library</span>(ltmle)</span>
<span id="cb53-68"><a href="msm_chapter.html#cb53-68" tabindex="-1"></a>Qform <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">L1=</span><span class="st">&quot;Q.kplus1 ~ L0_male + L0_soc_env + A0_PM2.5&quot;</span>,</span>
<span id="cb53-69"><a href="msm_chapter.html#cb53-69" tabindex="-1"></a>           <span class="at">Y_death=</span><span class="st">&quot;Q.kplus1 ~ L0_male + L0_soc_env + L1 +</span></span>
<span id="cb53-70"><a href="msm_chapter.html#cb53-70" tabindex="-1"></a><span class="st">                    A0_PM2.5 * M_diabetes&quot;</span>)</span>
<span id="cb53-71"><a href="msm_chapter.html#cb53-71" tabindex="-1"></a>gform <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;A0_PM2.5 ~ L0_male + L0_soc_env&quot;</span>,</span>
<span id="cb53-72"><a href="msm_chapter.html#cb53-72" tabindex="-1"></a>           <span class="st">&quot;M_diabetes ~ L0_male + L0_soc_env + A0_PM2.5 + L1&quot;</span>)</span>
<span id="cb53-73"><a href="msm_chapter.html#cb53-73" tabindex="-1"></a>data_binary <span class="ot">&lt;-</span> <span class="fu">subset</span>(df2_int, <span class="at">select =</span> <span class="fu">c</span>(L0_male, L0_soc_env,</span>
<span id="cb53-74"><a href="msm_chapter.html#cb53-74" tabindex="-1"></a>                                          A0_PM2<span class="fl">.5</span>, L1,</span>
<span id="cb53-75"><a href="msm_chapter.html#cb53-75" tabindex="-1"></a>                                          M_diabetes, Y_death))</span>
<span id="cb53-76"><a href="msm_chapter.html#cb53-76" tabindex="-1"></a>CDE_ltmle_M0_death <span class="ot">&lt;-</span> <span class="fu">ltmle</span>(<span class="at">data =</span> data_binary,</span>
<span id="cb53-77"><a href="msm_chapter.html#cb53-77" tabindex="-1"></a>                            <span class="at">Anodes =</span> <span class="fu">c</span>(<span class="st">&quot;A0_PM2.5&quot;</span>, <span class="st">&quot;M_diabetes&quot;</span>),</span>
<span id="cb53-78"><a href="msm_chapter.html#cb53-78" tabindex="-1"></a>                            <span class="at">Lnodes =</span> <span class="fu">c</span>(<span class="st">&quot;L1&quot;</span>), <span class="co"># intermediate confounders +/- baseline</span></span>
<span id="cb53-79"><a href="msm_chapter.html#cb53-79" tabindex="-1"></a>                            <span class="at">Ynodes =</span> <span class="fu">c</span>(<span class="st">&quot;Y_death&quot;</span>),</span>
<span id="cb53-80"><a href="msm_chapter.html#cb53-80" tabindex="-1"></a>                            <span class="at">survivalOutcome =</span> <span class="cn">FALSE</span>, <span class="co"># TRUE for time-to-event outcomes Y</span></span>
<span id="cb53-81"><a href="msm_chapter.html#cb53-81" tabindex="-1"></a>                            <span class="at">Qform =</span> Qform,</span>
<span id="cb53-82"><a href="msm_chapter.html#cb53-82" tabindex="-1"></a>                            <span class="at">gform =</span> gform,</span>
<span id="cb53-83"><a href="msm_chapter.html#cb53-83" tabindex="-1"></a>                            <span class="at">abar =</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">0</span>), <span class="co"># counterfactual intervention do(A=1,M=0)</span></span>
<span id="cb53-84"><a href="msm_chapter.html#cb53-84" tabindex="-1"></a>                                        <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>)), <span class="co"># counterfactual intervention do(A=0,M=0)</span></span>
<span id="cb53-85"><a href="msm_chapter.html#cb53-85" tabindex="-1"></a>                            <span class="at">SL.library =</span> <span class="cn">NULL</span>,</span>
<span id="cb53-86"><a href="msm_chapter.html#cb53-86" tabindex="-1"></a>                            <span class="at">estimate.time =</span> <span class="cn">FALSE</span>, <span class="co"># estimate computation time?</span></span>
<span id="cb53-87"><a href="msm_chapter.html#cb53-87" tabindex="-1"></a>                            <span class="at">iptw.only =</span> <span class="cn">TRUE</span>, <span class="co"># for only IPTW estimations (no TMLE)</span></span>
<span id="cb53-88"><a href="msm_chapter.html#cb53-88" tabindex="-1"></a>                            <span class="at">gcomp =</span> <span class="cn">FALSE</span>,</span>
<span id="cb53-89"><a href="msm_chapter.html#cb53-89" tabindex="-1"></a>                            <span class="at">variance.method =</span> <span class="st">&quot;iptw&quot;</span>) <span class="co"># IPTW influence curve</span></span>
<span id="cb53-90"><a href="msm_chapter.html#cb53-90" tabindex="-1"></a><span class="co"># CDE with M=0</span></span>
<span id="cb53-91"><a href="msm_chapter.html#cb53-91" tabindex="-1"></a><span class="fu">summary</span>(CDE_ltmle_M0_death, <span class="at">estimator =</span> <span class="st">&quot;iptw&quot;</span>)<span class="sc">$</span>effect.measures<span class="sc">$</span>ATE</span>
<span id="cb53-92"><a href="msm_chapter.html#cb53-92" tabindex="-1"></a><span class="co"># $estimate</span></span>
<span id="cb53-93"><a href="msm_chapter.html#cb53-93" tabindex="-1"></a><span class="co"># [1] 0.0601292</span></span>
<span id="cb53-94"><a href="msm_chapter.html#cb53-94" tabindex="-1"></a><span class="co"># $CI</span></span>
<span id="cb53-95"><a href="msm_chapter.html#cb53-95" tabindex="-1"></a><span class="co">#            2.5%      97.5%</span></span>
<span id="cb53-96"><a href="msm_chapter.html#cb53-96" tabindex="-1"></a><span class="co"># [1,] 0.02424819 0.09601021</span></span>
<span id="cb53-97"><a href="msm_chapter.html#cb53-97" tabindex="-1"></a></span>
<span id="cb53-98"><a href="msm_chapter.html#cb53-98" tabindex="-1"></a>CDE_ltmle_M1_death <span class="ot">&lt;-</span> <span class="fu">ltmle</span>(<span class="at">data =</span> data_binary,</span>
<span id="cb53-99"><a href="msm_chapter.html#cb53-99" tabindex="-1"></a>                            <span class="at">Anodes =</span> <span class="fu">c</span>(<span class="st">&quot;A0_PM2.5&quot;</span>, <span class="st">&quot;M_diabetes&quot;</span>),</span>
<span id="cb53-100"><a href="msm_chapter.html#cb53-100" tabindex="-1"></a>                            <span class="at">Lnodes =</span> <span class="fu">c</span>(<span class="st">&quot;L1&quot;</span>), <span class="co"># intermediate confounders +/- baseline</span></span>
<span id="cb53-101"><a href="msm_chapter.html#cb53-101" tabindex="-1"></a>                            <span class="at">Ynodes =</span> <span class="fu">c</span>(<span class="st">&quot;Y_death&quot;</span>),</span>
<span id="cb53-102"><a href="msm_chapter.html#cb53-102" tabindex="-1"></a>                            <span class="at">survivalOutcome =</span> <span class="cn">FALSE</span>, <span class="co"># TRUE for time-to-event outcomes Y</span></span>
<span id="cb53-103"><a href="msm_chapter.html#cb53-103" tabindex="-1"></a>                            <span class="at">Qform =</span> Qform,</span>
<span id="cb53-104"><a href="msm_chapter.html#cb53-104" tabindex="-1"></a>                            <span class="at">gform =</span> gform,</span>
<span id="cb53-105"><a href="msm_chapter.html#cb53-105" tabindex="-1"></a>                            <span class="at">abar =</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>), <span class="co"># counterfactual intervention do(A=1,M=0)</span></span>
<span id="cb53-106"><a href="msm_chapter.html#cb53-106" tabindex="-1"></a>                                        <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)), <span class="co"># counterfactual intervention do(A=0,M=0)</span></span>
<span id="cb53-107"><a href="msm_chapter.html#cb53-107" tabindex="-1"></a>                            <span class="at">SL.library =</span> <span class="cn">NULL</span>,</span>
<span id="cb53-108"><a href="msm_chapter.html#cb53-108" tabindex="-1"></a>                            <span class="at">estimate.time =</span> <span class="cn">FALSE</span>, <span class="co"># estimate computation time?</span></span>
<span id="cb53-109"><a href="msm_chapter.html#cb53-109" tabindex="-1"></a>                            <span class="at">iptw.only =</span> <span class="cn">TRUE</span>, <span class="co"># for only IPTW estimations (no TMLE)</span></span>
<span id="cb53-110"><a href="msm_chapter.html#cb53-110" tabindex="-1"></a>                            <span class="at">gcomp =</span> <span class="cn">FALSE</span>,</span>
<span id="cb53-111"><a href="msm_chapter.html#cb53-111" tabindex="-1"></a>                            <span class="at">variance.method =</span> <span class="st">&quot;iptw&quot;</span>) <span class="co"># IPTW influence curve</span></span>
<span id="cb53-112"><a href="msm_chapter.html#cb53-112" tabindex="-1"></a><span class="co"># CDE with M=1</span></span>
<span id="cb53-113"><a href="msm_chapter.html#cb53-113" tabindex="-1"></a><span class="fu">summary</span>(CDE_ltmle_M1_death, <span class="at">estimator =</span> <span class="st">&quot;iptw&quot;</span>)<span class="sc">$</span>effect.measures<span class="sc">$</span>ATE</span>
<span id="cb53-114"><a href="msm_chapter.html#cb53-114" tabindex="-1"></a><span class="co"># $estimate</span></span>
<span id="cb53-115"><a href="msm_chapter.html#cb53-115" tabindex="-1"></a><span class="co"># [1] 0.09030186</span></span>
<span id="cb53-116"><a href="msm_chapter.html#cb53-116" tabindex="-1"></a><span class="co"># $CI</span></span>
<span id="cb53-117"><a href="msm_chapter.html#cb53-117" tabindex="-1"></a><span class="co">#            2.5%     97.5%</span></span>
<span id="cb53-118"><a href="msm_chapter.html#cb53-118" tabindex="-1"></a><span class="co"># [1,] 0.04084792 0.1397558</span></span>
<span id="cb53-119"><a href="msm_chapter.html#cb53-119" tabindex="-1"></a></span>
<span id="cb53-120"><a href="msm_chapter.html#cb53-120" tabindex="-1"></a><span class="do">## we obtain the same results as the IPTW estimation by hand</span></span>
<span id="cb53-121"><a href="msm_chapter.html#cb53-121" tabindex="-1"></a></span>
<span id="cb53-122"><a href="msm_chapter.html#cb53-122" tabindex="-1"></a></span>
<span id="cb53-123"><a href="msm_chapter.html#cb53-123" tabindex="-1"></a><span class="do">### Estimation by IPTW using ltmle package</span></span>
<span id="cb53-124"><a href="msm_chapter.html#cb53-124" tabindex="-1"></a><span class="fu">library</span>(CMAverse)</span>
<span id="cb53-125"><a href="msm_chapter.html#cb53-125" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list=</span><span class="fu">ls</span>())</span>
<span id="cb53-126"><a href="msm_chapter.html#cb53-126" tabindex="-1"></a>df2_int <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="st">&quot;data/df2_int.csv&quot;</span>)</span>
<span id="cb53-127"><a href="msm_chapter.html#cb53-127" tabindex="-1"></a><span class="fu">cmdag</span>(<span class="at">outcome =</span> <span class="st">&quot;Y_death&quot;</span>, <span class="at">exposure =</span> <span class="st">&quot;A0_PM2.5&quot;</span>, <span class="at">mediator =</span> <span class="st">&quot;M_diabetes&quot;</span>,</span>
<span id="cb53-128"><a href="msm_chapter.html#cb53-128" tabindex="-1"></a>      <span class="at">basec =</span> <span class="fu">c</span>(<span class="st">&quot;L0_male&quot;</span>, <span class="st">&quot;L0_soc_env&quot;</span>), <span class="at">postc =</span> <span class="st">&quot;L1&quot;</span>, <span class="at">node =</span> <span class="cn">TRUE</span>, <span class="at">text_col =</span> <span class="st">&quot;white&quot;</span>)</span>
<span id="cb53-129"><a href="msm_chapter.html#cb53-129" tabindex="-1"></a><span class="co"># In this setting, we can use the marginal structural model and the $g$-formula approach. The results are shown below.</span></span>
<span id="cb53-130"><a href="msm_chapter.html#cb53-130" tabindex="-1"></a></span>
<span id="cb53-131"><a href="msm_chapter.html#cb53-131" tabindex="-1"></a><span class="do">## The Marginal Structural Model</span></span>
<span id="cb53-132"><a href="msm_chapter.html#cb53-132" tabindex="-1"></a>res_msm_RD <span class="ot">&lt;-</span> <span class="fu">cmest</span>(<span class="at">data =</span> df2_int,</span>
<span id="cb53-133"><a href="msm_chapter.html#cb53-133" tabindex="-1"></a>                    <span class="at">model =</span> <span class="st">&quot;msm&quot;</span>,</span>
<span id="cb53-134"><a href="msm_chapter.html#cb53-134" tabindex="-1"></a>                    <span class="at">outcome =</span> <span class="st">&quot;Y_death&quot;</span>,</span>
<span id="cb53-135"><a href="msm_chapter.html#cb53-135" tabindex="-1"></a>                    <span class="at">exposure =</span> <span class="st">&quot;A0_PM2.5&quot;</span>,</span>
<span id="cb53-136"><a href="msm_chapter.html#cb53-136" tabindex="-1"></a>                    <span class="at">mediator =</span> <span class="st">&quot;M_diabetes&quot;</span>,</span>
<span id="cb53-137"><a href="msm_chapter.html#cb53-137" tabindex="-1"></a>                    <span class="at">basec =</span> <span class="fu">c</span>(<span class="st">&quot;L0_male&quot;</span>, <span class="st">&quot;L0_soc_env&quot;</span>),</span>
<span id="cb53-138"><a href="msm_chapter.html#cb53-138" tabindex="-1"></a>                    <span class="at">postc =</span> <span class="st">&quot;L1&quot;</span>,</span>
<span id="cb53-139"><a href="msm_chapter.html#cb53-139" tabindex="-1"></a>                    <span class="at">EMint =</span> <span class="cn">TRUE</span>, <span class="co"># E*M interaction</span></span>
<span id="cb53-140"><a href="msm_chapter.html#cb53-140" tabindex="-1"></a>                    <span class="at">ereg =</span> <span class="st">&quot;logistic&quot;</span>,</span>
<span id="cb53-141"><a href="msm_chapter.html#cb53-141" tabindex="-1"></a>                    <span class="at">yreg =</span> <span class="st">&quot;linear&quot;</span>, <span class="co"># MSM is a linear regression (to get RD)</span></span>
<span id="cb53-142"><a href="msm_chapter.html#cb53-142" tabindex="-1"></a>                    <span class="at">mreg =</span> <span class="fu">list</span>(<span class="st">&quot;logistic&quot;</span>),</span>
<span id="cb53-143"><a href="msm_chapter.html#cb53-143" tabindex="-1"></a>                    <span class="at">wmnomreg =</span> <span class="fu">list</span>(<span class="st">&quot;logistic&quot;</span>),</span>
<span id="cb53-144"><a href="msm_chapter.html#cb53-144" tabindex="-1"></a>                    <span class="at">wmdenomreg =</span> <span class="fu">list</span>(<span class="st">&quot;logistic&quot;</span>),</span>
<span id="cb53-145"><a href="msm_chapter.html#cb53-145" tabindex="-1"></a>                    <span class="at">astar =</span> <span class="dv">0</span>, <span class="co">#E(Y_{A=0,M=1})</span></span>
<span id="cb53-146"><a href="msm_chapter.html#cb53-146" tabindex="-1"></a>                    <span class="at">a =</span> <span class="dv">1</span>,  <span class="co">#E(Y_{A=1,M=1})</span></span>
<span id="cb53-147"><a href="msm_chapter.html#cb53-147" tabindex="-1"></a>                    <span class="at">mval =</span> <span class="fu">list</span>(<span class="dv">1</span>), <span class="co"># for the CDE, set mediator to M=1</span></span>
<span id="cb53-148"><a href="msm_chapter.html#cb53-148" tabindex="-1"></a>                    <span class="at">estimation =</span> <span class="st">&quot;imputation&quot;</span>,</span>
<span id="cb53-149"><a href="msm_chapter.html#cb53-149" tabindex="-1"></a>                    <span class="at">inference =</span> <span class="st">&quot;bootstrap&quot;</span>,</span>
<span id="cb53-150"><a href="msm_chapter.html#cb53-150" tabindex="-1"></a>                    <span class="at">nboot =</span> <span class="dv">2</span>)</span>
<span id="cb53-151"><a href="msm_chapter.html#cb53-151" tabindex="-1"></a></span>
<span id="cb53-152"><a href="msm_chapter.html#cb53-152" tabindex="-1"></a><span class="fu">summary</span>(res_msm_RD)</span>
<span id="cb53-153"><a href="msm_chapter.html#cb53-153" tabindex="-1"></a><span class="co"># Causal Mediation Analysis</span></span>
<span id="cb53-154"><a href="msm_chapter.html#cb53-154" tabindex="-1"></a><span class="co"># # Outcome regression:</span></span>
<span id="cb53-155"><a href="msm_chapter.html#cb53-155" tabindex="-1"></a><span class="co"># Call:</span></span>
<span id="cb53-156"><a href="msm_chapter.html#cb53-156" tabindex="-1"></a><span class="co">#   glm(formula = Y_death ~ A0_PM2.5 + M_diabetes + A0_PM2.5 * M_diabetes, </span></span>
<span id="cb53-157"><a href="msm_chapter.html#cb53-157" tabindex="-1"></a><span class="co">#       family = gaussian(), data = getCall(x$reg.output$yreg)$data, </span></span>
<span id="cb53-158"><a href="msm_chapter.html#cb53-158" tabindex="-1"></a><span class="co">#       weights = getCall(x$reg.output$yreg)$weights)</span></span>
<span id="cb53-159"><a href="msm_chapter.html#cb53-159" tabindex="-1"></a><span class="co"># Coefficients:</span></span>
<span id="cb53-160"><a href="msm_chapter.html#cb53-160" tabindex="-1"></a><span class="co">#                       Estimate Std. Error t value Pr(&gt;|t|)      # MSM coef</span></span>
<span id="cb53-161"><a href="msm_chapter.html#cb53-161" tabindex="-1"></a><span class="co">#   (Intercept)         0.179321   0.005242  34.210  &lt; 2e-16 ***  # are the</span></span>
<span id="cb53-162"><a href="msm_chapter.html#cb53-162" tabindex="-1"></a><span class="co">#   A0_PM2.5            0.060129   0.017253   3.485 0.000494 ***  # same as</span></span>
<span id="cb53-163"><a href="msm_chapter.html#cb53-163" tabindex="-1"></a><span class="co">#   M_diabetes          0.072397   0.009242   7.834 5.21e-15 ***  # calculation</span></span>
<span id="cb53-164"><a href="msm_chapter.html#cb53-164" tabindex="-1"></a><span class="co">#   A0_PM2.5:M_diabetes 0.030173   0.025895   1.165 0.243960      # by hand</span></span>
<span id="cb53-165"><a href="msm_chapter.html#cb53-165" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb53-166"><a href="msm_chapter.html#cb53-166" tabindex="-1"></a><span class="co"># # Mediator regressions: </span></span>
<span id="cb53-167"><a href="msm_chapter.html#cb53-167" tabindex="-1"></a><span class="co"># Call:</span></span>
<span id="cb53-168"><a href="msm_chapter.html#cb53-168" tabindex="-1"></a><span class="co">#   glm(formula = M_diabetes ~ A0_PM2.5, family = binomial(), data = getCall(x$reg.output$mreg[[1L]])$data, </span></span>
<span id="cb53-169"><a href="msm_chapter.html#cb53-169" tabindex="-1"></a><span class="co">#       weights = getCall(x$reg.output$mreg[[1L]])$weights)</span></span>
<span id="cb53-170"><a href="msm_chapter.html#cb53-170" tabindex="-1"></a><span class="co"># Coefficients:</span></span>
<span id="cb53-171"><a href="msm_chapter.html#cb53-171" tabindex="-1"></a><span class="co">#               Estimate Std. Error z value Pr(&gt;|z|)    </span></span>
<span id="cb53-172"><a href="msm_chapter.html#cb53-172" tabindex="-1"></a><span class="co">#   (Intercept) -0.73432    0.02268 -32.384  &lt; 2e-16 ***</span></span>
<span id="cb53-173"><a href="msm_chapter.html#cb53-173" tabindex="-1"></a><span class="co">#   A0_PM2.5     0.51531    0.06422   8.024 1.02e-15 ***</span></span>
<span id="cb53-174"><a href="msm_chapter.html#cb53-174" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb53-175"><a href="msm_chapter.html#cb53-175" tabindex="-1"></a><span class="co"># # Mediator regressions for weighting (denominator): </span></span>
<span id="cb53-176"><a href="msm_chapter.html#cb53-176" tabindex="-1"></a><span class="co"># Call:</span></span>
<span id="cb53-177"><a href="msm_chapter.html#cb53-177" tabindex="-1"></a><span class="co">#   glm(formula = M_diabetes ~ A0_PM2.5 + L0_male + L0_soc_env + </span></span>
<span id="cb53-178"><a href="msm_chapter.html#cb53-178" tabindex="-1"></a><span class="co">#         L1, family = binomial(), data = getCall(x$reg.output$wmdenomreg[[1L]])$data, </span></span>
<span id="cb53-179"><a href="msm_chapter.html#cb53-179" tabindex="-1"></a><span class="co">#       weights = getCall(x$reg.output$wmdenomreg[[1L]])$weights)</span></span>
<span id="cb53-180"><a href="msm_chapter.html#cb53-180" tabindex="-1"></a><span class="co"># Coefficients:</span></span>
<span id="cb53-181"><a href="msm_chapter.html#cb53-181" tabindex="-1"></a><span class="co">#               Estimate Std. Error z value Pr(&gt;|z|)    </span></span>
<span id="cb53-182"><a href="msm_chapter.html#cb53-182" tabindex="-1"></a><span class="co">#   (Intercept) -1.36249    0.04783 -28.488  &lt; 2e-16 ***</span></span>
<span id="cb53-183"><a href="msm_chapter.html#cb53-183" tabindex="-1"></a><span class="co">#   A0_PM2.5     0.30994    0.06668   4.648 3.35e-06 ***</span></span>
<span id="cb53-184"><a href="msm_chapter.html#cb53-184" tabindex="-1"></a><span class="co">#   L0_male      0.24661    0.04369   5.644 1.66e-08 ***</span></span>
<span id="cb53-185"><a href="msm_chapter.html#cb53-185" tabindex="-1"></a><span class="co">#   L0_soc_env   0.30628    0.04650   6.587 4.50e-11 ***</span></span>
<span id="cb53-186"><a href="msm_chapter.html#cb53-186" tabindex="-1"></a><span class="co">#   L1           0.86045    0.04493  19.152  &lt; 2e-16 ***</span></span>
<span id="cb53-187"><a href="msm_chapter.html#cb53-187" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb53-188"><a href="msm_chapter.html#cb53-188" tabindex="-1"></a><span class="co"># # Mediator regressions for weighting (nominator): </span></span>
<span id="cb53-189"><a href="msm_chapter.html#cb53-189" tabindex="-1"></a><span class="co"># Call:</span></span>
<span id="cb53-190"><a href="msm_chapter.html#cb53-190" tabindex="-1"></a><span class="co">#   glm(formula = M_diabetes ~ A0_PM2.5, family = binomial(), data = getCall(x$reg.output$wmnomreg[[1L]])$data, </span></span>
<span id="cb53-191"><a href="msm_chapter.html#cb53-191" tabindex="-1"></a><span class="co">#       weights = getCall(x$reg.output$wmnomreg[[1L]])$weights)</span></span>
<span id="cb53-192"><a href="msm_chapter.html#cb53-192" tabindex="-1"></a><span class="co"># Coefficients:</span></span>
<span id="cb53-193"><a href="msm_chapter.html#cb53-193" tabindex="-1"></a><span class="co">#               Estimate Std. Error z value Pr(&gt;|z|)    </span></span>
<span id="cb53-194"><a href="msm_chapter.html#cb53-194" tabindex="-1"></a><span class="co">#   (Intercept) -0.74205    0.02271 -32.680   &lt;2e-16 ***</span></span>
<span id="cb53-195"><a href="msm_chapter.html#cb53-195" tabindex="-1"></a><span class="co">#   A0_PM2.5     0.55288    0.06408   8.628   &lt;2e-16 ***</span></span>
<span id="cb53-196"><a href="msm_chapter.html#cb53-196" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb53-197"><a href="msm_chapter.html#cb53-197" tabindex="-1"></a><span class="co"># # Exposure regression for weighting: </span></span>
<span id="cb53-198"><a href="msm_chapter.html#cb53-198" tabindex="-1"></a><span class="co"># Call:</span></span>
<span id="cb53-199"><a href="msm_chapter.html#cb53-199" tabindex="-1"></a><span class="co">#   glm(formula = A0_PM2.5 ~ L0_male + L0_soc_env, family = binomial(), </span></span>
<span id="cb53-200"><a href="msm_chapter.html#cb53-200" tabindex="-1"></a><span class="co">#       data = getCall(x$reg.output$ereg)$data, weights = getCall(x$reg.output$ereg)$weights)</span></span>
<span id="cb53-201"><a href="msm_chapter.html#cb53-201" tabindex="-1"></a><span class="co"># Coefficients:</span></span>
<span id="cb53-202"><a href="msm_chapter.html#cb53-202" tabindex="-1"></a><span class="co">#               Estimate Std. Error z value Pr(&gt;|z|)    </span></span>
<span id="cb53-203"><a href="msm_chapter.html#cb53-203" tabindex="-1"></a><span class="co">#   (Intercept) -2.73244    0.07425 -36.799  &lt; 2e-16 ***</span></span>
<span id="cb53-204"><a href="msm_chapter.html#cb53-204" tabindex="-1"></a><span class="co">#   L0_male      0.40580    0.06447   6.294 3.09e-10 ***</span></span>
<span id="cb53-205"><a href="msm_chapter.html#cb53-205" tabindex="-1"></a><span class="co">#   L0_soc_env   0.64060    0.07350   8.716  &lt; 2e-16 ***</span></span>
<span id="cb53-206"><a href="msm_chapter.html#cb53-206" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb53-207"><a href="msm_chapter.html#cb53-207" tabindex="-1"></a><span class="co"># # Effect decomposition on the mean difference scale via the marginal structural model</span></span>
<span id="cb53-208"><a href="msm_chapter.html#cb53-208" tabindex="-1"></a><span class="co"># Direct counterfactual imputation estimation with </span></span>
<span id="cb53-209"><a href="msm_chapter.html#cb53-209" tabindex="-1"></a><span class="co"># bootstrap standard errors, percentile confidence intervals and p-values </span></span>
<span id="cb53-210"><a href="msm_chapter.html#cb53-210" tabindex="-1"></a><span class="co">#                   Estimate  Std.error    95% CIL 95% CIU  P.val    </span></span>
<span id="cb53-211"><a href="msm_chapter.html#cb53-211" tabindex="-1"></a><span class="co">#   cde            9.030e-02  1.601e-02  6.094e-02   0.082 &lt;2e-16 *** # same result</span></span>
<span id="cb53-212"><a href="msm_chapter.html#cb53-212" tabindex="-1"></a><span class="co">#   rpnde          7.003e-02  1.600e-02  5.838e-02   0.080 &lt;2e-16 ***</span></span>
<span id="cb53-213"><a href="msm_chapter.html#cb53-213" tabindex="-1"></a><span class="co">#   rtnde          7.374e-02  1.597e-02  5.888e-02   0.080 &lt;2e-16 ***</span></span>
<span id="cb53-214"><a href="msm_chapter.html#cb53-214" tabindex="-1"></a><span class="co">#   rpnie          8.903e-03  9.159e-04  8.284e-03   0.010 &lt;2e-16 ***</span></span>
<span id="cb53-215"><a href="msm_chapter.html#cb53-215" tabindex="-1"></a><span class="co">#   rtnie          1.261e-02  9.523e-04  8.738e-03   0.010 &lt;2e-16 ***</span></span>
<span id="cb53-216"><a href="msm_chapter.html#cb53-216" tabindex="-1"></a><span class="co">#   te             8.265e-02  1.505e-02  6.839e-02   0.089 &lt;2e-16 ***</span></span>
<span id="cb53-217"><a href="msm_chapter.html#cb53-217" tabindex="-1"></a><span class="co">#   rintref       -2.027e-02  7.341e-06 -2.571e-03  -0.003 &lt;2e-16 ***</span></span>
<span id="cb53-218"><a href="msm_chapter.html#cb53-218" tabindex="-1"></a><span class="co">#   rintmed        3.710e-03  3.634e-05  4.542e-04   0.001 &lt;2e-16 ***</span></span>
<span id="cb53-219"><a href="msm_chapter.html#cb53-219" tabindex="-1"></a><span class="co">#   cde(prop)      1.093e+00  2.940e-02  8.907e-01   0.930 &lt;2e-16 ***</span></span>
<span id="cb53-220"><a href="msm_chapter.html#cb53-220" tabindex="-1"></a><span class="co">#   rintref(prop) -2.452e-01  6.289e-03 -3.752e-02  -0.029 &lt;2e-16 ***</span></span>
<span id="cb53-221"><a href="msm_chapter.html#cb53-221" tabindex="-1"></a><span class="co">#   rintmed(prop)  4.489e-02  1.662e-03  5.140e-03   0.007 &lt;2e-16 ***</span></span>
<span id="cb53-222"><a href="msm_chapter.html#cb53-222" tabindex="-1"></a><span class="co">#   rpnie(prop)    1.077e-01  3.403e-02  9.376e-02   0.139 &lt;2e-16 ***</span></span>
<span id="cb53-223"><a href="msm_chapter.html#cb53-223" tabindex="-1"></a><span class="co">#   rpm            1.526e-01  3.569e-02  9.890e-02   0.147 &lt;2e-16 ***</span></span>
<span id="cb53-224"><a href="msm_chapter.html#cb53-224" tabindex="-1"></a><span class="co">#   rint          -2.004e-01  4.627e-03 -3.014e-02  -0.024 &lt;2e-16 ***</span></span>
<span id="cb53-225"><a href="msm_chapter.html#cb53-225" tabindex="-1"></a><span class="co">#   rpe           -9.263e-02  2.940e-02  6.983e-02   0.109 &lt;2e-16 ***</span></span>
<span id="cb53-226"><a href="msm_chapter.html#cb53-226" tabindex="-1"></a><span class="co">#   ---</span></span>
<span id="cb53-227"><a href="msm_chapter.html#cb53-227" tabindex="-1"></a><span class="co">#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1</span></span>
<span id="cb53-228"><a href="msm_chapter.html#cb53-228" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb53-229"><a href="msm_chapter.html#cb53-229" tabindex="-1"></a><span class="co">#  (cde: controlled direct effect; </span></span>
<span id="cb53-230"><a href="msm_chapter.html#cb53-230" tabindex="-1"></a><span class="co">#  rpnde: randomized analogue of pure natural direct effect; </span></span>
<span id="cb53-231"><a href="msm_chapter.html#cb53-231" tabindex="-1"></a><span class="co">#  rtnde: randomized analogue of total natural direct effect; </span></span>
<span id="cb53-232"><a href="msm_chapter.html#cb53-232" tabindex="-1"></a><span class="co">#  rpnie: randomized analogue of pure natural indirect effect; </span></span>
<span id="cb53-233"><a href="msm_chapter.html#cb53-233" tabindex="-1"></a><span class="co">#  rtnie: randomized analogue of total natural indirect effect; </span></span>
<span id="cb53-234"><a href="msm_chapter.html#cb53-234" tabindex="-1"></a><span class="co">#  te: total effect; rintref: randomized analogue of reference interaction; </span></span>
<span id="cb53-235"><a href="msm_chapter.html#cb53-235" tabindex="-1"></a><span class="co">#  rintmed: randomized analogue of mediated interaction; </span></span>
<span id="cb53-236"><a href="msm_chapter.html#cb53-236" tabindex="-1"></a><span class="co">#  cde(prop): proportion cde; </span></span>
<span id="cb53-237"><a href="msm_chapter.html#cb53-237" tabindex="-1"></a><span class="co">#  rintref(prop): proportion rintref; </span></span>
<span id="cb53-238"><a href="msm_chapter.html#cb53-238" tabindex="-1"></a><span class="co">#  rintmed(prop): proportion rintmed; </span></span>
<span id="cb53-239"><a href="msm_chapter.html#cb53-239" tabindex="-1"></a><span class="co">#  rpnie(prop): proportion rpnie; </span></span>
<span id="cb53-240"><a href="msm_chapter.html#cb53-240" tabindex="-1"></a><span class="co">#  rpm: randomized analogue of overall proportion mediated; </span></span>
<span id="cb53-241"><a href="msm_chapter.html#cb53-241" tabindex="-1"></a><span class="co">#  rint: randomized analogue of overall proportion attributable to interaction; </span></span>
<span id="cb53-242"><a href="msm_chapter.html#cb53-242" tabindex="-1"></a><span class="co">#  rpe: randomized analogue of overall proportion eliminated)</span></span></code></pre></div>
</div>
</div>
<div id="estimation-of-the-msm-coefficients-by-g-computation" class="section level3 hasAnchor" number="8.2.3">
<h3><span class="header-section-number">8.2.3</span> Estimation of the MSM coefficients by G-computation<a href="msm_chapter.html#estimation-of-the-msm-coefficients-by-g-computation" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>As for the ATE, we can use G-computation to estimate the coefficients of the MSM to estimate Controlled Direct Effects.</p>
<p>Note that the algorithm described below is correct only if the exposure <span class="math inline">\(A\)</span> doesn’t affect the intermediate confounders <span class="math inline">\(L(1)\)</span> of the <span class="math inline">\(M \rightarrow Y\)</span> relationship (such as the data simulated from the Causal model 1 in our examples). In that case, the following steps can be applied:</p>
<ol style="list-style-type: decimal">
<li><p>Fit a (logistic or a linear) regression to estimate <span class="math inline">\(\overline{Q} = \mathbb{E}(Y \mid A,M, L(0),L(1))\)</span></p></li>
<li><p>Use this estimate to predict an outcome for each subject under the counterfactual scenarios <span class="math inline">\(\hat{\overline{Q}}(A=0,M=m,L(0),L(1))_i\)</span> and <span class="math inline">\(\hat{\overline{Q}}(A=1,M=m,L(0),L(1))_i\)</span>, by evaluating the regression fit <span class="math inline">\(\overline{Q}\)</span> at <span class="math inline">\((A=0,M=m)\)</span> and <span class="math inline">\((A=1,M=m)\)</span> respectively. If we want to set the level of the mediator to <span class="math inline">\(M=0\)</span> and <span class="math inline">\(M=1\)</span>, this would give 4 counterfactual scenarios <span class="math inline">\(\text{do}(A=0,M=0)\)</span>, <span class="math inline">\(\text{do}(A=1,M=0)\)</span>, <span class="math inline">\(\text{do}(A=0,M=1)\)</span> and <span class="math inline">\(\text{do}(A=1,M=1)\)</span>.</p></li>
<li><p>Duplicate the initial dataset for each scenario in a single long dataset in which:</p></li>
</ol>
<ul>
<li>the 1st part of the long dataset corresponds to the first counterfactual scenario with <span class="math inline">\((A=0,M=0)\)</span> for all individuals and an additional column for the predicted counterfactual outcome <span class="math inline">\(\mathbb{E}(Y_{A=0,M=0}\mid L(0),L(1)) = \hat{\overline{Q}}(A=0,M=0,L(0),L(1))\)</span> ;</li>
<li>the 2d part of the long dataset corresponds to the second counterfactual scenario with <span class="math inline">\((A=1,M=0)\)</span> for all individuals and an additional column for the predicted counterfactual outcome <span class="math inline">\(\mathbb{E}(Y_{A=1,M=0}\mid L(0),L(1)) = \hat{\overline{Q}}(A=1,M=0,L(0),L(1))\)</span> ;</li>
<li>the 3d part of the long dataset corresponds to the second counterfactual scenario with <span class="math inline">\((A=0,M=1)\)</span> for all individuals and an additional column for the predicted counterfactual outcome <span class="math inline">\(\mathbb{E}(Y_{A=0,M=1}\mid L(0),L(1)) = \hat{\overline{Q}}(A=0,M=1,L(0),L(1))\)</span> ;</li>
<li>the 4th part of the long dataset corresponds to the second counterfactual scenario with <span class="math inline">\((A=1,M=1)\)</span> for all individuals and an additional column for the predicted counterfactual outcome <span class="math inline">\(\mathbb{E}(Y_{A=1,M=1}\mid L(0),L(1)) = \hat{\overline{Q}}(A=1,M=1,L(0),L(1))\)</span> ;</li>
</ul>
<ol start="4" style="list-style-type: decimal">
<li>Fit the MSM <span class="math inline">\(\mathbb{E}(Y_{am}) = \alpha_0 + \alpha_A a + \alpha_M m + \alpha_{A \ast M} a \times m\)</span> using the long dataset.</li>
</ol>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="msm_chapter.html#cb54-1" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list=</span><span class="fu">ls</span>())</span>
<span id="cb54-2"><a href="msm_chapter.html#cb54-2" tabindex="-1"></a>df1_int <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="st">&quot;data/df1_int.csv&quot;</span>)</span>
<span id="cb54-3"><a href="msm_chapter.html#cb54-3" tabindex="-1"></a></span>
<span id="cb54-4"><a href="msm_chapter.html#cb54-4" tabindex="-1"></a><span class="do">### MSM of CDE, estimated by G-computation -------------------------------------</span></span>
<span id="cb54-5"><a href="msm_chapter.html#cb54-5" tabindex="-1"></a><span class="do">## 1. Estimate Qbar(A,M,L0,L1)</span></span>
<span id="cb54-6"><a href="msm_chapter.html#cb54-6" tabindex="-1"></a>Q.cde.death <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y_death <span class="sc">~</span> A0_PM2<span class="fl">.5</span> <span class="sc">+</span> M_diabetes <span class="sc">+</span> A0_PM2<span class="fl">.5</span><span class="sc">:</span>M_diabetes <span class="sc">+</span> </span>
<span id="cb54-7"><a href="msm_chapter.html#cb54-7" tabindex="-1"></a>                     L0_male <span class="sc">+</span> L0_soc_env <span class="sc">+</span> L1,</span>
<span id="cb54-8"><a href="msm_chapter.html#cb54-8" tabindex="-1"></a>                   <span class="at">family =</span> <span class="st">&quot;gaussian&quot;</span>, <span class="at">data =</span> df1_int)</span>
<span id="cb54-9"><a href="msm_chapter.html#cb54-9" tabindex="-1"></a><span class="co"># The final result would be sligthly different if we applied a binomial family</span></span>
<span id="cb54-10"><a href="msm_chapter.html#cb54-10" tabindex="-1"></a><span class="co"># The Gaussian family corresponds to the true generating model in this example.</span></span>
<span id="cb54-11"><a href="msm_chapter.html#cb54-11" tabindex="-1"></a></span>
<span id="cb54-12"><a href="msm_chapter.html#cb54-12" tabindex="-1"></a><span class="do">## 2. Predict an outcome for each subject, in each counterfactual scenario</span></span>
<span id="cb54-13"><a href="msm_chapter.html#cb54-13" tabindex="-1"></a><span class="co"># Prepare data sets that will be used to predict the outcome under the counterfactual</span></span>
<span id="cb54-14"><a href="msm_chapter.html#cb54-14" tabindex="-1"></a><span class="co"># 4 counterfactual scenarios setting (A=0,M=0), (A=1,M=0), (A=0,M=1) and (A=1,M=1)</span></span>
<span id="cb54-15"><a href="msm_chapter.html#cb54-15" tabindex="-1"></a>data.A0M0 <span class="ot">&lt;-</span> data.A1M0 <span class="ot">&lt;-</span> data.A0M1 <span class="ot">&lt;-</span> data.A1M1 <span class="ot">&lt;-</span> df1_int</span>
<span id="cb54-16"><a href="msm_chapter.html#cb54-16" tabindex="-1"></a>data.A0M0<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb54-17"><a href="msm_chapter.html#cb54-17" tabindex="-1"></a>data.A0M0<span class="sc">$</span>M_diabetes <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb54-18"><a href="msm_chapter.html#cb54-18" tabindex="-1"></a></span>
<span id="cb54-19"><a href="msm_chapter.html#cb54-19" tabindex="-1"></a>data.A1M0<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb54-20"><a href="msm_chapter.html#cb54-20" tabindex="-1"></a>data.A1M0<span class="sc">$</span>M_diabetes <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb54-21"><a href="msm_chapter.html#cb54-21" tabindex="-1"></a></span>
<span id="cb54-22"><a href="msm_chapter.html#cb54-22" tabindex="-1"></a>data.A0M1<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb54-23"><a href="msm_chapter.html#cb54-23" tabindex="-1"></a>data.A0M1<span class="sc">$</span>M_diabetes <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb54-24"><a href="msm_chapter.html#cb54-24" tabindex="-1"></a></span>
<span id="cb54-25"><a href="msm_chapter.html#cb54-25" tabindex="-1"></a>data.A1M1<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb54-26"><a href="msm_chapter.html#cb54-26" tabindex="-1"></a>data.A1M1<span class="sc">$</span>M_diabetes <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb54-27"><a href="msm_chapter.html#cb54-27" tabindex="-1"></a></span>
<span id="cb54-28"><a href="msm_chapter.html#cb54-28" tabindex="-1"></a><span class="co"># predict values under the same name in the corresponding counterfactual dataset</span></span>
<span id="cb54-29"><a href="msm_chapter.html#cb54-29" tabindex="-1"></a>data.A0M0<span class="sc">$</span>Yam.death.pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(Q.cde.death, <span class="at">newdata =</span> data.A0M0, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb54-30"><a href="msm_chapter.html#cb54-30" tabindex="-1"></a>data.A1M0<span class="sc">$</span>Yam.death.pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(Q.cde.death, <span class="at">newdata =</span> data.A1M0, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb54-31"><a href="msm_chapter.html#cb54-31" tabindex="-1"></a>data.A0M1<span class="sc">$</span>Yam.death.pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(Q.cde.death, <span class="at">newdata =</span> data.A0M1, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb54-32"><a href="msm_chapter.html#cb54-32" tabindex="-1"></a>data.A1M1<span class="sc">$</span>Yam.death.pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(Q.cde.death, <span class="at">newdata =</span> data.A1M1, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb54-33"><a href="msm_chapter.html#cb54-33" tabindex="-1"></a></span>
<span id="cb54-34"><a href="msm_chapter.html#cb54-34" tabindex="-1"></a><span class="do">## 3. Append the 4 counterfactual datasets in a single long dataset</span></span>
<span id="cb54-35"><a href="msm_chapter.html#cb54-35" tabindex="-1"></a><span class="co"># number of row is 4 times the initial value (we have 4 counterfactual scenarios)</span></span>
<span id="cb54-36"><a href="msm_chapter.html#cb54-36" tabindex="-1"></a>data<span class="fl">.4</span>scenarios <span class="ot">&lt;-</span> <span class="fu">rbind</span>(data.A0M0, data.A1M0,data.A0M1,data.A1M1)</span>
<span id="cb54-37"><a href="msm_chapter.html#cb54-37" tabindex="-1"></a></span>
<span id="cb54-38"><a href="msm_chapter.html#cb54-38" tabindex="-1"></a><span class="do">## 4. fit the MSM: E(Y_am) = alpha_0 + alpha_A a + alpha_M m + alpha_AM a:m</span></span>
<span id="cb54-39"><a href="msm_chapter.html#cb54-39" tabindex="-1"></a>MSM.CDE.gcomp <span class="ot">&lt;-</span> <span class="fu">glm</span>(Yam.death.pred <span class="sc">~</span> A0_PM2<span class="fl">.5</span> <span class="sc">+</span>  M_diabetes <span class="sc">+</span> A0_PM2<span class="fl">.5</span><span class="sc">:</span>M_diabetes,</span>
<span id="cb54-40"><a href="msm_chapter.html#cb54-40" tabindex="-1"></a>                     <span class="at">family =</span> <span class="st">&quot;gaussian&quot;</span>, <span class="co"># gaussian family for risk differences</span></span>
<span id="cb54-41"><a href="msm_chapter.html#cb54-41" tabindex="-1"></a>                     <span class="at">data =</span> data<span class="fl">.4</span>scenarios)</span>
<span id="cb54-42"><a href="msm_chapter.html#cb54-42" tabindex="-1"></a><span class="fu">coef</span>(MSM.CDE.gcomp)</span>
<span id="cb54-43"><a href="msm_chapter.html#cb54-43" tabindex="-1"></a><span class="co"># (Intercept)            A0_PM2.5          M_diabetes A0_PM2.5:M_diabetes </span></span>
<span id="cb54-44"><a href="msm_chapter.html#cb54-44" tabindex="-1"></a><span class="co">#  0.17968603          0.06000138          0.06757214          0.01918153</span></span>
<span id="cb54-45"><a href="msm_chapter.html#cb54-45" tabindex="-1"></a></span>
<span id="cb54-46"><a href="msm_chapter.html#cb54-46" tabindex="-1"></a><span class="do">## 5. Estimate the CDE(M=m)</span></span>
<span id="cb54-47"><a href="msm_chapter.html#cb54-47" tabindex="-1"></a><span class="co"># CDE(M=0) = E(Y_{A=1,M=0}) - E(Y_{A=0,M=0})</span></span>
<span id="cb54-48"><a href="msm_chapter.html#cb54-48" tabindex="-1"></a>CDE_mis0_gcomp <span class="ot">&lt;-</span> <span class="fu">coef</span>(MSM.CDE.gcomp)[<span class="st">&quot;A0_PM2.5&quot;</span>]</span>
<span id="cb54-49"><a href="msm_chapter.html#cb54-49" tabindex="-1"></a><span class="co"># 0.06000138</span></span>
<span id="cb54-50"><a href="msm_chapter.html#cb54-50" tabindex="-1"></a></span>
<span id="cb54-51"><a href="msm_chapter.html#cb54-51" tabindex="-1"></a><span class="co"># CDE(M=1) = E(Y_{A=1,M=1}) - E(Y_{A=0,M=1})</span></span>
<span id="cb54-52"><a href="msm_chapter.html#cb54-52" tabindex="-1"></a>CDE_mis1_gcomp <span class="ot">&lt;-</span> (<span class="fu">coef</span>(MSM.CDE.gcomp)[<span class="st">&quot;A0_PM2.5&quot;</span>] <span class="sc">+</span></span>
<span id="cb54-53"><a href="msm_chapter.html#cb54-53" tabindex="-1"></a>                     <span class="fu">coef</span>(MSM.CDE.gcomp)[<span class="st">&quot;A0_PM2.5:M_diabetes&quot;</span>])</span>
<span id="cb54-54"><a href="msm_chapter.html#cb54-54" tabindex="-1"></a><span class="co"># 0.07918291</span></span>
<span id="cb54-55"><a href="msm_chapter.html#cb54-55" tabindex="-1"></a></span>
<span id="cb54-56"><a href="msm_chapter.html#cb54-56" tabindex="-1"></a><span class="co"># Note: Applying a binomial family for the first Qbar model would result in two</span></span>
<span id="cb54-57"><a href="msm_chapter.html#cb54-57" tabindex="-1"></a><span class="co"># sligthly different values of the CDE(M=m)</span></span>
<span id="cb54-58"><a href="msm_chapter.html#cb54-58" tabindex="-1"></a><span class="co"># =&gt; 0.05934409 in setting M=0</span></span>
<span id="cb54-59"><a href="msm_chapter.html#cb54-59" tabindex="-1"></a><span class="co"># =&gt; 0.07537874 in setting M=1</span></span></code></pre></div>
<p>If the exposure <span class="math inline">\(A\)</span> affects the intermediate confounder <span class="math inline">\(L(1)\)</span>, as in the Causal model 2, the steps 1) and 2) of the algorithm should follow the method described in paragraph <a href="ChapGcomp.html#ChapGcomp-CDE-param">6.2.1</a> or <a href="ChapGcomp.html#ChapGcomp-CDE-ICE">6.2.2</a>.</p>
<p>Here is an example applying G-computation by iterative conditional expectation:</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="msm_chapter.html#cb55-1" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list=</span><span class="fu">ls</span>())</span>
<span id="cb55-2"><a href="msm_chapter.html#cb55-2" tabindex="-1"></a>df2_int <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="st">&quot;data/df2_int.csv&quot;</span>)</span>
<span id="cb55-3"><a href="msm_chapter.html#cb55-3" tabindex="-1"></a></span>
<span id="cb55-4"><a href="msm_chapter.html#cb55-4" tabindex="-1"></a><span class="do">### MSM of CDE, estimated by G-computation (by ICE) ----------------------------</span></span>
<span id="cb55-5"><a href="msm_chapter.html#cb55-5" tabindex="-1"></a><span class="do">## 1a) Regress the outcome on L0, A, L1 and M (and the A*M interaction if appropriate)</span></span>
<span id="cb55-6"><a href="msm_chapter.html#cb55-6" tabindex="-1"></a>Y.death.model <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y_death <span class="sc">~</span> L0_male <span class="sc">+</span> L0_soc_env <span class="sc">+</span> A0_PM2<span class="fl">.5</span> <span class="sc">+</span> L1 <span class="sc">+</span></span>
<span id="cb55-7"><a href="msm_chapter.html#cb55-7" tabindex="-1"></a>                       M_diabetes <span class="sc">+</span> A0_PM2<span class="fl">.5</span><span class="sc">:</span>M_diabetes,</span>
<span id="cb55-8"><a href="msm_chapter.html#cb55-8" tabindex="-1"></a>                     <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>, <span class="at">data =</span> df2_int)</span>
<span id="cb55-9"><a href="msm_chapter.html#cb55-9" tabindex="-1"></a></span>
<span id="cb55-10"><a href="msm_chapter.html#cb55-10" tabindex="-1"></a><span class="do">## 1b) Generate predicted values by evaluating the regression  </span></span>
<span id="cb55-11"><a href="msm_chapter.html#cb55-11" tabindex="-1"></a><span class="do">##     under the 4 counterfactual scenarios</span></span>
<span id="cb55-12"><a href="msm_chapter.html#cb55-12" tabindex="-1"></a>data.A0M0 <span class="ot">&lt;-</span> data.A1M0 <span class="ot">&lt;-</span> data.A0M1 <span class="ot">&lt;-</span> data.A1M1 <span class="ot">&lt;-</span> df2_int</span>
<span id="cb55-13"><a href="msm_chapter.html#cb55-13" tabindex="-1"></a>data.A0M0<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb55-14"><a href="msm_chapter.html#cb55-14" tabindex="-1"></a>data.A0M0<span class="sc">$</span>M_diabetes <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb55-15"><a href="msm_chapter.html#cb55-15" tabindex="-1"></a></span>
<span id="cb55-16"><a href="msm_chapter.html#cb55-16" tabindex="-1"></a>data.A1M0<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb55-17"><a href="msm_chapter.html#cb55-17" tabindex="-1"></a>data.A1M0<span class="sc">$</span>M_diabetes <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb55-18"><a href="msm_chapter.html#cb55-18" tabindex="-1"></a></span>
<span id="cb55-19"><a href="msm_chapter.html#cb55-19" tabindex="-1"></a>data.A0M1<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb55-20"><a href="msm_chapter.html#cb55-20" tabindex="-1"></a>data.A0M1<span class="sc">$</span>M_diabetes <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb55-21"><a href="msm_chapter.html#cb55-21" tabindex="-1"></a></span>
<span id="cb55-22"><a href="msm_chapter.html#cb55-22" tabindex="-1"></a>data.A1M1<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb55-23"><a href="msm_chapter.html#cb55-23" tabindex="-1"></a>data.A1M1<span class="sc">$</span>M_diabetes <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb55-24"><a href="msm_chapter.html#cb55-24" tabindex="-1"></a></span>
<span id="cb55-25"><a href="msm_chapter.html#cb55-25" tabindex="-1"></a>Q.Y.death.A0M0 <span class="ot">&lt;-</span> <span class="fu">predict</span>(Y.death.model, <span class="at">newdata =</span> data.A0M0, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb55-26"><a href="msm_chapter.html#cb55-26" tabindex="-1"></a>Q.Y.death.A1M0 <span class="ot">&lt;-</span> <span class="fu">predict</span>(Y.death.model, <span class="at">newdata =</span> data.A1M0, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb55-27"><a href="msm_chapter.html#cb55-27" tabindex="-1"></a>Q.Y.death.A0M1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(Y.death.model, <span class="at">newdata =</span> data.A0M1, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb55-28"><a href="msm_chapter.html#cb55-28" tabindex="-1"></a>Q.Y.death.A1M1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(Y.death.model, <span class="at">newdata =</span> data.A1M1, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb55-29"><a href="msm_chapter.html#cb55-29" tabindex="-1"></a></span>
<span id="cb55-30"><a href="msm_chapter.html#cb55-30" tabindex="-1"></a><span class="do">## 2a) Regress the predicted values conditional on the observed exposure A</span></span>
<span id="cb55-31"><a href="msm_chapter.html#cb55-31" tabindex="-1"></a><span class="do">##    and baseline confounders L(0)</span></span>
<span id="cb55-32"><a href="msm_chapter.html#cb55-32" tabindex="-1"></a>L1.death.A0M0.model <span class="ot">&lt;-</span> <span class="fu">glm</span>(Q.Y.death.A0M0 <span class="sc">~</span> L0_male <span class="sc">+</span> L0_soc_env <span class="sc">+</span> A0_PM2<span class="fl">.5</span>,</span>
<span id="cb55-33"><a href="msm_chapter.html#cb55-33" tabindex="-1"></a>                           <span class="at">family =</span> <span class="st">&quot;quasibinomial&quot;</span>, <span class="at">data =</span> df2_int)</span>
<span id="cb55-34"><a href="msm_chapter.html#cb55-34" tabindex="-1"></a>L1.death.A1M0.model <span class="ot">&lt;-</span> <span class="fu">glm</span>(Q.Y.death.A1M0 <span class="sc">~</span> L0_male <span class="sc">+</span> L0_soc_env <span class="sc">+</span> A0_PM2<span class="fl">.5</span>,</span>
<span id="cb55-35"><a href="msm_chapter.html#cb55-35" tabindex="-1"></a>                           <span class="at">family =</span> <span class="st">&quot;quasibinomial&quot;</span>, <span class="at">data =</span> df2_int)</span>
<span id="cb55-36"><a href="msm_chapter.html#cb55-36" tabindex="-1"></a>L1.death.A0M1.model <span class="ot">&lt;-</span> <span class="fu">glm</span>(Q.Y.death.A0M1 <span class="sc">~</span> L0_male <span class="sc">+</span> L0_soc_env <span class="sc">+</span> A0_PM2<span class="fl">.5</span>,</span>
<span id="cb55-37"><a href="msm_chapter.html#cb55-37" tabindex="-1"></a>                           <span class="at">family =</span> <span class="st">&quot;quasibinomial&quot;</span>, <span class="at">data =</span> df2_int)</span>
<span id="cb55-38"><a href="msm_chapter.html#cb55-38" tabindex="-1"></a>L1.death.A1M1.model <span class="ot">&lt;-</span> <span class="fu">glm</span>(Q.Y.death.A1M1 <span class="sc">~</span> L0_male <span class="sc">+</span> L0_soc_env <span class="sc">+</span> A0_PM2<span class="fl">.5</span>,</span>
<span id="cb55-39"><a href="msm_chapter.html#cb55-39" tabindex="-1"></a>                           <span class="at">family =</span> <span class="st">&quot;quasibinomial&quot;</span>, <span class="at">data =</span> df2_int)</span>
<span id="cb55-40"><a href="msm_chapter.html#cb55-40" tabindex="-1"></a></span>
<span id="cb55-41"><a href="msm_chapter.html#cb55-41" tabindex="-1"></a></span>
<span id="cb55-42"><a href="msm_chapter.html#cb55-42" tabindex="-1"></a><span class="do">## 2b) generate predicted values by evaluating the regression at exposure</span></span>
<span id="cb55-43"><a href="msm_chapter.html#cb55-43" tabindex="-1"></a><span class="do">##    of interest: {A=0,M=0}, {A=1,M=0}, {A=0,M=1}, {A=1,M=1}</span></span>
<span id="cb55-44"><a href="msm_chapter.html#cb55-44" tabindex="-1"></a>data.A0M0<span class="sc">$</span>Yam.death.pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(L1.death.A0M0.model,</span>
<span id="cb55-45"><a href="msm_chapter.html#cb55-45" tabindex="-1"></a>                                    <span class="at">newdata =</span> data.A0M0, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb55-46"><a href="msm_chapter.html#cb55-46" tabindex="-1"></a>data.A1M0<span class="sc">$</span>Yam.death.pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(L1.death.A1M0.model,</span>
<span id="cb55-47"><a href="msm_chapter.html#cb55-47" tabindex="-1"></a>                                    <span class="at">newdata =</span> data.A1M0, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb55-48"><a href="msm_chapter.html#cb55-48" tabindex="-1"></a>data.A0M1<span class="sc">$</span>Yam.death.pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(L1.death.A0M1.model,</span>
<span id="cb55-49"><a href="msm_chapter.html#cb55-49" tabindex="-1"></a>                                    <span class="at">newdata =</span> data.A0M1, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb55-50"><a href="msm_chapter.html#cb55-50" tabindex="-1"></a>data.A1M1<span class="sc">$</span>Yam.death.pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(L1.death.A1M1.model,</span>
<span id="cb55-51"><a href="msm_chapter.html#cb55-51" tabindex="-1"></a>                                    <span class="at">newdata =</span> data.A1M1, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb55-52"><a href="msm_chapter.html#cb55-52" tabindex="-1"></a></span>
<span id="cb55-53"><a href="msm_chapter.html#cb55-53" tabindex="-1"></a></span>
<span id="cb55-54"><a href="msm_chapter.html#cb55-54" tabindex="-1"></a><span class="do">## 3. Append the 4 counterfactual datasets in a single long dataset</span></span>
<span id="cb55-55"><a href="msm_chapter.html#cb55-55" tabindex="-1"></a><span class="co"># number of row is 4 times the initial value (we have 4 counterfactual scenarios)</span></span>
<span id="cb55-56"><a href="msm_chapter.html#cb55-56" tabindex="-1"></a>data<span class="fl">.4</span>scenarios <span class="ot">&lt;-</span> <span class="fu">rbind</span>(data.A0M0, data.A1M0,data.A0M1,data.A1M1)</span>
<span id="cb55-57"><a href="msm_chapter.html#cb55-57" tabindex="-1"></a></span>
<span id="cb55-58"><a href="msm_chapter.html#cb55-58" tabindex="-1"></a><span class="do">## 4. fit the MSM: E(Y_am) = alpha_0 + alpha_A a + alpha_M m + alpha_AM a:m</span></span>
<span id="cb55-59"><a href="msm_chapter.html#cb55-59" tabindex="-1"></a>MSM.CDE.gcomp <span class="ot">&lt;-</span> <span class="fu">glm</span>(Yam.death.pred <span class="sc">~</span> A0_PM2<span class="fl">.5</span> <span class="sc">+</span>  M_diabetes <span class="sc">+</span> A0_PM2<span class="fl">.5</span><span class="sc">:</span>M_diabetes,</span>
<span id="cb55-60"><a href="msm_chapter.html#cb55-60" tabindex="-1"></a>                     <span class="at">family =</span> <span class="st">&quot;gaussian&quot;</span>, <span class="co"># gaussian family for risk differences</span></span>
<span id="cb55-61"><a href="msm_chapter.html#cb55-61" tabindex="-1"></a>                     <span class="at">data =</span> data<span class="fl">.4</span>scenarios)</span>
<span id="cb55-62"><a href="msm_chapter.html#cb55-62" tabindex="-1"></a><span class="fu">coef</span>(MSM.CDE.gcomp)</span>
<span id="cb55-63"><a href="msm_chapter.html#cb55-63" tabindex="-1"></a><span class="co"># (Intercept)            A0_PM2.5          M_diabetes A0_PM2.5:M_diabetes </span></span>
<span id="cb55-64"><a href="msm_chapter.html#cb55-64" tabindex="-1"></a><span class="co">#  0.17974947          0.06342833          0.07366466          0.02469485</span></span>
<span id="cb55-65"><a href="msm_chapter.html#cb55-65" tabindex="-1"></a></span>
<span id="cb55-66"><a href="msm_chapter.html#cb55-66" tabindex="-1"></a><span class="do">## 5. Estimate the CDE(M=m)</span></span>
<span id="cb55-67"><a href="msm_chapter.html#cb55-67" tabindex="-1"></a><span class="co"># CDE(M=0) = E(Y_{A=1,M=0}) - E(Y_{A=0,M=0})</span></span>
<span id="cb55-68"><a href="msm_chapter.html#cb55-68" tabindex="-1"></a>CDE_mis0_gcomp_ice <span class="ot">&lt;-</span> <span class="fu">coef</span>(MSM.CDE.gcomp)[<span class="st">&quot;A0_PM2.5&quot;</span>]</span>
<span id="cb55-69"><a href="msm_chapter.html#cb55-69" tabindex="-1"></a><span class="co"># 0.06342833</span></span>
<span id="cb55-70"><a href="msm_chapter.html#cb55-70" tabindex="-1"></a></span>
<span id="cb55-71"><a href="msm_chapter.html#cb55-71" tabindex="-1"></a><span class="co"># CDE(M=1) = E(Y_{A=1,M=1}) - E(Y_{A=0,M=1})</span></span>
<span id="cb55-72"><a href="msm_chapter.html#cb55-72" tabindex="-1"></a>CDE_mis1_gcomp_ice <span class="ot">&lt;-</span> (<span class="fu">coef</span>(MSM.CDE.gcomp)[<span class="st">&quot;A0_PM2.5&quot;</span>] <span class="sc">+</span></span>
<span id="cb55-73"><a href="msm_chapter.html#cb55-73" tabindex="-1"></a>                         <span class="fu">coef</span>(MSM.CDE.gcomp)[<span class="st">&quot;A0_PM2.5:M_diabetes&quot;</span>])</span>
<span id="cb55-74"><a href="msm_chapter.html#cb55-74" tabindex="-1"></a><span class="co"># 0.08812318</span></span></code></pre></div>
<p>The example above (MSM estimation using G-computation by ICE) corresponds to the algorithm applied by the <code>ltmle</code> package:</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="msm_chapter.html#cb56-1" tabindex="-1"></a><span class="fu">library</span>(ltmle)</span>
<span id="cb56-2"><a href="msm_chapter.html#cb56-2" tabindex="-1"></a>Qform <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">L1=</span><span class="st">&quot;Q.kplus1 ~ L0_male + L0_soc_env + A0_PM2.5&quot;</span>,</span>
<span id="cb56-3"><a href="msm_chapter.html#cb56-3" tabindex="-1"></a>           <span class="at">Y_death=</span><span class="st">&quot;Q.kplus1 ~ L0_male + L0_soc_env + L1 +</span></span>
<span id="cb56-4"><a href="msm_chapter.html#cb56-4" tabindex="-1"></a><span class="st">                    A0_PM2.5 * M_diabetes&quot;</span>)</span>
<span id="cb56-5"><a href="msm_chapter.html#cb56-5" tabindex="-1"></a>gform <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;A0_PM2.5 ~ L0_male + L0_soc_env&quot;</span>,</span>
<span id="cb56-6"><a href="msm_chapter.html#cb56-6" tabindex="-1"></a>           <span class="st">&quot;M_diabetes ~ L0_male + L0_soc_env + A0_PM2.5 + L1&quot;</span>)</span>
<span id="cb56-7"><a href="msm_chapter.html#cb56-7" tabindex="-1"></a><span class="co"># in this example of g-computation, the propensity scores &#39;gform&#39; will not be used</span></span>
<span id="cb56-8"><a href="msm_chapter.html#cb56-8" tabindex="-1"></a></span>
<span id="cb56-9"><a href="msm_chapter.html#cb56-9" tabindex="-1"></a>data_binary <span class="ot">&lt;-</span> <span class="fu">subset</span>(df2_int, <span class="at">select =</span> <span class="fu">c</span>(L0_male, L0_soc_env,</span>
<span id="cb56-10"><a href="msm_chapter.html#cb56-10" tabindex="-1"></a>                                          A0_PM2<span class="fl">.5</span>, L1,</span>
<span id="cb56-11"><a href="msm_chapter.html#cb56-11" tabindex="-1"></a>                                          M_diabetes, Y_death))</span>
<span id="cb56-12"><a href="msm_chapter.html#cb56-12" tabindex="-1"></a>CDE_ltmle_M0 <span class="ot">&lt;-</span> <span class="fu">ltmle</span>(<span class="at">data =</span> data_binary,</span>
<span id="cb56-13"><a href="msm_chapter.html#cb56-13" tabindex="-1"></a>                      <span class="at">Anodes =</span> <span class="fu">c</span>(<span class="st">&quot;A0_PM2.5&quot;</span>, <span class="st">&quot;M_diabetes&quot;</span>),</span>
<span id="cb56-14"><a href="msm_chapter.html#cb56-14" tabindex="-1"></a>                      <span class="at">Lnodes =</span> <span class="fu">c</span>(<span class="st">&quot;L1&quot;</span>), <span class="co"># intermediate confounders +/- baseline</span></span>
<span id="cb56-15"><a href="msm_chapter.html#cb56-15" tabindex="-1"></a>                      <span class="at">Ynodes =</span> <span class="fu">c</span>(<span class="st">&quot;Y_death&quot;</span>),</span>
<span id="cb56-16"><a href="msm_chapter.html#cb56-16" tabindex="-1"></a>                      <span class="at">survivalOutcome =</span> <span class="cn">FALSE</span>, <span class="co"># TRUE for time-to-event outcomes Y</span></span>
<span id="cb56-17"><a href="msm_chapter.html#cb56-17" tabindex="-1"></a>                      <span class="at">Qform =</span> Qform,</span>
<span id="cb56-18"><a href="msm_chapter.html#cb56-18" tabindex="-1"></a>                      <span class="at">gform =</span> gform,</span>
<span id="cb56-19"><a href="msm_chapter.html#cb56-19" tabindex="-1"></a>                      <span class="at">abar =</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">0</span>), <span class="co"># counterfactual intervention do(A=1,M=0)</span></span>
<span id="cb56-20"><a href="msm_chapter.html#cb56-20" tabindex="-1"></a>                                  <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>)), <span class="co"># counterfactual intervention do(A=0,M=0)</span></span>
<span id="cb56-21"><a href="msm_chapter.html#cb56-21" tabindex="-1"></a>                      <span class="at">SL.library =</span> <span class="cn">NULL</span>, <span class="co"># calls glm() instead of SuperLearner</span></span>
<span id="cb56-22"><a href="msm_chapter.html#cb56-22" tabindex="-1"></a>                      <span class="at">estimate.time =</span> <span class="cn">FALSE</span>, <span class="co"># estimate computation time?</span></span>
<span id="cb56-23"><a href="msm_chapter.html#cb56-23" tabindex="-1"></a>                      <span class="at">gcomp =</span> <span class="cn">TRUE</span>, <span class="co"># to apply g-computation</span></span>
<span id="cb56-24"><a href="msm_chapter.html#cb56-24" tabindex="-1"></a>                      <span class="at">variance.method =</span> <span class="st">&quot;ic&quot;</span>)</span>
<span id="cb56-25"><a href="msm_chapter.html#cb56-25" tabindex="-1"></a><span class="co"># CDE with M=0</span></span>
<span id="cb56-26"><a href="msm_chapter.html#cb56-26" tabindex="-1"></a><span class="fu">summary</span>(CDE_ltmle_M0)<span class="sc">$</span>effect.measures<span class="sc">$</span>ATE<span class="sc">$</span>estimate</span>
<span id="cb56-27"><a href="msm_chapter.html#cb56-27" tabindex="-1"></a><span class="co">#   Parameter Estimate:  0.06342833</span></span>
<span id="cb56-28"><a href="msm_chapter.html#cb56-28" tabindex="-1"></a></span>
<span id="cb56-29"><a href="msm_chapter.html#cb56-29" tabindex="-1"></a>CDE_ltmle_M1 <span class="ot">&lt;-</span> <span class="fu">ltmle</span>(<span class="at">data =</span> data_binary,</span>
<span id="cb56-30"><a href="msm_chapter.html#cb56-30" tabindex="-1"></a>                      <span class="at">Anodes =</span> <span class="fu">c</span>(<span class="st">&quot;A0_PM2.5&quot;</span>, <span class="st">&quot;M_diabetes&quot;</span>),</span>
<span id="cb56-31"><a href="msm_chapter.html#cb56-31" tabindex="-1"></a>                      <span class="at">Lnodes =</span> <span class="fu">c</span>(<span class="st">&quot;L1&quot;</span>), <span class="co"># intermediate confounders +/- baseline</span></span>
<span id="cb56-32"><a href="msm_chapter.html#cb56-32" tabindex="-1"></a>                      <span class="at">Ynodes =</span> <span class="fu">c</span>(<span class="st">&quot;Y_death&quot;</span>),</span>
<span id="cb56-33"><a href="msm_chapter.html#cb56-33" tabindex="-1"></a>                      <span class="at">survivalOutcome =</span> <span class="cn">FALSE</span>, <span class="co"># TRUE for time-to-event outcomes Y</span></span>
<span id="cb56-34"><a href="msm_chapter.html#cb56-34" tabindex="-1"></a>                      <span class="at">Qform =</span> Qform,</span>
<span id="cb56-35"><a href="msm_chapter.html#cb56-35" tabindex="-1"></a>                      <span class="at">gform =</span> gform,</span>
<span id="cb56-36"><a href="msm_chapter.html#cb56-36" tabindex="-1"></a>                      <span class="at">abar =</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>), <span class="co"># counterfactual intervention do(A=1,M=0)</span></span>
<span id="cb56-37"><a href="msm_chapter.html#cb56-37" tabindex="-1"></a>                                  <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)), <span class="co"># counterfactual intervention do(A=0,M=0)</span></span>
<span id="cb56-38"><a href="msm_chapter.html#cb56-38" tabindex="-1"></a>                      <span class="at">SL.library =</span> <span class="cn">NULL</span>, <span class="co"># calls glm() instead of SuperLearner</span></span>
<span id="cb56-39"><a href="msm_chapter.html#cb56-39" tabindex="-1"></a>                      <span class="at">estimate.time =</span> <span class="cn">FALSE</span>, <span class="co"># estimate computation time?</span></span>
<span id="cb56-40"><a href="msm_chapter.html#cb56-40" tabindex="-1"></a>                      <span class="at">gcomp =</span> <span class="cn">TRUE</span>, <span class="co"># to apply g-computation</span></span>
<span id="cb56-41"><a href="msm_chapter.html#cb56-41" tabindex="-1"></a>                      <span class="at">variance.method =</span> <span class="st">&quot;ic&quot;</span>)</span>
<span id="cb56-42"><a href="msm_chapter.html#cb56-42" tabindex="-1"></a><span class="co"># CDE with M=1</span></span>
<span id="cb56-43"><a href="msm_chapter.html#cb56-43" tabindex="-1"></a><span class="fu">summary</span>(CDE_ltmle_M1)<span class="sc">$</span>effect.measures<span class="sc">$</span>ATE<span class="sc">$</span>estimate</span>
<span id="cb56-44"><a href="msm_chapter.html#cb56-44" tabindex="-1"></a><span class="co">#   Parameter Estimate:  0.08812318</span></span></code></pre></div>
</div>
</div>
<div id="msm_NDE_NIE_paragraph" class="section level2 hasAnchor" number="8.3">
<h2><span class="header-section-number">8.3</span> MSM for Natural Direct and Indirect Effects<a href="msm_chapter.html#msm_NDE_NIE_paragraph" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="expressing-the-nde-and-nie-using-coefficients-of-2-msms" class="section level3 hasAnchor" number="8.3.1">
<h3><span class="header-section-number">8.3.1</span> Expressing the NDE and NIE using coefficients of 2 MSMs<a href="msm_chapter.html#expressing-the-nde-and-nie-using-coefficients-of-2-msms" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The (Pure) Natural Direct Effect is defined by <span class="math inline">\(\text{PNDE} = \mathbb{E}(Y_{a,M_{a^*}}) - \mathbb{E}(Y_{a^*,M_{a^*}})\)</span> and the (Total) Natural Indirect Effect is defined by <span class="math inline">\(\text{TNIE} = \mathbb{E}(Y_{a,M_a}) - \mathbb{E}(Y_{a,M_{a^*}})\)</span>.</p>
<p>VanderWeele suggested using 2 MSMs conditional on baseline confounders <span class="math inline">\(L(0)\)</span> in order to estimate natural direct and indirect effects <span class="citation">(<a href="#ref-vanderweele2009">VanderWeele 2009</a>)</span>:</p>
<ol style="list-style-type: decimal">
<li><p>a model of the counterfactual values of the outcome <span class="math inline">\(\mathbb{E}(Y_{a,m} \mid l(0))=h^{-1}(a,m,l(0))\)</span>, where <span class="math inline">\(h\)</span> is a link function. For example:
<span class="math display" id="eq:MSM-Indirect-model1">\[\begin{equation}
    \mathbb{E}(Y_{a,m} \mid l(0)) = \alpha_0 + \alpha_A a + \alpha_M m + \alpha_{AM} a \times m + \alpha_{L(0)} l(0) \tag{8.5}
  \end{equation}\]</span>
(where <span class="math inline">\(h\)</span> is the identity function, so that the model can be used to express risk differences)</p></li>
<li><p>a model of the counterfactual values of the mediator <span class="math inline">\(\mathbb{E}(M_{a} \mid L(0))=g^{-1}(a,l(0))\)</span>, where <span class="math inline">\(g\)</span> is a link function. For example with a binary mediator:
<span class="math display" id="eq:MSM-Indirect-model2">\[\begin{equation}
    \mathbb{E}(M_a \mid l(0)) = g^{-1}\left[\beta_0 + \beta_A a + \beta_{L(0)} l(0) \right]
    \tag{8.6}
  \end{equation}\]</span>
(where <span class="math inline">\(g\)</span> is the logit function because the mediator is binary).</p></li>
</ol>
<p>VanderWeele shows that if the function <span class="math inline">\(h\)</span> is linear in <span class="math inline">\(m\)</span> (no quadratic terms in <span class="math inline">\(m\)</span>, nor transformations such as <span class="math inline">\(\log(m)\)</span> or <span class="math inline">\(\sqrt{m}\)</span>, etc) and the exposure <span class="math inline">\(A\)</span> does not affect the intermediate confounder <span class="math inline">\(L(1)\)</span>, then
<span class="math display">\[\begin{equation*}
  \mathbb{E}(Y_{a,M_{a^*}}) = h^{-1}\left[a,g^{-1}\left(a^*,l(0)\right),l(0)\right]
\end{equation*}\]</span></p>
<p>Using the 2 MSMs, we can express the Natural Direct and Indirect Effects conditional on baseline confounders <span class="math inline">\(L(0)\)</span>. In our example:
<span class="math display">\[\begin{align*}
  \text{PNDE} \mid L(0) &amp;= \mathbb{E}(Y_{a,M_{a^*}} \mid L(0)) - \mathbb{E}(Y_{a^*,M_{a^*}} \mid L(0)) \\
  &amp;= \{\alpha_0 + \alpha_A a + [\alpha_M + \alpha_{AM}a] \times g^{-1}(a^*,l(0)) + \alpha_{L(0)} l(0) \} \\
  &amp; \quad \quad - \{ \alpha_0 + \alpha_A a^*+ [\alpha_M + \alpha_{AM}a^*] \times g^{-1}(a^*,l(0)) + \alpha_{L(0)} l(0) \} \\
  &amp;= (a - a^*) \times [\alpha_A + \alpha_{AM} \times g^{-1}(a^*,l(0))]
\end{align*}\]</span></p>
<p><span class="math display">\[\begin{align*}
  \text{TNIE} \mid L(0) &amp;= \mathbb{E}(Y_{a,M_{a}} \mid L(0)) - \mathbb{E}(Y_{a,M_{a^*}} \mid L(0)) \\
  &amp;= \{\alpha_0 + \alpha_A a + [\alpha_M + \alpha_{AM}a] \times g^{-1}(a,l(0)) + \alpha_{L(0)} l(0) \} \\
  &amp; \quad \quad - \{ \alpha_0 + \alpha_A a+ [\alpha_M + \alpha_{AM}a] \times g^{-1}(a^*,l(0)) + \alpha_{L(0)} l(0) \} \\
  &amp;= \left[ g^{-1}(a,l(0)) - g^{-1}(a^*,l(0)) \right](\alpha_M + \alpha_{AM} a)
\end{align*}\]</span></p>
<p>Marginal Natural Direct and Indirect effect can then be obtained:
<span class="math display">\[\begin{align*}
  \text{PNDE} &amp;= \sum_{l(0)} \left[ \text{PNDE} \mid L(0) = l(0) \right] \times P(L(0)=l(0)) \\
  \quad \text{TNIE} &amp;= \sum_{l(0)} \left[ \text{TNIE} \mid L(0) = l(0) \right] \times P(L(0)=l(0))
\end{align*}\]</span></p>
</div>
<div id="estimation-of-the-2-msms-coefficients-by-iptw-for-nde-and-nie" class="section level3 hasAnchor" number="8.3.2">
<h3><span class="header-section-number">8.3.2</span> Estimation of the 2 MSMs coefficients by IPTW for NDE and NIE<a href="msm_chapter.html#estimation-of-the-2-msms-coefficients-by-iptw-for-nde-and-nie" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>As previously, MSM coefficients can be estimated using an Inverse Probability of Treatment (IPTW) approach based on weighted regressions.</p>
<p>In order to fit the 1st MSM <a href="msm_chapter.html#eq:MSM-Indirect-model1">(8.5)</a>, we can use a linear regression of the (observed) outcome <span class="math inline">\(Y\)</span> on the exposure and mediator, adjusted for <span class="math inline">\(L(0)\)</span>, weighted by individual stabilized weights <span class="math inline">\(sw_{msm1,i}\)</span> <span class="citation">(<a href="#ref-vanderweele2009">VanderWeele 2009</a>)</span>:
<span class="math display">\[\begin{equation*}
  \mathbb{E}\left(Y \mid A,M,L(0)\right) = \alpha_0 + \alpha_A a + \alpha_M m + \alpha_{AM} a \times m + \alpha_{L(0)} L(0)
\end{equation*}\]</span></p>
<p>where <span class="math inline">\(sw_{msm1,i}\)</span> is the product of two weights <span class="math inline">\(sw_{msm1,i} = sw_{A,i} \times sw_{M,i}\)</span>,
<span class="math display">\[\begin{align*}
  sw_{A,i} =&amp; \frac{P(A=a_i)}{P(A=a_i \mid L(0)=l(0)_i)} \quad \text{or} \quad sw_{A,i} = \frac{P(A=a_i \mid L(0)=l(0)_i)}{P(A=a_i \mid L(0)=l(0)_i)} = 1 \\
  sw_{M,i} =&amp; \frac{P(M=m_i \mid A=a_i)}{P(M = m_i \mid A=a_i,L(0)=l(0)_i), L(1)=l(1)_i} \\
  &amp; \quad \text{or} \quad sw_{M,i} = \frac{P(M=m_i \mid A=a_i,L(0)=l(0)_i)}{P(M = m_i \mid A=a_i,L(0)=l(0)_i), L(1)=l(1)_i} \\
\end{align*}\]</span></p>
<p>In order to fit the 2nd MSM <a href="msm_chapter.html#eq:MSM-Indirect-model2">(8.6)</a>, we can use a logistic regression of the (observed) mediator <span class="math inline">\(M\)</span> on the exposure, adjusted for <span class="math inline">\(L(0)\)</span>, weighted by individual stabilized weights <span class="math inline">\(sw_{msm2,i}\)</span>:
<span class="math display">\[\begin{equation*}
\text{logit} \mathbb{E}(M \mid a,l(0)) = \beta_0 + \beta_A a + \beta_{L(0)} l(0)
\end{equation*}\]</span></p>
<p><span class="math display">\[\begin{equation*}
\text{where} \quad sw_{msm2,i} = \frac{P(A=a_i)}{P(A=a_i \mid L(0)=l(0)_i)}
\end{equation*}\]</span></p>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="msm_chapter.html#cb57-1" tabindex="-1"></a><span class="do">### MSM of NDE &amp; NIE, estimated by IPTW ----------------------------------------</span></span>
<span id="cb57-2"><a href="msm_chapter.html#cb57-2" tabindex="-1"></a><span class="do">## 1. Stabilized weight for the MSM1</span></span>
<span id="cb57-3"><a href="msm_chapter.html#cb57-3" tabindex="-1"></a><span class="co"># 1a. sw_Ai = g(A=a_i | L(0)) / g(A=a_i | L(0)) = 1</span></span>
<span id="cb57-4"><a href="msm_chapter.html#cb57-4" tabindex="-1"></a>sw_Ai <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">nrow</span>(df1_int))</span>
<span id="cb57-5"><a href="msm_chapter.html#cb57-5" tabindex="-1"></a></span>
<span id="cb57-6"><a href="msm_chapter.html#cb57-6" tabindex="-1"></a><span class="co"># 1b. sw_Mi = g(M=m_i | A,L(0)) / g(M=m_i | A,L(0),L(1))</span></span>
<span id="cb57-7"><a href="msm_chapter.html#cb57-7" tabindex="-1"></a>g.M.AL0 <span class="ot">&lt;-</span> <span class="fu">glm</span>(M_diabetes <span class="sc">~</span> A0_PM2<span class="fl">.5</span> <span class="sc">+</span> L0_male <span class="sc">+</span> L0_soc_env,</span>
<span id="cb57-8"><a href="msm_chapter.html#cb57-8" tabindex="-1"></a>               <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>, <span class="at">data =</span> df1_int)</span>
<span id="cb57-9"><a href="msm_chapter.html#cb57-9" tabindex="-1"></a>g.Mis1.AL0 <span class="ot">&lt;-</span> <span class="fu">predict</span>(g.M.AL0, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb57-10"><a href="msm_chapter.html#cb57-10" tabindex="-1"></a>sw_M.num <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">nrow</span>(df1_int))</span>
<span id="cb57-11"><a href="msm_chapter.html#cb57-11" tabindex="-1"></a>sw_M.num[df1_int<span class="sc">$</span>M_diabetes<span class="sc">==</span><span class="dv">1</span>] <span class="ot">&lt;-</span> g.Mis1.AL0[df1_int<span class="sc">$</span>M_diabetes<span class="sc">==</span><span class="dv">1</span>]</span>
<span id="cb57-12"><a href="msm_chapter.html#cb57-12" tabindex="-1"></a>sw_M.num[df1_int<span class="sc">$</span>M_diabetes<span class="sc">==</span><span class="dv">0</span>] <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> g.Mis1.AL0[df1_int<span class="sc">$</span>M_diabetes<span class="sc">==</span><span class="dv">0</span>])</span>
<span id="cb57-13"><a href="msm_chapter.html#cb57-13" tabindex="-1"></a></span>
<span id="cb57-14"><a href="msm_chapter.html#cb57-14" tabindex="-1"></a>g.M.AL0L1 <span class="ot">&lt;-</span> <span class="fu">glm</span>(M_diabetes <span class="sc">~</span> A0_PM2<span class="fl">.5</span> <span class="sc">+</span> L0_male <span class="sc">+</span> L0_soc_env <span class="sc">+</span> L1,</span>
<span id="cb57-15"><a href="msm_chapter.html#cb57-15" tabindex="-1"></a>                 <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>, <span class="at">data =</span> df1_int)</span>
<span id="cb57-16"><a href="msm_chapter.html#cb57-16" tabindex="-1"></a>g.Mis1.AL0L1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(g.M.AL0L1, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb57-17"><a href="msm_chapter.html#cb57-17" tabindex="-1"></a>sw_M.denom <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">nrow</span>(df1_int))</span>
<span id="cb57-18"><a href="msm_chapter.html#cb57-18" tabindex="-1"></a>sw_M.denom[df1_int<span class="sc">$</span>M_diabetes<span class="sc">==</span><span class="dv">1</span>] <span class="ot">&lt;-</span> g.Mis1.AL0L1[df1_int<span class="sc">$</span>M_diabetes<span class="sc">==</span><span class="dv">1</span>]</span>
<span id="cb57-19"><a href="msm_chapter.html#cb57-19" tabindex="-1"></a>sw_M.denom[df1_int<span class="sc">$</span>M_diabetes<span class="sc">==</span><span class="dv">0</span>] <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> g.Mis1.AL0L1[df1_int<span class="sc">$</span>M_diabetes<span class="sc">==</span><span class="dv">0</span>])</span>
<span id="cb57-20"><a href="msm_chapter.html#cb57-20" tabindex="-1"></a></span>
<span id="cb57-21"><a href="msm_chapter.html#cb57-21" tabindex="-1"></a>sw_msm1 <span class="ot">&lt;-</span> sw_Ai <span class="sc">*</span> sw_M.num <span class="sc">/</span> sw_M.denom</span>
<span id="cb57-22"><a href="msm_chapter.html#cb57-22" tabindex="-1"></a></span>
<span id="cb57-23"><a href="msm_chapter.html#cb57-23" tabindex="-1"></a><span class="do">## 2. Estimate coefficients of the MSM1</span></span>
<span id="cb57-24"><a href="msm_chapter.html#cb57-24" tabindex="-1"></a>MSM1 <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y_death <span class="sc">~</span> A0_PM2<span class="fl">.5</span> <span class="sc">+</span> M_diabetes <span class="sc">+</span> A0_PM2<span class="fl">.5</span><span class="sc">:</span>M_diabetes <span class="sc">+</span></span>
<span id="cb57-25"><a href="msm_chapter.html#cb57-25" tabindex="-1"></a>              L0_male <span class="sc">+</span> L0_soc_env,</span>
<span id="cb57-26"><a href="msm_chapter.html#cb57-26" tabindex="-1"></a>            <span class="at">weights =</span> sw_msm1,</span>
<span id="cb57-27"><a href="msm_chapter.html#cb57-27" tabindex="-1"></a>            <span class="at">family =</span> <span class="st">&quot;gaussian&quot;</span>,</span>
<span id="cb57-28"><a href="msm_chapter.html#cb57-28" tabindex="-1"></a>            <span class="at">data =</span> df1_int)</span>
<span id="cb57-29"><a href="msm_chapter.html#cb57-29" tabindex="-1"></a><span class="fu">coef</span>(MSM1)</span>
<span id="cb57-30"><a href="msm_chapter.html#cb57-30" tabindex="-1"></a><span class="co"># (Intercept)     A0_PM2.5  M_diabetes    L0_male L0_soc_env  A0_PM2.5:M_diabetes</span></span>
<span id="cb57-31"><a href="msm_chapter.html#cb57-31" tabindex="-1"></a><span class="co">#  0.12033221   0.06381257  0.06691712 0.04671886 0.05521263           0.01652446</span></span>
<span id="cb57-32"><a href="msm_chapter.html#cb57-32" tabindex="-1"></a></span>
<span id="cb57-33"><a href="msm_chapter.html#cb57-33" tabindex="-1"></a><span class="do">## 3. Stabilized weight for the MSM2</span></span>
<span id="cb57-34"><a href="msm_chapter.html#cb57-34" tabindex="-1"></a><span class="co"># 3a. sw_A = g(A=a_i) / g(A=a_i | L(0))</span></span>
<span id="cb57-35"><a href="msm_chapter.html#cb57-35" tabindex="-1"></a><span class="co"># numerator</span></span>
<span id="cb57-36"><a href="msm_chapter.html#cb57-36" tabindex="-1"></a>g.A <span class="ot">&lt;-</span> <span class="fu">glm</span>(A0_PM2<span class="fl">.5</span> <span class="sc">~</span> <span class="dv">1</span>, <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>, <span class="at">data =</span> df1_int)</span>
<span id="cb57-37"><a href="msm_chapter.html#cb57-37" tabindex="-1"></a>g.Ais1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(g.A, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb57-38"><a href="msm_chapter.html#cb57-38" tabindex="-1"></a>sw_msm2.num <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">nrow</span>(df1_int))</span>
<span id="cb57-39"><a href="msm_chapter.html#cb57-39" tabindex="-1"></a>sw_msm2.num[df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">1</span>] <span class="ot">&lt;-</span> g.Ais1[df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">1</span>]</span>
<span id="cb57-40"><a href="msm_chapter.html#cb57-40" tabindex="-1"></a>sw_msm2.num[df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">0</span>] <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> g.Ais1[df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">0</span>])</span>
<span id="cb57-41"><a href="msm_chapter.html#cb57-41" tabindex="-1"></a></span>
<span id="cb57-42"><a href="msm_chapter.html#cb57-42" tabindex="-1"></a><span class="co"># denominator</span></span>
<span id="cb57-43"><a href="msm_chapter.html#cb57-43" tabindex="-1"></a>g.A.L0 <span class="ot">&lt;-</span> <span class="fu">glm</span>(A0_PM2<span class="fl">.5</span> <span class="sc">~</span> L0_male <span class="sc">+</span> L0_soc_env,</span>
<span id="cb57-44"><a href="msm_chapter.html#cb57-44" tabindex="-1"></a>              <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>, <span class="at">data =</span> df1_int)</span>
<span id="cb57-45"><a href="msm_chapter.html#cb57-45" tabindex="-1"></a>g.Ais1.L0 <span class="ot">&lt;-</span> <span class="fu">predict</span>(g.A.L0, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb57-46"><a href="msm_chapter.html#cb57-46" tabindex="-1"></a>sw_msm2.denom <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">nrow</span>(df1_int))</span>
<span id="cb57-47"><a href="msm_chapter.html#cb57-47" tabindex="-1"></a>sw_msm2.denom[df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">1</span>] <span class="ot">&lt;-</span> g.Ais1.L0[df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">1</span>]</span>
<span id="cb57-48"><a href="msm_chapter.html#cb57-48" tabindex="-1"></a>sw_msm2.denom[df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">0</span>] <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> g.Ais1.L0[df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">0</span>])</span>
<span id="cb57-49"><a href="msm_chapter.html#cb57-49" tabindex="-1"></a></span>
<span id="cb57-50"><a href="msm_chapter.html#cb57-50" tabindex="-1"></a><span class="co"># stabilized weight</span></span>
<span id="cb57-51"><a href="msm_chapter.html#cb57-51" tabindex="-1"></a>sw_msm2 <span class="ot">&lt;-</span> sw_msm2.num <span class="sc">/</span> sw_msm2.denom</span>
<span id="cb57-52"><a href="msm_chapter.html#cb57-52" tabindex="-1"></a></span>
<span id="cb57-53"><a href="msm_chapter.html#cb57-53" tabindex="-1"></a><span class="do">## 3. Estimate coefficients of the MSM2</span></span>
<span id="cb57-54"><a href="msm_chapter.html#cb57-54" tabindex="-1"></a>MSM2 <span class="ot">&lt;-</span> <span class="fu">glm</span>(M_diabetes <span class="sc">~</span> A0_PM2<span class="fl">.5</span> <span class="sc">+</span> L0_male <span class="sc">+</span> L0_soc_env,</span>
<span id="cb57-55"><a href="msm_chapter.html#cb57-55" tabindex="-1"></a>            <span class="at">weights =</span> sw_msm2,</span>
<span id="cb57-56"><a href="msm_chapter.html#cb57-56" tabindex="-1"></a>            <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>,</span>
<span id="cb57-57"><a href="msm_chapter.html#cb57-57" tabindex="-1"></a>            <span class="at">data =</span> df1_int)</span>
<span id="cb57-58"><a href="msm_chapter.html#cb57-58" tabindex="-1"></a><span class="fu">coef</span>(MSM2)</span>
<span id="cb57-59"><a href="msm_chapter.html#cb57-59" tabindex="-1"></a><span class="co"># (Intercept)    A0_PM2.5     L0_male   L0_soc_env</span></span>
<span id="cb57-60"><a href="msm_chapter.html#cb57-60" tabindex="-1"></a><span class="co">#  -1.2723106   0.5883720   0.2566129    0.3270087</span></span>
<span id="cb57-61"><a href="msm_chapter.html#cb57-61" tabindex="-1"></a></span>
<span id="cb57-62"><a href="msm_chapter.html#cb57-62" tabindex="-1"></a><span class="do">## 4. Estimate PNDE conditional on L(0), and the marginal value of PNDE</span></span>
<span id="cb57-63"><a href="msm_chapter.html#cb57-63" tabindex="-1"></a><span class="co"># a = 1 and a* = 0</span></span>
<span id="cb57-64"><a href="msm_chapter.html#cb57-64" tabindex="-1"></a><span class="co"># PNDE|L(0) = (a - a*)[alpha_A + alpha_AM.g^-1(a^*,l(0))]</span></span>
<span id="cb57-65"><a href="msm_chapter.html#cb57-65" tabindex="-1"></a>g.minus1.A0 <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="fu">coef</span>(MSM2)[<span class="st">&quot;(Intercept)&quot;</span>] <span class="sc">+</span> <span class="fu">coef</span>(MSM2)[<span class="st">&quot;A0_PM2.5&quot;</span>] <span class="sc">*</span> <span class="dv">0</span> <span class="sc">+</span></span>
<span id="cb57-66"><a href="msm_chapter.html#cb57-66" tabindex="-1"></a>                      <span class="fu">coef</span>(MSM2)[<span class="st">&quot;L0_male&quot;</span>] <span class="sc">*</span> df1_int<span class="sc">$</span>L0_male <span class="sc">+</span></span>
<span id="cb57-67"><a href="msm_chapter.html#cb57-67" tabindex="-1"></a>                      <span class="fu">coef</span>(MSM2)[<span class="st">&quot;L0_soc_env&quot;</span>] <span class="sc">*</span> df1_int<span class="sc">$</span>L0_soc_env)</span>
<span id="cb57-68"><a href="msm_chapter.html#cb57-68" tabindex="-1"></a></span>
<span id="cb57-69"><a href="msm_chapter.html#cb57-69" tabindex="-1"></a><span class="co"># PNDE conditional on L(0)</span></span>
<span id="cb57-70"><a href="msm_chapter.html#cb57-70" tabindex="-1"></a>PNDE_L0 <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="dv">0</span>) <span class="sc">*</span> (<span class="fu">coef</span>(MSM1)[<span class="st">&quot;A0_PM2.5&quot;</span>] <span class="sc">+</span></span>
<span id="cb57-71"><a href="msm_chapter.html#cb57-71" tabindex="-1"></a>                        <span class="fu">coef</span>(MSM1)[<span class="st">&quot;A0_PM2.5:M_diabetes&quot;</span>] <span class="sc">*</span> g.minus1.A0)</span>
<span id="cb57-72"><a href="msm_chapter.html#cb57-72" tabindex="-1"></a><span class="co"># marginal PNDE</span></span>
<span id="cb57-73"><a href="msm_chapter.html#cb57-73" tabindex="-1"></a>PNDE <span class="ot">&lt;-</span> <span class="fu">mean</span>(PNDE_L0)</span>
<span id="cb57-74"><a href="msm_chapter.html#cb57-74" tabindex="-1"></a><span class="co"># [1] 0.06850657</span></span>
<span id="cb57-75"><a href="msm_chapter.html#cb57-75" tabindex="-1"></a></span>
<span id="cb57-76"><a href="msm_chapter.html#cb57-76" tabindex="-1"></a><span class="do">## 4. Estimate TNIE conditional on L(0), and the marginal value of TNIE</span></span>
<span id="cb57-77"><a href="msm_chapter.html#cb57-77" tabindex="-1"></a><span class="co"># TNIE|L(0) = [g^-1(a,l(0)) - g^-1(a^*,l(0))] * (alpha_M + alpha_AM * a)</span></span>
<span id="cb57-78"><a href="msm_chapter.html#cb57-78" tabindex="-1"></a>g.minus1.A1 <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="fu">coef</span>(MSM2)[<span class="st">&quot;(Intercept)&quot;</span>] <span class="sc">+</span> <span class="fu">coef</span>(MSM2)[<span class="st">&quot;A0_PM2.5&quot;</span>] <span class="sc">*</span> <span class="dv">1</span> <span class="sc">+</span></span>
<span id="cb57-79"><a href="msm_chapter.html#cb57-79" tabindex="-1"></a>                        <span class="fu">coef</span>(MSM2)[<span class="st">&quot;L0_male&quot;</span>] <span class="sc">*</span> df1_int<span class="sc">$</span>L0_male <span class="sc">+</span></span>
<span id="cb57-80"><a href="msm_chapter.html#cb57-80" tabindex="-1"></a>                        <span class="fu">coef</span>(MSM2)[<span class="st">&quot;L0_soc_env&quot;</span>] <span class="sc">*</span> df1_int<span class="sc">$</span>L0_soc_env)</span>
<span id="cb57-81"><a href="msm_chapter.html#cb57-81" tabindex="-1"></a></span>
<span id="cb57-82"><a href="msm_chapter.html#cb57-82" tabindex="-1"></a><span class="co"># TNIE conditional on L(0)</span></span>
<span id="cb57-83"><a href="msm_chapter.html#cb57-83" tabindex="-1"></a>TNIE_L0 <span class="ot">&lt;-</span> (g.minus1.A1 <span class="sc">-</span> g.minus1.A0) <span class="sc">*</span> (<span class="fu">coef</span>(MSM1)[<span class="st">&quot;M_diabetes&quot;</span>] <span class="sc">+</span></span>
<span id="cb57-84"><a href="msm_chapter.html#cb57-84" tabindex="-1"></a>                                            <span class="fu">coef</span>(MSM1)[<span class="st">&quot;A0_PM2.5:M_diabetes&quot;</span>] <span class="sc">*</span> <span class="dv">1</span>)</span>
<span id="cb57-85"><a href="msm_chapter.html#cb57-85" tabindex="-1"></a><span class="co"># marginal PNDE</span></span>
<span id="cb57-86"><a href="msm_chapter.html#cb57-86" tabindex="-1"></a>TNIE <span class="ot">&lt;-</span> <span class="fu">mean</span>(TNIE_L0)</span>
<span id="cb57-87"><a href="msm_chapter.html#cb57-87" tabindex="-1"></a><span class="co"># [1] 0.01096799</span></span></code></pre></div>
<p>In this example, the estimation of the PNDE is 6.9% and the estimation of the TNIE is 1.1%. Confidence intervals can be calculated by bootstrap.</p>
</div>
</div>
<div id="msm_CMAverse" class="section level2 hasAnchor" number="8.4">
<h2><span class="header-section-number">8.4</span> MSM estimated by the <code>CMAverse</code> package<a href="msm_chapter.html#msm_CMAverse" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="calculation-by-hand-using-the-mediation-formula" class="section level3 hasAnchor" number="8.4.1">
<h3><span class="header-section-number">8.4.1</span> Calculation by hand, using the “mediation formula”<a href="msm_chapter.html#calculation-by-hand-using-the-mediation-formula" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The counterfactual quantity <span class="math inline">\(\mathbb{E}(Y_{a,M_{a^\prime}})\)</span> used to defined the Natural Direct and Indirect effects can be expressed by the <em>mediation formula</em> (conditional on <span class="math inline">\(\{L(0),L(1)\}\)</span>, or the population average):
<span class="math display">\[\begin{align*}
  \mathbb{E}\left( Y_{a,M_{a^\prime}} \mid L(0),L(1) \right) &amp;= \sum_m \mathbb{E}\left( Y_{a,m} \mid L(0),L(1) \right) \times \mathbb{P}\left(M_{a^\prime} = m \mid L(0),L(1)\right) \\
  \text{ or } &amp; \\
  \mathbb{E}\left( Y_{a,M_{a^\prime}} \right) &amp;= \sum_m \mathbb{E}\left( Y_{a,m} \right) \times \mathbb{P}(M_{a^\prime} = m) \\
\end{align*}\]</span></p>
<p>In order to estimate the <span class="math inline">\(\text{PNDE} = \mathbb{E}(Y_{1,M_0}) - \mathbb{E}(Y_{0,M_0})\)</span> and the <span class="math inline">\(\text{TNIE} = \mathbb{E}(Y_{1,M_1}) - \mathbb{E}(Y_{1,M_0})\)</span> we can estimate 2 Marginal Structural Models:</p>
<ul>
<li>a model of the counterfactual mediator (where <span class="math inline">\(g\)</span> is a link function), for example:
<span class="math display">\[\begin{equation*}
  g \left[ \mathbb{P}(M_{a^\prime} = 1)\right] = \beta_0 + \beta_A a^\prime
\end{equation*}\]</span></li>
<li>a model of the counterfactual outcome (where <span class="math inline">\(h\)</span> is a link function), for example:
<span class="math display">\[\begin{equation*}
  h \left[ \mathbb{E}(Y_{a,m})\right] = \alpha_0 + \alpha_A a + \alpha_M m + \alpha_{A \ast M} a \times m)
\end{equation*}\]</span></li>
</ul>
<p>Below, we will estimate the coefficients of the 2 MSMs by Inverse Probability of Treatment Weighting (IPTW).</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="msm_chapter.html#cb58-1" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list=</span><span class="fu">ls</span>())</span>
<span id="cb58-2"><a href="msm_chapter.html#cb58-2" tabindex="-1"></a>df1_int <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="st">&quot;data/df1_int.csv&quot;</span>)</span>
<span id="cb58-3"><a href="msm_chapter.html#cb58-3" tabindex="-1"></a></span>
<span id="cb58-4"><a href="msm_chapter.html#cb58-4" tabindex="-1"></a><span class="do">## 1. Stabilized weight for the exposure sw_{A,i}</span></span>
<span id="cb58-5"><a href="msm_chapter.html#cb58-5" tabindex="-1"></a><span class="co"># 1a. Estimate g(A=a_i|L(0)) (denominator of the weight)</span></span>
<span id="cb58-6"><a href="msm_chapter.html#cb58-6" tabindex="-1"></a>g.A.L <span class="ot">&lt;-</span> <span class="fu">glm</span>(A0_PM2<span class="fl">.5</span> <span class="sc">~</span> L0_male <span class="sc">+</span> L0_soc_env <span class="sc">+</span> L1,</span>
<span id="cb58-7"><a href="msm_chapter.html#cb58-7" tabindex="-1"></a>             <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>, <span class="at">data =</span> df1_int)</span>
<span id="cb58-8"><a href="msm_chapter.html#cb58-8" tabindex="-1"></a><span class="fu">summary</span>(g.A.L)</span>
<span id="cb58-9"><a href="msm_chapter.html#cb58-9" tabindex="-1"></a><span class="co"># Coefficients:</span></span>
<span id="cb58-10"><a href="msm_chapter.html#cb58-10" tabindex="-1"></a><span class="co">#               Estimate Std. Error z value Pr(&gt;|z|)</span></span>
<span id="cb58-11"><a href="msm_chapter.html#cb58-11" tabindex="-1"></a><span class="co">#   (Intercept) -2.74236    0.07729 -35.484  &lt; 2e-16 ***</span></span>
<span id="cb58-12"><a href="msm_chapter.html#cb58-12" tabindex="-1"></a><span class="co">#   L0_male      0.40610    0.06448   6.298 3.01e-10 ***</span></span>
<span id="cb58-13"><a href="msm_chapter.html#cb58-13" tabindex="-1"></a><span class="co">#   L0_soc_env   0.64079    0.07350   8.718  &lt; 2e-16 ***</span></span>
<span id="cb58-14"><a href="msm_chapter.html#cb58-14" tabindex="-1"></a><span class="co">#   L1           0.03257    0.06968   0.467     0.64</span></span>
<span id="cb58-15"><a href="msm_chapter.html#cb58-15" tabindex="-1"></a></span>
<span id="cb58-16"><a href="msm_chapter.html#cb58-16" tabindex="-1"></a><span class="co"># 1b. Predict each individual&#39;s probability of being exposed to her own exposure</span></span>
<span id="cb58-17"><a href="msm_chapter.html#cb58-17" tabindex="-1"></a><span class="co"># the predicted probability of the observed treatment g(A = a_i | L(0)) is :</span></span>
<span id="cb58-18"><a href="msm_chapter.html#cb58-18" tabindex="-1"></a>gAi.L <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">nrow</span>(df1_int))</span>
<span id="cb58-19"><a href="msm_chapter.html#cb58-19" tabindex="-1"></a>gAi.L[df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">predict</span>(g.A.L, <span class="at">type=</span><span class="st">&quot;response&quot;</span>)[df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">1</span>]</span>
<span id="cb58-20"><a href="msm_chapter.html#cb58-20" tabindex="-1"></a>gAi.L[df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">0</span>] <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="fu">predict</span>(g.A.L, <span class="at">type=</span><span class="st">&quot;response&quot;</span>))[df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">0</span>]</span>
<span id="cb58-21"><a href="msm_chapter.html#cb58-21" tabindex="-1"></a></span>
<span id="cb58-22"><a href="msm_chapter.html#cb58-22" tabindex="-1"></a><span class="co"># 1c. Estimate g(A=a_i) (numerator of the weight)</span></span>
<span id="cb58-23"><a href="msm_chapter.html#cb58-23" tabindex="-1"></a>g.A <span class="ot">&lt;-</span> <span class="fu">glm</span>(A0_PM2<span class="fl">.5</span> <span class="sc">~</span> <span class="dv">1</span>, <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>, <span class="at">data =</span> df1_int)</span>
<span id="cb58-24"><a href="msm_chapter.html#cb58-24" tabindex="-1"></a><span class="co"># 1d. Predict each individual&#39;s probability of being exposed to her own exposure</span></span>
<span id="cb58-25"><a href="msm_chapter.html#cb58-25" tabindex="-1"></a><span class="co"># the predicted probability of the observed treatment g(A = a_i) is :</span></span>
<span id="cb58-26"><a href="msm_chapter.html#cb58-26" tabindex="-1"></a>gAi <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">nrow</span>(df1_int))</span>
<span id="cb58-27"><a href="msm_chapter.html#cb58-27" tabindex="-1"></a>gAi[df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">predict</span>(g.A, <span class="at">type=</span><span class="st">&quot;response&quot;</span>)[df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">1</span>]</span>
<span id="cb58-28"><a href="msm_chapter.html#cb58-28" tabindex="-1"></a>gAi[df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">0</span>] <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="fu">predict</span>(g.A, <span class="at">type=</span><span class="st">&quot;response&quot;</span>))[df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">0</span>]</span>
<span id="cb58-29"><a href="msm_chapter.html#cb58-29" tabindex="-1"></a></span>
<span id="cb58-30"><a href="msm_chapter.html#cb58-30" tabindex="-1"></a><span class="co"># 1e. Calculate sw_{A,i}</span></span>
<span id="cb58-31"><a href="msm_chapter.html#cb58-31" tabindex="-1"></a>sw_Ai <span class="ot">&lt;-</span> gAi <span class="sc">/</span> gAi.L</span>
<span id="cb58-32"><a href="msm_chapter.html#cb58-32" tabindex="-1"></a></span>
<span id="cb58-33"><a href="msm_chapter.html#cb58-33" tabindex="-1"></a><span class="do">## 2. Stabilized weight for the mediator sw_{M,i}</span></span>
<span id="cb58-34"><a href="msm_chapter.html#cb58-34" tabindex="-1"></a><span class="co"># 2a. Estimate g(M=m_i|L(0),A,L(1)) (denominator of the weight)</span></span>
<span id="cb58-35"><a href="msm_chapter.html#cb58-35" tabindex="-1"></a>g.M.L <span class="ot">&lt;-</span> <span class="fu">glm</span>(M_diabetes <span class="sc">~</span> L0_male <span class="sc">+</span> L0_soc_env <span class="sc">+</span> A0_PM2<span class="fl">.5</span> <span class="sc">+</span> L1,</span>
<span id="cb58-36"><a href="msm_chapter.html#cb58-36" tabindex="-1"></a>             <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>, <span class="at">data =</span> df1_int)</span>
<span id="cb58-37"><a href="msm_chapter.html#cb58-37" tabindex="-1"></a><span class="fu">summary</span>(g.M.L)</span>
<span id="cb58-38"><a href="msm_chapter.html#cb58-38" tabindex="-1"></a><span class="co">#               Estimate Std. Error z value Pr(&gt;|z|)</span></span>
<span id="cb58-39"><a href="msm_chapter.html#cb58-39" tabindex="-1"></a><span class="co">#   (Intercept) -1.37880    0.04872 -28.303  &lt; 2e-16 ***</span></span>
<span id="cb58-40"><a href="msm_chapter.html#cb58-40" tabindex="-1"></a><span class="co">#   L0_male      0.25861    0.04437   5.829 5.57e-09 ***</span></span>
<span id="cb58-41"><a href="msm_chapter.html#cb58-41" tabindex="-1"></a><span class="co">#   L0_soc_env   0.33050    0.04744   6.967 3.23e-12 ***</span></span>
<span id="cb58-42"><a href="msm_chapter.html#cb58-42" tabindex="-1"></a><span class="co">#   A0_PM2.5     0.56260    0.06555   8.583  &lt; 2e-16 ***</span></span>
<span id="cb58-43"><a href="msm_chapter.html#cb58-43" tabindex="-1"></a><span class="co">#   L1           0.33462    0.04744   7.054 1.74e-12 ***</span></span>
<span id="cb58-44"><a href="msm_chapter.html#cb58-44" tabindex="-1"></a></span>
<span id="cb58-45"><a href="msm_chapter.html#cb58-45" tabindex="-1"></a><span class="co"># 2b. Predict each individual&#39;s probability of being exposed to her own exposure</span></span>
<span id="cb58-46"><a href="msm_chapter.html#cb58-46" tabindex="-1"></a><span class="co"># the predicted probability of the observed treatment g(A = a_i | L(0)) is :</span></span>
<span id="cb58-47"><a href="msm_chapter.html#cb58-47" tabindex="-1"></a>gMi.L <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">nrow</span>(df1_int))</span>
<span id="cb58-48"><a href="msm_chapter.html#cb58-48" tabindex="-1"></a>gMi.L[df1_int<span class="sc">$</span>M_diabetes<span class="sc">==</span><span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">predict</span>(g.M.L, <span class="at">type=</span><span class="st">&quot;response&quot;</span>)[df1_int<span class="sc">$</span>M_diabetes<span class="sc">==</span><span class="dv">1</span>]</span>
<span id="cb58-49"><a href="msm_chapter.html#cb58-49" tabindex="-1"></a>gMi.L[df1_int<span class="sc">$</span>M_diabetes<span class="sc">==</span><span class="dv">0</span>] <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="fu">predict</span>(g.M.L, <span class="at">type=</span><span class="st">&quot;response&quot;</span>))[df1_int<span class="sc">$</span>M_diabetes<span class="sc">==</span><span class="dv">0</span>]</span>
<span id="cb58-50"><a href="msm_chapter.html#cb58-50" tabindex="-1"></a></span>
<span id="cb58-51"><a href="msm_chapter.html#cb58-51" tabindex="-1"></a><span class="co"># 2c. Estimate g(M=m_i|A) (numerator of the weight)</span></span>
<span id="cb58-52"><a href="msm_chapter.html#cb58-52" tabindex="-1"></a>g.M.A <span class="ot">&lt;-</span> <span class="fu">glm</span>(M_diabetes <span class="sc">~</span> A0_PM2<span class="fl">.5</span>, <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>, <span class="at">data =</span> df1_int)</span>
<span id="cb58-53"><a href="msm_chapter.html#cb58-53" tabindex="-1"></a><span class="fu">summary</span>(g.M.A)</span>
<span id="cb58-54"><a href="msm_chapter.html#cb58-54" tabindex="-1"></a><span class="co">#               Estimate Std. Error z value Pr(&gt;|z|)</span></span>
<span id="cb58-55"><a href="msm_chapter.html#cb58-55" tabindex="-1"></a><span class="co">#   (Intercept) -0.93236    0.02358 -39.544   &lt;2e-16 ***</span></span>
<span id="cb58-56"><a href="msm_chapter.html#cb58-56" tabindex="-1"></a><span class="co">#   A0_PM2.5     0.62388    0.06481   9.627   &lt;2e-16 ***</span></span>
<span id="cb58-57"><a href="msm_chapter.html#cb58-57" tabindex="-1"></a></span>
<span id="cb58-58"><a href="msm_chapter.html#cb58-58" tabindex="-1"></a><span class="co"># 2d. Predict each individual&#39;s probability of being exposed to her own exposure</span></span>
<span id="cb58-59"><a href="msm_chapter.html#cb58-59" tabindex="-1"></a><span class="co"># the predicted probability of the observed treatment g(M = m_i|A) is :</span></span>
<span id="cb58-60"><a href="msm_chapter.html#cb58-60" tabindex="-1"></a>gMi.A <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">nrow</span>(df1_int))</span>
<span id="cb58-61"><a href="msm_chapter.html#cb58-61" tabindex="-1"></a>gMi.A[df1_int<span class="sc">$</span>M_diabetes<span class="sc">==</span><span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">predict</span>(g.M.A, <span class="at">type=</span><span class="st">&quot;response&quot;</span>)[df1_int<span class="sc">$</span>M_diabetes<span class="sc">==</span><span class="dv">1</span>]</span>
<span id="cb58-62"><a href="msm_chapter.html#cb58-62" tabindex="-1"></a>gMi.A[df1_int<span class="sc">$</span>M_diabetes<span class="sc">==</span><span class="dv">0</span>] <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="fu">predict</span>(g.M.A, <span class="at">type=</span><span class="st">&quot;response&quot;</span>))[df1_int<span class="sc">$</span>M_diabetes<span class="sc">==</span><span class="dv">0</span>]</span>
<span id="cb58-63"><a href="msm_chapter.html#cb58-63" tabindex="-1"></a><span class="co"># 2e. Calculate sw_{M,i}</span></span>
<span id="cb58-64"><a href="msm_chapter.html#cb58-64" tabindex="-1"></a>sw_Mi <span class="ot">&lt;-</span> gMi.A <span class="sc">/</span> gMi.L</span>
<span id="cb58-65"><a href="msm_chapter.html#cb58-65" tabindex="-1"></a></span>
<span id="cb58-66"><a href="msm_chapter.html#cb58-66" tabindex="-1"></a><span class="do">## 3. Estimate marginal model for the counterfactual outcome Y_{am}</span></span>
<span id="cb58-67"><a href="msm_chapter.html#cb58-67" tabindex="-1"></a>model.Yam.death <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y_death <span class="sc">~</span> A0_PM2<span class="fl">.5</span> <span class="sc">*</span> M_diabetes,</span>
<span id="cb58-68"><a href="msm_chapter.html#cb58-68" tabindex="-1"></a>                       <span class="at">weights =</span> sw_Ai <span class="sc">*</span> sw_Mi,</span>
<span id="cb58-69"><a href="msm_chapter.html#cb58-69" tabindex="-1"></a>                       <span class="at">family =</span> <span class="st">&quot;gaussian&quot;</span>,</span>
<span id="cb58-70"><a href="msm_chapter.html#cb58-70" tabindex="-1"></a>                       <span class="at">data =</span> df1_int)</span>
<span id="cb58-71"><a href="msm_chapter.html#cb58-71" tabindex="-1"></a><span class="fu">summary</span>(model.Yam.death)</span>
<span id="cb58-72"><a href="msm_chapter.html#cb58-72" tabindex="-1"></a><span class="co"># Coefficients:</span></span>
<span id="cb58-73"><a href="msm_chapter.html#cb58-73" tabindex="-1"></a><span class="co">#                        Estimate Std. Error t value Pr(&gt;|t|)</span></span>
<span id="cb58-74"><a href="msm_chapter.html#cb58-74" tabindex="-1"></a><span class="co">#   (Intercept)          0.178967   0.005049  35.445  &lt; 2e-16 ***</span></span>
<span id="cb58-75"><a href="msm_chapter.html#cb58-75" tabindex="-1"></a><span class="co">#   A0_PM2.5             0.067151   0.016679   4.026 5.72e-05 ***</span></span>
<span id="cb58-76"><a href="msm_chapter.html#cb58-76" tabindex="-1"></a><span class="co">#   M_diabetes           0.067321   0.009508   7.080 1.54e-12 ***</span></span>
<span id="cb58-77"><a href="msm_chapter.html#cb58-77" tabindex="-1"></a><span class="co">#   A0_PM2.5:M_diabetes -0.004491   0.026027  -0.173    0.863</span></span>
<span id="cb58-78"><a href="msm_chapter.html#cb58-78" tabindex="-1"></a></span>
<span id="cb58-79"><a href="msm_chapter.html#cb58-79" tabindex="-1"></a><span class="do">## 4) Estimate marginal model for the counterfactual mediator P(M_a* = 1)</span></span>
<span id="cb58-80"><a href="msm_chapter.html#cb58-80" tabindex="-1"></a>model.Ma <span class="ot">&lt;-</span> <span class="fu">glm</span>(M_diabetes <span class="sc">~</span> A0_PM2<span class="fl">.5</span>,</span>
<span id="cb58-81"><a href="msm_chapter.html#cb58-81" tabindex="-1"></a>                <span class="at">weights =</span> sw_Ai,</span>
<span id="cb58-82"><a href="msm_chapter.html#cb58-82" tabindex="-1"></a>                <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>,</span>
<span id="cb58-83"><a href="msm_chapter.html#cb58-83" tabindex="-1"></a>                <span class="at">data =</span> df1_int)</span>
<span id="cb58-84"><a href="msm_chapter.html#cb58-84" tabindex="-1"></a><span class="fu">summary</span>(model.Ma)</span>
<span id="cb58-85"><a href="msm_chapter.html#cb58-85" tabindex="-1"></a><span class="co"># Coefficients:</span></span>
<span id="cb58-86"><a href="msm_chapter.html#cb58-86" tabindex="-1"></a><span class="co">#               Estimate Std. Error z value Pr(&gt;|z|)</span></span>
<span id="cb58-87"><a href="msm_chapter.html#cb58-87" tabindex="-1"></a><span class="co">#   (Intercept) -0.92405    0.02353 -39.264   &lt;2e-16 ***</span></span>
<span id="cb58-88"><a href="msm_chapter.html#cb58-88" tabindex="-1"></a><span class="co">#   A0_PM2.5     0.58413    0.06501   8.986   &lt;2e-16 ***</span></span>
<span id="cb58-89"><a href="msm_chapter.html#cb58-89" tabindex="-1"></a></span>
<span id="cb58-90"><a href="msm_chapter.html#cb58-90" tabindex="-1"></a><span class="do">## 5) Estimate population average counterfactuals using the &quot;mediation formula&quot;</span></span>
<span id="cb58-91"><a href="msm_chapter.html#cb58-91" tabindex="-1"></a><span class="do">##    E(Y_{a,M_a*}) = sum_m E(Y_{am}) * P(M_a^* = m)</span></span>
<span id="cb58-92"><a href="msm_chapter.html#cb58-92" tabindex="-1"></a>E.Y0M0 <span class="ot">&lt;-</span> ((<span class="fu">coef</span>(model.Yam.death)[<span class="st">&quot;(Intercept)&quot;</span>] <span class="sc">+</span> <span class="co"># sum_m E(Y_{a0}) * P(M_a^* = 0)</span></span>
<span id="cb58-93"><a href="msm_chapter.html#cb58-93" tabindex="-1"></a>             <span class="fu">coef</span>(model.Yam.death)[<span class="st">&quot;A0_PM2.5&quot;</span>] <span class="sc">*</span> <span class="dv">0</span> <span class="sc">+</span></span>
<span id="cb58-94"><a href="msm_chapter.html#cb58-94" tabindex="-1"></a>             <span class="fu">coef</span>(model.Yam.death)[<span class="st">&quot;M_diabetes&quot;</span>] <span class="sc">*</span> <span class="dv">0</span> <span class="sc">+</span></span>
<span id="cb58-95"><a href="msm_chapter.html#cb58-95" tabindex="-1"></a>             <span class="fu">coef</span>(model.Yam.death)[<span class="st">&quot;A0_PM2.5:M_diabetes&quot;</span>] <span class="sc">*</span> <span class="dv">0</span> <span class="sc">*</span> <span class="dv">0</span>) <span class="sc">*</span></span>
<span id="cb58-96"><a href="msm_chapter.html#cb58-96" tabindex="-1"></a>             (<span class="dv">1</span> <span class="sc">-</span> <span class="fu">plogis</span>(<span class="fu">coef</span>(model.Ma)[<span class="st">&quot;(Intercept)&quot;</span>] <span class="sc">+</span></span>
<span id="cb58-97"><a href="msm_chapter.html#cb58-97" tabindex="-1"></a>                           <span class="fu">coef</span>(model.Ma)[<span class="st">&quot;A0_PM2.5&quot;</span>] <span class="sc">*</span> <span class="dv">0</span>))) <span class="sc">+</span></span>
<span id="cb58-98"><a href="msm_chapter.html#cb58-98" tabindex="-1"></a>  ((<span class="fu">coef</span>(model.Yam.death)[<span class="st">&quot;(Intercept)&quot;</span>] <span class="sc">+</span>  <span class="co"># sum_m E(Y_{a1}) * P(M_a^* = 1)</span></span>
<span id="cb58-99"><a href="msm_chapter.html#cb58-99" tabindex="-1"></a>      <span class="fu">coef</span>(model.Yam.death)[<span class="st">&quot;A0_PM2.5&quot;</span>] <span class="sc">*</span> <span class="dv">0</span> <span class="sc">+</span></span>
<span id="cb58-100"><a href="msm_chapter.html#cb58-100" tabindex="-1"></a>      <span class="fu">coef</span>(model.Yam.death)[<span class="st">&quot;M_diabetes&quot;</span>] <span class="sc">*</span> <span class="dv">1</span> <span class="sc">+</span></span>
<span id="cb58-101"><a href="msm_chapter.html#cb58-101" tabindex="-1"></a>      <span class="fu">coef</span>(model.Yam.death)[<span class="st">&quot;A0_PM2.5:M_diabetes&quot;</span>] <span class="sc">*</span> <span class="dv">0</span> <span class="sc">*</span> <span class="dv">1</span>) <span class="sc">*</span></span>
<span id="cb58-102"><a href="msm_chapter.html#cb58-102" tabindex="-1"></a>     (<span class="fu">plogis</span>(<span class="fu">coef</span>(model.Ma)[<span class="st">&quot;(Intercept)&quot;</span>] <span class="sc">+</span></span>
<span id="cb58-103"><a href="msm_chapter.html#cb58-103" tabindex="-1"></a>               <span class="fu">coef</span>(model.Ma)[<span class="st">&quot;A0_PM2.5&quot;</span>] <span class="sc">*</span> <span class="dv">0</span>)))</span>
<span id="cb58-104"><a href="msm_chapter.html#cb58-104" tabindex="-1"></a></span>
<span id="cb58-105"><a href="msm_chapter.html#cb58-105" tabindex="-1"></a>E.Y1M0 <span class="ot">&lt;-</span> ((<span class="fu">coef</span>(model.Yam.death)[<span class="st">&quot;(Intercept)&quot;</span>] <span class="sc">+</span> <span class="co"># sum_m E(Y_{a,M=0}) * P(M_0 = 0)</span></span>
<span id="cb58-106"><a href="msm_chapter.html#cb58-106" tabindex="-1"></a>              <span class="fu">coef</span>(model.Yam.death)[<span class="st">&quot;A0_PM2.5&quot;</span>] <span class="sc">*</span> <span class="dv">1</span> <span class="sc">+</span></span>
<span id="cb58-107"><a href="msm_chapter.html#cb58-107" tabindex="-1"></a>              <span class="fu">coef</span>(model.Yam.death)[<span class="st">&quot;M_diabetes&quot;</span>] <span class="sc">*</span> <span class="dv">0</span> <span class="sc">+</span></span>
<span id="cb58-108"><a href="msm_chapter.html#cb58-108" tabindex="-1"></a>              <span class="fu">coef</span>(model.Yam.death)[<span class="st">&quot;A0_PM2.5:M_diabetes&quot;</span>] <span class="sc">*</span> <span class="dv">1</span> <span class="sc">*</span> <span class="dv">0</span>) <span class="sc">*</span></span>
<span id="cb58-109"><a href="msm_chapter.html#cb58-109" tabindex="-1"></a>             (<span class="dv">1</span> <span class="sc">-</span> <span class="fu">plogis</span>(<span class="fu">coef</span>(model.Ma)[<span class="st">&quot;(Intercept)&quot;</span>] <span class="sc">+</span></span>
<span id="cb58-110"><a href="msm_chapter.html#cb58-110" tabindex="-1"></a>                           <span class="fu">coef</span>(model.Ma)[<span class="st">&quot;A0_PM2.5&quot;</span>] <span class="sc">*</span> <span class="dv">0</span>))) <span class="sc">+</span></span>
<span id="cb58-111"><a href="msm_chapter.html#cb58-111" tabindex="-1"></a>  ((<span class="fu">coef</span>(model.Yam.death)[<span class="st">&quot;(Intercept)&quot;</span>] <span class="sc">+</span>  <span class="co"># sum_m E(Y_{a,M=1}) * P(M_0 = 1)</span></span>
<span id="cb58-112"><a href="msm_chapter.html#cb58-112" tabindex="-1"></a>      <span class="fu">coef</span>(model.Yam.death)[<span class="st">&quot;A0_PM2.5&quot;</span>] <span class="sc">*</span> <span class="dv">1</span> <span class="sc">+</span></span>
<span id="cb58-113"><a href="msm_chapter.html#cb58-113" tabindex="-1"></a>      <span class="fu">coef</span>(model.Yam.death)[<span class="st">&quot;M_diabetes&quot;</span>] <span class="sc">*</span> <span class="dv">1</span> <span class="sc">+</span></span>
<span id="cb58-114"><a href="msm_chapter.html#cb58-114" tabindex="-1"></a>      <span class="fu">coef</span>(model.Yam.death)[<span class="st">&quot;A0_PM2.5:M_diabetes&quot;</span>] <span class="sc">*</span> <span class="dv">1</span> <span class="sc">*</span> <span class="dv">1</span>) <span class="sc">*</span></span>
<span id="cb58-115"><a href="msm_chapter.html#cb58-115" tabindex="-1"></a>     (<span class="fu">plogis</span>(<span class="fu">coef</span>(model.Ma)[<span class="st">&quot;(Intercept)&quot;</span>] <span class="sc">+</span></span>
<span id="cb58-116"><a href="msm_chapter.html#cb58-116" tabindex="-1"></a>               <span class="fu">coef</span>(model.Ma)[<span class="st">&quot;A0_PM2.5&quot;</span>] <span class="sc">*</span> <span class="dv">0</span>)))</span>
<span id="cb58-117"><a href="msm_chapter.html#cb58-117" tabindex="-1"></a></span>
<span id="cb58-118"><a href="msm_chapter.html#cb58-118" tabindex="-1"></a>E.Y1M1 <span class="ot">&lt;-</span> ((<span class="fu">coef</span>(model.Yam.death)[<span class="st">&quot;(Intercept)&quot;</span>] <span class="sc">+</span> <span class="co">#  E(Y_{a,M=0}) * P(M_1 = 0)</span></span>
<span id="cb58-119"><a href="msm_chapter.html#cb58-119" tabindex="-1"></a>              <span class="fu">coef</span>(model.Yam.death)[<span class="st">&quot;A0_PM2.5&quot;</span>] <span class="sc">*</span> <span class="dv">1</span> <span class="sc">+</span></span>
<span id="cb58-120"><a href="msm_chapter.html#cb58-120" tabindex="-1"></a>              <span class="fu">coef</span>(model.Yam.death)[<span class="st">&quot;M_diabetes&quot;</span>] <span class="sc">*</span> <span class="dv">0</span> <span class="sc">+</span></span>
<span id="cb58-121"><a href="msm_chapter.html#cb58-121" tabindex="-1"></a>              <span class="fu">coef</span>(model.Yam.death)[<span class="st">&quot;A0_PM2.5:M_diabetes&quot;</span>] <span class="sc">*</span> <span class="dv">1</span> <span class="sc">*</span> <span class="dv">0</span>) <span class="sc">*</span></span>
<span id="cb58-122"><a href="msm_chapter.html#cb58-122" tabindex="-1"></a>             (<span class="dv">1</span> <span class="sc">-</span> <span class="fu">plogis</span>(<span class="fu">coef</span>(model.Ma)[<span class="st">&quot;(Intercept)&quot;</span>] <span class="sc">+</span></span>
<span id="cb58-123"><a href="msm_chapter.html#cb58-123" tabindex="-1"></a>                           <span class="fu">coef</span>(model.Ma)[<span class="st">&quot;A0_PM2.5&quot;</span>] <span class="sc">*</span> <span class="dv">1</span>))) <span class="sc">+</span></span>
<span id="cb58-124"><a href="msm_chapter.html#cb58-124" tabindex="-1"></a>  ((<span class="fu">coef</span>(model.Yam.death)[<span class="st">&quot;(Intercept)&quot;</span>] <span class="sc">+</span>  <span class="co">#  E(Y_{a,M=1}) * P(M_1 = 1)</span></span>
<span id="cb58-125"><a href="msm_chapter.html#cb58-125" tabindex="-1"></a>      <span class="fu">coef</span>(model.Yam.death)[<span class="st">&quot;A0_PM2.5&quot;</span>] <span class="sc">*</span> <span class="dv">1</span> <span class="sc">+</span></span>
<span id="cb58-126"><a href="msm_chapter.html#cb58-126" tabindex="-1"></a>      <span class="fu">coef</span>(model.Yam.death)[<span class="st">&quot;M_diabetes&quot;</span>] <span class="sc">*</span> <span class="dv">1</span> <span class="sc">+</span></span>
<span id="cb58-127"><a href="msm_chapter.html#cb58-127" tabindex="-1"></a>      <span class="fu">coef</span>(model.Yam.death)[<span class="st">&quot;A0_PM2.5:M_diabetes&quot;</span>] <span class="sc">*</span> <span class="dv">1</span> <span class="sc">*</span> <span class="dv">1</span>) <span class="sc">*</span></span>
<span id="cb58-128"><a href="msm_chapter.html#cb58-128" tabindex="-1"></a>     (<span class="fu">plogis</span>(<span class="fu">coef</span>(model.Ma)[<span class="st">&quot;(Intercept)&quot;</span>] <span class="sc">+</span></span>
<span id="cb58-129"><a href="msm_chapter.html#cb58-129" tabindex="-1"></a>               <span class="fu">coef</span>(model.Ma)[<span class="st">&quot;A0_PM2.5&quot;</span>] <span class="sc">*</span> <span class="dv">1</span>)))</span>
<span id="cb58-130"><a href="msm_chapter.html#cb58-130" tabindex="-1"></a></span>
<span id="cb58-131"><a href="msm_chapter.html#cb58-131" tabindex="-1"></a>PNDE.death <span class="ot">&lt;-</span> E.Y1M0 <span class="sc">-</span> E.Y0M0</span>
<span id="cb58-132"><a href="msm_chapter.html#cb58-132" tabindex="-1"></a><span class="co"># 0.06587481</span></span>
<span id="cb58-133"><a href="msm_chapter.html#cb58-133" tabindex="-1"></a>TNIE.death <span class="ot">&lt;-</span> E.Y1M1 <span class="sc">-</span> E.Y1M0</span>
<span id="cb58-134"><a href="msm_chapter.html#cb58-134" tabindex="-1"></a><span class="co"># 0.008274351</span></span></code></pre></div>
<p>In the example above, we directly used the estimated coefficients of the MSMs to calculate the quantities <span class="math inline">\(\mathbb{E}(Y_{a,M_{a^\prime}})\)</span> for the PNDE and the TNIE. When using the CMAverse, individual values for the counterfactual mediator are simulated as shown below. This strategy can be useful if the mediator is continuous of high-dimensional.</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="msm_chapter.html#cb59-1" tabindex="-1"></a><span class="do">## 6) Estimate population average counterfactuals using simulated</span></span>
<span id="cb59-2"><a href="msm_chapter.html#cb59-2" tabindex="-1"></a><span class="do">##    values of the mediator</span></span>
<span id="cb59-3"><a href="msm_chapter.html#cb59-3" tabindex="-1"></a>PNDE.death.sim <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>,<span class="dv">5</span>)</span>
<span id="cb59-4"><a href="msm_chapter.html#cb59-4" tabindex="-1"></a>TNIE.death.sim <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>,<span class="dv">5</span>)</span>
<span id="cb59-5"><a href="msm_chapter.html#cb59-5" tabindex="-1"></a></span>
<span id="cb59-6"><a href="msm_chapter.html#cb59-6" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb59-7"><a href="msm_chapter.html#cb59-7" tabindex="-1"></a><span class="cf">for</span>(k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">15</span>){</span>
<span id="cb59-8"><a href="msm_chapter.html#cb59-8" tabindex="-1"></a>  M0 <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="at">n =</span> <span class="fu">nrow</span>(df1_int), <span class="at">size =</span> <span class="dv">1</span>,</span>
<span id="cb59-9"><a href="msm_chapter.html#cb59-9" tabindex="-1"></a>               <span class="at">prob =</span> <span class="fu">plogis</span>(<span class="fu">coef</span>(model.Ma)[<span class="st">&quot;(Intercept)&quot;</span>] <span class="sc">+</span></span>
<span id="cb59-10"><a href="msm_chapter.html#cb59-10" tabindex="-1"></a>                               <span class="fu">coef</span>(model.Ma)[<span class="st">&quot;A0_PM2.5&quot;</span>] <span class="sc">*</span> <span class="dv">0</span>))</span>
<span id="cb59-11"><a href="msm_chapter.html#cb59-11" tabindex="-1"></a>  M1 <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="at">n =</span> <span class="fu">nrow</span>(df1_int), <span class="at">size =</span> <span class="dv">1</span>,</span>
<span id="cb59-12"><a href="msm_chapter.html#cb59-12" tabindex="-1"></a>               <span class="at">prob =</span> <span class="fu">plogis</span>(<span class="fu">coef</span>(model.Ma)[<span class="st">&quot;(Intercept)&quot;</span>] <span class="sc">+</span></span>
<span id="cb59-13"><a href="msm_chapter.html#cb59-13" tabindex="-1"></a>                               <span class="fu">coef</span>(model.Ma)[<span class="st">&quot;A0_PM2.5&quot;</span>] <span class="sc">*</span> <span class="dv">1</span>))</span>
<span id="cb59-14"><a href="msm_chapter.html#cb59-14" tabindex="-1"></a>  E.Y0M0 <span class="ot">&lt;-</span> <span class="fu">mean</span>((<span class="fu">coef</span>(model.Yam.death)[<span class="st">&quot;(Intercept)&quot;</span>] <span class="sc">+</span></span>
<span id="cb59-15"><a href="msm_chapter.html#cb59-15" tabindex="-1"></a>                    <span class="fu">coef</span>(model.Yam.death)[<span class="st">&quot;A0_PM2.5&quot;</span>] <span class="sc">*</span> <span class="dv">0</span> <span class="sc">+</span></span>
<span id="cb59-16"><a href="msm_chapter.html#cb59-16" tabindex="-1"></a>                    <span class="fu">coef</span>(model.Yam.death)[<span class="st">&quot;M_diabetes&quot;</span>] <span class="sc">*</span> M0 <span class="sc">+</span></span>
<span id="cb59-17"><a href="msm_chapter.html#cb59-17" tabindex="-1"></a>                    <span class="fu">coef</span>(model.Yam.death)[<span class="st">&quot;A0_PM2.5:M_diabetes&quot;</span>] <span class="sc">*</span> <span class="dv">0</span> <span class="sc">*</span> M0))</span>
<span id="cb59-18"><a href="msm_chapter.html#cb59-18" tabindex="-1"></a>  E.Y1M0 <span class="ot">&lt;-</span> <span class="fu">mean</span>((<span class="fu">coef</span>(model.Yam.death)[<span class="st">&quot;(Intercept)&quot;</span>] <span class="sc">+</span></span>
<span id="cb59-19"><a href="msm_chapter.html#cb59-19" tabindex="-1"></a>                    <span class="fu">coef</span>(model.Yam.death)[<span class="st">&quot;A0_PM2.5&quot;</span>] <span class="sc">*</span> <span class="dv">1</span> <span class="sc">+</span></span>
<span id="cb59-20"><a href="msm_chapter.html#cb59-20" tabindex="-1"></a>                    <span class="fu">coef</span>(model.Yam.death)[<span class="st">&quot;M_diabetes&quot;</span>] <span class="sc">*</span> M0 <span class="sc">+</span></span>
<span id="cb59-21"><a href="msm_chapter.html#cb59-21" tabindex="-1"></a>                    <span class="fu">coef</span>(model.Yam.death)[<span class="st">&quot;A0_PM2.5:M_diabetes&quot;</span>] <span class="sc">*</span> <span class="dv">1</span> <span class="sc">*</span> M0))</span>
<span id="cb59-22"><a href="msm_chapter.html#cb59-22" tabindex="-1"></a>  E.Y1M1 <span class="ot">&lt;-</span> <span class="fu">mean</span>((<span class="fu">coef</span>(model.Yam.death)[<span class="st">&quot;(Intercept)&quot;</span>] <span class="sc">+</span></span>
<span id="cb59-23"><a href="msm_chapter.html#cb59-23" tabindex="-1"></a>                <span class="fu">coef</span>(model.Yam.death)[<span class="st">&quot;A0_PM2.5&quot;</span>] <span class="sc">*</span> <span class="dv">1</span> <span class="sc">+</span></span>
<span id="cb59-24"><a href="msm_chapter.html#cb59-24" tabindex="-1"></a>                <span class="fu">coef</span>(model.Yam.death)[<span class="st">&quot;M_diabetes&quot;</span>] <span class="sc">*</span> M1 <span class="sc">+</span></span>
<span id="cb59-25"><a href="msm_chapter.html#cb59-25" tabindex="-1"></a>                <span class="fu">coef</span>(model.Yam.death)[<span class="st">&quot;A0_PM2.5:M_diabetes&quot;</span>] <span class="sc">*</span> <span class="dv">1</span> <span class="sc">*</span> M1))</span>
<span id="cb59-26"><a href="msm_chapter.html#cb59-26" tabindex="-1"></a>  PNDE.death.sim[k] <span class="ot">&lt;-</span> E.Y1M0  <span class="sc">-</span> E.Y0M0</span>
<span id="cb59-27"><a href="msm_chapter.html#cb59-27" tabindex="-1"></a>  TNIE.death.sim[k] <span class="ot">&lt;-</span> E.Y1M1 <span class="sc">-</span> E.Y1M0</span>
<span id="cb59-28"><a href="msm_chapter.html#cb59-28" tabindex="-1"></a>}</span>
<span id="cb59-29"><a href="msm_chapter.html#cb59-29" tabindex="-1"></a><span class="fu">mean</span>(PNDE.death.sim)</span>
<span id="cb59-30"><a href="msm_chapter.html#cb59-30" tabindex="-1"></a><span class="co"># [1] 0.06587304</span></span>
<span id="cb59-31"><a href="msm_chapter.html#cb59-31" tabindex="-1"></a><span class="fu">mean</span>(TNIE.death.sim)</span>
<span id="cb59-32"><a href="msm_chapter.html#cb59-32" tabindex="-1"></a><span class="co"># [1] 0.00824998</span></span></code></pre></div>
</div>
<div id="estimation-of-nde-and-nie-using-cmaverse-by-iptw-or-gcomputation" class="section level3 hasAnchor" number="8.4.2">
<h3><span class="header-section-number">8.4.2</span> Estimation of NDE and NIE using CMAverse (by IPTW or gcomputation)<a href="msm_chapter.html#estimation-of-nde-and-nie-using-cmaverse-by-iptw-or-gcomputation" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We can use the <code>CMAverse</code> package to estimate the coefficients of the 2 MSMs required to estimate Natural Direct and Indirect Effects.</p>
<p>For estimation by IPTW, we have to specify the following arguments <code>model = msm</code> (to estimate the MSM of the outcome and the MSM of the mediator), and that the counterfactual mediator values are simulated (<code>estimation = "imputation"</code>). Because the coefficients of the MSMs are estimated by IPTW, we have to specify</p>
<ul>
<li>the link functions for the MSM of the outcome (<code>yreg</code>) and the MSM of the mediator (<code>mreg</code>)</li>
<li>and the link function to calculate the weights <code>ereg</code> for <span class="math inline">\(\mathbb{P}(A=1|L(0))\)</span>, <code>wmnomreg</code> for the numerator of the mediator’s weight and <code>wmdenomreg</code> for the denominator of the mediator’s weight.</li>
</ul>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="msm_chapter.html#cb60-1" tabindex="-1"></a><span class="do">## Using the CMAverse to estimate MSM estimated by IPTW</span></span>
<span id="cb60-2"><a href="msm_chapter.html#cb60-2" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>) <span class="co"># note: there is randomness, even with estimation by IPTW</span></span>
<span id="cb60-3"><a href="msm_chapter.html#cb60-3" tabindex="-1"></a>               <span class="co">#       =&gt; counterfactuals are imputed (estimation = &quot;imputation&quot;)</span></span>
<span id="cb60-4"><a href="msm_chapter.html#cb60-4" tabindex="-1"></a>res_msm_df1 <span class="ot">&lt;-</span> <span class="fu">cmest</span>(<span class="at">data =</span> df1_int,</span>
<span id="cb60-5"><a href="msm_chapter.html#cb60-5" tabindex="-1"></a>                     <span class="at">model =</span> <span class="st">&quot;msm&quot;</span>,</span>
<span id="cb60-6"><a href="msm_chapter.html#cb60-6" tabindex="-1"></a>                     <span class="at">outcome =</span> <span class="st">&quot;Y_death&quot;</span>,</span>
<span id="cb60-7"><a href="msm_chapter.html#cb60-7" tabindex="-1"></a>                     <span class="at">exposure =</span> <span class="st">&quot;A0_PM2.5&quot;</span>,</span>
<span id="cb60-8"><a href="msm_chapter.html#cb60-8" tabindex="-1"></a>                     <span class="at">mediator =</span> <span class="st">&quot;M_diabetes&quot;</span>,</span>
<span id="cb60-9"><a href="msm_chapter.html#cb60-9" tabindex="-1"></a>                     <span class="at">basec =</span> <span class="fu">c</span>(<span class="st">&quot;L0_male&quot;</span>, <span class="st">&quot;L0_soc_env&quot;</span>,<span class="st">&quot;L1&quot;</span>),</span>
<span id="cb60-10"><a href="msm_chapter.html#cb60-10" tabindex="-1"></a>                     <span class="at">postc =</span> <span class="cn">NULL</span>,</span>
<span id="cb60-11"><a href="msm_chapter.html#cb60-11" tabindex="-1"></a>                     <span class="at">EMint =</span> <span class="cn">TRUE</span>, <span class="co"># E*M interaction</span></span>
<span id="cb60-12"><a href="msm_chapter.html#cb60-12" tabindex="-1"></a>                     <span class="at">ereg =</span> <span class="st">&quot;logistic&quot;</span>, <span class="co"># exposure regression model g(A=1|L(0))</span></span>
<span id="cb60-13"><a href="msm_chapter.html#cb60-13" tabindex="-1"></a>                     <span class="at">yreg =</span> <span class="st">&quot;linear&quot;</span>, <span class="co"># to get risk difference</span></span>
<span id="cb60-14"><a href="msm_chapter.html#cb60-14" tabindex="-1"></a>                     <span class="at">mreg =</span> <span class="fu">list</span>(<span class="st">&quot;logistic&quot;</span>), <span class="co"># mediation model g(M=1|L1,A,L0)</span></span>
<span id="cb60-15"><a href="msm_chapter.html#cb60-15" tabindex="-1"></a>                     <span class="at">wmnomreg =</span> <span class="fu">list</span>(<span class="st">&quot;logistic&quot;</span>), <span class="co">#g(M=1|A) wgt nominator</span></span>
<span id="cb60-16"><a href="msm_chapter.html#cb60-16" tabindex="-1"></a>                     <span class="at">wmdenomreg =</span> <span class="fu">list</span>(<span class="st">&quot;logistic&quot;</span>), <span class="co"># g(M=1|L1,A,L(0)) wgt denom</span></span>
<span id="cb60-17"><a href="msm_chapter.html#cb60-17" tabindex="-1"></a>                     <span class="at">astar =</span> <span class="dv">0</span>, <span class="co">#E(Y_{A=0,M=1})</span></span>
<span id="cb60-18"><a href="msm_chapter.html#cb60-18" tabindex="-1"></a>                     <span class="at">a =</span> <span class="dv">1</span>,  <span class="co">#E(Y_{A=1,M=1})</span></span>
<span id="cb60-19"><a href="msm_chapter.html#cb60-19" tabindex="-1"></a>                     <span class="at">mval =</span> <span class="fu">list</span>(<span class="dv">0</span>), <span class="co"># mediator value at which the variable is controlled</span></span>
<span id="cb60-20"><a href="msm_chapter.html#cb60-20" tabindex="-1"></a>                     <span class="at">estimation =</span> <span class="st">&quot;imputation&quot;</span>,</span>
<span id="cb60-21"><a href="msm_chapter.html#cb60-21" tabindex="-1"></a>                     <span class="at">inference =</span> <span class="st">&quot;bootstrap&quot;</span>,</span>
<span id="cb60-22"><a href="msm_chapter.html#cb60-22" tabindex="-1"></a>                     <span class="at">nboot =</span> <span class="dv">2</span>)</span>
<span id="cb60-23"><a href="msm_chapter.html#cb60-23" tabindex="-1"></a><span class="fu">summary</span>(res_msm_df1)</span>
<span id="cb60-24"><a href="msm_chapter.html#cb60-24" tabindex="-1"></a><span class="co"># Causal Mediation Analysis</span></span>
<span id="cb60-25"><a href="msm_chapter.html#cb60-25" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb60-26"><a href="msm_chapter.html#cb60-26" tabindex="-1"></a><span class="co"># # Outcome regression:</span></span>
<span id="cb60-27"><a href="msm_chapter.html#cb60-27" tabindex="-1"></a><span class="co"># Call:</span></span>
<span id="cb60-28"><a href="msm_chapter.html#cb60-28" tabindex="-1"></a><span class="co">#   glm(formula = Y_death ~ A0_PM2.5 + M_diabetes + A0_PM2.5 * M_diabetes,</span></span>
<span id="cb60-29"><a href="msm_chapter.html#cb60-29" tabindex="-1"></a><span class="co">#       family = gaussian(), data = getCall(x$reg.output$yreg)$data,</span></span>
<span id="cb60-30"><a href="msm_chapter.html#cb60-30" tabindex="-1"></a><span class="co">#       weights = getCall(x$reg.output$yreg)$weights)</span></span>
<span id="cb60-31"><a href="msm_chapter.html#cb60-31" tabindex="-1"></a><span class="co"># Coefficients:</span></span>
<span id="cb60-32"><a href="msm_chapter.html#cb60-32" tabindex="-1"></a><span class="co">#                        Estimate Std. Error t value Pr(&gt;|t|)</span></span>
<span id="cb60-33"><a href="msm_chapter.html#cb60-33" tabindex="-1"></a><span class="co">#   (Intercept)          0.178967   0.005049  35.445  &lt; 2e-16 ***</span></span>
<span id="cb60-34"><a href="msm_chapter.html#cb60-34" tabindex="-1"></a><span class="co">#   A0_PM2.5             0.067151   0.016679   4.026 5.72e-05 ***</span></span>
<span id="cb60-35"><a href="msm_chapter.html#cb60-35" tabindex="-1"></a><span class="co">#   M_diabetes           0.067321   0.009508   7.080 1.54e-12 ***</span></span>
<span id="cb60-36"><a href="msm_chapter.html#cb60-36" tabindex="-1"></a><span class="co">#   A0_PM2.5:M_diabetes -0.004491   0.026027  -0.173    0.863</span></span>
<span id="cb60-37"><a href="msm_chapter.html#cb60-37" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb60-38"><a href="msm_chapter.html#cb60-38" tabindex="-1"></a><span class="co"># # Mediator regressions:</span></span>
<span id="cb60-39"><a href="msm_chapter.html#cb60-39" tabindex="-1"></a><span class="co"># Call:</span></span>
<span id="cb60-40"><a href="msm_chapter.html#cb60-40" tabindex="-1"></a><span class="co">#   glm(formula = M_diabetes ~ A0_PM2.5, family = binomial(), </span></span>
<span id="cb60-41"><a href="msm_chapter.html#cb60-41" tabindex="-1"></a><span class="co">#       data = getCall(x$reg.output$mreg[[1L]])$data,</span></span>
<span id="cb60-42"><a href="msm_chapter.html#cb60-42" tabindex="-1"></a><span class="co">#       weights = getCall(x$reg.output$mreg[[1L]])$weights)</span></span>
<span id="cb60-43"><a href="msm_chapter.html#cb60-43" tabindex="-1"></a><span class="co"># Coefficients:</span></span>
<span id="cb60-44"><a href="msm_chapter.html#cb60-44" tabindex="-1"></a><span class="co">#               Estimate Std. Error z value Pr(&gt;|z|)</span></span>
<span id="cb60-45"><a href="msm_chapter.html#cb60-45" tabindex="-1"></a><span class="co">#   (Intercept) -0.92405    0.02353 -39.264   &lt;2e-16 ***</span></span>
<span id="cb60-46"><a href="msm_chapter.html#cb60-46" tabindex="-1"></a><span class="co">#   A0_PM2.5     0.58413    0.06501   8.986   &lt;2e-16 ***</span></span>
<span id="cb60-47"><a href="msm_chapter.html#cb60-47" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb60-48"><a href="msm_chapter.html#cb60-48" tabindex="-1"></a><span class="co"># # Mediator regressions for weighting (denominator):</span></span>
<span id="cb60-49"><a href="msm_chapter.html#cb60-49" tabindex="-1"></a><span class="co"># Call:</span></span>
<span id="cb60-50"><a href="msm_chapter.html#cb60-50" tabindex="-1"></a><span class="co">#   glm(formula = M_diabetes ~ A0_PM2.5 + L0_male + L0_soc_env +</span></span>
<span id="cb60-51"><a href="msm_chapter.html#cb60-51" tabindex="-1"></a><span class="co">#         L1, family = binomial(), data = getCall(x$reg.output$wmdenomreg[[1L]])$data,</span></span>
<span id="cb60-52"><a href="msm_chapter.html#cb60-52" tabindex="-1"></a><span class="co">#       weights = getCall(x$reg.output$wmdenomreg[[1L]])$weights)</span></span>
<span id="cb60-53"><a href="msm_chapter.html#cb60-53" tabindex="-1"></a><span class="co"># Coefficients:</span></span>
<span id="cb60-54"><a href="msm_chapter.html#cb60-54" tabindex="-1"></a><span class="co">#               Estimate Std. Error z value Pr(&gt;|z|)</span></span>
<span id="cb60-55"><a href="msm_chapter.html#cb60-55" tabindex="-1"></a><span class="co">#   (Intercept) -1.37880    0.04872 -28.303  &lt; 2e-16 ***</span></span>
<span id="cb60-56"><a href="msm_chapter.html#cb60-56" tabindex="-1"></a><span class="co">#   A0_PM2.5     0.56260    0.06555   8.583  &lt; 2e-16 ***</span></span>
<span id="cb60-57"><a href="msm_chapter.html#cb60-57" tabindex="-1"></a><span class="co">#   L0_male      0.25861    0.04437   5.829 5.57e-09 ***</span></span>
<span id="cb60-58"><a href="msm_chapter.html#cb60-58" tabindex="-1"></a><span class="co">#   L0_soc_env   0.33050    0.04744   6.967 3.23e-12 ***</span></span>
<span id="cb60-59"><a href="msm_chapter.html#cb60-59" tabindex="-1"></a><span class="co">#   L1           0.33462    0.04744   7.054 1.74e-12 ***</span></span>
<span id="cb60-60"><a href="msm_chapter.html#cb60-60" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb60-61"><a href="msm_chapter.html#cb60-61" tabindex="-1"></a><span class="co"># # Mediator regressions for weighting (nominator):</span></span>
<span id="cb60-62"><a href="msm_chapter.html#cb60-62" tabindex="-1"></a><span class="co"># Call:</span></span>
<span id="cb60-63"><a href="msm_chapter.html#cb60-63" tabindex="-1"></a><span class="co">#   glm(formula = M_diabetes ~ A0_PM2.5, family = binomial(), </span></span>
<span id="cb60-64"><a href="msm_chapter.html#cb60-64" tabindex="-1"></a><span class="co">#       data = getCall(x$reg.output$wmnomreg[[1L]])$data,</span></span>
<span id="cb60-65"><a href="msm_chapter.html#cb60-65" tabindex="-1"></a><span class="co">#       weights = getCall(x$reg.output$wmnomreg[[1L]])$weights)</span></span>
<span id="cb60-66"><a href="msm_chapter.html#cb60-66" tabindex="-1"></a><span class="co"># Coefficients:</span></span>
<span id="cb60-67"><a href="msm_chapter.html#cb60-67" tabindex="-1"></a><span class="co">#               Estimate Std. Error z value Pr(&gt;|z|)</span></span>
<span id="cb60-68"><a href="msm_chapter.html#cb60-68" tabindex="-1"></a><span class="co">#   (Intercept) -0.93236    0.02358 -39.544   &lt;2e-16 ***</span></span>
<span id="cb60-69"><a href="msm_chapter.html#cb60-69" tabindex="-1"></a><span class="co">#   A0_PM2.5     0.62388    0.06481   9.627   &lt;2e-16 ***</span></span>
<span id="cb60-70"><a href="msm_chapter.html#cb60-70" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb60-71"><a href="msm_chapter.html#cb60-71" tabindex="-1"></a><span class="co"># # Exposure regression for weighting:</span></span>
<span id="cb60-72"><a href="msm_chapter.html#cb60-72" tabindex="-1"></a><span class="co"># Call:</span></span>
<span id="cb60-73"><a href="msm_chapter.html#cb60-73" tabindex="-1"></a><span class="co">#   glm(formula = A0_PM2.5 ~ L0_male + L0_soc_env + L1, family = binomial(),</span></span>
<span id="cb60-74"><a href="msm_chapter.html#cb60-74" tabindex="-1"></a><span class="co">#       data = getCall(x$reg.output$ereg)$data, </span></span>
<span id="cb60-75"><a href="msm_chapter.html#cb60-75" tabindex="-1"></a><span class="co">#       weights = getCall(x$reg.output$ereg)$weights)</span></span>
<span id="cb60-76"><a href="msm_chapter.html#cb60-76" tabindex="-1"></a><span class="co"># Coefficients:</span></span>
<span id="cb60-77"><a href="msm_chapter.html#cb60-77" tabindex="-1"></a><span class="co">#               Estimate Std. Error z value Pr(&gt;|z|)</span></span>
<span id="cb60-78"><a href="msm_chapter.html#cb60-78" tabindex="-1"></a><span class="co">#   (Intercept) -2.74236    0.07729 -35.484  &lt; 2e-16 ***</span></span>
<span id="cb60-79"><a href="msm_chapter.html#cb60-79" tabindex="-1"></a><span class="co">#   L0_male      0.40610    0.06448   6.298 3.01e-10 ***</span></span>
<span id="cb60-80"><a href="msm_chapter.html#cb60-80" tabindex="-1"></a><span class="co">#   L0_soc_env   0.64079    0.07350   8.718  &lt; 2e-16 ***</span></span>
<span id="cb60-81"><a href="msm_chapter.html#cb60-81" tabindex="-1"></a><span class="co">#   L1           0.03257    0.06968   0.467     0.64</span></span>
<span id="cb60-82"><a href="msm_chapter.html#cb60-82" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb60-83"><a href="msm_chapter.html#cb60-83" tabindex="-1"></a><span class="co"># # Effect decomposition on the mean difference scale via the marginal structural model</span></span>
<span id="cb60-84"><a href="msm_chapter.html#cb60-84" tabindex="-1"></a><span class="co"># Direct counterfactual imputation estimation with</span></span>
<span id="cb60-85"><a href="msm_chapter.html#cb60-85" tabindex="-1"></a><span class="co"># bootstrap standard errors, percentile confidence intervals and p-values</span></span>
<span id="cb60-86"><a href="msm_chapter.html#cb60-86" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb60-87"><a href="msm_chapter.html#cb60-87" tabindex="-1"></a><span class="co">#                  Estimate  Std.error    95% CIL 95% CIU  P.val</span></span>
<span id="cb60-88"><a href="msm_chapter.html#cb60-88" tabindex="-1"></a><span class="co">#   cde           0.0671509  0.0157808  0.0761499   0.097 &lt;2e-16 ***</span></span>
<span id="cb60-89"><a href="msm_chapter.html#cb60-89" tabindex="-1"></a><span class="co">#   pnde          0.0658727  0.0169713  0.0643983   0.087 &lt;2e-16 *** &lt;- PNDE</span></span>
<span id="cb60-90"><a href="msm_chapter.html#cb60-90" tabindex="-1"></a><span class="co">#   tnde          0.0652889  0.0172698  0.0594343   0.083 &lt;2e-16 ***</span></span>
<span id="cb60-91"><a href="msm_chapter.html#cb60-91" tabindex="-1"></a><span class="co">#   pnie          0.0087514  0.0013389  0.0070189   0.009 &lt;2e-16 ***</span></span>
<span id="cb60-92"><a href="msm_chapter.html#cb60-92" tabindex="-1"></a><span class="co">#   tnie          0.0081675  0.0010405  0.0024559   0.004 &lt;2e-16 *** &lt;- TNDE</span></span>
<span id="cb60-93"><a href="msm_chapter.html#cb60-93" tabindex="-1"></a><span class="co">#   te            0.0740402  0.0159309  0.0682520   0.090 &lt;2e-16 ***</span></span>
<span id="cb60-94"><a href="msm_chapter.html#cb60-94" tabindex="-1"></a><span class="co">#   intref       -0.0012782  0.0011906 -0.0117517  -0.010 &lt;2e-16 ***</span></span>
<span id="cb60-95"><a href="msm_chapter.html#cb60-95" tabindex="-1"></a><span class="co">#   intmed       -0.0005839  0.0002984 -0.0049640  -0.005 &lt;2e-16 ***</span></span>
<span id="cb60-96"><a href="msm_chapter.html#cb60-96" tabindex="-1"></a><span class="co">#   cde(prop)     0.9069522  0.0222813  1.0860362   1.116 &lt;2e-16 ***</span></span>
<span id="cb60-97"><a href="msm_chapter.html#cb60-97" tabindex="-1"></a><span class="co">#   intref(prop) -0.0172642  0.0439631 -0.1726807  -0.114 &lt;2e-16 ***</span></span>
<span id="cb60-98"><a href="msm_chapter.html#cb60-98" tabindex="-1"></a><span class="co">#   intmed(prop) -0.0078856  0.0162851 -0.0729153  -0.051 &lt;2e-16 ***</span></span>
<span id="cb60-99"><a href="msm_chapter.html#cb60-99" tabindex="-1"></a><span class="co">#   pnie(prop)    0.1181976  0.0379668  0.0786163   0.130 &lt;2e-16 ***</span></span>
<span id="cb60-100"><a href="msm_chapter.html#cb60-100" tabindex="-1"></a><span class="co">#   pm            0.1103120  0.0216818  0.0275800   0.057 &lt;2e-16 ***</span></span>
<span id="cb60-101"><a href="msm_chapter.html#cb60-101" tabindex="-1"></a><span class="co">#   int          -0.0251498  0.0602482 -0.2455960  -0.165 &lt;2e-16 ***</span></span>
<span id="cb60-102"><a href="msm_chapter.html#cb60-102" tabindex="-1"></a><span class="co">#   pe            0.0930478  0.0222813 -0.1159712  -0.086 &lt;2e-16 ***</span></span>
<span id="cb60-103"><a href="msm_chapter.html#cb60-103" tabindex="-1"></a><span class="co">#   ---</span></span>
<span id="cb60-104"><a href="msm_chapter.html#cb60-104" tabindex="-1"></a><span class="co">#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1</span></span>
<span id="cb60-105"><a href="msm_chapter.html#cb60-105" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb60-106"><a href="msm_chapter.html#cb60-106" tabindex="-1"></a><span class="co"># (cde: controlled direct effect;</span></span>
<span id="cb60-107"><a href="msm_chapter.html#cb60-107" tabindex="-1"></a><span class="co">#  pnde: pure natural direct effect;</span></span>
<span id="cb60-108"><a href="msm_chapter.html#cb60-108" tabindex="-1"></a><span class="co">#  tnde: total natural direct effect;</span></span>
<span id="cb60-109"><a href="msm_chapter.html#cb60-109" tabindex="-1"></a><span class="co">#  pnie: pure natural indirect effect;</span></span>
<span id="cb60-110"><a href="msm_chapter.html#cb60-110" tabindex="-1"></a><span class="co">#  tnie: total natural indirect effect;</span></span>
<span id="cb60-111"><a href="msm_chapter.html#cb60-111" tabindex="-1"></a><span class="co">#  te: total effect;</span></span>
<span id="cb60-112"><a href="msm_chapter.html#cb60-112" tabindex="-1"></a><span class="co">#  intref: reference interaction;</span></span>
<span id="cb60-113"><a href="msm_chapter.html#cb60-113" tabindex="-1"></a><span class="co">#  intmed: mediated interaction;</span></span>
<span id="cb60-114"><a href="msm_chapter.html#cb60-114" tabindex="-1"></a><span class="co">#  cde(prop): proportion cde;</span></span>
<span id="cb60-115"><a href="msm_chapter.html#cb60-115" tabindex="-1"></a><span class="co">#  intref(prop): proportion intref;</span></span>
<span id="cb60-116"><a href="msm_chapter.html#cb60-116" tabindex="-1"></a><span class="co">#  intmed(prop): proportion intmed;</span></span>
<span id="cb60-117"><a href="msm_chapter.html#cb60-117" tabindex="-1"></a><span class="co">#  pnie(prop): proportion pnie;</span></span>
<span id="cb60-118"><a href="msm_chapter.html#cb60-118" tabindex="-1"></a><span class="co">#  pm: overall proportion mediated;</span></span>
<span id="cb60-119"><a href="msm_chapter.html#cb60-119" tabindex="-1"></a><span class="co">#  int: overall proportion attributable to interaction;</span></span>
<span id="cb60-120"><a href="msm_chapter.html#cb60-120" tabindex="-1"></a><span class="co">#  pe: overall proportion eliminated)</span></span></code></pre></div>
<p>The CMAverse can also estimate the coefficients of the 2 MSM by (parametric) g-computation. For this estimation, we have to specify the following arguments <code>model = gformula</code>, and that the counterfactual outcome and mediator values are simulated (<code>estimation = "imputation"</code>). We don’t need to specify the <code>ereg</code>, <code>wmnomreg</code> and <code>wmdenomreg</code> arguments which were used to calculate weights in the previous approach.</p>
<p>Note that the estimated models of the outcome and the mediator are conditional on baseline confounders <span class="math inline">\(L(0)\)</span> and <span class="math inline">\(L(1)\)</span>.</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="msm_chapter.html#cb61-1" tabindex="-1"></a><span class="do">## Using the CMAverse to estimate MSM estimated by g-comp</span></span>
<span id="cb61-2"><a href="msm_chapter.html#cb61-2" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>) <span class="co"># note: there is randomness, even with estimation by IPTW</span></span>
<span id="cb61-3"><a href="msm_chapter.html#cb61-3" tabindex="-1"></a><span class="co">#       =&gt; counterfactuals are imputed (estimation = &quot;imputation&quot;)</span></span>
<span id="cb61-4"><a href="msm_chapter.html#cb61-4" tabindex="-1"></a>res_msm_df1.qol <span class="ot">&lt;-</span> <span class="fu">cmest</span>(<span class="at">data =</span> df1_int,</span>
<span id="cb61-5"><a href="msm_chapter.html#cb61-5" tabindex="-1"></a>                     <span class="at">model =</span> <span class="st">&quot;gformula&quot;</span>,</span>
<span id="cb61-6"><a href="msm_chapter.html#cb61-6" tabindex="-1"></a>                     <span class="at">outcome =</span> <span class="st">&quot;Y_qol&quot;</span>,</span>
<span id="cb61-7"><a href="msm_chapter.html#cb61-7" tabindex="-1"></a>                     <span class="at">exposure =</span> <span class="st">&quot;A0_PM2.5&quot;</span>,</span>
<span id="cb61-8"><a href="msm_chapter.html#cb61-8" tabindex="-1"></a>                     <span class="at">mediator =</span> <span class="st">&quot;M_diabetes&quot;</span>,</span>
<span id="cb61-9"><a href="msm_chapter.html#cb61-9" tabindex="-1"></a>                     <span class="at">basec =</span> <span class="fu">c</span>(<span class="st">&quot;L0_male&quot;</span>, <span class="st">&quot;L0_soc_env&quot;</span>,<span class="st">&quot;L1&quot;</span>),</span>
<span id="cb61-10"><a href="msm_chapter.html#cb61-10" tabindex="-1"></a>                     <span class="at">postc =</span> <span class="cn">NULL</span>,</span>
<span id="cb61-11"><a href="msm_chapter.html#cb61-11" tabindex="-1"></a>                     <span class="at">EMint =</span> <span class="cn">TRUE</span>, <span class="co"># E*M interaction</span></span>
<span id="cb61-12"><a href="msm_chapter.html#cb61-12" tabindex="-1"></a>                     <span class="co"># ereg = &quot;logistic&quot;, # # not needed with gcomp</span></span>
<span id="cb61-13"><a href="msm_chapter.html#cb61-13" tabindex="-1"></a>                     <span class="at">yreg =</span> <span class="st">&quot;linear&quot;</span>, <span class="co"># to get risk difference</span></span>
<span id="cb61-14"><a href="msm_chapter.html#cb61-14" tabindex="-1"></a>                     <span class="at">mreg =</span> <span class="fu">list</span>(<span class="st">&quot;logistic&quot;</span>), <span class="co"># mediation model g(M=1|L1,A,L0)</span></span>
<span id="cb61-15"><a href="msm_chapter.html#cb61-15" tabindex="-1"></a>                     <span class="co"># wmnomreg = list(&quot;logistic&quot;), # not needed with gcomp</span></span>
<span id="cb61-16"><a href="msm_chapter.html#cb61-16" tabindex="-1"></a>                     <span class="co"># wmdenomreg = list(&quot;logistic&quot;), ## not needed with gcomp</span></span>
<span id="cb61-17"><a href="msm_chapter.html#cb61-17" tabindex="-1"></a>                     <span class="at">astar =</span> <span class="dv">0</span>, <span class="co">#E(Y_{A=0,M=1})</span></span>
<span id="cb61-18"><a href="msm_chapter.html#cb61-18" tabindex="-1"></a>                     <span class="at">a =</span> <span class="dv">1</span>,  <span class="co">#E(Y_{A=1,M=1})</span></span>
<span id="cb61-19"><a href="msm_chapter.html#cb61-19" tabindex="-1"></a>                     <span class="at">mval =</span> <span class="fu">list</span>(<span class="dv">0</span>), <span class="co"># mediator value at which the variable is controlled</span></span>
<span id="cb61-20"><a href="msm_chapter.html#cb61-20" tabindex="-1"></a>                     <span class="at">estimation =</span> <span class="st">&quot;imputation&quot;</span>,</span>
<span id="cb61-21"><a href="msm_chapter.html#cb61-21" tabindex="-1"></a>                     <span class="at">inference =</span> <span class="st">&quot;bootstrap&quot;</span>,</span>
<span id="cb61-22"><a href="msm_chapter.html#cb61-22" tabindex="-1"></a>                     <span class="at">nboot =</span> <span class="dv">2</span>)</span>
<span id="cb61-23"><a href="msm_chapter.html#cb61-23" tabindex="-1"></a><span class="fu">summary</span>(res_msm_df1.qol)</span>
<span id="cb61-24"><a href="msm_chapter.html#cb61-24" tabindex="-1"></a><span class="co"># Causal Mediation Analysis</span></span>
<span id="cb61-25"><a href="msm_chapter.html#cb61-25" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb61-26"><a href="msm_chapter.html#cb61-26" tabindex="-1"></a><span class="co"># # Outcome regression:</span></span>
<span id="cb61-27"><a href="msm_chapter.html#cb61-27" tabindex="-1"></a><span class="co"># Call:</span></span>
<span id="cb61-28"><a href="msm_chapter.html#cb61-28" tabindex="-1"></a><span class="co">#   glm(formula = Y_qol ~ A0_PM2.5 + M_diabetes + A0_PM2.5 * M_diabetes +</span></span>
<span id="cb61-29"><a href="msm_chapter.html#cb61-29" tabindex="-1"></a><span class="co">#         L0_male + L0_soc_env + L1, family = gaussian(), data = getCall(x$reg.output$yreg)$data,</span></span>
<span id="cb61-30"><a href="msm_chapter.html#cb61-30" tabindex="-1"></a><span class="co">#       weights = getCall(x$reg.output$yreg)$weights)</span></span>
<span id="cb61-31"><a href="msm_chapter.html#cb61-31" tabindex="-1"></a><span class="co"># Coefficients:</span></span>
<span id="cb61-32"><a href="msm_chapter.html#cb61-32" tabindex="-1"></a><span class="co">#                       Estimate Std. Error t value Pr(&gt;|t|)</span></span>
<span id="cb61-33"><a href="msm_chapter.html#cb61-33" tabindex="-1"></a><span class="co">#   (Intercept)          74.7669     0.2139 349.557  &lt; 2e-16 ***</span></span>
<span id="cb61-34"><a href="msm_chapter.html#cb61-34" tabindex="-1"></a><span class="co">#   A0_PM2.5             -3.7153     0.4160  -8.931  &lt; 2e-16 ***</span></span>
<span id="cb61-35"><a href="msm_chapter.html#cb61-35" tabindex="-1"></a><span class="co">#   M_diabetes           -8.6317     0.2385 -36.197  &lt; 2e-16 ***</span></span>
<span id="cb61-36"><a href="msm_chapter.html#cb61-36" tabindex="-1"></a><span class="co">#   L0_male              -0.7235     0.2018  -3.586 0.000337 ***</span></span>
<span id="cb61-37"><a href="msm_chapter.html#cb61-37" tabindex="-1"></a><span class="co">#   L0_soc_env           -2.8899     0.2112 -13.684  &lt; 2e-16 ***</span></span>
<span id="cb61-38"><a href="msm_chapter.html#cb61-38" tabindex="-1"></a><span class="co">#   L1                   -3.4280     0.2212 -15.494  &lt; 2e-16 ***</span></span>
<span id="cb61-39"><a href="msm_chapter.html#cb61-39" tabindex="-1"></a><span class="co">#   A0_PM2.5:M_diabetes  -5.6154     0.6514  -8.621  &lt; 2e-16 ***</span></span>
<span id="cb61-40"><a href="msm_chapter.html#cb61-40" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb61-41"><a href="msm_chapter.html#cb61-41" tabindex="-1"></a><span class="co"># # Mediator regressions:</span></span>
<span id="cb61-42"><a href="msm_chapter.html#cb61-42" tabindex="-1"></a><span class="co"># Call:</span></span>
<span id="cb61-43"><a href="msm_chapter.html#cb61-43" tabindex="-1"></a><span class="co">#   glm(formula = M_diabetes ~ A0_PM2.5 + L0_male + L0_soc_env +</span></span>
<span id="cb61-44"><a href="msm_chapter.html#cb61-44" tabindex="-1"></a><span class="co">#         L1, family = binomial(), data = getCall(x$reg.output$mreg[[1L]])$data,</span></span>
<span id="cb61-45"><a href="msm_chapter.html#cb61-45" tabindex="-1"></a><span class="co">#       weights = getCall(x$reg.output$mreg[[1L]])$weights)</span></span>
<span id="cb61-46"><a href="msm_chapter.html#cb61-46" tabindex="-1"></a><span class="co"># Coefficients:</span></span>
<span id="cb61-47"><a href="msm_chapter.html#cb61-47" tabindex="-1"></a><span class="co">#               Estimate Std. Error z value Pr(&gt;|z|)</span></span>
<span id="cb61-48"><a href="msm_chapter.html#cb61-48" tabindex="-1"></a><span class="co">#   (Intercept) -1.37880    0.04872 -28.303  &lt; 2e-16 ***</span></span>
<span id="cb61-49"><a href="msm_chapter.html#cb61-49" tabindex="-1"></a><span class="co">#   A0_PM2.5     0.56260    0.06555   8.583  &lt; 2e-16 ***</span></span>
<span id="cb61-50"><a href="msm_chapter.html#cb61-50" tabindex="-1"></a><span class="co">#   L0_male      0.25861    0.04437   5.829 5.57e-09 ***</span></span>
<span id="cb61-51"><a href="msm_chapter.html#cb61-51" tabindex="-1"></a><span class="co">#   L0_soc_env   0.33050    0.04744   6.967 3.23e-12 ***</span></span>
<span id="cb61-52"><a href="msm_chapter.html#cb61-52" tabindex="-1"></a><span class="co">#   L1           0.33462    0.04744   7.054 1.74e-12 ***</span></span>
<span id="cb61-53"><a href="msm_chapter.html#cb61-53" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb61-54"><a href="msm_chapter.html#cb61-54" tabindex="-1"></a><span class="co"># # Effect decomposition on the mean difference scale via the g-formula approach</span></span>
<span id="cb61-55"><a href="msm_chapter.html#cb61-55" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb61-56"><a href="msm_chapter.html#cb61-56" tabindex="-1"></a><span class="co"># Direct counterfactual imputation estimation with</span></span>
<span id="cb61-57"><a href="msm_chapter.html#cb61-57" tabindex="-1"></a><span class="co"># bootstrap standard errors, percentile confidence intervals and p-values</span></span>
<span id="cb61-58"><a href="msm_chapter.html#cb61-58" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb61-59"><a href="msm_chapter.html#cb61-59" tabindex="-1"></a><span class="co">#                 Estimate Std.error   95% CIL 95% CIU  P.val</span></span>
<span id="cb61-60"><a href="msm_chapter.html#cb61-60" tabindex="-1"></a><span class="co">#   cde          -3.715265  0.114707 -3.084527  -2.930 &lt;2e-16 ***</span></span>
<span id="cb61-61"><a href="msm_chapter.html#cb61-61" tabindex="-1"></a><span class="co">#   pnde         -5.103390  0.008919 -4.820137  -4.808 &lt;2e-16 ***</span></span>
<span id="cb61-62"><a href="msm_chapter.html#cb61-62" tabindex="-1"></a><span class="co">#   tnde         -5.659875  0.006095 -5.579563  -5.571 &lt;2e-16 ***</span></span>
<span id="cb61-63"><a href="msm_chapter.html#cb61-63" tabindex="-1"></a><span class="co">#   pnie         -0.855400  0.040149 -1.006846  -0.953 &lt;2e-16 ***</span></span>
<span id="cb61-64"><a href="msm_chapter.html#cb61-64" tabindex="-1"></a><span class="co">#   tnie         -1.411886  0.025135 -1.758083  -1.724 &lt;2e-16 ***</span></span>
<span id="cb61-65"><a href="msm_chapter.html#cb61-65" tabindex="-1"></a><span class="co">#   te           -6.515276  0.034054 -6.578220  -6.532 &lt;2e-16 ***</span></span>
<span id="cb61-66"><a href="msm_chapter.html#cb61-66" tabindex="-1"></a><span class="co">#   intref       -1.388125  0.105788 -1.877736  -1.736 &lt;2e-16 ***</span></span>
<span id="cb61-67"><a href="msm_chapter.html#cb61-67" tabindex="-1"></a><span class="co">#   intmed       -0.556485  0.015014 -0.771408  -0.751 &lt;2e-16 ***</span></span>
<span id="cb61-68"><a href="msm_chapter.html#cb61-68" tabindex="-1"></a><span class="co">#   cde(prop)     0.570239  0.015115  0.448589   0.469 &lt;2e-16 ***</span></span>
<span id="cb61-69"><a href="msm_chapter.html#cb61-69" tabindex="-1"></a><span class="co">#   intref(prop)  0.213057  0.017570  0.263846   0.287 &lt;2e-16 ***</span></span>
<span id="cb61-70"><a href="msm_chapter.html#cb61-70" tabindex="-1"></a><span class="co">#   intmed(prop)  0.085412  0.002894  0.114201   0.118 &lt;2e-16 ***</span></span>
<span id="cb61-71"><a href="msm_chapter.html#cb61-71" tabindex="-1"></a><span class="co">#   pnie(prop)    0.131292  0.005348  0.145871   0.153 &lt;2e-16 ***</span></span>
<span id="cb61-72"><a href="msm_chapter.html#cb61-72" tabindex="-1"></a><span class="co">#   pm            0.216704  0.002454  0.263960   0.267 &lt;2e-16 ***</span></span>
<span id="cb61-73"><a href="msm_chapter.html#cb61-73" tabindex="-1"></a><span class="co">#   int           0.298469  0.020463  0.378048   0.406 &lt;2e-16 ***</span></span>
<span id="cb61-74"><a href="msm_chapter.html#cb61-74" tabindex="-1"></a><span class="co">#   pe            0.429761  0.015115  0.531104   0.551 &lt;2e-16 ***</span></span>
<span id="cb61-75"><a href="msm_chapter.html#cb61-75" tabindex="-1"></a><span class="co">#   ---</span></span>
<span id="cb61-76"><a href="msm_chapter.html#cb61-76" tabindex="-1"></a><span class="co">#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1</span></span>
<span id="cb61-77"><a href="msm_chapter.html#cb61-77" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb61-78"><a href="msm_chapter.html#cb61-78" tabindex="-1"></a><span class="co"># (cde: controlled direct effect;</span></span>
<span id="cb61-79"><a href="msm_chapter.html#cb61-79" tabindex="-1"></a><span class="co">#  pnde: pure natural direct effect;</span></span>
<span id="cb61-80"><a href="msm_chapter.html#cb61-80" tabindex="-1"></a><span class="co">#  tnde: total natural direct effect;</span></span>
<span id="cb61-81"><a href="msm_chapter.html#cb61-81" tabindex="-1"></a><span class="co">#  pnie: pure natural indirect effect;</span></span>
<span id="cb61-82"><a href="msm_chapter.html#cb61-82" tabindex="-1"></a><span class="co">#  tnie: total natural indirect effect;</span></span>
<span id="cb61-83"><a href="msm_chapter.html#cb61-83" tabindex="-1"></a><span class="co">#  te: total effect; intref:</span></span>
<span id="cb61-84"><a href="msm_chapter.html#cb61-84" tabindex="-1"></a><span class="co">#  reference interaction;</span></span>
<span id="cb61-85"><a href="msm_chapter.html#cb61-85" tabindex="-1"></a><span class="co">#  intmed: mediated interaction;</span></span>
<span id="cb61-86"><a href="msm_chapter.html#cb61-86" tabindex="-1"></a><span class="co">#  cde(prop): proportion cde;</span></span>
<span id="cb61-87"><a href="msm_chapter.html#cb61-87" tabindex="-1"></a><span class="co">#  intref(prop): proportion intref;</span></span>
<span id="cb61-88"><a href="msm_chapter.html#cb61-88" tabindex="-1"></a><span class="co">#  intmed(prop): proportion intmed;</span></span>
<span id="cb61-89"><a href="msm_chapter.html#cb61-89" tabindex="-1"></a><span class="co">#  pnie(prop): proportion pnie;</span></span>
<span id="cb61-90"><a href="msm_chapter.html#cb61-90" tabindex="-1"></a><span class="co">#  pm: overall proportion mediated;</span></span>
<span id="cb61-91"><a href="msm_chapter.html#cb61-91" tabindex="-1"></a><span class="co">#  int: overall proportion attributable to interaction;</span></span>
<span id="cb61-92"><a href="msm_chapter.html#cb61-92" tabindex="-1"></a><span class="co">#  pe: overall proportion eliminated)</span></span></code></pre></div>
</div>
</div>
<div id="msm_unified" class="section level2 hasAnchor" number="8.5">
<h2><span class="header-section-number">8.5</span> “Unified” approach for estimating Natural Direct and Indirect effects<a href="msm_chapter.html#msm_unified" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p><span class="citation">(<a href="#ref-lange2012">Lange, Vansteelandt, and Bekaert 2012</a>)</span> suggested to use a “unified” approach for estimating Natural Direct and Indirect effects (when they are identifiable), based on the following Marginal Structural Model:
<span class="math display">\[\begin{equation*}
  h\left[\mathbb{E}(Y_{a,M_{a^*}})\right] = \gamma_0 + \gamma_1 a + \gamma_2 a^* + \gamma_3 (a \times a^*) \text{ where } h \text{ is a link function}
\end{equation*}\]</span></p>
<p>So that we can express the PNDE as:
<span class="math display">\[\begin{align*}
  \text{PNDE} &amp;= \mathbb{E}(Y_{1,M_{0}}) - \mathbb{E}(Y_{0,M_{0}}) \\
  \text{PNDE} &amp;= h^{-1}\left(\gamma_0 + \gamma_1 \right) - h^{-1}\left(\gamma_0 \right) \\
  \text{PNDE} &amp;= \gamma_1 \text{ if the link function is the identity function}
\end{align*}\]</span></p>
<p>and we can express the TNIE as:
<span class="math display">\[\begin{align*}
  \text{TNIE} &amp;= \mathbb{E}(Y_{1,M_{1}}) - \mathbb{E}(Y_{1,M_{0}}) \\
  \text{TNIE} &amp;= h^{-1}\left(\gamma_0 + \gamma_1 + \gamma_2 + \gamma_3 \right) - h^{-1}\left(\gamma_0 + \gamma_1 \right) \\
  \text{TNIE} &amp;= \gamma_2 + \gamma_3 \text{ if the link function is the identity function}
\end{align*}\]</span></p>
<p>Note that this model can also be extended to study effect modifications by baseline confounders.</p>
<div id="estimation-of-the-msm-by-iptw" class="section level3 hasAnchor" number="8.5.1">
<h3><span class="header-section-number">8.5.1</span> Estimation of the MSM by IPTW<a href="msm_chapter.html#estimation-of-the-msm-by-iptw" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="manual-calculation" class="section level4 hasAnchor" number="8.5.1.1">
<h4><span class="header-section-number">8.5.1.1</span> Manual calculation<a href="msm_chapter.html#manual-calculation" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>The estimation of the “unified” MSM for Natural Direct and Indirect effects relies on the following steps:</p>
<ol style="list-style-type: decimal">
<li>Estimate suitable models for the exposure conditional on baseline confounders (<span class="math inline">\(L(0)\)</span> and <span class="math inline">\(L(1)\)</span>), using the original data set, in order to compute weights for the exposure <span class="math inline">\(A\)</span></li>
<li>Estimate a suitable model for the mediator conditional on baseline confounders (<span class="math inline">\(L(0)\)</span> and <span class="math inline">\(L(1)\)</span>), using the original data set, in order to compute weights for the mediator <span class="math inline">\(M\)</span></li>
<li>Construct a new data set by repeating the original data set twice, and including an additional variable <span class="math inline">\(A^*\)</span>, equal to the original exposure in the 1st data set, and equal to <span class="math inline">\(1-A\)</span> in the 2nd data set (for multicategorical exposures, see supplementary material of <span class="citation">(<a href="#ref-lange2012">Lange, Vansteelandt, and Bekaert 2012</a>)</span>).</li>
<li>Compute weights by applying the fitted models from steps 1 and 2
<span class="math display">\[\begin{align*}
    w_i &amp;= \frac{1}{P(A=A_i\mid L(0)=L(0)_i,L(1)=L(1)_i)} \times \frac{P(M=M_i \mid A = A^*_i,L(0)=L(0)_i,L(1)=L(1)_i)}{P(M=M_i \mid A = A_i,L(0)=L(0)_i,L(1)=L(1)_i)} \\
    \text{ or } sw_i &amp;= \frac{P(A=A_i)}{P(A=A_i\mid L(0)=L(0)_i,L(1)=L(1)_i)} \times \frac{P(M=M_i \mid A = A^*_i,L(0)=L(0)_i,L(1)=L(1)_i)}{P(M=M_i \mid A = A_i,L(0)=L(0)_i,L(1)=L(1)_i)} \\
  \end{align*}\]</span></li>
<li>Estimate the unified MSM as a weighted model of the outcome including only <span class="math inline">\(A\)</span> and <span class="math inline">\(A^*\)</span> (and their interaction), weighted by simple weights or stabilized weights. Use the estimated coefficients of the MSM to calculate the PNDE and TNIE</li>
</ol>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb62-1"><a href="msm_chapter.html#cb62-1" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list=</span><span class="fu">ls</span>())</span>
<span id="cb62-2"><a href="msm_chapter.html#cb62-2" tabindex="-1"></a>df1_int <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="st">&quot;data/df1_int.csv&quot;</span>)</span>
<span id="cb62-3"><a href="msm_chapter.html#cb62-3" tabindex="-1"></a></span>
<span id="cb62-4"><a href="msm_chapter.html#cb62-4" tabindex="-1"></a><span class="do">## Step 1. Estimate a suitable model for the exposure conditional on confounders,</span></span>
<span id="cb62-5"><a href="msm_chapter.html#cb62-5" tabindex="-1"></a><span class="do">##         using the original data set</span></span>
<span id="cb62-6"><a href="msm_chapter.html#cb62-6" tabindex="-1"></a><span class="co"># for A weight numerator</span></span>
<span id="cb62-7"><a href="msm_chapter.html#cb62-7" tabindex="-1"></a>g.A <span class="ot">&lt;-</span> <span class="fu">glm</span>(A0_PM2<span class="fl">.5</span> <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb62-8"><a href="msm_chapter.html#cb62-8" tabindex="-1"></a>           <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>, <span class="at">data =</span> df1_int)</span>
<span id="cb62-9"><a href="msm_chapter.html#cb62-9" tabindex="-1"></a></span>
<span id="cb62-10"><a href="msm_chapter.html#cb62-10" tabindex="-1"></a><span class="co"># for A weight denominator</span></span>
<span id="cb62-11"><a href="msm_chapter.html#cb62-11" tabindex="-1"></a>g.A.L0 <span class="ot">&lt;-</span> <span class="fu">glm</span>(A0_PM2<span class="fl">.5</span> <span class="sc">~</span> L0_male <span class="sc">+</span> L0_soc_env <span class="sc">+</span> L1, <span class="co"># L1 not necessary in our example</span></span>
<span id="cb62-12"><a href="msm_chapter.html#cb62-12" tabindex="-1"></a>              <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>, <span class="at">data =</span> df1_int)</span>
<span id="cb62-13"><a href="msm_chapter.html#cb62-13" tabindex="-1"></a></span>
<span id="cb62-14"><a href="msm_chapter.html#cb62-14" tabindex="-1"></a><span class="do">## Step 2. Estimate a suitable model for the mediator conditional on confounders,</span></span>
<span id="cb62-15"><a href="msm_chapter.html#cb62-15" tabindex="-1"></a><span class="do">##         using the original data set</span></span>
<span id="cb62-16"><a href="msm_chapter.html#cb62-16" tabindex="-1"></a>df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span>_temp <span class="ot">&lt;-</span> df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span></span>
<span id="cb62-17"><a href="msm_chapter.html#cb62-17" tabindex="-1"></a>g.M.AL0 <span class="ot">&lt;-</span> <span class="fu">glm</span>(M_diabetes <span class="sc">~</span> L0_male <span class="sc">+</span> L0_soc_env <span class="sc">+</span> A0_PM2<span class="fl">.5</span>_temp <span class="sc">+</span> L1,</span>
<span id="cb62-18"><a href="msm_chapter.html#cb62-18" tabindex="-1"></a>               <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>, <span class="at">data =</span> df1_int)</span>
<span id="cb62-19"><a href="msm_chapter.html#cb62-19" tabindex="-1"></a></span>
<span id="cb62-20"><a href="msm_chapter.html#cb62-20" tabindex="-1"></a><span class="do">## Step 3. Construct a new data set by repeating the original data set twice,</span></span>
<span id="cb62-21"><a href="msm_chapter.html#cb62-21" tabindex="-1"></a><span class="do">##         and including an additional variable A*, equal to the original exposure</span></span>
<span id="cb62-22"><a href="msm_chapter.html#cb62-22" tabindex="-1"></a><span class="do">##         in the 1st data set, and equal to 1-A in the 2nd data set</span></span>
<span id="cb62-23"><a href="msm_chapter.html#cb62-23" tabindex="-1"></a><span class="do">##         (note for multicategorical exposure, see supplementary material of Lange et al)</span></span>
<span id="cb62-24"><a href="msm_chapter.html#cb62-24" tabindex="-1"></a></span>
<span id="cb62-25"><a href="msm_chapter.html#cb62-25" tabindex="-1"></a><span class="co"># create identifier</span></span>
<span id="cb62-26"><a href="msm_chapter.html#cb62-26" tabindex="-1"></a>df1_int<span class="sc">$</span>id <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(df1_int)</span>
<span id="cb62-27"><a href="msm_chapter.html#cb62-27" tabindex="-1"></a></span>
<span id="cb62-28"><a href="msm_chapter.html#cb62-28" tabindex="-1"></a><span class="co"># dupplicate the original data set</span></span>
<span id="cb62-29"><a href="msm_chapter.html#cb62-29" tabindex="-1"></a>df1_int<span class="fl">.1</span> <span class="ot">&lt;-</span> df1_int<span class="fl">.2</span> <span class="ot">&lt;-</span> df1_int</span>
<span id="cb62-30"><a href="msm_chapter.html#cb62-30" tabindex="-1"></a></span>
<span id="cb62-31"><a href="msm_chapter.html#cb62-31" tabindex="-1"></a><span class="co"># Add an A* variable</span></span>
<span id="cb62-32"><a href="msm_chapter.html#cb62-32" tabindex="-1"></a>df1_int<span class="fl">.1</span><span class="sc">$</span>A0_PM2<span class="fl">.5</span>_star <span class="ot">&lt;-</span> df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="co"># A* = A in the 1st data set</span></span>
<span id="cb62-33"><a href="msm_chapter.html#cb62-33" tabindex="-1"></a>df1_int<span class="fl">.2</span><span class="sc">$</span>A0_PM2<span class="fl">.5</span>_star <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="co"># A* = 1 - A in the 2d data set</span></span>
<span id="cb62-34"><a href="msm_chapter.html#cb62-34" tabindex="-1"></a></span>
<span id="cb62-35"><a href="msm_chapter.html#cb62-35" tabindex="-1"></a><span class="co"># stack the 2 new datasets</span></span>
<span id="cb62-36"><a href="msm_chapter.html#cb62-36" tabindex="-1"></a>df1_int.new <span class="ot">&lt;-</span> <span class="fu">rbind</span>(df1_int<span class="fl">.1</span>,df1_int<span class="fl">.2</span>)</span>
<span id="cb62-37"><a href="msm_chapter.html#cb62-37" tabindex="-1"></a><span class="co"># sort the data set by the id-variable to use geeglm</span></span>
<span id="cb62-38"><a href="msm_chapter.html#cb62-38" tabindex="-1"></a><span class="co"># (necessary to use geepack and the geeglm() later)</span></span>
<span id="cb62-39"><a href="msm_chapter.html#cb62-39" tabindex="-1"></a>df1_int.new <span class="ot">&lt;-</span> df1_int.new[<span class="fu">order</span>(df1_int.new<span class="sc">$</span>id), ]</span>
<span id="cb62-40"><a href="msm_chapter.html#cb62-40" tabindex="-1"></a></span>
<span id="cb62-41"><a href="msm_chapter.html#cb62-41" tabindex="-1"></a><span class="fu">head</span>(df1_int.new, <span class="dv">12</span>)</span>
<span id="cb62-42"><a href="msm_chapter.html#cb62-42" tabindex="-1"></a><span class="co">#       L0_male L0_soc_env A0_PM2.5 L1 M_diabetes Y_death Y_qol A0_PM2.5_temp id A0_PM2.5_star</span></span>
<span id="cb62-43"><a href="msm_chapter.html#cb62-43" tabindex="-1"></a><span class="co"># 1           0          1        0  1          0       0  93.4             0  1             0</span></span>
<span id="cb62-44"><a href="msm_chapter.html#cb62-44" tabindex="-1"></a><span class="co"># 10001       0          1        0  1          0       0  93.4             0  1             1</span></span>
<span id="cb62-45"><a href="msm_chapter.html#cb62-45" tabindex="-1"></a><span class="co"># 2           1          1        1  1          0       1  64.0             1  2             1</span></span>
<span id="cb62-46"><a href="msm_chapter.html#cb62-46" tabindex="-1"></a><span class="co"># 10002       1          1        1  1          0       1  64.0             1  2             0</span></span>
<span id="cb62-47"><a href="msm_chapter.html#cb62-47" tabindex="-1"></a><span class="co"># 3           1          1        0  0          0       0  75.6             0  3             0</span></span>
<span id="cb62-48"><a href="msm_chapter.html#cb62-48" tabindex="-1"></a><span class="co"># 10003       1          1        0  0          0       0  75.6             0  3             1</span></span>
<span id="cb62-49"><a href="msm_chapter.html#cb62-49" tabindex="-1"></a><span class="co"># 4           1          0        0  0          0       0  89.8             0  4             0</span></span>
<span id="cb62-50"><a href="msm_chapter.html#cb62-50" tabindex="-1"></a><span class="co"># 10004       1          0        0  0          0       0  89.8             0  4             1</span></span>
<span id="cb62-51"><a href="msm_chapter.html#cb62-51" tabindex="-1"></a><span class="co"># 5           1          1        0  0          0       0  77.2             0  5             0</span></span>
<span id="cb62-52"><a href="msm_chapter.html#cb62-52" tabindex="-1"></a><span class="co"># 10005       1          1        0  0          0       0  77.2             0  5             1</span></span>
<span id="cb62-53"><a href="msm_chapter.html#cb62-53" tabindex="-1"></a><span class="co"># 6           1          1        0  0          1       0  73.9             0  6             0</span></span>
<span id="cb62-54"><a href="msm_chapter.html#cb62-54" tabindex="-1"></a><span class="co"># 10006       1          1        0  0          1       0  73.9             0  6             1</span></span>
<span id="cb62-55"><a href="msm_chapter.html#cb62-55" tabindex="-1"></a></span>
<span id="cb62-56"><a href="msm_chapter.html#cb62-56" tabindex="-1"></a></span>
<span id="cb62-57"><a href="msm_chapter.html#cb62-57" tabindex="-1"></a><span class="do">## Step 4. Compute weights by applying the fitted models from steps 1 and 2</span></span>
<span id="cb62-58"><a href="msm_chapter.html#cb62-58" tabindex="-1"></a><span class="co"># weights for A</span></span>
<span id="cb62-59"><a href="msm_chapter.html#cb62-59" tabindex="-1"></a>g.Ais1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(g.A, <span class="at">newdata =</span> df1_int.new, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb62-60"><a href="msm_chapter.html#cb62-60" tabindex="-1"></a>sw_A.num <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">nrow</span>(df1_int.new))</span>
<span id="cb62-61"><a href="msm_chapter.html#cb62-61" tabindex="-1"></a>sw_A.num[df1_int.new<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">1</span>] <span class="ot">&lt;-</span> g.Ais1[df1_int.new<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">1</span>]</span>
<span id="cb62-62"><a href="msm_chapter.html#cb62-62" tabindex="-1"></a>sw_A.num[df1_int.new<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">0</span>] <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> g.Ais1[df1_int.new<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">0</span>])</span>
<span id="cb62-63"><a href="msm_chapter.html#cb62-63" tabindex="-1"></a></span>
<span id="cb62-64"><a href="msm_chapter.html#cb62-64" tabindex="-1"></a>g.Ais1.L0 <span class="ot">&lt;-</span> <span class="fu">predict</span>(g.A.L0, <span class="at">newdata =</span> df1_int.new, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb62-65"><a href="msm_chapter.html#cb62-65" tabindex="-1"></a>sw_A.denom <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">nrow</span>(df1_int.new))</span>
<span id="cb62-66"><a href="msm_chapter.html#cb62-66" tabindex="-1"></a>sw_A.denom[df1_int.new<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">1</span>] <span class="ot">&lt;-</span> g.Ais1.L0[df1_int.new<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">1</span>]</span>
<span id="cb62-67"><a href="msm_chapter.html#cb62-67" tabindex="-1"></a>sw_A.denom[df1_int.new<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">0</span>] <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> g.Ais1.L0[df1_int.new<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">0</span>])</span>
<span id="cb62-68"><a href="msm_chapter.html#cb62-68" tabindex="-1"></a></span>
<span id="cb62-69"><a href="msm_chapter.html#cb62-69" tabindex="-1"></a>w_A <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> sw_A.denom</span>
<span id="cb62-70"><a href="msm_chapter.html#cb62-70" tabindex="-1"></a>sw_A <span class="ot">&lt;-</span> sw_A.num <span class="sc">/</span> sw_A.denom</span>
<span id="cb62-71"><a href="msm_chapter.html#cb62-71" tabindex="-1"></a></span>
<span id="cb62-72"><a href="msm_chapter.html#cb62-72" tabindex="-1"></a><span class="co"># weights for M|A*</span></span>
<span id="cb62-73"><a href="msm_chapter.html#cb62-73" tabindex="-1"></a>df1_int.new<span class="sc">$</span>A0_PM2<span class="fl">.5</span>_temp <span class="ot">&lt;-</span> df1_int.new<span class="sc">$</span>A0_PM2<span class="fl">.5</span>_star</span>
<span id="cb62-74"><a href="msm_chapter.html#cb62-74" tabindex="-1"></a>g.Mis1.Astar <span class="ot">&lt;-</span> <span class="fu">predict</span>(g.M.AL0, <span class="at">newdata =</span> df1_int.new, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb62-75"><a href="msm_chapter.html#cb62-75" tabindex="-1"></a>sw_M.Astar <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">nrow</span>(df1_int.new))</span>
<span id="cb62-76"><a href="msm_chapter.html#cb62-76" tabindex="-1"></a>sw_M.Astar[df1_int.new<span class="sc">$</span>M_diabetes<span class="sc">==</span><span class="dv">1</span>] <span class="ot">&lt;-</span> g.Mis1.Astar[df1_int.new<span class="sc">$</span>M_diabetes<span class="sc">==</span><span class="dv">1</span>]</span>
<span id="cb62-77"><a href="msm_chapter.html#cb62-77" tabindex="-1"></a>sw_M.Astar[df1_int.new<span class="sc">$</span>M_diabetes<span class="sc">==</span><span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> g.Mis1.Astar[df1_int.new<span class="sc">$</span>M_diabetes<span class="sc">==</span><span class="dv">0</span>]</span>
<span id="cb62-78"><a href="msm_chapter.html#cb62-78" tabindex="-1"></a></span>
<span id="cb62-79"><a href="msm_chapter.html#cb62-79" tabindex="-1"></a><span class="co"># weight for M|A</span></span>
<span id="cb62-80"><a href="msm_chapter.html#cb62-80" tabindex="-1"></a>df1_int.new<span class="sc">$</span>A0_PM2<span class="fl">.5</span>_temp <span class="ot">&lt;-</span> df1_int.new<span class="sc">$</span>A0_PM2<span class="fl">.5</span></span>
<span id="cb62-81"><a href="msm_chapter.html#cb62-81" tabindex="-1"></a>g.Mis1.A <span class="ot">&lt;-</span> <span class="fu">predict</span>(g.M.AL0, <span class="at">newdata =</span> df1_int.new, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb62-82"><a href="msm_chapter.html#cb62-82" tabindex="-1"></a>sw_M.A <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">nrow</span>(df1_int.new))</span>
<span id="cb62-83"><a href="msm_chapter.html#cb62-83" tabindex="-1"></a>sw_M.A[df1_int.new<span class="sc">$</span>M_diabetes<span class="sc">==</span><span class="dv">1</span>] <span class="ot">&lt;-</span> g.Mis1.A[df1_int.new<span class="sc">$</span>M_diabetes<span class="sc">==</span><span class="dv">1</span>]</span>
<span id="cb62-84"><a href="msm_chapter.html#cb62-84" tabindex="-1"></a>sw_M.A[df1_int.new<span class="sc">$</span>M_diabetes<span class="sc">==</span><span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> g.Mis1.A[df1_int.new<span class="sc">$</span>M_diabetes<span class="sc">==</span><span class="dv">0</span>]</span>
<span id="cb62-85"><a href="msm_chapter.html#cb62-85" tabindex="-1"></a></span>
<span id="cb62-86"><a href="msm_chapter.html#cb62-86" tabindex="-1"></a><span class="co"># non-stabilized weight</span></span>
<span id="cb62-87"><a href="msm_chapter.html#cb62-87" tabindex="-1"></a>w <span class="ot">&lt;-</span> w_A <span class="sc">*</span> (sw_M.Astar <span class="sc">/</span> sw_M.A)</span>
<span id="cb62-88"><a href="msm_chapter.html#cb62-88" tabindex="-1"></a><span class="co"># stabilized weight</span></span>
<span id="cb62-89"><a href="msm_chapter.html#cb62-89" tabindex="-1"></a>sw <span class="ot">&lt;-</span> sw_A <span class="sc">*</span> (sw_M.Astar <span class="sc">/</span> sw_M.A)</span>
<span id="cb62-90"><a href="msm_chapter.html#cb62-90" tabindex="-1"></a></span>
<span id="cb62-91"><a href="msm_chapter.html#cb62-91" tabindex="-1"></a><span class="fu">boxplot</span>(<span class="fu">data.frame</span>(w, sw))</span>
<span id="cb62-92"><a href="msm_chapter.html#cb62-92" tabindex="-1"></a></span>
<span id="cb62-93"><a href="msm_chapter.html#cb62-93" tabindex="-1"></a><span class="do">## Step 5. Fit a suitable model to the outcome including only A and A* (and their</span></span>
<span id="cb62-94"><a href="msm_chapter.html#cb62-94" tabindex="-1"></a><span class="do">##         interaction) using a weighted regression</span></span>
<span id="cb62-95"><a href="msm_chapter.html#cb62-95" tabindex="-1"></a></span>
<span id="cb62-96"><a href="msm_chapter.html#cb62-96" tabindex="-1"></a><span class="co"># we will use a GEE model in order to get &quot;robust&quot; standard errors</span></span>
<span id="cb62-97"><a href="msm_chapter.html#cb62-97" tabindex="-1"></a><span class="fu">library</span>(geepack)</span>
<span id="cb62-98"><a href="msm_chapter.html#cb62-98" tabindex="-1"></a><span class="co"># note: be careful that individuals in the &quot;df1_int.new&quot; data set</span></span>
<span id="cb62-99"><a href="msm_chapter.html#cb62-99" tabindex="-1"></a><span class="co">#       and in the &quot;w&quot; vector have the same order</span></span>
<span id="cb62-100"><a href="msm_chapter.html#cb62-100" tabindex="-1"></a></span>
<span id="cb62-101"><a href="msm_chapter.html#cb62-101" tabindex="-1"></a><span class="do">## for a risk difference in death</span></span>
<span id="cb62-102"><a href="msm_chapter.html#cb62-102" tabindex="-1"></a>MSM.model.death <span class="ot">&lt;-</span> <span class="fu">geeglm</span>(Y_death <span class="sc">~</span> A0_PM2<span class="fl">.5</span> <span class="sc">*</span> A0_PM2<span class="fl">.5</span>_star,</span>
<span id="cb62-103"><a href="msm_chapter.html#cb62-103" tabindex="-1"></a>                          <span class="at">weights =</span> sw,</span>
<span id="cb62-104"><a href="msm_chapter.html#cb62-104" tabindex="-1"></a>                          <span class="at">family =</span> <span class="st">&quot;gaussian&quot;</span>,</span>
<span id="cb62-105"><a href="msm_chapter.html#cb62-105" tabindex="-1"></a>                          <span class="at">id =</span> df1_int.new<span class="sc">$</span>id,</span>
<span id="cb62-106"><a href="msm_chapter.html#cb62-106" tabindex="-1"></a>                          <span class="at">data =</span> df1_int.new,</span>
<span id="cb62-107"><a href="msm_chapter.html#cb62-107" tabindex="-1"></a>                          <span class="at">scale.fix =</span> <span class="cn">TRUE</span>)</span>
<span id="cb62-108"><a href="msm_chapter.html#cb62-108" tabindex="-1"></a><span class="fu">summary</span>(MSM.model.death)</span>
<span id="cb62-109"><a href="msm_chapter.html#cb62-109" tabindex="-1"></a><span class="co"># Coefficients:</span></span>
<span id="cb62-110"><a href="msm_chapter.html#cb62-110" tabindex="-1"></a><span class="co">#                           Estimate   Std.err    Wald Pr(&gt;|W|)</span></span>
<span id="cb62-111"><a href="msm_chapter.html#cb62-111" tabindex="-1"></a><span class="co">#   (Intercept)             0.198840  0.004251 2187.61  &lt; 2e-16 ***</span></span>
<span id="cb62-112"><a href="msm_chapter.html#cb62-112" tabindex="-1"></a><span class="co">#   A0_PM2.5                0.065950  0.014539   20.58  5.7e-06 ***</span></span>
<span id="cb62-113"><a href="msm_chapter.html#cb62-113" tabindex="-1"></a><span class="co">#   A0_PM2.5_star           0.008534  0.001242   47.25  6.2e-12 ***</span></span>
<span id="cb62-114"><a href="msm_chapter.html#cb62-114" tabindex="-1"></a><span class="co">#   A0_PM2.5:A0_PM2.5_star -0.000406  0.003762    0.01     0.91</span></span>
<span id="cb62-115"><a href="msm_chapter.html#cb62-115" tabindex="-1"></a></span>
<span id="cb62-116"><a href="msm_chapter.html#cb62-116" tabindex="-1"></a><span class="do">## Calculate PNDE and PNIE using the MSM&#39;s coefficients</span></span>
<span id="cb62-117"><a href="msm_chapter.html#cb62-117" tabindex="-1"></a>unif.PNDE.death <span class="ot">&lt;-</span> <span class="fu">coef</span>(MSM.model.death)[<span class="st">&quot;A0_PM2.5&quot;</span>]</span>
<span id="cb62-118"><a href="msm_chapter.html#cb62-118" tabindex="-1"></a><span class="co"># 0.066</span></span>
<span id="cb62-119"><a href="msm_chapter.html#cb62-119" tabindex="-1"></a>unif.TNIE.death <span class="ot">&lt;-</span> (<span class="fu">coef</span>(MSM.model.death)[<span class="st">&quot;A0_PM2.5_star&quot;</span>] <span class="sc">+</span></span>
<span id="cb62-120"><a href="msm_chapter.html#cb62-120" tabindex="-1"></a>                      <span class="fu">coef</span>(MSM.model.death)[<span class="st">&quot;A0_PM2.5:A0_PM2.5_star&quot;</span>])</span>
<span id="cb62-121"><a href="msm_chapter.html#cb62-121" tabindex="-1"></a><span class="co"># 0.00813</span></span>
<span id="cb62-122"><a href="msm_chapter.html#cb62-122" tabindex="-1"></a></span>
<span id="cb62-123"><a href="msm_chapter.html#cb62-123" tabindex="-1"></a><span class="do">## For Quality of life</span></span>
<span id="cb62-124"><a href="msm_chapter.html#cb62-124" tabindex="-1"></a>MSM.model.qol <span class="ot">&lt;-</span> <span class="fu">geeglm</span>(Y_qol <span class="sc">~</span> A0_PM2<span class="fl">.5</span> <span class="sc">*</span> A0_PM2<span class="fl">.5</span>_star,</span>
<span id="cb62-125"><a href="msm_chapter.html#cb62-125" tabindex="-1"></a>                        <span class="at">weights =</span> sw,</span>
<span id="cb62-126"><a href="msm_chapter.html#cb62-126" tabindex="-1"></a>                        <span class="at">family =</span> <span class="st">&quot;gaussian&quot;</span>,</span>
<span id="cb62-127"><a href="msm_chapter.html#cb62-127" tabindex="-1"></a>                        <span class="at">id =</span> df1_int.new<span class="sc">$</span>id,</span>
<span id="cb62-128"><a href="msm_chapter.html#cb62-128" tabindex="-1"></a>                        <span class="at">data =</span> df1_int.new,</span>
<span id="cb62-129"><a href="msm_chapter.html#cb62-129" tabindex="-1"></a>                        <span class="at">scale.fix =</span> <span class="cn">TRUE</span>)</span>
<span id="cb62-130"><a href="msm_chapter.html#cb62-130" tabindex="-1"></a><span class="fu">summary</span>(MSM.model.qol)</span>
<span id="cb62-131"><a href="msm_chapter.html#cb62-131" tabindex="-1"></a><span class="co"># Coefficients:</span></span>
<span id="cb62-132"><a href="msm_chapter.html#cb62-132" tabindex="-1"></a><span class="co">#                          Estimate Std.err     Wald Pr(&gt;|W|)</span></span>
<span id="cb62-133"><a href="msm_chapter.html#cb62-133" tabindex="-1"></a><span class="co">#   (Intercept)             69.0853  0.1174 346240.4  &lt; 2e-16 ***</span></span>
<span id="cb62-134"><a href="msm_chapter.html#cb62-134" tabindex="-1"></a><span class="co">#   A0_PM2.5                -5.3771  0.4010    179.8  &lt; 2e-16 ***</span></span>
<span id="cb62-135"><a href="msm_chapter.html#cb62-135" tabindex="-1"></a><span class="co">#   A0_PM2.5_star           -1.0769  0.0311   1197.2  &lt; 2e-16 ***</span></span>
<span id="cb62-136"><a href="msm_chapter.html#cb62-136" tabindex="-1"></a><span class="co">#   A0_PM2.5:A0_PM2.5_star  -0.6947  0.0909     58.4  2.2e-14 ***</span></span>
<span id="cb62-137"><a href="msm_chapter.html#cb62-137" tabindex="-1"></a></span>
<span id="cb62-138"><a href="msm_chapter.html#cb62-138" tabindex="-1"></a><span class="do">## Calculate PNDE and PNIE using the MSM&#39;s coefficients</span></span>
<span id="cb62-139"><a href="msm_chapter.html#cb62-139" tabindex="-1"></a>unif.PNDE.qol <span class="ot">&lt;-</span> <span class="fu">coef</span>(MSM.model.qol)[<span class="st">&quot;A0_PM2.5&quot;</span>]</span>
<span id="cb62-140"><a href="msm_chapter.html#cb62-140" tabindex="-1"></a><span class="co"># -5.38</span></span>
<span id="cb62-141"><a href="msm_chapter.html#cb62-141" tabindex="-1"></a>unif.TNIE.qol <span class="ot">&lt;-</span> (<span class="fu">coef</span>(MSM.model.qol)[<span class="st">&quot;A0_PM2.5_star&quot;</span>] <span class="sc">+</span></span>
<span id="cb62-142"><a href="msm_chapter.html#cb62-142" tabindex="-1"></a>                    <span class="fu">coef</span>(MSM.model.qol)[<span class="st">&quot;A0_PM2.5:A0_PM2.5_star&quot;</span>])</span>
<span id="cb62-143"><a href="msm_chapter.html#cb62-143" tabindex="-1"></a><span class="co"># -1.77</span></span>
<span id="cb62-144"><a href="msm_chapter.html#cb62-144" tabindex="-1"></a></span>
<span id="cb62-145"><a href="msm_chapter.html#cb62-145" tabindex="-1"></a><span class="co"># 95% confidence intervals can also be computed by bootstrap</span></span></code></pre></div>
</div>
<div id="using-the-medflex-package" class="section level4 hasAnchor" number="8.5.1.2">
<h4><span class="header-section-number">8.5.1.2</span> Using the <code>medflex</code> package<a href="msm_chapter.html#using-the-medflex-package" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>We can used the <code>medflex</code> package to apply this approach, as described below.</p>
<p>The “unified” MSM can be defined as a model of the expected counterfactual outcome <span class="math inline">\(\mathbb{E}(Y_{a,M_{a^*}} \mid L(0),L(1))\)</span> conditional on the baseline confounders <span class="math inline">\(L(0)\)</span> and <span class="math inline">\(L(1)\)</span>, or as a model the marginal expected counterfactual outcome <span class="math inline">\(\mathbb{E}(Y_{a,M_{a^*}}\)</span>.</p>
<p>For estimation by IPTW, the data is expanded using the <code>neWeight</code> function, and the MSM is estimated using the <code>neModel</code> function.Population average estimations are obtained using a weighted regression, where the weights are calcuated using a model of the exposure, stated at the <code>xFit</code> argument inside the <code>neModel</code> function.</p>
<p>Standard errors can be computed by bootstrap or as robust “Sandwich” standard errors.</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb63-1"><a href="msm_chapter.html#cb63-1" tabindex="-1"></a><span class="fu">library</span>(medflex)</span>
<span id="cb63-2"><a href="msm_chapter.html#cb63-2" tabindex="-1"></a><span class="co"># this package can used to estimate Natural direct and indirect effects when they are</span></span>
<span id="cb63-3"><a href="msm_chapter.html#cb63-3" tabindex="-1"></a><span class="co"># identifiable</span></span>
<span id="cb63-4"><a href="msm_chapter.html#cb63-4" tabindex="-1"></a></span>
<span id="cb63-5"><a href="msm_chapter.html#cb63-5" tabindex="-1"></a><span class="do">### 5.2.1) estimate PNDE and TNDE, conditional on L0 and L1 </span></span>
<span id="cb63-6"><a href="msm_chapter.html#cb63-6" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------------- #</span></span>
<span id="cb63-7"><a href="msm_chapter.html#cb63-7" tabindex="-1"></a><span class="co"># get back to the original data set</span></span>
<span id="cb63-8"><a href="msm_chapter.html#cb63-8" tabindex="-1"></a>df1_int <span class="ot">&lt;-</span> <span class="fu">subset</span>(df1_int, <span class="at">select =</span> <span class="sc">-</span><span class="fu">c</span>(A0_PM2<span class="fl">.5</span>_temp, id))</span>
<span id="cb63-9"><a href="msm_chapter.html#cb63-9" tabindex="-1"></a></span>
<span id="cb63-10"><a href="msm_chapter.html#cb63-10" tabindex="-1"></a><span class="do">## 1) Expand the dataset and calculate weights using the neWeight() function</span></span>
<span id="cb63-11"><a href="msm_chapter.html#cb63-11" tabindex="-1"></a>g.M <span class="ot">&lt;-</span> <span class="fu">glm</span>(M_diabetes <span class="sc">~</span> <span class="fu">factor</span>(A0_PM2<span class="fl">.5</span>) <span class="sc">+</span> <span class="co"># the 1st variable should be the exposure</span></span>
<span id="cb63-12"><a href="msm_chapter.html#cb63-12" tabindex="-1"></a>             L0_male <span class="sc">+</span> L0_soc_env <span class="sc">+</span> L1, <span class="co"># then add baseline confounders</span></span>
<span id="cb63-13"><a href="msm_chapter.html#cb63-13" tabindex="-1"></a>           <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>, <span class="at">data =</span> df1_int)</span>
<span id="cb63-14"><a href="msm_chapter.html#cb63-14" tabindex="-1"></a></span>
<span id="cb63-15"><a href="msm_chapter.html#cb63-15" tabindex="-1"></a><span class="co"># expend the data set and add a second column A* = 1 - A</span></span>
<span id="cb63-16"><a href="msm_chapter.html#cb63-16" tabindex="-1"></a><span class="co"># and calculate the weights = sw_M.Astar / sw_M.A</span></span>
<span id="cb63-17"><a href="msm_chapter.html#cb63-17" tabindex="-1"></a>exp.Data <span class="ot">&lt;-</span> <span class="fu">neWeight</span>(g.M)</span>
<span id="cb63-18"><a href="msm_chapter.html#cb63-18" tabindex="-1"></a></span>
<span id="cb63-19"><a href="msm_chapter.html#cb63-19" tabindex="-1"></a><span class="co"># it is also possible to use the neWeight function directly:</span></span>
<span id="cb63-20"><a href="msm_chapter.html#cb63-20" tabindex="-1"></a><span class="co"># exp.Data &lt;- neWeight(M_diabetes ~ factor(A0_PM2.5) + # the 1st variable should be the exposure</span></span>
<span id="cb63-21"><a href="msm_chapter.html#cb63-21" tabindex="-1"></a><span class="co">#                        L0_male + L0_soc_env + L1, # then add baseline confounders</span></span>
<span id="cb63-22"><a href="msm_chapter.html#cb63-22" tabindex="-1"></a><span class="co">#                      family = &quot;binomial&quot;, data = df1_int)</span></span>
<span id="cb63-23"><a href="msm_chapter.html#cb63-23" tabindex="-1"></a></span>
<span id="cb63-24"><a href="msm_chapter.html#cb63-24" tabindex="-1"></a><span class="fu">class</span>(exp.Data)</span>
<span id="cb63-25"><a href="msm_chapter.html#cb63-25" tabindex="-1"></a><span class="co"># [1] &quot;data.frame&quot; &quot;expData&quot;    &quot;weightData&quot;</span></span>
<span id="cb63-26"><a href="msm_chapter.html#cb63-26" tabindex="-1"></a><span class="fu">head</span>(exp.Data)</span>
<span id="cb63-27"><a href="msm_chapter.html#cb63-27" tabindex="-1"></a><span class="co">#   id A0_PM2.50 A0_PM2.51 L0_male L0_soc_env L1 M_diabetes Y_death Y_qol</span></span>
<span id="cb63-28"><a href="msm_chapter.html#cb63-28" tabindex="-1"></a><span class="co"># 1  1         0         0       0          1  1          0       0  93.4</span></span>
<span id="cb63-29"><a href="msm_chapter.html#cb63-29" tabindex="-1"></a><span class="co"># 2  1         0         1       0          1  1          0       0  93.4</span></span>
<span id="cb63-30"><a href="msm_chapter.html#cb63-30" tabindex="-1"></a><span class="co"># 3  2         1         1       1          1  1          0       1  64.0</span></span>
<span id="cb63-31"><a href="msm_chapter.html#cb63-31" tabindex="-1"></a><span class="co"># 4  2         1         0       1          1  1          0       1  64.0</span></span>
<span id="cb63-32"><a href="msm_chapter.html#cb63-32" tabindex="-1"></a><span class="co"># 5  3         0         0       1          1  0          0       0  75.6</span></span>
<span id="cb63-33"><a href="msm_chapter.html#cb63-33" tabindex="-1"></a><span class="co"># 6  3         0         1       1          1  0          0       0  75.6</span></span>
<span id="cb63-34"><a href="msm_chapter.html#cb63-34" tabindex="-1"></a></span>
<span id="cb63-35"><a href="msm_chapter.html#cb63-35" tabindex="-1"></a><span class="co"># the new variables A0_PM2.50 and A0_PM2.51 correspond to A and A*</span></span>
<span id="cb63-36"><a href="msm_chapter.html#cb63-36" tabindex="-1"></a></span>
<span id="cb63-37"><a href="msm_chapter.html#cb63-37" tabindex="-1"></a><span class="co"># check the weights:</span></span>
<span id="cb63-38"><a href="msm_chapter.html#cb63-38" tabindex="-1"></a>w <span class="ot">&lt;-</span> <span class="fu">weights</span>(exp.Data)</span>
<span id="cb63-39"><a href="msm_chapter.html#cb63-39" tabindex="-1"></a><span class="fu">boxplot</span>(w)</span>
<span id="cb63-40"><a href="msm_chapter.html#cb63-40" tabindex="-1"></a></span>
<span id="cb63-41"><a href="msm_chapter.html#cb63-41" tabindex="-1"></a><span class="co"># Note that we estimated the same weights by hand previously:</span></span>
<span id="cb63-42"><a href="msm_chapter.html#cb63-42" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">data.frame</span>(w, sw_M.Astar <span class="sc">/</span> sw_M.A), <span class="dv">6</span>)</span>
<span id="cb63-43"><a href="msm_chapter.html#cb63-43" tabindex="-1"></a><span class="co">#       w sw_M.Astar.sw_M.A</span></span>
<span id="cb63-44"><a href="msm_chapter.html#cb63-44" tabindex="-1"></a><span class="co"># 1 1.000             1.000</span></span>
<span id="cb63-45"><a href="msm_chapter.html#cb63-45" tabindex="-1"></a><span class="co"># 2 0.801             0.801</span></span>
<span id="cb63-46"><a href="msm_chapter.html#cb63-46" tabindex="-1"></a><span class="co"># 3 1.000             1.000</span></span>
<span id="cb63-47"><a href="msm_chapter.html#cb63-47" tabindex="-1"></a><span class="co"># 4 1.293             1.293</span></span>
<span id="cb63-48"><a href="msm_chapter.html#cb63-48" tabindex="-1"></a><span class="co"># 5 1.000             1.000</span></span>
<span id="cb63-49"><a href="msm_chapter.html#cb63-49" tabindex="-1"></a><span class="co"># 6 0.809             0.809</span></span>
<span id="cb63-50"><a href="msm_chapter.html#cb63-50" tabindex="-1"></a><span class="fu">plot</span>(w, sw_M.Astar <span class="sc">/</span> sw_M.A)</span>
<span id="cb63-51"><a href="msm_chapter.html#cb63-51" tabindex="-1"></a><span class="fu">abline</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb63-52"><a href="msm_chapter.html#cb63-52" tabindex="-1"></a></span>
<span id="cb63-53"><a href="msm_chapter.html#cb63-53" tabindex="-1"></a><span class="do">## 2) Fit the natural effect model using the neModel() function</span></span>
<span id="cb63-54"><a href="msm_chapter.html#cb63-54" tabindex="-1"></a><span class="do">##    (adjusted for baseline confounders)</span></span>
<span id="cb63-55"><a href="msm_chapter.html#cb63-55" tabindex="-1"></a></span>
<span id="cb63-56"><a href="msm_chapter.html#cb63-56" tabindex="-1"></a><span class="do">## for death</span></span>
<span id="cb63-57"><a href="msm_chapter.html#cb63-57" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb63-58"><a href="msm_chapter.html#cb63-58" tabindex="-1"></a>neMod.death <span class="ot">&lt;-</span> <span class="fu">neModel</span>(Y_death <span class="sc">~</span> A0_PM2<span class="fl">.50</span> <span class="sc">*</span> A0_PM2<span class="fl">.51</span> <span class="sc">+</span> L0_male <span class="sc">+</span> L0_soc_env <span class="sc">+</span> L1,</span>
<span id="cb63-59"><a href="msm_chapter.html#cb63-59" tabindex="-1"></a>                       <span class="at">family =</span> <span class="st">&quot;gaussian&quot;</span>, <span class="co"># to estimate risk difference</span></span>
<span id="cb63-60"><a href="msm_chapter.html#cb63-60" tabindex="-1"></a>                       <span class="at">expData =</span> exp.Data,</span>
<span id="cb63-61"><a href="msm_chapter.html#cb63-61" tabindex="-1"></a>                       <span class="at">se =</span> <span class="fu">c</span>(<span class="st">&quot;bootstrap&quot;</span>), <span class="co"># or &quot;robust&quot;</span></span>
<span id="cb63-62"><a href="msm_chapter.html#cb63-62" tabindex="-1"></a>                       <span class="at">nBoot =</span> <span class="dv">10</span>, <span class="co"># use &gt;= 1000 samples, if se = bootstrap</span></span>
<span id="cb63-63"><a href="msm_chapter.html#cb63-63" tabindex="-1"></a>                       )</span>
<span id="cb63-64"><a href="msm_chapter.html#cb63-64" tabindex="-1"></a><span class="fu">summary</span>(neMod.death)</span>
<span id="cb63-65"><a href="msm_chapter.html#cb63-65" tabindex="-1"></a><span class="co">#                         Estimate Std. Error z value Pr(&gt;|z|)</span></span>
<span id="cb63-66"><a href="msm_chapter.html#cb63-66" tabindex="-1"></a><span class="co">#   (Intercept)            0.10982    0.00807   13.61  &lt; 2e-16 ***</span></span>
<span id="cb63-67"><a href="msm_chapter.html#cb63-67" tabindex="-1"></a><span class="co">#   A0_PM2.501             0.06576    0.01642    4.01  6.2e-05 ***</span></span>
<span id="cb63-68"><a href="msm_chapter.html#cb63-68" tabindex="-1"></a><span class="co">#   A0_PM2.511             0.00836    0.00214    3.91  9.1e-05 ***</span></span>
<span id="cb63-69"><a href="msm_chapter.html#cb63-69" tabindex="-1"></a><span class="co">#   L0_male                0.05041    0.00741    6.80  1.0e-11 ***</span></span>
<span id="cb63-70"><a href="msm_chapter.html#cb63-70" tabindex="-1"></a><span class="co">#   L0_soc_env             0.06113    0.00609   10.03  &lt; 2e-16 ***</span></span>
<span id="cb63-71"><a href="msm_chapter.html#cb63-71" tabindex="-1"></a><span class="co">#   L1                     0.08341    0.01281    6.51  7.5e-11 ***</span></span>
<span id="cb63-72"><a href="msm_chapter.html#cb63-72" tabindex="-1"></a><span class="co">#   A0_PM2.501:A0_PM2.511  0.00238    0.00446    0.53     0.59</span></span>
<span id="cb63-73"><a href="msm_chapter.html#cb63-73" tabindex="-1"></a></span>
<span id="cb63-74"><a href="msm_chapter.html#cb63-74" tabindex="-1"></a><span class="do">## estimate the conditional PNDE and TNDE, given L(0)=0 and L(1)=0</span></span>
<span id="cb63-75"><a href="msm_chapter.html#cb63-75" tabindex="-1"></a>medflex.PNDE.death.L0 <span class="ot">&lt;-</span> <span class="fu">coef</span>(neMod.death)[<span class="st">&quot;A0_PM2.501&quot;</span>]</span>
<span id="cb63-76"><a href="msm_chapter.html#cb63-76" tabindex="-1"></a><span class="co"># 0.0658</span></span>
<span id="cb63-77"><a href="msm_chapter.html#cb63-77" tabindex="-1"></a>medflex.TNIE.death.L0 <span class="ot">&lt;-</span> (<span class="fu">coef</span>(neMod.death)[<span class="st">&quot;A0_PM2.511&quot;</span>] <span class="sc">+</span></span>
<span id="cb63-78"><a href="msm_chapter.html#cb63-78" tabindex="-1"></a>                            <span class="fu">coef</span>(neMod.death)[<span class="st">&quot;A0_PM2.501:A0_PM2.511&quot;</span>])</span>
<span id="cb63-79"><a href="msm_chapter.html#cb63-79" tabindex="-1"></a><span class="co"># 0.0107</span></span>
<span id="cb63-80"><a href="msm_chapter.html#cb63-80" tabindex="-1"></a></span>
<span id="cb63-81"><a href="msm_chapter.html#cb63-81" tabindex="-1"></a><span class="co"># 95% CI of the TNIE (which combines 2 coefficients) ?</span></span>
<span id="cb63-82"><a href="msm_chapter.html#cb63-82" tabindex="-1"></a><span class="co"># cov(b1,b2) = var(b1) + var(b2) + 2 * cov(b1,b2)</span></span>
<span id="cb63-83"><a href="msm_chapter.html#cb63-83" tabindex="-1"></a><span class="fu">c</span>(medflex.TNIE.death.L0 <span class="sc">-</span></span>
<span id="cb63-84"><a href="msm_chapter.html#cb63-84" tabindex="-1"></a>    <span class="fu">qnorm</span>(<span class="fl">0.975</span>) <span class="sc">*</span> <span class="fu">sqrt</span>(<span class="fu">var</span>(neMod.death<span class="sc">$</span>bootRes<span class="sc">$</span>t[,<span class="dv">3</span>]) <span class="sc">+</span> <span class="co"># column of A0_PM2.511</span></span>
<span id="cb63-85"><a href="msm_chapter.html#cb63-85" tabindex="-1"></a>                          <span class="fu">var</span>(neMod.death<span class="sc">$</span>bootRes<span class="sc">$</span>t[,<span class="dv">7</span>]) <span class="sc">+</span> <span class="co"># column of A0_PM2.501:A0_PM2.511</span></span>
<span id="cb63-86"><a href="msm_chapter.html#cb63-86" tabindex="-1"></a>                          <span class="dv">2</span> <span class="sc">*</span> <span class="fu">var</span>(neMod.death<span class="sc">$</span>bootRes<span class="sc">$</span>t[,<span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">7</span>)])[<span class="dv">1</span>,<span class="dv">2</span>]),</span>
<span id="cb63-87"><a href="msm_chapter.html#cb63-87" tabindex="-1"></a>  medflex.TNIE.death.L0 <span class="sc">+</span></span>
<span id="cb63-88"><a href="msm_chapter.html#cb63-88" tabindex="-1"></a>    <span class="fu">qnorm</span>(<span class="fl">0.975</span>) <span class="sc">*</span> <span class="fu">sqrt</span>(<span class="fu">var</span>(neMod.death<span class="sc">$</span>bootRes<span class="sc">$</span>t[,<span class="dv">3</span>]) <span class="sc">+</span></span>
<span id="cb63-89"><a href="msm_chapter.html#cb63-89" tabindex="-1"></a>                          <span class="fu">var</span>(neMod.death<span class="sc">$</span>bootRes<span class="sc">$</span>t[,<span class="dv">7</span>]) <span class="sc">+</span></span>
<span id="cb63-90"><a href="msm_chapter.html#cb63-90" tabindex="-1"></a>                          <span class="dv">2</span> <span class="sc">*</span> <span class="fu">var</span>(neMod.death<span class="sc">$</span>bootRes<span class="sc">$</span>t[,<span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">7</span>)])[<span class="dv">1</span>,<span class="dv">2</span>]))</span>
<span id="cb63-91"><a href="msm_chapter.html#cb63-91" tabindex="-1"></a><span class="co"># A0_PM2.511 A0_PM2.511</span></span>
<span id="cb63-92"><a href="msm_chapter.html#cb63-92" tabindex="-1"></a><span class="co">#     0.0027     0.0188</span></span>
<span id="cb63-93"><a href="msm_chapter.html#cb63-93" tabindex="-1"></a></span>
<span id="cb63-94"><a href="msm_chapter.html#cb63-94" tabindex="-1"></a><span class="do">## for quality of life</span></span>
<span id="cb63-95"><a href="msm_chapter.html#cb63-95" tabindex="-1"></a>neMod.qol <span class="ot">&lt;-</span> <span class="fu">neModel</span>(Y_qol <span class="sc">~</span> A0_PM2<span class="fl">.50</span> <span class="sc">*</span> A0_PM2<span class="fl">.51</span> <span class="sc">+</span> L0_male <span class="sc">+</span> L0_soc_env <span class="sc">+</span> L1,</span>
<span id="cb63-96"><a href="msm_chapter.html#cb63-96" tabindex="-1"></a>                     <span class="at">family =</span> <span class="st">&quot;gaussian&quot;</span>, <span class="co"># to estimate risk difference</span></span>
<span id="cb63-97"><a href="msm_chapter.html#cb63-97" tabindex="-1"></a>                     <span class="at">expData =</span> exp.Data,</span>
<span id="cb63-98"><a href="msm_chapter.html#cb63-98" tabindex="-1"></a>                     <span class="at">se =</span> <span class="fu">c</span>(<span class="st">&quot;robust&quot;</span>) <span class="co"># or &quot;bootstrap&quot;</span></span>
<span id="cb63-99"><a href="msm_chapter.html#cb63-99" tabindex="-1"></a>                     <span class="co"># nBoot = 1000, # if se = bootstrap</span></span>
<span id="cb63-100"><a href="msm_chapter.html#cb63-100" tabindex="-1"></a>                     )</span>
<span id="cb63-101"><a href="msm_chapter.html#cb63-101" tabindex="-1"></a><span class="fu">summary</span>(neMod.qol)</span>
<span id="cb63-102"><a href="msm_chapter.html#cb63-102" tabindex="-1"></a><span class="co">#                         Estimate Std. Error z value Pr(&gt;|z|)</span></span>
<span id="cb63-103"><a href="msm_chapter.html#cb63-103" tabindex="-1"></a><span class="co">#   (Intercept)             73.187      0.226  324.09  &lt; 2e-16 ***</span></span>
<span id="cb63-104"><a href="msm_chapter.html#cb63-104" tabindex="-1"></a><span class="co">#   A0_PM2.501              -5.336      0.338  -15.77  &lt; 2e-16 ***</span></span>
<span id="cb63-105"><a href="msm_chapter.html#cb63-105" tabindex="-1"></a><span class="co">#   A0_PM2.511              -1.069      0.136   -7.87  3.4e-15 ***</span></span>
<span id="cb63-106"><a href="msm_chapter.html#cb63-106" tabindex="-1"></a><span class="co">#   L0_male                 -1.231      0.223   -5.53  3.3e-08 ***</span></span>
<span id="cb63-107"><a href="msm_chapter.html#cb63-107" tabindex="-1"></a><span class="co">#   L0_soc_env              -3.546      0.230  -15.41  &lt; 2e-16 ***</span></span>
<span id="cb63-108"><a href="msm_chapter.html#cb63-108" tabindex="-1"></a><span class="co">#   L1                      -4.101      0.243  -16.87  &lt; 2e-16 ***</span></span>
<span id="cb63-109"><a href="msm_chapter.html#cb63-109" tabindex="-1"></a><span class="co">#   A0_PM2.501:A0_PM2.511   -0.765      0.126   -6.09  1.1e-09 ***</span></span>
<span id="cb63-110"><a href="msm_chapter.html#cb63-110" tabindex="-1"></a></span>
<span id="cb63-111"><a href="msm_chapter.html#cb63-111" tabindex="-1"></a><span class="do">## estimate the conditional PNDE and TNDE, given L(0)=0 and L(1)=0</span></span>
<span id="cb63-112"><a href="msm_chapter.html#cb63-112" tabindex="-1"></a>medflex.PNDE.qol.L0 <span class="ot">&lt;-</span> <span class="fu">coef</span>(neMod.qol)[<span class="st">&quot;A0_PM2.501&quot;</span>]</span>
<span id="cb63-113"><a href="msm_chapter.html#cb63-113" tabindex="-1"></a><span class="co"># -5.34</span></span>
<span id="cb63-114"><a href="msm_chapter.html#cb63-114" tabindex="-1"></a>medflex.TNIE.qol.L0 <span class="ot">&lt;-</span> (<span class="fu">coef</span>(neMod.qol)[<span class="st">&quot;A0_PM2.511&quot;</span>] <span class="sc">+</span></span>
<span id="cb63-115"><a href="msm_chapter.html#cb63-115" tabindex="-1"></a>                            <span class="fu">coef</span>(neMod.qol)[<span class="st">&quot;A0_PM2.501:A0_PM2.511&quot;</span>])</span>
<span id="cb63-116"><a href="msm_chapter.html#cb63-116" tabindex="-1"></a><span class="co"># -1.83</span></span>
<span id="cb63-117"><a href="msm_chapter.html#cb63-117" tabindex="-1"></a></span>
<span id="cb63-118"><a href="msm_chapter.html#cb63-118" tabindex="-1"></a><span class="co"># 95% CI of the TNIE (which combines 2 coefficients) ?</span></span>
<span id="cb63-119"><a href="msm_chapter.html#cb63-119" tabindex="-1"></a><span class="co"># cov(b1,b2) = var(b1) + var(b2) + 2cov(b1,b2)</span></span>
<span id="cb63-120"><a href="msm_chapter.html#cb63-120" tabindex="-1"></a><span class="fu">c</span>(medflex.TNIE.qol.L0 <span class="sc">-</span></span>
<span id="cb63-121"><a href="msm_chapter.html#cb63-121" tabindex="-1"></a>    <span class="fu">qnorm</span>(<span class="fl">0.975</span>) <span class="sc">*</span> <span class="fu">sqrt</span>(neMod.qol<span class="sc">$</span>vcov[<span class="st">&quot;A0_PM2.511&quot;</span>,<span class="st">&quot;A0_PM2.511&quot;</span>] <span class="sc">+</span></span>
<span id="cb63-122"><a href="msm_chapter.html#cb63-122" tabindex="-1"></a>                          neMod.qol<span class="sc">$</span>vcov[<span class="st">&quot;A0_PM2.501:A0_PM2.511&quot;</span>,<span class="st">&quot;A0_PM2.501:A0_PM2.511&quot;</span>] <span class="sc">+</span></span>
<span id="cb63-123"><a href="msm_chapter.html#cb63-123" tabindex="-1"></a>                          <span class="dv">2</span> <span class="sc">*</span> neMod.qol<span class="sc">$</span>vcov[<span class="st">&quot;A0_PM2.511&quot;</span>,<span class="st">&quot;A0_PM2.501:A0_PM2.511&quot;</span>]),</span>
<span id="cb63-124"><a href="msm_chapter.html#cb63-124" tabindex="-1"></a>  medflex.TNIE.qol.L0 <span class="sc">+</span></span>
<span id="cb63-125"><a href="msm_chapter.html#cb63-125" tabindex="-1"></a>    <span class="fu">qnorm</span>(<span class="fl">0.975</span>) <span class="sc">*</span> <span class="fu">sqrt</span>(neMod.qol<span class="sc">$</span>vcov[<span class="st">&quot;A0_PM2.511&quot;</span>,<span class="st">&quot;A0_PM2.511&quot;</span>] <span class="sc">+</span></span>
<span id="cb63-126"><a href="msm_chapter.html#cb63-126" tabindex="-1"></a>                          neMod.qol<span class="sc">$</span>vcov[<span class="st">&quot;A0_PM2.501:A0_PM2.511&quot;</span>,<span class="st">&quot;A0_PM2.501:A0_PM2.511&quot;</span>] <span class="sc">+</span></span>
<span id="cb63-127"><a href="msm_chapter.html#cb63-127" tabindex="-1"></a>                          <span class="dv">2</span> <span class="sc">*</span> neMod.qol<span class="sc">$</span>vcov[<span class="st">&quot;A0_PM2.511&quot;</span>,<span class="st">&quot;A0_PM2.501:A0_PM2.511&quot;</span>]))</span>
<span id="cb63-128"><a href="msm_chapter.html#cb63-128" tabindex="-1"></a><span class="co"># A0_PM2.511 A0_PM2.511</span></span>
<span id="cb63-129"><a href="msm_chapter.html#cb63-129" tabindex="-1"></a><span class="co">#     -2.30      -1.37</span></span>
<span id="cb63-130"><a href="msm_chapter.html#cb63-130" tabindex="-1"></a></span>
<span id="cb63-131"><a href="msm_chapter.html#cb63-131" tabindex="-1"></a><span class="co"># plot results</span></span>
<span id="cb63-132"><a href="msm_chapter.html#cb63-132" tabindex="-1"></a><span class="fu">plot</span>(neMod.qol)</span>
<span id="cb63-133"><a href="msm_chapter.html#cb63-133" tabindex="-1"></a></span>
<span id="cb63-134"><a href="msm_chapter.html#cb63-134" tabindex="-1"></a><span class="do">### 5.2.2) estimate marginal PNDE and TNDE (population average) </span></span>
<span id="cb63-135"><a href="msm_chapter.html#cb63-135" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------------- #</span></span>
<span id="cb63-136"><a href="msm_chapter.html#cb63-136" tabindex="-1"></a></span>
<span id="cb63-137"><a href="msm_chapter.html#cb63-137" tabindex="-1"></a><span class="do">## 1) Expand the dataset and calculate weights using the neWeight() function</span></span>
<span id="cb63-138"><a href="msm_chapter.html#cb63-138" tabindex="-1"></a></span>
<span id="cb63-139"><a href="msm_chapter.html#cb63-139" tabindex="-1"></a><span class="do">## Estimate a model of the exposure</span></span>
<span id="cb63-140"><a href="msm_chapter.html#cb63-140" tabindex="-1"></a>g.A.L0 <span class="ot">&lt;-</span> <span class="fu">glm</span>(A0_PM2<span class="fl">.5</span> <span class="sc">~</span> L0_male <span class="sc">+</span> L0_soc_env <span class="sc">+</span> L1, <span class="co"># will no work without L(1) !</span></span>
<span id="cb63-141"><a href="msm_chapter.html#cb63-141" tabindex="-1"></a>              <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>, <span class="at">data =</span> df1_int)</span>
<span id="cb63-142"><a href="msm_chapter.html#cb63-142" tabindex="-1"></a></span>
<span id="cb63-143"><a href="msm_chapter.html#cb63-143" tabindex="-1"></a><span class="do">## Estimate a model of the mediator</span></span>
<span id="cb63-144"><a href="msm_chapter.html#cb63-144" tabindex="-1"></a>g.M <span class="ot">&lt;-</span> <span class="fu">glm</span>(M_diabetes <span class="sc">~</span> <span class="fu">factor</span>(A0_PM2<span class="fl">.5</span>) <span class="sc">+</span> <span class="co"># the 1st variable should be the exposure</span></span>
<span id="cb63-145"><a href="msm_chapter.html#cb63-145" tabindex="-1"></a>             L0_male <span class="sc">+</span> L0_soc_env <span class="sc">+</span> L1, <span class="co"># then add baseline confounders</span></span>
<span id="cb63-146"><a href="msm_chapter.html#cb63-146" tabindex="-1"></a>           <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>, <span class="at">data =</span> df1_int)</span>
<span id="cb63-147"><a href="msm_chapter.html#cb63-147" tabindex="-1"></a></span>
<span id="cb63-148"><a href="msm_chapter.html#cb63-148" tabindex="-1"></a><span class="co"># expend the data set and add a second column A* = 1 - A</span></span>
<span id="cb63-149"><a href="msm_chapter.html#cb63-149" tabindex="-1"></a><span class="co"># and calculate the weights = sw_M.Astar / sw_M.A</span></span>
<span id="cb63-150"><a href="msm_chapter.html#cb63-150" tabindex="-1"></a>exp.Data <span class="ot">&lt;-</span> <span class="fu">neWeight</span>(g.M)</span>
<span id="cb63-151"><a href="msm_chapter.html#cb63-151" tabindex="-1"></a></span>
<span id="cb63-152"><a href="msm_chapter.html#cb63-152" tabindex="-1"></a><span class="do">## 2) Fit the natural effect model using the neModel() function</span></span>
<span id="cb63-153"><a href="msm_chapter.html#cb63-153" tabindex="-1"></a><span class="do">## for death</span></span>
<span id="cb63-154"><a href="msm_chapter.html#cb63-154" tabindex="-1"></a>neMod.death.pop <span class="ot">&lt;-</span> <span class="fu">neModel</span>(Y_death <span class="sc">~</span> A0_PM2<span class="fl">.50</span> <span class="sc">*</span> A0_PM2<span class="fl">.51</span>, <span class="co"># no need for L(0),L(1)</span></span>
<span id="cb63-155"><a href="msm_chapter.html#cb63-155" tabindex="-1"></a>                       <span class="at">family =</span> <span class="st">&quot;gaussian&quot;</span>, <span class="co"># to estimate risk difference</span></span>
<span id="cb63-156"><a href="msm_chapter.html#cb63-156" tabindex="-1"></a>                       <span class="at">expData =</span> exp.Data,</span>
<span id="cb63-157"><a href="msm_chapter.html#cb63-157" tabindex="-1"></a>                       <span class="at">xFit =</span> g.A.L0, <span class="co"># model of the exposure</span></span>
<span id="cb63-158"><a href="msm_chapter.html#cb63-158" tabindex="-1"></a>                       <span class="at">se =</span> <span class="fu">c</span>(<span class="st">&quot;robust&quot;</span>)) <span class="co"># or &quot;bootstrap&quot;</span></span>
<span id="cb63-159"><a href="msm_chapter.html#cb63-159" tabindex="-1"></a><span class="fu">summary</span>(neMod.death.pop)</span>
<span id="cb63-160"><a href="msm_chapter.html#cb63-160" tabindex="-1"></a><span class="co"># Parameter estimates:</span></span>
<span id="cb63-161"><a href="msm_chapter.html#cb63-161" tabindex="-1"></a><span class="co">#   Estimate Std. Error z value Pr(&gt;|z|)</span></span>
<span id="cb63-162"><a href="msm_chapter.html#cb63-162" tabindex="-1"></a><span class="co">#   (Intercept)            0.198840   0.004247   46.82  &lt; 2e-16 ***</span></span>
<span id="cb63-163"><a href="msm_chapter.html#cb63-163" tabindex="-1"></a><span class="co">#   A0_PM2.501             0.065950   0.014346    4.60  4.3e-06 ***</span></span>
<span id="cb63-164"><a href="msm_chapter.html#cb63-164" tabindex="-1"></a><span class="co">#   A0_PM2.511             0.008534   0.001619    5.27  1.4e-07 ***</span></span>
<span id="cb63-165"><a href="msm_chapter.html#cb63-165" tabindex="-1"></a><span class="co">#   A0_PM2.501:A0_PM2.511 -0.000406   0.003744   -0.11     0.91</span></span>
<span id="cb63-166"><a href="msm_chapter.html#cb63-166" tabindex="-1"></a></span>
<span id="cb63-167"><a href="msm_chapter.html#cb63-167" tabindex="-1"></a><span class="do">## estimate the population average PNDE and TNDE,</span></span>
<span id="cb63-168"><a href="msm_chapter.html#cb63-168" tabindex="-1"></a>medflex.PNDE.death <span class="ot">&lt;-</span> <span class="fu">coef</span>(neMod.death.pop)[<span class="st">&quot;A0_PM2.501&quot;</span>]</span>
<span id="cb63-169"><a href="msm_chapter.html#cb63-169" tabindex="-1"></a><span class="co"># 0.066</span></span>
<span id="cb63-170"><a href="msm_chapter.html#cb63-170" tabindex="-1"></a>medflex.TNIE.death <span class="ot">&lt;-</span> (<span class="fu">coef</span>(neMod.death.pop)[<span class="st">&quot;A0_PM2.511&quot;</span>] <span class="sc">+</span></span>
<span id="cb63-171"><a href="msm_chapter.html#cb63-171" tabindex="-1"></a>                          <span class="fu">coef</span>(neMod.death.pop)[<span class="st">&quot;A0_PM2.501:A0_PM2.511&quot;</span>])</span>
<span id="cb63-172"><a href="msm_chapter.html#cb63-172" tabindex="-1"></a><span class="co"># 0.00813</span></span>
<span id="cb63-173"><a href="msm_chapter.html#cb63-173" tabindex="-1"></a><span class="co"># the results are the same than results calculated by hand</span></span>
<span id="cb63-174"><a href="msm_chapter.html#cb63-174" tabindex="-1"></a></span>
<span id="cb63-175"><a href="msm_chapter.html#cb63-175" tabindex="-1"></a><span class="do">## for quality of life</span></span>
<span id="cb63-176"><a href="msm_chapter.html#cb63-176" tabindex="-1"></a>neMod.qol.pop <span class="ot">&lt;-</span> <span class="fu">neModel</span>(Y_qol <span class="sc">~</span> A0_PM2<span class="fl">.50</span> <span class="sc">*</span> A0_PM2<span class="fl">.51</span>, <span class="co"># no need for L(0),L(1)</span></span>
<span id="cb63-177"><a href="msm_chapter.html#cb63-177" tabindex="-1"></a>                         <span class="at">family =</span> <span class="st">&quot;gaussian&quot;</span>, <span class="co"># to estimate risk difference</span></span>
<span id="cb63-178"><a href="msm_chapter.html#cb63-178" tabindex="-1"></a>                         <span class="at">expData =</span> exp.Data,</span>
<span id="cb63-179"><a href="msm_chapter.html#cb63-179" tabindex="-1"></a>                         <span class="at">xFit =</span> g.A.L0, <span class="co"># model of the exposure</span></span>
<span id="cb63-180"><a href="msm_chapter.html#cb63-180" tabindex="-1"></a>                         <span class="at">se =</span> <span class="fu">c</span>(<span class="st">&quot;robust&quot;</span>)) <span class="co"># or &quot;bootstrap&quot;</span></span>
<span id="cb63-181"><a href="msm_chapter.html#cb63-181" tabindex="-1"></a><span class="fu">summary</span>(neMod.qol.pop)</span>
<span id="cb63-182"><a href="msm_chapter.html#cb63-182" tabindex="-1"></a><span class="co"># Parameter estimates:</span></span>
<span id="cb63-183"><a href="msm_chapter.html#cb63-183" tabindex="-1"></a><span class="co">#                         Estimate Std. Error z value Pr(&gt;|z|)</span></span>
<span id="cb63-184"><a href="msm_chapter.html#cb63-184" tabindex="-1"></a><span class="co">#   (Intercept)             69.085      0.117  590.36  &lt; 2e-16 ***</span></span>
<span id="cb63-185"><a href="msm_chapter.html#cb63-185" tabindex="-1"></a><span class="co">#   A0_PM2.501              -5.377      0.350  -15.38  &lt; 2e-16 ***</span></span>
<span id="cb63-186"><a href="msm_chapter.html#cb63-186" tabindex="-1"></a><span class="co">#   A0_PM2.511              -1.077      0.137   -7.88  3.3e-15 ***</span></span>
<span id="cb63-187"><a href="msm_chapter.html#cb63-187" tabindex="-1"></a><span class="co">#   A0_PM2.501:A0_PM2.511   -0.695      0.120   -5.80  6.7e-09 ***</span></span>
<span id="cb63-188"><a href="msm_chapter.html#cb63-188" tabindex="-1"></a></span>
<span id="cb63-189"><a href="msm_chapter.html#cb63-189" tabindex="-1"></a><span class="do">## estimate the population average PNDE and TNDE,</span></span>
<span id="cb63-190"><a href="msm_chapter.html#cb63-190" tabindex="-1"></a>medflex.PNDE.qol <span class="ot">&lt;-</span> <span class="fu">coef</span>(neMod.qol.pop)[<span class="st">&quot;A0_PM2.501&quot;</span>]</span>
<span id="cb63-191"><a href="msm_chapter.html#cb63-191" tabindex="-1"></a><span class="co"># -5.38</span></span>
<span id="cb63-192"><a href="msm_chapter.html#cb63-192" tabindex="-1"></a>medflex.TNIE.qol <span class="ot">&lt;-</span> (<span class="fu">coef</span>(neMod.qol.pop)[<span class="st">&quot;A0_PM2.511&quot;</span>] <span class="sc">+</span></span>
<span id="cb63-193"><a href="msm_chapter.html#cb63-193" tabindex="-1"></a>                       <span class="fu">coef</span>(neMod.qol.pop)[<span class="st">&quot;A0_PM2.501:A0_PM2.511&quot;</span>])</span>
<span id="cb63-194"><a href="msm_chapter.html#cb63-194" tabindex="-1"></a><span class="co"># -1.77</span></span>
<span id="cb63-195"><a href="msm_chapter.html#cb63-195" tabindex="-1"></a><span class="co"># the results are the same than results calculated by hand</span></span></code></pre></div>
</div>
</div>
<div id="estimation-of-the-msm-by-g-computation" class="section level3 hasAnchor" number="8.5.2">
<h3><span class="header-section-number">8.5.2</span> Estimation of the MSM by g-computation<a href="msm_chapter.html#estimation-of-the-msm-by-g-computation" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="manual-calculation-1" class="section level4 hasAnchor" number="8.5.2.1">
<h4><span class="header-section-number">8.5.2.1</span> Manual calculation<a href="msm_chapter.html#manual-calculation-1" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>The “unified” MSM can also be estimated by g-computation. Note that for the estimation of the population average effects, calculation relies on a weighted regression, as with the IPTW approach.</p>
<p>We can apply the following steps:</p>
<ol style="list-style-type: decimal">
<li>Estimate a suitable model for the outcome conditional on the exposure, mediator and confounders, using the original data set</li>
<li>Construct a new data set by repeating the original data set twice, and including an additional variable <span class="math inline">\(A^*\)</span>, equal to the original exposure in the 1st data set, and equal to <span class="math inline">\(1-A\)</span> in the 2nd data set. Then impute counterfactuals <span class="math inline">\(\mathbb{E}(Y_{a,M_a*}|L(0),L(1))\)</span></li>
<li>Estimate the unified MSM as a model of the outcome including <span class="math inline">\(A\)</span> and <span class="math inline">\(A^*\)</span> (and their interaction), adjusted for baseline confounders <span class="math inline">\(L(0)\)</span> and <span class="math inline">\(L(1)\)</span>. In order to obtain population average model (unconditional on baseline confounders), coefficients can be estimated using a weighted regression (with simple weights or stabilized weights of the exposure). Use the estimated coefficients of the MSM to calculate the PNDE and TNIE.</li>
</ol>
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb64-1"><a href="msm_chapter.html#cb64-1" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list=</span><span class="fu">ls</span>())</span>
<span id="cb64-2"><a href="msm_chapter.html#cb64-2" tabindex="-1"></a>df1_int <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="st">&quot;data/df1_int.csv&quot;</span>)</span>
<span id="cb64-3"><a href="msm_chapter.html#cb64-3" tabindex="-1"></a></span>
<span id="cb64-4"><a href="msm_chapter.html#cb64-4" tabindex="-1"></a><span class="do">## Step 1. Estimate a suitable model for the outcome conditional on the exposure,</span></span>
<span id="cb64-5"><a href="msm_chapter.html#cb64-5" tabindex="-1"></a><span class="do">##         mediator and confounders, using the original data set</span></span>
<span id="cb64-6"><a href="msm_chapter.html#cb64-6" tabindex="-1"></a>Q.Y.death <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y_death <span class="sc">~</span> L0_male <span class="sc">+</span> L0_soc_env <span class="sc">+</span> L1  <span class="sc">+</span> A0_PM2<span class="fl">.5</span> <span class="sc">*</span> M_diabetes,</span>
<span id="cb64-7"><a href="msm_chapter.html#cb64-7" tabindex="-1"></a>                 <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>,</span>
<span id="cb64-8"><a href="msm_chapter.html#cb64-8" tabindex="-1"></a>                 <span class="at">data =</span> df1_int)</span>
<span id="cb64-9"><a href="msm_chapter.html#cb64-9" tabindex="-1"></a></span>
<span id="cb64-10"><a href="msm_chapter.html#cb64-10" tabindex="-1"></a>Q.Y.qol <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y_qol <span class="sc">~</span> L0_male <span class="sc">+</span> L0_soc_env <span class="sc">+</span> L1 <span class="sc">+</span> A0_PM2<span class="fl">.5</span> <span class="sc">*</span> M_diabetes,</span>
<span id="cb64-11"><a href="msm_chapter.html#cb64-11" tabindex="-1"></a>               <span class="at">family =</span> <span class="st">&quot;gaussian&quot;</span>,</span>
<span id="cb64-12"><a href="msm_chapter.html#cb64-12" tabindex="-1"></a>               <span class="at">data =</span> df1_int)</span>
<span id="cb64-13"><a href="msm_chapter.html#cb64-13" tabindex="-1"></a></span>
<span id="cb64-14"><a href="msm_chapter.html#cb64-14" tabindex="-1"></a><span class="do">## Step 2. Expand data and impute counterfactuals E(Y_{a,M_a*}|L(0),L(1))</span></span>
<span id="cb64-15"><a href="msm_chapter.html#cb64-15" tabindex="-1"></a><span class="do">## Expand data</span></span>
<span id="cb64-16"><a href="msm_chapter.html#cb64-16" tabindex="-1"></a><span class="co"># create identifier</span></span>
<span id="cb64-17"><a href="msm_chapter.html#cb64-17" tabindex="-1"></a>df1_int<span class="sc">$</span>id <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(df1_int)</span>
<span id="cb64-18"><a href="msm_chapter.html#cb64-18" tabindex="-1"></a></span>
<span id="cb64-19"><a href="msm_chapter.html#cb64-19" tabindex="-1"></a><span class="co"># dupplicate the original data set</span></span>
<span id="cb64-20"><a href="msm_chapter.html#cb64-20" tabindex="-1"></a>df1_int<span class="fl">.1</span> <span class="ot">&lt;-</span> df1_int<span class="fl">.2</span> <span class="ot">&lt;-</span> df1_int</span>
<span id="cb64-21"><a href="msm_chapter.html#cb64-21" tabindex="-1"></a></span>
<span id="cb64-22"><a href="msm_chapter.html#cb64-22" tabindex="-1"></a><span class="co"># Add an A* variable where A* = A</span></span>
<span id="cb64-23"><a href="msm_chapter.html#cb64-23" tabindex="-1"></a>df1_int<span class="fl">.1</span><span class="sc">$</span>A0_PM2<span class="fl">.5</span>_star <span class="ot">&lt;-</span> df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span></span>
<span id="cb64-24"><a href="msm_chapter.html#cb64-24" tabindex="-1"></a>df1_int<span class="fl">.2</span><span class="sc">$</span>A0_PM2<span class="fl">.5</span>_star <span class="ot">&lt;-</span> df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span></span>
<span id="cb64-25"><a href="msm_chapter.html#cb64-25" tabindex="-1"></a></span>
<span id="cb64-26"><a href="msm_chapter.html#cb64-26" tabindex="-1"></a><span class="co"># for the 2nd data set, change the exposure A = 1 - A</span></span>
<span id="cb64-27"><a href="msm_chapter.html#cb64-27" tabindex="-1"></a>df1_int<span class="fl">.2</span><span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span></span>
<span id="cb64-28"><a href="msm_chapter.html#cb64-28" tabindex="-1"></a></span>
<span id="cb64-29"><a href="msm_chapter.html#cb64-29" tabindex="-1"></a><span class="co"># stack the 2 new datasets</span></span>
<span id="cb64-30"><a href="msm_chapter.html#cb64-30" tabindex="-1"></a>df1_int.new <span class="ot">&lt;-</span> <span class="fu">rbind</span>(df1_int<span class="fl">.1</span>,df1_int<span class="fl">.2</span>)</span>
<span id="cb64-31"><a href="msm_chapter.html#cb64-31" tabindex="-1"></a><span class="co"># sort the data set by the id-variable to use geeglm</span></span>
<span id="cb64-32"><a href="msm_chapter.html#cb64-32" tabindex="-1"></a><span class="co"># (necessary to use geepack and the geeglm() later)</span></span>
<span id="cb64-33"><a href="msm_chapter.html#cb64-33" tabindex="-1"></a>df1_int.new <span class="ot">&lt;-</span> df1_int.new[<span class="fu">order</span>(df1_int.new<span class="sc">$</span>id), ]</span>
<span id="cb64-34"><a href="msm_chapter.html#cb64-34" tabindex="-1"></a></span>
<span id="cb64-35"><a href="msm_chapter.html#cb64-35" tabindex="-1"></a><span class="fu">head</span>(df1_int.new, <span class="dv">12</span>)</span>
<span id="cb64-36"><a href="msm_chapter.html#cb64-36" tabindex="-1"></a><span class="co">#       L0_male L0_soc_env A0_PM2.5 L1 M_diabetes Y_death Y_qol A0_PM2.5_temp id A0_PM2.5_star</span></span>
<span id="cb64-37"><a href="msm_chapter.html#cb64-37" tabindex="-1"></a><span class="co"># 1           0          1        0  1          0       0  93.4             0  1             0</span></span>
<span id="cb64-38"><a href="msm_chapter.html#cb64-38" tabindex="-1"></a><span class="co"># 10001       0          1        1  1          0       0  93.4             0  1             0</span></span>
<span id="cb64-39"><a href="msm_chapter.html#cb64-39" tabindex="-1"></a><span class="co"># 2           1          1        1  1          0       1  64.0             1  2             1</span></span>
<span id="cb64-40"><a href="msm_chapter.html#cb64-40" tabindex="-1"></a><span class="co"># 10002       1          1        0  1          0       1  64.0             1  2             1</span></span>
<span id="cb64-41"><a href="msm_chapter.html#cb64-41" tabindex="-1"></a><span class="co"># 3           1          1        0  0          0       0  75.6             0  3             0</span></span>
<span id="cb64-42"><a href="msm_chapter.html#cb64-42" tabindex="-1"></a><span class="co"># 10003       1          1        1  0          0       0  75.6             0  3             0</span></span>
<span id="cb64-43"><a href="msm_chapter.html#cb64-43" tabindex="-1"></a><span class="co"># 4           1          0        0  0          0       0  89.8             0  4             0</span></span>
<span id="cb64-44"><a href="msm_chapter.html#cb64-44" tabindex="-1"></a><span class="co"># 10004       1          0        1  0          0       0  89.8             0  4             0</span></span>
<span id="cb64-45"><a href="msm_chapter.html#cb64-45" tabindex="-1"></a><span class="co"># 5           1          1        0  0          0       0  77.2             0  5             0</span></span>
<span id="cb64-46"><a href="msm_chapter.html#cb64-46" tabindex="-1"></a><span class="co"># 10005       1          1        1  0          0       0  77.2             0  5             0</span></span>
<span id="cb64-47"><a href="msm_chapter.html#cb64-47" tabindex="-1"></a><span class="co"># 6           1          1        0  0          1       0  73.9             0  6             0</span></span>
<span id="cb64-48"><a href="msm_chapter.html#cb64-48" tabindex="-1"></a><span class="co"># 10006       1          1        1  0          1       0  73.9             0  6             0</span></span>
<span id="cb64-49"><a href="msm_chapter.html#cb64-49" tabindex="-1"></a></span>
<span id="cb64-50"><a href="msm_chapter.html#cb64-50" tabindex="-1"></a><span class="do">## Impute counterfactuals</span></span>
<span id="cb64-51"><a href="msm_chapter.html#cb64-51" tabindex="-1"></a><span class="co"># death - we predict the probability P(Y=1|A,M,L(0),L(1))</span></span>
<span id="cb64-52"><a href="msm_chapter.html#cb64-52" tabindex="-1"></a>Y.pred.death <span class="ot">&lt;-</span> <span class="fu">predict</span>(Q.Y.death, <span class="at">newdata =</span> df1_int.new, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb64-53"><a href="msm_chapter.html#cb64-53" tabindex="-1"></a></span>
<span id="cb64-54"><a href="msm_chapter.html#cb64-54" tabindex="-1"></a><span class="co"># qol - we can predict the mean E(Y|A,M,L(0),L(1))</span></span>
<span id="cb64-55"><a href="msm_chapter.html#cb64-55" tabindex="-1"></a>Y.pred.qol <span class="ot">&lt;-</span> <span class="fu">predict</span>(Q.Y.qol, <span class="at">newdata =</span> df1_int.new, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb64-56"><a href="msm_chapter.html#cb64-56" tabindex="-1"></a></span>
<span id="cb64-57"><a href="msm_chapter.html#cb64-57" tabindex="-1"></a><span class="do">## Step 3. Fit a suitable model to the outcome incluing only A and A* (and their</span></span>
<span id="cb64-58"><a href="msm_chapter.html#cb64-58" tabindex="-1"></a><span class="do">##         interaction)</span></span>
<span id="cb64-59"><a href="msm_chapter.html#cb64-59" tabindex="-1"></a><span class="fu">library</span>(geepack)</span>
<span id="cb64-60"><a href="msm_chapter.html#cb64-60" tabindex="-1"></a><span class="co"># for death (conditional)</span></span>
<span id="cb64-61"><a href="msm_chapter.html#cb64-61" tabindex="-1"></a>MSM.model.death<span class="fl">.1</span> <span class="ot">&lt;-</span> <span class="fu">geeglm</span>(Y.pred.death <span class="sc">~</span> A0_PM2<span class="fl">.5</span> <span class="sc">*</span> A0_PM2<span class="fl">.5</span>_star <span class="sc">+</span></span>
<span id="cb64-62"><a href="msm_chapter.html#cb64-62" tabindex="-1"></a>                              L0_male <span class="sc">+</span> L0_soc_env <span class="sc">+</span> L1,</span>
<span id="cb64-63"><a href="msm_chapter.html#cb64-63" tabindex="-1"></a>                            <span class="at">family =</span> <span class="st">&quot;gaussian&quot;</span>,</span>
<span id="cb64-64"><a href="msm_chapter.html#cb64-64" tabindex="-1"></a>                            <span class="at">id =</span> df1_int.new<span class="sc">$</span>id,</span>
<span id="cb64-65"><a href="msm_chapter.html#cb64-65" tabindex="-1"></a>                            <span class="at">data =</span> df1_int.new,</span>
<span id="cb64-66"><a href="msm_chapter.html#cb64-66" tabindex="-1"></a>                            <span class="at">scale.fix =</span> <span class="cn">TRUE</span>)</span>
<span id="cb64-67"><a href="msm_chapter.html#cb64-67" tabindex="-1"></a><span class="fu">summary</span>(MSM.model.death<span class="fl">.1</span>)</span>
<span id="cb64-68"><a href="msm_chapter.html#cb64-68" tabindex="-1"></a><span class="co">#                          Estimate  Std.err   Wald Pr(&gt;|W|)</span></span>
<span id="cb64-69"><a href="msm_chapter.html#cb64-69" tabindex="-1"></a><span class="co">#   (Intercept)            0.104153 0.000611  29104  &lt; 2e-16 ***</span></span>
<span id="cb64-70"><a href="msm_chapter.html#cb64-70" tabindex="-1"></a><span class="co">#   A0_PM2.5               0.063543 0.000138 210638  &lt; 2e-16 ***</span></span>
<span id="cb64-71"><a href="msm_chapter.html#cb64-71" tabindex="-1"></a><span class="co">#   A0_PM2.5_star          0.007032 0.001112     40  2.5e-10 ***</span></span>
<span id="cb64-72"><a href="msm_chapter.html#cb64-72" tabindex="-1"></a><span class="co">#   L0_male                0.054291 0.000706   5922  &lt; 2e-16 ***</span></span>
<span id="cb64-73"><a href="msm_chapter.html#cb64-73" tabindex="-1"></a><span class="co">#   L0_soc_env             0.065692 0.000692   9004  &lt; 2e-16 ***</span></span>
<span id="cb64-74"><a href="msm_chapter.html#cb64-74" tabindex="-1"></a><span class="co">#   L1                     0.086446 0.000860  10100  &lt; 2e-16 ***</span></span>
<span id="cb64-75"><a href="msm_chapter.html#cb64-75" tabindex="-1"></a><span class="co">#   A0_PM2.5:A0_PM2.5_star 0.004918 0.000397    154  &lt; 2e-16 ***</span></span>
<span id="cb64-76"><a href="msm_chapter.html#cb64-76" tabindex="-1"></a></span>
<span id="cb64-77"><a href="msm_chapter.html#cb64-77" tabindex="-1"></a><span class="do">## estimate the conditional PNDE and TNDE, given L(0)=0 and L(1)=0</span></span>
<span id="cb64-78"><a href="msm_chapter.html#cb64-78" tabindex="-1"></a>PNDE.death.L0 <span class="ot">&lt;-</span> <span class="fu">coef</span>(MSM.model.death<span class="fl">.1</span>)[<span class="st">&quot;A0_PM2.5&quot;</span>]</span>
<span id="cb64-79"><a href="msm_chapter.html#cb64-79" tabindex="-1"></a><span class="co"># 0.0635</span></span>
<span id="cb64-80"><a href="msm_chapter.html#cb64-80" tabindex="-1"></a>TNIE.death.L0 <span class="ot">&lt;-</span> (<span class="fu">coef</span>(MSM.model.death<span class="fl">.1</span>)[<span class="st">&quot;A0_PM2.5_star&quot;</span>] <span class="sc">+</span></span>
<span id="cb64-81"><a href="msm_chapter.html#cb64-81" tabindex="-1"></a>                            <span class="fu">coef</span>(MSM.model.death<span class="fl">.1</span>)[<span class="st">&quot;A0_PM2.5:A0_PM2.5_star&quot;</span>])</span>
<span id="cb64-82"><a href="msm_chapter.html#cb64-82" tabindex="-1"></a><span class="co"># 0.012</span></span>
<span id="cb64-83"><a href="msm_chapter.html#cb64-83" tabindex="-1"></a></span>
<span id="cb64-84"><a href="msm_chapter.html#cb64-84" tabindex="-1"></a><span class="co"># For quality of life (conditional)</span></span>
<span id="cb64-85"><a href="msm_chapter.html#cb64-85" tabindex="-1"></a>MSM.model.qol<span class="fl">.1</span> <span class="ot">&lt;-</span> <span class="fu">geeglm</span>(Y.pred.qol <span class="sc">~</span> A0_PM2<span class="fl">.5</span> <span class="sc">*</span> A0_PM2<span class="fl">.5</span>_star <span class="sc">+</span></span>
<span id="cb64-86"><a href="msm_chapter.html#cb64-86" tabindex="-1"></a>                              L0_male <span class="sc">+</span> L0_soc_env <span class="sc">+</span> L1,</span>
<span id="cb64-87"><a href="msm_chapter.html#cb64-87" tabindex="-1"></a>                            <span class="at">family =</span> <span class="st">&quot;gaussian&quot;</span>,</span>
<span id="cb64-88"><a href="msm_chapter.html#cb64-88" tabindex="-1"></a>                            <span class="at">id =</span> df1_int.new<span class="sc">$</span>id,</span>
<span id="cb64-89"><a href="msm_chapter.html#cb64-89" tabindex="-1"></a>                            <span class="at">data =</span> df1_int.new,</span>
<span id="cb64-90"><a href="msm_chapter.html#cb64-90" tabindex="-1"></a>                            <span class="at">scale.fix =</span> <span class="cn">TRUE</span>)</span>
<span id="cb64-91"><a href="msm_chapter.html#cb64-91" tabindex="-1"></a><span class="fu">summary</span>(MSM.model.qol<span class="fl">.1</span>)</span>
<span id="cb64-92"><a href="msm_chapter.html#cb64-92" tabindex="-1"></a><span class="co">#                          Estimate Std.err     Wald Pr(&gt;|W|)</span></span>
<span id="cb64-93"><a href="msm_chapter.html#cb64-93" tabindex="-1"></a><span class="co">#   (Intercept)             73.3371  0.0949 597466.3  &lt; 2e-16 ***</span></span>
<span id="cb64-94"><a href="msm_chapter.html#cb64-94" tabindex="-1"></a><span class="co">#   A0_PM2.5                -5.3013  0.0268  39033.2  &lt; 2e-16 ***</span></span>
<span id="cb64-95"><a href="msm_chapter.html#cb64-95" tabindex="-1"></a><span class="co">#   A0_PM2.5_star           -1.0535  0.1353     60.6  6.9e-15 ***</span></span>
<span id="cb64-96"><a href="msm_chapter.html#cb64-96" tabindex="-1"></a><span class="co">#   L0_male                 -1.3289  0.1038    164.0  &lt; 2e-16 ***</span></span>
<span id="cb64-97"><a href="msm_chapter.html#cb64-97" tabindex="-1"></a><span class="co">#   L0_soc_env              -3.6467  0.1061   1180.6  &lt; 2e-16 ***</span></span>
<span id="cb64-98"><a href="msm_chapter.html#cb64-98" tabindex="-1"></a><span class="co">#   L1                      -4.2325  0.1168   1312.8  &lt; 2e-16 ***</span></span>
<span id="cb64-99"><a href="msm_chapter.html#cb64-99" tabindex="-1"></a><span class="co">#   A0_PM2.5:A0_PM2.5_star  -0.7920  0.0870     82.9  &lt; 2e-16 ***</span></span>
<span id="cb64-100"><a href="msm_chapter.html#cb64-100" tabindex="-1"></a></span>
<span id="cb64-101"><a href="msm_chapter.html#cb64-101" tabindex="-1"></a><span class="do">## estimate the conditional PNDE and TNDE, given L(0)=0 and L(1)=0</span></span>
<span id="cb64-102"><a href="msm_chapter.html#cb64-102" tabindex="-1"></a>PNDE.qol.L0 <span class="ot">&lt;-</span> <span class="fu">coef</span>(MSM.model.qol<span class="fl">.1</span>)[<span class="st">&quot;A0_PM2.5&quot;</span>]</span>
<span id="cb64-103"><a href="msm_chapter.html#cb64-103" tabindex="-1"></a><span class="co"># -5.3</span></span>
<span id="cb64-104"><a href="msm_chapter.html#cb64-104" tabindex="-1"></a>TNIE.qol.L0 <span class="ot">&lt;-</span> (<span class="fu">coef</span>(MSM.model.qol<span class="fl">.1</span>)[<span class="st">&quot;A0_PM2.5_star&quot;</span>] <span class="sc">+</span></span>
<span id="cb64-105"><a href="msm_chapter.html#cb64-105" tabindex="-1"></a>                  <span class="fu">coef</span>(MSM.model.qol<span class="fl">.1</span>)[<span class="st">&quot;A0_PM2.5:A0_PM2.5_star&quot;</span>])</span>
<span id="cb64-106"><a href="msm_chapter.html#cb64-106" tabindex="-1"></a><span class="co"># -1.85</span></span>
<span id="cb64-107"><a href="msm_chapter.html#cb64-107" tabindex="-1"></a></span>
<span id="cb64-108"><a href="msm_chapter.html#cb64-108" tabindex="-1"></a><span class="do">## For population average estimations</span></span>
<span id="cb64-109"><a href="msm_chapter.html#cb64-109" tabindex="-1"></a><span class="do">## Estimate a model of the exposure</span></span>
<span id="cb64-110"><a href="msm_chapter.html#cb64-110" tabindex="-1"></a>g.A.L0 <span class="ot">&lt;-</span> <span class="fu">glm</span>(A0_PM2<span class="fl">.5</span> <span class="sc">~</span> L0_male <span class="sc">+</span> L0_soc_env <span class="sc">+</span> L1, <span class="co"># will no work without L(1) !</span></span>
<span id="cb64-111"><a href="msm_chapter.html#cb64-111" tabindex="-1"></a>              <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>, <span class="at">data =</span> df1_int)</span>
<span id="cb64-112"><a href="msm_chapter.html#cb64-112" tabindex="-1"></a>g.Ais1.L0 <span class="ot">&lt;-</span> <span class="fu">predict</span>(g.A.L0, <span class="at">newdata =</span> df1_int.new, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb64-113"><a href="msm_chapter.html#cb64-113" tabindex="-1"></a></span>
<span id="cb64-114"><a href="msm_chapter.html#cb64-114" tabindex="-1"></a>w <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">nrow</span>(df1_int.new))</span>
<span id="cb64-115"><a href="msm_chapter.html#cb64-115" tabindex="-1"></a>w[df1_int.new<span class="sc">$</span>A0_PM2<span class="fl">.5</span>_star <span class="sc">==</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> g.Ais1.L0[df1_int.new<span class="sc">$</span>A0_PM2<span class="fl">.5</span>_star <span class="sc">==</span> <span class="dv">1</span>]</span>
<span id="cb64-116"><a href="msm_chapter.html#cb64-116" tabindex="-1"></a>w[df1_int.new<span class="sc">$</span>A0_PM2<span class="fl">.5</span>_star <span class="sc">==</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> g.Ais1.L0[df1_int.new<span class="sc">$</span>A0_PM2<span class="fl">.5</span>_star <span class="sc">==</span> <span class="dv">0</span>])</span>
<span id="cb64-117"><a href="msm_chapter.html#cb64-117" tabindex="-1"></a></span>
<span id="cb64-118"><a href="msm_chapter.html#cb64-118" tabindex="-1"></a><span class="co"># for death (population average), we use the weighted regression</span></span>
<span id="cb64-119"><a href="msm_chapter.html#cb64-119" tabindex="-1"></a>MSM.model.death<span class="fl">.2</span> <span class="ot">&lt;-</span> <span class="fu">geeglm</span>(Y.pred.death <span class="sc">~</span> A0_PM2<span class="fl">.5</span> <span class="sc">*</span> A0_PM2<span class="fl">.5</span>_star,</span>
<span id="cb64-120"><a href="msm_chapter.html#cb64-120" tabindex="-1"></a>                            <span class="at">family =</span> <span class="st">&quot;gaussian&quot;</span>,</span>
<span id="cb64-121"><a href="msm_chapter.html#cb64-121" tabindex="-1"></a>                            <span class="at">weights =</span> w,</span>
<span id="cb64-122"><a href="msm_chapter.html#cb64-122" tabindex="-1"></a>                            <span class="at">id =</span> df1_int.new<span class="sc">$</span>id,</span>
<span id="cb64-123"><a href="msm_chapter.html#cb64-123" tabindex="-1"></a>                            <span class="at">data =</span> df1_int.new,</span>
<span id="cb64-124"><a href="msm_chapter.html#cb64-124" tabindex="-1"></a>                            <span class="at">scale.fix =</span> <span class="cn">TRUE</span>)</span>
<span id="cb64-125"><a href="msm_chapter.html#cb64-125" tabindex="-1"></a><span class="fu">summary</span>(MSM.model.death<span class="fl">.2</span>)</span>
<span id="cb64-126"><a href="msm_chapter.html#cb64-126" tabindex="-1"></a><span class="co">#                          Estimate  Std.err    Wald Pr(&gt;|W|)</span></span>
<span id="cb64-127"><a href="msm_chapter.html#cb64-127" tabindex="-1"></a><span class="co">#   (Intercept)            0.198882 0.000644  95250.3  &lt; 2e-16 ***</span></span>
<span id="cb64-128"><a href="msm_chapter.html#cb64-128" tabindex="-1"></a><span class="co">#   A0_PM2.5               0.063867 0.000138 213552.3  &lt; 2e-16 ***</span></span>
<span id="cb64-129"><a href="msm_chapter.html#cb64-129" tabindex="-1"></a><span class="co">#   A0_PM2.5_star          0.009213 0.002009     21.0  4.5e-06 ***</span></span>
<span id="cb64-130"><a href="msm_chapter.html#cb64-130" tabindex="-1"></a><span class="co">#   A0_PM2.5:A0_PM2.5_star 0.002330 0.000445     27.4  1.7e-07 ***</span></span>
<span id="cb64-131"><a href="msm_chapter.html#cb64-131" tabindex="-1"></a></span>
<span id="cb64-132"><a href="msm_chapter.html#cb64-132" tabindex="-1"></a><span class="do">## estimate the conditional PNDE and TNDE, given L(0)=0 and L(1)=0</span></span>
<span id="cb64-133"><a href="msm_chapter.html#cb64-133" tabindex="-1"></a>PNDE.death <span class="ot">&lt;-</span> <span class="fu">coef</span>(MSM.model.death<span class="fl">.2</span>)[<span class="st">&quot;A0_PM2.5&quot;</span>]</span>
<span id="cb64-134"><a href="msm_chapter.html#cb64-134" tabindex="-1"></a><span class="co"># 0.0639</span></span>
<span id="cb64-135"><a href="msm_chapter.html#cb64-135" tabindex="-1"></a>TNIE.death <span class="ot">&lt;-</span> (<span class="fu">coef</span>(MSM.model.death<span class="fl">.2</span>)[<span class="st">&quot;A0_PM2.5_star&quot;</span>] <span class="sc">+</span></span>
<span id="cb64-136"><a href="msm_chapter.html#cb64-136" tabindex="-1"></a>                 <span class="fu">coef</span>(MSM.model.death<span class="fl">.2</span>)[<span class="st">&quot;A0_PM2.5:A0_PM2.5_star&quot;</span>])</span>
<span id="cb64-137"><a href="msm_chapter.html#cb64-137" tabindex="-1"></a><span class="co"># 0.0115</span></span>
<span id="cb64-138"><a href="msm_chapter.html#cb64-138" tabindex="-1"></a></span>
<span id="cb64-139"><a href="msm_chapter.html#cb64-139" tabindex="-1"></a><span class="co"># For quality of life (population average), we use the weighted regression</span></span>
<span id="cb64-140"><a href="msm_chapter.html#cb64-140" tabindex="-1"></a>MSM.model.qol<span class="fl">.2</span> <span class="ot">&lt;-</span> <span class="fu">geeglm</span>(Y.pred.qol <span class="sc">~</span> A0_PM2<span class="fl">.5</span> <span class="sc">*</span> A0_PM2<span class="fl">.5</span>_star,</span>
<span id="cb64-141"><a href="msm_chapter.html#cb64-141" tabindex="-1"></a>                          <span class="at">family =</span> <span class="st">&quot;gaussian&quot;</span>,</span>
<span id="cb64-142"><a href="msm_chapter.html#cb64-142" tabindex="-1"></a>                          <span class="at">weights =</span> w,</span>
<span id="cb64-143"><a href="msm_chapter.html#cb64-143" tabindex="-1"></a>                          <span class="at">id =</span> df1_int.new<span class="sc">$</span>id,</span>
<span id="cb64-144"><a href="msm_chapter.html#cb64-144" tabindex="-1"></a>                          <span class="at">data =</span> df1_int.new,</span>
<span id="cb64-145"><a href="msm_chapter.html#cb64-145" tabindex="-1"></a>                          <span class="at">scale.fix =</span> <span class="cn">TRUE</span>)</span>
<span id="cb64-146"><a href="msm_chapter.html#cb64-146" tabindex="-1"></a><span class="fu">summary</span>(MSM.model.qol<span class="fl">.2</span>)</span>
<span id="cb64-147"><a href="msm_chapter.html#cb64-147" tabindex="-1"></a><span class="co">#                          Estimate Std.err     Wald Pr(&gt;|W|)</span></span>
<span id="cb64-148"><a href="msm_chapter.html#cb64-148" tabindex="-1"></a><span class="co">#   (Intercept)             69.0849  0.0492 1.97e+06  &lt; 2e-16 ***</span></span>
<span id="cb64-149"><a href="msm_chapter.html#cb64-149" tabindex="-1"></a><span class="co">#   A0_PM2.5                -5.3108  0.0269 3.88e+04  &lt; 2e-16 ***</span></span>
<span id="cb64-150"><a href="msm_chapter.html#cb64-150" tabindex="-1"></a><span class="co">#   A0_PM2.5_star           -1.1690  0.1624 5.18e+01  6.1e-13 ***</span></span>
<span id="cb64-151"><a href="msm_chapter.html#cb64-151" tabindex="-1"></a><span class="co">#   A0_PM2.5:A0_PM2.5_star  -0.7395  0.0906 6.66e+01  3.3e-16 ***</span></span>
<span id="cb64-152"><a href="msm_chapter.html#cb64-152" tabindex="-1"></a></span>
<span id="cb64-153"><a href="msm_chapter.html#cb64-153" tabindex="-1"></a><span class="do">## estimate the conditional PNDE and TNDE, given L(0)=0 and L(1)=0</span></span>
<span id="cb64-154"><a href="msm_chapter.html#cb64-154" tabindex="-1"></a>PNDE.qol.L0 <span class="ot">&lt;-</span> <span class="fu">coef</span>(MSM.model.qol<span class="fl">.2</span>)[<span class="st">&quot;A0_PM2.5&quot;</span>]</span>
<span id="cb64-155"><a href="msm_chapter.html#cb64-155" tabindex="-1"></a><span class="co"># -5.31</span></span>
<span id="cb64-156"><a href="msm_chapter.html#cb64-156" tabindex="-1"></a>TNIE.qol.L0 <span class="ot">&lt;-</span> (<span class="fu">coef</span>(MSM.model.qol<span class="fl">.2</span>)[<span class="st">&quot;A0_PM2.5_star&quot;</span>] <span class="sc">+</span></span>
<span id="cb64-157"><a href="msm_chapter.html#cb64-157" tabindex="-1"></a>                  <span class="fu">coef</span>(MSM.model.qol<span class="fl">.2</span>)[<span class="st">&quot;A0_PM2.5:A0_PM2.5_star&quot;</span>])</span>
<span id="cb64-158"><a href="msm_chapter.html#cb64-158" tabindex="-1"></a><span class="co"># -1.91</span></span></code></pre></div>
</div>
<div id="using-the-medflex-package-1" class="section level4 hasAnchor" number="8.5.2.2">
<h4><span class="header-section-number">8.5.2.2</span> Using the <code>medflex</code> package<a href="msm_chapter.html#using-the-medflex-package-1" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>We can used the <code>medflex</code> package to apply this approach, as described below.</p>
<p>The “unified” MSM can be defined as a model of the expected counterfactual outcome <span class="math inline">\(\mathbb{E}(Y_{a,M_{a^*}} \mid L(0),L(1))\)</span> conditional on the baseline confounders <span class="math inline">\(L(0)\)</span> and <span class="math inline">\(L(1)\)</span>, or as a model the marginal expected counterfactual outcome <span class="math inline">\(\mathbb{E}(Y_{a,M_{a^*}}\)</span>.</p>
<p>For estimation by g-computation, the data is expanded using the <code>neImpute</code> function, and the MSM is estimated using the <code>neModel</code> function. Population average estimations are obtained using a weighted regression, where the weights are calcuated using a model of the exposure, stated at the <code>xFit</code> argument inside the <code>neModel</code> function.</p>
<p>Standard errors can be computed by bootstrap or as robust “Sandwich” standard errors.</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="msm_chapter.html#cb65-1" tabindex="-1"></a><span class="fu">library</span>(medflex)</span>
<span id="cb65-2"><a href="msm_chapter.html#cb65-2" tabindex="-1"></a></span>
<span id="cb65-3"><a href="msm_chapter.html#cb65-3" tabindex="-1"></a><span class="do">### 6.2.1) estimate PNDE and TNDE, conditional on L0 and L1</span></span>
<span id="cb65-4"><a href="msm_chapter.html#cb65-4" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------------- #</span></span>
<span id="cb65-5"><a href="msm_chapter.html#cb65-5" tabindex="-1"></a><span class="co"># get back to the original data set</span></span>
<span id="cb65-6"><a href="msm_chapter.html#cb65-6" tabindex="-1"></a>df1_int <span class="ot">&lt;-</span> <span class="fu">subset</span>(df1_int, <span class="at">select =</span> <span class="sc">-</span><span class="fu">c</span>(id))</span>
<span id="cb65-7"><a href="msm_chapter.html#cb65-7" tabindex="-1"></a>df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="ot">&lt;-</span> <span class="fu">factor</span>(df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span>)</span>
<span id="cb65-8"><a href="msm_chapter.html#cb65-8" tabindex="-1"></a></span>
<span id="cb65-9"><a href="msm_chapter.html#cb65-9" tabindex="-1"></a><span class="do">## 1) Fit a model for the outcome</span></span>
<span id="cb65-10"><a href="msm_chapter.html#cb65-10" tabindex="-1"></a>Q.Y.death <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y_death <span class="sc">~</span> A0_PM2<span class="fl">.5</span> <span class="sc">+</span> <span class="co"># start with the exposure</span></span>
<span id="cb65-11"><a href="msm_chapter.html#cb65-11" tabindex="-1"></a>                   M_diabetes <span class="sc">+</span> A0_PM2<span class="fl">.5</span><span class="sc">:</span>M_diabetes <span class="sc">+</span> <span class="co"># then the mediator</span></span>
<span id="cb65-12"><a href="msm_chapter.html#cb65-12" tabindex="-1"></a>                   L0_male <span class="sc">+</span> L0_soc_env <span class="sc">+</span> L1, <span class="co"># then baseline confounders</span></span>
<span id="cb65-13"><a href="msm_chapter.html#cb65-13" tabindex="-1"></a>                 <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>,</span>
<span id="cb65-14"><a href="msm_chapter.html#cb65-14" tabindex="-1"></a>                 <span class="at">data =</span> df1_int)</span>
<span id="cb65-15"><a href="msm_chapter.html#cb65-15" tabindex="-1"></a></span>
<span id="cb65-16"><a href="msm_chapter.html#cb65-16" tabindex="-1"></a>Q.Y.qol <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y_qol <span class="sc">~</span> A0_PM2<span class="fl">.5</span> <span class="sc">+</span> <span class="co"># start with the exposure</span></span>
<span id="cb65-17"><a href="msm_chapter.html#cb65-17" tabindex="-1"></a>                 M_diabetes <span class="sc">+</span> A0_PM2<span class="fl">.5</span><span class="sc">:</span>M_diabetes <span class="sc">+</span> <span class="co"># then the mediator</span></span>
<span id="cb65-18"><a href="msm_chapter.html#cb65-18" tabindex="-1"></a>                 L0_male <span class="sc">+</span> L0_soc_env <span class="sc">+</span> L1, <span class="co"># then baseline confounders</span></span>
<span id="cb65-19"><a href="msm_chapter.html#cb65-19" tabindex="-1"></a>               <span class="at">family =</span> <span class="st">&quot;gaussian&quot;</span>,</span>
<span id="cb65-20"><a href="msm_chapter.html#cb65-20" tabindex="-1"></a>               <span class="at">data =</span> df1_int)</span>
<span id="cb65-21"><a href="msm_chapter.html#cb65-21" tabindex="-1"></a></span>
<span id="cb65-22"><a href="msm_chapter.html#cb65-22" tabindex="-1"></a></span>
<span id="cb65-23"><a href="msm_chapter.html#cb65-23" tabindex="-1"></a><span class="do">## 2) expend the data set and add a second column A* = 1 - A</span></span>
<span id="cb65-24"><a href="msm_chapter.html#cb65-24" tabindex="-1"></a>exp.Data.death <span class="ot">&lt;-</span> <span class="fu">neImpute</span>(Q.Y.death)</span>
<span id="cb65-25"><a href="msm_chapter.html#cb65-25" tabindex="-1"></a><span class="fu">head</span>(exp.Data.death)</span>
<span id="cb65-26"><a href="msm_chapter.html#cb65-26" tabindex="-1"></a><span class="co">#   id A0_PM2.50 A0_PM2.51 L0_male L0_soc_env L1 M_diabetes Y_death Y_qol</span></span>
<span id="cb65-27"><a href="msm_chapter.html#cb65-27" tabindex="-1"></a><span class="co"># 1  1         0         0       0          1  1          0   0.222  93.4</span></span>
<span id="cb65-28"><a href="msm_chapter.html#cb65-28" tabindex="-1"></a><span class="co"># 2  1         1         0       0          1  1          0   0.292  93.4</span></span>
<span id="cb65-29"><a href="msm_chapter.html#cb65-29" tabindex="-1"></a><span class="co"># 3  2         1         1       1          1  1          0   0.356  64.0</span></span>
<span id="cb65-30"><a href="msm_chapter.html#cb65-30" tabindex="-1"></a><span class="co"># 4  2         0         1       1          1  1          0   0.277  64.0</span></span>
<span id="cb65-31"><a href="msm_chapter.html#cb65-31" tabindex="-1"></a><span class="co"># 5  3         0         0       1          1  0          0   0.197  75.6</span></span>
<span id="cb65-32"><a href="msm_chapter.html#cb65-32" tabindex="-1"></a><span class="co"># 6  3         1         0       1          1  0          0   0.261  75.6</span></span>
<span id="cb65-33"><a href="msm_chapter.html#cb65-33" tabindex="-1"></a></span>
<span id="cb65-34"><a href="msm_chapter.html#cb65-34" tabindex="-1"></a>exp.Data.qol <span class="ot">&lt;-</span> <span class="fu">neImpute</span>(Q.Y.qol)</span>
<span id="cb65-35"><a href="msm_chapter.html#cb65-35" tabindex="-1"></a><span class="fu">head</span>(exp.Data.qol)</span>
<span id="cb65-36"><a href="msm_chapter.html#cb65-36" tabindex="-1"></a><span class="co">#   id A0_PM2.50 A0_PM2.51 L0_male L0_soc_env L1 M_diabetes Y_death Y_qol</span></span>
<span id="cb65-37"><a href="msm_chapter.html#cb65-37" tabindex="-1"></a><span class="co"># 1  1         0         0       0          1  1          0       0  68.4</span></span>
<span id="cb65-38"><a href="msm_chapter.html#cb65-38" tabindex="-1"></a><span class="co"># 2  1         1         0       0          1  1          0       0  64.7</span></span>
<span id="cb65-39"><a href="msm_chapter.html#cb65-39" tabindex="-1"></a><span class="co"># 3  2         1         1       1          1  1          0       1  64.0</span></span>
<span id="cb65-40"><a href="msm_chapter.html#cb65-40" tabindex="-1"></a><span class="co"># 4  2         0         1       1          1  1          0       1  67.7</span></span>
<span id="cb65-41"><a href="msm_chapter.html#cb65-41" tabindex="-1"></a><span class="co"># 5  3         0         0       1          1  0          0       0  71.2</span></span>
<span id="cb65-42"><a href="msm_chapter.html#cb65-42" tabindex="-1"></a><span class="co"># 6  3         1         0       1          1  0          0       0  67.4</span></span>
<span id="cb65-43"><a href="msm_chapter.html#cb65-43" tabindex="-1"></a></span>
<span id="cb65-44"><a href="msm_chapter.html#cb65-44" tabindex="-1"></a><span class="co"># the predicted outcomes by medflex are the same than our previous predictions</span></span>
<span id="cb65-45"><a href="msm_chapter.html#cb65-45" tabindex="-1"></a><span class="fu">plot</span>(exp.Data.death<span class="sc">$</span>Y_death, Y.pred.death)</span>
<span id="cb65-46"><a href="msm_chapter.html#cb65-46" tabindex="-1"></a><span class="fu">abline</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb65-47"><a href="msm_chapter.html#cb65-47" tabindex="-1"></a></span>
<span id="cb65-48"><a href="msm_chapter.html#cb65-48" tabindex="-1"></a><span class="fu">plot</span>(exp.Data.qol<span class="sc">$</span>Y_qol, Y.pred.qol)</span>
<span id="cb65-49"><a href="msm_chapter.html#cb65-49" tabindex="-1"></a><span class="fu">abline</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb65-50"><a href="msm_chapter.html#cb65-50" tabindex="-1"></a></span>
<span id="cb65-51"><a href="msm_chapter.html#cb65-51" tabindex="-1"></a><span class="do">## 3) Fit the natural effect model using the neModel() function</span></span>
<span id="cb65-52"><a href="msm_chapter.html#cb65-52" tabindex="-1"></a><span class="do">##    (adjusted for baseline confounders)</span></span>
<span id="cb65-53"><a href="msm_chapter.html#cb65-53" tabindex="-1"></a></span>
<span id="cb65-54"><a href="msm_chapter.html#cb65-54" tabindex="-1"></a><span class="do">## for death</span></span>
<span id="cb65-55"><a href="msm_chapter.html#cb65-55" tabindex="-1"></a>neMod.death <span class="ot">&lt;-</span> <span class="fu">neModel</span>(Y_death <span class="sc">~</span> A0_PM2<span class="fl">.50</span> <span class="sc">*</span> A0_PM2<span class="fl">.51</span> <span class="sc">+</span> L0_male <span class="sc">+</span> L0_soc_env <span class="sc">+</span> L1,</span>
<span id="cb65-56"><a href="msm_chapter.html#cb65-56" tabindex="-1"></a>                       <span class="at">family =</span> <span class="st">&quot;gaussian&quot;</span>, <span class="co"># to estimate risk difference</span></span>
<span id="cb65-57"><a href="msm_chapter.html#cb65-57" tabindex="-1"></a>                       <span class="at">expData =</span> exp.Data.death,</span>
<span id="cb65-58"><a href="msm_chapter.html#cb65-58" tabindex="-1"></a>                       <span class="at">se =</span> <span class="fu">c</span>(<span class="st">&quot;robust&quot;</span>) <span class="co"># or &quot;bootstrap&quot;</span></span>
<span id="cb65-59"><a href="msm_chapter.html#cb65-59" tabindex="-1"></a>                       )</span>
<span id="cb65-60"><a href="msm_chapter.html#cb65-60" tabindex="-1"></a><span class="fu">summary</span>(neMod.death)</span>
<span id="cb65-61"><a href="msm_chapter.html#cb65-61" tabindex="-1"></a><span class="co">#                         Estimate Std. Error z value Pr(&gt;|z|)</span></span>
<span id="cb65-62"><a href="msm_chapter.html#cb65-62" tabindex="-1"></a><span class="co">#   (Intercept)            0.10415    0.00829   12.56  &lt; 2e-16 ***</span></span>
<span id="cb65-63"><a href="msm_chapter.html#cb65-63" tabindex="-1"></a><span class="co">#   A0_PM2.501             0.06354    0.01373    4.63  3.7e-06 ***</span></span>
<span id="cb65-64"><a href="msm_chapter.html#cb65-64" tabindex="-1"></a><span class="co">#   A0_PM2.511             0.00703    0.00175    4.01  6.1e-05 ***</span></span>
<span id="cb65-65"><a href="msm_chapter.html#cb65-65" tabindex="-1"></a><span class="co">#   L0_male                0.05429    0.00867    6.26  3.8e-10 ***</span></span>
<span id="cb65-66"><a href="msm_chapter.html#cb65-66" tabindex="-1"></a><span class="co">#   L0_soc_env             0.06569    0.00882    7.45  9.3e-14 ***</span></span>
<span id="cb65-67"><a href="msm_chapter.html#cb65-67" tabindex="-1"></a><span class="co">#   L1                     0.08645    0.00999    8.66  &lt; 2e-16 ***</span></span>
<span id="cb65-68"><a href="msm_chapter.html#cb65-68" tabindex="-1"></a><span class="co">#   A0_PM2.501:A0_PM2.511  0.00492    0.00391    1.26     0.21</span></span>
<span id="cb65-69"><a href="msm_chapter.html#cb65-69" tabindex="-1"></a></span>
<span id="cb65-70"><a href="msm_chapter.html#cb65-70" tabindex="-1"></a><span class="do">## estimate the conditional PNDE and TNDE, given L(0)=0 and L(1)=0</span></span>
<span id="cb65-71"><a href="msm_chapter.html#cb65-71" tabindex="-1"></a>medflex.PNDE.death.L0 <span class="ot">&lt;-</span> <span class="fu">coef</span>(neMod.death)[<span class="st">&quot;A0_PM2.501&quot;</span>]</span>
<span id="cb65-72"><a href="msm_chapter.html#cb65-72" tabindex="-1"></a><span class="co"># 0.0635</span></span>
<span id="cb65-73"><a href="msm_chapter.html#cb65-73" tabindex="-1"></a>medflex.TNIE.death.L0 <span class="ot">&lt;-</span> (<span class="fu">coef</span>(neMod.death)[<span class="st">&quot;A0_PM2.511&quot;</span>] <span class="sc">+</span></span>
<span id="cb65-74"><a href="msm_chapter.html#cb65-74" tabindex="-1"></a>                            <span class="fu">coef</span>(neMod.death)[<span class="st">&quot;A0_PM2.501:A0_PM2.511&quot;</span>])</span>
<span id="cb65-75"><a href="msm_chapter.html#cb65-75" tabindex="-1"></a><span class="co"># 0.012</span></span>
<span id="cb65-76"><a href="msm_chapter.html#cb65-76" tabindex="-1"></a></span>
<span id="cb65-77"><a href="msm_chapter.html#cb65-77" tabindex="-1"></a><span class="do">## for quality of life</span></span>
<span id="cb65-78"><a href="msm_chapter.html#cb65-78" tabindex="-1"></a>neMod.qol <span class="ot">&lt;-</span> <span class="fu">neModel</span>(Y_qol <span class="sc">~</span> A0_PM2<span class="fl">.50</span> <span class="sc">*</span> A0_PM2<span class="fl">.51</span> <span class="sc">+</span> L0_male <span class="sc">+</span> L0_soc_env <span class="sc">+</span> L1,</span>
<span id="cb65-79"><a href="msm_chapter.html#cb65-79" tabindex="-1"></a>                     <span class="at">family =</span> <span class="st">&quot;gaussian&quot;</span>, <span class="co"># to estimate risk difference</span></span>
<span id="cb65-80"><a href="msm_chapter.html#cb65-80" tabindex="-1"></a>                     <span class="at">expData =</span> exp.Data.qol,</span>
<span id="cb65-81"><a href="msm_chapter.html#cb65-81" tabindex="-1"></a>                     <span class="at">se =</span> <span class="fu">c</span>(<span class="st">&quot;robust&quot;</span>)) <span class="co"># or &quot;bootstrap&quot;</span></span>
<span id="cb65-82"><a href="msm_chapter.html#cb65-82" tabindex="-1"></a><span class="fu">summary</span>(neMod.qol)</span>
<span id="cb65-83"><a href="msm_chapter.html#cb65-83" tabindex="-1"></a><span class="co">#                         Estimate Std. Error z value Pr(&gt;|z|)</span></span>
<span id="cb65-84"><a href="msm_chapter.html#cb65-84" tabindex="-1"></a><span class="co">#   (Intercept)             73.337      0.230  319.17  &lt; 2e-16 ***</span></span>
<span id="cb65-85"><a href="msm_chapter.html#cb65-85" tabindex="-1"></a><span class="co">#   A0_PM2.501              -5.301      0.340  -15.61  &lt; 2e-16 ***</span></span>
<span id="cb65-86"><a href="msm_chapter.html#cb65-86" tabindex="-1"></a><span class="co">#   A0_PM2.511              -1.054      0.139   -7.58  3.6e-14 ***</span></span>
<span id="cb65-87"><a href="msm_chapter.html#cb65-87" tabindex="-1"></a><span class="co">#   L0_male                 -1.329      0.227   -5.85  5.0e-09 ***</span></span>
<span id="cb65-88"><a href="msm_chapter.html#cb65-88" tabindex="-1"></a><span class="co">#   L0_soc_env              -3.647      0.235  -15.54  &lt; 2e-16 ***</span></span>
<span id="cb65-89"><a href="msm_chapter.html#cb65-89" tabindex="-1"></a><span class="co">#   L1                      -4.233      0.249  -17.01  &lt; 2e-16 ***</span></span>
<span id="cb65-90"><a href="msm_chapter.html#cb65-90" tabindex="-1"></a><span class="co">#   A0_PM2.501:A0_PM2.511   -0.792      0.127   -6.21  5.1e-10 ***</span></span>
<span id="cb65-91"><a href="msm_chapter.html#cb65-91" tabindex="-1"></a></span>
<span id="cb65-92"><a href="msm_chapter.html#cb65-92" tabindex="-1"></a><span class="do">## estimate the conditional PNDE and TNDE, given L(0)=0 and L(1)=0</span></span>
<span id="cb65-93"><a href="msm_chapter.html#cb65-93" tabindex="-1"></a>medflex.PNDE.qol.L0 <span class="ot">&lt;-</span> <span class="fu">coef</span>(neMod.qol)[<span class="st">&quot;A0_PM2.501&quot;</span>]</span>
<span id="cb65-94"><a href="msm_chapter.html#cb65-94" tabindex="-1"></a><span class="co"># -5.3</span></span>
<span id="cb65-95"><a href="msm_chapter.html#cb65-95" tabindex="-1"></a>medflex.TNIE.qol.L0 <span class="ot">&lt;-</span> (<span class="fu">coef</span>(neMod.qol)[<span class="st">&quot;A0_PM2.511&quot;</span>] <span class="sc">+</span></span>
<span id="cb65-96"><a href="msm_chapter.html#cb65-96" tabindex="-1"></a>                          <span class="fu">coef</span>(neMod.qol)[<span class="st">&quot;A0_PM2.501:A0_PM2.511&quot;</span>])</span>
<span id="cb65-97"><a href="msm_chapter.html#cb65-97" tabindex="-1"></a><span class="co"># -1.85</span></span>
<span id="cb65-98"><a href="msm_chapter.html#cb65-98" tabindex="-1"></a></span>
<span id="cb65-99"><a href="msm_chapter.html#cb65-99" tabindex="-1"></a></span>
<span id="cb65-100"><a href="msm_chapter.html#cb65-100" tabindex="-1"></a><span class="do">### 6.2.2) estimate marginal PNDE and TNDE (population average) </span></span>
<span id="cb65-101"><a href="msm_chapter.html#cb65-101" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------------- #</span></span>
<span id="cb65-102"><a href="msm_chapter.html#cb65-102" tabindex="-1"></a><span class="do">## Estimate a model of the exposure</span></span>
<span id="cb65-103"><a href="msm_chapter.html#cb65-103" tabindex="-1"></a>g.A.L0 <span class="ot">&lt;-</span> <span class="fu">glm</span>(A0_PM2<span class="fl">.5</span> <span class="sc">~</span> L0_male <span class="sc">+</span> L0_soc_env <span class="sc">+</span> L1, <span class="co"># will no work without L(1) !</span></span>
<span id="cb65-104"><a href="msm_chapter.html#cb65-104" tabindex="-1"></a>              <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>, <span class="at">data =</span> df1_int)</span>
<span id="cb65-105"><a href="msm_chapter.html#cb65-105" tabindex="-1"></a></span>
<span id="cb65-106"><a href="msm_chapter.html#cb65-106" tabindex="-1"></a><span class="do">## 3) Fit the natural effect model using the neModel() function</span></span>
<span id="cb65-107"><a href="msm_chapter.html#cb65-107" tabindex="-1"></a><span class="do">## for death</span></span>
<span id="cb65-108"><a href="msm_chapter.html#cb65-108" tabindex="-1"></a>neMod.death.pop <span class="ot">&lt;-</span> <span class="fu">neModel</span>(Y_death <span class="sc">~</span> A0_PM2<span class="fl">.50</span> <span class="sc">*</span> A0_PM2<span class="fl">.51</span>, <span class="co"># no need for L(0),L(1)</span></span>
<span id="cb65-109"><a href="msm_chapter.html#cb65-109" tabindex="-1"></a>                           <span class="at">family =</span> <span class="st">&quot;gaussian&quot;</span>, <span class="co"># to estimate risk difference</span></span>
<span id="cb65-110"><a href="msm_chapter.html#cb65-110" tabindex="-1"></a>                           <span class="at">expData =</span> exp.Data.death,</span>
<span id="cb65-111"><a href="msm_chapter.html#cb65-111" tabindex="-1"></a>                           <span class="at">xFit =</span> g.A.L0, <span class="co"># model of the exposure</span></span>
<span id="cb65-112"><a href="msm_chapter.html#cb65-112" tabindex="-1"></a>                           <span class="at">se =</span> <span class="fu">c</span>(<span class="st">&quot;robust&quot;</span>)) <span class="co"># or &quot;bootstrap&quot;</span></span>
<span id="cb65-113"><a href="msm_chapter.html#cb65-113" tabindex="-1"></a><span class="fu">summary</span>(neMod.death.pop)</span>
<span id="cb65-114"><a href="msm_chapter.html#cb65-114" tabindex="-1"></a><span class="co"># Parameter estimates:</span></span>
<span id="cb65-115"><a href="msm_chapter.html#cb65-115" tabindex="-1"></a><span class="co">#                         Estimate Std. Error z value Pr(&gt;|z|)</span></span>
<span id="cb65-116"><a href="msm_chapter.html#cb65-116" tabindex="-1"></a><span class="co">#   (Intercept)            0.19888    0.00425   46.83  &lt; 2e-16 ***</span></span>
<span id="cb65-117"><a href="msm_chapter.html#cb65-117" tabindex="-1"></a><span class="co">#   A0_PM2.501             0.06387    0.01378    4.64  3.6e-06 ***</span></span>
<span id="cb65-118"><a href="msm_chapter.html#cb65-118" tabindex="-1"></a><span class="co">#   A0_PM2.511             0.00921    0.00169    5.45  5.1e-08 ***</span></span>
<span id="cb65-119"><a href="msm_chapter.html#cb65-119" tabindex="-1"></a><span class="co">#   A0_PM2.501:A0_PM2.511  0.00233    0.00367    0.64     0.53</span></span>
<span id="cb65-120"><a href="msm_chapter.html#cb65-120" tabindex="-1"></a></span>
<span id="cb65-121"><a href="msm_chapter.html#cb65-121" tabindex="-1"></a><span class="do">## estimate the population average PNDE and TNDE,</span></span>
<span id="cb65-122"><a href="msm_chapter.html#cb65-122" tabindex="-1"></a>medflex.PNDE.death <span class="ot">&lt;-</span> <span class="fu">coef</span>(neMod.death.pop)[<span class="st">&quot;A0_PM2.501&quot;</span>]</span>
<span id="cb65-123"><a href="msm_chapter.html#cb65-123" tabindex="-1"></a><span class="co"># 0.0639</span></span>
<span id="cb65-124"><a href="msm_chapter.html#cb65-124" tabindex="-1"></a>medflex.TNIE.death <span class="ot">&lt;-</span> (<span class="fu">coef</span>(neMod.death.pop)[<span class="st">&quot;A0_PM2.511&quot;</span>] <span class="sc">+</span></span>
<span id="cb65-125"><a href="msm_chapter.html#cb65-125" tabindex="-1"></a>                         <span class="fu">coef</span>(neMod.death.pop)[<span class="st">&quot;A0_PM2.501:A0_PM2.511&quot;</span>])</span>
<span id="cb65-126"><a href="msm_chapter.html#cb65-126" tabindex="-1"></a><span class="co"># 0.0115</span></span>
<span id="cb65-127"><a href="msm_chapter.html#cb65-127" tabindex="-1"></a><span class="co"># the results are the same than results calculated by hand</span></span>
<span id="cb65-128"><a href="msm_chapter.html#cb65-128" tabindex="-1"></a></span>
<span id="cb65-129"><a href="msm_chapter.html#cb65-129" tabindex="-1"></a><span class="do">## for quality of life</span></span>
<span id="cb65-130"><a href="msm_chapter.html#cb65-130" tabindex="-1"></a>neMod.qol.pop <span class="ot">&lt;-</span> <span class="fu">neModel</span>(Y_qol <span class="sc">~</span> A0_PM2<span class="fl">.50</span> <span class="sc">*</span> A0_PM2<span class="fl">.51</span>, <span class="co"># no need for L(0),L(1)</span></span>
<span id="cb65-131"><a href="msm_chapter.html#cb65-131" tabindex="-1"></a>                         <span class="at">family =</span> <span class="st">&quot;gaussian&quot;</span>, <span class="co"># to estimate risk difference</span></span>
<span id="cb65-132"><a href="msm_chapter.html#cb65-132" tabindex="-1"></a>                         <span class="at">expData =</span> exp.Data.qol,</span>
<span id="cb65-133"><a href="msm_chapter.html#cb65-133" tabindex="-1"></a>                         <span class="at">xFit =</span> g.A.L0, <span class="co"># model of the exposure</span></span>
<span id="cb65-134"><a href="msm_chapter.html#cb65-134" tabindex="-1"></a>                         <span class="at">se =</span> <span class="fu">c</span>(<span class="st">&quot;robust&quot;</span>)) <span class="co"># or &quot;bootstrap&quot;</span></span>
<span id="cb65-135"><a href="msm_chapter.html#cb65-135" tabindex="-1"></a><span class="fu">summary</span>(neMod.qol.pop)</span>
<span id="cb65-136"><a href="msm_chapter.html#cb65-136" tabindex="-1"></a><span class="co"># Parameter estimates:</span></span>
<span id="cb65-137"><a href="msm_chapter.html#cb65-137" tabindex="-1"></a><span class="co">#                         Estimate Std. Error z value Pr(&gt;|z|)</span></span>
<span id="cb65-138"><a href="msm_chapter.html#cb65-138" tabindex="-1"></a><span class="co">#   (Intercept)             69.085      0.117  590.50  &lt; 2e-16 ***</span></span>
<span id="cb65-139"><a href="msm_chapter.html#cb65-139" tabindex="-1"></a><span class="co">#   A0_PM2.501              -5.311      0.339  -15.65  &lt; 2e-16 ***</span></span>
<span id="cb65-140"><a href="msm_chapter.html#cb65-140" tabindex="-1"></a><span class="co">#   A0_PM2.511              -1.169      0.145   -8.09  6.1e-16 ***</span></span>
<span id="cb65-141"><a href="msm_chapter.html#cb65-141" tabindex="-1"></a><span class="co">#   A0_PM2.501:A0_PM2.511   -0.740      0.125   -5.92  3.2e-09 ***</span></span>
<span id="cb65-142"><a href="msm_chapter.html#cb65-142" tabindex="-1"></a></span>
<span id="cb65-143"><a href="msm_chapter.html#cb65-143" tabindex="-1"></a><span class="do">## estimate the population average PNDE and TNDE,</span></span>
<span id="cb65-144"><a href="msm_chapter.html#cb65-144" tabindex="-1"></a>medflex.PNDE.qol <span class="ot">&lt;-</span> <span class="fu">coef</span>(neMod.qol.pop)[<span class="st">&quot;A0_PM2.501&quot;</span>]</span>
<span id="cb65-145"><a href="msm_chapter.html#cb65-145" tabindex="-1"></a><span class="co"># -5.31</span></span>
<span id="cb65-146"><a href="msm_chapter.html#cb65-146" tabindex="-1"></a>medflex.TNIE.qol <span class="ot">&lt;-</span> (<span class="fu">coef</span>(neMod.qol.pop)[<span class="st">&quot;A0_PM2.511&quot;</span>] <span class="sc">+</span></span>
<span id="cb65-147"><a href="msm_chapter.html#cb65-147" tabindex="-1"></a>                       <span class="fu">coef</span>(neMod.qol.pop)[<span class="st">&quot;A0_PM2.501:A0_PM2.511&quot;</span>])</span>
<span id="cb65-148"><a href="msm_chapter.html#cb65-148" tabindex="-1"></a><span class="co"># -1.91</span></span>
<span id="cb65-149"><a href="msm_chapter.html#cb65-149" tabindex="-1"></a><span class="co"># the results are the same than results calculated by hand</span></span></code></pre></div>

</div>
</div>
</div>
</div>
<h3>References<a href="references.html#references" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-lange2012" class="csl-entry">
Lange, Theis, Stijn Vansteelandt, and Maarten Bekaert. 2012. <span>“A Simple Unified Approach for Estimating Natural Direct and Indirect Effects.”</span> <em>American Journal of Epidemiology</em> 176 (3): 190–95.
</div>
<div id="ref-vanderweele2009" class="csl-entry">
VanderWeele, Tyler J. 2009. <span>“Marginal Structural Models for the Estimation of Direct and Indirect Effects.”</span> <em>Epidemiology</em> 20: 18–26.
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="ChapIptw.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="chap_tmle.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/benoitlepage/mediation_workshop/05-MSM.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
