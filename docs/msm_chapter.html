<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 8 Marginal structural models | Mediation Workshop</title>
  <meta name="description" content="Expanse project - Mediation workshop. Online complementary document with practical examples in R." />
  <meta name="generator" content="bookdown 0.40 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 8 Marginal structural models | Mediation Workshop" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="Expanse project - Mediation workshop. Online complementary document with practical examples in R." />
  <meta name="github-repo" content="mediation_workshop" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 8 Marginal structural models | Mediation Workshop" />
  
  <meta name="twitter:description" content="Expanse project - Mediation workshop. Online complementary document with practical examples in R." />
  

<meta name="author" content="Benoît Lepage" />


<meta name="date" content="2024-10-17" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="ChapIptw.html"/>
<link rel="next" href="chap_tmle.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>
<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Mediation workshop</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a></li>
<li class="chapter" data-level="2" data-path="software.html"><a href="software.html"><i class="fa fa-check"></i><b>2</b> Software</a></li>
<li class="chapter" data-level="3" data-path="data-sets.html"><a href="data-sets.html"><i class="fa fa-check"></i><b>3</b> Data sets</a>
<ul>
<li class="chapter" data-level="3.1" data-path="data-sets.html"><a href="data-sets.html#general-presentation-of-the-data-used-in-our-examples"><i class="fa fa-check"></i><b>3.1</b> General presentation of the data used in our examples</a></li>
<li class="chapter" data-level="3.2" data-path="data-sets.html"><a href="data-sets.html#data-generating-mechanisms"><i class="fa fa-check"></i><b>3.2</b> Data generating mechanisms</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="ChapBaronKennySem.html"><a href="ChapBaronKennySem.html"><i class="fa fa-check"></i><b>4</b> Baron and Kenny, structural equation models</a>
<ul>
<li class="chapter" data-level="4.1" data-path="ChapBaronKennySem.html"><a href="ChapBaronKennySem.html#baron-and-kenny-approach"><i class="fa fa-check"></i><b>4.1</b> Baron and Kenny approach</a></li>
<li class="chapter" data-level="4.2" data-path="ChapBaronKennySem.html"><a href="ChapBaronKennySem.html#path-analysis-and-structural-equation-modeling"><i class="fa fa-check"></i><b>4.2</b> Path analysis and Structural Equation Modeling</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="ChapBaronKennySem.html"><a href="ChapBaronKennySem.html#first-application-without-intermediate-confouding-affected-by-the-exposure"><i class="fa fa-check"></i><b>4.2.1</b> First application, without intermediate confouding affected by the exposure</a></li>
<li class="chapter" data-level="4.2.2" data-path="ChapBaronKennySem.html"><a href="ChapBaronKennySem.html#dealing-with-categorical-endogenous-variables"><i class="fa fa-check"></i><b>4.2.2</b> Dealing with categorical endogenous variables</a></li>
<li class="chapter" data-level="4.2.3" data-path="ChapBaronKennySem.html"><a href="ChapBaronKennySem.html#application-with-intermediate-confounding-affected-by-the-exposure"><i class="fa fa-check"></i><b>4.2.3</b> Application with intermediate confounding affected by the exposure</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="ChapTradRegModels.html"><a href="ChapTradRegModels.html"><i class="fa fa-check"></i><b>5</b> Traditional regression models</a>
<ul>
<li class="chapter" data-level="5.1" data-path="ChapTradRegModels.html"><a href="ChapTradRegModels.html#estimation-of-the-average-total-effect-ate"><i class="fa fa-check"></i><b>5.1</b> Estimation of the Average Total Effect (ATE)</a></li>
<li class="chapter" data-level="5.2" data-path="ChapTradRegModels.html"><a href="ChapTradRegModels.html#trad2way"><i class="fa fa-check"></i><b>5.2</b> Two-way decomposition</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="ChapTradRegModels.html"><a href="ChapTradRegModels.html#trad2waycde"><i class="fa fa-check"></i><b>5.2.1</b> Controlled Direct Effect</a></li>
<li class="chapter" data-level="5.2.2" data-path="ChapTradRegModels.html"><a href="ChapTradRegModels.html#trad2waynatural"><i class="fa fa-check"></i><b>5.2.2</b> Natural Direct and Indirect effects</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="ChapTradRegModels.html"><a href="ChapTradRegModels.html#trad3way"><i class="fa fa-check"></i><b>5.3</b> Three-way decomposition</a></li>
<li class="chapter" data-level="5.4" data-path="ChapTradRegModels.html"><a href="ChapTradRegModels.html#four-way-decomposition"><i class="fa fa-check"></i><b>5.4</b> Four-way decomposition</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="ChapGcomp.html"><a href="ChapGcomp.html"><i class="fa fa-check"></i><b>6</b> G-computation</a>
<ul>
<li class="chapter" data-level="6.1" data-path="ChapGcomp.html"><a href="ChapGcomp.html#estimation-of-the-average-total-effect-ate-1"><i class="fa fa-check"></i><b>6.1</b> Estimation of the Average Total Effect (ATE)</a></li>
<li class="chapter" data-level="6.2" data-path="ChapGcomp.html"><a href="ChapGcomp.html#estimation-of-controlled-direct-effects-cde"><i class="fa fa-check"></i><b>6.2</b> Estimation of Controlled Direct Effects (CDE)</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="ChapGcomp.html"><a href="ChapGcomp.html#ChapGcomp-CDE-param"><i class="fa fa-check"></i><b>6.2.1</b> Parametric g-computation</a></li>
<li class="chapter" data-level="6.2.2" data-path="ChapGcomp.html"><a href="ChapGcomp.html#ChapGcomp-CDE-ICE"><i class="fa fa-check"></i><b>6.2.2</b> G-computation by iterative conditional expectation</a></li>
<li class="chapter" data-level="6.2.3" data-path="ChapGcomp.html"><a href="ChapGcomp.html#sequential-g-estimator"><i class="fa fa-check"></i><b>6.2.3</b> Sequential g-estimator</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="ChapGcomp.html"><a href="ChapGcomp.html#estimation-of-natural-direct-nde-and-indirect-effects-nie"><i class="fa fa-check"></i><b>6.3</b> Estimation of Natural Direct (NDE) and Indirect Effects (NIE)</a>
<ul>
<li class="chapter" data-level="6.3.1" data-path="ChapGcomp.html"><a href="ChapGcomp.html#simple-plug-in-estimator"><i class="fa fa-check"></i><b>6.3.1</b> Simple “plug-in” estimator</a></li>
<li class="chapter" data-level="6.3.2" data-path="ChapGcomp.html"><a href="ChapGcomp.html#using-the-mediation-r-package"><i class="fa fa-check"></i><b>6.3.2</b> Using the <code>mediation</code> R package</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="ChapGcomp.html"><a href="ChapGcomp.html#estimation-of-marginal-randomizedinterventional-natural-direct-mrde-and-indirect-effects-mrie"><i class="fa fa-check"></i><b>6.4</b> Estimation of “Marginal” Randomized/Interventional Natural Direct (MRDE) and Indirect Effects (MRIE)</a>
<ul>
<li class="chapter" data-level="6.4.1" data-path="ChapGcomp.html"><a href="ChapGcomp.html#parametric-g-computation"><i class="fa fa-check"></i><b>6.4.1</b> Parametric g-computation</a></li>
<li class="chapter" data-level="6.4.2" data-path="ChapGcomp.html"><a href="ChapGcomp.html#g-computation-by-iterative-conditional-expectation"><i class="fa fa-check"></i><b>6.4.2</b> G-computation by iterative conditional expectation</a></li>
</ul></li>
<li class="chapter" data-level="6.5" data-path="ChapGcomp.html"><a href="ChapGcomp.html#using-the-cmaverse-package-for-2-way-3-way-and-4-way-decomposition"><i class="fa fa-check"></i><b>6.5</b> Using the <code>CMAverse</code> package for 2-way, 3-way and 4-way decomposition</a></li>
<li class="chapter" data-level="6.6" data-path="ChapGcomp.html"><a href="ChapGcomp.html#estimation-of-conditional-randomizedinterventional-natural-direct-crde-and-indirect-effects-crie"><i class="fa fa-check"></i><b>6.6</b> Estimation of “Conditional” Randomized/Interventional Natural Direct (CRDE) and Indirect Effects (CRIE)</a>
<ul>
<li class="chapter" data-level="6.6.1" data-path="ChapGcomp.html"><a href="ChapGcomp.html#g-computation-by-iterative-conditional-expectation-simple-substitution-estimator"><i class="fa fa-check"></i><b>6.6.1</b> G-computation by iterative conditional expectation (simple substitution estimator)</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="ChapIptw.html"><a href="ChapIptw.html"><i class="fa fa-check"></i><b>7</b> Inverse Probability of Treatment Weighting (IPTW)</a>
<ul>
<li class="chapter" data-level="7.1" data-path="ChapIptw.html"><a href="ChapIptw.html#estimation-of-the-average-total-effect"><i class="fa fa-check"></i><b>7.1</b> Estimation of the Average total effect</a>
<ul>
<li class="chapter" data-level="7.1.1" data-path="ChapIptw.html"><a href="ChapIptw.html#iptw-for-the-ate"><i class="fa fa-check"></i><b>7.1.1</b> IPTW for the ATE</a></li>
<li class="chapter" data-level="7.1.2" data-path="ChapIptw.html"><a href="ChapIptw.html#stabilized-iptw-for-the-ate"><i class="fa fa-check"></i><b>7.1.2</b> Stabilized IPTW for the ATE</a></li>
</ul></li>
<li class="chapter" data-level="7.2" data-path="ChapIptw.html"><a href="ChapIptw.html#estimation-of-the-controlled-direct-effect-cde"><i class="fa fa-check"></i><b>7.2</b> Estimation of the Controlled direct effect (CDE)</a>
<ul>
<li class="chapter" data-level="7.2.1" data-path="ChapIptw.html"><a href="ChapIptw.html#iptw-for-the-cde"><i class="fa fa-check"></i><b>7.2.1</b> IPTW for the CDE</a></li>
<li class="chapter" data-level="7.2.2" data-path="ChapIptw.html"><a href="ChapIptw.html#stabilized-iptw-for-the-cde"><i class="fa fa-check"></i><b>7.2.2</b> Stabilized IPTW for the CDE</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="ChapIptw.html"><a href="ChapIptw.html#estimation-of-conditional-randomizedinterventional-natural-direct-crde-and-indirect-effects-crie-1"><i class="fa fa-check"></i><b>7.3</b> Estimation of “Conditional” Randomized/Interventional Natural Direct (CRDE) and Indirect Effects (CRIE)</a>
<ul>
<li class="chapter" data-level="7.3.1" data-path="ChapIptw.html"><a href="ChapIptw.html#iptw-for-the-crde-and-crie"><i class="fa fa-check"></i><b>7.3.1</b> IPTW for the CRDE and CRIE</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="msm_chapter.html"><a href="msm_chapter.html"><i class="fa fa-check"></i><b>8</b> Marginal structural models</a>
<ul>
<li class="chapter" data-level="8.1" data-path="msm_chapter.html"><a href="msm_chapter.html#msm_ATE_paragraph"><i class="fa fa-check"></i><b>8.1</b> MSM for the Average Total Effect (ATE)</a>
<ul>
<li class="chapter" data-level="8.1.1" data-path="msm_chapter.html"><a href="msm_chapter.html#expressing-the-ate-using-coefficients-of-an-msm"><i class="fa fa-check"></i><b>8.1.1</b> Expressing the ATE using coefficients of an MSM</a></li>
<li class="chapter" data-level="8.1.2" data-path="msm_chapter.html"><a href="msm_chapter.html#estimation-of-the-msm-coefficients-by-iptw"><i class="fa fa-check"></i><b>8.1.2</b> Estimation of the MSM coefficients by IPTW</a></li>
<li class="chapter" data-level="8.1.3" data-path="msm_chapter.html"><a href="msm_chapter.html#estimation-of-the-msm-coefficients-by-g-computation-imputation"><i class="fa fa-check"></i><b>8.1.3</b> Estimation of the MSM coefficients by G-computation (imputation)</a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="msm_chapter.html"><a href="msm_chapter.html#msm_CDE_paragraph"><i class="fa fa-check"></i><b>8.2</b> MSM for Controlled Direct Effects</a>
<ul>
<li class="chapter" data-level="8.2.1" data-path="msm_chapter.html"><a href="msm_chapter.html#expressing-the-cde-using-coefficients-of-an-msm"><i class="fa fa-check"></i><b>8.2.1</b> Expressing the CDE using coefficients of an MSM</a></li>
<li class="chapter" data-level="8.2.2" data-path="msm_chapter.html"><a href="msm_chapter.html#estimation-of-the-msm-coefficients-by-iptw-1"><i class="fa fa-check"></i><b>8.2.2</b> Estimation of the MSM coefficients by IPTW</a></li>
<li class="chapter" data-level="8.2.3" data-path="msm_chapter.html"><a href="msm_chapter.html#estimation-of-the-msm-coefficients-by-g-computation"><i class="fa fa-check"></i><b>8.2.3</b> Estimation of the MSM coefficients by G-computation</a></li>
</ul></li>
<li class="chapter" data-level="8.3" data-path="msm_chapter.html"><a href="msm_chapter.html#msm_NDE_NIE_paragraph"><i class="fa fa-check"></i><b>8.3</b> MSM for Natural Direct and Indirect Effects</a>
<ul>
<li class="chapter" data-level="8.3.1" data-path="msm_chapter.html"><a href="msm_chapter.html#expressing-the-nde-and-nie-using-coefficients-of-2-msms"><i class="fa fa-check"></i><b>8.3.1</b> Expressing the NDE and NIE using coefficients of 2 MSMs</a></li>
<li class="chapter" data-level="8.3.2" data-path="msm_chapter.html"><a href="msm_chapter.html#estimation-of-the-2-msms-coefficients-by-iptw-for-nde-and-nie"><i class="fa fa-check"></i><b>8.3.2</b> Estimation of the 2 MSMs coefficients by IPTW for NDE and NIE</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="9" data-path="chap_tmle.html"><a href="chap_tmle.html"><i class="fa fa-check"></i><b>9</b> Targeted Maximum Likelihood Estimation (TMLE)</a>
<ul>
<li class="chapter" data-level="9.1" data-path="chap_tmle.html"><a href="chap_tmle.html#tmle-for-the-ate"><i class="fa fa-check"></i><b>9.1</b> TMLE for the ATE</a></li>
<li class="chapter" data-level="9.2" data-path="chap_tmle.html"><a href="chap_tmle.html#tmle-of-the-controlled-direct-effect-cde"><i class="fa fa-check"></i><b>9.2</b> TMLE of the Controlled direct effect (CDE)</a>
<ul>
<li class="chapter" data-level="9.2.1" data-path="chap_tmle.html"><a href="chap_tmle.html#for-binary-outcomes"><i class="fa fa-check"></i><b>9.2.1</b> For binary outcomes</a></li>
<li class="chapter" data-level="9.2.2" data-path="chap_tmle.html"><a href="chap_tmle.html#for-continuous-outcomes"><i class="fa fa-check"></i><b>9.2.2</b> For continuous outcomes</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="10" data-path="appendix_a.html"><a href="appendix_a.html"><i class="fa fa-check"></i><b>10</b> Appendix A: Data generating mechanisms</a>
<ul>
<li class="chapter" data-level="10.1" data-path="appendix_a.html"><a href="appendix_a.html#first-causal-model-data-generating-mechanism-without-mediator-outcome-confounder-affected-by-the-exposure"><i class="fa fa-check"></i><b>10.1</b> First causal model: Data generating mechanism without mediator-outcome confounder affected by the exposure</a></li>
<li class="chapter" data-level="10.2" data-path="appendix_a.html"><a href="appendix_a.html#second-causal-model-data-generating-mechanism-with-mediator-outcome-confounder-affected-by-the-exposure"><i class="fa fa-check"></i><b>10.2</b> Second causal model: Data generating mechanism with mediator-outcome confounder affected by the exposure</a></li>
<li class="chapter" data-level="10.3" data-path="appendix_a.html"><a href="appendix_a.html#simulation-of-the-four-data-sets-used-in-examples"><i class="fa fa-check"></i><b>10.3</b> Simulation of the four data sets used in examples</a>
<ul>
<li class="chapter" data-level="10.3.1" data-path="appendix_a.html"><a href="appendix_a.html#data-sets-generated-from-the-causal-model-1"><i class="fa fa-check"></i><b>10.3.1</b> Data sets generated from the causal model 1</a></li>
<li class="chapter" data-level="10.3.2" data-path="appendix_a.html"><a href="appendix_a.html#data-sets-generated-from-the-causal-model-2"><i class="fa fa-check"></i><b>10.3.2</b> Data sets generated from the causal model 2</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="11" data-path="appendix_b.html"><a href="appendix_b.html"><i class="fa fa-check"></i><b>11</b> Appendix B: Calculation of the true causal quantities</a>
<ul>
<li class="chapter" data-level="11.1" data-path="appendix_b.html"><a href="appendix_b.html#true-causal-quantities-without-mediator-ouctome-confounder-affected-by-the-exposure"><i class="fa fa-check"></i><b>11.1</b> True causal quantities without mediator-ouctome confounder affected by the exposure</a>
<ul>
<li class="chapter" data-level="11.1.1" data-path="appendix_b.html"><a href="appendix_b.html#average-total-effects-ate"><i class="fa fa-check"></i><b>11.1.1</b> Average total effects (ATE)</a></li>
<li class="chapter" data-level="11.1.2" data-path="appendix_b.html"><a href="appendix_b.html#controlled-direct-effects-cde"><i class="fa fa-check"></i><b>11.1.2</b> Controlled direct effects (CDE)</a></li>
<li class="chapter" data-level="11.1.3" data-path="appendix_b.html"><a href="appendix_b.html#pure-natural-direct-effect-and-total-natural-indirect-effect"><i class="fa fa-check"></i><b>11.1.3</b> Pure natural direct effect and Total natural indirect effect</a></li>
<li class="chapter" data-level="11.1.4" data-path="appendix_b.html"><a href="appendix_b.html#total-natural-direct-effect-and-pure-natural-indirect-effect"><i class="fa fa-check"></i><b>11.1.4</b> Total natural direct effect and Pure natural indirect effect</a></li>
<li class="chapter" data-level="11.1.5" data-path="appendix_b.html"><a href="appendix_b.html#vanderweeles-3-way-decomposition"><i class="fa fa-check"></i><b>11.1.5</b> Vanderweele’s 3-way decomposition</a></li>
<li class="chapter" data-level="11.1.6" data-path="appendix_b.html"><a href="appendix_b.html#vanderweeles-4-way-decomposition"><i class="fa fa-check"></i><b>11.1.6</b> Vanderweele’s 4-way decomposition</a></li>
<li class="chapter" data-level="11.1.7" data-path="appendix_b.html"><a href="appendix_b.html#marginal-randomized-direct-and-indirect-effects"><i class="fa fa-check"></i><b>11.1.7</b> Marginal randomized direct and indirect effects</a></li>
<li class="chapter" data-level="11.1.8" data-path="appendix_b.html"><a href="appendix_b.html#conditional-randomized-direct-and-indirect-effects"><i class="fa fa-check"></i><b>11.1.8</b> Conditional randomized direct and indirect effects</a></li>
</ul></li>
<li class="chapter" data-level="11.2" data-path="appendix_b.html"><a href="appendix_b.html#true-causal-quantities-with-mediator-outcome-confounder-affected-by-the-exposure"><i class="fa fa-check"></i><b>11.2</b> True causal quantities with mediator-outcome confounder affected by the exposure</a>
<ul>
<li class="chapter" data-level="11.2.1" data-path="appendix_b.html"><a href="appendix_b.html#average-total-effects-ate-1"><i class="fa fa-check"></i><b>11.2.1</b> Average total effects (ATE)</a></li>
<li class="chapter" data-level="11.2.2" data-path="appendix_b.html"><a href="appendix_b.html#controlled-direct-effects-cde-1"><i class="fa fa-check"></i><b>11.2.2</b> Controlled direct effects (CDE)</a></li>
<li class="chapter" data-level="11.2.3" data-path="appendix_b.html"><a href="appendix_b.html#marginal-randomized-direct-and-indirect-effects-1"><i class="fa fa-check"></i><b>11.2.3</b> Marginal randomized direct and indirect effects</a></li>
<li class="chapter" data-level="11.2.4" data-path="appendix_b.html"><a href="appendix_b.html#conditional-randomized-direct-and-indirect-effects-1"><i class="fa fa-check"></i><b>11.2.4</b> Conditional randomized direct and indirect effects</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Mediation Workshop</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="msm_chapter" class="section level1 hasAnchor" number="8">
<h1><span class="header-section-number">Chapter 8</span> Marginal structural models<a href="msm_chapter.html#msm_chapter" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>Marginal structural models (MSM) are parametric models that are used to summarize the relationship between the counterfactual outcome (<span class="math inline">\(Y_a\)</span> or <span class="math inline">\(Y_{am}\)</span> for example) and the exposure(s) <span class="math inline">\(A\)</span> and mediators <span class="math inline">\(M\)</span>. It also possible to summarize the relationship according to a subset of the baseline confounders if it is relevant for the scientific question.</p>
<p>To illustrate the application of MSMs, we will first use the data simulated from the Causal model 1 (with an <span class="math inline">\(A \ast M\)</span> interaction effect on the outcome) where the exposure <span class="math inline">\(A\)</span> doesn’t affect the confounder <span class="math inline">\(L(1)\)</span> between the mediator and the outcome.</p>
<div id="msm_ATE_paragraph" class="section level2 hasAnchor" number="8.1">
<h2><span class="header-section-number">8.1</span> MSM for the Average Total Effect (ATE)<a href="msm_chapter.html#msm_ATE_paragraph" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="expressing-the-ate-using-coefficients-of-an-msm" class="section level3 hasAnchor" number="8.1.1">
<h3><span class="header-section-number">8.1.1</span> Expressing the ATE using coefficients of an MSM<a href="msm_chapter.html#expressing-the-ate-using-coefficients-of-an-msm" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>For a continuous or binary outcome, we can use the following MSM to summarize the relationship between the counterfactual outcome (<span class="math inline">\(Y_a\)</span>) and the exposure(s) <span class="math inline">\(A\)</span>:
<span class="math display" id="eq:MSMATEmarg">\[\begin{equation}
  \mathbb{E}(Y_a) = \alpha_0 + \alpha_A a
  \tag{8.1}
\end{equation}\]</span></p>
<p>The Average Total Effect <span class="math inline">\(\text{ATE} = \mathbb{E}(Y_{A=1}) - \mathbb{E}(Y_{A=0})\)</span> can then be expressed using the coefficients of this MSM <a href="msm_chapter.html#eq:MSMATEmarg">(8.1)</a>:
<span class="math display">\[\begin{equation*}
  \text{ATE} := \left(\alpha_0 + \alpha_A \times 1 \right) - \left(\alpha_0 + \alpha_A \times 0 \right) = \alpha_A
\end{equation*}\]</span></p>
<p>In this example, the coefficient <span class="math inline">\(\alpha_A\)</span> corresponds to the <span class="math inline">\(\text{ATE}\)</span>.</p>
<p>Such a model is not very useful for a binary exposure. It would be much more useful for higher-dimensional exposures, for example with a continuous exposure, where the relationship between all the possible continuous values of the exposure <span class="math inline">\(A=a\)</span> and the corresponding outcomes <span class="math inline">\(Y_a\)</span> is summarized (and arbitrarily simplified) by a single line and the slope coefficient <span class="math inline">\(\alpha_A\)</span>.</p>
<p>It is also possible to define MSMs adjusted for a subset <span class="math inline">\(V\)</span> of the baseline confounders (<span class="math inline">\(V \subset L(0)\)</span>). Such MSMs can be useful to estimate conditional effects. For example it is possible to define an average “conditional” total effect <span class="math inline">\(\text{ATE}|L(0)\)</span> (instead of the marginal ATE defined above), projecting the counterfactual outcomes on a parametric model such as the following:</p>
<p><span class="math display" id="eq:MSMATEcond">\[\begin{equation}
  \mathbb{E}(Y_a \mid L(0)) = \alpha_0 + \alpha_A a + \alpha_\text{male} L_\text{male}(0) + \alpha_\text{soc.env.} L_\text{soc.env.}(0)
  \tag{8.2}
\end{equation}\]</span></p>
<p>so that <span class="math inline">\(\text{ATE} \mid L(0) = \mathbb{E}(Y_{A=1} \mid L(0)) - \mathbb{E}(Y_{A=0} \mid L(0)) = \alpha_A\)</span> using the coefficient from the MSM <a href="msm_chapter.html#eq:MSMATEcond">(8.2)</a>.</p>
<p>MSMs are also very useful to study interactions, or effect modification of the exposure <span class="math inline">\(A\)</span> by a baseline confounder. For example, in order to study the average total effect according to sex, we can use the following MSM:</p>
<p><span class="math display" id="eq:MSMATEsex">\[\begin{equation}
  \mathbb{E}(Y_a \mid L_\text{male}(0)) = \alpha_0 + \alpha_A a + \alpha_\text{male} L_\text{male}(0) + \alpha_{A \ast L_\text{male}} \left(a \times L_\text{male}(0)\right)
  \tag{8.3}
\end{equation}\]</span></p>
<p>and express the average total effect in each strata of sex using the coefficients of the MSM <a href="msm_chapter.html#eq:MSMATEsex">(8.3)</a>:</p>
<p><span class="math display">\[\begin{align*}
\{\text{ATE} \mid L_\text{male}(0) = 0\} &amp;:= \mathbb{E}(Y_1 \mid L_\text{male}(0) = 0) - \mathbb{E}(Y_0 \mid L_\text{male}(0) = 0) = \alpha_A \\
\{\text{ATE} \mid L_\text{male}(0) = 1\} &amp;:= \mathbb{E}(Y_1 \mid L_\text{male}(0) = 1) - \mathbb{E}(Y_0 \mid L_\text{male}(0) = 1) = \alpha_A + \alpha_{A \ast L_\text{male}}
\end{align*}\]</span></p>
<p>Because MSMs are models of unobserved counterfactual outcomes, estimators of the MSM coefficients are necessary. We will describe two possible approaches : estimation by IPTW or by G-computation.</p>
<p>In both approaches, 95% confidence intervals can be computed by bootstrap.</p>
</div>
<div id="estimation-of-the-msm-coefficients-by-iptw" class="section level3 hasAnchor" number="8.1.2">
<h3><span class="header-section-number">8.1.2</span> Estimation of the MSM coefficients by IPTW<a href="msm_chapter.html#estimation-of-the-msm-coefficients-by-iptw" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>MSM coefficients can be easily estimated using an Inverse Probability of Treatment (IPTW) approach based on weighted regressions.</p>
<p>For example, in order to fit the MSM <a href="msm_chapter.html#eq:MSMATEsex">(8.3)</a> described above, we can use a linear regression of the (observed) outcome <span class="math inline">\(Y\)</span> on the exposure and sex, weigthed by individual weights <span class="math inline">\(w_i\)</span> or <span class="math inline">\(sw_i\)</span>:
<span class="math display">\[\begin{equation}
  \mathbb{E}\left[Y \mid L_\text{male}(0)\right] = \alpha_0 + \alpha_A a + \alpha_\text{male} L_\text{male}(0) + \alpha_{A \ast L_\text{male}} \left(a \times L_\text{male}(0)\right)
\end{equation}\]</span></p>
<p>where <span class="math inline">\(w_i=\frac{1}{P(A=a_i \mid L(0)=l(0)_i)}\)</span> or <span class="math inline">\(sw_i=\frac{P(A=a_i \mid L_\text{male}(0))}{P(A=a_i \mid L(0)=l(0)_i)}\)</span>.</p>
<p>As in chapter <a href="ChapIptw.html#ChapIptw">7</a>, the “no-unmeasured confounding” assumption is addressed by the application of weights <span class="math inline">\(w_i\)</span> or <span class="math inline">\(sw_i\)</span>, which balance confounders <span class="math inline">\(L(0)\)</span> relative to the exposure <span class="math inline">\(A\)</span>.</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="msm_chapter.html#cb48-1" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list=</span><span class="fu">ls</span>())</span>
<span id="cb48-2"><a href="msm_chapter.html#cb48-2" tabindex="-1"></a>df1_int <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="st">&quot;data/df1_int.csv&quot;</span>)</span>
<span id="cb48-3"><a href="msm_chapter.html#cb48-3" tabindex="-1"></a></span>
<span id="cb48-4"><a href="msm_chapter.html#cb48-4" tabindex="-1"></a><span class="do">## 1. Denominator of the weight</span></span>
<span id="cb48-5"><a href="msm_chapter.html#cb48-5" tabindex="-1"></a><span class="co"># 1a. Estimate g(A=a_i|L(0)) (denominator of the weight)</span></span>
<span id="cb48-6"><a href="msm_chapter.html#cb48-6" tabindex="-1"></a>g.A.L <span class="ot">&lt;-</span> <span class="fu">glm</span>(A0_PM2<span class="fl">.5</span> <span class="sc">~</span> L0_male <span class="sc">+</span> L0_soc_env,</span>
<span id="cb48-7"><a href="msm_chapter.html#cb48-7" tabindex="-1"></a>           <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>, <span class="at">data =</span> df1_int)</span>
<span id="cb48-8"><a href="msm_chapter.html#cb48-8" tabindex="-1"></a></span>
<span id="cb48-9"><a href="msm_chapter.html#cb48-9" tabindex="-1"></a><span class="co"># 1b. Predict each individual&#39;s probability of being exposed to her own exposure</span></span>
<span id="cb48-10"><a href="msm_chapter.html#cb48-10" tabindex="-1"></a><span class="co"># predict the probabilities P(A0_PM2.5 = 1) &amp; P(A0_PM2.5 = 0)</span></span>
<span id="cb48-11"><a href="msm_chapter.html#cb48-11" tabindex="-1"></a>pred.g1.L <span class="ot">&lt;-</span> <span class="fu">predict</span>(g.A.L, <span class="at">type=</span><span class="st">&quot;response&quot;</span>)</span>
<span id="cb48-12"><a href="msm_chapter.html#cb48-12" tabindex="-1"></a>pred.g0.L <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> pred.g1.L</span>
<span id="cb48-13"><a href="msm_chapter.html#cb48-13" tabindex="-1"></a><span class="co"># the predicted probability of the observed treatment P(A = a_i | L(0)) is :</span></span>
<span id="cb48-14"><a href="msm_chapter.html#cb48-14" tabindex="-1"></a>gAi.L <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">nrow</span>(df1_int))</span>
<span id="cb48-15"><a href="msm_chapter.html#cb48-15" tabindex="-1"></a>gAi.L[df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">1</span>] <span class="ot">&lt;-</span> pred.g1.L[df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">1</span>]</span>
<span id="cb48-16"><a href="msm_chapter.html#cb48-16" tabindex="-1"></a>gAi.L[df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">0</span>] <span class="ot">&lt;-</span> pred.g0.L[df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">0</span>]</span>
<span id="cb48-17"><a href="msm_chapter.html#cb48-17" tabindex="-1"></a></span>
<span id="cb48-18"><a href="msm_chapter.html#cb48-18" tabindex="-1"></a><span class="do">## 2. Numerator of the weight</span></span>
<span id="cb48-19"><a href="msm_chapter.html#cb48-19" tabindex="-1"></a><span class="co"># The numerator of the weight can be 1 for simple weights,</span></span>
<span id="cb48-20"><a href="msm_chapter.html#cb48-20" tabindex="-1"></a><span class="co"># or g(A=a_i|V) to obtain stabilized weights which put less weight to individuals</span></span>
<span id="cb48-21"><a href="msm_chapter.html#cb48-21" tabindex="-1"></a><span class="co"># with less observation. Stabilized weights enable a weaker positivity assumption.</span></span>
<span id="cb48-22"><a href="msm_chapter.html#cb48-22" tabindex="-1"></a></span>
<span id="cb48-23"><a href="msm_chapter.html#cb48-23" tabindex="-1"></a><span class="co"># 2a. Estimate g(A=a_i | sex) (numerator of the stabilized weight)</span></span>
<span id="cb48-24"><a href="msm_chapter.html#cb48-24" tabindex="-1"></a>g.A.sex <span class="ot">&lt;-</span> <span class="fu">glm</span>(A0_PM2<span class="fl">.5</span> <span class="sc">~</span> L0_male,</span>
<span id="cb48-25"><a href="msm_chapter.html#cb48-25" tabindex="-1"></a>               <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>, <span class="at">data =</span> df1_int)</span>
<span id="cb48-26"><a href="msm_chapter.html#cb48-26" tabindex="-1"></a></span>
<span id="cb48-27"><a href="msm_chapter.html#cb48-27" tabindex="-1"></a><span class="co"># 2b. Predict each individual&#39;s probability of being exposed to her own exposure</span></span>
<span id="cb48-28"><a href="msm_chapter.html#cb48-28" tabindex="-1"></a><span class="co"># predict the probabilities P(A0_PM2.5 = 1 | sex) &amp; P(A0_PM2.5 = 0 | sex)</span></span>
<span id="cb48-29"><a href="msm_chapter.html#cb48-29" tabindex="-1"></a>pred.g1.sex <span class="ot">&lt;-</span> <span class="fu">predict</span>(g.A.sex, <span class="at">type=</span><span class="st">&quot;response&quot;</span>)</span>
<span id="cb48-30"><a href="msm_chapter.html#cb48-30" tabindex="-1"></a>pred.g0.sex <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> pred.g1.sex</span>
<span id="cb48-31"><a href="msm_chapter.html#cb48-31" tabindex="-1"></a><span class="co"># the predicted probability of the observed treatment P(A = a_i | sex) is :</span></span>
<span id="cb48-32"><a href="msm_chapter.html#cb48-32" tabindex="-1"></a>gAi.sex <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">nrow</span>(df1_int))</span>
<span id="cb48-33"><a href="msm_chapter.html#cb48-33" tabindex="-1"></a>gAi.sex[df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">1</span>] <span class="ot">&lt;-</span> pred.g1.sex[df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">1</span>]</span>
<span id="cb48-34"><a href="msm_chapter.html#cb48-34" tabindex="-1"></a>gAi.sex[df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">0</span>] <span class="ot">&lt;-</span> pred.g0.sex[df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">0</span>]</span>
<span id="cb48-35"><a href="msm_chapter.html#cb48-35" tabindex="-1"></a></span>
<span id="cb48-36"><a href="msm_chapter.html#cb48-36" tabindex="-1"></a><span class="do">## 3. Define individual weights:</span></span>
<span id="cb48-37"><a href="msm_chapter.html#cb48-37" tabindex="-1"></a><span class="co"># We can use simple weights w = 1 / g(A=a_i | L(0))</span></span>
<span id="cb48-38"><a href="msm_chapter.html#cb48-38" tabindex="-1"></a>w <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> gAi.L</span>
<span id="cb48-39"><a href="msm_chapter.html#cb48-39" tabindex="-1"></a><span class="co"># Or alternatively, we can use stabilized weights : </span></span>
<span id="cb48-40"><a href="msm_chapter.html#cb48-40" tabindex="-1"></a><span class="co"># sw = g(A=a_i | sex) / g(A=a_i | L(0))</span></span>
<span id="cb48-41"><a href="msm_chapter.html#cb48-41" tabindex="-1"></a>sw <span class="ot">&lt;-</span> gAi.sex <span class="sc">/</span> gAi.L</span>
<span id="cb48-42"><a href="msm_chapter.html#cb48-42" tabindex="-1"></a></span>
<span id="cb48-43"><a href="msm_chapter.html#cb48-43" tabindex="-1"></a><span class="co"># we can see that stabilized weights have less extreme values</span></span>
<span id="cb48-44"><a href="msm_chapter.html#cb48-44" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfcol =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb48-45"><a href="msm_chapter.html#cb48-45" tabindex="-1"></a><span class="fu">boxplot</span>(w <span class="sc">~</span> df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span>)</span>
<span id="cb48-46"><a href="msm_chapter.html#cb48-46" tabindex="-1"></a><span class="fu">boxplot</span>(sw <span class="sc">~</span> df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span>)</span>
<span id="cb48-47"><a href="msm_chapter.html#cb48-47" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfcol =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb48-48"><a href="msm_chapter.html#cb48-48" tabindex="-1"></a></span>
<span id="cb48-49"><a href="msm_chapter.html#cb48-49" tabindex="-1"></a><span class="do">## applying these weights creates a pseudo-population were the baseline</span></span>
<span id="cb48-50"><a href="msm_chapter.html#cb48-50" tabindex="-1"></a><span class="do">## confounders are balanced, relative to the exposure:</span></span>
<span id="cb48-51"><a href="msm_chapter.html#cb48-51" tabindex="-1"></a><span class="do">## before applying weights to the individuals:</span></span>
<span id="cb48-52"><a href="msm_chapter.html#cb48-52" tabindex="-1"></a><span class="fu">table</span>(df1_int<span class="sc">$</span>L0_male, df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span>, <span class="at">deparse.level =</span> <span class="dv">2</span>)</span>
<span id="cb48-53"><a href="msm_chapter.html#cb48-53" tabindex="-1"></a><span class="co">#                df1_int$A0_PM2.5</span></span>
<span id="cb48-54"><a href="msm_chapter.html#cb48-54" tabindex="-1"></a><span class="co"># df1_int$L0_male    0    1</span></span>
<span id="cb48-55"><a href="msm_chapter.html#cb48-55" tabindex="-1"></a><span class="co">#               0 4527  463</span></span>
<span id="cb48-56"><a href="msm_chapter.html#cb48-56" tabindex="-1"></a><span class="co">#               1 4349  661</span></span>
<span id="cb48-57"><a href="msm_chapter.html#cb48-57" tabindex="-1"></a><span class="fu">prop.table</span>(<span class="fu">table</span>(df1_int<span class="sc">$</span>L0_male, df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span>, <span class="at">deparse.level =</span> <span class="dv">2</span>),</span>
<span id="cb48-58"><a href="msm_chapter.html#cb48-58" tabindex="-1"></a>           <span class="at">margin =</span> <span class="dv">2</span>)</span>
<span id="cb48-59"><a href="msm_chapter.html#cb48-59" tabindex="-1"></a><span class="co">#                          df1_int$A0_PM2.5</span></span>
<span id="cb48-60"><a href="msm_chapter.html#cb48-60" tabindex="-1"></a><span class="co"># df1_int$L0_male         0         1</span></span>
<span id="cb48-61"><a href="msm_chapter.html#cb48-61" tabindex="-1"></a><span class="co">#               0 0.5100270 0.4119217</span></span>
<span id="cb48-62"><a href="msm_chapter.html#cb48-62" tabindex="-1"></a><span class="co">#               1 0.4899730 0.5880783   # sex is unbalanced: 49% versus 59%</span></span>
<span id="cb48-63"><a href="msm_chapter.html#cb48-63" tabindex="-1"></a></span>
<span id="cb48-64"><a href="msm_chapter.html#cb48-64" tabindex="-1"></a><span class="do">## after applying weights to the individuals:</span></span>
<span id="cb48-65"><a href="msm_chapter.html#cb48-65" tabindex="-1"></a><span class="fu">library</span>(questionr) <span class="co"># The questionr package enables to describe weighted populations</span></span>
<span id="cb48-66"><a href="msm_chapter.html#cb48-66" tabindex="-1"></a><span class="fu">wtd.table</span>(<span class="at">x =</span> df1_int<span class="sc">$</span>L0_male, <span class="at">y =</span> df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span>,</span>
<span id="cb48-67"><a href="msm_chapter.html#cb48-67" tabindex="-1"></a>          <span class="at">weights =</span> w)</span>
<span id="cb48-68"><a href="msm_chapter.html#cb48-68" tabindex="-1"></a><span class="co">#          0        1</span></span>
<span id="cb48-69"><a href="msm_chapter.html#cb48-69" tabindex="-1"></a><span class="co"># 0 4989.425 4918.462</span></span>
<span id="cb48-70"><a href="msm_chapter.html#cb48-70" tabindex="-1"></a><span class="co"># 1 5010.862 5057.676</span></span>
<span id="cb48-71"><a href="msm_chapter.html#cb48-71" tabindex="-1"></a><span class="fu">prop.table</span>(<span class="fu">wtd.table</span>(<span class="at">x =</span> df1_int<span class="sc">$</span>L0_male, <span class="at">y =</span> df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span>,</span>
<span id="cb48-72"><a href="msm_chapter.html#cb48-72" tabindex="-1"></a>                     <span class="at">weights =</span> w), <span class="at">margin =</span> <span class="dv">2</span>)</span>
<span id="cb48-73"><a href="msm_chapter.html#cb48-73" tabindex="-1"></a><span class="co">#           0         1</span></span>
<span id="cb48-74"><a href="msm_chapter.html#cb48-74" tabindex="-1"></a><span class="co"># 0 0.4989282 0.4930227</span></span>
<span id="cb48-75"><a href="msm_chapter.html#cb48-75" tabindex="-1"></a><span class="co"># 1 0.5010718 0.5069773 # sex is balanced in the weighted population</span></span>
<span id="cb48-76"><a href="msm_chapter.html#cb48-76" tabindex="-1"></a></span>
<span id="cb48-77"><a href="msm_chapter.html#cb48-77" tabindex="-1"></a><span class="do">## 4. Estimate coefficients of the MSM using a weighted regression E(Y | A, sex)</span></span>
<span id="cb48-78"><a href="msm_chapter.html#cb48-78" tabindex="-1"></a><span class="co"># a GLM with gaussian family can be applied to estimate risk differences</span></span>
<span id="cb48-79"><a href="msm_chapter.html#cb48-79" tabindex="-1"></a><span class="co"># (for relative risk or rate ratios, we can apply a Poisson family; </span></span>
<span id="cb48-80"><a href="msm_chapter.html#cb48-80" tabindex="-1"></a><span class="co">#  for OR, we can apply a binomial family)</span></span>
<span id="cb48-81"><a href="msm_chapter.html#cb48-81" tabindex="-1"></a>msm1 <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y_death <span class="sc">~</span> A0_PM2<span class="fl">.5</span> <span class="sc">+</span> L0_male <span class="sc">+</span> A0_PM2<span class="fl">.5</span><span class="sc">*</span>L0_male,</span>
<span id="cb48-82"><a href="msm_chapter.html#cb48-82" tabindex="-1"></a>           <span class="at">weights =</span> w,</span>
<span id="cb48-83"><a href="msm_chapter.html#cb48-83" tabindex="-1"></a>           <span class="at">family =</span> <span class="st">&quot;gaussian&quot;</span>,</span>
<span id="cb48-84"><a href="msm_chapter.html#cb48-84" tabindex="-1"></a>           <span class="at">data =</span> df1_int)</span>
<span id="cb48-85"><a href="msm_chapter.html#cb48-85" tabindex="-1"></a><span class="fu">coef</span>(msm1)</span>
<span id="cb48-86"><a href="msm_chapter.html#cb48-86" tabindex="-1"></a><span class="co"># (Intercept)         A0_PM2.5          L0_male A0_PM2.5:L0_male</span></span>
<span id="cb48-87"><a href="msm_chapter.html#cb48-87" tabindex="-1"></a><span class="co">#  0.17573472       0.05883228       0.04598911       0.03077614</span></span>
<span id="cb48-88"><a href="msm_chapter.html#cb48-88" tabindex="-1"></a></span>
<span id="cb48-89"><a href="msm_chapter.html#cb48-89" tabindex="-1"></a>msm2 <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y_death <span class="sc">~</span> A0_PM2<span class="fl">.5</span> <span class="sc">+</span> L0_male <span class="sc">+</span> A0_PM2<span class="fl">.5</span><span class="sc">*</span>L0_male,</span>
<span id="cb48-90"><a href="msm_chapter.html#cb48-90" tabindex="-1"></a>            <span class="at">weights =</span> sw,</span>
<span id="cb48-91"><a href="msm_chapter.html#cb48-91" tabindex="-1"></a>            <span class="at">family =</span> <span class="st">&quot;gaussian&quot;</span>,</span>
<span id="cb48-92"><a href="msm_chapter.html#cb48-92" tabindex="-1"></a>            <span class="at">data =</span> df1_int)</span>
<span id="cb48-93"><a href="msm_chapter.html#cb48-93" tabindex="-1"></a><span class="fu">coef</span>(msm2)</span>
<span id="cb48-94"><a href="msm_chapter.html#cb48-94" tabindex="-1"></a><span class="co"># (Intercept)         A0_PM2.5          L0_male A0_PM2.5:L0_male</span></span>
<span id="cb48-95"><a href="msm_chapter.html#cb48-95" tabindex="-1"></a><span class="co">#  0.17573472       0.05883228       0.04598911       0.03077614</span></span>
<span id="cb48-96"><a href="msm_chapter.html#cb48-96" tabindex="-1"></a></span>
<span id="cb48-97"><a href="msm_chapter.html#cb48-97" tabindex="-1"></a><span class="do">## 5. Estimate the ATE stratified by sex</span></span>
<span id="cb48-98"><a href="msm_chapter.html#cb48-98" tabindex="-1"></a><span class="co"># According to MSM1 (with simple weights)</span></span>
<span id="cb48-99"><a href="msm_chapter.html#cb48-99" tabindex="-1"></a>ATE.msm1.male0 <span class="ot">&lt;-</span> <span class="fu">coef</span>(msm1)[<span class="st">&quot;A0_PM2.5&quot;</span>]</span>
<span id="cb48-100"><a href="msm_chapter.html#cb48-100" tabindex="-1"></a><span class="co"># 0.05883228</span></span>
<span id="cb48-101"><a href="msm_chapter.html#cb48-101" tabindex="-1"></a>ATE.msm1.male1 <span class="ot">&lt;-</span> <span class="fu">coef</span>(msm1)[<span class="st">&quot;A0_PM2.5&quot;</span>] <span class="sc">+</span> <span class="fu">coef</span>(msm1)[<span class="st">&quot;A0_PM2.5:L0_male&quot;</span>]</span>
<span id="cb48-102"><a href="msm_chapter.html#cb48-102" tabindex="-1"></a><span class="co"># 0.08960842</span></span>
<span id="cb48-103"><a href="msm_chapter.html#cb48-103" tabindex="-1"></a></span>
<span id="cb48-104"><a href="msm_chapter.html#cb48-104" tabindex="-1"></a><span class="co"># According to the MSM2 (with stabilized weights)</span></span>
<span id="cb48-105"><a href="msm_chapter.html#cb48-105" tabindex="-1"></a>ATE.msm2.male0 <span class="ot">&lt;-</span> <span class="fu">coef</span>(msm2)[<span class="st">&quot;A0_PM2.5&quot;</span>]</span>
<span id="cb48-106"><a href="msm_chapter.html#cb48-106" tabindex="-1"></a><span class="co"># 0.05883228</span></span>
<span id="cb48-107"><a href="msm_chapter.html#cb48-107" tabindex="-1"></a>ATE.msm2.male1 <span class="ot">&lt;-</span> <span class="fu">coef</span>(msm2)[<span class="st">&quot;A0_PM2.5&quot;</span>] <span class="sc">+</span> <span class="fu">coef</span>(msm2)[<span class="st">&quot;A0_PM2.5:L0_male&quot;</span>]</span>
<span id="cb48-108"><a href="msm_chapter.html#cb48-108" tabindex="-1"></a><span class="co"># 0.08960842</span></span>
<span id="cb48-109"><a href="msm_chapter.html#cb48-109" tabindex="-1"></a><span class="co"># The results are the same because there is no violation of the positivity assumption</span></span>
<span id="cb48-110"><a href="msm_chapter.html#cb48-110" tabindex="-1"></a><span class="co"># In case of positivity violation, stabilized weights would give more accurate estimates</span></span></code></pre></div>
<p>The ATE estimates of death probability using an MSM estimated by IPTW are respectively +5.9% in women and +9.0% in men.</p>
<p>95% confidence intervals can be calculated by bootstrap.</p>
<p>Note: Using the true data generating model used to simulate the illustrative datasets, the “true” value of the ATE stratified by sex can be calculated:</p>
<ul>
<li><p>the “true” <span class="math inline">\((ATE \mid L_\text{male}(0) = 0) = 0.0688\)</span> in women,</p></li>
<li><p>the “true” <span class="math inline">\((ATE \mid L_\text{male}(0) = 1) = 0.0703\)</span> in men.</p></li>
</ul>
</div>
<div id="estimation-of-the-msm-coefficients-by-g-computation-imputation" class="section level3 hasAnchor" number="8.1.3">
<h3><span class="header-section-number">8.1.3</span> Estimation of the MSM coefficients by G-computation (imputation)<a href="msm_chapter.html#estimation-of-the-msm-coefficients-by-g-computation-imputation" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We can also use a G-computation (sometimes described as an imputation) approach to estimate the coefficients of an MSM.</p>
<p>The following steps can be applied:</p>
<ol style="list-style-type: decimal">
<li><p>Fit a (logistic or a linear) regression to estimate <span class="math inline">\(\overline{Q} = \mathbb{E}(Y \mid A, L(0))\)</span></p></li>
<li><p>Use this estimate to predict an outcome for each subject under the counterfactual scenarios <span class="math inline">\(\hat{\overline{Q}}(A=0)_i\)</span> and <span class="math inline">\(\hat{\overline{Q}}(A=1)_i\)</span>, by evaluating the regression fit <span class="math inline">\(\overline{Q}\)</span> at <span class="math inline">\(A=0\)</span> and <span class="math inline">\(A=1\)</span> respectively</p></li>
<li><p>Duplicate the initial dataset in a single long dataset in which:</p></li>
</ol>
<ul>
<li>the first half of the long dataset corresponds to the first counterfactual scenario with <span class="math inline">\(A=0\)</span> for all individuals and an additional column for the predicted counterfactual outcome <span class="math inline">\(\hat{\overline{Q}}(A=0)\)</span> ;</li>
<li>the second half of the long dataset corresponds to the second counterfactual scenario with <span class="math inline">\(A=1\)</span> for all individuals and <span class="math inline">\(\hat{\overline{Q}}(A=1)\)</span> for the predicted counterfactual column.</li>
</ul>
<ol start="4" style="list-style-type: decimal">
<li>Fit the MSM <span class="math inline">\(\mathbb{E}\left[Y_a \mid L_\text{male}(0)\right]\)</span> using the long dataset.</li>
</ol>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="msm_chapter.html#cb49-1" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list=</span><span class="fu">ls</span>())</span>
<span id="cb49-2"><a href="msm_chapter.html#cb49-2" tabindex="-1"></a>df1_int <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="st">&quot;data/df1_int.csv&quot;</span>)</span>
<span id="cb49-3"><a href="msm_chapter.html#cb49-3" tabindex="-1"></a></span>
<span id="cb49-4"><a href="msm_chapter.html#cb49-4" tabindex="-1"></a><span class="do">## 1. Estimate Qbar</span></span>
<span id="cb49-5"><a href="msm_chapter.html#cb49-5" tabindex="-1"></a>Q.tot.death <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y_death <span class="sc">~</span> A0_PM2<span class="fl">.5</span> <span class="sc">+</span> L0_male <span class="sc">+</span> L0_soc_env,</span>
<span id="cb49-6"><a href="msm_chapter.html#cb49-6" tabindex="-1"></a>                   <span class="at">family =</span> <span class="st">&quot;gaussian&quot;</span>, <span class="at">data =</span> df1_int)</span>
<span id="cb49-7"><a href="msm_chapter.html#cb49-7" tabindex="-1"></a><span class="co"># The final result would be sligthly different if we apply a binomial family.</span></span>
<span id="cb49-8"><a href="msm_chapter.html#cb49-8" tabindex="-1"></a></span>
<span id="cb49-9"><a href="msm_chapter.html#cb49-9" tabindex="-1"></a><span class="do">## 2. Predict an outcome for each subject, in 2 counterfactual scenarios </span></span>
<span id="cb49-10"><a href="msm_chapter.html#cb49-10" tabindex="-1"></a><span class="do">##    setting A=0 and A=1</span></span>
<span id="cb49-11"><a href="msm_chapter.html#cb49-11" tabindex="-1"></a><span class="co"># prepare data sets used to predict the outcome under the counterfactual</span></span>
<span id="cb49-12"><a href="msm_chapter.html#cb49-12" tabindex="-1"></a><span class="co"># scenarios setting A=0 and A=1</span></span>
<span id="cb49-13"><a href="msm_chapter.html#cb49-13" tabindex="-1"></a>data.A1 <span class="ot">&lt;-</span> data.A0 <span class="ot">&lt;-</span> df1_int</span>
<span id="cb49-14"><a href="msm_chapter.html#cb49-14" tabindex="-1"></a>data.A1<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb49-15"><a href="msm_chapter.html#cb49-15" tabindex="-1"></a>data.A0<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb49-16"><a href="msm_chapter.html#cb49-16" tabindex="-1"></a></span>
<span id="cb49-17"><a href="msm_chapter.html#cb49-17" tabindex="-1"></a><span class="co"># predict values under the same name in the corresponding counterfactual dataset</span></span>
<span id="cb49-18"><a href="msm_chapter.html#cb49-18" tabindex="-1"></a>data.A1<span class="sc">$</span>Ya.death.pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(Q.tot.death, <span class="at">newdata =</span> data.A1, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb49-19"><a href="msm_chapter.html#cb49-19" tabindex="-1"></a>data.A0<span class="sc">$</span>Ya.death.pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(Q.tot.death, <span class="at">newdata =</span> data.A0, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb49-20"><a href="msm_chapter.html#cb49-20" tabindex="-1"></a></span>
<span id="cb49-21"><a href="msm_chapter.html#cb49-21" tabindex="-1"></a><span class="do">## 3. Append both counterfactual datasets in a single long dataset</span></span>
<span id="cb49-22"><a href="msm_chapter.html#cb49-22" tabindex="-1"></a><span class="co"># (the number of row is twice the initial number of row because there are 2 </span></span>
<span id="cb49-23"><a href="msm_chapter.html#cb49-23" tabindex="-1"></a><span class="co"># counterfactual scenarios)</span></span>
<span id="cb49-24"><a href="msm_chapter.html#cb49-24" tabindex="-1"></a>data<span class="fl">.2</span>scenarios <span class="ot">&lt;-</span> <span class="fu">rbind</span>(data.A0, data.A1)</span>
<span id="cb49-25"><a href="msm_chapter.html#cb49-25" tabindex="-1"></a></span>
<span id="cb49-26"><a href="msm_chapter.html#cb49-26" tabindex="-1"></a><span class="do">## 4. fit the MSM: E(Y_a|sex)</span></span>
<span id="cb49-27"><a href="msm_chapter.html#cb49-27" tabindex="-1"></a><span class="co"># a GLM with gaussian family can be applied to estimate risk differences</span></span>
<span id="cb49-28"><a href="msm_chapter.html#cb49-28" tabindex="-1"></a>MSM.ATE.gcomp <span class="ot">&lt;-</span> <span class="fu">glm</span>(Ya.death.pred <span class="sc">~</span> A0_PM2<span class="fl">.5</span> <span class="sc">+</span> L0_male <span class="sc">+</span> A0_PM2<span class="fl">.5</span><span class="sc">:</span>L0_male,</span>
<span id="cb49-29"><a href="msm_chapter.html#cb49-29" tabindex="-1"></a>                     <span class="at">family =</span> <span class="st">&quot;gaussian&quot;</span>,</span>
<span id="cb49-30"><a href="msm_chapter.html#cb49-30" tabindex="-1"></a>                     <span class="at">data =</span> data<span class="fl">.2</span>scenarios)</span>
<span id="cb49-31"><a href="msm_chapter.html#cb49-31" tabindex="-1"></a><span class="fu">coef</span>(MSM.ATE.gcomp)</span>
<span id="cb49-32"><a href="msm_chapter.html#cb49-32" tabindex="-1"></a><span class="co">#  (Intercept)         A0_PM2.5          L0_male A0_PM2.5:L0_male </span></span>
<span id="cb49-33"><a href="msm_chapter.html#cb49-33" tabindex="-1"></a><span class="co"># 1.743994e-01     7.720726e-02     4.874750e-02     5.087110e-16</span></span>
<span id="cb49-34"><a href="msm_chapter.html#cb49-34" tabindex="-1"></a></span>
<span id="cb49-35"><a href="msm_chapter.html#cb49-35" tabindex="-1"></a><span class="do">## 5. Estimate the ATE stratified by sex</span></span>
<span id="cb49-36"><a href="msm_chapter.html#cb49-36" tabindex="-1"></a><span class="co"># According to MSM.ATE.gcomp</span></span>
<span id="cb49-37"><a href="msm_chapter.html#cb49-37" tabindex="-1"></a>ATE.MSM.gcomp.male0 <span class="ot">&lt;-</span> <span class="fu">coef</span>(MSM.ATE.gcomp)[<span class="st">&quot;A0_PM2.5&quot;</span>]</span>
<span id="cb49-38"><a href="msm_chapter.html#cb49-38" tabindex="-1"></a><span class="co"># 0.07720726</span></span>
<span id="cb49-39"><a href="msm_chapter.html#cb49-39" tabindex="-1"></a>ATE.MSM.gcomp.male1 <span class="ot">&lt;-</span> (<span class="fu">coef</span>(MSM.ATE.gcomp)[<span class="st">&quot;A0_PM2.5&quot;</span>] <span class="sc">+</span></span>
<span id="cb49-40"><a href="msm_chapter.html#cb49-40" tabindex="-1"></a>                          <span class="fu">coef</span>(MSM.ATE.gcomp)[<span class="st">&quot;A0_PM2.5:L0_male&quot;</span>])</span>
<span id="cb49-41"><a href="msm_chapter.html#cb49-41" tabindex="-1"></a><span class="co"># 0.07720726</span></span>
<span id="cb49-42"><a href="msm_chapter.html#cb49-42" tabindex="-1"></a><span class="co"># The results are the same in both strata, because in the first Qbar model,</span></span>
<span id="cb49-43"><a href="msm_chapter.html#cb49-43" tabindex="-1"></a><span class="co"># we did not include any (A * sex) interaction term</span></span>
<span id="cb49-44"><a href="msm_chapter.html#cb49-44" tabindex="-1"></a></span>
<span id="cb49-45"><a href="msm_chapter.html#cb49-45" tabindex="-1"></a><span class="co"># Applying a binomial family for the first Qbar model would result in two</span></span>
<span id="cb49-46"><a href="msm_chapter.html#cb49-46" tabindex="-1"></a><span class="co"># different values of the ATE stratified by sex.</span></span>
<span id="cb49-47"><a href="msm_chapter.html#cb49-47" tabindex="-1"></a><span class="co"># =&gt; 0.06880798 in the L0_male = 0 strata</span></span>
<span id="cb49-48"><a href="msm_chapter.html#cb49-48" tabindex="-1"></a><span class="co"># =&gt; 0.08053575 in the L0_male = 1 strata</span></span>
<span id="cb49-49"><a href="msm_chapter.html#cb49-49" tabindex="-1"></a></span>
<span id="cb49-50"><a href="msm_chapter.html#cb49-50" tabindex="-1"></a><span class="co"># Comments: For the estimation of the first Qbar model, applying a gaussian family </span></span>
<span id="cb49-51"><a href="msm_chapter.html#cb49-51" tabindex="-1"></a><span class="co"># (additive model) with no interaction terms implies the presence of some interaction </span></span>
<span id="cb49-52"><a href="msm_chapter.html#cb49-52" tabindex="-1"></a><span class="co"># terms in a multiplicative model (such as a glm with a binomial family).</span></span>
<span id="cb49-53"><a href="msm_chapter.html#cb49-53" tabindex="-1"></a><span class="co"># On the contrary, applying a binomial family (multiplicative model) with no</span></span>
<span id="cb49-54"><a href="msm_chapter.html#cb49-54" tabindex="-1"></a><span class="co"># interaction terms implies some interaction terms in an additive model (such as</span></span>
<span id="cb49-55"><a href="msm_chapter.html#cb49-55" tabindex="-1"></a><span class="co"># a glm with a gaussian family)</span></span></code></pre></div>
</div>
</div>
<div id="msm_CDE_paragraph" class="section level2 hasAnchor" number="8.2">
<h2><span class="header-section-number">8.2</span> MSM for Controlled Direct Effects<a href="msm_chapter.html#msm_CDE_paragraph" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="expressing-the-cde-using-coefficients-of-an-msm" class="section level3 hasAnchor" number="8.2.1">
<h3><span class="header-section-number">8.2.1</span> Expressing the CDE using coefficients of an MSM<a href="msm_chapter.html#expressing-the-cde-using-coefficients-of-an-msm" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The controlled direct effect is defined as <span class="math inline">\(\text{CDE}_m= \mathbb{E}(Y_{am}) - \mathbb{E}(Y_{a^*m})\)</span>.</p>
<p>Using the following MSM
<span class="math display" id="eq:MSMCDE">\[\begin{equation}
  \mathbb{E}(Y_{am}) = \alpha_0 + \alpha_A a + \alpha_M m + \alpha_{A \ast M} a \times m
  \tag{8.4}
\end{equation}\]</span>
the controlled direct effect (keeping the mediator constant to the value <span class="math inline">\(M=m\)</span>) can be expressed using the coefficients of the MSM <a href="msm_chapter.html#eq:MSMCDE">(8.4)</a>:
<span class="math display">\[\begin{align*}
  \text{CDE}_m &amp;= (\alpha_0 + \alpha_A a + \alpha_M m + \alpha_{A \ast M} a \times m) - (\alpha_0 + \alpha_A a^* + \alpha_M m + \alpha_{A \ast M} a^* \times m) \\
  \text{CDE}_m &amp;= \alpha_A(a - a^* ) + \alpha_{A \ast M} \times (a - a^*) \times m
\end{align*}\]</span>
For a binary exposure <span class="math inline">\(A\)</span>, we have <span class="math inline">\(\text{CDE}_m=\alpha_A + \alpha_{A \ast M} \times m\)</span>.</p>
</div>
<div id="estimation-of-the-msm-coefficients-by-iptw-1" class="section level3 hasAnchor" number="8.2.2">
<h3><span class="header-section-number">8.2.2</span> Estimation of the MSM coefficients by IPTW<a href="msm_chapter.html#estimation-of-the-msm-coefficients-by-iptw-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>MSM coefficients can be easily estimated using an Inverse Probability of Treatment (IPTW) approach based on weighted regressions.</p>
<p>In order to fit the MSM <a href="msm_chapter.html#eq:MSMCDE">(8.4)</a>, we can use a linear regression of the (observed) outcome <span class="math inline">\(Y\)</span> on the exposure and mediator, weighted by individual stabilized weights <span class="math inline">\(sw_i\)</span> (<span class="citation">(<a href="#ref-vanderweele2009">VanderWeele 2009</a>)</span>):
<span class="math display">\[\begin{equation}
  \mathbb{E}\left(Y \mid A,M\right) = \alpha_0 + \alpha_A a + \alpha_M m + \alpha_{A \ast M} a \times m
\end{equation}\]</span></p>
<p>where <span class="math inline">\(sw_i\)</span> is the product of two weights <span class="math inline">\(sw_i = sw_{A,i} \times sw_{M,i}\)</span>,</p>
<p><span class="math inline">\(sw_{A,i}=\frac{P(A=a_i)}{P(A=a_i \mid L(0)=l(0)_i)}\)</span> and <span class="math inline">\(sw_{M,i}=\frac{P(M=m_i \mid A=a_i)}{P(M = m_i \mid A=a_i,L(0)=l(0)_i), L(1)=l(1)_i}\)</span>.</p>
<p>The “no-unmeasured confounding” assumption is addressed by the application of weights <span class="math inline">\(sw_i\)</span>, which balances confounders <span class="math inline">\(L(0)\)</span> relative to the exposure-outcome <span class="math inline">\(A-Y\)</span> relationship, and balance the set of confounders <span class="math inline">\(\{L(0),A,L(1)\}\)</span> relative to the mediator-outcome <span class="math inline">\(M-Y\)</span> relationship.</p>
<div id="example-1-with-no-intermediate-confounder-affected-by-the-exposure" class="section level4 hasAnchor" number="8.2.2.1">
<h4><span class="header-section-number">8.2.2.1</span> Example 1, with no intermediate confounder affected by the exposure<a href="msm_chapter.html#example-1-with-no-intermediate-confounder-affected-by-the-exposure" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="msm_chapter.html#cb50-1" tabindex="-1"></a><span class="do">### MSM of CDE, estimated by IPTW ----------------------------------------------</span></span>
<span id="cb50-2"><a href="msm_chapter.html#cb50-2" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list=</span><span class="fu">ls</span>())</span>
<span id="cb50-3"><a href="msm_chapter.html#cb50-3" tabindex="-1"></a>df1_int <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="st">&quot;data/df1_int.csv&quot;</span>)</span>
<span id="cb50-4"><a href="msm_chapter.html#cb50-4" tabindex="-1"></a></span>
<span id="cb50-5"><a href="msm_chapter.html#cb50-5" tabindex="-1"></a><span class="do">## 1. Stabilized weight for the exposure sw_{A,i}</span></span>
<span id="cb50-6"><a href="msm_chapter.html#cb50-6" tabindex="-1"></a><span class="co"># 1a. Estimate g(A=a_i|L(0)) (denominator of the weight)</span></span>
<span id="cb50-7"><a href="msm_chapter.html#cb50-7" tabindex="-1"></a>g.A.L <span class="ot">&lt;-</span> <span class="fu">glm</span>(A0_PM2<span class="fl">.5</span> <span class="sc">~</span> L0_male <span class="sc">+</span> L0_soc_env,</span>
<span id="cb50-8"><a href="msm_chapter.html#cb50-8" tabindex="-1"></a>             <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>, <span class="at">data =</span> df1_int)</span>
<span id="cb50-9"><a href="msm_chapter.html#cb50-9" tabindex="-1"></a><span class="co"># 1b. Predict each individual&#39;s probability of being exposed to her own exposure</span></span>
<span id="cb50-10"><a href="msm_chapter.html#cb50-10" tabindex="-1"></a><span class="co"># the predicted probability of the observed treatment g(A = a_i | L(0)) is :</span></span>
<span id="cb50-11"><a href="msm_chapter.html#cb50-11" tabindex="-1"></a>gAi.L <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">nrow</span>(df1_int))</span>
<span id="cb50-12"><a href="msm_chapter.html#cb50-12" tabindex="-1"></a>gAi.L[df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">predict</span>(g.A.L, <span class="at">type=</span><span class="st">&quot;response&quot;</span>)[df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">1</span>]</span>
<span id="cb50-13"><a href="msm_chapter.html#cb50-13" tabindex="-1"></a>gAi.L[df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">0</span>] <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="fu">predict</span>(g.A.L, <span class="at">type=</span><span class="st">&quot;response&quot;</span>))[df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">0</span>]</span>
<span id="cb50-14"><a href="msm_chapter.html#cb50-14" tabindex="-1"></a></span>
<span id="cb50-15"><a href="msm_chapter.html#cb50-15" tabindex="-1"></a><span class="co"># 1c. Estimate g(A=a_i) (numerator of the weight)</span></span>
<span id="cb50-16"><a href="msm_chapter.html#cb50-16" tabindex="-1"></a>g.A <span class="ot">&lt;-</span> <span class="fu">glm</span>(A0_PM2<span class="fl">.5</span> <span class="sc">~</span> <span class="dv">1</span>, <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>, <span class="at">data =</span> df1_int)</span>
<span id="cb50-17"><a href="msm_chapter.html#cb50-17" tabindex="-1"></a><span class="co"># 1d. Predict each individual&#39;s probability of being exposed to her own exposure</span></span>
<span id="cb50-18"><a href="msm_chapter.html#cb50-18" tabindex="-1"></a><span class="co"># the predicted probability of the observed treatment g(A = a_i) is :</span></span>
<span id="cb50-19"><a href="msm_chapter.html#cb50-19" tabindex="-1"></a>gAi <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">nrow</span>(df1_int))</span>
<span id="cb50-20"><a href="msm_chapter.html#cb50-20" tabindex="-1"></a>gAi[df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">predict</span>(g.A, <span class="at">type=</span><span class="st">&quot;response&quot;</span>)[df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">1</span>]</span>
<span id="cb50-21"><a href="msm_chapter.html#cb50-21" tabindex="-1"></a>gAi[df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">0</span>] <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="fu">predict</span>(g.A, <span class="at">type=</span><span class="st">&quot;response&quot;</span>))[df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">0</span>]</span>
<span id="cb50-22"><a href="msm_chapter.html#cb50-22" tabindex="-1"></a></span>
<span id="cb50-23"><a href="msm_chapter.html#cb50-23" tabindex="-1"></a><span class="co"># 1e. Calculate the weight for the exposure A: sw_{A,i}</span></span>
<span id="cb50-24"><a href="msm_chapter.html#cb50-24" tabindex="-1"></a>sw_Ai <span class="ot">&lt;-</span> gAi <span class="sc">/</span> gAi.L</span>
<span id="cb50-25"><a href="msm_chapter.html#cb50-25" tabindex="-1"></a></span>
<span id="cb50-26"><a href="msm_chapter.html#cb50-26" tabindex="-1"></a><span class="do">## 2. Stabilized weight for the mediator sw_{M,i}</span></span>
<span id="cb50-27"><a href="msm_chapter.html#cb50-27" tabindex="-1"></a><span class="co"># 2a. Estimate g(M=m_i|L(0),A,L(1)) (denominator of the weight)</span></span>
<span id="cb50-28"><a href="msm_chapter.html#cb50-28" tabindex="-1"></a>g.M.L <span class="ot">&lt;-</span> <span class="fu">glm</span>(M_diabetes <span class="sc">~</span> L0_male <span class="sc">+</span> L0_soc_env <span class="sc">+</span> A0_PM2<span class="fl">.5</span> <span class="sc">+</span> L1,</span>
<span id="cb50-29"><a href="msm_chapter.html#cb50-29" tabindex="-1"></a>             <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>, <span class="at">data =</span> df1_int)</span>
<span id="cb50-30"><a href="msm_chapter.html#cb50-30" tabindex="-1"></a><span class="co"># 2b. Predict each individual&#39;s probability of being exposed to her own exposure</span></span>
<span id="cb50-31"><a href="msm_chapter.html#cb50-31" tabindex="-1"></a><span class="co"># the predicted probability of the observed treatment g(A = a_i | L(0)) is :</span></span>
<span id="cb50-32"><a href="msm_chapter.html#cb50-32" tabindex="-1"></a>gMi.L <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">nrow</span>(df1_int))</span>
<span id="cb50-33"><a href="msm_chapter.html#cb50-33" tabindex="-1"></a>gMi.L[df1_int<span class="sc">$</span>M_diabetes<span class="sc">==</span><span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">predict</span>(g.M.L, <span class="at">type=</span><span class="st">&quot;response&quot;</span>)[df1_int<span class="sc">$</span>M_diabetes<span class="sc">==</span><span class="dv">1</span>]</span>
<span id="cb50-34"><a href="msm_chapter.html#cb50-34" tabindex="-1"></a>gMi.L[df1_int<span class="sc">$</span>M_diabetes<span class="sc">==</span><span class="dv">0</span>] <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="fu">predict</span>(g.M.L, <span class="at">type=</span><span class="st">&quot;response&quot;</span>))[df1_int<span class="sc">$</span>M_diabetes<span class="sc">==</span><span class="dv">0</span>]</span>
<span id="cb50-35"><a href="msm_chapter.html#cb50-35" tabindex="-1"></a></span>
<span id="cb50-36"><a href="msm_chapter.html#cb50-36" tabindex="-1"></a><span class="co"># 2c. Estimate g(M=m_i|A) (numerator of the weight)</span></span>
<span id="cb50-37"><a href="msm_chapter.html#cb50-37" tabindex="-1"></a>g.M.A <span class="ot">&lt;-</span> <span class="fu">glm</span>(M_diabetes <span class="sc">~</span> A0_PM2<span class="fl">.5</span>, <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>, <span class="at">data =</span> df1_int)</span>
<span id="cb50-38"><a href="msm_chapter.html#cb50-38" tabindex="-1"></a><span class="co"># 2d. Predict each individual&#39;s probability of being exposed to her own exposure</span></span>
<span id="cb50-39"><a href="msm_chapter.html#cb50-39" tabindex="-1"></a><span class="co"># the predicted probability of the observed treatment g(M = m_i|A) is :</span></span>
<span id="cb50-40"><a href="msm_chapter.html#cb50-40" tabindex="-1"></a>gMi.A <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">nrow</span>(df1_int))</span>
<span id="cb50-41"><a href="msm_chapter.html#cb50-41" tabindex="-1"></a>gMi.A[df1_int<span class="sc">$</span>M_diabetes<span class="sc">==</span><span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">predict</span>(g.M.A, <span class="at">type=</span><span class="st">&quot;response&quot;</span>)[df1_int<span class="sc">$</span>M_diabetes<span class="sc">==</span><span class="dv">1</span>]</span>
<span id="cb50-42"><a href="msm_chapter.html#cb50-42" tabindex="-1"></a>gMi.A[df1_int<span class="sc">$</span>M_diabetes<span class="sc">==</span><span class="dv">0</span>] <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="fu">predict</span>(g.M.A, <span class="at">type=</span><span class="st">&quot;response&quot;</span>))[df1_int<span class="sc">$</span>M_diabetes<span class="sc">==</span><span class="dv">0</span>]</span>
<span id="cb50-43"><a href="msm_chapter.html#cb50-43" tabindex="-1"></a><span class="co"># 2e. Calculate the weight for the mediator M: sw_{M,i}</span></span>
<span id="cb50-44"><a href="msm_chapter.html#cb50-44" tabindex="-1"></a>sw_Mi <span class="ot">&lt;-</span> gMi.A <span class="sc">/</span> gMi.L</span>
<span id="cb50-45"><a href="msm_chapter.html#cb50-45" tabindex="-1"></a></span>
<span id="cb50-46"><a href="msm_chapter.html#cb50-46" tabindex="-1"></a><span class="do">## 3. Define the individual stabilized weight for the CDE_m</span></span>
<span id="cb50-47"><a href="msm_chapter.html#cb50-47" tabindex="-1"></a>sw_cde <span class="ot">&lt;-</span> sw_Ai <span class="sc">*</span> sw_Mi</span>
<span id="cb50-48"><a href="msm_chapter.html#cb50-48" tabindex="-1"></a></span>
<span id="cb50-49"><a href="msm_chapter.html#cb50-49" tabindex="-1"></a><span class="do">## 4. Estimate coefficients of the MSM using a weighted regression E(Y | A, sex)</span></span>
<span id="cb50-50"><a href="msm_chapter.html#cb50-50" tabindex="-1"></a><span class="co"># a GLM with gaussian family can be applied to estimate risk differences</span></span>
<span id="cb50-51"><a href="msm_chapter.html#cb50-51" tabindex="-1"></a>msm_cde <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y_death <span class="sc">~</span> A0_PM2<span class="fl">.5</span> <span class="sc">+</span> M_diabetes <span class="sc">+</span> A0_PM2<span class="fl">.5</span><span class="sc">*</span>M_diabetes,</span>
<span id="cb50-52"><a href="msm_chapter.html#cb50-52" tabindex="-1"></a>               <span class="at">weights =</span> sw_cde,</span>
<span id="cb50-53"><a href="msm_chapter.html#cb50-53" tabindex="-1"></a>               <span class="at">family =</span> <span class="st">&quot;gaussian&quot;</span>,</span>
<span id="cb50-54"><a href="msm_chapter.html#cb50-54" tabindex="-1"></a>               <span class="at">data =</span> df1_int)</span>
<span id="cb50-55"><a href="msm_chapter.html#cb50-55" tabindex="-1"></a><span class="fu">coef</span>(msm_cde)</span>
<span id="cb50-56"><a href="msm_chapter.html#cb50-56" tabindex="-1"></a><span class="co"># (Intercept)            A0_PM2.5          M_diabetes A0_PM2.5:M_diabetes </span></span>
<span id="cb50-57"><a href="msm_chapter.html#cb50-57" tabindex="-1"></a><span class="co">#  0.17891689          0.06798282          0.06729724         -0.00495314</span></span>
<span id="cb50-58"><a href="msm_chapter.html#cb50-58" tabindex="-1"></a></span>
<span id="cb50-59"><a href="msm_chapter.html#cb50-59" tabindex="-1"></a><span class="do">## 5. Estimate CDE for m=0 and for m=1 using the MSM&#39;s coefficients</span></span>
<span id="cb50-60"><a href="msm_chapter.html#cb50-60" tabindex="-1"></a>CDE_mis0 <span class="ot">&lt;-</span> <span class="fu">coef</span>(msm_cde)[<span class="st">&quot;A0_PM2.5&quot;</span>]</span>
<span id="cb50-61"><a href="msm_chapter.html#cb50-61" tabindex="-1"></a><span class="co"># 0.06798282</span></span>
<span id="cb50-62"><a href="msm_chapter.html#cb50-62" tabindex="-1"></a>CDE_mis1 <span class="ot">&lt;-</span> <span class="fu">coef</span>(msm_cde)[<span class="st">&quot;A0_PM2.5&quot;</span>] <span class="sc">+</span> <span class="fu">coef</span>(msm_cde)[<span class="st">&quot;A0_PM2.5:M_diabetes&quot;</span>]</span>
<span id="cb50-63"><a href="msm_chapter.html#cb50-63" tabindex="-1"></a><span class="co"># 0.06302968</span></span></code></pre></div>
<p>In this example, our estimates of the controlled direct effects are <span class="math inline">\(CDE_{M=0} = 6.8\%\)</span> and <span class="math inline">\(CDE_{M=1} = 6.3\%\)</span>. Confidence intervals can be calculated by bootstrap.</p>
<p>Importantly, this approach for the estimation of the controlled direct effect <span class="math inline">\(\text{CDE}_m\)</span> by IPTW is also valid if the exposure <span class="math inline">\(A\)</span> affects the intermediate confounder <span class="math inline">\(L(1)\)</span> (as with the Causal model 2).</p>
</div>
<div id="example-2-with-intermediate-confounder-affected-by-the-exposure" class="section level4 hasAnchor" number="8.2.2.2">
<h4><span class="header-section-number">8.2.2.2</span> Example 2, with intermediate confounder affected by the exposure<a href="msm_chapter.html#example-2-with-intermediate-confounder-affected-by-the-exposure" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Below, we estimate the CDE by hand, and using the <code>ltmle</code> package and the <code>CMAverse</code> package</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="msm_chapter.html#cb51-1" tabindex="-1"></a><span class="do">### MSM of CDE, estimated by IPTW</span></span>
<span id="cb51-2"><a href="msm_chapter.html#cb51-2" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list=</span><span class="fu">ls</span>())</span>
<span id="cb51-3"><a href="msm_chapter.html#cb51-3" tabindex="-1"></a>df2_int <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="st">&quot;data/df2_int.csv&quot;</span>)</span>
<span id="cb51-4"><a href="msm_chapter.html#cb51-4" tabindex="-1"></a></span>
<span id="cb51-5"><a href="msm_chapter.html#cb51-5" tabindex="-1"></a><span class="do">## 1. Stabilized weight for the exposure sw_{A,i}</span></span>
<span id="cb51-6"><a href="msm_chapter.html#cb51-6" tabindex="-1"></a><span class="co"># 1a. Estimate g(A=a_i|L(0)) (denominator of the weight)</span></span>
<span id="cb51-7"><a href="msm_chapter.html#cb51-7" tabindex="-1"></a>g.A.L <span class="ot">&lt;-</span> <span class="fu">glm</span>(A0_PM2<span class="fl">.5</span> <span class="sc">~</span> L0_male <span class="sc">+</span> L0_soc_env,</span>
<span id="cb51-8"><a href="msm_chapter.html#cb51-8" tabindex="-1"></a>             <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>, <span class="at">data =</span> df2_int)</span>
<span id="cb51-9"><a href="msm_chapter.html#cb51-9" tabindex="-1"></a><span class="co"># 1b. Predict each individual&#39;s probability of being exposed to her own exposure</span></span>
<span id="cb51-10"><a href="msm_chapter.html#cb51-10" tabindex="-1"></a><span class="co"># the predicted probability of the observed treatment g(A = a_i | L(0)) is :</span></span>
<span id="cb51-11"><a href="msm_chapter.html#cb51-11" tabindex="-1"></a>gAi.L <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">nrow</span>(df2_int))</span>
<span id="cb51-12"><a href="msm_chapter.html#cb51-12" tabindex="-1"></a>gAi.L[df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">predict</span>(g.A.L, <span class="at">type=</span><span class="st">&quot;response&quot;</span>)[df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">1</span>]</span>
<span id="cb51-13"><a href="msm_chapter.html#cb51-13" tabindex="-1"></a>gAi.L[df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">0</span>] <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="fu">predict</span>(g.A.L, <span class="at">type=</span><span class="st">&quot;response&quot;</span>))[df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">0</span>]</span>
<span id="cb51-14"><a href="msm_chapter.html#cb51-14" tabindex="-1"></a></span>
<span id="cb51-15"><a href="msm_chapter.html#cb51-15" tabindex="-1"></a><span class="co"># 1c. Estimate g(A=a_i) (numerator of the weight)</span></span>
<span id="cb51-16"><a href="msm_chapter.html#cb51-16" tabindex="-1"></a>g.A <span class="ot">&lt;-</span> <span class="fu">glm</span>(A0_PM2<span class="fl">.5</span> <span class="sc">~</span> <span class="dv">1</span>, <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>, <span class="at">data =</span> df2_int)</span>
<span id="cb51-17"><a href="msm_chapter.html#cb51-17" tabindex="-1"></a><span class="co"># 1d. Predict each individual&#39;s probability of being exposed to her own exposure</span></span>
<span id="cb51-18"><a href="msm_chapter.html#cb51-18" tabindex="-1"></a><span class="co"># the predicted probability of the observed treatment g(A = a_i) is :</span></span>
<span id="cb51-19"><a href="msm_chapter.html#cb51-19" tabindex="-1"></a>gAi <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">nrow</span>(df2_int))</span>
<span id="cb51-20"><a href="msm_chapter.html#cb51-20" tabindex="-1"></a>gAi[df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">predict</span>(g.A, <span class="at">type=</span><span class="st">&quot;response&quot;</span>)[df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">1</span>]</span>
<span id="cb51-21"><a href="msm_chapter.html#cb51-21" tabindex="-1"></a>gAi[df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">0</span>] <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="fu">predict</span>(g.A, <span class="at">type=</span><span class="st">&quot;response&quot;</span>))[df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">0</span>]</span>
<span id="cb51-22"><a href="msm_chapter.html#cb51-22" tabindex="-1"></a></span>
<span id="cb51-23"><a href="msm_chapter.html#cb51-23" tabindex="-1"></a><span class="co"># 1e. Calculate the weight for the exposure A: sw_{A,i}</span></span>
<span id="cb51-24"><a href="msm_chapter.html#cb51-24" tabindex="-1"></a>sw_Ai <span class="ot">&lt;-</span> gAi <span class="sc">/</span> gAi.L</span>
<span id="cb51-25"><a href="msm_chapter.html#cb51-25" tabindex="-1"></a></span>
<span id="cb51-26"><a href="msm_chapter.html#cb51-26" tabindex="-1"></a><span class="do">## 2. Stabilized weight for the mediator sw_{M,i}</span></span>
<span id="cb51-27"><a href="msm_chapter.html#cb51-27" tabindex="-1"></a><span class="co"># 2a. Estimate g(M=m_i|L(0),A,L(1)) (denominator of the weight)</span></span>
<span id="cb51-28"><a href="msm_chapter.html#cb51-28" tabindex="-1"></a>g.M.L <span class="ot">&lt;-</span> <span class="fu">glm</span>(M_diabetes <span class="sc">~</span> L0_male <span class="sc">+</span> L0_soc_env <span class="sc">+</span> A0_PM2<span class="fl">.5</span> <span class="sc">+</span> L1,</span>
<span id="cb51-29"><a href="msm_chapter.html#cb51-29" tabindex="-1"></a>             <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>, <span class="at">data =</span> df2_int)</span>
<span id="cb51-30"><a href="msm_chapter.html#cb51-30" tabindex="-1"></a><span class="co"># 2b. Predict each individual&#39;s probability of being exposed to her own exposure</span></span>
<span id="cb51-31"><a href="msm_chapter.html#cb51-31" tabindex="-1"></a><span class="co"># the predicted probability of the observed treatment g(A = a_i | L(0)) is :</span></span>
<span id="cb51-32"><a href="msm_chapter.html#cb51-32" tabindex="-1"></a>gMi.L <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">nrow</span>(df2_int))</span>
<span id="cb51-33"><a href="msm_chapter.html#cb51-33" tabindex="-1"></a>gMi.L[df2_int<span class="sc">$</span>M_diabetes<span class="sc">==</span><span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">predict</span>(g.M.L, <span class="at">type=</span><span class="st">&quot;response&quot;</span>)[df2_int<span class="sc">$</span>M_diabetes<span class="sc">==</span><span class="dv">1</span>]</span>
<span id="cb51-34"><a href="msm_chapter.html#cb51-34" tabindex="-1"></a>gMi.L[df2_int<span class="sc">$</span>M_diabetes<span class="sc">==</span><span class="dv">0</span>] <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="fu">predict</span>(g.M.L, <span class="at">type=</span><span class="st">&quot;response&quot;</span>))[df2_int<span class="sc">$</span>M_diabetes<span class="sc">==</span><span class="dv">0</span>]</span>
<span id="cb51-35"><a href="msm_chapter.html#cb51-35" tabindex="-1"></a></span>
<span id="cb51-36"><a href="msm_chapter.html#cb51-36" tabindex="-1"></a><span class="co"># 2c. Estimate g(M=m_i|A) (numerator of the weight)</span></span>
<span id="cb51-37"><a href="msm_chapter.html#cb51-37" tabindex="-1"></a>g.M.A <span class="ot">&lt;-</span> <span class="fu">glm</span>(M_diabetes <span class="sc">~</span> A0_PM2<span class="fl">.5</span>, <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>, <span class="at">data =</span> df2_int)</span>
<span id="cb51-38"><a href="msm_chapter.html#cb51-38" tabindex="-1"></a><span class="co"># 2d. Predict each individual&#39;s probability of being exposed to her own exposure</span></span>
<span id="cb51-39"><a href="msm_chapter.html#cb51-39" tabindex="-1"></a><span class="co"># the predicted probability of the observed treatment g(M = m_i|A) is :</span></span>
<span id="cb51-40"><a href="msm_chapter.html#cb51-40" tabindex="-1"></a>gMi.A <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">nrow</span>(df2_int))</span>
<span id="cb51-41"><a href="msm_chapter.html#cb51-41" tabindex="-1"></a>gMi.A[df2_int<span class="sc">$</span>M_diabetes<span class="sc">==</span><span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">predict</span>(g.M.A, <span class="at">type=</span><span class="st">&quot;response&quot;</span>)[df2_int<span class="sc">$</span>M_diabetes<span class="sc">==</span><span class="dv">1</span>]</span>
<span id="cb51-42"><a href="msm_chapter.html#cb51-42" tabindex="-1"></a>gMi.A[df2_int<span class="sc">$</span>M_diabetes<span class="sc">==</span><span class="dv">0</span>] <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="fu">predict</span>(g.M.A, <span class="at">type=</span><span class="st">&quot;response&quot;</span>))[df2_int<span class="sc">$</span>M_diabetes<span class="sc">==</span><span class="dv">0</span>]</span>
<span id="cb51-43"><a href="msm_chapter.html#cb51-43" tabindex="-1"></a><span class="co"># 2e. Calculate the weight for the mediator M: sw_{M,i}</span></span>
<span id="cb51-44"><a href="msm_chapter.html#cb51-44" tabindex="-1"></a>sw_Mi <span class="ot">&lt;-</span> gMi.A <span class="sc">/</span> gMi.L</span>
<span id="cb51-45"><a href="msm_chapter.html#cb51-45" tabindex="-1"></a></span>
<span id="cb51-46"><a href="msm_chapter.html#cb51-46" tabindex="-1"></a><span class="do">## 3. Define the individual stabilized weight for the CDE_m</span></span>
<span id="cb51-47"><a href="msm_chapter.html#cb51-47" tabindex="-1"></a>sw_cde <span class="ot">&lt;-</span> sw_Ai <span class="sc">*</span> sw_Mi</span>
<span id="cb51-48"><a href="msm_chapter.html#cb51-48" tabindex="-1"></a></span>
<span id="cb51-49"><a href="msm_chapter.html#cb51-49" tabindex="-1"></a><span class="do">## 4. Estimate coefficients of the MSM using a weighted regression E(Y | A, sex)</span></span>
<span id="cb51-50"><a href="msm_chapter.html#cb51-50" tabindex="-1"></a><span class="co"># a GLM with gaussian family can be applied to estimate risk differences</span></span>
<span id="cb51-51"><a href="msm_chapter.html#cb51-51" tabindex="-1"></a>msm_cde <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y_death <span class="sc">~</span> A0_PM2<span class="fl">.5</span> <span class="sc">+</span> M_diabetes <span class="sc">+</span> A0_PM2<span class="fl">.5</span><span class="sc">*</span>M_diabetes,</span>
<span id="cb51-52"><a href="msm_chapter.html#cb51-52" tabindex="-1"></a>               <span class="at">weights =</span> sw_cde,</span>
<span id="cb51-53"><a href="msm_chapter.html#cb51-53" tabindex="-1"></a>               <span class="at">family =</span> <span class="st">&quot;gaussian&quot;</span>,</span>
<span id="cb51-54"><a href="msm_chapter.html#cb51-54" tabindex="-1"></a>               <span class="at">data =</span> df2_int)</span>
<span id="cb51-55"><a href="msm_chapter.html#cb51-55" tabindex="-1"></a><span class="fu">coef</span>(msm_cde)</span>
<span id="cb51-56"><a href="msm_chapter.html#cb51-56" tabindex="-1"></a><span class="co"># (Intercept)            A0_PM2.5          M_diabetes A0_PM2.5:M_diabetes</span></span>
<span id="cb51-57"><a href="msm_chapter.html#cb51-57" tabindex="-1"></a><span class="co">#  0.17932146          0.06012920          0.07239661          0.03017266</span></span>
<span id="cb51-58"><a href="msm_chapter.html#cb51-58" tabindex="-1"></a></span>
<span id="cb51-59"><a href="msm_chapter.html#cb51-59" tabindex="-1"></a><span class="do">## 5. Estimate CDE for m=0 and for m=1 using the MSM&#39;s coefficients</span></span>
<span id="cb51-60"><a href="msm_chapter.html#cb51-60" tabindex="-1"></a>CDE_mis0 <span class="ot">&lt;-</span> <span class="fu">coef</span>(msm_cde)[<span class="st">&quot;A0_PM2.5&quot;</span>]</span>
<span id="cb51-61"><a href="msm_chapter.html#cb51-61" tabindex="-1"></a><span class="co"># 0.0601292</span></span>
<span id="cb51-62"><a href="msm_chapter.html#cb51-62" tabindex="-1"></a>CDE_mis1 <span class="ot">&lt;-</span> <span class="fu">coef</span>(msm_cde)[<span class="st">&quot;A0_PM2.5&quot;</span>] <span class="sc">+</span> <span class="fu">coef</span>(msm_cde)[<span class="st">&quot;A0_PM2.5:M_diabetes&quot;</span>]</span>
<span id="cb51-63"><a href="msm_chapter.html#cb51-63" tabindex="-1"></a><span class="co"># 0.09030186</span></span>
<span id="cb51-64"><a href="msm_chapter.html#cb51-64" tabindex="-1"></a></span>
<span id="cb51-65"><a href="msm_chapter.html#cb51-65" tabindex="-1"></a></span>
<span id="cb51-66"><a href="msm_chapter.html#cb51-66" tabindex="-1"></a><span class="do">### Estimation by IPTW using ltmle package</span></span>
<span id="cb51-67"><a href="msm_chapter.html#cb51-67" tabindex="-1"></a><span class="fu">library</span>(ltmle)</span>
<span id="cb51-68"><a href="msm_chapter.html#cb51-68" tabindex="-1"></a>Qform <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">L1=</span><span class="st">&quot;Q.kplus1 ~ L0_male + L0_soc_env + A0_PM2.5&quot;</span>,</span>
<span id="cb51-69"><a href="msm_chapter.html#cb51-69" tabindex="-1"></a>           <span class="at">Y_death=</span><span class="st">&quot;Q.kplus1 ~ L0_male + L0_soc_env + L1 +</span></span>
<span id="cb51-70"><a href="msm_chapter.html#cb51-70" tabindex="-1"></a><span class="st">                    A0_PM2.5 * M_diabetes&quot;</span>)</span>
<span id="cb51-71"><a href="msm_chapter.html#cb51-71" tabindex="-1"></a>gform <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;A0_PM2.5 ~ L0_male + L0_soc_env&quot;</span>,</span>
<span id="cb51-72"><a href="msm_chapter.html#cb51-72" tabindex="-1"></a>           <span class="st">&quot;M_diabetes ~ L0_male + L0_soc_env + A0_PM2.5 + L1&quot;</span>)</span>
<span id="cb51-73"><a href="msm_chapter.html#cb51-73" tabindex="-1"></a>data_binary <span class="ot">&lt;-</span> <span class="fu">subset</span>(df2_int, <span class="at">select =</span> <span class="fu">c</span>(L0_male, L0_soc_env,</span>
<span id="cb51-74"><a href="msm_chapter.html#cb51-74" tabindex="-1"></a>                                          A0_PM2<span class="fl">.5</span>, L1,</span>
<span id="cb51-75"><a href="msm_chapter.html#cb51-75" tabindex="-1"></a>                                          M_diabetes, Y_death))</span>
<span id="cb51-76"><a href="msm_chapter.html#cb51-76" tabindex="-1"></a>CDE_ltmle_M0_death <span class="ot">&lt;-</span> <span class="fu">ltmle</span>(<span class="at">data =</span> data_binary,</span>
<span id="cb51-77"><a href="msm_chapter.html#cb51-77" tabindex="-1"></a>                            <span class="at">Anodes =</span> <span class="fu">c</span>(<span class="st">&quot;A0_PM2.5&quot;</span>, <span class="st">&quot;M_diabetes&quot;</span>),</span>
<span id="cb51-78"><a href="msm_chapter.html#cb51-78" tabindex="-1"></a>                            <span class="at">Lnodes =</span> <span class="fu">c</span>(<span class="st">&quot;L1&quot;</span>), <span class="co"># intermediate confounders +/- baseline</span></span>
<span id="cb51-79"><a href="msm_chapter.html#cb51-79" tabindex="-1"></a>                            <span class="at">Ynodes =</span> <span class="fu">c</span>(<span class="st">&quot;Y_death&quot;</span>),</span>
<span id="cb51-80"><a href="msm_chapter.html#cb51-80" tabindex="-1"></a>                            <span class="at">survivalOutcome =</span> <span class="cn">FALSE</span>, <span class="co"># TRUE for time-to-event outcomes Y</span></span>
<span id="cb51-81"><a href="msm_chapter.html#cb51-81" tabindex="-1"></a>                            <span class="at">Qform =</span> Qform,</span>
<span id="cb51-82"><a href="msm_chapter.html#cb51-82" tabindex="-1"></a>                            <span class="at">gform =</span> gform,</span>
<span id="cb51-83"><a href="msm_chapter.html#cb51-83" tabindex="-1"></a>                            <span class="at">abar =</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">0</span>), <span class="co"># counterfactual intervention do(A=1,M=0)</span></span>
<span id="cb51-84"><a href="msm_chapter.html#cb51-84" tabindex="-1"></a>                                        <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>)), <span class="co"># counterfactual intervention do(A=0,M=0)</span></span>
<span id="cb51-85"><a href="msm_chapter.html#cb51-85" tabindex="-1"></a>                            <span class="at">SL.library =</span> <span class="cn">NULL</span>,</span>
<span id="cb51-86"><a href="msm_chapter.html#cb51-86" tabindex="-1"></a>                            <span class="at">estimate.time =</span> <span class="cn">FALSE</span>, <span class="co"># estimate computation time?</span></span>
<span id="cb51-87"><a href="msm_chapter.html#cb51-87" tabindex="-1"></a>                            <span class="at">iptw.only =</span> <span class="cn">TRUE</span>, <span class="co"># for only IPTW estimations (no TMLE)</span></span>
<span id="cb51-88"><a href="msm_chapter.html#cb51-88" tabindex="-1"></a>                            <span class="at">gcomp =</span> <span class="cn">FALSE</span>,</span>
<span id="cb51-89"><a href="msm_chapter.html#cb51-89" tabindex="-1"></a>                            <span class="at">variance.method =</span> <span class="st">&quot;iptw&quot;</span>) <span class="co"># IPTW influence curve</span></span>
<span id="cb51-90"><a href="msm_chapter.html#cb51-90" tabindex="-1"></a><span class="co"># CDE with M=0</span></span>
<span id="cb51-91"><a href="msm_chapter.html#cb51-91" tabindex="-1"></a><span class="fu">summary</span>(CDE_ltmle_M0_death, <span class="at">estimator =</span> <span class="st">&quot;iptw&quot;</span>)<span class="sc">$</span>effect.measures<span class="sc">$</span>ATE</span>
<span id="cb51-92"><a href="msm_chapter.html#cb51-92" tabindex="-1"></a><span class="co"># $estimate</span></span>
<span id="cb51-93"><a href="msm_chapter.html#cb51-93" tabindex="-1"></a><span class="co"># [1] 0.0601292</span></span>
<span id="cb51-94"><a href="msm_chapter.html#cb51-94" tabindex="-1"></a><span class="co"># $CI</span></span>
<span id="cb51-95"><a href="msm_chapter.html#cb51-95" tabindex="-1"></a><span class="co">#            2.5%      97.5%</span></span>
<span id="cb51-96"><a href="msm_chapter.html#cb51-96" tabindex="-1"></a><span class="co"># [1,] 0.02424819 0.09601021</span></span>
<span id="cb51-97"><a href="msm_chapter.html#cb51-97" tabindex="-1"></a></span>
<span id="cb51-98"><a href="msm_chapter.html#cb51-98" tabindex="-1"></a>CDE_ltmle_M1_death <span class="ot">&lt;-</span> <span class="fu">ltmle</span>(<span class="at">data =</span> data_binary,</span>
<span id="cb51-99"><a href="msm_chapter.html#cb51-99" tabindex="-1"></a>                            <span class="at">Anodes =</span> <span class="fu">c</span>(<span class="st">&quot;A0_PM2.5&quot;</span>, <span class="st">&quot;M_diabetes&quot;</span>),</span>
<span id="cb51-100"><a href="msm_chapter.html#cb51-100" tabindex="-1"></a>                            <span class="at">Lnodes =</span> <span class="fu">c</span>(<span class="st">&quot;L1&quot;</span>), <span class="co"># intermediate confounders +/- baseline</span></span>
<span id="cb51-101"><a href="msm_chapter.html#cb51-101" tabindex="-1"></a>                            <span class="at">Ynodes =</span> <span class="fu">c</span>(<span class="st">&quot;Y_death&quot;</span>),</span>
<span id="cb51-102"><a href="msm_chapter.html#cb51-102" tabindex="-1"></a>                            <span class="at">survivalOutcome =</span> <span class="cn">FALSE</span>, <span class="co"># TRUE for time-to-event outcomes Y</span></span>
<span id="cb51-103"><a href="msm_chapter.html#cb51-103" tabindex="-1"></a>                            <span class="at">Qform =</span> Qform,</span>
<span id="cb51-104"><a href="msm_chapter.html#cb51-104" tabindex="-1"></a>                            <span class="at">gform =</span> gform,</span>
<span id="cb51-105"><a href="msm_chapter.html#cb51-105" tabindex="-1"></a>                            <span class="at">abar =</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>), <span class="co"># counterfactual intervention do(A=1,M=0)</span></span>
<span id="cb51-106"><a href="msm_chapter.html#cb51-106" tabindex="-1"></a>                                        <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)), <span class="co"># counterfactual intervention do(A=0,M=0)</span></span>
<span id="cb51-107"><a href="msm_chapter.html#cb51-107" tabindex="-1"></a>                            <span class="at">SL.library =</span> <span class="cn">NULL</span>,</span>
<span id="cb51-108"><a href="msm_chapter.html#cb51-108" tabindex="-1"></a>                            <span class="at">estimate.time =</span> <span class="cn">FALSE</span>, <span class="co"># estimate computation time?</span></span>
<span id="cb51-109"><a href="msm_chapter.html#cb51-109" tabindex="-1"></a>                            <span class="at">iptw.only =</span> <span class="cn">TRUE</span>, <span class="co"># for only IPTW estimations (no TMLE)</span></span>
<span id="cb51-110"><a href="msm_chapter.html#cb51-110" tabindex="-1"></a>                            <span class="at">gcomp =</span> <span class="cn">FALSE</span>,</span>
<span id="cb51-111"><a href="msm_chapter.html#cb51-111" tabindex="-1"></a>                            <span class="at">variance.method =</span> <span class="st">&quot;iptw&quot;</span>) <span class="co"># IPTW influence curve</span></span>
<span id="cb51-112"><a href="msm_chapter.html#cb51-112" tabindex="-1"></a><span class="co"># CDE with M=1</span></span>
<span id="cb51-113"><a href="msm_chapter.html#cb51-113" tabindex="-1"></a><span class="fu">summary</span>(CDE_ltmle_M1_death, <span class="at">estimator =</span> <span class="st">&quot;iptw&quot;</span>)<span class="sc">$</span>effect.measures<span class="sc">$</span>ATE</span>
<span id="cb51-114"><a href="msm_chapter.html#cb51-114" tabindex="-1"></a><span class="co"># $estimate</span></span>
<span id="cb51-115"><a href="msm_chapter.html#cb51-115" tabindex="-1"></a><span class="co"># [1] 0.09030186</span></span>
<span id="cb51-116"><a href="msm_chapter.html#cb51-116" tabindex="-1"></a><span class="co"># $CI</span></span>
<span id="cb51-117"><a href="msm_chapter.html#cb51-117" tabindex="-1"></a><span class="co">#            2.5%     97.5%</span></span>
<span id="cb51-118"><a href="msm_chapter.html#cb51-118" tabindex="-1"></a><span class="co"># [1,] 0.04084792 0.1397558</span></span>
<span id="cb51-119"><a href="msm_chapter.html#cb51-119" tabindex="-1"></a></span>
<span id="cb51-120"><a href="msm_chapter.html#cb51-120" tabindex="-1"></a><span class="do">## we obtain the same results as the IPTW estimation by hand</span></span>
<span id="cb51-121"><a href="msm_chapter.html#cb51-121" tabindex="-1"></a></span>
<span id="cb51-122"><a href="msm_chapter.html#cb51-122" tabindex="-1"></a></span>
<span id="cb51-123"><a href="msm_chapter.html#cb51-123" tabindex="-1"></a><span class="do">### Estimation by IPTW using ltmle package</span></span>
<span id="cb51-124"><a href="msm_chapter.html#cb51-124" tabindex="-1"></a><span class="fu">library</span>(CMAverse)</span>
<span id="cb51-125"><a href="msm_chapter.html#cb51-125" tabindex="-1"></a><span class="fu">library</span>(CMAverse)</span>
<span id="cb51-126"><a href="msm_chapter.html#cb51-126" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list=</span><span class="fu">ls</span>())</span>
<span id="cb51-127"><a href="msm_chapter.html#cb51-127" tabindex="-1"></a>df2_int <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="st">&quot;data/df2_int.csv&quot;</span>)</span>
<span id="cb51-128"><a href="msm_chapter.html#cb51-128" tabindex="-1"></a><span class="fu">cmdag</span>(<span class="at">outcome =</span> <span class="st">&quot;Y_death&quot;</span>, <span class="at">exposure =</span> <span class="st">&quot;A0_PM2.5&quot;</span>, <span class="at">mediator =</span> <span class="st">&quot;M_diabetes&quot;</span>,</span>
<span id="cb51-129"><a href="msm_chapter.html#cb51-129" tabindex="-1"></a>      <span class="at">basec =</span> <span class="fu">c</span>(<span class="st">&quot;L0_male&quot;</span>, <span class="st">&quot;L0_soc_env&quot;</span>), <span class="at">postc =</span> <span class="st">&quot;L1&quot;</span>, <span class="at">node =</span> <span class="cn">TRUE</span>, <span class="at">text_col =</span> <span class="st">&quot;white&quot;</span>)</span>
<span id="cb51-130"><a href="msm_chapter.html#cb51-130" tabindex="-1"></a><span class="co"># In this setting, we can use the marginal structural model and the $g$-formula approach. The results are shown below.</span></span>
<span id="cb51-131"><a href="msm_chapter.html#cb51-131" tabindex="-1"></a></span>
<span id="cb51-132"><a href="msm_chapter.html#cb51-132" tabindex="-1"></a><span class="do">## The Marginal Structural Model</span></span>
<span id="cb51-133"><a href="msm_chapter.html#cb51-133" tabindex="-1"></a>res_msm_RD <span class="ot">&lt;-</span> <span class="fu">cmest</span>(<span class="at">data =</span> df2_int,</span>
<span id="cb51-134"><a href="msm_chapter.html#cb51-134" tabindex="-1"></a>                    <span class="at">model =</span> <span class="st">&quot;msm&quot;</span>,</span>
<span id="cb51-135"><a href="msm_chapter.html#cb51-135" tabindex="-1"></a>                    <span class="at">outcome =</span> <span class="st">&quot;Y_death&quot;</span>,</span>
<span id="cb51-136"><a href="msm_chapter.html#cb51-136" tabindex="-1"></a>                    <span class="at">exposure =</span> <span class="st">&quot;A0_PM2.5&quot;</span>,</span>
<span id="cb51-137"><a href="msm_chapter.html#cb51-137" tabindex="-1"></a>                    <span class="at">mediator =</span> <span class="st">&quot;M_diabetes&quot;</span>,</span>
<span id="cb51-138"><a href="msm_chapter.html#cb51-138" tabindex="-1"></a>                    <span class="at">basec =</span> <span class="fu">c</span>(<span class="st">&quot;L0_male&quot;</span>, <span class="st">&quot;L0_soc_env&quot;</span>),</span>
<span id="cb51-139"><a href="msm_chapter.html#cb51-139" tabindex="-1"></a>                    <span class="at">postc =</span> <span class="st">&quot;L1&quot;</span>,</span>
<span id="cb51-140"><a href="msm_chapter.html#cb51-140" tabindex="-1"></a>                    <span class="at">EMint =</span> <span class="cn">TRUE</span>, <span class="co"># E*M interaction</span></span>
<span id="cb51-141"><a href="msm_chapter.html#cb51-141" tabindex="-1"></a>                    <span class="at">ereg =</span> <span class="st">&quot;logistic&quot;</span>,</span>
<span id="cb51-142"><a href="msm_chapter.html#cb51-142" tabindex="-1"></a>                    <span class="at">yreg =</span> <span class="st">&quot;linear&quot;</span>, <span class="co"># MSM is a linear regression (to get RD)</span></span>
<span id="cb51-143"><a href="msm_chapter.html#cb51-143" tabindex="-1"></a>                    <span class="at">mreg =</span> <span class="fu">list</span>(<span class="st">&quot;logistic&quot;</span>),</span>
<span id="cb51-144"><a href="msm_chapter.html#cb51-144" tabindex="-1"></a>                    <span class="at">wmnomreg =</span> <span class="fu">list</span>(<span class="st">&quot;logistic&quot;</span>),</span>
<span id="cb51-145"><a href="msm_chapter.html#cb51-145" tabindex="-1"></a>                    <span class="at">wmdenomreg =</span> <span class="fu">list</span>(<span class="st">&quot;logistic&quot;</span>),</span>
<span id="cb51-146"><a href="msm_chapter.html#cb51-146" tabindex="-1"></a>                    <span class="at">astar =</span> <span class="dv">0</span>, <span class="co">#E(Y_{A=0,M=1})</span></span>
<span id="cb51-147"><a href="msm_chapter.html#cb51-147" tabindex="-1"></a>                    <span class="at">a =</span> <span class="dv">1</span>,  <span class="co">#E(Y_{A=1,M=1})</span></span>
<span id="cb51-148"><a href="msm_chapter.html#cb51-148" tabindex="-1"></a>                    <span class="at">mval =</span> <span class="fu">list</span>(<span class="dv">1</span>), <span class="co"># for the CDE, set mediator to M=1</span></span>
<span id="cb51-149"><a href="msm_chapter.html#cb51-149" tabindex="-1"></a>                    <span class="at">estimation =</span> <span class="st">&quot;imputation&quot;</span>,</span>
<span id="cb51-150"><a href="msm_chapter.html#cb51-150" tabindex="-1"></a>                    <span class="at">inference =</span> <span class="st">&quot;bootstrap&quot;</span>,</span>
<span id="cb51-151"><a href="msm_chapter.html#cb51-151" tabindex="-1"></a>                    <span class="at">nboot =</span> <span class="dv">2</span>)</span>
<span id="cb51-152"><a href="msm_chapter.html#cb51-152" tabindex="-1"></a></span>
<span id="cb51-153"><a href="msm_chapter.html#cb51-153" tabindex="-1"></a><span class="fu">summary</span>(res_msm_RD)</span>
<span id="cb51-154"><a href="msm_chapter.html#cb51-154" tabindex="-1"></a><span class="co"># Causal Mediation Analysis</span></span>
<span id="cb51-155"><a href="msm_chapter.html#cb51-155" tabindex="-1"></a><span class="co"># # Outcome regression:</span></span>
<span id="cb51-156"><a href="msm_chapter.html#cb51-156" tabindex="-1"></a><span class="co"># Call:</span></span>
<span id="cb51-157"><a href="msm_chapter.html#cb51-157" tabindex="-1"></a><span class="co">#   glm(formula = Y_death ~ A0_PM2.5 + M_diabetes + A0_PM2.5 * M_diabetes, </span></span>
<span id="cb51-158"><a href="msm_chapter.html#cb51-158" tabindex="-1"></a><span class="co">#       family = gaussian(), data = getCall(x$reg.output$yreg)$data, </span></span>
<span id="cb51-159"><a href="msm_chapter.html#cb51-159" tabindex="-1"></a><span class="co">#       weights = getCall(x$reg.output$yreg)$weights)</span></span>
<span id="cb51-160"><a href="msm_chapter.html#cb51-160" tabindex="-1"></a><span class="co"># Coefficients:</span></span>
<span id="cb51-161"><a href="msm_chapter.html#cb51-161" tabindex="-1"></a><span class="co">#                       Estimate Std. Error t value Pr(&gt;|t|)      # MSM coef</span></span>
<span id="cb51-162"><a href="msm_chapter.html#cb51-162" tabindex="-1"></a><span class="co">#   (Intercept)         0.179321   0.005242  34.210  &lt; 2e-16 ***  # are the</span></span>
<span id="cb51-163"><a href="msm_chapter.html#cb51-163" tabindex="-1"></a><span class="co">#   A0_PM2.5            0.060129   0.017253   3.485 0.000494 ***  # same as</span></span>
<span id="cb51-164"><a href="msm_chapter.html#cb51-164" tabindex="-1"></a><span class="co">#   M_diabetes          0.072397   0.009242   7.834 5.21e-15 ***  # calculation</span></span>
<span id="cb51-165"><a href="msm_chapter.html#cb51-165" tabindex="-1"></a><span class="co">#   A0_PM2.5:M_diabetes 0.030173   0.025895   1.165 0.243960      # by hand</span></span>
<span id="cb51-166"><a href="msm_chapter.html#cb51-166" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb51-167"><a href="msm_chapter.html#cb51-167" tabindex="-1"></a><span class="co"># # Mediator regressions: </span></span>
<span id="cb51-168"><a href="msm_chapter.html#cb51-168" tabindex="-1"></a><span class="co"># Call:</span></span>
<span id="cb51-169"><a href="msm_chapter.html#cb51-169" tabindex="-1"></a><span class="co">#   glm(formula = M_diabetes ~ A0_PM2.5, family = binomial(), data = getCall(x$reg.output$mreg[[1L]])$data, </span></span>
<span id="cb51-170"><a href="msm_chapter.html#cb51-170" tabindex="-1"></a><span class="co">#       weights = getCall(x$reg.output$mreg[[1L]])$weights)</span></span>
<span id="cb51-171"><a href="msm_chapter.html#cb51-171" tabindex="-1"></a><span class="co"># Coefficients:</span></span>
<span id="cb51-172"><a href="msm_chapter.html#cb51-172" tabindex="-1"></a><span class="co">#               Estimate Std. Error z value Pr(&gt;|z|)    </span></span>
<span id="cb51-173"><a href="msm_chapter.html#cb51-173" tabindex="-1"></a><span class="co">#   (Intercept) -0.73432    0.02268 -32.384  &lt; 2e-16 ***</span></span>
<span id="cb51-174"><a href="msm_chapter.html#cb51-174" tabindex="-1"></a><span class="co">#   A0_PM2.5     0.51531    0.06422   8.024 1.02e-15 ***</span></span>
<span id="cb51-175"><a href="msm_chapter.html#cb51-175" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb51-176"><a href="msm_chapter.html#cb51-176" tabindex="-1"></a><span class="co"># # Mediator regressions for weighting (denominator): </span></span>
<span id="cb51-177"><a href="msm_chapter.html#cb51-177" tabindex="-1"></a><span class="co"># Call:</span></span>
<span id="cb51-178"><a href="msm_chapter.html#cb51-178" tabindex="-1"></a><span class="co">#   glm(formula = M_diabetes ~ A0_PM2.5 + L0_male + L0_soc_env + </span></span>
<span id="cb51-179"><a href="msm_chapter.html#cb51-179" tabindex="-1"></a><span class="co">#         L1, family = binomial(), data = getCall(x$reg.output$wmdenomreg[[1L]])$data, </span></span>
<span id="cb51-180"><a href="msm_chapter.html#cb51-180" tabindex="-1"></a><span class="co">#       weights = getCall(x$reg.output$wmdenomreg[[1L]])$weights)</span></span>
<span id="cb51-181"><a href="msm_chapter.html#cb51-181" tabindex="-1"></a><span class="co"># Coefficients:</span></span>
<span id="cb51-182"><a href="msm_chapter.html#cb51-182" tabindex="-1"></a><span class="co">#               Estimate Std. Error z value Pr(&gt;|z|)    </span></span>
<span id="cb51-183"><a href="msm_chapter.html#cb51-183" tabindex="-1"></a><span class="co">#   (Intercept) -1.36249    0.04783 -28.488  &lt; 2e-16 ***</span></span>
<span id="cb51-184"><a href="msm_chapter.html#cb51-184" tabindex="-1"></a><span class="co">#   A0_PM2.5     0.30994    0.06668   4.648 3.35e-06 ***</span></span>
<span id="cb51-185"><a href="msm_chapter.html#cb51-185" tabindex="-1"></a><span class="co">#   L0_male      0.24661    0.04369   5.644 1.66e-08 ***</span></span>
<span id="cb51-186"><a href="msm_chapter.html#cb51-186" tabindex="-1"></a><span class="co">#   L0_soc_env   0.30628    0.04650   6.587 4.50e-11 ***</span></span>
<span id="cb51-187"><a href="msm_chapter.html#cb51-187" tabindex="-1"></a><span class="co">#   L1           0.86045    0.04493  19.152  &lt; 2e-16 ***</span></span>
<span id="cb51-188"><a href="msm_chapter.html#cb51-188" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb51-189"><a href="msm_chapter.html#cb51-189" tabindex="-1"></a><span class="co"># # Mediator regressions for weighting (nominator): </span></span>
<span id="cb51-190"><a href="msm_chapter.html#cb51-190" tabindex="-1"></a><span class="co"># Call:</span></span>
<span id="cb51-191"><a href="msm_chapter.html#cb51-191" tabindex="-1"></a><span class="co">#   glm(formula = M_diabetes ~ A0_PM2.5, family = binomial(), data = getCall(x$reg.output$wmnomreg[[1L]])$data, </span></span>
<span id="cb51-192"><a href="msm_chapter.html#cb51-192" tabindex="-1"></a><span class="co">#       weights = getCall(x$reg.output$wmnomreg[[1L]])$weights)</span></span>
<span id="cb51-193"><a href="msm_chapter.html#cb51-193" tabindex="-1"></a><span class="co"># Coefficients:</span></span>
<span id="cb51-194"><a href="msm_chapter.html#cb51-194" tabindex="-1"></a><span class="co">#               Estimate Std. Error z value Pr(&gt;|z|)    </span></span>
<span id="cb51-195"><a href="msm_chapter.html#cb51-195" tabindex="-1"></a><span class="co">#   (Intercept) -0.74205    0.02271 -32.680   &lt;2e-16 ***</span></span>
<span id="cb51-196"><a href="msm_chapter.html#cb51-196" tabindex="-1"></a><span class="co">#   A0_PM2.5     0.55288    0.06408   8.628   &lt;2e-16 ***</span></span>
<span id="cb51-197"><a href="msm_chapter.html#cb51-197" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb51-198"><a href="msm_chapter.html#cb51-198" tabindex="-1"></a><span class="co"># # Exposure regression for weighting: </span></span>
<span id="cb51-199"><a href="msm_chapter.html#cb51-199" tabindex="-1"></a><span class="co"># Call:</span></span>
<span id="cb51-200"><a href="msm_chapter.html#cb51-200" tabindex="-1"></a><span class="co">#   glm(formula = A0_PM2.5 ~ L0_male + L0_soc_env, family = binomial(), </span></span>
<span id="cb51-201"><a href="msm_chapter.html#cb51-201" tabindex="-1"></a><span class="co">#       data = getCall(x$reg.output$ereg)$data, weights = getCall(x$reg.output$ereg)$weights)</span></span>
<span id="cb51-202"><a href="msm_chapter.html#cb51-202" tabindex="-1"></a><span class="co"># Coefficients:</span></span>
<span id="cb51-203"><a href="msm_chapter.html#cb51-203" tabindex="-1"></a><span class="co">#               Estimate Std. Error z value Pr(&gt;|z|)    </span></span>
<span id="cb51-204"><a href="msm_chapter.html#cb51-204" tabindex="-1"></a><span class="co">#   (Intercept) -2.73244    0.07425 -36.799  &lt; 2e-16 ***</span></span>
<span id="cb51-205"><a href="msm_chapter.html#cb51-205" tabindex="-1"></a><span class="co">#   L0_male      0.40580    0.06447   6.294 3.09e-10 ***</span></span>
<span id="cb51-206"><a href="msm_chapter.html#cb51-206" tabindex="-1"></a><span class="co">#   L0_soc_env   0.64060    0.07350   8.716  &lt; 2e-16 ***</span></span>
<span id="cb51-207"><a href="msm_chapter.html#cb51-207" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb51-208"><a href="msm_chapter.html#cb51-208" tabindex="-1"></a><span class="co"># # Effect decomposition on the mean difference scale via the marginal structural model</span></span>
<span id="cb51-209"><a href="msm_chapter.html#cb51-209" tabindex="-1"></a><span class="co"># Direct counterfactual imputation estimation with </span></span>
<span id="cb51-210"><a href="msm_chapter.html#cb51-210" tabindex="-1"></a><span class="co"># bootstrap standard errors, percentile confidence intervals and p-values </span></span>
<span id="cb51-211"><a href="msm_chapter.html#cb51-211" tabindex="-1"></a><span class="co">#                   Estimate  Std.error    95% CIL 95% CIU  P.val    </span></span>
<span id="cb51-212"><a href="msm_chapter.html#cb51-212" tabindex="-1"></a><span class="co">#   cde            9.030e-02  1.601e-02  6.094e-02   0.082 &lt;2e-16 *** # same result</span></span>
<span id="cb51-213"><a href="msm_chapter.html#cb51-213" tabindex="-1"></a><span class="co">#   rpnde          7.003e-02  1.600e-02  5.838e-02   0.080 &lt;2e-16 ***</span></span>
<span id="cb51-214"><a href="msm_chapter.html#cb51-214" tabindex="-1"></a><span class="co">#   rtnde          7.374e-02  1.597e-02  5.888e-02   0.080 &lt;2e-16 ***</span></span>
<span id="cb51-215"><a href="msm_chapter.html#cb51-215" tabindex="-1"></a><span class="co">#   rpnie          8.903e-03  9.159e-04  8.284e-03   0.010 &lt;2e-16 ***</span></span>
<span id="cb51-216"><a href="msm_chapter.html#cb51-216" tabindex="-1"></a><span class="co">#   rtnie          1.261e-02  9.523e-04  8.738e-03   0.010 &lt;2e-16 ***</span></span>
<span id="cb51-217"><a href="msm_chapter.html#cb51-217" tabindex="-1"></a><span class="co">#   te             8.265e-02  1.505e-02  6.839e-02   0.089 &lt;2e-16 ***</span></span>
<span id="cb51-218"><a href="msm_chapter.html#cb51-218" tabindex="-1"></a><span class="co">#   rintref       -2.027e-02  7.341e-06 -2.571e-03  -0.003 &lt;2e-16 ***</span></span>
<span id="cb51-219"><a href="msm_chapter.html#cb51-219" tabindex="-1"></a><span class="co">#   rintmed        3.710e-03  3.634e-05  4.542e-04   0.001 &lt;2e-16 ***</span></span>
<span id="cb51-220"><a href="msm_chapter.html#cb51-220" tabindex="-1"></a><span class="co">#   cde(prop)      1.093e+00  2.940e-02  8.907e-01   0.930 &lt;2e-16 ***</span></span>
<span id="cb51-221"><a href="msm_chapter.html#cb51-221" tabindex="-1"></a><span class="co">#   rintref(prop) -2.452e-01  6.289e-03 -3.752e-02  -0.029 &lt;2e-16 ***</span></span>
<span id="cb51-222"><a href="msm_chapter.html#cb51-222" tabindex="-1"></a><span class="co">#   rintmed(prop)  4.489e-02  1.662e-03  5.140e-03   0.007 &lt;2e-16 ***</span></span>
<span id="cb51-223"><a href="msm_chapter.html#cb51-223" tabindex="-1"></a><span class="co">#   rpnie(prop)    1.077e-01  3.403e-02  9.376e-02   0.139 &lt;2e-16 ***</span></span>
<span id="cb51-224"><a href="msm_chapter.html#cb51-224" tabindex="-1"></a><span class="co">#   rpm            1.526e-01  3.569e-02  9.890e-02   0.147 &lt;2e-16 ***</span></span>
<span id="cb51-225"><a href="msm_chapter.html#cb51-225" tabindex="-1"></a><span class="co">#   rint          -2.004e-01  4.627e-03 -3.014e-02  -0.024 &lt;2e-16 ***</span></span>
<span id="cb51-226"><a href="msm_chapter.html#cb51-226" tabindex="-1"></a><span class="co">#   rpe           -9.263e-02  2.940e-02  6.983e-02   0.109 &lt;2e-16 ***</span></span>
<span id="cb51-227"><a href="msm_chapter.html#cb51-227" tabindex="-1"></a><span class="co">#   ---</span></span>
<span id="cb51-228"><a href="msm_chapter.html#cb51-228" tabindex="-1"></a><span class="co">#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1</span></span>
<span id="cb51-229"><a href="msm_chapter.html#cb51-229" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb51-230"><a href="msm_chapter.html#cb51-230" tabindex="-1"></a><span class="co">#  (cde: controlled direct effect; </span></span>
<span id="cb51-231"><a href="msm_chapter.html#cb51-231" tabindex="-1"></a><span class="co">#  rpnde: randomized analogue of pure natural direct effect; </span></span>
<span id="cb51-232"><a href="msm_chapter.html#cb51-232" tabindex="-1"></a><span class="co">#  rtnde: randomized analogue of total natural direct effect; </span></span>
<span id="cb51-233"><a href="msm_chapter.html#cb51-233" tabindex="-1"></a><span class="co">#  rpnie: randomized analogue of pure natural indirect effect; </span></span>
<span id="cb51-234"><a href="msm_chapter.html#cb51-234" tabindex="-1"></a><span class="co">#  rtnie: randomized analogue of total natural indirect effect; </span></span>
<span id="cb51-235"><a href="msm_chapter.html#cb51-235" tabindex="-1"></a><span class="co">#  te: total effect; rintref: randomized analogue of reference interaction; </span></span>
<span id="cb51-236"><a href="msm_chapter.html#cb51-236" tabindex="-1"></a><span class="co">#  rintmed: randomized analogue of mediated interaction; </span></span>
<span id="cb51-237"><a href="msm_chapter.html#cb51-237" tabindex="-1"></a><span class="co">#  cde(prop): proportion cde; </span></span>
<span id="cb51-238"><a href="msm_chapter.html#cb51-238" tabindex="-1"></a><span class="co">#  rintref(prop): proportion rintref; </span></span>
<span id="cb51-239"><a href="msm_chapter.html#cb51-239" tabindex="-1"></a><span class="co">#  rintmed(prop): proportion rintmed; </span></span>
<span id="cb51-240"><a href="msm_chapter.html#cb51-240" tabindex="-1"></a><span class="co">#  rpnie(prop): proportion rpnie; </span></span>
<span id="cb51-241"><a href="msm_chapter.html#cb51-241" tabindex="-1"></a><span class="co">#  rpm: randomized analogue of overall proportion mediated; </span></span>
<span id="cb51-242"><a href="msm_chapter.html#cb51-242" tabindex="-1"></a><span class="co">#  rint: randomized analogue of overall proportion attributable to interaction; </span></span>
<span id="cb51-243"><a href="msm_chapter.html#cb51-243" tabindex="-1"></a><span class="co">#  rpe: randomized analogue of overall proportion eliminated)</span></span></code></pre></div>
</div>
</div>
<div id="estimation-of-the-msm-coefficients-by-g-computation" class="section level3 hasAnchor" number="8.2.3">
<h3><span class="header-section-number">8.2.3</span> Estimation of the MSM coefficients by G-computation<a href="msm_chapter.html#estimation-of-the-msm-coefficients-by-g-computation" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>As for the ATE, we can use G-computation to estimate the coefficients of the MSM to estimate Controlled Direct Effects.</p>
<p>Note that the algorithm described below is correct only if the exposure <span class="math inline">\(A\)</span> doesn’t affect the intermediate confounders <span class="math inline">\(L(1)\)</span> of the <span class="math inline">\(M \rightarrow Y\)</span> relationship (such as the data simulated from the Causal model 1 in our examples). In that case, the following steps can be applied:</p>
<ol style="list-style-type: decimal">
<li><p>Fit a (logistic or a linear) regression to estimate <span class="math inline">\(\overline{Q} = \mathbb{E}(Y \mid A,M, L(0),L(1))\)</span></p></li>
<li><p>Use this estimate to predict an outcome for each subject under the counterfactual scenarios <span class="math inline">\(\hat{\overline{Q}}(A=0,M=m,L(0),L(1))_i\)</span> and <span class="math inline">\(\hat{\overline{Q}}(A=1,M=m,L(0),L(1))_i\)</span>, by evaluating the regression fit <span class="math inline">\(\overline{Q}\)</span> at <span class="math inline">\((A=0,M=m)\)</span> and <span class="math inline">\((A=1,M=m)\)</span> respectively. If we want to set the level of the mediator to <span class="math inline">\(M=0\)</span> and <span class="math inline">\(M=1\)</span>, this would give 4 counterfactual scenarios <span class="math inline">\(\text{do}(A=0,M=0)\)</span>, <span class="math inline">\(\text{do}(A=1,M=0)\)</span>, <span class="math inline">\(\text{do}(A=0,M=1)\)</span> and <span class="math inline">\(\text{do}(A=1,M=1)\)</span>.</p></li>
<li><p>Duplicate the initial dataset for each scenario in a single long dataset in which:</p></li>
</ol>
<ul>
<li>the 1st part of the long dataset corresponds to the first counterfactual scenario with <span class="math inline">\((A=0,M=0)\)</span> for all individuals and an additional column for the predicted counterfactual outcome <span class="math inline">\(\mathbb{E}(Y_{A=0,M=0}\mid L(0),L(1)) = \hat{\overline{Q}}(A=0,M=0,L(0),L(1))\)</span> ;</li>
<li>the 2d part of the long dataset corresponds to the second counterfactual scenario with <span class="math inline">\((A=1,M=0)\)</span> for all individuals and an additional column for the predicted counterfactual outcome <span class="math inline">\(\mathbb{E}(Y_{A=1,M=0}\mid L(0),L(1)) = \hat{\overline{Q}}(A=1,M=0,L(0),L(1))\)</span> ;</li>
<li>the 3d part of the long dataset corresponds to the second counterfactual scenario with <span class="math inline">\((A=0,M=1)\)</span> for all individuals and an additional column for the predicted counterfactual outcome <span class="math inline">\(\mathbb{E}(Y_{A=0,M=1}\mid L(0),L(1)) = \hat{\overline{Q}}(A=0,M=1,L(0),L(1))\)</span> ;</li>
<li>the 4th part of the long dataset corresponds to the second counterfactual scenario with <span class="math inline">\((A=1,M=1)\)</span> for all individuals and an additional column for the predicted counterfactual outcome <span class="math inline">\(\mathbb{E}(Y_{A=1,M=1}\mid L(0),L(1)) = \hat{\overline{Q}}(A=1,M=1,L(0),L(1))\)</span> ;</li>
</ul>
<ol start="4" style="list-style-type: decimal">
<li>Fit the MSM <span class="math inline">\(\mathbb{E}(Y_{am}) = \alpha_0 + \alpha_A a + \alpha_M m + \alpha_{A \ast M} a \times m\)</span> using the long dataset.</li>
</ol>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="msm_chapter.html#cb52-1" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list=</span><span class="fu">ls</span>())</span>
<span id="cb52-2"><a href="msm_chapter.html#cb52-2" tabindex="-1"></a>df1_int <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="st">&quot;data/df1_int.csv&quot;</span>)</span>
<span id="cb52-3"><a href="msm_chapter.html#cb52-3" tabindex="-1"></a></span>
<span id="cb52-4"><a href="msm_chapter.html#cb52-4" tabindex="-1"></a><span class="do">### MSM of CDE, estimated by G-computation -------------------------------------</span></span>
<span id="cb52-5"><a href="msm_chapter.html#cb52-5" tabindex="-1"></a><span class="do">## 1. Estimate Qbar(A,M,L0,L1)</span></span>
<span id="cb52-6"><a href="msm_chapter.html#cb52-6" tabindex="-1"></a>Q.cde.death <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y_death <span class="sc">~</span> A0_PM2<span class="fl">.5</span> <span class="sc">+</span> M_diabetes <span class="sc">+</span> A0_PM2<span class="fl">.5</span><span class="sc">:</span>M_diabetes <span class="sc">+</span> </span>
<span id="cb52-7"><a href="msm_chapter.html#cb52-7" tabindex="-1"></a>                     L0_male <span class="sc">+</span> L0_soc_env <span class="sc">+</span> L1,</span>
<span id="cb52-8"><a href="msm_chapter.html#cb52-8" tabindex="-1"></a>                   <span class="at">family =</span> <span class="st">&quot;gaussian&quot;</span>, <span class="at">data =</span> df1_int)</span>
<span id="cb52-9"><a href="msm_chapter.html#cb52-9" tabindex="-1"></a><span class="co"># The final result would be sligthly different if we applied a binomial family</span></span>
<span id="cb52-10"><a href="msm_chapter.html#cb52-10" tabindex="-1"></a><span class="co"># The Gaussian family corresponds to the true generating model in this example.</span></span>
<span id="cb52-11"><a href="msm_chapter.html#cb52-11" tabindex="-1"></a></span>
<span id="cb52-12"><a href="msm_chapter.html#cb52-12" tabindex="-1"></a><span class="do">## 2. Predict an outcome for each subject, in each counterfactual scenario</span></span>
<span id="cb52-13"><a href="msm_chapter.html#cb52-13" tabindex="-1"></a><span class="co"># Prepare data sets that will be used to predict the outcome under the counterfactual</span></span>
<span id="cb52-14"><a href="msm_chapter.html#cb52-14" tabindex="-1"></a><span class="co"># 4 counterfactual scenarios setting (A=0,M=0), (A=1,M=0), (A=0,M=1) and (A=1,M=1)</span></span>
<span id="cb52-15"><a href="msm_chapter.html#cb52-15" tabindex="-1"></a>data.A0M0 <span class="ot">&lt;-</span> data.A1M0 <span class="ot">&lt;-</span> data.A0M1 <span class="ot">&lt;-</span> data.A1M1 <span class="ot">&lt;-</span> df1_int</span>
<span id="cb52-16"><a href="msm_chapter.html#cb52-16" tabindex="-1"></a>data.A0M0<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb52-17"><a href="msm_chapter.html#cb52-17" tabindex="-1"></a>data.A0M0<span class="sc">$</span>M_diabetes <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb52-18"><a href="msm_chapter.html#cb52-18" tabindex="-1"></a></span>
<span id="cb52-19"><a href="msm_chapter.html#cb52-19" tabindex="-1"></a>data.A1M0<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb52-20"><a href="msm_chapter.html#cb52-20" tabindex="-1"></a>data.A1M0<span class="sc">$</span>M_diabetes <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb52-21"><a href="msm_chapter.html#cb52-21" tabindex="-1"></a></span>
<span id="cb52-22"><a href="msm_chapter.html#cb52-22" tabindex="-1"></a>data.A0M1<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb52-23"><a href="msm_chapter.html#cb52-23" tabindex="-1"></a>data.A0M1<span class="sc">$</span>M_diabetes <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb52-24"><a href="msm_chapter.html#cb52-24" tabindex="-1"></a></span>
<span id="cb52-25"><a href="msm_chapter.html#cb52-25" tabindex="-1"></a>data.A1M1<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb52-26"><a href="msm_chapter.html#cb52-26" tabindex="-1"></a>data.A1M1<span class="sc">$</span>M_diabetes <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb52-27"><a href="msm_chapter.html#cb52-27" tabindex="-1"></a></span>
<span id="cb52-28"><a href="msm_chapter.html#cb52-28" tabindex="-1"></a><span class="co"># predict values under the same name in the corresponding counterfactual dataset</span></span>
<span id="cb52-29"><a href="msm_chapter.html#cb52-29" tabindex="-1"></a>data.A0M0<span class="sc">$</span>Yam.death.pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(Q.cde.death, <span class="at">newdata =</span> data.A0M0, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb52-30"><a href="msm_chapter.html#cb52-30" tabindex="-1"></a>data.A1M0<span class="sc">$</span>Yam.death.pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(Q.cde.death, <span class="at">newdata =</span> data.A1M0, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb52-31"><a href="msm_chapter.html#cb52-31" tabindex="-1"></a>data.A0M1<span class="sc">$</span>Yam.death.pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(Q.cde.death, <span class="at">newdata =</span> data.A0M1, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb52-32"><a href="msm_chapter.html#cb52-32" tabindex="-1"></a>data.A1M1<span class="sc">$</span>Yam.death.pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(Q.cde.death, <span class="at">newdata =</span> data.A1M1, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb52-33"><a href="msm_chapter.html#cb52-33" tabindex="-1"></a></span>
<span id="cb52-34"><a href="msm_chapter.html#cb52-34" tabindex="-1"></a><span class="do">## 3. Append the 4 counterfactual datasets in a single long dataset</span></span>
<span id="cb52-35"><a href="msm_chapter.html#cb52-35" tabindex="-1"></a><span class="co"># number of row is 4 times the initial value (we have 4 counterfactual scenarios)</span></span>
<span id="cb52-36"><a href="msm_chapter.html#cb52-36" tabindex="-1"></a>data<span class="fl">.4</span>scenarios <span class="ot">&lt;-</span> <span class="fu">rbind</span>(data.A0M0, data.A1M0,data.A0M1,data.A1M1)</span>
<span id="cb52-37"><a href="msm_chapter.html#cb52-37" tabindex="-1"></a></span>
<span id="cb52-38"><a href="msm_chapter.html#cb52-38" tabindex="-1"></a><span class="do">## 4. fit the MSM: E(Y_am) = alpha_0 + alpha_A a + alpha_M m + alpha_AM a:m</span></span>
<span id="cb52-39"><a href="msm_chapter.html#cb52-39" tabindex="-1"></a>MSM.CDE.gcomp <span class="ot">&lt;-</span> <span class="fu">glm</span>(Yam.death.pred <span class="sc">~</span> A0_PM2<span class="fl">.5</span> <span class="sc">+</span>  M_diabetes <span class="sc">+</span> A0_PM2<span class="fl">.5</span><span class="sc">:</span>M_diabetes,</span>
<span id="cb52-40"><a href="msm_chapter.html#cb52-40" tabindex="-1"></a>                     <span class="at">family =</span> <span class="st">&quot;gaussian&quot;</span>, <span class="co"># gaussian family for risk differences</span></span>
<span id="cb52-41"><a href="msm_chapter.html#cb52-41" tabindex="-1"></a>                     <span class="at">data =</span> data<span class="fl">.4</span>scenarios)</span>
<span id="cb52-42"><a href="msm_chapter.html#cb52-42" tabindex="-1"></a><span class="fu">coef</span>(MSM.CDE.gcomp)</span>
<span id="cb52-43"><a href="msm_chapter.html#cb52-43" tabindex="-1"></a><span class="co"># (Intercept)            A0_PM2.5          M_diabetes A0_PM2.5:M_diabetes </span></span>
<span id="cb52-44"><a href="msm_chapter.html#cb52-44" tabindex="-1"></a><span class="co">#  0.17968603          0.06000138          0.06757214          0.01918153</span></span>
<span id="cb52-45"><a href="msm_chapter.html#cb52-45" tabindex="-1"></a></span>
<span id="cb52-46"><a href="msm_chapter.html#cb52-46" tabindex="-1"></a><span class="do">## 5. Estimate the CDE(M=m)</span></span>
<span id="cb52-47"><a href="msm_chapter.html#cb52-47" tabindex="-1"></a><span class="co"># CDE(M=0) = E(Y_{A=1,M=0}) - E(Y_{A=0,M=0})</span></span>
<span id="cb52-48"><a href="msm_chapter.html#cb52-48" tabindex="-1"></a>CDE_mis0_gcomp <span class="ot">&lt;-</span> <span class="fu">coef</span>(MSM.CDE.gcomp)[<span class="st">&quot;A0_PM2.5&quot;</span>]</span>
<span id="cb52-49"><a href="msm_chapter.html#cb52-49" tabindex="-1"></a><span class="co"># 0.06000138</span></span>
<span id="cb52-50"><a href="msm_chapter.html#cb52-50" tabindex="-1"></a></span>
<span id="cb52-51"><a href="msm_chapter.html#cb52-51" tabindex="-1"></a><span class="co"># CDE(M=1) = E(Y_{A=1,M=1}) - E(Y_{A=0,M=1})</span></span>
<span id="cb52-52"><a href="msm_chapter.html#cb52-52" tabindex="-1"></a>CDE_mis1_gcomp <span class="ot">&lt;-</span> (<span class="fu">coef</span>(MSM.CDE.gcomp)[<span class="st">&quot;A0_PM2.5&quot;</span>] <span class="sc">+</span></span>
<span id="cb52-53"><a href="msm_chapter.html#cb52-53" tabindex="-1"></a>                     <span class="fu">coef</span>(MSM.CDE.gcomp)[<span class="st">&quot;A0_PM2.5:M_diabetes&quot;</span>])</span>
<span id="cb52-54"><a href="msm_chapter.html#cb52-54" tabindex="-1"></a><span class="co"># 0.07918291</span></span>
<span id="cb52-55"><a href="msm_chapter.html#cb52-55" tabindex="-1"></a></span>
<span id="cb52-56"><a href="msm_chapter.html#cb52-56" tabindex="-1"></a><span class="co"># Note: Applying a binomial family for the first Qbar model would result in two</span></span>
<span id="cb52-57"><a href="msm_chapter.html#cb52-57" tabindex="-1"></a><span class="co"># sligthly different values of the CDE(M=m)</span></span>
<span id="cb52-58"><a href="msm_chapter.html#cb52-58" tabindex="-1"></a><span class="co"># =&gt; 0.05934409 in setting M=0</span></span>
<span id="cb52-59"><a href="msm_chapter.html#cb52-59" tabindex="-1"></a><span class="co"># =&gt; 0.07537874 in setting M=1</span></span></code></pre></div>
<p>If the exposure <span class="math inline">\(A\)</span> affects the intermediate confounder <span class="math inline">\(L(1)\)</span>, as in the Causal model 2, the steps 1) and 2) of the algorithm should follow the method described in paragraph <a href="ChapGcomp.html#ChapGcomp-CDE-param">6.2.1</a> or <a href="ChapGcomp.html#ChapGcomp-CDE-ICE">6.2.2</a>.</p>
<p>Here is an example applying G-computation by iterative conditional expectation:</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="msm_chapter.html#cb53-1" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list=</span><span class="fu">ls</span>())</span>
<span id="cb53-2"><a href="msm_chapter.html#cb53-2" tabindex="-1"></a>df2_int <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="st">&quot;data/df2_int.csv&quot;</span>)</span>
<span id="cb53-3"><a href="msm_chapter.html#cb53-3" tabindex="-1"></a></span>
<span id="cb53-4"><a href="msm_chapter.html#cb53-4" tabindex="-1"></a><span class="do">### MSM of CDE, estimated by G-computation (by ICE) ----------------------------</span></span>
<span id="cb53-5"><a href="msm_chapter.html#cb53-5" tabindex="-1"></a><span class="do">## 1a) Regress the outcome on L0, A, L1 and M (and the A*M interaction if appropriate)</span></span>
<span id="cb53-6"><a href="msm_chapter.html#cb53-6" tabindex="-1"></a>Y.death.model <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y_death <span class="sc">~</span> L0_male <span class="sc">+</span> L0_soc_env <span class="sc">+</span> A0_PM2<span class="fl">.5</span> <span class="sc">+</span> L1 <span class="sc">+</span></span>
<span id="cb53-7"><a href="msm_chapter.html#cb53-7" tabindex="-1"></a>                       M_diabetes <span class="sc">+</span> A0_PM2<span class="fl">.5</span><span class="sc">:</span>M_diabetes,</span>
<span id="cb53-8"><a href="msm_chapter.html#cb53-8" tabindex="-1"></a>                     <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>, <span class="at">data =</span> df2_int)</span>
<span id="cb53-9"><a href="msm_chapter.html#cb53-9" tabindex="-1"></a></span>
<span id="cb53-10"><a href="msm_chapter.html#cb53-10" tabindex="-1"></a><span class="do">## 1b) Generate predicted values by evaluating the regression  </span></span>
<span id="cb53-11"><a href="msm_chapter.html#cb53-11" tabindex="-1"></a><span class="do">##     under the 4 counterfactual scenarios</span></span>
<span id="cb53-12"><a href="msm_chapter.html#cb53-12" tabindex="-1"></a>data.A0M0 <span class="ot">&lt;-</span> data.A1M0 <span class="ot">&lt;-</span> data.A0M1 <span class="ot">&lt;-</span> data.A1M1 <span class="ot">&lt;-</span> df2_int</span>
<span id="cb53-13"><a href="msm_chapter.html#cb53-13" tabindex="-1"></a>data.A0M0<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb53-14"><a href="msm_chapter.html#cb53-14" tabindex="-1"></a>data.A0M0<span class="sc">$</span>M_diabetes <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb53-15"><a href="msm_chapter.html#cb53-15" tabindex="-1"></a></span>
<span id="cb53-16"><a href="msm_chapter.html#cb53-16" tabindex="-1"></a>data.A1M0<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb53-17"><a href="msm_chapter.html#cb53-17" tabindex="-1"></a>data.A1M0<span class="sc">$</span>M_diabetes <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb53-18"><a href="msm_chapter.html#cb53-18" tabindex="-1"></a></span>
<span id="cb53-19"><a href="msm_chapter.html#cb53-19" tabindex="-1"></a>data.A0M1<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb53-20"><a href="msm_chapter.html#cb53-20" tabindex="-1"></a>data.A0M1<span class="sc">$</span>M_diabetes <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb53-21"><a href="msm_chapter.html#cb53-21" tabindex="-1"></a></span>
<span id="cb53-22"><a href="msm_chapter.html#cb53-22" tabindex="-1"></a>data.A1M1<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb53-23"><a href="msm_chapter.html#cb53-23" tabindex="-1"></a>data.A1M1<span class="sc">$</span>M_diabetes <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb53-24"><a href="msm_chapter.html#cb53-24" tabindex="-1"></a></span>
<span id="cb53-25"><a href="msm_chapter.html#cb53-25" tabindex="-1"></a>Q.Y.death.A0M0 <span class="ot">&lt;-</span> <span class="fu">predict</span>(Y.death.model, <span class="at">newdata =</span> data.A0M0, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb53-26"><a href="msm_chapter.html#cb53-26" tabindex="-1"></a>Q.Y.death.A1M0 <span class="ot">&lt;-</span> <span class="fu">predict</span>(Y.death.model, <span class="at">newdata =</span> data.A1M0, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb53-27"><a href="msm_chapter.html#cb53-27" tabindex="-1"></a>Q.Y.death.A0M1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(Y.death.model, <span class="at">newdata =</span> data.A0M1, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb53-28"><a href="msm_chapter.html#cb53-28" tabindex="-1"></a>Q.Y.death.A1M1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(Y.death.model, <span class="at">newdata =</span> data.A1M1, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb53-29"><a href="msm_chapter.html#cb53-29" tabindex="-1"></a></span>
<span id="cb53-30"><a href="msm_chapter.html#cb53-30" tabindex="-1"></a><span class="do">## 2a) Regress the predicted values conditional on the observed exposure A</span></span>
<span id="cb53-31"><a href="msm_chapter.html#cb53-31" tabindex="-1"></a><span class="do">##    and baseline confounders L(0)</span></span>
<span id="cb53-32"><a href="msm_chapter.html#cb53-32" tabindex="-1"></a>L1.death.A0M0.model <span class="ot">&lt;-</span> <span class="fu">glm</span>(Q.Y.death.A0M0 <span class="sc">~</span> L0_male <span class="sc">+</span> L0_soc_env <span class="sc">+</span> A0_PM2<span class="fl">.5</span>,</span>
<span id="cb53-33"><a href="msm_chapter.html#cb53-33" tabindex="-1"></a>                           <span class="at">family =</span> <span class="st">&quot;quasibinomial&quot;</span>, <span class="at">data =</span> df2_int)</span>
<span id="cb53-34"><a href="msm_chapter.html#cb53-34" tabindex="-1"></a>L1.death.A1M0.model <span class="ot">&lt;-</span> <span class="fu">glm</span>(Q.Y.death.A1M0 <span class="sc">~</span> L0_male <span class="sc">+</span> L0_soc_env <span class="sc">+</span> A0_PM2<span class="fl">.5</span>,</span>
<span id="cb53-35"><a href="msm_chapter.html#cb53-35" tabindex="-1"></a>                           <span class="at">family =</span> <span class="st">&quot;quasibinomial&quot;</span>, <span class="at">data =</span> df2_int)</span>
<span id="cb53-36"><a href="msm_chapter.html#cb53-36" tabindex="-1"></a>L1.death.A0M1.model <span class="ot">&lt;-</span> <span class="fu">glm</span>(Q.Y.death.A0M1 <span class="sc">~</span> L0_male <span class="sc">+</span> L0_soc_env <span class="sc">+</span> A0_PM2<span class="fl">.5</span>,</span>
<span id="cb53-37"><a href="msm_chapter.html#cb53-37" tabindex="-1"></a>                           <span class="at">family =</span> <span class="st">&quot;quasibinomial&quot;</span>, <span class="at">data =</span> df2_int)</span>
<span id="cb53-38"><a href="msm_chapter.html#cb53-38" tabindex="-1"></a>L1.death.A1M1.model <span class="ot">&lt;-</span> <span class="fu">glm</span>(Q.Y.death.A1M1 <span class="sc">~</span> L0_male <span class="sc">+</span> L0_soc_env <span class="sc">+</span> A0_PM2<span class="fl">.5</span>,</span>
<span id="cb53-39"><a href="msm_chapter.html#cb53-39" tabindex="-1"></a>                           <span class="at">family =</span> <span class="st">&quot;quasibinomial&quot;</span>, <span class="at">data =</span> df2_int)</span>
<span id="cb53-40"><a href="msm_chapter.html#cb53-40" tabindex="-1"></a></span>
<span id="cb53-41"><a href="msm_chapter.html#cb53-41" tabindex="-1"></a></span>
<span id="cb53-42"><a href="msm_chapter.html#cb53-42" tabindex="-1"></a><span class="do">## 2b) generate predicted values by evaluating the regression at exposure</span></span>
<span id="cb53-43"><a href="msm_chapter.html#cb53-43" tabindex="-1"></a><span class="do">##    of interest: {A=0,M=0}, {A=1,M=0}, {A=0,M=1}, {A=1,M=1}</span></span>
<span id="cb53-44"><a href="msm_chapter.html#cb53-44" tabindex="-1"></a>data.A0M0<span class="sc">$</span>Yam.death.pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(L1.death.A0M0.model,</span>
<span id="cb53-45"><a href="msm_chapter.html#cb53-45" tabindex="-1"></a>                                    <span class="at">newdata =</span> data.A0M0, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb53-46"><a href="msm_chapter.html#cb53-46" tabindex="-1"></a>data.A1M0<span class="sc">$</span>Yam.death.pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(L1.death.A1M0.model,</span>
<span id="cb53-47"><a href="msm_chapter.html#cb53-47" tabindex="-1"></a>                                    <span class="at">newdata =</span> data.A1M0, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb53-48"><a href="msm_chapter.html#cb53-48" tabindex="-1"></a>data.A0M1<span class="sc">$</span>Yam.death.pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(L1.death.A0M1.model,</span>
<span id="cb53-49"><a href="msm_chapter.html#cb53-49" tabindex="-1"></a>                                    <span class="at">newdata =</span> data.A0M1, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb53-50"><a href="msm_chapter.html#cb53-50" tabindex="-1"></a>data.A1M1<span class="sc">$</span>Yam.death.pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(L1.death.A1M1.model,</span>
<span id="cb53-51"><a href="msm_chapter.html#cb53-51" tabindex="-1"></a>                                    <span class="at">newdata =</span> data.A1M1, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb53-52"><a href="msm_chapter.html#cb53-52" tabindex="-1"></a></span>
<span id="cb53-53"><a href="msm_chapter.html#cb53-53" tabindex="-1"></a></span>
<span id="cb53-54"><a href="msm_chapter.html#cb53-54" tabindex="-1"></a><span class="do">## 3. Append the 4 counterfactual datasets in a single long dataset</span></span>
<span id="cb53-55"><a href="msm_chapter.html#cb53-55" tabindex="-1"></a><span class="co"># number of row is 4 times the initial value (we have 4 counterfactual scenarios)</span></span>
<span id="cb53-56"><a href="msm_chapter.html#cb53-56" tabindex="-1"></a>data<span class="fl">.4</span>scenarios <span class="ot">&lt;-</span> <span class="fu">rbind</span>(data.A0M0, data.A1M0,data.A0M1,data.A1M1)</span>
<span id="cb53-57"><a href="msm_chapter.html#cb53-57" tabindex="-1"></a></span>
<span id="cb53-58"><a href="msm_chapter.html#cb53-58" tabindex="-1"></a><span class="do">## 4. fit the MSM: E(Y_am) = alpha_0 + alpha_A a + alpha_M m + alpha_AM a:m</span></span>
<span id="cb53-59"><a href="msm_chapter.html#cb53-59" tabindex="-1"></a>MSM.CDE.gcomp <span class="ot">&lt;-</span> <span class="fu">glm</span>(Yam.death.pred <span class="sc">~</span> A0_PM2<span class="fl">.5</span> <span class="sc">+</span>  M_diabetes <span class="sc">+</span> A0_PM2<span class="fl">.5</span><span class="sc">:</span>M_diabetes,</span>
<span id="cb53-60"><a href="msm_chapter.html#cb53-60" tabindex="-1"></a>                     <span class="at">family =</span> <span class="st">&quot;gaussian&quot;</span>, <span class="co"># gaussian family for risk differences</span></span>
<span id="cb53-61"><a href="msm_chapter.html#cb53-61" tabindex="-1"></a>                     <span class="at">data =</span> data<span class="fl">.4</span>scenarios)</span>
<span id="cb53-62"><a href="msm_chapter.html#cb53-62" tabindex="-1"></a><span class="fu">coef</span>(MSM.CDE.gcomp)</span>
<span id="cb53-63"><a href="msm_chapter.html#cb53-63" tabindex="-1"></a><span class="co"># (Intercept)            A0_PM2.5          M_diabetes A0_PM2.5:M_diabetes </span></span>
<span id="cb53-64"><a href="msm_chapter.html#cb53-64" tabindex="-1"></a><span class="co">#  0.17974947          0.06342833          0.07366466          0.02469485</span></span>
<span id="cb53-65"><a href="msm_chapter.html#cb53-65" tabindex="-1"></a></span>
<span id="cb53-66"><a href="msm_chapter.html#cb53-66" tabindex="-1"></a><span class="do">## 5. Estimate the CDE(M=m)</span></span>
<span id="cb53-67"><a href="msm_chapter.html#cb53-67" tabindex="-1"></a><span class="co"># CDE(M=0) = E(Y_{A=1,M=0}) - E(Y_{A=0,M=0})</span></span>
<span id="cb53-68"><a href="msm_chapter.html#cb53-68" tabindex="-1"></a>CDE_mis0_gcomp_ice <span class="ot">&lt;-</span> <span class="fu">coef</span>(MSM.CDE.gcomp)[<span class="st">&quot;A0_PM2.5&quot;</span>]</span>
<span id="cb53-69"><a href="msm_chapter.html#cb53-69" tabindex="-1"></a><span class="co"># 0.06342833</span></span>
<span id="cb53-70"><a href="msm_chapter.html#cb53-70" tabindex="-1"></a></span>
<span id="cb53-71"><a href="msm_chapter.html#cb53-71" tabindex="-1"></a><span class="co"># CDE(M=1) = E(Y_{A=1,M=1}) - E(Y_{A=0,M=1})</span></span>
<span id="cb53-72"><a href="msm_chapter.html#cb53-72" tabindex="-1"></a>CDE_mis1_gcomp_ice <span class="ot">&lt;-</span> (<span class="fu">coef</span>(MSM.CDE.gcomp)[<span class="st">&quot;A0_PM2.5&quot;</span>] <span class="sc">+</span></span>
<span id="cb53-73"><a href="msm_chapter.html#cb53-73" tabindex="-1"></a>                         <span class="fu">coef</span>(MSM.CDE.gcomp)[<span class="st">&quot;A0_PM2.5:M_diabetes&quot;</span>])</span>
<span id="cb53-74"><a href="msm_chapter.html#cb53-74" tabindex="-1"></a><span class="co"># 0.08812318</span></span></code></pre></div>
<p>The example above (MSM estimation using G-computation by ICE) corresponds to the algorithm applied by the <code>ltmle</code> package:</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="msm_chapter.html#cb54-1" tabindex="-1"></a><span class="fu">library</span>(ltmle)</span>
<span id="cb54-2"><a href="msm_chapter.html#cb54-2" tabindex="-1"></a>Qform <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">L1=</span><span class="st">&quot;Q.kplus1 ~ L0_male + L0_soc_env + A0_PM2.5&quot;</span>,</span>
<span id="cb54-3"><a href="msm_chapter.html#cb54-3" tabindex="-1"></a>           <span class="at">Y_death=</span><span class="st">&quot;Q.kplus1 ~ L0_male + L0_soc_env + L1 +</span></span>
<span id="cb54-4"><a href="msm_chapter.html#cb54-4" tabindex="-1"></a><span class="st">                    A0_PM2.5 * M_diabetes&quot;</span>)</span>
<span id="cb54-5"><a href="msm_chapter.html#cb54-5" tabindex="-1"></a>gform <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;A0_PM2.5 ~ L0_male + L0_soc_env&quot;</span>,</span>
<span id="cb54-6"><a href="msm_chapter.html#cb54-6" tabindex="-1"></a>           <span class="st">&quot;M_diabetes ~ L0_male + L0_soc_env + A0_PM2.5 + L1&quot;</span>)</span>
<span id="cb54-7"><a href="msm_chapter.html#cb54-7" tabindex="-1"></a><span class="co"># in this example of g-computation, the propensity scores &#39;gform&#39; will not be used</span></span>
<span id="cb54-8"><a href="msm_chapter.html#cb54-8" tabindex="-1"></a></span>
<span id="cb54-9"><a href="msm_chapter.html#cb54-9" tabindex="-1"></a>data_binary <span class="ot">&lt;-</span> <span class="fu">subset</span>(df2_int, <span class="at">select =</span> <span class="fu">c</span>(L0_male, L0_soc_env,</span>
<span id="cb54-10"><a href="msm_chapter.html#cb54-10" tabindex="-1"></a>                                          A0_PM2<span class="fl">.5</span>, L1,</span>
<span id="cb54-11"><a href="msm_chapter.html#cb54-11" tabindex="-1"></a>                                          M_diabetes, Y_death))</span>
<span id="cb54-12"><a href="msm_chapter.html#cb54-12" tabindex="-1"></a>CDE_ltmle_M0 <span class="ot">&lt;-</span> <span class="fu">ltmle</span>(<span class="at">data =</span> data_binary,</span>
<span id="cb54-13"><a href="msm_chapter.html#cb54-13" tabindex="-1"></a>                      <span class="at">Anodes =</span> <span class="fu">c</span>(<span class="st">&quot;A0_PM2.5&quot;</span>, <span class="st">&quot;M_diabetes&quot;</span>),</span>
<span id="cb54-14"><a href="msm_chapter.html#cb54-14" tabindex="-1"></a>                      <span class="at">Lnodes =</span> <span class="fu">c</span>(<span class="st">&quot;L1&quot;</span>), <span class="co"># intermediate confounders +/- baseline</span></span>
<span id="cb54-15"><a href="msm_chapter.html#cb54-15" tabindex="-1"></a>                      <span class="at">Ynodes =</span> <span class="fu">c</span>(<span class="st">&quot;Y_death&quot;</span>),</span>
<span id="cb54-16"><a href="msm_chapter.html#cb54-16" tabindex="-1"></a>                      <span class="at">survivalOutcome =</span> <span class="cn">FALSE</span>, <span class="co"># TRUE for time-to-event outcomes Y</span></span>
<span id="cb54-17"><a href="msm_chapter.html#cb54-17" tabindex="-1"></a>                      <span class="at">Qform =</span> Qform,</span>
<span id="cb54-18"><a href="msm_chapter.html#cb54-18" tabindex="-1"></a>                      <span class="at">gform =</span> gform,</span>
<span id="cb54-19"><a href="msm_chapter.html#cb54-19" tabindex="-1"></a>                      <span class="at">abar =</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">0</span>), <span class="co"># counterfactual intervention do(A=1,M=0)</span></span>
<span id="cb54-20"><a href="msm_chapter.html#cb54-20" tabindex="-1"></a>                                  <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>)), <span class="co"># counterfactual intervention do(A=0,M=0)</span></span>
<span id="cb54-21"><a href="msm_chapter.html#cb54-21" tabindex="-1"></a>                      <span class="at">SL.library =</span> <span class="cn">NULL</span>, <span class="co"># calls glm() instead of SuperLearner</span></span>
<span id="cb54-22"><a href="msm_chapter.html#cb54-22" tabindex="-1"></a>                      <span class="at">estimate.time =</span> <span class="cn">FALSE</span>, <span class="co"># estimate computation time?</span></span>
<span id="cb54-23"><a href="msm_chapter.html#cb54-23" tabindex="-1"></a>                      <span class="at">gcomp =</span> <span class="cn">TRUE</span>, <span class="co"># to apply g-computation</span></span>
<span id="cb54-24"><a href="msm_chapter.html#cb54-24" tabindex="-1"></a>                      <span class="at">variance.method =</span> <span class="st">&quot;ic&quot;</span>)</span>
<span id="cb54-25"><a href="msm_chapter.html#cb54-25" tabindex="-1"></a><span class="co"># CDE with M=0</span></span>
<span id="cb54-26"><a href="msm_chapter.html#cb54-26" tabindex="-1"></a><span class="fu">summary</span>(CDE_ltmle_M0)<span class="sc">$</span>effect.measures<span class="sc">$</span>ATE<span class="sc">$</span>estimate</span>
<span id="cb54-27"><a href="msm_chapter.html#cb54-27" tabindex="-1"></a><span class="co">#   Parameter Estimate:  0.06342833</span></span>
<span id="cb54-28"><a href="msm_chapter.html#cb54-28" tabindex="-1"></a></span>
<span id="cb54-29"><a href="msm_chapter.html#cb54-29" tabindex="-1"></a>CDE_ltmle_M1 <span class="ot">&lt;-</span> <span class="fu">ltmle</span>(<span class="at">data =</span> data_binary,</span>
<span id="cb54-30"><a href="msm_chapter.html#cb54-30" tabindex="-1"></a>                      <span class="at">Anodes =</span> <span class="fu">c</span>(<span class="st">&quot;A0_PM2.5&quot;</span>, <span class="st">&quot;M_diabetes&quot;</span>),</span>
<span id="cb54-31"><a href="msm_chapter.html#cb54-31" tabindex="-1"></a>                      <span class="at">Lnodes =</span> <span class="fu">c</span>(<span class="st">&quot;L1&quot;</span>), <span class="co"># intermediate confounders +/- baseline</span></span>
<span id="cb54-32"><a href="msm_chapter.html#cb54-32" tabindex="-1"></a>                      <span class="at">Ynodes =</span> <span class="fu">c</span>(<span class="st">&quot;Y_death&quot;</span>),</span>
<span id="cb54-33"><a href="msm_chapter.html#cb54-33" tabindex="-1"></a>                      <span class="at">survivalOutcome =</span> <span class="cn">FALSE</span>, <span class="co"># TRUE for time-to-event outcomes Y</span></span>
<span id="cb54-34"><a href="msm_chapter.html#cb54-34" tabindex="-1"></a>                      <span class="at">Qform =</span> Qform,</span>
<span id="cb54-35"><a href="msm_chapter.html#cb54-35" tabindex="-1"></a>                      <span class="at">gform =</span> gform,</span>
<span id="cb54-36"><a href="msm_chapter.html#cb54-36" tabindex="-1"></a>                      <span class="at">abar =</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>), <span class="co"># counterfactual intervention do(A=1,M=0)</span></span>
<span id="cb54-37"><a href="msm_chapter.html#cb54-37" tabindex="-1"></a>                                  <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)), <span class="co"># counterfactual intervention do(A=0,M=0)</span></span>
<span id="cb54-38"><a href="msm_chapter.html#cb54-38" tabindex="-1"></a>                      <span class="at">SL.library =</span> <span class="cn">NULL</span>, <span class="co"># calls glm() instead of SuperLearner</span></span>
<span id="cb54-39"><a href="msm_chapter.html#cb54-39" tabindex="-1"></a>                      <span class="at">estimate.time =</span> <span class="cn">FALSE</span>, <span class="co"># estimate computation time?</span></span>
<span id="cb54-40"><a href="msm_chapter.html#cb54-40" tabindex="-1"></a>                      <span class="at">gcomp =</span> <span class="cn">TRUE</span>, <span class="co"># to apply g-computation</span></span>
<span id="cb54-41"><a href="msm_chapter.html#cb54-41" tabindex="-1"></a>                      <span class="at">variance.method =</span> <span class="st">&quot;ic&quot;</span>)</span>
<span id="cb54-42"><a href="msm_chapter.html#cb54-42" tabindex="-1"></a><span class="co"># CDE with M=1</span></span>
<span id="cb54-43"><a href="msm_chapter.html#cb54-43" tabindex="-1"></a><span class="fu">summary</span>(CDE_ltmle_M1)<span class="sc">$</span>effect.measures<span class="sc">$</span>ATE<span class="sc">$</span>estimate</span>
<span id="cb54-44"><a href="msm_chapter.html#cb54-44" tabindex="-1"></a><span class="co">#   Parameter Estimate:  0.08812318</span></span></code></pre></div>
</div>
</div>
<div id="msm_NDE_NIE_paragraph" class="section level2 hasAnchor" number="8.3">
<h2><span class="header-section-number">8.3</span> MSM for Natural Direct and Indirect Effects<a href="msm_chapter.html#msm_NDE_NIE_paragraph" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="expressing-the-nde-and-nie-using-coefficients-of-2-msms" class="section level3 hasAnchor" number="8.3.1">
<h3><span class="header-section-number">8.3.1</span> Expressing the NDE and NIE using coefficients of 2 MSMs<a href="msm_chapter.html#expressing-the-nde-and-nie-using-coefficients-of-2-msms" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The (Pure) Natural Direct Effect is defined by <span class="math inline">\(\text{PNDE} = \mathbb{E}(Y_{a,M_{a^*}}) - \mathbb{E}(Y_{a^*,M_{a^*}})\)</span> and the (Total) Natural Indirect Effect is defined by <span class="math inline">\(\text{TNIE} = \mathbb{E}(Y_{a,M_a}) - \mathbb{E}(Y_{a,M_{a^*}})\)</span>.</p>
<p>VanderWeele suggested using 2 MSMs conditional on baseline confounders <span class="math inline">\(L(0)\)</span> in order to estimate natural direct and indirect effects <span class="citation">(<a href="#ref-vanderweele2009">VanderWeele 2009</a>)</span>:</p>
<ol style="list-style-type: decimal">
<li><p>a model of the counterfactual values of the outcome <span class="math inline">\(\mathbb{E}(Y_{a,m} \mid l(0))=h^{-1}(a,m,l(0))\)</span>, where <span class="math inline">\(h\)</span> is a link function. For example:
<span class="math display" id="eq:MSM-Indirect-model1">\[\begin{equation}
    \mathbb{E}(Y_{a,m} \mid l(0)) = \alpha_0 + \alpha_A a + \alpha_M m + \alpha_{AM} a \times m + \alpha_{L(0)} l(0) \tag{8.5}
  \end{equation}\]</span>
(where <span class="math inline">\(h\)</span> is the identity function, so that the model can be used to express risk differences)</p></li>
<li><p>a model of the counterfactual values of the mediator <span class="math inline">\(\mathbb{E}(M_{a} \mid L(0))=g^{-1}(a,l(0))\)</span>, where <span class="math inline">\(g\)</span> is a link function. For example with a binary mediator:
<span class="math display" id="eq:MSM-Indirect-model2">\[\begin{equation}
    \mathbb{E}(M_a \mid l(0)) = g^{-1}\left[\beta_0 + \beta_A a + \beta_{L(0)} l(0) \right]
    \tag{8.6}
  \end{equation}\]</span>
(where <span class="math inline">\(g\)</span> is the logit function because the mediator is binary).</p></li>
</ol>
<p>VanderWeele shows that if the function <span class="math inline">\(h\)</span> is linear in <span class="math inline">\(m\)</span> (no quadratic terms in <span class="math inline">\(m\)</span>, nor transformations such as <span class="math inline">\(\log(m)\)</span> or <span class="math inline">\(\sqrt{m}\)</span>, etc) and the exposure <span class="math inline">\(A\)</span> does not affect the intermediate confounder <span class="math inline">\(L(1)\)</span>, then
<span class="math display">\[\begin{equation*}
  \mathbb{E}(Y_{a,M_{a^*}}) = h^{-1}\left[a,g^{-1}\left(a^*,l(0)\right),l(0)\right]
\end{equation*}\]</span></p>
<p>Using the 2 MSMs, we can express the Natural Direct and Indirect Effects conditional on baseline confounders <span class="math inline">\(L(0)\)</span>. In our example:
<span class="math display">\[\begin{align*}
  \text{PNDE} \mid L(0) &amp;= \mathbb{E}(Y_{a,M_{a^*}} \mid L(0)) - \mathbb{E}(Y_{a^*,M_{a^*}} \mid L(0)) \\
  &amp;= \{\alpha_0 + \alpha_A a + [\alpha_M + \alpha_{AM}a] \times g^{-1}(a^*,l(0)) + \alpha_{L(0)} l(0) \} \\
  &amp; \quad \quad - \{ \alpha_0 + \alpha_A a^*+ [\alpha_M + \alpha_{AM}a^*] \times g^{-1}(a^*,l(0)) + \alpha_{L(0)} l(0) \} \\
  &amp;= (a - a^*) \times [\alpha_A + \alpha_{AM} \times g^{-1}(a^*,l(0))]
\end{align*}\]</span></p>
<p><span class="math display">\[\begin{align*}
  \text{TNIE} \mid L(0) &amp;= \mathbb{E}(Y_{a,M_{a}} \mid L(0)) - \mathbb{E}(Y_{a,M_{a^*}} \mid L(0)) \\
  &amp;= \{\alpha_0 + \alpha_A a + [\alpha_M + \alpha_{AM}a] \times g^{-1}(a,l(0)) + \alpha_{L(0)} l(0) \} \\
  &amp; \quad \quad - \{ \alpha_0 + \alpha_A a+ [\alpha_M + \alpha_{AM}a] \times g^{-1}(a^*,l(0)) + \alpha_{L(0)} l(0) \} \\
  &amp;= \left[ g^{-1}(a,l(0)) - g^{-1}(a^*,l(0)) \right](\alpha_M + \alpha_{AM} a)
\end{align*}\]</span></p>
<p>Marginal Natural Direct and Indirect effect can then be obtained:
<span class="math display">\[\begin{align*}
  \text{PNDE} &amp;= \sum_{l(0)} \left[ \text{PNDE} \mid L(0) = l(0) \right] \times P(L(0)=l(0)) \\
  \quad \text{TNIE} &amp;= \sum_{l(0)} \left[ \text{TNIE} \mid L(0) = l(0) \right] \times P(L(0)=l(0))
\end{align*}\]</span></p>
</div>
<div id="estimation-of-the-2-msms-coefficients-by-iptw-for-nde-and-nie" class="section level3 hasAnchor" number="8.3.2">
<h3><span class="header-section-number">8.3.2</span> Estimation of the 2 MSMs coefficients by IPTW for NDE and NIE<a href="msm_chapter.html#estimation-of-the-2-msms-coefficients-by-iptw-for-nde-and-nie" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>As previously, MSM coefficients can be estimated using an Inverse Probability of Treatment (IPTW) approach based on weighted regressions.</p>
<p>In order to fit the 1st MSM <a href="msm_chapter.html#eq:MSM-Indirect-model1">(8.5)</a>, we can use a linear regression of the (observed) outcome <span class="math inline">\(Y\)</span> on the exposure and mediator, adjusted for <span class="math inline">\(L(0)\)</span>, weighted by individual stabilized weights <span class="math inline">\(sw_{msm1,i}\)</span> <span class="citation">(<a href="#ref-vanderweele2009">VanderWeele 2009</a>)</span>:
<span class="math display">\[\begin{equation*}
  \mathbb{E}\left(Y \mid A,M,L(0)\right) = \alpha_0 + \alpha_A a + \alpha_M m + \alpha_{AM} a \times m + \alpha_{L(0)} L(0)
\end{equation*}\]</span></p>
<p>where <span class="math inline">\(sw_{msm1,i}\)</span> is the product of two weights <span class="math inline">\(sw_{msm1,i} = sw_{A,i} \times sw_{M,i}\)</span>,
<span class="math display">\[\begin{align*}
  sw_{A,i} =&amp; \frac{P(A=a_i)}{P(A=a_i \mid L(0)=l(0)_i)} \quad \text{or} \quad sw_{A,i} = \frac{P(A=a_i \mid L(0)=l(0)_i)}{P(A=a_i \mid L(0)=l(0)_i)} = 1 \\
  sw_{M,i} =&amp; \frac{P(M=m_i \mid A=a_i)}{P(M = m_i \mid A=a_i,L(0)=l(0)_i), L(1)=l(1)_i} \\
  &amp; \quad \text{or} \quad sw_{M,i} = \frac{P(M=m_i \mid A=a_i,L(0)=l(0)_i)}{P(M = m_i \mid A=a_i,L(0)=l(0)_i), L(1)=l(1)_i} \\
\end{align*}\]</span></p>
<p>In order to fit the 2nd MSM <a href="msm_chapter.html#eq:MSM-Indirect-model2">(8.6)</a>, we can use a logistic regression of the (observed) mediator <span class="math inline">\(M\)</span> on the exposure, adjusted for <span class="math inline">\(L(0)\)</span>, weighted by individual stabilized weights <span class="math inline">\(sw_{msm2,i}\)</span>:
<span class="math display">\[\begin{equation*}
\text{logit} \mathbb{E}(M \mid a,l(0)) = \beta_0 + \beta_A a + \beta_{L(0)} l(0)
\end{equation*}\]</span></p>
<p><span class="math display">\[\begin{equation*}
\text{where} \quad sw_{msm2,i} = \frac{P(A=a_i)}{P(A=a_i \mid L(0)=l(0)_i)}
\end{equation*}\]</span></p>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="msm_chapter.html#cb55-1" tabindex="-1"></a><span class="do">### MSM of NDE &amp; NIE, estimated by IPTW ----------------------------------------</span></span>
<span id="cb55-2"><a href="msm_chapter.html#cb55-2" tabindex="-1"></a><span class="do">## 1. Stabilized weight for the MSM1</span></span>
<span id="cb55-3"><a href="msm_chapter.html#cb55-3" tabindex="-1"></a><span class="co"># 1a. sw_Ai = g(A=a_i | L(0)) / g(A=a_i | L(0)) = 1</span></span>
<span id="cb55-4"><a href="msm_chapter.html#cb55-4" tabindex="-1"></a>sw_Ai <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">nrow</span>(df1_int))</span>
<span id="cb55-5"><a href="msm_chapter.html#cb55-5" tabindex="-1"></a></span>
<span id="cb55-6"><a href="msm_chapter.html#cb55-6" tabindex="-1"></a><span class="co"># 1b. sw_Mi = g(M=m_i | A,L(0)) / g(M=m_i | A,L(0),L(1))</span></span>
<span id="cb55-7"><a href="msm_chapter.html#cb55-7" tabindex="-1"></a>g.M.AL0 <span class="ot">&lt;-</span> <span class="fu">glm</span>(M_diabetes <span class="sc">~</span> A0_PM2<span class="fl">.5</span> <span class="sc">+</span> L0_male <span class="sc">+</span> L0_soc_env,</span>
<span id="cb55-8"><a href="msm_chapter.html#cb55-8" tabindex="-1"></a>               <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>, <span class="at">data =</span> df1_int)</span>
<span id="cb55-9"><a href="msm_chapter.html#cb55-9" tabindex="-1"></a>g.Mis1.AL0 <span class="ot">&lt;-</span> <span class="fu">predict</span>(g.M.AL0, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb55-10"><a href="msm_chapter.html#cb55-10" tabindex="-1"></a>sw_M.num <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">nrow</span>(df1_int))</span>
<span id="cb55-11"><a href="msm_chapter.html#cb55-11" tabindex="-1"></a>sw_M.num[df1_int<span class="sc">$</span>M_diabetes<span class="sc">==</span><span class="dv">1</span>] <span class="ot">&lt;-</span> g.Mis1.AL0[df1_int<span class="sc">$</span>M_diabetes<span class="sc">==</span><span class="dv">1</span>]</span>
<span id="cb55-12"><a href="msm_chapter.html#cb55-12" tabindex="-1"></a>sw_M.num[df1_int<span class="sc">$</span>M_diabetes<span class="sc">==</span><span class="dv">0</span>] <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> g.Mis1.AL0[df1_int<span class="sc">$</span>M_diabetes<span class="sc">==</span><span class="dv">0</span>])</span>
<span id="cb55-13"><a href="msm_chapter.html#cb55-13" tabindex="-1"></a></span>
<span id="cb55-14"><a href="msm_chapter.html#cb55-14" tabindex="-1"></a>g.M.AL0L1 <span class="ot">&lt;-</span> <span class="fu">glm</span>(M_diabetes <span class="sc">~</span> A0_PM2<span class="fl">.5</span> <span class="sc">+</span> L0_male <span class="sc">+</span> L0_soc_env <span class="sc">+</span> L1,</span>
<span id="cb55-15"><a href="msm_chapter.html#cb55-15" tabindex="-1"></a>                 <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>, <span class="at">data =</span> df1_int)</span>
<span id="cb55-16"><a href="msm_chapter.html#cb55-16" tabindex="-1"></a>g.Mis1.AL0L1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(g.M.AL0L1, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb55-17"><a href="msm_chapter.html#cb55-17" tabindex="-1"></a>sw_M.denom <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">nrow</span>(df1_int))</span>
<span id="cb55-18"><a href="msm_chapter.html#cb55-18" tabindex="-1"></a>sw_M.denom[df1_int<span class="sc">$</span>M_diabetes<span class="sc">==</span><span class="dv">1</span>] <span class="ot">&lt;-</span> g.Mis1.AL0L1[df1_int<span class="sc">$</span>M_diabetes<span class="sc">==</span><span class="dv">1</span>]</span>
<span id="cb55-19"><a href="msm_chapter.html#cb55-19" tabindex="-1"></a>sw_M.denom[df1_int<span class="sc">$</span>M_diabetes<span class="sc">==</span><span class="dv">0</span>] <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> g.Mis1.AL0L1[df1_int<span class="sc">$</span>M_diabetes<span class="sc">==</span><span class="dv">0</span>])</span>
<span id="cb55-20"><a href="msm_chapter.html#cb55-20" tabindex="-1"></a></span>
<span id="cb55-21"><a href="msm_chapter.html#cb55-21" tabindex="-1"></a>sw_msm1 <span class="ot">&lt;-</span> sw_Ai <span class="sc">*</span> sw_M.num <span class="sc">/</span> sw_M.denom</span>
<span id="cb55-22"><a href="msm_chapter.html#cb55-22" tabindex="-1"></a></span>
<span id="cb55-23"><a href="msm_chapter.html#cb55-23" tabindex="-1"></a><span class="do">## 2. Estimate coefficients of the MSM1</span></span>
<span id="cb55-24"><a href="msm_chapter.html#cb55-24" tabindex="-1"></a>MSM1 <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y_death <span class="sc">~</span> A0_PM2<span class="fl">.5</span> <span class="sc">+</span> M_diabetes <span class="sc">+</span> A0_PM2<span class="fl">.5</span><span class="sc">:</span>M_diabetes <span class="sc">+</span></span>
<span id="cb55-25"><a href="msm_chapter.html#cb55-25" tabindex="-1"></a>              L0_male <span class="sc">+</span> L0_soc_env,</span>
<span id="cb55-26"><a href="msm_chapter.html#cb55-26" tabindex="-1"></a>            <span class="at">weights =</span> sw_msm1,</span>
<span id="cb55-27"><a href="msm_chapter.html#cb55-27" tabindex="-1"></a>            <span class="at">family =</span> <span class="st">&quot;gaussian&quot;</span>,</span>
<span id="cb55-28"><a href="msm_chapter.html#cb55-28" tabindex="-1"></a>            <span class="at">data =</span> df1_int)</span>
<span id="cb55-29"><a href="msm_chapter.html#cb55-29" tabindex="-1"></a><span class="fu">coef</span>(MSM1)</span>
<span id="cb55-30"><a href="msm_chapter.html#cb55-30" tabindex="-1"></a><span class="co"># (Intercept)     A0_PM2.5  M_diabetes    L0_male L0_soc_env  A0_PM2.5:M_diabetes</span></span>
<span id="cb55-31"><a href="msm_chapter.html#cb55-31" tabindex="-1"></a><span class="co">#  0.12033221   0.06381257  0.06691712 0.04671886 0.05521263           0.01652446</span></span>
<span id="cb55-32"><a href="msm_chapter.html#cb55-32" tabindex="-1"></a></span>
<span id="cb55-33"><a href="msm_chapter.html#cb55-33" tabindex="-1"></a><span class="do">## 3. Stabilized weight for the MSM2</span></span>
<span id="cb55-34"><a href="msm_chapter.html#cb55-34" tabindex="-1"></a><span class="co"># 3a. sw_A = g(A=a_i) / g(A=a_i | L(0))</span></span>
<span id="cb55-35"><a href="msm_chapter.html#cb55-35" tabindex="-1"></a><span class="co"># numerator</span></span>
<span id="cb55-36"><a href="msm_chapter.html#cb55-36" tabindex="-1"></a>g.A <span class="ot">&lt;-</span> <span class="fu">glm</span>(A0_PM2<span class="fl">.5</span> <span class="sc">~</span> <span class="dv">1</span>, <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>, <span class="at">data =</span> df1_int)</span>
<span id="cb55-37"><a href="msm_chapter.html#cb55-37" tabindex="-1"></a>g.Ais1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(g.A, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb55-38"><a href="msm_chapter.html#cb55-38" tabindex="-1"></a>sw_msm2.num <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">nrow</span>(df1_int))</span>
<span id="cb55-39"><a href="msm_chapter.html#cb55-39" tabindex="-1"></a>sw_msm2.num[df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">1</span>] <span class="ot">&lt;-</span> g.Ais1[df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">1</span>]</span>
<span id="cb55-40"><a href="msm_chapter.html#cb55-40" tabindex="-1"></a>sw_msm2.num[df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">0</span>] <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> g.Ais1[df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">0</span>])</span>
<span id="cb55-41"><a href="msm_chapter.html#cb55-41" tabindex="-1"></a></span>
<span id="cb55-42"><a href="msm_chapter.html#cb55-42" tabindex="-1"></a><span class="co"># denominator</span></span>
<span id="cb55-43"><a href="msm_chapter.html#cb55-43" tabindex="-1"></a>g.A.L0 <span class="ot">&lt;-</span> <span class="fu">glm</span>(A0_PM2<span class="fl">.5</span> <span class="sc">~</span> L0_male <span class="sc">+</span> L0_soc_env,</span>
<span id="cb55-44"><a href="msm_chapter.html#cb55-44" tabindex="-1"></a>              <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>, <span class="at">data =</span> df1_int)</span>
<span id="cb55-45"><a href="msm_chapter.html#cb55-45" tabindex="-1"></a>g.Ais1.L0 <span class="ot">&lt;-</span> <span class="fu">predict</span>(g.A.L0, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb55-46"><a href="msm_chapter.html#cb55-46" tabindex="-1"></a>sw_msm2.denom <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">nrow</span>(df1_int))</span>
<span id="cb55-47"><a href="msm_chapter.html#cb55-47" tabindex="-1"></a>sw_msm2.denom[df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">1</span>] <span class="ot">&lt;-</span> g.Ais1.L0[df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">1</span>]</span>
<span id="cb55-48"><a href="msm_chapter.html#cb55-48" tabindex="-1"></a>sw_msm2.denom[df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">0</span>] <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> g.Ais1.L0[df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">0</span>])</span>
<span id="cb55-49"><a href="msm_chapter.html#cb55-49" tabindex="-1"></a></span>
<span id="cb55-50"><a href="msm_chapter.html#cb55-50" tabindex="-1"></a><span class="co"># stabilized weight</span></span>
<span id="cb55-51"><a href="msm_chapter.html#cb55-51" tabindex="-1"></a>sw_msm2 <span class="ot">&lt;-</span> sw_msm2.num <span class="sc">/</span> sw_msm2.denom</span>
<span id="cb55-52"><a href="msm_chapter.html#cb55-52" tabindex="-1"></a></span>
<span id="cb55-53"><a href="msm_chapter.html#cb55-53" tabindex="-1"></a><span class="do">## 3. Estimate coefficients of the MSM2</span></span>
<span id="cb55-54"><a href="msm_chapter.html#cb55-54" tabindex="-1"></a>MSM2 <span class="ot">&lt;-</span> <span class="fu">glm</span>(M_diabetes <span class="sc">~</span> A0_PM2<span class="fl">.5</span> <span class="sc">+</span> L0_male <span class="sc">+</span> L0_soc_env,</span>
<span id="cb55-55"><a href="msm_chapter.html#cb55-55" tabindex="-1"></a>            <span class="at">weights =</span> sw_msm2,</span>
<span id="cb55-56"><a href="msm_chapter.html#cb55-56" tabindex="-1"></a>            <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>,</span>
<span id="cb55-57"><a href="msm_chapter.html#cb55-57" tabindex="-1"></a>            <span class="at">data =</span> df1_int)</span>
<span id="cb55-58"><a href="msm_chapter.html#cb55-58" tabindex="-1"></a><span class="fu">coef</span>(MSM2)</span>
<span id="cb55-59"><a href="msm_chapter.html#cb55-59" tabindex="-1"></a><span class="co"># (Intercept)    A0_PM2.5     L0_male   L0_soc_env</span></span>
<span id="cb55-60"><a href="msm_chapter.html#cb55-60" tabindex="-1"></a><span class="co">#  -1.2723106   0.5883720   0.2566129    0.3270087</span></span>
<span id="cb55-61"><a href="msm_chapter.html#cb55-61" tabindex="-1"></a></span>
<span id="cb55-62"><a href="msm_chapter.html#cb55-62" tabindex="-1"></a><span class="do">## 4. Estimate PNDE conditional on L(0), and the marginal value of PNDE</span></span>
<span id="cb55-63"><a href="msm_chapter.html#cb55-63" tabindex="-1"></a><span class="co"># a = 1 and a* = 0</span></span>
<span id="cb55-64"><a href="msm_chapter.html#cb55-64" tabindex="-1"></a><span class="co"># PNDE|L(0) = (a - a*)[alpha_A + alpha_AM.g^-1(a^*,l(0))]</span></span>
<span id="cb55-65"><a href="msm_chapter.html#cb55-65" tabindex="-1"></a>g.minus1.A0 <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="fu">coef</span>(MSM2)[<span class="st">&quot;(Intercept)&quot;</span>] <span class="sc">+</span> <span class="fu">coef</span>(MSM2)[<span class="st">&quot;A0_PM2.5&quot;</span>] <span class="sc">*</span> <span class="dv">0</span> <span class="sc">+</span></span>
<span id="cb55-66"><a href="msm_chapter.html#cb55-66" tabindex="-1"></a>                      <span class="fu">coef</span>(MSM2)[<span class="st">&quot;L0_male&quot;</span>] <span class="sc">*</span> df1_int<span class="sc">$</span>L0_male <span class="sc">+</span></span>
<span id="cb55-67"><a href="msm_chapter.html#cb55-67" tabindex="-1"></a>                      <span class="fu">coef</span>(MSM2)[<span class="st">&quot;L0_soc_env&quot;</span>] <span class="sc">*</span> df1_int<span class="sc">$</span>L0_soc_env)</span>
<span id="cb55-68"><a href="msm_chapter.html#cb55-68" tabindex="-1"></a></span>
<span id="cb55-69"><a href="msm_chapter.html#cb55-69" tabindex="-1"></a><span class="co"># PNDE conditional on L(0)</span></span>
<span id="cb55-70"><a href="msm_chapter.html#cb55-70" tabindex="-1"></a>PNDE_L0 <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="dv">0</span>) <span class="sc">*</span> (<span class="fu">coef</span>(MSM1)[<span class="st">&quot;A0_PM2.5&quot;</span>] <span class="sc">+</span></span>
<span id="cb55-71"><a href="msm_chapter.html#cb55-71" tabindex="-1"></a>                        <span class="fu">coef</span>(MSM1)[<span class="st">&quot;A0_PM2.5:M_diabetes&quot;</span>] <span class="sc">*</span> g.minus1.A0)</span>
<span id="cb55-72"><a href="msm_chapter.html#cb55-72" tabindex="-1"></a><span class="co"># marginal PNDE</span></span>
<span id="cb55-73"><a href="msm_chapter.html#cb55-73" tabindex="-1"></a>PNDE <span class="ot">&lt;-</span> <span class="fu">mean</span>(PNDE_L0)</span>
<span id="cb55-74"><a href="msm_chapter.html#cb55-74" tabindex="-1"></a><span class="co"># [1] 0.06850657</span></span>
<span id="cb55-75"><a href="msm_chapter.html#cb55-75" tabindex="-1"></a></span>
<span id="cb55-76"><a href="msm_chapter.html#cb55-76" tabindex="-1"></a><span class="do">## 4. Estimate TNIE conditional on L(0), and the marginal value of TNIE</span></span>
<span id="cb55-77"><a href="msm_chapter.html#cb55-77" tabindex="-1"></a><span class="co"># TNIE|L(0) = [g^-1(a,l(0)) - g^-1(a^*,l(0))] * (alpha_M + alpha_AM * a)</span></span>
<span id="cb55-78"><a href="msm_chapter.html#cb55-78" tabindex="-1"></a>g.minus1.A1 <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="fu">coef</span>(MSM2)[<span class="st">&quot;(Intercept)&quot;</span>] <span class="sc">+</span> <span class="fu">coef</span>(MSM2)[<span class="st">&quot;A0_PM2.5&quot;</span>] <span class="sc">*</span> <span class="dv">1</span> <span class="sc">+</span></span>
<span id="cb55-79"><a href="msm_chapter.html#cb55-79" tabindex="-1"></a>                        <span class="fu">coef</span>(MSM2)[<span class="st">&quot;L0_male&quot;</span>] <span class="sc">*</span> df1_int<span class="sc">$</span>L0_male <span class="sc">+</span></span>
<span id="cb55-80"><a href="msm_chapter.html#cb55-80" tabindex="-1"></a>                        <span class="fu">coef</span>(MSM2)[<span class="st">&quot;L0_soc_env&quot;</span>] <span class="sc">*</span> df1_int<span class="sc">$</span>L0_soc_env)</span>
<span id="cb55-81"><a href="msm_chapter.html#cb55-81" tabindex="-1"></a></span>
<span id="cb55-82"><a href="msm_chapter.html#cb55-82" tabindex="-1"></a><span class="co"># TNIE conditional on L(0)</span></span>
<span id="cb55-83"><a href="msm_chapter.html#cb55-83" tabindex="-1"></a>TNIE_L0 <span class="ot">&lt;-</span> (g.minus1.A1 <span class="sc">-</span> g.minus1.A0) <span class="sc">*</span> (<span class="fu">coef</span>(MSM1)[<span class="st">&quot;M_diabetes&quot;</span>] <span class="sc">+</span></span>
<span id="cb55-84"><a href="msm_chapter.html#cb55-84" tabindex="-1"></a>                                            <span class="fu">coef</span>(MSM1)[<span class="st">&quot;A0_PM2.5:M_diabetes&quot;</span>] <span class="sc">*</span> <span class="dv">1</span>)</span>
<span id="cb55-85"><a href="msm_chapter.html#cb55-85" tabindex="-1"></a><span class="co"># marginal PNDE</span></span>
<span id="cb55-86"><a href="msm_chapter.html#cb55-86" tabindex="-1"></a>TNIE <span class="ot">&lt;-</span> <span class="fu">mean</span>(TNIE_L0)</span>
<span id="cb55-87"><a href="msm_chapter.html#cb55-87" tabindex="-1"></a><span class="co"># [1] 0.01096799</span></span></code></pre></div>
<p>In this example, the estimation of the PNDE is 6.9% and the estimation of the TNIE is 1.1%. Confidence intervals can be calculated by bootstrap.</p>

</div>
</div>
</div>
<h3>References<a href="references.html#references" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-vanderweele2009" class="csl-entry">
VanderWeele, Tyler J. 2009. <span>“Marginal Structural Models for the Estimation of Direct and Indirect Effects.”</span> <em>Epidemiology</em> 20: 18–26.
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="ChapIptw.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="chap_tmle.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/benoitlepage/mediation_workshop/05-MSM.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
