<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 7 Inverse Probability of Treatment Weighting (IPTW) | Mediation Workshop</title>
  <meta name="description" content="Expanse project - Mediation workshop. Online complementary document with practical examples in R." />
  <meta name="generator" content="bookdown 0.40 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 7 Inverse Probability of Treatment Weighting (IPTW) | Mediation Workshop" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="Expanse project - Mediation workshop. Online complementary document with practical examples in R." />
  <meta name="github-repo" content="mediation_workshop" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 7 Inverse Probability of Treatment Weighting (IPTW) | Mediation Workshop" />
  
  <meta name="twitter:description" content="Expanse project - Mediation workshop. Online complementary document with practical examples in R." />
  

<meta name="author" content="Benoît Lepage" />


<meta name="date" content="2024-10-27" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="ChapGcomp.html"/>
<link rel="next" href="msm_chapter.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>
<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Mediation workshop</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a></li>
<li class="chapter" data-level="2" data-path="software.html"><a href="software.html"><i class="fa fa-check"></i><b>2</b> Software</a></li>
<li class="chapter" data-level="3" data-path="data-sets.html"><a href="data-sets.html"><i class="fa fa-check"></i><b>3</b> Data sets</a>
<ul>
<li class="chapter" data-level="3.1" data-path="data-sets.html"><a href="data-sets.html#general-presentation-of-the-data-used-in-our-examples"><i class="fa fa-check"></i><b>3.1</b> General presentation of the data used in our examples</a></li>
<li class="chapter" data-level="3.2" data-path="data-sets.html"><a href="data-sets.html#data-generating-mechanisms"><i class="fa fa-check"></i><b>3.2</b> Data generating mechanisms</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="ChapBaronKennySem.html"><a href="ChapBaronKennySem.html"><i class="fa fa-check"></i><b>4</b> Baron and Kenny, structural equation models</a>
<ul>
<li class="chapter" data-level="4.1" data-path="ChapBaronKennySem.html"><a href="ChapBaronKennySem.html#baron-and-kenny-approach"><i class="fa fa-check"></i><b>4.1</b> Baron and Kenny approach</a></li>
<li class="chapter" data-level="4.2" data-path="ChapBaronKennySem.html"><a href="ChapBaronKennySem.html#path-analysis-and-structural-equation-modeling"><i class="fa fa-check"></i><b>4.2</b> Path analysis and Structural Equation Modeling</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="ChapBaronKennySem.html"><a href="ChapBaronKennySem.html#first-application-without-intermediate-confouding-affected-by-the-exposure"><i class="fa fa-check"></i><b>4.2.1</b> First application, without intermediate confouding affected by the exposure</a></li>
<li class="chapter" data-level="4.2.2" data-path="ChapBaronKennySem.html"><a href="ChapBaronKennySem.html#dealing-with-categorical-endogenous-variables"><i class="fa fa-check"></i><b>4.2.2</b> Dealing with categorical endogenous variables</a></li>
<li class="chapter" data-level="4.2.3" data-path="ChapBaronKennySem.html"><a href="ChapBaronKennySem.html#application-with-intermediate-confounding-affected-by-the-exposure"><i class="fa fa-check"></i><b>4.2.3</b> Application with intermediate confounding affected by the exposure</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="ChapTradRegModels.html"><a href="ChapTradRegModels.html"><i class="fa fa-check"></i><b>5</b> Traditional regression models</a>
<ul>
<li class="chapter" data-level="5.1" data-path="ChapTradRegModels.html"><a href="ChapTradRegModels.html#estimation-of-the-average-total-effect-ate"><i class="fa fa-check"></i><b>5.1</b> Estimation of the Average Total Effect (ATE)</a></li>
<li class="chapter" data-level="5.2" data-path="ChapTradRegModels.html"><a href="ChapTradRegModels.html#trad2way"><i class="fa fa-check"></i><b>5.2</b> Two-way decomposition</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="ChapTradRegModels.html"><a href="ChapTradRegModels.html#trad2waycde"><i class="fa fa-check"></i><b>5.2.1</b> Controlled Direct Effect</a></li>
<li class="chapter" data-level="5.2.2" data-path="ChapTradRegModels.html"><a href="ChapTradRegModels.html#trad2waynatural"><i class="fa fa-check"></i><b>5.2.2</b> Natural Direct and Indirect effects</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="ChapTradRegModels.html"><a href="ChapTradRegModels.html#trad3way"><i class="fa fa-check"></i><b>5.3</b> Three-way decomposition</a></li>
<li class="chapter" data-level="5.4" data-path="ChapTradRegModels.html"><a href="ChapTradRegModels.html#four-way-decomposition"><i class="fa fa-check"></i><b>5.4</b> Four-way decomposition</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="ChapGcomp.html"><a href="ChapGcomp.html"><i class="fa fa-check"></i><b>6</b> G-computation</a>
<ul>
<li class="chapter" data-level="6.1" data-path="ChapGcomp.html"><a href="ChapGcomp.html#estimation-of-the-average-total-effect-ate-1"><i class="fa fa-check"></i><b>6.1</b> Estimation of the Average Total Effect (ATE)</a></li>
<li class="chapter" data-level="6.2" data-path="ChapGcomp.html"><a href="ChapGcomp.html#estimation-of-controlled-direct-effects-cde"><i class="fa fa-check"></i><b>6.2</b> Estimation of Controlled Direct Effects (CDE)</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="ChapGcomp.html"><a href="ChapGcomp.html#ChapGcomp-CDE-param"><i class="fa fa-check"></i><b>6.2.1</b> Parametric g-computation</a></li>
<li class="chapter" data-level="6.2.2" data-path="ChapGcomp.html"><a href="ChapGcomp.html#ChapGcomp-CDE-ICE"><i class="fa fa-check"></i><b>6.2.2</b> G-computation by iterative conditional expectation</a></li>
<li class="chapter" data-level="6.2.3" data-path="ChapGcomp.html"><a href="ChapGcomp.html#sequential-g-estimator"><i class="fa fa-check"></i><b>6.2.3</b> Sequential g-estimator</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="ChapGcomp.html"><a href="ChapGcomp.html#estimation-of-natural-direct-nde-and-indirect-effects-nie"><i class="fa fa-check"></i><b>6.3</b> Estimation of Natural Direct (NDE) and Indirect Effects (NIE)</a>
<ul>
<li class="chapter" data-level="6.3.1" data-path="ChapGcomp.html"><a href="ChapGcomp.html#simple-plug-in-estimator"><i class="fa fa-check"></i><b>6.3.1</b> Simple “plug-in” estimator</a></li>
<li class="chapter" data-level="6.3.2" data-path="ChapGcomp.html"><a href="ChapGcomp.html#using-the-cmaverse-r-package"><i class="fa fa-check"></i><b>6.3.2</b> Using the <code>CMAverse</code> R package</a></li>
<li class="chapter" data-level="6.3.3" data-path="ChapGcomp.html"><a href="ChapGcomp.html#using-the-mediation-r-package"><i class="fa fa-check"></i><b>6.3.3</b> Using the <code>mediation</code> R package</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="ChapGcomp.html"><a href="ChapGcomp.html#estimation-of-marginal-randomizedinterventional-natural-direct-mrde-and-indirect-effects-mrie"><i class="fa fa-check"></i><b>6.4</b> Estimation of “Marginal” Randomized/Interventional Natural Direct (MRDE) and Indirect Effects (MRIE)</a>
<ul>
<li class="chapter" data-level="6.4.1" data-path="ChapGcomp.html"><a href="ChapGcomp.html#parametric-g-computation"><i class="fa fa-check"></i><b>6.4.1</b> Parametric g-computation</a></li>
<li class="chapter" data-level="6.4.2" data-path="ChapGcomp.html"><a href="ChapGcomp.html#g-computation-by-iterative-conditional-expectation"><i class="fa fa-check"></i><b>6.4.2</b> G-computation by iterative conditional expectation</a></li>
</ul></li>
<li class="chapter" data-level="6.5" data-path="ChapGcomp.html"><a href="ChapGcomp.html#using-the-cmaverse-package-for-2-way-3-way-and-4-way-decomposition"><i class="fa fa-check"></i><b>6.5</b> Using the <code>CMAverse</code> package for 2-way, 3-way and 4-way decomposition</a></li>
<li class="chapter" data-level="6.6" data-path="ChapGcomp.html"><a href="ChapGcomp.html#estimation-of-conditional-randomizedinterventional-natural-direct-crde-and-indirect-effects-crie"><i class="fa fa-check"></i><b>6.6</b> Estimation of “Conditional” Randomized/Interventional Natural Direct (CRDE) and Indirect Effects (CRIE)</a>
<ul>
<li class="chapter" data-level="6.6.1" data-path="ChapGcomp.html"><a href="ChapGcomp.html#g-computation-by-iterative-conditional-expectation-simple-substitution-estimator"><i class="fa fa-check"></i><b>6.6.1</b> G-computation by iterative conditional expectation (simple substitution estimator)</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="ChapIptw.html"><a href="ChapIptw.html"><i class="fa fa-check"></i><b>7</b> Inverse Probability of Treatment Weighting (IPTW)</a>
<ul>
<li class="chapter" data-level="7.1" data-path="ChapIptw.html"><a href="ChapIptw.html#estimation-of-the-average-total-effect"><i class="fa fa-check"></i><b>7.1</b> Estimation of the Average total effect</a>
<ul>
<li class="chapter" data-level="7.1.1" data-path="ChapIptw.html"><a href="ChapIptw.html#iptw-for-the-ate"><i class="fa fa-check"></i><b>7.1.1</b> IPTW for the ATE</a></li>
<li class="chapter" data-level="7.1.2" data-path="ChapIptw.html"><a href="ChapIptw.html#stabilized-iptw-for-the-ate"><i class="fa fa-check"></i><b>7.1.2</b> Stabilized IPTW for the ATE</a></li>
</ul></li>
<li class="chapter" data-level="7.2" data-path="ChapIptw.html"><a href="ChapIptw.html#estimation-of-the-controlled-direct-effect-cde"><i class="fa fa-check"></i><b>7.2</b> Estimation of the Controlled direct effect (CDE)</a>
<ul>
<li class="chapter" data-level="7.2.1" data-path="ChapIptw.html"><a href="ChapIptw.html#iptw-for-the-cde"><i class="fa fa-check"></i><b>7.2.1</b> IPTW for the CDE</a></li>
<li class="chapter" data-level="7.2.2" data-path="ChapIptw.html"><a href="ChapIptw.html#stabilized-iptw-for-the-cde"><i class="fa fa-check"></i><b>7.2.2</b> Stabilized IPTW for the CDE</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="ChapIptw.html"><a href="ChapIptw.html#estimation-of-the-pnde-and-tnie-by-inverse-odds-ratio-weigthing"><i class="fa fa-check"></i><b>7.3</b> Estimation of the PNDE and TNIE by Inverse Odds Ratio Weigthing</a></li>
<li class="chapter" data-level="7.4" data-path="ChapIptw.html"><a href="ChapIptw.html#estimation-of-conditional-randomizedinterventional-natural-direct-crde-and-indirect-effects-crie-1"><i class="fa fa-check"></i><b>7.4</b> Estimation of “Conditional” Randomized/Interventional Natural Direct (CRDE) and Indirect Effects (CRIE)</a>
<ul>
<li class="chapter" data-level="7.4.1" data-path="ChapIptw.html"><a href="ChapIptw.html#iptw-for-the-crde-and-crie"><i class="fa fa-check"></i><b>7.4.1</b> IPTW for the CRDE and CRIE</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="msm_chapter.html"><a href="msm_chapter.html"><i class="fa fa-check"></i><b>8</b> Marginal structural models</a>
<ul>
<li class="chapter" data-level="8.1" data-path="msm_chapter.html"><a href="msm_chapter.html#msm_ATE_paragraph"><i class="fa fa-check"></i><b>8.1</b> MSM for the Average Total Effect (ATE)</a>
<ul>
<li class="chapter" data-level="8.1.1" data-path="msm_chapter.html"><a href="msm_chapter.html#expressing-the-ate-using-coefficients-of-an-msm"><i class="fa fa-check"></i><b>8.1.1</b> Expressing the ATE using coefficients of an MSM</a></li>
<li class="chapter" data-level="8.1.2" data-path="msm_chapter.html"><a href="msm_chapter.html#estimation-of-the-msm-coefficients-by-iptw"><i class="fa fa-check"></i><b>8.1.2</b> Estimation of the MSM coefficients by IPTW</a></li>
<li class="chapter" data-level="8.1.3" data-path="msm_chapter.html"><a href="msm_chapter.html#estimation-of-the-msm-coefficients-by-g-computation-imputation"><i class="fa fa-check"></i><b>8.1.3</b> Estimation of the MSM coefficients by G-computation (imputation)</a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="msm_chapter.html"><a href="msm_chapter.html#msm_CDE_paragraph"><i class="fa fa-check"></i><b>8.2</b> MSM for Controlled Direct Effects</a>
<ul>
<li class="chapter" data-level="8.2.1" data-path="msm_chapter.html"><a href="msm_chapter.html#expressing-the-cde-using-coefficients-of-an-msm"><i class="fa fa-check"></i><b>8.2.1</b> Expressing the CDE using coefficients of an MSM</a></li>
<li class="chapter" data-level="8.2.2" data-path="msm_chapter.html"><a href="msm_chapter.html#estimation-of-the-msm-coefficients-by-iptw-1"><i class="fa fa-check"></i><b>8.2.2</b> Estimation of the MSM coefficients by IPTW</a></li>
<li class="chapter" data-level="8.2.3" data-path="msm_chapter.html"><a href="msm_chapter.html#estimation-of-the-msm-coefficients-by-g-computation"><i class="fa fa-check"></i><b>8.2.3</b> Estimation of the MSM coefficients by G-computation</a></li>
</ul></li>
<li class="chapter" data-level="8.3" data-path="msm_chapter.html"><a href="msm_chapter.html#msm_NDE_NIE_paragraph"><i class="fa fa-check"></i><b>8.3</b> MSM for Natural Direct and Indirect Effects</a>
<ul>
<li class="chapter" data-level="8.3.1" data-path="msm_chapter.html"><a href="msm_chapter.html#expressing-the-nde-and-nie-using-coefficients-of-2-msms"><i class="fa fa-check"></i><b>8.3.1</b> Expressing the NDE and NIE using coefficients of 2 MSMs</a></li>
<li class="chapter" data-level="8.3.2" data-path="msm_chapter.html"><a href="msm_chapter.html#estimation-of-the-2-msms-coefficients-by-iptw-for-nde-and-nie"><i class="fa fa-check"></i><b>8.3.2</b> Estimation of the 2 MSMs coefficients by IPTW for NDE and NIE</a></li>
</ul></li>
<li class="chapter" data-level="8.4" data-path="msm_chapter.html"><a href="msm_chapter.html#msm_CMAverse"><i class="fa fa-check"></i><b>8.4</b> MSM estimated by the <code>CMAverse</code> package</a>
<ul>
<li class="chapter" data-level="8.4.1" data-path="msm_chapter.html"><a href="msm_chapter.html#calculation-by-hand-using-the-mediation-formula"><i class="fa fa-check"></i><b>8.4.1</b> Calculation by hand, using the “mediation formula”</a></li>
<li class="chapter" data-level="8.4.2" data-path="msm_chapter.html"><a href="msm_chapter.html#estimation-of-nde-and-nie-using-cmaverse-by-iptw-or-gcomputation"><i class="fa fa-check"></i><b>8.4.2</b> Estimation of NDE and NIE using CMAverse (by IPTW or gcomputation)</a></li>
</ul></li>
<li class="chapter" data-level="8.5" data-path="msm_chapter.html"><a href="msm_chapter.html#msm_unified"><i class="fa fa-check"></i><b>8.5</b> “Unified” approach for estimating Natural Direct and Indirect effects</a>
<ul>
<li class="chapter" data-level="8.5.1" data-path="msm_chapter.html"><a href="msm_chapter.html#estimation-of-the-msm-by-iptw"><i class="fa fa-check"></i><b>8.5.1</b> Estimation of the MSM by IPTW</a></li>
<li class="chapter" data-level="8.5.2" data-path="msm_chapter.html"><a href="msm_chapter.html#estimation-of-the-msm-by-g-computation"><i class="fa fa-check"></i><b>8.5.2</b> Estimation of the MSM by g-computation</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="9" data-path="chap_tmle.html"><a href="chap_tmle.html"><i class="fa fa-check"></i><b>9</b> Targeted Maximum Likelihood Estimation (TMLE)</a>
<ul>
<li class="chapter" data-level="9.1" data-path="chap_tmle.html"><a href="chap_tmle.html#tmle-for-the-ate"><i class="fa fa-check"></i><b>9.1</b> TMLE for the ATE</a></li>
<li class="chapter" data-level="9.2" data-path="chap_tmle.html"><a href="chap_tmle.html#tmle-of-the-controlled-direct-effect-cde"><i class="fa fa-check"></i><b>9.2</b> TMLE of the Controlled direct effect (CDE)</a>
<ul>
<li class="chapter" data-level="9.2.1" data-path="chap_tmle.html"><a href="chap_tmle.html#for-binary-outcomes"><i class="fa fa-check"></i><b>9.2.1</b> For binary outcomes</a></li>
<li class="chapter" data-level="9.2.2" data-path="chap_tmle.html"><a href="chap_tmle.html#for-continuous-outcomes"><i class="fa fa-check"></i><b>9.2.2</b> For continuous outcomes</a></li>
</ul></li>
<li class="chapter" data-level="9.3" data-path="chap_tmle.html"><a href="chap_tmle.html#one-step-and-tmle-estimator-of-the-marginal-randomizedinterventional-direct-and-indirect-effects"><i class="fa fa-check"></i><b>9.3</b> One-step and TMLE estimator of the Marginal Randomized/Interventional Direct and Indirect Effects</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="appendix_a.html"><a href="appendix_a.html"><i class="fa fa-check"></i><b>10</b> Appendix A: Data generating mechanisms</a>
<ul>
<li class="chapter" data-level="10.1" data-path="appendix_a.html"><a href="appendix_a.html#first-causal-model-data-generating-mechanism-without-mediator-outcome-confounder-affected-by-the-exposure"><i class="fa fa-check"></i><b>10.1</b> First causal model: Data generating mechanism without mediator-outcome confounder affected by the exposure</a></li>
<li class="chapter" data-level="10.2" data-path="appendix_a.html"><a href="appendix_a.html#second-causal-model-data-generating-mechanism-with-mediator-outcome-confounder-affected-by-the-exposure"><i class="fa fa-check"></i><b>10.2</b> Second causal model: Data generating mechanism with mediator-outcome confounder affected by the exposure</a></li>
<li class="chapter" data-level="10.3" data-path="appendix_a.html"><a href="appendix_a.html#simulation-of-the-four-data-sets-used-in-examples"><i class="fa fa-check"></i><b>10.3</b> Simulation of the four data sets used in examples</a>
<ul>
<li class="chapter" data-level="10.3.1" data-path="appendix_a.html"><a href="appendix_a.html#data-sets-generated-from-the-causal-model-1"><i class="fa fa-check"></i><b>10.3.1</b> Data sets generated from the causal model 1</a></li>
<li class="chapter" data-level="10.3.2" data-path="appendix_a.html"><a href="appendix_a.html#data-sets-generated-from-the-causal-model-2"><i class="fa fa-check"></i><b>10.3.2</b> Data sets generated from the causal model 2</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="11" data-path="appendix_b.html"><a href="appendix_b.html"><i class="fa fa-check"></i><b>11</b> Appendix B: Calculation of the true causal quantities</a>
<ul>
<li class="chapter" data-level="11.1" data-path="appendix_b.html"><a href="appendix_b.html#true-causal-quantities-without-mediator-ouctome-confounder-affected-by-the-exposure"><i class="fa fa-check"></i><b>11.1</b> True causal quantities without mediator-ouctome confounder affected by the exposure</a>
<ul>
<li class="chapter" data-level="11.1.1" data-path="appendix_b.html"><a href="appendix_b.html#average-total-effects-ate"><i class="fa fa-check"></i><b>11.1.1</b> Average total effects (ATE)</a></li>
<li class="chapter" data-level="11.1.2" data-path="appendix_b.html"><a href="appendix_b.html#controlled-direct-effects-cde"><i class="fa fa-check"></i><b>11.1.2</b> Controlled direct effects (CDE)</a></li>
<li class="chapter" data-level="11.1.3" data-path="appendix_b.html"><a href="appendix_b.html#pure-natural-direct-effect-and-total-natural-indirect-effect"><i class="fa fa-check"></i><b>11.1.3</b> Pure natural direct effect and Total natural indirect effect</a></li>
<li class="chapter" data-level="11.1.4" data-path="appendix_b.html"><a href="appendix_b.html#total-natural-direct-effect-and-pure-natural-indirect-effect"><i class="fa fa-check"></i><b>11.1.4</b> Total natural direct effect and Pure natural indirect effect</a></li>
<li class="chapter" data-level="11.1.5" data-path="appendix_b.html"><a href="appendix_b.html#vanderweeles-3-way-decomposition"><i class="fa fa-check"></i><b>11.1.5</b> Vanderweele’s 3-way decomposition</a></li>
<li class="chapter" data-level="11.1.6" data-path="appendix_b.html"><a href="appendix_b.html#vanderweeles-4-way-decomposition"><i class="fa fa-check"></i><b>11.1.6</b> Vanderweele’s 4-way decomposition</a></li>
<li class="chapter" data-level="11.1.7" data-path="appendix_b.html"><a href="appendix_b.html#marginal-randomized-direct-and-indirect-effects"><i class="fa fa-check"></i><b>11.1.7</b> Marginal randomized direct and indirect effects</a></li>
<li class="chapter" data-level="11.1.8" data-path="appendix_b.html"><a href="appendix_b.html#conditional-randomized-direct-and-indirect-effects"><i class="fa fa-check"></i><b>11.1.8</b> Conditional randomized direct and indirect effects</a></li>
</ul></li>
<li class="chapter" data-level="11.2" data-path="appendix_b.html"><a href="appendix_b.html#true-causal-quantities-with-mediator-outcome-confounder-affected-by-the-exposure"><i class="fa fa-check"></i><b>11.2</b> True causal quantities with mediator-outcome confounder affected by the exposure</a>
<ul>
<li class="chapter" data-level="11.2.1" data-path="appendix_b.html"><a href="appendix_b.html#average-total-effects-ate-1"><i class="fa fa-check"></i><b>11.2.1</b> Average total effects (ATE)</a></li>
<li class="chapter" data-level="11.2.2" data-path="appendix_b.html"><a href="appendix_b.html#controlled-direct-effects-cde-1"><i class="fa fa-check"></i><b>11.2.2</b> Controlled direct effects (CDE)</a></li>
<li class="chapter" data-level="11.2.3" data-path="appendix_b.html"><a href="appendix_b.html#marginal-randomized-direct-and-indirect-effects-1"><i class="fa fa-check"></i><b>11.2.3</b> Marginal randomized direct and indirect effects</a></li>
<li class="chapter" data-level="11.2.4" data-path="appendix_b.html"><a href="appendix_b.html#conditional-randomized-direct-and-indirect-effects-1"><i class="fa fa-check"></i><b>11.2.4</b> Conditional randomized direct and indirect effects</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Mediation Workshop</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="ChapIptw" class="section level1 hasAnchor" number="7">
<h1><span class="header-section-number">Chapter 7</span> Inverse Probability of Treatment Weighting (IPTW)<a href="ChapIptw.html#ChapIptw" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="estimation-of-the-average-total-effect" class="section level2 hasAnchor" number="7.1">
<h2><span class="header-section-number">7.1</span> Estimation of the Average total effect<a href="ChapIptw.html#estimation-of-the-average-total-effect" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="iptw-for-the-ate" class="section level3 hasAnchor" number="7.1.1">
<h3><span class="header-section-number">7.1.1</span> IPTW for the ATE<a href="ChapIptw.html#iptw-for-the-ate" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>If the average total effect (ATE) is identifiable, <span class="math inline">\(\Psi_{ATE} = \mathbb{E}(Y_{A=1}) - \mathbb{E}(Y_{A=0})\)</span> can be expressed using Inverse probability of treatment weighting (IPTW), denoting <span class="math inline">\(\mathbb{P}(A=a \mid L(0)) = g(A=a \mid L(0))\)</span>:
<span class="math display">\[\begin{equation}
\Psi_{ATE} = \mathbb{E}\left( \frac{\mathbb{I}(A=1)}{g(A=1 \mid L(0))} Y \right) - \mathbb{E}\left( \frac{\mathbb{I}(A=0)}{g(A=0 \mid L(0))} Y \right)
\end{equation}\]</span></p>
<p>The following steps describe the implementation of the IPTW estimator</p>
<ol style="list-style-type: decimal">
<li><p>Estimate the treatment mechanism <span class="math inline">\(g(A=1 \mid L(0))\)</span></p></li>
<li><p>Predict each individual’s probability of being exposed to her own exposure</p></li>
<li><p>Apply weights corresponding to the inverse of the predicted probability <span class="math inline">\(w_i = \frac{1}{\hat{g}(A = a_i \mid L(0)_i)}\)</span></p></li>
<li><p>Use the empirical mean of the weighted outcome <span class="math inline">\(Y\)</span>: <span class="math inline">\(\hat{\mathbb{E}}(Y_a) = \frac{1}{n} \sum_{i=1}^n \frac{\mathbb{I}(A_i=a)}{\hat{g}(A=a_i \mid L(0)_i)} Y_i\)</span></p></li>
</ol>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="ChapIptw.html#cb44-1" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list=</span><span class="fu">ls</span>())</span>
<span id="cb44-2"><a href="ChapIptw.html#cb44-2" tabindex="-1"></a>df2_int <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="st">&quot;data/df2_int.csv&quot;</span>)</span>
<span id="cb44-3"><a href="ChapIptw.html#cb44-3" tabindex="-1"></a></span>
<span id="cb44-4"><a href="ChapIptw.html#cb44-4" tabindex="-1"></a><span class="do">## 1. Estimate g</span></span>
<span id="cb44-5"><a href="ChapIptw.html#cb44-5" tabindex="-1"></a>g.L <span class="ot">&lt;-</span> <span class="fu">glm</span>(A0_PM2<span class="fl">.5</span> <span class="sc">~</span> L0_male <span class="sc">+</span> L0_soc_env, </span>
<span id="cb44-6"><a href="ChapIptw.html#cb44-6" tabindex="-1"></a>           <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>, <span class="at">data =</span> df2_int)</span>
<span id="cb44-7"><a href="ChapIptw.html#cb44-7" tabindex="-1"></a></span>
<span id="cb44-8"><a href="ChapIptw.html#cb44-8" tabindex="-1"></a><span class="do">## 2. Predict each individual&#39;s probability of being exposed to her own exposure</span></span>
<span id="cb44-9"><a href="ChapIptw.html#cb44-9" tabindex="-1"></a><span class="co"># predict the probabilities P(A0_PM2.5=1|L(0)) &amp; P(A0_PM2.5=0|L(0))</span></span>
<span id="cb44-10"><a href="ChapIptw.html#cb44-10" tabindex="-1"></a>pred.g1.L <span class="ot">&lt;-</span> <span class="fu">predict</span>(g.L, <span class="at">type=</span><span class="st">&quot;response&quot;</span>)</span>
<span id="cb44-11"><a href="ChapIptw.html#cb44-11" tabindex="-1"></a>pred.g0.L <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> pred.g1.L</span>
<span id="cb44-12"><a href="ChapIptw.html#cb44-12" tabindex="-1"></a><span class="co"># the predicted probability of the observed treatment A=a_i is :</span></span>
<span id="cb44-13"><a href="ChapIptw.html#cb44-13" tabindex="-1"></a>gA.L <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">nrow</span>(df2_int))</span>
<span id="cb44-14"><a href="ChapIptw.html#cb44-14" tabindex="-1"></a>gA.L[df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="sc">==</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> pred.g1.L[df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="sc">==</span> <span class="dv">1</span>]</span>
<span id="cb44-15"><a href="ChapIptw.html#cb44-15" tabindex="-1"></a>gA.L[df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="sc">==</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> pred.g0.L[df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="sc">==</span> <span class="dv">0</span>]</span>
<span id="cb44-16"><a href="ChapIptw.html#cb44-16" tabindex="-1"></a></span>
<span id="cb44-17"><a href="ChapIptw.html#cb44-17" tabindex="-1"></a><span class="do">## 3. Apply weights corresponding to the inverse of the predicted probability</span></span>
<span id="cb44-18"><a href="ChapIptw.html#cb44-18" tabindex="-1"></a>wt <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> gA.L</span>
<span id="cb44-19"><a href="ChapIptw.html#cb44-19" tabindex="-1"></a></span>
<span id="cb44-20"><a href="ChapIptw.html#cb44-20" tabindex="-1"></a><span class="do">## 4. Use the empirical mean of the weighted outcome</span></span>
<span id="cb44-21"><a href="ChapIptw.html#cb44-21" tabindex="-1"></a><span class="co"># point estimates:</span></span>
<span id="cb44-22"><a href="ChapIptw.html#cb44-22" tabindex="-1"></a>IPTW.death <span class="ot">&lt;-</span> <span class="fu">mean</span>(wt <span class="sc">*</span> <span class="fu">as.numeric</span>(df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">*</span> df2_int<span class="sc">$</span>Y_death) <span class="sc">-</span></span>
<span id="cb44-23"><a href="ChapIptw.html#cb44-23" tabindex="-1"></a>  <span class="fu">mean</span>(wt <span class="sc">*</span> <span class="fu">as.numeric</span>(df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">*</span> df2_int<span class="sc">$</span>Y_death)</span>
<span id="cb44-24"><a href="ChapIptw.html#cb44-24" tabindex="-1"></a>IPTW.death</span>
<span id="cb44-25"><a href="ChapIptw.html#cb44-25" tabindex="-1"></a><span class="co"># [1] 0.08224947</span></span>
<span id="cb44-26"><a href="ChapIptw.html#cb44-26" tabindex="-1"></a></span>
<span id="cb44-27"><a href="ChapIptw.html#cb44-27" tabindex="-1"></a>IPTW.qol <span class="ot">&lt;-</span> <span class="fu">mean</span>(wt <span class="sc">*</span> <span class="fu">as.numeric</span>(df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">*</span> df2_int<span class="sc">$</span>Y_qol) <span class="sc">-</span></span>
<span id="cb44-28"><a href="ChapIptw.html#cb44-28" tabindex="-1"></a>  <span class="fu">mean</span>(wt <span class="sc">*</span> <span class="fu">as.numeric</span>(df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">*</span> df2_int<span class="sc">$</span>Y_qol)</span>
<span id="cb44-29"><a href="ChapIptw.html#cb44-29" tabindex="-1"></a>IPTW.qol</span>
<span id="cb44-30"><a href="ChapIptw.html#cb44-30" tabindex="-1"></a><span class="co"># [1] -8.436797</span></span></code></pre></div>
<p>The ATE estimates using IPTW for death probability and mean quality of life are respectively +8.2% and -8.44.</p>
</div>
<div id="stabilized-iptw-for-the-ate" class="section level3 hasAnchor" number="7.1.2">
<h3><span class="header-section-number">7.1.2</span> Stabilized IPTW for the ATE<a href="ChapIptw.html#stabilized-iptw-for-the-ate" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>If the average total effect (ATE) is identifiable, <span class="math inline">\(\Psi_{ATE}\)</span> can be estimated using a stabilized IPTW estimator:
<span class="math display">\[\begin{equation}
\hat{\mathbb{E}}(Y_1) - \hat{\mathbb{E}}(Y_0) =  \frac{\frac{1}{n} \sum_{i=1}^n \frac{\mathbb{I}(A_i=1)\hat{g}^*(A_i=1)}{\hat{g}(A_i=1 \mid L(0)_i)} Y_i}{ \frac{1}{n} \sum_{i=1}^n \frac{\mathbb{I}(A_i=1)\hat{g}^*(A_i=1)}{\hat{g}(A_i=1 \mid L(0)_i)}} - \frac{\frac{1}{n} \sum_{i=1}^n \frac{\mathbb{I}(A_i=0)\hat{g}^*(A_i=0)}{\hat{g}(A_i=0 \mid L(0)_i)} Y_i}{ \frac{1}{n} \sum_{i=1}^n \frac{\mathbb{I}(A_i=0)\hat{g}^*(A_i=0)}{\hat{g}(A_i=0 \mid L(0)_i)}}
\end{equation}\]</span>
The estimation algorithm is the same as for IPTW, but taking into account any non-null function of <span class="math inline">\(A\)</span> (<span class="math inline">\(g^*(A_i=a)\)</span>) in the denominator of the weight in step 3, and applying the stabilized estimator in step 4.</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="ChapIptw.html#cb45-1" tabindex="-1"></a><span class="do">## 3. For example, applying g^*(A) = 1</span></span>
<span id="cb45-2"><a href="ChapIptw.html#cb45-2" tabindex="-1"></a><span class="do">## 4. Applying the stabilized estimator</span></span>
<span id="cb45-3"><a href="ChapIptw.html#cb45-3" tabindex="-1"></a><span class="co"># point estimates:</span></span>
<span id="cb45-4"><a href="ChapIptw.html#cb45-4" tabindex="-1"></a>s.IPTW.death <span class="ot">&lt;-</span> (<span class="fu">mean</span>(wt <span class="sc">*</span> <span class="fu">as.numeric</span>(df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">*</span> df2_int<span class="sc">$</span>Y_death) <span class="sc">/</span></span>
<span id="cb45-5"><a href="ChapIptw.html#cb45-5" tabindex="-1"></a>                   <span class="fu">mean</span>(wt <span class="sc">*</span> <span class="fu">as.numeric</span>(df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="sc">==</span> <span class="dv">1</span>))) <span class="sc">-</span></span>
<span id="cb45-6"><a href="ChapIptw.html#cb45-6" tabindex="-1"></a>  (<span class="fu">mean</span>(wt <span class="sc">*</span> <span class="fu">as.numeric</span>(df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">*</span> df2_int<span class="sc">$</span>Y_death) <span class="sc">/</span></span>
<span id="cb45-7"><a href="ChapIptw.html#cb45-7" tabindex="-1"></a>     <span class="fu">mean</span>(wt <span class="sc">*</span> <span class="fu">as.numeric</span>(df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="sc">==</span> <span class="dv">0</span>)))</span>
<span id="cb45-8"><a href="ChapIptw.html#cb45-8" tabindex="-1"></a>s.IPTW.death</span>
<span id="cb45-9"><a href="ChapIptw.html#cb45-9" tabindex="-1"></a><span class="co"># [1] 0.08294185</span></span>
<span id="cb45-10"><a href="ChapIptw.html#cb45-10" tabindex="-1"></a></span>
<span id="cb45-11"><a href="ChapIptw.html#cb45-11" tabindex="-1"></a>s.IPTW.qol <span class="ot">&lt;-</span> (<span class="fu">mean</span>(wt <span class="sc">*</span> <span class="fu">as.numeric</span>(df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">*</span> df2_int<span class="sc">$</span>Y_qol) <span class="sc">/</span></span>
<span id="cb45-12"><a href="ChapIptw.html#cb45-12" tabindex="-1"></a>                 <span class="fu">mean</span>(wt <span class="sc">*</span> <span class="fu">as.numeric</span>(df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="sc">==</span> <span class="dv">1</span>))) <span class="sc">-</span></span>
<span id="cb45-13"><a href="ChapIptw.html#cb45-13" tabindex="-1"></a>  (<span class="fu">mean</span>(wt <span class="sc">*</span> <span class="fu">as.numeric</span>(df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">*</span> df2_int<span class="sc">$</span>Y_qol) <span class="sc">/</span></span>
<span id="cb45-14"><a href="ChapIptw.html#cb45-14" tabindex="-1"></a>     <span class="fu">mean</span>(wt <span class="sc">*</span> <span class="fu">as.numeric</span>(df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="sc">==</span> <span class="dv">0</span>)))</span>
<span id="cb45-15"><a href="ChapIptw.html#cb45-15" tabindex="-1"></a>s.IPTW.qol</span>
<span id="cb45-16"><a href="ChapIptw.html#cb45-16" tabindex="-1"></a><span class="co"># [1] -8.291992</span></span></code></pre></div>
<p>The ATE estimates using stabilized IPTW for death probability and mean quality of life are respectively +8.3% and -8.29.</p>
</div>
</div>
<div id="estimation-of-the-controlled-direct-effect-cde" class="section level2 hasAnchor" number="7.2">
<h2><span class="header-section-number">7.2</span> Estimation of the Controlled direct effect (CDE)<a href="ChapIptw.html#estimation-of-the-controlled-direct-effect-cde" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="iptw-for-the-cde" class="section level3 hasAnchor" number="7.2.1">
<h3><span class="header-section-number">7.2.1</span> IPTW for the CDE<a href="ChapIptw.html#iptw-for-the-cde" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>If the controlled direct effect (CDE) is identifiable, <span class="math inline">\(\Psi^{\text{CDE}_m} = \mathbb{E}(Y_{A=1,M=m}) - \mathbb{E}(Y_{A=0,M=m})\)</span> can be expressed by the basic Horvitz Thompson estimator (using Inverse probability of treatment weighting (IPTW)), denoting <span class="math inline">\(\mathbb{P}\left(A=a \mid L(0)) = g(A=a \mid L(0)\right)\)</span> and <span class="math inline">\(\mathbb{P}\left(M=m \mid L(0),A,L(1)) = g(M=m \mid L(0),A,L(1)\right)\)</span>:
<span class="math display">\[\begin{equation}
\small
\Psi^{\text{CDE}_m} = \mathbb{E}\left[ \frac{\mathbb{I}(A=1 \cap M=m)}{g(A=1 \mid L(0)) \times g(M=m \mid L(0),A,L(1))} Y \right] - \mathbb{E}\left[ \frac{\mathbb{I}(A=0 \cap M=m)}{g(A=0 \mid L(0)) \times g(M=m \mid L(0),A,L(1))} Y \right]
\end{equation}\]</span></p>
<p>The following steps describe the implementation of the IPTW estimator</p>
<ol style="list-style-type: decimal">
<li><p>Estimate the treatment mechanisms <span class="math inline">\(g\left(A=1 \mid L(0)\right)\)</span> and <span class="math inline">\(g\left(M=1 \mid L(0),A,L(1)\right)\)</span></p></li>
<li><p>Predict each individual’s probability of being exposed to her own exposure</p></li>
<li><p>Apply weights corresponding to the inverse of the predicted probability <span class="math inline">\(w_{A_i} = \frac{1}{\hat{g}(A = a_i \mid L(0)_i)}\)</span> and <span class="math inline">\(w_{M_i} = \frac{1}{\hat{g}(M = m_i \mid L(0)_i,A_i,L(1)_i)}\)</span></p></li>
<li><p>Use the empirical mean of the weighted outcome <span class="math inline">\(Y\)</span>: <span class="math inline">\(\hat{\mathbb{E}}(Y_{a,m}) = \frac{1}{n} \sum_{i=1}^n \frac{\mathbb{I}(A_i=a \cap M_i=m)}{\hat{g}(A=a_i \mid L(0)_i) \times \hat{g}(M=m_i \mid L(0)_i,A_i,L(1)_i)} Y_i\)</span></p></li>
</ol>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="ChapIptw.html#cb46-1" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list=</span><span class="fu">ls</span>())</span>
<span id="cb46-2"><a href="ChapIptw.html#cb46-2" tabindex="-1"></a>df2_int <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="st">&quot;data/df2_int.csv&quot;</span>)</span>
<span id="cb46-3"><a href="ChapIptw.html#cb46-3" tabindex="-1"></a></span>
<span id="cb46-4"><a href="ChapIptw.html#cb46-4" tabindex="-1"></a><span class="do">## 1. Estimate gA and gM</span></span>
<span id="cb46-5"><a href="ChapIptw.html#cb46-5" tabindex="-1"></a>gA.L <span class="ot">&lt;-</span> <span class="fu">glm</span>(A0_PM2<span class="fl">.5</span> <span class="sc">~</span> L0_male <span class="sc">+</span> L0_soc_env, </span>
<span id="cb46-6"><a href="ChapIptw.html#cb46-6" tabindex="-1"></a>            <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>, <span class="at">data =</span> df2_int)</span>
<span id="cb46-7"><a href="ChapIptw.html#cb46-7" tabindex="-1"></a>gM.L <span class="ot">&lt;-</span> <span class="fu">glm</span>(M_diabetes <span class="sc">~</span> L0_male <span class="sc">+</span> L0_soc_env <span class="sc">+</span> A0_PM2<span class="fl">.5</span> <span class="sc">+</span> L1, </span>
<span id="cb46-8"><a href="ChapIptw.html#cb46-8" tabindex="-1"></a>            <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>, <span class="at">data =</span> df2_int)</span>
<span id="cb46-9"><a href="ChapIptw.html#cb46-9" tabindex="-1"></a></span>
<span id="cb46-10"><a href="ChapIptw.html#cb46-10" tabindex="-1"></a><span class="do">## 2. Predict each individual&#39;s probability of being exposed to her own exposure</span></span>
<span id="cb46-11"><a href="ChapIptw.html#cb46-11" tabindex="-1"></a><span class="co"># predict the probabilities P(A0_PM2.5=1|L(0)) &amp; P(A0_PM2.5=0|L(0))</span></span>
<span id="cb46-12"><a href="ChapIptw.html#cb46-12" tabindex="-1"></a>pred.gA1.L <span class="ot">&lt;-</span> <span class="fu">predict</span>(gA.L, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb46-13"><a href="ChapIptw.html#cb46-13" tabindex="-1"></a>pred.gA0.L <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> pred.gA1.L</span>
<span id="cb46-14"><a href="ChapIptw.html#cb46-14" tabindex="-1"></a><span class="co"># the predicted probability of the observed treatment A_i=a is :</span></span>
<span id="cb46-15"><a href="ChapIptw.html#cb46-15" tabindex="-1"></a>gAobs.L <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">nrow</span>(df2_int))</span>
<span id="cb46-16"><a href="ChapIptw.html#cb46-16" tabindex="-1"></a>gAobs.L[df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="sc">==</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> pred.gA1.L[df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="sc">==</span> <span class="dv">1</span>]</span>
<span id="cb46-17"><a href="ChapIptw.html#cb46-17" tabindex="-1"></a>gAobs.L[df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="sc">==</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> pred.gA0.L[df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="sc">==</span> <span class="dv">0</span>]</span>
<span id="cb46-18"><a href="ChapIptw.html#cb46-18" tabindex="-1"></a></span>
<span id="cb46-19"><a href="ChapIptw.html#cb46-19" tabindex="-1"></a><span class="co"># predict the probabilities P(M=1|L(0),A,L(1)) &amp; P(M=0|L(0),A,L(1))</span></span>
<span id="cb46-20"><a href="ChapIptw.html#cb46-20" tabindex="-1"></a>pred.gM1.L <span class="ot">&lt;-</span> <span class="fu">predict</span>(gM.L, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb46-21"><a href="ChapIptw.html#cb46-21" tabindex="-1"></a>pred.gM0.L <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> pred.gM1.L</span>
<span id="cb46-22"><a href="ChapIptw.html#cb46-22" tabindex="-1"></a><span class="co"># the predicted probability of the observed treatment M_i=m is :</span></span>
<span id="cb46-23"><a href="ChapIptw.html#cb46-23" tabindex="-1"></a>gMobs.L <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">nrow</span>(df2_int))</span>
<span id="cb46-24"><a href="ChapIptw.html#cb46-24" tabindex="-1"></a>gMobs.L[df2_int<span class="sc">$</span>M_diabetes <span class="sc">==</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> pred.gM1.L[df2_int<span class="sc">$</span>M_diabetes <span class="sc">==</span> <span class="dv">1</span>]</span>
<span id="cb46-25"><a href="ChapIptw.html#cb46-25" tabindex="-1"></a>gMobs.L[df2_int<span class="sc">$</span>M_diabetes <span class="sc">==</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> pred.gM0.L[df2_int<span class="sc">$</span>M_diabetes <span class="sc">==</span> <span class="dv">0</span>]</span>
<span id="cb46-26"><a href="ChapIptw.html#cb46-26" tabindex="-1"></a></span>
<span id="cb46-27"><a href="ChapIptw.html#cb46-27" tabindex="-1"></a><span class="do">## 3. Apply weights corresponding to the inverse of the predicted probability</span></span>
<span id="cb46-28"><a href="ChapIptw.html#cb46-28" tabindex="-1"></a>wt_A <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> gAobs.L</span>
<span id="cb46-29"><a href="ChapIptw.html#cb46-29" tabindex="-1"></a>wt_M <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> gMobs.L</span>
<span id="cb46-30"><a href="ChapIptw.html#cb46-30" tabindex="-1"></a>wt <span class="ot">&lt;-</span> wt_A <span class="sc">*</span> wt_M</span>
<span id="cb46-31"><a href="ChapIptw.html#cb46-31" tabindex="-1"></a></span>
<span id="cb46-32"><a href="ChapIptw.html#cb46-32" tabindex="-1"></a><span class="do">## 4. Use the empirical mean of the weighted outcome</span></span>
<span id="cb46-33"><a href="ChapIptw.html#cb46-33" tabindex="-1"></a><span class="co"># point estimates of CDE, setting M=0</span></span>
<span id="cb46-34"><a href="ChapIptw.html#cb46-34" tabindex="-1"></a>CDE_IPTW_m0_death <span class="ot">&lt;-</span> (<span class="fu">mean</span>(wt <span class="sc">*</span> <span class="fu">as.numeric</span>(df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> </span>
<span id="cb46-35"><a href="ChapIptw.html#cb46-35" tabindex="-1"></a>                                             df2_int<span class="sc">$</span>M_diabetes <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">*</span> </span>
<span id="cb46-36"><a href="ChapIptw.html#cb46-36" tabindex="-1"></a>                             df2_int<span class="sc">$</span>Y_death) <span class="sc">-</span></span>
<span id="cb46-37"><a href="ChapIptw.html#cb46-37" tabindex="-1"></a>                        <span class="fu">mean</span>(wt <span class="sc">*</span> <span class="fu">as.numeric</span>(df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">0</span> <span class="sc">&amp;</span> </span>
<span id="cb46-38"><a href="ChapIptw.html#cb46-38" tabindex="-1"></a>                                               df2_int<span class="sc">$</span>M_diabetes <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">*</span> </span>
<span id="cb46-39"><a href="ChapIptw.html#cb46-39" tabindex="-1"></a>                               df2_int<span class="sc">$</span>Y_death))</span>
<span id="cb46-40"><a href="ChapIptw.html#cb46-40" tabindex="-1"></a>CDE_IPTW_m0_death</span>
<span id="cb46-41"><a href="ChapIptw.html#cb46-41" tabindex="-1"></a><span class="co"># [1] 0.05874684</span></span>
<span id="cb46-42"><a href="ChapIptw.html#cb46-42" tabindex="-1"></a></span>
<span id="cb46-43"><a href="ChapIptw.html#cb46-43" tabindex="-1"></a>CDE_IPTW_m0_qol <span class="ot">&lt;-</span> (<span class="fu">mean</span>(wt <span class="sc">*</span> <span class="fu">as.numeric</span>(df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> </span>
<span id="cb46-44"><a href="ChapIptw.html#cb46-44" tabindex="-1"></a>                                           df2_int<span class="sc">$</span>M_diabetes <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">*</span> </span>
<span id="cb46-45"><a href="ChapIptw.html#cb46-45" tabindex="-1"></a>                           df2_int<span class="sc">$</span>Y_qol) <span class="sc">-</span></span>
<span id="cb46-46"><a href="ChapIptw.html#cb46-46" tabindex="-1"></a>                      <span class="fu">mean</span>(wt <span class="sc">*</span> <span class="fu">as.numeric</span>(df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">0</span> <span class="sc">&amp;</span> </span>
<span id="cb46-47"><a href="ChapIptw.html#cb46-47" tabindex="-1"></a>                                             df2_int<span class="sc">$</span>M_diabetes <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">*</span> </span>
<span id="cb46-48"><a href="ChapIptw.html#cb46-48" tabindex="-1"></a>                             df2_int<span class="sc">$</span>Y_qol))</span>
<span id="cb46-49"><a href="ChapIptw.html#cb46-49" tabindex="-1"></a>CDE_IPTW_m0_qol</span>
<span id="cb46-50"><a href="ChapIptw.html#cb46-50" tabindex="-1"></a><span class="co"># [1] -5.341138</span></span>
<span id="cb46-51"><a href="ChapIptw.html#cb46-51" tabindex="-1"></a></span>
<span id="cb46-52"><a href="ChapIptw.html#cb46-52" tabindex="-1"></a><span class="co"># point estimates of CDE, setting M=1</span></span>
<span id="cb46-53"><a href="ChapIptw.html#cb46-53" tabindex="-1"></a>CDE_IPTW_m1_death <span class="ot">&lt;-</span> (<span class="fu">mean</span>(wt <span class="sc">*</span> <span class="fu">as.numeric</span>(df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> </span>
<span id="cb46-54"><a href="ChapIptw.html#cb46-54" tabindex="-1"></a>                                             df2_int<span class="sc">$</span>M_diabetes <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">*</span> </span>
<span id="cb46-55"><a href="ChapIptw.html#cb46-55" tabindex="-1"></a>                             df2_int<span class="sc">$</span>Y_death) <span class="sc">-</span></span>
<span id="cb46-56"><a href="ChapIptw.html#cb46-56" tabindex="-1"></a>                        <span class="fu">mean</span>(wt <span class="sc">*</span> <span class="fu">as.numeric</span>(df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">0</span> <span class="sc">&amp;</span> </span>
<span id="cb46-57"><a href="ChapIptw.html#cb46-57" tabindex="-1"></a>                                               df2_int<span class="sc">$</span>M_diabetes <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">*</span> </span>
<span id="cb46-58"><a href="ChapIptw.html#cb46-58" tabindex="-1"></a>                               df2_int<span class="sc">$</span>Y_death))</span>
<span id="cb46-59"><a href="ChapIptw.html#cb46-59" tabindex="-1"></a>CDE_IPTW_m1_death</span>
<span id="cb46-60"><a href="ChapIptw.html#cb46-60" tabindex="-1"></a><span class="co"># [1] 0.101733</span></span>
<span id="cb46-61"><a href="ChapIptw.html#cb46-61" tabindex="-1"></a></span>
<span id="cb46-62"><a href="ChapIptw.html#cb46-62" tabindex="-1"></a>CDE_IPTW_m1_qol <span class="ot">&lt;-</span> (<span class="fu">mean</span>(wt <span class="sc">*</span> <span class="fu">as.numeric</span>(df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> </span>
<span id="cb46-63"><a href="ChapIptw.html#cb46-63" tabindex="-1"></a>                                           df2_int<span class="sc">$</span>M_diabetes <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">*</span> </span>
<span id="cb46-64"><a href="ChapIptw.html#cb46-64" tabindex="-1"></a>                           df2_int<span class="sc">$</span>Y_qol) <span class="sc">-</span></span>
<span id="cb46-65"><a href="ChapIptw.html#cb46-65" tabindex="-1"></a>                      <span class="fu">mean</span>(wt <span class="sc">*</span> <span class="fu">as.numeric</span>(df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span><span class="sc">==</span><span class="dv">0</span> <span class="sc">&amp;</span> </span>
<span id="cb46-66"><a href="ChapIptw.html#cb46-66" tabindex="-1"></a>                                             df2_int<span class="sc">$</span>M_diabetes <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">*</span> </span>
<span id="cb46-67"><a href="ChapIptw.html#cb46-67" tabindex="-1"></a>                             df2_int<span class="sc">$</span>Y_qol))</span>
<span id="cb46-68"><a href="ChapIptw.html#cb46-68" tabindex="-1"></a>CDE_IPTW_m1_qol</span>
<span id="cb46-69"><a href="ChapIptw.html#cb46-69" tabindex="-1"></a><span class="co"># [1] -8.185866</span></span></code></pre></div>
</div>
<div id="stabilized-iptw-for-the-cde" class="section level3 hasAnchor" number="7.2.2">
<h3><span class="header-section-number">7.2.2</span> Stabilized IPTW for the CDE<a href="ChapIptw.html#stabilized-iptw-for-the-cde" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>If the controlled dired effect (CDE) is identifiable, <span class="math inline">\(\Psi^{CDE}\)</span> can be estimated using a stabilized IPTW estimator (modified Horvitz Thompson estimator):
<span class="math display">\[\begin{equation}
\small
\hat{\mathbb{E}}(Y_{1,m}) - \hat{\mathbb{E}}(Y_{0,m}) =  \frac{ \sum_{i=1}^n \frac{\mathbb{I}(A_i=1 \cap M_i=m)}{\hat{g}(A_i=1 \mid L(0)_i) \times \hat{g}(M_i=m \mid L(0)_i,A_i,L(1)_i)} Y_i}{\sum_{i=1}^n \frac{\mathbb{I}(A_i=1 \cap M_i=m)}{\hat{g}(A_i=1 \mid L(0)_i) \hat{g}(M_i=m \mid L(0)_i,A_i,L(1)_i)}} - \frac{ \sum_{i=1}^n \frac{\mathbb{I}(A_i=0 \cap M_i=m)}{\hat{g}(A_i=0 \mid L(0)_i) \times \hat{g}(M_i=m \mid L(0)_i,A_i,L(1)_i)} Y_i}{ \sum_{i=1}^n \frac{\mathbb{I}(A_i=0 \cap M_i=m)}{\hat{g}(A_i=0 \mid L(0)_i) \times \hat{g}(M_i=m \mid L(0)_i,A_i,L(1)_i)}}
\end{equation}\]</span>
The estimation algorithm is the same as for IPTW, but applying the stabilized estimator in step 4.</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="ChapIptw.html#cb47-1" tabindex="-1"></a><span class="do">## 4. Applying the stabilized estimator</span></span>
<span id="cb47-2"><a href="ChapIptw.html#cb47-2" tabindex="-1"></a><span class="co"># point estimates of CDE, setting M=0:</span></span>
<span id="cb47-3"><a href="ChapIptw.html#cb47-3" tabindex="-1"></a>CDE_sIPTW_m0_death <span class="ot">&lt;-</span> (<span class="fu">mean</span>(wt <span class="sc">*</span> <span class="fu">as.numeric</span>(df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> </span>
<span id="cb47-4"><a href="ChapIptw.html#cb47-4" tabindex="-1"></a>                                              df2_int<span class="sc">$</span>M_diabetes <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">*</span> </span>
<span id="cb47-5"><a href="ChapIptw.html#cb47-5" tabindex="-1"></a>                              df2_int<span class="sc">$</span>Y_death) <span class="sc">/</span> </span>
<span id="cb47-6"><a href="ChapIptw.html#cb47-6" tabindex="-1"></a>                         <span class="fu">mean</span>(wt <span class="sc">*</span> <span class="fu">as.numeric</span>(df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> </span>
<span id="cb47-7"><a href="ChapIptw.html#cb47-7" tabindex="-1"></a>                                                df2_int<span class="sc">$</span>M_diabetes <span class="sc">==</span> <span class="dv">0</span>))) <span class="sc">-</span></span>
<span id="cb47-8"><a href="ChapIptw.html#cb47-8" tabindex="-1"></a>                         (<span class="fu">mean</span>(wt <span class="sc">*</span> <span class="fu">as.numeric</span>(df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> </span>
<span id="cb47-9"><a href="ChapIptw.html#cb47-9" tabindex="-1"></a>                                              df2_int<span class="sc">$</span>M_diabetes <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">*</span> </span>
<span id="cb47-10"><a href="ChapIptw.html#cb47-10" tabindex="-1"></a>                              df2_int<span class="sc">$</span>Y_death) <span class="sc">/</span> </span>
<span id="cb47-11"><a href="ChapIptw.html#cb47-11" tabindex="-1"></a>                         <span class="fu">mean</span>(wt <span class="sc">*</span> <span class="fu">as.numeric</span>(df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> </span>
<span id="cb47-12"><a href="ChapIptw.html#cb47-12" tabindex="-1"></a>                                                df2_int<span class="sc">$</span>M_diabetes <span class="sc">==</span> <span class="dv">0</span>)))</span>
<span id="cb47-13"><a href="ChapIptw.html#cb47-13" tabindex="-1"></a>CDE_sIPTW_m0_death</span>
<span id="cb47-14"><a href="ChapIptw.html#cb47-14" tabindex="-1"></a><span class="co"># [1] 0.0601292</span></span>
<span id="cb47-15"><a href="ChapIptw.html#cb47-15" tabindex="-1"></a></span>
<span id="cb47-16"><a href="ChapIptw.html#cb47-16" tabindex="-1"></a>CDE_sIPTW_m0_qol <span class="ot">&lt;-</span> (<span class="fu">mean</span>(wt <span class="sc">*</span> <span class="fu">as.numeric</span>(df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> </span>
<span id="cb47-17"><a href="ChapIptw.html#cb47-17" tabindex="-1"></a>                                              df2_int<span class="sc">$</span>M_diabetes <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">*</span> </span>
<span id="cb47-18"><a href="ChapIptw.html#cb47-18" tabindex="-1"></a>                              df2_int<span class="sc">$</span>Y_qol) <span class="sc">/</span> </span>
<span id="cb47-19"><a href="ChapIptw.html#cb47-19" tabindex="-1"></a>                         <span class="fu">mean</span>(wt <span class="sc">*</span> <span class="fu">as.numeric</span>(df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> </span>
<span id="cb47-20"><a href="ChapIptw.html#cb47-20" tabindex="-1"></a>                                                df2_int<span class="sc">$</span>M_diabetes <span class="sc">==</span> <span class="dv">0</span>))) <span class="sc">-</span></span>
<span id="cb47-21"><a href="ChapIptw.html#cb47-21" tabindex="-1"></a>                         (<span class="fu">mean</span>(wt <span class="sc">*</span> <span class="fu">as.numeric</span>(df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> </span>
<span id="cb47-22"><a href="ChapIptw.html#cb47-22" tabindex="-1"></a>                                              df2_int<span class="sc">$</span>M_diabetes <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">*</span> </span>
<span id="cb47-23"><a href="ChapIptw.html#cb47-23" tabindex="-1"></a>                              df2_int<span class="sc">$</span>Y_qol) <span class="sc">/</span> </span>
<span id="cb47-24"><a href="ChapIptw.html#cb47-24" tabindex="-1"></a>                         <span class="fu">mean</span>(wt <span class="sc">*</span> <span class="fu">as.numeric</span>(df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> </span>
<span id="cb47-25"><a href="ChapIptw.html#cb47-25" tabindex="-1"></a>                                                df2_int<span class="sc">$</span>M_diabetes <span class="sc">==</span> <span class="dv">0</span>)))</span>
<span id="cb47-26"><a href="ChapIptw.html#cb47-26" tabindex="-1"></a>CDE_sIPTW_m0_qol</span>
<span id="cb47-27"><a href="ChapIptw.html#cb47-27" tabindex="-1"></a><span class="co"># [1] -4.966328</span></span>
<span id="cb47-28"><a href="ChapIptw.html#cb47-28" tabindex="-1"></a></span>
<span id="cb47-29"><a href="ChapIptw.html#cb47-29" tabindex="-1"></a><span class="co"># point estimates of CDE, setting M=1:</span></span>
<span id="cb47-30"><a href="ChapIptw.html#cb47-30" tabindex="-1"></a>CDE_sIPTW_m1_death <span class="ot">&lt;-</span> (<span class="fu">mean</span>(wt <span class="sc">*</span> <span class="fu">as.numeric</span>(df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> </span>
<span id="cb47-31"><a href="ChapIptw.html#cb47-31" tabindex="-1"></a>                                              df2_int<span class="sc">$</span>M_diabetes <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">*</span> </span>
<span id="cb47-32"><a href="ChapIptw.html#cb47-32" tabindex="-1"></a>                              df2_int<span class="sc">$</span>Y_death) <span class="sc">/</span> </span>
<span id="cb47-33"><a href="ChapIptw.html#cb47-33" tabindex="-1"></a>                         <span class="fu">mean</span>(wt <span class="sc">*</span> <span class="fu">as.numeric</span>(df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> </span>
<span id="cb47-34"><a href="ChapIptw.html#cb47-34" tabindex="-1"></a>                                                df2_int<span class="sc">$</span>M_diabetes <span class="sc">==</span> <span class="dv">1</span>))) <span class="sc">-</span></span>
<span id="cb47-35"><a href="ChapIptw.html#cb47-35" tabindex="-1"></a>                         (<span class="fu">mean</span>(wt <span class="sc">*</span> <span class="fu">as.numeric</span>(df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> </span>
<span id="cb47-36"><a href="ChapIptw.html#cb47-36" tabindex="-1"></a>                                              df2_int<span class="sc">$</span>M_diabetes <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">*</span> </span>
<span id="cb47-37"><a href="ChapIptw.html#cb47-37" tabindex="-1"></a>                              df2_int<span class="sc">$</span>Y_death) <span class="sc">/</span> </span>
<span id="cb47-38"><a href="ChapIptw.html#cb47-38" tabindex="-1"></a>                         <span class="fu">mean</span>(wt <span class="sc">*</span> <span class="fu">as.numeric</span>(df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> </span>
<span id="cb47-39"><a href="ChapIptw.html#cb47-39" tabindex="-1"></a>                                                df2_int<span class="sc">$</span>M_diabetes <span class="sc">==</span> <span class="dv">1</span>)))</span>
<span id="cb47-40"><a href="ChapIptw.html#cb47-40" tabindex="-1"></a>CDE_sIPTW_m1_death</span>
<span id="cb47-41"><a href="ChapIptw.html#cb47-41" tabindex="-1"></a><span class="co"># [1] 0.09030186</span></span>
<span id="cb47-42"><a href="ChapIptw.html#cb47-42" tabindex="-1"></a></span>
<span id="cb47-43"><a href="ChapIptw.html#cb47-43" tabindex="-1"></a>CDE_sIPTW_m1_qol <span class="ot">&lt;-</span> (<span class="fu">mean</span>(wt <span class="sc">*</span> <span class="fu">as.numeric</span>(df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> </span>
<span id="cb47-44"><a href="ChapIptw.html#cb47-44" tabindex="-1"></a>                                              df2_int<span class="sc">$</span>M_diabetes <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">*</span> </span>
<span id="cb47-45"><a href="ChapIptw.html#cb47-45" tabindex="-1"></a>                              df2_int<span class="sc">$</span>Y_qol) <span class="sc">/</span> </span>
<span id="cb47-46"><a href="ChapIptw.html#cb47-46" tabindex="-1"></a>                         <span class="fu">mean</span>(wt <span class="sc">*</span> <span class="fu">as.numeric</span>(df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> </span>
<span id="cb47-47"><a href="ChapIptw.html#cb47-47" tabindex="-1"></a>                                                df2_int<span class="sc">$</span>M_diabetes <span class="sc">==</span> <span class="dv">1</span>))) <span class="sc">-</span></span>
<span id="cb47-48"><a href="ChapIptw.html#cb47-48" tabindex="-1"></a>                         (<span class="fu">mean</span>(wt <span class="sc">*</span> <span class="fu">as.numeric</span>(df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> </span>
<span id="cb47-49"><a href="ChapIptw.html#cb47-49" tabindex="-1"></a>                                              df2_int<span class="sc">$</span>M_diabetes <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">*</span> </span>
<span id="cb47-50"><a href="ChapIptw.html#cb47-50" tabindex="-1"></a>                              df2_int<span class="sc">$</span>Y_qol) <span class="sc">/</span> </span>
<span id="cb47-51"><a href="ChapIptw.html#cb47-51" tabindex="-1"></a>                         <span class="fu">mean</span>(wt <span class="sc">*</span> <span class="fu">as.numeric</span>(df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> </span>
<span id="cb47-52"><a href="ChapIptw.html#cb47-52" tabindex="-1"></a>                                                df2_int<span class="sc">$</span>M_diabetes <span class="sc">==</span> <span class="dv">1</span>)))</span>
<span id="cb47-53"><a href="ChapIptw.html#cb47-53" tabindex="-1"></a>CDE_sIPTW_m1_qol</span>
<span id="cb47-54"><a href="ChapIptw.html#cb47-54" tabindex="-1"></a><span class="co"># [1] -10.03045</span></span></code></pre></div>
</div>
</div>
<div id="estimation-of-the-pnde-and-tnie-by-inverse-odds-ratio-weigthing" class="section level2 hasAnchor" number="7.3">
<h2><span class="header-section-number">7.3</span> Estimation of the PNDE and TNIE by Inverse Odds Ratio Weigthing<a href="ChapIptw.html#estimation-of-the-pnde-and-tnie-by-inverse-odds-ratio-weigthing" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p><span class="citation">(<a href="#ref-Tchetgen2012">Tchetgen Tchetgen 2013</a>)</span> described the estimation of the Pure Natural Direct Effect (PNDE) and Total Natural Indirect Effect (TNIE) using Inverse Oddes Ratio Weighting (IORW), when the the two effects are identifiable (Causal model 1, Figure <a href="data-sets.html#fig:figDAGM1">3.1</a>).</p>
<p>A practical guidance is also given in <span class="citation">(<a href="#ref-Nguyen2015">Nguyen et al. 2015</a>)</span>.</p>
<p>The approach is particularly useful with multiple mediators, as we don’t need to estimate a model for each mediator of interest. We also don’t need to make any assumptions regarding the exposure-mediator interaction effects on the outcome.</p>
<p>The IORW approach relies on :</p>
<ul>
<li>a single model of the exposure conditional on the set of mediators and baseline confounders,</li>
<li>and 2 models of the outcome, circonventing the need to specify the possible interactions between the exposure and mediators</li>
</ul>
<p>The analysis relies on the following steps:</p>
<ol style="list-style-type: decimal">
<li>Fit a standard multiple logistic regression model for the exposure <span class="math inline">\(A\)</span>, conditional on mediators <span class="math inline">\(M\)</span> and baseline confounders <span class="math inline">\(L(0)\)</span> and <span class="math inline">\(L(1)\)</span></li>
<li>Compute an IORW weight by taking the inverse of the predicted odds ratio from step 1 for each observation in the exposed group (the unexposed group weight equals 1)</li>
<li>Estimate the direct effect of the exposure via a glm of the regression of the outcome <span class="math inline">\(Y\)</span> on the exposure <span class="math inline">\(A\)</span> and baseline confounders <span class="math inline">\(L(0)\)</span> and <span class="math inline">\(L(1)\)</span>, with the appropriate link function and the weights from step 2</li>
<li>Estimate the total effect of the exposure <span class="math inline">\(A\)</span> on the outcome <span class="math inline">\(Y\)</span> using a standard glm with the appropriate link function (adjusted for baseline confounders)</li>
<li>Calculate indirect effects by substracting the direct effect from the total effect</li>
<li>Bootstrap effect estimates to get 95% confidence intervals</li>
</ol>
<p>Note: Examples of sensitivity analysis to test the unmeasured confounding assumptions are also described in <span class="citation">(<a href="#ref-Nguyen2015">Nguyen et al. 2015</a>)</span> (not shown below).</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="ChapIptw.html#cb48-1" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list=</span><span class="fu">ls</span>())</span>
<span id="cb48-2"><a href="ChapIptw.html#cb48-2" tabindex="-1"></a>df1_int <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="st">&quot;data/df1_int.csv&quot;</span>)</span>
<span id="cb48-3"><a href="ChapIptw.html#cb48-3" tabindex="-1"></a></span>
<span id="cb48-4"><a href="ChapIptw.html#cb48-4" tabindex="-1"></a><span class="do">## 1) Fit a standard multiple logistic regression model for the exposure A,</span></span>
<span id="cb48-5"><a href="ChapIptw.html#cb48-5" tabindex="-1"></a><span class="do">##    conditional on mediators M and baseline confounders L(0) and L(1)</span></span>
<span id="cb48-6"><a href="ChapIptw.html#cb48-6" tabindex="-1"></a>g.A.L0 <span class="ot">&lt;-</span> <span class="fu">glm</span>(A0_PM2<span class="fl">.5</span> <span class="sc">~</span> M_diabetes <span class="sc">+</span> L0_male <span class="sc">+</span> L0_soc_env <span class="sc">+</span> L1,</span>
<span id="cb48-7"><a href="ChapIptw.html#cb48-7" tabindex="-1"></a>              <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>,</span>
<span id="cb48-8"><a href="ChapIptw.html#cb48-8" tabindex="-1"></a>              <span class="at">data =</span> df1_int)</span>
<span id="cb48-9"><a href="ChapIptw.html#cb48-9" tabindex="-1"></a><span class="fu">summary</span>(g.A.L0)</span>
<span id="cb48-10"><a href="ChapIptw.html#cb48-10" tabindex="-1"></a><span class="co"># Coefficients:</span></span>
<span id="cb48-11"><a href="ChapIptw.html#cb48-11" tabindex="-1"></a><span class="co">#                Estimate Std. Error z value Pr(&gt;|z|)</span></span>
<span id="cb48-12"><a href="ChapIptw.html#cb48-12" tabindex="-1"></a><span class="co">#   (Intercept) -2.883345   0.080069 -36.011  &lt; 2e-16 ***</span></span>
<span id="cb48-13"><a href="ChapIptw.html#cb48-13" tabindex="-1"></a><span class="co">#   M_diabetes   0.562935   0.065539   8.589  &lt; 2e-16 ***</span></span>
<span id="cb48-14"><a href="ChapIptw.html#cb48-14" tabindex="-1"></a><span class="co">#   L0_male      0.374904   0.064828   5.783 7.34e-09 ***</span></span>
<span id="cb48-15"><a href="ChapIptw.html#cb48-15" tabindex="-1"></a><span class="co">#   L0_soc_env   0.600956   0.073872   8.135 4.12e-16 ***</span></span>
<span id="cb48-16"><a href="ChapIptw.html#cb48-16" tabindex="-1"></a><span class="co">#   L1          -0.007768   0.070141  -0.111    0.912</span></span>
<span id="cb48-17"><a href="ChapIptw.html#cb48-17" tabindex="-1"></a></span>
<span id="cb48-18"><a href="ChapIptw.html#cb48-18" tabindex="-1"></a><span class="do">## 2) Compute an IORW weight by taking the inverse of the predicted odds ratio</span></span>
<span id="cb48-19"><a href="ChapIptw.html#cb48-19" tabindex="-1"></a><span class="do">##    from step 1 for each observation in the exposed group (the unexposed</span></span>
<span id="cb48-20"><a href="ChapIptw.html#cb48-20" tabindex="-1"></a><span class="do">##    group weight equals 1)</span></span>
<span id="cb48-21"><a href="ChapIptw.html#cb48-21" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">predict</span>(g.A.L0, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb48-22"><a href="ChapIptw.html#cb48-22" tabindex="-1"></a></span>
<span id="cb48-23"><a href="ChapIptw.html#cb48-23" tabindex="-1"></a>iorw <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">nrow</span>(df1_int))</span>
<span id="cb48-24"><a href="ChapIptw.html#cb48-24" tabindex="-1"></a>iorw[df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="sc">==</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb48-25"><a href="ChapIptw.html#cb48-25" tabindex="-1"></a>iorw[df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="sc">==</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> ((<span class="dv">1</span> <span class="sc">-</span> p[df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="sc">==</span> <span class="dv">1</span>]) <span class="sc">/</span></span>
<span id="cb48-26"><a href="ChapIptw.html#cb48-26" tabindex="-1"></a>                                  p[df1_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="sc">==</span> <span class="dv">1</span>])</span>
<span id="cb48-27"><a href="ChapIptw.html#cb48-27" tabindex="-1"></a></span>
<span id="cb48-28"><a href="ChapIptw.html#cb48-28" tabindex="-1"></a><span class="do">## 3) Estimate the direct effect of the exposure via a glm of the regression of</span></span>
<span id="cb48-29"><a href="ChapIptw.html#cb48-29" tabindex="-1"></a><span class="do">##    the outcome Y on the exposure A and baseline confounders L(0) and L(1),</span></span>
<span id="cb48-30"><a href="ChapIptw.html#cb48-30" tabindex="-1"></a><span class="do">##    with the appropriate link function and the weights from step 2</span></span>
<span id="cb48-31"><a href="ChapIptw.html#cb48-31" tabindex="-1"></a>Dir.Y.model.death <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y_death <span class="sc">~</span> A0_PM2<span class="fl">.5</span> <span class="sc">+</span> L0_male <span class="sc">+</span> L0_soc_env <span class="sc">+</span> L1,</span>
<span id="cb48-32"><a href="ChapIptw.html#cb48-32" tabindex="-1"></a>                         <span class="at">weights =</span> iorw,</span>
<span id="cb48-33"><a href="ChapIptw.html#cb48-33" tabindex="-1"></a>                         <span class="at">family =</span> <span class="st">&quot;gaussian&quot;</span>, <span class="co"># to get risk differences</span></span>
<span id="cb48-34"><a href="ChapIptw.html#cb48-34" tabindex="-1"></a>                         <span class="at">data =</span> df1_int)</span>
<span id="cb48-35"><a href="ChapIptw.html#cb48-35" tabindex="-1"></a><span class="fu">summary</span>(Dir.Y.model.death)</span>
<span id="cb48-36"><a href="ChapIptw.html#cb48-36" tabindex="-1"></a><span class="co">#               Estimate Std. Error t value Pr(&gt;|t|)</span></span>
<span id="cb48-37"><a href="ChapIptw.html#cb48-37" tabindex="-1"></a><span class="co">#   (Intercept) 0.102447   0.009481  10.805  &lt; 2e-16 ***</span></span>
<span id="cb48-38"><a href="ChapIptw.html#cb48-38" tabindex="-1"></a><span class="co">#   A0_PM2.5    0.063862   0.008313   7.682 1.71e-14 ***</span></span>
<span id="cb48-39"><a href="ChapIptw.html#cb48-39" tabindex="-1"></a><span class="co">#   L0_male     0.066841   0.008318   8.035 1.04e-15 ***</span></span>
<span id="cb48-40"><a href="ChapIptw.html#cb48-40" tabindex="-1"></a><span class="co">#   L0_soc_env  0.056381   0.008625   6.537 6.57e-11 ***</span></span>
<span id="cb48-41"><a href="ChapIptw.html#cb48-41" tabindex="-1"></a><span class="co">#   L1          0.091272   0.009103  10.026  &lt; 2e-16 ***</span></span>
<span id="cb48-42"><a href="ChapIptw.html#cb48-42" tabindex="-1"></a></span>
<span id="cb48-43"><a href="ChapIptw.html#cb48-43" tabindex="-1"></a>PNDE <span class="ot">&lt;-</span> <span class="fu">coef</span>(Dir.Y.model.death)[<span class="st">&quot;A0_PM2.5&quot;</span>]</span>
<span id="cb48-44"><a href="ChapIptw.html#cb48-44" tabindex="-1"></a><span class="co"># 0.06386221</span></span>
<span id="cb48-45"><a href="ChapIptw.html#cb48-45" tabindex="-1"></a></span>
<span id="cb48-46"><a href="ChapIptw.html#cb48-46" tabindex="-1"></a><span class="do">## 4) Estimate the total effect of the exposure A on the outcome Y using a standard</span></span>
<span id="cb48-47"><a href="ChapIptw.html#cb48-47" tabindex="-1"></a><span class="do">##    glm with the appropriate link function (adjusted for baseline confounders)</span></span>
<span id="cb48-48"><a href="ChapIptw.html#cb48-48" tabindex="-1"></a>Tot.Y.model.death <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y_death <span class="sc">~</span> A0_PM2<span class="fl">.5</span> <span class="sc">+</span> L0_male <span class="sc">+</span> L0_soc_env <span class="sc">+</span> L1,</span>
<span id="cb48-49"><a href="ChapIptw.html#cb48-49" tabindex="-1"></a>                         <span class="at">family =</span> <span class="st">&quot;gaussian&quot;</span>, <span class="co"># to get risk differences</span></span>
<span id="cb48-50"><a href="ChapIptw.html#cb48-50" tabindex="-1"></a>                         <span class="at">data =</span> df1_int)</span>
<span id="cb48-51"><a href="ChapIptw.html#cb48-51" tabindex="-1"></a><span class="fu">summary</span>(Tot.Y.model.death)</span>
<span id="cb48-52"><a href="ChapIptw.html#cb48-52" tabindex="-1"></a><span class="co"># Coefficients:</span></span>
<span id="cb48-53"><a href="ChapIptw.html#cb48-53" tabindex="-1"></a><span class="co">#               Estimate Std. Error t value Pr(&gt;|t|)</span></span>
<span id="cb48-54"><a href="ChapIptw.html#cb48-54" tabindex="-1"></a><span class="co">#   (Intercept) 0.111516   0.008328  13.390  &lt; 2e-16 ***</span></span>
<span id="cb48-55"><a href="ChapIptw.html#cb48-55" tabindex="-1"></a><span class="co">#   A0_PM2.5    0.076673   0.012777   6.001 2.03e-09 ***</span></span>
<span id="cb48-56"><a href="ChapIptw.html#cb48-56" tabindex="-1"></a><span class="co">#   L0_male     0.050049   0.008042   6.224 5.05e-10 ***</span></span>
<span id="cb48-57"><a href="ChapIptw.html#cb48-57" tabindex="-1"></a><span class="co">#   L0_soc_env  0.060178   0.008413   7.153 9.07e-13 ***</span></span>
<span id="cb48-58"><a href="ChapIptw.html#cb48-58" tabindex="-1"></a><span class="co">#   L1          0.080243   0.008813   9.106  &lt; 2e-16 ***</span></span>
<span id="cb48-59"><a href="ChapIptw.html#cb48-59" tabindex="-1"></a></span>
<span id="cb48-60"><a href="ChapIptw.html#cb48-60" tabindex="-1"></a><span class="co"># the total effect is 0.076673</span></span>
<span id="cb48-61"><a href="ChapIptw.html#cb48-61" tabindex="-1"></a></span>
<span id="cb48-62"><a href="ChapIptw.html#cb48-62" tabindex="-1"></a><span class="do">## 5) Calculate indirect effects by substracting the direct effect from the total</span></span>
<span id="cb48-63"><a href="ChapIptw.html#cb48-63" tabindex="-1"></a><span class="do">##    effect</span></span>
<span id="cb48-64"><a href="ChapIptw.html#cb48-64" tabindex="-1"></a>TNIE <span class="ot">&lt;-</span> <span class="fu">coef</span>(Tot.Y.model.death)[<span class="st">&quot;A0_PM2.5&quot;</span>] <span class="sc">-</span> PNDE</span>
<span id="cb48-65"><a href="ChapIptw.html#cb48-65" tabindex="-1"></a><span class="co"># 0.01281078</span></span>
<span id="cb48-66"><a href="ChapIptw.html#cb48-66" tabindex="-1"></a></span>
<span id="cb48-67"><a href="ChapIptw.html#cb48-67" tabindex="-1"></a><span class="do">## 6) bootstrap effect estimates to get 95% confidence intervals</span></span></code></pre></div>
<p>We can use the <code>CMAverse</code> package to obtain those estimations by IORW.</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="ChapIptw.html#cb49-1" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list=</span><span class="fu">ls</span>())</span>
<span id="cb49-2"><a href="ChapIptw.html#cb49-2" tabindex="-1"></a>df1_int <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="st">&quot;data/df1_int.csv&quot;</span>)</span>
<span id="cb49-3"><a href="ChapIptw.html#cb49-3" tabindex="-1"></a><span class="fu">library</span>(CMAverse)</span>
<span id="cb49-4"><a href="ChapIptw.html#cb49-4" tabindex="-1"></a></span>
<span id="cb49-5"><a href="ChapIptw.html#cb49-5" tabindex="-1"></a><span class="do">## Using the CMAverse to estimate PNDE and TNIE by IORW</span></span>
<span id="cb49-6"><a href="ChapIptw.html#cb49-6" tabindex="-1"></a>res_msm_df1.death <span class="ot">&lt;-</span> <span class="fu">cmest</span>(<span class="at">data =</span> df1_int,</span>
<span id="cb49-7"><a href="ChapIptw.html#cb49-7" tabindex="-1"></a>                           <span class="at">model =</span> <span class="st">&quot;iorw&quot;</span>,</span>
<span id="cb49-8"><a href="ChapIptw.html#cb49-8" tabindex="-1"></a>                           <span class="at">outcome =</span> <span class="st">&quot;Y_death&quot;</span>,</span>
<span id="cb49-9"><a href="ChapIptw.html#cb49-9" tabindex="-1"></a>                           <span class="at">exposure =</span> <span class="st">&quot;A0_PM2.5&quot;</span>,</span>
<span id="cb49-10"><a href="ChapIptw.html#cb49-10" tabindex="-1"></a>                           <span class="at">mediator =</span> <span class="st">&quot;M_diabetes&quot;</span>,</span>
<span id="cb49-11"><a href="ChapIptw.html#cb49-11" tabindex="-1"></a>                           <span class="at">basec =</span> <span class="fu">c</span>(<span class="st">&quot;L0_male&quot;</span>, <span class="st">&quot;L0_soc_env&quot;</span>,<span class="st">&quot;L1&quot;</span>),</span>
<span id="cb49-12"><a href="ChapIptw.html#cb49-12" tabindex="-1"></a>                           <span class="at">postc =</span> <span class="cn">NULL</span>,</span>
<span id="cb49-13"><a href="ChapIptw.html#cb49-13" tabindex="-1"></a>                           <span class="co"># EMint = TRUE, # not needed for IORW</span></span>
<span id="cb49-14"><a href="ChapIptw.html#cb49-14" tabindex="-1"></a>                           <span class="at">ereg =</span> <span class="st">&quot;logistic&quot;</span>, <span class="co"># exposure regression model g(A=1|L(0))</span></span>
<span id="cb49-15"><a href="ChapIptw.html#cb49-15" tabindex="-1"></a>                           <span class="at">yreg =</span> <span class="st">&quot;linear&quot;</span>, <span class="co"># to get risk difference</span></span>
<span id="cb49-16"><a href="ChapIptw.html#cb49-16" tabindex="-1"></a>                           <span class="co"># mreg = list(&quot;logistic&quot;), # not needed for IORW</span></span>
<span id="cb49-17"><a href="ChapIptw.html#cb49-17" tabindex="-1"></a>                           <span class="co"># wmnomreg = list(&quot;logistic&quot;), # not needed for IORW</span></span>
<span id="cb49-18"><a href="ChapIptw.html#cb49-18" tabindex="-1"></a>                           <span class="co"># wmdenomreg = list(&quot;logistic&quot;), # not needed for IORW</span></span>
<span id="cb49-19"><a href="ChapIptw.html#cb49-19" tabindex="-1"></a>                           <span class="at">astar =</span> <span class="dv">0</span>, <span class="co">#E(Y_{A=0,M=1})</span></span>
<span id="cb49-20"><a href="ChapIptw.html#cb49-20" tabindex="-1"></a>                           <span class="at">a =</span> <span class="dv">1</span>,  <span class="co">#E(Y_{A=1,M=1})</span></span>
<span id="cb49-21"><a href="ChapIptw.html#cb49-21" tabindex="-1"></a>                           <span class="co"># mval = list(0), # not needed for IORW</span></span>
<span id="cb49-22"><a href="ChapIptw.html#cb49-22" tabindex="-1"></a>                           <span class="at">estimation =</span> <span class="st">&quot;imputation&quot;</span>,</span>
<span id="cb49-23"><a href="ChapIptw.html#cb49-23" tabindex="-1"></a>                           <span class="at">inference =</span> <span class="st">&quot;bootstrap&quot;</span>,</span>
<span id="cb49-24"><a href="ChapIptw.html#cb49-24" tabindex="-1"></a>                           <span class="at">nboot =</span> <span class="dv">2</span>)</span>
<span id="cb49-25"><a href="ChapIptw.html#cb49-25" tabindex="-1"></a><span class="fu">summary</span>(res_msm_df1.death)</span>
<span id="cb49-26"><a href="ChapIptw.html#cb49-26" tabindex="-1"></a><span class="co"># Causal Mediation Analysis</span></span>
<span id="cb49-27"><a href="ChapIptw.html#cb49-27" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb49-28"><a href="ChapIptw.html#cb49-28" tabindex="-1"></a><span class="co"># # Outcome regression for the total effect:</span></span>
<span id="cb49-29"><a href="ChapIptw.html#cb49-29" tabindex="-1"></a><span class="co"># Call:</span></span>
<span id="cb49-30"><a href="ChapIptw.html#cb49-30" tabindex="-1"></a><span class="co">#   glm(formula = Y_death ~ A0_PM2.5 + L0_male + L0_soc_env + L1,</span></span>
<span id="cb49-31"><a href="ChapIptw.html#cb49-31" tabindex="-1"></a><span class="co">#       family = gaussian(), data = getCall(x$reg.output$yregTot)$data,</span></span>
<span id="cb49-32"><a href="ChapIptw.html#cb49-32" tabindex="-1"></a><span class="co">#       weights = getCall(x$reg.output$yregTot)$weights)</span></span>
<span id="cb49-33"><a href="ChapIptw.html#cb49-33" tabindex="-1"></a><span class="co"># Coefficients:</span></span>
<span id="cb49-34"><a href="ChapIptw.html#cb49-34" tabindex="-1"></a><span class="co">#               Estimate Std. Error t value Pr(&gt;|t|)</span></span>
<span id="cb49-35"><a href="ChapIptw.html#cb49-35" tabindex="-1"></a><span class="co">#   (Intercept) 0.111516   0.008328  13.390  &lt; 2e-16 ***</span></span>
<span id="cb49-36"><a href="ChapIptw.html#cb49-36" tabindex="-1"></a><span class="co">#   A0_PM2.5    0.076673   0.012777   6.001 2.03e-09 ***</span></span>
<span id="cb49-37"><a href="ChapIptw.html#cb49-37" tabindex="-1"></a><span class="co">#   L0_male     0.050049   0.008042   6.224 5.05e-10 ***</span></span>
<span id="cb49-38"><a href="ChapIptw.html#cb49-38" tabindex="-1"></a><span class="co">#   L0_soc_env  0.060178   0.008413   7.153 9.07e-13 ***</span></span>
<span id="cb49-39"><a href="ChapIptw.html#cb49-39" tabindex="-1"></a><span class="co">#   L1          0.080243   0.008813   9.106  &lt; 2e-16 ***</span></span>
<span id="cb49-40"><a href="ChapIptw.html#cb49-40" tabindex="-1"></a><span class="co">#   ---</span></span>
<span id="cb49-41"><a href="ChapIptw.html#cb49-41" tabindex="-1"></a><span class="co">#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1</span></span>
<span id="cb49-42"><a href="ChapIptw.html#cb49-42" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb49-43"><a href="ChapIptw.html#cb49-43" tabindex="-1"></a><span class="co"># # Outcome regression for the direct effect:</span></span>
<span id="cb49-44"><a href="ChapIptw.html#cb49-44" tabindex="-1"></a><span class="co"># Call:</span></span>
<span id="cb49-45"><a href="ChapIptw.html#cb49-45" tabindex="-1"></a><span class="co">#   glm(formula = Y_death ~ A0_PM2.5 + L0_male + L0_soc_env + L1,</span></span>
<span id="cb49-46"><a href="ChapIptw.html#cb49-46" tabindex="-1"></a><span class="co">#       family = gaussian(), data = getCall(x$reg.output$yregDir)$data,</span></span>
<span id="cb49-47"><a href="ChapIptw.html#cb49-47" tabindex="-1"></a><span class="co">#       weights = getCall(x$reg.output$yregDir)$weights)</span></span>
<span id="cb49-48"><a href="ChapIptw.html#cb49-48" tabindex="-1"></a><span class="co"># Coefficients:</span></span>
<span id="cb49-49"><a href="ChapIptw.html#cb49-49" tabindex="-1"></a><span class="co">#               Estimate Std. Error t value Pr(&gt;|t|)</span></span>
<span id="cb49-50"><a href="ChapIptw.html#cb49-50" tabindex="-1"></a><span class="co">#   (Intercept) 0.102447   0.009481  10.805  &lt; 2e-16 ***</span></span>
<span id="cb49-51"><a href="ChapIptw.html#cb49-51" tabindex="-1"></a><span class="co">#   A0_PM2.5    0.063862   0.008313   7.682 1.71e-14 ***</span></span>
<span id="cb49-52"><a href="ChapIptw.html#cb49-52" tabindex="-1"></a><span class="co">#   L0_male     0.066841   0.008318   8.035 1.04e-15 ***</span></span>
<span id="cb49-53"><a href="ChapIptw.html#cb49-53" tabindex="-1"></a><span class="co">#   L0_soc_env  0.056381   0.008625   6.537 6.57e-11 ***</span></span>
<span id="cb49-54"><a href="ChapIptw.html#cb49-54" tabindex="-1"></a><span class="co">#   L1          0.091272   0.009103  10.026  &lt; 2e-16 ***</span></span>
<span id="cb49-55"><a href="ChapIptw.html#cb49-55" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb49-56"><a href="ChapIptw.html#cb49-56" tabindex="-1"></a><span class="co"># # Exposure regression for weighting:</span></span>
<span id="cb49-57"><a href="ChapIptw.html#cb49-57" tabindex="-1"></a><span class="co"># Call:</span></span>
<span id="cb49-58"><a href="ChapIptw.html#cb49-58" tabindex="-1"></a><span class="co">#   glm(formula = A0_PM2.5 ~ M_diabetes + L0_male + L0_soc_env +</span></span>
<span id="cb49-59"><a href="ChapIptw.html#cb49-59" tabindex="-1"></a><span class="co">#         L1, family = binomial(), data = getCall(x$reg.output$ereg)$data,</span></span>
<span id="cb49-60"><a href="ChapIptw.html#cb49-60" tabindex="-1"></a><span class="co">#       weights = getCall(x$reg.output$ereg)$weights)</span></span>
<span id="cb49-61"><a href="ChapIptw.html#cb49-61" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb49-62"><a href="ChapIptw.html#cb49-62" tabindex="-1"></a><span class="co"># Coefficients:</span></span>
<span id="cb49-63"><a href="ChapIptw.html#cb49-63" tabindex="-1"></a><span class="co">#                Estimate Std. Error z value Pr(&gt;|z|)</span></span>
<span id="cb49-64"><a href="ChapIptw.html#cb49-64" tabindex="-1"></a><span class="co">#   (Intercept) -2.883345   0.080069 -36.011  &lt; 2e-16 ***</span></span>
<span id="cb49-65"><a href="ChapIptw.html#cb49-65" tabindex="-1"></a><span class="co">#   M_diabetes   0.562935   0.065539   8.589  &lt; 2e-16 ***</span></span>
<span id="cb49-66"><a href="ChapIptw.html#cb49-66" tabindex="-1"></a><span class="co">#   L0_male      0.374904   0.064828   5.783 7.34e-09 ***</span></span>
<span id="cb49-67"><a href="ChapIptw.html#cb49-67" tabindex="-1"></a><span class="co">#   L0_soc_env   0.600956   0.073872   8.135 4.12e-16 ***</span></span>
<span id="cb49-68"><a href="ChapIptw.html#cb49-68" tabindex="-1"></a><span class="co">#   L1          -0.007768   0.070141  -0.111    0.912</span></span>
<span id="cb49-69"><a href="ChapIptw.html#cb49-69" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb49-70"><a href="ChapIptw.html#cb49-70" tabindex="-1"></a><span class="co"># # Effect decomposition on the mean difference scale via the inverse odds ratio weighting approach</span></span>
<span id="cb49-71"><a href="ChapIptw.html#cb49-71" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb49-72"><a href="ChapIptw.html#cb49-72" tabindex="-1"></a><span class="co"># Direct counterfactual imputation estimation with</span></span>
<span id="cb49-73"><a href="ChapIptw.html#cb49-73" tabindex="-1"></a><span class="co"># bootstrap standard errors, percentile confidence intervals and p-values</span></span>
<span id="cb49-74"><a href="ChapIptw.html#cb49-74" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb49-75"><a href="ChapIptw.html#cb49-75" tabindex="-1"></a><span class="co">#        Estimate Std.error  95% CIL 95% CIU  P.val</span></span>
<span id="cb49-76"><a href="ChapIptw.html#cb49-76" tabindex="-1"></a><span class="co">#   te   0.076673  0.009812 0.072033   0.085 &lt;2e-16 ***</span></span>
<span id="cb49-77"><a href="ChapIptw.html#cb49-77" tabindex="-1"></a><span class="co">#   pnde 0.063862  0.003280 0.056996   0.061 &lt;2e-16 ***</span></span>
<span id="cb49-78"><a href="ChapIptw.html#cb49-78" tabindex="-1"></a><span class="co">#   tnie 0.012811  0.006532 0.015038   0.024 &lt;2e-16 ***</span></span>
<span id="cb49-79"><a href="ChapIptw.html#cb49-79" tabindex="-1"></a><span class="co">#   pm   0.167083  0.052652 0.208409   0.279 &lt;2e-16 ***</span></span>
<span id="cb49-80"><a href="ChapIptw.html#cb49-80" tabindex="-1"></a><span class="co">#   ---</span></span>
<span id="cb49-81"><a href="ChapIptw.html#cb49-81" tabindex="-1"></a><span class="co">#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1</span></span>
<span id="cb49-82"><a href="ChapIptw.html#cb49-82" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb49-83"><a href="ChapIptw.html#cb49-83" tabindex="-1"></a><span class="co"># (te: total effect;</span></span>
<span id="cb49-84"><a href="ChapIptw.html#cb49-84" tabindex="-1"></a><span class="co"># pnde: pure natural direct effect;</span></span>
<span id="cb49-85"><a href="ChapIptw.html#cb49-85" tabindex="-1"></a><span class="co"># tnie: total natural indirect effect;</span></span>
<span id="cb49-86"><a href="ChapIptw.html#cb49-86" tabindex="-1"></a><span class="co"># pm: proportion mediated)</span></span></code></pre></div>
</div>
<div id="estimation-of-conditional-randomizedinterventional-natural-direct-crde-and-indirect-effects-crie-1" class="section level2 hasAnchor" number="7.4">
<h2><span class="header-section-number">7.4</span> Estimation of “Conditional” Randomized/Interventional Natural Direct (CRDE) and Indirect Effects (CRIE)<a href="ChapIptw.html#estimation-of-conditional-randomizedinterventional-natural-direct-crde-and-indirect-effects-crie-1" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="iptw-for-the-crde-and-crie" class="section level3 hasAnchor" number="7.4.1">
<h3><span class="header-section-number">7.4.1</span> IPTW for the CRDE and CRIE<a href="ChapIptw.html#iptw-for-the-crde-and-crie" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Zheng and van der Laan <span class="citation">(<a href="#ref-zheng2017longitudinal">Zheng and van der Laan 2017</a>)</span> described “Conditional” Randomized Direct and Indirect Effects, using random draws from the counterfactual distribution of the mediator, conditional on both <span class="math inline">\(L(0)\)</span> and <span class="math inline">\(L(1)\)</span>. The Average Total Effect (ATE) can be decomposed into the sum of :</p>
<ul>
<li>a Conditional Randomized Natural Direct Effect (CRDE):
<span class="math inline">\(\text{CRDE}=\mathbb{E}(Y_{1,\Gamma_{0} \mid L(0),L(1)})-\mathbb{E}(Y_{0,\Gamma_{0} \mid L(0), L(1)})\)</span>,</li>
<li>and Conditional Randomized Natural Indirect Effect (CRIE)
<span class="math inline">\(\text{CRIE}=\mathbb{E}(Y_{1,\Gamma_{1} \mid L(0), L(1)})-\mathbb{E}(Y_{1,\Gamma_{0} \mid L(0), L(1)})\)</span>.</li>
</ul>
<p>Under the identifiability conditions, the quantity of <span class="math inline">\(\mathbb{E}(Y_{a,\Gamma_{a^\prime} \mid L(0), L(1)})\)</span> can be estimated by IPTW:
<span class="math display">\[\begin{equation*}
  \Psi^{a,a^\prime}_\text{IPTW} = \mathbb{E}\left[Y_{a,\Gamma_{a^\prime} \mid L(0), L(1)} \right] = \frac{1}{n} \sum_{i=1}^n D_\text{IPTW}^{a,a^\prime}
\end{equation*}\]</span>
where
<span class="math display">\[\begin{equation*}
  D_\text{IPTW}^{a,a^\prime} = Y \frac{I(A=a)}{p_A(A=a\mid L(0))} \frac{p_M(M \mid A=a^\prime,L(1),L(0))}{p_M(M \mid A=a,L(1),L(0))}
\end{equation*}\]</span>
and the variance of the estimator <span class="math inline">\(\Psi^{a,a^\prime}_\text{IPTW}\)</span> is <span class="math inline">\(\text{var}\left(\Psi^{a,a^\prime}_\text{IPTW}\right) = \frac{\text{var}\left(D_\text{IPTW}^{a,a^\prime}\right)}{n}\)</span>, which can be used to estimate 90% confidence intervals.</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="ChapIptw.html#cb50-1" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list=</span><span class="fu">ls</span>())</span>
<span id="cb50-2"><a href="ChapIptw.html#cb50-2" tabindex="-1"></a>df2_int <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="st">&quot;./data/df2_int.csv&quot;</span>)</span>
<span id="cb50-3"><a href="ChapIptw.html#cb50-3" tabindex="-1"></a></span>
<span id="cb50-4"><a href="ChapIptw.html#cb50-4" tabindex="-1"></a><span class="do">## In order to estimate Psi^{a,a&#39;}</span></span>
<span id="cb50-5"><a href="ChapIptw.html#cb50-5" tabindex="-1"></a><span class="do">## 1. Estimate gA and gM</span></span>
<span id="cb50-6"><a href="ChapIptw.html#cb50-6" tabindex="-1"></a>gA <span class="ot">&lt;-</span> <span class="fu">glm</span>(A0_PM2<span class="fl">.5</span> <span class="sc">~</span> L0_male <span class="sc">+</span> L0_soc_env,</span>
<span id="cb50-7"><a href="ChapIptw.html#cb50-7" tabindex="-1"></a>          <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>, <span class="at">data =</span> df2_int)</span>
<span id="cb50-8"><a href="ChapIptw.html#cb50-8" tabindex="-1"></a>gM <span class="ot">&lt;-</span> <span class="fu">glm</span>(M_diabetes <span class="sc">~</span> L0_male <span class="sc">+</span> L0_soc_env <span class="sc">+</span> A0_PM2<span class="fl">.5</span> <span class="sc">+</span> L1,</span>
<span id="cb50-9"><a href="ChapIptw.html#cb50-9" tabindex="-1"></a>          <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>, <span class="at">data =</span> df2_int)</span>
<span id="cb50-10"><a href="ChapIptw.html#cb50-10" tabindex="-1"></a></span>
<span id="cb50-11"><a href="ChapIptw.html#cb50-11" tabindex="-1"></a><span class="do">## 2. Predict each individual&#39;s probability of being exposed to her own exposure</span></span>
<span id="cb50-12"><a href="ChapIptw.html#cb50-12" tabindex="-1"></a><span class="co"># predict the probabilities P(A0_PM2.5=1|L(0)) &amp; P(A0_PM2.5=0|L(0))</span></span>
<span id="cb50-13"><a href="ChapIptw.html#cb50-13" tabindex="-1"></a>pred.gA1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(gA, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb50-14"><a href="ChapIptw.html#cb50-14" tabindex="-1"></a>pred.gA0 <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> pred.gA1</span>
<span id="cb50-15"><a href="ChapIptw.html#cb50-15" tabindex="-1"></a><span class="co"># the predicted probability of the observed treatment A_i=a is :</span></span>
<span id="cb50-16"><a href="ChapIptw.html#cb50-16" tabindex="-1"></a>gAobs <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">nrow</span>(df2_int))</span>
<span id="cb50-17"><a href="ChapIptw.html#cb50-17" tabindex="-1"></a>gAobs[df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="sc">==</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> pred.gA1[df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="sc">==</span> <span class="dv">1</span>]</span>
<span id="cb50-18"><a href="ChapIptw.html#cb50-18" tabindex="-1"></a>gAobs[df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="sc">==</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> pred.gA0[df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="sc">==</span> <span class="dv">0</span>]</span>
<span id="cb50-19"><a href="ChapIptw.html#cb50-19" tabindex="-1"></a></span>
<span id="cb50-20"><a href="ChapIptw.html#cb50-20" tabindex="-1"></a><span class="co"># predict the probabilities</span></span>
<span id="cb50-21"><a href="ChapIptw.html#cb50-21" tabindex="-1"></a><span class="co"># P(M=1|L(0),A=1,L(1)) &amp; P(M=0|L(0),A=1,L(1)) setting A = 1</span></span>
<span id="cb50-22"><a href="ChapIptw.html#cb50-22" tabindex="-1"></a><span class="co"># and P(M=1|L(0),A=0,L(1)) &amp; P(M=0|L(0),A=0,L(1)) setting A = 0</span></span>
<span id="cb50-23"><a href="ChapIptw.html#cb50-23" tabindex="-1"></a>data.Ais0 <span class="ot">&lt;-</span> data.Ais1 <span class="ot">&lt;-</span> df2_int</span>
<span id="cb50-24"><a href="ChapIptw.html#cb50-24" tabindex="-1"></a>data.Ais0<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb50-25"><a href="ChapIptw.html#cb50-25" tabindex="-1"></a>data.Ais1<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb50-26"><a href="ChapIptw.html#cb50-26" tabindex="-1"></a></span>
<span id="cb50-27"><a href="ChapIptw.html#cb50-27" tabindex="-1"></a>pred.gM1.Ais1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(gM, <span class="at">newdata =</span> data.Ais1, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb50-28"><a href="ChapIptw.html#cb50-28" tabindex="-1"></a>pred.gM0.Ais1 <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> pred.gM1.Ais1</span>
<span id="cb50-29"><a href="ChapIptw.html#cb50-29" tabindex="-1"></a><span class="co"># the predicted probability of the observed treatment M_i=m is :</span></span>
<span id="cb50-30"><a href="ChapIptw.html#cb50-30" tabindex="-1"></a>gMobs.Ais1 <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">nrow</span>(df2_int))</span>
<span id="cb50-31"><a href="ChapIptw.html#cb50-31" tabindex="-1"></a>gMobs.Ais1[df2_int<span class="sc">$</span>M_diabetes <span class="sc">==</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> pred.gM1.Ais1[df2_int<span class="sc">$</span>M_diabetes <span class="sc">==</span> <span class="dv">1</span>]</span>
<span id="cb50-32"><a href="ChapIptw.html#cb50-32" tabindex="-1"></a>gMobs.Ais1[df2_int<span class="sc">$</span>M_diabetes <span class="sc">==</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> pred.gM0.Ais1[df2_int<span class="sc">$</span>M_diabetes <span class="sc">==</span> <span class="dv">0</span>]</span>
<span id="cb50-33"><a href="ChapIptw.html#cb50-33" tabindex="-1"></a></span>
<span id="cb50-34"><a href="ChapIptw.html#cb50-34" tabindex="-1"></a>pred.gM1.Ais0 <span class="ot">&lt;-</span> <span class="fu">predict</span>(gM, <span class="at">newdata =</span> data.Ais0, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb50-35"><a href="ChapIptw.html#cb50-35" tabindex="-1"></a>pred.gM0.Ais0 <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> pred.gM1.Ais0</span>
<span id="cb50-36"><a href="ChapIptw.html#cb50-36" tabindex="-1"></a><span class="co"># the predicted probability of the observed treatment M_i=m is :</span></span>
<span id="cb50-37"><a href="ChapIptw.html#cb50-37" tabindex="-1"></a>gMobs.Ais0 <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">nrow</span>(df2_int))</span>
<span id="cb50-38"><a href="ChapIptw.html#cb50-38" tabindex="-1"></a>gMobs.Ais0[df2_int<span class="sc">$</span>M_diabetes <span class="sc">==</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> pred.gM1.Ais0[df2_int<span class="sc">$</span>M_diabetes <span class="sc">==</span> <span class="dv">1</span>]</span>
<span id="cb50-39"><a href="ChapIptw.html#cb50-39" tabindex="-1"></a>gMobs.Ais0[df2_int<span class="sc">$</span>M_diabetes <span class="sc">==</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> pred.gM0.Ais0[df2_int<span class="sc">$</span>M_diabetes <span class="sc">==</span> <span class="dv">0</span>]</span>
<span id="cb50-40"><a href="ChapIptw.html#cb50-40" tabindex="-1"></a></span>
<span id="cb50-41"><a href="ChapIptw.html#cb50-41" tabindex="-1"></a><span class="do">## 3. Calculate D^{a,a&#39;} - influence curve of the IPTW estimator</span></span>
<span id="cb50-42"><a href="ChapIptw.html#cb50-42" tabindex="-1"></a>D.death<span class="fl">.11</span> <span class="ot">&lt;-</span> (df2_int<span class="sc">$</span>Y_death <span class="sc">*</span> (<span class="fu">I</span>(df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">/</span> gAobs) <span class="sc">*</span></span>
<span id="cb50-43"><a href="ChapIptw.html#cb50-43" tabindex="-1"></a>                 (gMobs.Ais1 <span class="sc">/</span> gMobs.Ais1))</span>
<span id="cb50-44"><a href="ChapIptw.html#cb50-44" tabindex="-1"></a>D.death<span class="fl">.10</span> <span class="ot">&lt;-</span> (df2_int<span class="sc">$</span>Y_death <span class="sc">*</span> (<span class="fu">I</span>(df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">/</span> gAobs) <span class="sc">*</span></span>
<span id="cb50-45"><a href="ChapIptw.html#cb50-45" tabindex="-1"></a>                 (gMobs.Ais0 <span class="sc">/</span> gMobs.Ais1))</span>
<span id="cb50-46"><a href="ChapIptw.html#cb50-46" tabindex="-1"></a>D.death<span class="fl">.00</span> <span class="ot">&lt;-</span> (df2_int<span class="sc">$</span>Y_death <span class="sc">*</span> (<span class="fu">I</span>(df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">/</span> gAobs) <span class="sc">*</span></span>
<span id="cb50-47"><a href="ChapIptw.html#cb50-47" tabindex="-1"></a>                 (gMobs.Ais0 <span class="sc">/</span> gMobs.Ais0))</span>
<span id="cb50-48"><a href="ChapIptw.html#cb50-48" tabindex="-1"></a></span>
<span id="cb50-49"><a href="ChapIptw.html#cb50-49" tabindex="-1"></a>D.qol<span class="fl">.11</span> <span class="ot">&lt;-</span> (df2_int<span class="sc">$</span>Y_qol <span class="sc">*</span> (<span class="fu">I</span>(df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">/</span> gAobs) <span class="sc">*</span></span>
<span id="cb50-50"><a href="ChapIptw.html#cb50-50" tabindex="-1"></a>               (gMobs.Ais1 <span class="sc">/</span> gMobs.Ais1))</span>
<span id="cb50-51"><a href="ChapIptw.html#cb50-51" tabindex="-1"></a>D.qol<span class="fl">.10</span> <span class="ot">&lt;-</span> (df2_int<span class="sc">$</span>Y_qol <span class="sc">*</span> (<span class="fu">I</span>(df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">/</span> gAobs) <span class="sc">*</span></span>
<span id="cb50-52"><a href="ChapIptw.html#cb50-52" tabindex="-1"></a>               (gMobs.Ais0 <span class="sc">/</span> gMobs.Ais1))</span>
<span id="cb50-53"><a href="ChapIptw.html#cb50-53" tabindex="-1"></a>D.qol<span class="fl">.00</span> <span class="ot">&lt;-</span> (df2_int<span class="sc">$</span>Y_qol <span class="sc">*</span> (<span class="fu">I</span>(df2_int<span class="sc">$</span>A0_PM2<span class="fl">.5</span> <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">/</span> gAobs) <span class="sc">*</span></span>
<span id="cb50-54"><a href="ChapIptw.html#cb50-54" tabindex="-1"></a>               (gMobs.Ais0 <span class="sc">/</span> gMobs.Ais0))</span>
<span id="cb50-55"><a href="ChapIptw.html#cb50-55" tabindex="-1"></a></span>
<span id="cb50-56"><a href="ChapIptw.html#cb50-56" tabindex="-1"></a><span class="do">## 4. Calculate CRDE and CRIE</span></span>
<span id="cb50-57"><a href="ChapIptw.html#cb50-57" tabindex="-1"></a><span class="do">## For death</span></span>
<span id="cb50-58"><a href="ChapIptw.html#cb50-58" tabindex="-1"></a>CRDE.death <span class="ot">&lt;-</span> <span class="fu">mean</span>(D.death<span class="fl">.10</span>) <span class="sc">-</span> <span class="fu">mean</span>(D.death<span class="fl">.00</span>)</span>
<span id="cb50-59"><a href="ChapIptw.html#cb50-59" tabindex="-1"></a>CRDE.death</span>
<span id="cb50-60"><a href="ChapIptw.html#cb50-60" tabindex="-1"></a><span class="co"># [1] 0.07405068</span></span>
<span id="cb50-61"><a href="ChapIptw.html#cb50-61" tabindex="-1"></a>CRIE.death <span class="ot">&lt;-</span> <span class="fu">mean</span>(D.death<span class="fl">.11</span>) <span class="sc">-</span> <span class="fu">mean</span>(D.death<span class="fl">.10</span>)</span>
<span id="cb50-62"><a href="ChapIptw.html#cb50-62" tabindex="-1"></a>CRIE.death</span>
<span id="cb50-63"><a href="ChapIptw.html#cb50-63" tabindex="-1"></a><span class="co"># [1] 0.00819879</span></span>
<span id="cb50-64"><a href="ChapIptw.html#cb50-64" tabindex="-1"></a></span>
<span id="cb50-65"><a href="ChapIptw.html#cb50-65" tabindex="-1"></a><span class="do">## For quality of life</span></span>
<span id="cb50-66"><a href="ChapIptw.html#cb50-66" tabindex="-1"></a>CRDE.qol <span class="ot">&lt;-</span> <span class="fu">mean</span>(D.qol<span class="fl">.10</span>) <span class="sc">-</span> <span class="fu">mean</span>(D.qol<span class="fl">.00</span>)</span>
<span id="cb50-67"><a href="ChapIptw.html#cb50-67" tabindex="-1"></a>CRDE.qol</span>
<span id="cb50-68"><a href="ChapIptw.html#cb50-68" tabindex="-1"></a><span class="co"># [1] -7.563116</span></span>
<span id="cb50-69"><a href="ChapIptw.html#cb50-69" tabindex="-1"></a>CRIE.qol <span class="ot">&lt;-</span> <span class="fu">mean</span>(D.qol<span class="fl">.11</span>) <span class="sc">-</span> <span class="fu">mean</span>(D.qol<span class="fl">.10</span>)</span>
<span id="cb50-70"><a href="ChapIptw.html#cb50-70" tabindex="-1"></a>CRIE.qol</span>
<span id="cb50-71"><a href="ChapIptw.html#cb50-71" tabindex="-1"></a><span class="co"># [1] -0.8736813</span></span>
<span id="cb50-72"><a href="ChapIptw.html#cb50-72" tabindex="-1"></a></span>
<span id="cb50-73"><a href="ChapIptw.html#cb50-73" tabindex="-1"></a><span class="do">## 5. Calculate 95% CI based on the influence curve D^{a,a&#39;}</span></span>
<span id="cb50-74"><a href="ChapIptw.html#cb50-74" tabindex="-1"></a><span class="co"># the variance of the estimator Psi^{a,a&#39;} = mean(D^{a,a&#39;}) is var(D^{a,a&#39;}) / n)</span></span>
<span id="cb50-75"><a href="ChapIptw.html#cb50-75" tabindex="-1"></a>se.CRDE.death <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">var</span>(D.death<span class="fl">.10</span> <span class="sc">-</span> D.death<span class="fl">.00</span>) <span class="sc">/</span> <span class="fu">nrow</span>(df2_int))</span>
<span id="cb50-76"><a href="ChapIptw.html#cb50-76" tabindex="-1"></a><span class="fu">c</span>(CRDE.death <span class="sc">-</span> <span class="fu">qnorm</span>(<span class="fl">0.975</span>) <span class="sc">*</span> se.CRDE.death,</span>
<span id="cb50-77"><a href="ChapIptw.html#cb50-77" tabindex="-1"></a>  CRDE.death <span class="sc">+</span> <span class="fu">qnorm</span>(<span class="fl">0.975</span>) <span class="sc">*</span> se.CRDE.death)</span>
<span id="cb50-78"><a href="ChapIptw.html#cb50-78" tabindex="-1"></a><span class="co"># [1] 0.04141535 0.10668602</span></span>
<span id="cb50-79"><a href="ChapIptw.html#cb50-79" tabindex="-1"></a>se.CRIE.death <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">var</span>(D.death<span class="fl">.11</span> <span class="sc">-</span> D.death<span class="fl">.10</span>) <span class="sc">/</span> <span class="fu">nrow</span>(df2_int))</span>
<span id="cb50-80"><a href="ChapIptw.html#cb50-80" tabindex="-1"></a><span class="fu">c</span>(CRIE.death <span class="sc">-</span> <span class="fu">qnorm</span>(<span class="fl">0.975</span>) <span class="sc">*</span> se.CRIE.death,</span>
<span id="cb50-81"><a href="ChapIptw.html#cb50-81" tabindex="-1"></a>  CRIE.death <span class="sc">+</span> <span class="fu">qnorm</span>(<span class="fl">0.975</span>) <span class="sc">*</span> se.CRIE.death)</span>
<span id="cb50-82"><a href="ChapIptw.html#cb50-82" tabindex="-1"></a><span class="co"># [1] 0.003380238 0.013017342</span></span>
<span id="cb50-83"><a href="ChapIptw.html#cb50-83" tabindex="-1"></a></span>
<span id="cb50-84"><a href="ChapIptw.html#cb50-84" tabindex="-1"></a>se.CRDE.qol <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">var</span>(D.qol<span class="fl">.10</span> <span class="sc">-</span> D.qol<span class="fl">.00</span>) <span class="sc">/</span> <span class="fu">nrow</span>(df2_int))</span>
<span id="cb50-85"><a href="ChapIptw.html#cb50-85" tabindex="-1"></a><span class="fu">c</span>(CRDE.qol <span class="sc">-</span> <span class="fu">qnorm</span>(<span class="fl">0.975</span>) <span class="sc">*</span> se.CRDE.qol,</span>
<span id="cb50-86"><a href="ChapIptw.html#cb50-86" tabindex="-1"></a>  CRDE.qol <span class="sc">+</span> <span class="fu">qnorm</span>(<span class="fl">0.975</span>) <span class="sc">*</span> se.CRDE.qol)</span>
<span id="cb50-87"><a href="ChapIptw.html#cb50-87" tabindex="-1"></a><span class="co"># [1] -11.748095  -3.378137</span></span>
<span id="cb50-88"><a href="ChapIptw.html#cb50-88" tabindex="-1"></a>se.CRIE.qol <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">var</span>(D.qol<span class="fl">.11</span> <span class="sc">-</span> D.qol<span class="fl">.10</span>) <span class="sc">/</span> <span class="fu">nrow</span>(df2_int))</span>
<span id="cb50-89"><a href="ChapIptw.html#cb50-89" tabindex="-1"></a><span class="fu">c</span>(CRIE.qol <span class="sc">-</span> <span class="fu">qnorm</span>(<span class="fl">0.975</span>) <span class="sc">*</span> se.CRIE.qol,</span>
<span id="cb50-90"><a href="ChapIptw.html#cb50-90" tabindex="-1"></a>  CRIE.qol <span class="sc">+</span> <span class="fu">qnorm</span>(<span class="fl">0.975</span>) <span class="sc">*</span> se.CRIE.qol)</span>
<span id="cb50-91"><a href="ChapIptw.html#cb50-91" tabindex="-1"></a><span class="co"># [1] -1.4111404 -0.3362223</span></span></code></pre></div>
<p>Results are close to the estimations obtained by g-computation. IPTW estimations are know to be more sensitive to positivity issues, with larger confidence intervals (they can be too conservative with more than 95% coverage).</p>
<ul>
<li>the conditional “randomized” Natural Indirect effect is <span class="math inline">\(\text{CRIE} \approx +0.8\%, \quad 95\%CI=[0.3\%,1.3\%]\)</span> on death and <span class="math inline">\(\text{CRIE} \approx -0.9, \quad 95\%CI=[-1.4,-0.3]\)</span> on quality of life. This indirect effect corresponds to the specific path <span class="math inline">\(A \rightarrow M \rightarrow Y\)</span> (and can also contain the mediated interactive effect of due to the <span class="math inline">\(A \ast M\)</span> interaction on <span class="math inline">\(Y\)</span>).</li>
<li>the conditional “randomized” Natural Direct effect is <span class="math inline">\(\text{CRDE} \approx +7.4\, \quad 95\%CI=[4.1\%,10.7\%]\)</span> on death and <span class="math inline">\(\text{CRDE} \approx -7.6, \quad 95\%CI=[-11.7,-3.4]\)</span> on quality of life. This direct effect corresponds to the combination of the paths <span class="math inline">\(A \rightarrow Y\)</span>, <span class="math inline">\(A \rightarrow L(1) \rightarrow Y\)</span> and <span class="math inline">\(A \rightarrow L(1) \rightarrow M \rightarrow Y\)</span>.</li>
</ul>
<p>95% confidence intervals can be calculated by bootstrap.</p>

</div>
</div>
</div>
<h3>References<a href="references.html#references" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-Nguyen2015" class="csl-entry">
Nguyen, Quynh C., Theresa L. Osypuk, Nicole M. Schmidt, M. Maria Glymour, and Eric J. Tchetgen Tchetgen. 2015. <span>“<span class="nocase">Practical Guidance for Conducting Mediation Analysis With Multiple Mediators Using Inverse Odds Ratio Weighting</span>.”</span> <em>American Journal of Epidemiology</em> 181 (5): 349–56. <a href="https://doi.org/10.1093/aje/kwu278">https://doi.org/10.1093/aje/kwu278</a>.
</div>
<div id="ref-Tchetgen2012" class="csl-entry">
Tchetgen Tchetgen, Eric J. 2013. <span>“Inverse Odds Ratio-Weighted Estimation for Causal Mediation Analysis.”</span> <em>Statistics in Medicine</em> 32 (26): 4567–80. https://doi.org/<a href="https://doi.org/10.1002/sim.5864">https://doi.org/10.1002/sim.5864</a>.
</div>
<div id="ref-zheng2017longitudinal" class="csl-entry">
Zheng, Wenjing, and Mark van der Laan. 2017. <span>“Longitudinal Mediation Analysis with Time-Varying Mediators and Exposures, with Application to Survival Outcomes.”</span> <em>Journal of Causal Inference</em> 5 (2).
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="ChapGcomp.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="msm_chapter.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/benoitlepage/mediation_workshop/04-IPTW.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
